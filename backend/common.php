<?php


ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

class AuthLogin {
    public function __construct(){
        $_SESSION['sess_signin'] = "";
        if(isset($_SESSION['sess_iAdminUserId'])&& !empty($_SESSION['sess_iAdminUserId'])){
            global $obj;
            $iAdminUserId = $_SESSION['sess_iAdminUserId'];
            $sql = "select vCode from language_master where eDefault='Yes'";
            $db_lbl = $obj->MySQLSelect($sql);
            $_SESSION['sess_lang'] = $db_lbl[0]['vCode'];
            $cmp_ssql = "";
            $sql = "SELECT COUNT(iAdminId)AS Total,eStatus FROM administrators WHERE iAdminId=" . $iAdminUserId;
            $data = $obj->MySQLSelect($sql);
            $checkadmin = $data[0]['Total'];
            $eStatus = $data[0]['eStatus'];
            if($eStatus == 'Deleted'){
                $checkadmin = 0;
            }
            else if($eStatus == 'Inactive'){
                $checkadmin = 0;
            }
            else {
                $checkadmin = 1;
                $isAjax = isset($_SERVER['HTTP_X_REQUESTED_WITH'])AND strtolower($_SERVER['HTTP_X_REQUESTED_WITH'])=== 'xmlhttprequest';
                if(!$isAjax){
                    $_SESSION['login_redirect_url'] = $_SERVER['REQUEST_URI'];
                }
            }
            if($checkadmin <= 0){
                $_SESSION['sess_iAdminUserId'] = "";
                $_SESSION["sess_vAdminFirstName"] = "";
                $_SESSION["sess_vAdminLastName"] = "";
                $_SESSION["sess_vAdminEmail"] = "";
                $_SESSION["current_link"] = "";
                unset($_SESSION['OrderDetails']);
                unset($_SESSION['sess_iServiceId_mr']);
                unset($_SESSION['sess_iUserId_mr']);
                unset($_SESSION["sess_iUserAddressId_mr"]);
                unset($_SESSION["sess_promoCode"]);
                unset($_SESSION["sess_vCurrency_mr"]);
                unset($_SESSION['sess_currentpage_url_mr']);
                unset($_SESSION['sess_vLatitude_mr']);
                unset($_SESSION['sess_vLongitude_mr']);
                unset($_SESSION['sess_vServiceAddress_mr']);
                unset($_SESSION["sess_vName_mr"]);
                unset($_SESSION["sess_company_mr"]);
                unset($_SESSION["sess_vEmail_mr"]);
                unset($_SESSION["sess_user_mr"]);
                unset($_SESSION['sess_userby_mr']);
                unset($_SESSION["sess_userby_id"]);
                if($eStatus == 'Deleted'){
                    $_SESSION['checkadminmsg'] = 'Your account has been deleted.Please contact administrator to activate your account.';
                }
                else {
                    $_SESSION['checkadminmsg'] = 'Your account has been disabled.Please contact administrator to activate your account.';
                }
                if($_SESSION["SessionUserType"] == 'hotel'){
                    $_SESSION["SessionUserType"] = "";
                    header("location:../hotel");
                }
                else {
                    header("location:index.php");
                }
            }
            $this->checkAuthAdmin();
        }
    }
    public function checkAuthAdmin(){
        global $THEME_OBJ;
        $url = 'http://' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'];
        if($THEME_OBJ->isRideCXThemeActive()== 'Yes' || $THEME_OBJ->isRideDeliveryXThemeActive()== 'Yes' || $THEME_OBJ->isRideCXv2ThemeActive()== 'Yes'){
            if((strpos($url, 'driver_service_request.php')== true)||(strpos($url, 'user-order-information')== true)||(strpos($url, 'store_vehicle_type.php')== true)){
                header("location:index.php");
                exit;
            }
        }
    }
    public function checkMemberAuthentication(){
        global $tconfig, $obj, $langage_lbl;
        $sess_iUserId = isset($_SESSION['sess_iUserId'])? $_SESSION['sess_iUserId'] : '';
        $sess_iAdminUserId = isset($_SESSION['sess_iAdminUserId'])? $_SESSION['sess_iAdminUserId'] : '';
        if($sess_iUserId == "" && $sess_iAdminUserId == "" && basename($_SERVER['PHP_SELF'])!= "login.php"){
            if(isset($_SERVER['REQUEST_URI'])){
                setcookie('login_redirect_url_user', $_SERVER['REQUEST_URI'], time()+ 2 * 24 * 60 * 60);
            }
            header("Location:" . $tconfig["tsite_url"] . "sign-in.php");
        }
        else {
            $SESSION_MEMBER = "";
            if(!empty($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'rider' && !empty($_SESSION['sess_iUserId'])){
                $SESSION_MEMBER = "User";
            }
            else if(!empty($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'driver' && !empty($_SESSION['sess_iUserId'])){
                $SESSION_MEMBER = "Driver";
            }
            else if(!empty($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'company' && !empty($_SESSION['sess_iCompanyId'])){
                $SESSION_MEMBER = "Company";
            }
            else if(!empty($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'organization' && !empty($_SESSION['sess_iOrganizationId'])){
                $SESSION_MEMBER = "Organization";
            }
            else if(!empty($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'tracking_company' && !empty($_SESSION['sess_iTrackServiceCompanyId'])){
                $SESSION_MEMBER = "TrackingCompany";
            }
            else {
                $SESSION_MEMBER = "Admin";
            }
            switch($SESSION_MEMBER){
                case 'User': $sess_iUserId = $_SESSION['sess_iUserId'];
                $sql = "SELECT COUNT(iUserId)AS Total,eStatus FROM register_user WHERE eStatus != 'Deleted' AND eStatus != 'Inactive' AND iUserId=" . $sess_iUserId;
                $data = $obj->MySQLSelect($sql);
                $checkuser = $data[0]['Total'];
                $eStatusUser = $data[0]['eStatus'];
                if($checkuser <= 0){
                    session_start();
                    unset($_SESSION['sess_iUserId']);
                    unset($_SESSION["sess_iCompanyId"]);
                    unset($_SESSION["sess_vName"]);
                    unset($_SESSION["sess_vEmail"]);
                    unset($_SESSION["sess_user"]);
                    unset($_SESSION['sess_iMemberId']);
                    unset($_SESSION['sess_eGender']);
                    unset($_SESSION['sess_vImage']);
                    unset($_SESSION['fb_user']);
                    unset($_SESSION['linkedin_user']);
                    unset($_SESSION['oauth_access_token']);
                    unset($_SESSION['oauth_verifier']);
                    unset($_SESSION['requestToken']);
                    unset($_SESSION['sess_currentpage_url_ub']);
                    $_SESSION['sess_currentpage_url_ub'] = "";
                    unset($_SESSION['sess_iServiceId_mr']);
                    unset($_SESSION['sess_iUserId_mr']);
                    unset($_SESSION["sess_iUserAddressId_mr"]);
                    unset($_SESSION["sess_promoCode"]);
                    unset($_SESSION["sess_vCurrency_mr"]);
                    unset($_SESSION['sess_currentpage_url_mr']);
                    unset($_SESSION['sess_vLatitude_mr']);
                    unset($_SESSION['sess_vLongitude_mr']);
                    unset($_SESSION['sess_vServiceAddress_mr']);
                    unset($_SESSION["sess_vName_mr"]);
                    unset($_SESSION["sess_company_mr"]);
                    unset($_SESSION["sess_vEmail_mr"]);
                    unset($_SESSION["sess_user_mr"]);
                    unset($_SESSION['sess_userby_mr']);
                    unset($_SESSION["sess_userby_id"]);
                    if(isset($_SERVER['HTTP_COOKIE'])){
                        $cookies = explode(';
                        ', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie){
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()- 1000);
                            setcookie($name, '', time()- 1000, '/');
                        }
                    }
                    session_destroy();
                    if($eStatusUser == 'Deleted'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else {
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    if(isset($_REQUEST['depart'])&& $_REQUEST['depart'] == 'mobi'){
                        header("Location:mobi");
                    }
                    else {
                        $url = $tconfig["tsite_url"] . 'user-login';
                        header("Location:$url");
                    }
                    exit;
                }
                break;
                case 'Driver': $sess_iDriverId = $_SESSION['sess_iUserId'];
                $sql = "SELECT COUNT(iDriverId)AS Total,eStatus FROM register_driver WHERE eStatus != 'Deleted' AND eStatus != 'Suspend' AND iDriverId =" . $sess_iDriverId;
                $data = $obj->MySQLSelect($sql);
                $checkdriver = $data[0]['Total'];
                $eStatusdriver = $data[0]['eStatus'];
                if($checkdriver <= 0){
                    session_start();
                    unset($_SESSION['sess_iUserId']);
                    unset($_SESSION["sess_iCompanyId"]);
                    unset($_SESSION["sess_vName"]);
                    unset($_SESSION["sess_vEmail"]);
                    unset($_SESSION["sess_user"]);
                    unset($_SESSION['sess_iMemberId']);
                    unset($_SESSION['sess_eGender']);
                    unset($_SESSION['sess_vImage']);
                    unset($_SESSION['fb_user']);
                    unset($_SESSION['linkedin_user']);
                    unset($_SESSION['oauth_access_token']);
                    unset($_SESSION['oauth_verifier']);
                    unset($_SESSION['requestToken']);
                    unset($_SESSION['sess_currentpage_url_ub']);
                    $_SESSION['sess_currentpage_url_ub'] = "";
                    unset($_SESSION['sess_iServiceId_mr']);
                    unset($_SESSION['sess_iUserId_mr']);
                    unset($_SESSION["sess_iUserAddressId_mr"]);
                    unset($_SESSION["sess_promoCode"]);
                    unset($_SESSION["sess_vCurrency_mr"]);
                    unset($_SESSION['sess_currentpage_url_mr']);
                    unset($_SESSION['sess_vLatitude_mr']);
                    unset($_SESSION['sess_vLongitude_mr']);
                    unset($_SESSION['sess_vServiceAddress_mr']);
                    unset($_SESSION["sess_vName_mr"]);
                    unset($_SESSION["sess_company_mr"]);
                    unset($_SESSION["sess_vEmail_mr"]);
                    unset($_SESSION["sess_user_mr"]);
                    unset($_SESSION['sess_userby_mr']);
                    unset($_SESSION["sess_userby_id"]);
                    if(isset($_SERVER['HTTP_COOKIE'])){
                        $cookies = explode(';
                        ', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie){
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()- 1000);
                            setcookie($name, '', time()- 1000, '/');
                        }
                    }
                    session_destroy();
                    if($eStatusdriver == 'Deleted'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else if($eStatusdriver == 'Suspend'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else {
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    if(isset($_REQUEST['depart'])&& $_REQUEST['depart'] == 'mobi'){
                        header("Location:mobi");
                    }
                    else {
                        $url = $tconfig["tsite_url"] . 'provider-login';
                        header("Location:$url");
                    }
                    exit;
                }
                break;
                case 'Company': $sess_iCompanyId = $_SESSION['sess_iCompanyId'];
                $sql = "SELECT COUNT(iCompanyId)AS Total,eStatus FROM company WHERE eStatus != 'Deleted' AND iCompanyId=" . $sess_iCompanyId;
                $data = $obj->MySQLSelect($sql);
                $checkcompany = $data[0]['Total'];
                $eStatuscompany = $data[0]['eStatus'];
                if($checkcompany <= 0){
                    session_start();
                    unset($_SESSION['sess_iUserId']);
                    unset($_SESSION["sess_iCompanyId"]);
                    unset($_SESSION["sess_vName"]);
                    unset($_SESSION["sess_vEmail"]);
                    unset($_SESSION["sess_user"]);
                    unset($_SESSION['sess_iMemberId']);
                    unset($_SESSION['sess_eGender']);
                    unset($_SESSION['sess_vImage']);
                    unset($_SESSION['fb_user']);
                    unset($_SESSION['linkedin_user']);
                    unset($_SESSION['oauth_access_token']);
                    unset($_SESSION['oauth_verifier']);
                    unset($_SESSION['requestToken']);
                    unset($_SESSION['sess_currentpage_url_ub']);
                    $_SESSION['sess_currentpage_url_ub'] = "";
                    unset($_SESSION['sess_iServiceId_mr']);
                    unset($_SESSION['sess_iUserId_mr']);
                    unset($_SESSION["sess_iUserAddressId_mr"]);
                    unset($_SESSION["sess_promoCode"]);
                    unset($_SESSION["sess_vCurrency_mr"]);
                    unset($_SESSION['sess_currentpage_url_mr']);
                    unset($_SESSION['sess_vLatitude_mr']);
                    unset($_SESSION['sess_vLongitude_mr']);
                    unset($_SESSION['sess_vServiceAddress_mr']);
                    unset($_SESSION["sess_vName_mr"]);
                    unset($_SESSION["sess_company_mr"]);
                    unset($_SESSION["sess_vEmail_mr"]);
                    unset($_SESSION["sess_user_mr"]);
                    unset($_SESSION['sess_userby_mr']);
                    unset($_SESSION["sess_userby_id"]);
                    if(isset($_SERVER['HTTP_COOKIE'])){
                        $cookies = explode(';
                        ', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie){
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()- 1000);
                            setcookie($name, '', time()- 1000, '/');
                        }
                    }
                    session_destroy();
                    if($eStatusdriver == 'Deleted'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else {
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    if(isset($_REQUEST['depart'])&& $_REQUEST['depart'] == 'mobi'){
                        header("Location:mobi");
                    }
                    else {
                        $url = $tconfig["tsite_url"] . 'company-login';
                        header("Location:$url");
                    }
                    exit;
                }
                break;
                case 'Organization': $sess_iOrganizationId = $_SESSION['sess_iOrganizationId'];
                $sql = "SELECT COUNT(iOrganizationId)AS Total,eStatus FROM organization WHERE eStatus != 'Deleted' AND iOrganizationId=" . $sess_iOrganizationId;
                $data = $obj->MySQLSelect($sql);
                $checkorganization = $data[0]['Total'];
                $eStatusorganization = $data[0]['eStatus'];
                if($checkorganization <= 0){
                    session_start();
                    unset($_SESSION['sess_iUserId']);
                    unset($_SESSION["sess_iCompanyId"]);
                    unset($_SESSION["sess_vName"]);
                    unset($_SESSION["sess_vEmail"]);
                    unset($_SESSION["sess_user"]);
                    unset($_SESSION['sess_iMemberId']);
                    unset($_SESSION['sess_eGender']);
                    unset($_SESSION['sess_vImage']);
                    unset($_SESSION['fb_user']);
                    unset($_SESSION['linkedin_user']);
                    unset($_SESSION['oauth_access_token']);
                    unset($_SESSION['oauth_verifier']);
                    unset($_SESSION['requestToken']);
                    unset($_SESSION['sess_currentpage_url_ub']);
                    $_SESSION['sess_currentpage_url_ub'] = "";
                    unset($_SESSION['sess_iServiceId_mr']);
                    unset($_SESSION['sess_iUserId_mr']);
                    unset($_SESSION["sess_iUserAddressId_mr"]);
                    unset($_SESSION["sess_promoCode"]);
                    unset($_SESSION["sess_vCurrency_mr"]);
                    unset($_SESSION['sess_currentpage_url_mr']);
                    unset($_SESSION['sess_vLatitude_mr']);
                    unset($_SESSION['sess_vLongitude_mr']);
                    unset($_SESSION['sess_vServiceAddress_mr']);
                    unset($_SESSION["sess_vName_mr"]);
                    unset($_SESSION["sess_company_mr"]);
                    unset($_SESSION["sess_vEmail_mr"]);
                    unset($_SESSION["sess_user_mr"]);
                    unset($_SESSION['sess_userby_mr']);
                    unset($_SESSION["sess_userby_id"]);
                    if(isset($_SERVER['HTTP_COOKIE'])){
                        $cookies = explode(';
                        ', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie){
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()- 1000);
                            setcookie($name, '', time()- 1000, '/');
                        }
                    }
                    session_destroy();
                    if($eStatusdriver == 'Deleted'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else {
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    if(isset($_REQUEST['depart'])&& $_REQUEST['depart'] == 'mobi'){
                        header("Location:mobi");
                    }
                    else {
                        $url = $tconfig["tsite_url"] . 'organization-login';
                        header("Location:$url");
                    }
                    exit;
                }
                break;
                case 'TrackingCompany': $sess_iTrackServiceCompanyId = $_SESSION['sess_iTrackServiceCompanyId'];
                $sql = "SELECT COUNT(iTrackServiceCompanyId)AS Total,eStatus FROM track_service_company WHERE eStatus != 'Deleted' AND iTrackServiceCompanyId=" . $sess_iTrackServiceCompanyId;
                $data = $obj->MySQLSelect($sql);
                $checkorganization = $data[0]['Total'];
                $eStatusorganization = $data[0]['eStatus'];
                if($checkorganization <= 0){
                    session_start();
                    unset($_SESSION['sess_iUserId']);
                    unset($_SESSION["sess_iCompanyId"]);
                    unset($_SESSION["sess_vName"]);
                    unset($_SESSION["sess_vEmail"]);
                    unset($_SESSION["sess_user"]);
                    unset($_SESSION['sess_iMemberId']);
                    unset($_SESSION['sess_eGender']);
                    unset($_SESSION['sess_vImage']);
                    unset($_SESSION['fb_user']);
                    unset($_SESSION['linkedin_user']);
                    unset($_SESSION['oauth_access_token']);
                    unset($_SESSION['oauth_verifier']);
                    unset($_SESSION['requestToken']);
                    unset($_SESSION['sess_currentpage_url_ub']);
                    $_SESSION['sess_currentpage_url_ub'] = "";
                    unset($_SESSION['sess_iServiceId_mr']);
                    unset($_SESSION['sess_iUserId_mr']);
                    unset($_SESSION["sess_iUserAddressId_mr"]);
                    unset($_SESSION["sess_promoCode"]);
                    unset($_SESSION["sess_vCurrency_mr"]);
                    unset($_SESSION['sess_currentpage_url_mr']);
                    unset($_SESSION['sess_vLatitude_mr']);
                    unset($_SESSION['sess_vLongitude_mr']);
                    unset($_SESSION['sess_vServiceAddress_mr']);
                    unset($_SESSION["sess_vName_mr"]);
                    unset($_SESSION["sess_company_mr"]);
                    unset($_SESSION["sess_vEmail_mr"]);
                    unset($_SESSION["sess_user_mr"]);
                    unset($_SESSION['sess_userby_mr']);
                    unset($_SESSION["sess_userby_id"]);
                    if(isset($_SERVER['HTTP_COOKIE'])){
                        $cookies = explode(';
                        ', $_SERVER['HTTP_COOKIE']);
                        foreach($cookies as $cookie){
                            $parts = explode('=', $cookie);
                            $name = trim($parts[0]);
                            setcookie($name, '', time()- 1000);
                            setcookie($name, '', time()- 1000, '/');
                        }
                    }
                    session_destroy();
                    if($eStatusdriver == 'Deleted'){
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    else {
                        $_SESSION['checkadminmsg'] = $langage_lbl['LBL_ACCOUNT_NOT_ACTIVE_ERROR_MSG'];
                    }
                    if(isset($_REQUEST['depart'])&& $_REQUEST['depart'] == 'mobi'){
                        header("Location:mobi");
                    }
                    else {
                        $url = $tconfig["tsite_url"] . 'organization-login';
                        header("Location:$url");
                    }
                    exit;
                }
                break;
                case 'Admin': default: break;
            }
        }
    }
    public function checkManualTaxiMemberAuthentication(){
        global $tconfig, $MODULES_OBJ;
        $userType = isset($_REQUEST['userType1'])? $_REQUEST['userType1'] : '';
        if(isset($userType)&& !empty($userType)){
            $redirect_file_name = 'sign-in.php';
            if($userType == 'company'){
                $redirect_file_name = 'company-login';
            }
            else if($userType == 'rider'){
                $redirect_file_name = 'user-login';
            }
        }
        $manual_booking_enable = $MODULES_OBJ->isManualBookingAvailable()? 'Yes' : 'No';
        if(!($MODULES_OBJ->isRideFeatureAvailable()||($MODULES_OBJ->isDeliveryFeatureAvailable()&& strtoupper(ENABLE_MANUAL_BOOKING_DELIVERY)== "YES")||($ufxEnable == 'Yes' && strtoupper(ENABLE_MANUAL_BOOKING_UBERX)== 'YES'))){
            $manual_booking_enable = "No";
        }
        $sess_iUserId = isset($_SESSION['sess_iUserId'])? $_SESSION['sess_iUserId'] : '';
        if(($sess_iUserId == "" && basename($_SERVER['PHP_SELF'])!= "login.php")|| $manual_booking_enable == "No"){
            header("Location:" . $tconfig["tsite_url"] . $redirect_file_name);
        }
        else {
        }
    }
    public function AuthMemberRedirect(){
        global $tconfig;
        $sess_iUserId = isset($_SESSION['sess_iUserId'])? $_SESSION['sess_iUserId'] : '';
        $sess_user = isset($_SESSION['sess_user'])? $_SESSION['sess_user'] : '';
        $url = "";
        if($sess_iUserId != "" && $sess_user != ''){
            switch($sess_user){
                case 'driver': $url = "profile.php";
                break;
                case 'rider': $url = "profile_rider.php";
                break;
                case 'company': $url = "profile.php";
                break;
                case 'organization': $url = "organization-profile";
                break;
                default: $url = "index.php";
                break;
            }
        }
        if($url != '' && basename($_SERVER['PHP_SELF'])!= $url){
            header("Location:" . $url);
        }
    }
    public function AuthAdminRedirect(){
        global $tconfig;
        $sess_iAdminUserId = isset($_SESSION['sess_iAdminUserId'])? $_SESSION['sess_iAdminUserId'] : '';
        $sess_iGroupId = isset($_SESSION['sess_iGroupId'])? $_SESSION['sess_iGroupId'] : '';
        if($sess_iGroupId == '4'){
            if($sess_iAdminUserId != ""){
                $url = $tconfig['tsite_url_main_admin'] . "create_request.php";
            }
        }
        else {
            if($sess_iAdminUserId != ""){
                $url = $tconfig['tsite_url_main_admin'] . "dashboard.php";
            }
        }
        if(isset($url)&& $url != '' && basename($_SERVER['PHP_SELF'])!= $url){
            echo '<script>window.location="' . $url . '";
            </script>';
            @header("Location:" . $url);
            exit;
        }
    }
    public function VerifyPassword($pass, $hash){
        if(password_verify($pass, $hash)){
            $test = 1;
        }
        else {
            $test = 0;
        }
        return $test;
    }
}
class AuthenticateMemberCls {
    private $exclude = ['RoTOQSk6OH_XXXXXXXX.php', 'send_notifications.php', 'app_configuration_file.php', '/dummy', 'wa_notify.php', 'response.php', 'callback.php', 'webhook.php', 'notify.php', 'wa_notify.php'];
    private $exclude_webview_files = ['payment_mode_select.php'];
    private $tokens_count = 2;
    private $tokens_count_default = 10;
    function __construct(){
        global $ANDROID_USER, $ANDROID_DRIVER, $ANDROID_STORE, $ANDROID_KIOSK, $ANDROID_KIOSK_STORE, $ANDROID_TRACK_USER, $IOS_USER, $IOS_DRIVER, $IOS_STORE, $IOS_KIOSK, $IOS_KIOSK_STORE, $IOS_TRACK_USER, $AUTH_OBJ, $oCache, $tconfig, $ENABLE_DATA_ENCRYPTION;
        if(stripos($_SERVER['REQUEST_URI'], WEBSERVICE_API_FILE_NAME)!== false && !isset($_REQUEST['IS_FROM_APPLE_WATCH'])){
            if(strtoupper($ENABLE_DATA_ENCRYPTION)!= "YES"){
                return true;
            }
            if(isset($_SERVER['HTTP_X_REQUESTED_WITH'])&& strtolower($_SERVER['HTTP_X_REQUESTED_WITH'])=== 'xmlhttprequest'){
                if(!$this->validate()){
                    http_response_code(400);
                    echo "<h1>Bad Request</h1>";
                    die();
                }
            }
            else {
                $GeneralUserType = isset($_REQUEST['GeneralUserType'])? $_REQUEST['GeneralUserType'] : '';
                $GeneralDeviceType = isset($_REQUEST['GeneralDeviceType'])? $_REQUEST['GeneralDeviceType'] : '';
                $eSystemAppType = isset($_REQUEST["eSystemAppType"])? $_REQUEST["eSystemAppType"] : '';
                $auth_package = $auth_member = "";
                $http_auth_token = $this->getHttpAuthToken();
                if(strtoupper($GeneralUserType)== "PASSENGER"){
                    $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_USER : $IOS_USER;
                    $auth_member = "USER_" . $http_auth_token;
                }
                elseif(strtoupper($GeneralUserType)== "DRIVER"){
                    $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_DRIVER : $IOS_DRIVER;
                    $auth_member = "DRIVER_" . $http_auth_token;
                }
                elseif(strtoupper($GeneralUserType)== "COMPANY"){
                    $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_STORE : $IOS_STORE;
                    $auth_member = "STORE_" . $http_auth_token;
                    if(!empty($eSystemAppType)&& strtoupper($eSystemAppType)== "KIOSK"){
                        $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_KIOSK_STORE : $IOS_KIOSK_STORE;
                        $auth_member = "FOODKIOSK_" . $http_auth_token;
                    }
                }
                elseif(strtoupper($GeneralUserType)== "HOTEL"){
                    $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_KIOSK : $IOS_KIOSK;
                    $auth_member = "HOTEL_" . $http_auth_token;
                }
                elseif(strtoupper($GeneralUserType)== "TRACKING"){
                    $auth_package = strtoupper($GeneralDeviceType)== "ANDROID" ? $ANDROID_TRACK_USER : $IOS_TRACK_USER;
                    $auth_member = "TRACKING_" . $http_auth_token;
                }
                $auth_token = $this->generateAuthToken($auth_package, ENC_SHA_KEY);
                if(isset($_REQUEST["isFromAdmin"])&& strtoupper($_REQUEST["isFromAdmin"])== "YES"){
                    $auth_token = $this->getAuthTokenWeb();
                }
                $authMemberApcKey = md5($auth_member);
                $authMemberCacheData = $oCache->getData($authMemberApcKey);
                $valid = $AUTH_OBJ->VerifyPassword($auth_token, $http_auth_token);
                if(!$valid || $valid == 0 || !empty($authMemberCacheData)){
                    http_response_code(400);
                    echo "<h1>Bad Request</h1>";
                    die();
                }
                else {
                    $oCache->setData($authMemberApcKey, true);
                }
            }
        }
        else {
            if(!$this->validate()){
                http_response_code(400);
                echo "<h1>Bad Request</h1>";
                die();
            }
        }
    }
    public function initAuth(){
        global $tconfig;
        if(!isset($_COOKIE['amifnctgk3hhsec'])&& !isset($_REQUEST['isFromApp'])){
            setcookie('amifnctgk3hhsec', json_encode($this->getCSRFTokens(), JSON_UNESCAPED_UNICODE), time()+ 86400, '/');
        }
    }
    private function generateAuthToken($auth_package, $auth_sha_key){
        $enc_auth_token = ENC_SEC_KEY;
        preg_match_all("/(?<!\d)\d {
            2
        }(?!\d)/", $enc_auth_token, $matches);
        $token_length_arr = $matches[0];
        $sub_auth_shakey = substr($auth_sha_key, 0, $token_length_arr[0]);
        $sub_auth_token = substr($enc_auth_token, 0, $token_length_arr[1]);
        $sub_auth_package = substr($auth_package, 0, $token_length_arr[2]);
        return base64_encode(md5(base64_encode(strtoupper($sub_auth_shakey . $sub_auth_token . $sub_auth_package))));
    }
    private function getHttpAuthToken(){
        $http_headers_arr = getallheaders();
        if(empty($http_headers_arr['Authorization'])){
            $http_headers_arr['Authorization'] = isset($_SERVER['REDIRECT_HTTP_AUTHORIZATION'])? $_SERVER['REDIRECT_HTTP_AUTHORIZATION'] : '';
        }
        $token = str_replace("Bearer ", "", $http_headers_arr['Authorization']);
        return $token;
    }
    public function getPackageData(){
        global $ANDROID_USER, $ANDROID_DRIVER, $ANDROID_STORE, $ANDROID_KIOSK, $ANDROID_KIOSK_STORE, $ANDROID_TRACK_USER, $IOS_USER, $IOS_DRIVER, $IOS_STORE, $IOS_KIOSK, $IOS_KIOSK_STORE, $IOS_TRACK_USER;
        $auth_sha_key = ENC_SHA_KEY;
        $data = array();
        $data['ANDROID_USER'] = $this->generateAuthToken($ANDROID_USER, $auth_sha_key);
        $data['ANDROID_DRIVER'] = $this->generateAuthToken($ANDROID_DRIVER, $auth_sha_key);
        if(!empty($ANDROID_STORE))$data['ANDROID_STORE'] = $this->generateAuthToken($ANDROID_STORE, $auth_sha_key);
        if(!empty($ANDROID_KIOSK))$data['ANDROID_KIOSK'] = $this->generateAuthToken($ANDROID_KIOSK, $auth_sha_key);
        if(!empty($ANDROID_KIOSK_STORE))$data['ANDROID_KIOSK_STORE'] = $this->generateAuthToken($ANDROID_KIOSK_STORE, $auth_sha_key);
        if(!empty($ANDROID_TRACK_USER))$data['ANDROID_TRACK_USER'] = $this->generateAuthToken($ANDROID_TRACK_USER, $auth_sha_key);
        $data['IOS_USER'] = $this->generateAuthToken($IOS_USER, $auth_sha_key);
        $data['IOS_DRIVER'] = $this->generateAuthToken($IOS_DRIVER, $auth_sha_key);
        if(!empty($IOS_STORE))$data['IOS_STORE'] = $this->generateAuthToken($IOS_STORE, $auth_sha_key);
        if(!empty($IOS_KIOSK))$data['IOS_KIOSK'] = $this->generateAuthToken($IOS_KIOSK, $auth_sha_key);
        if(!empty($IOS_KIOSK_STORE))$data['IOS_KIOSK_STORE'] = $this->generateAuthToken($IOS_KIOSK_STORE, $auth_sha_key);
        if(!empty($IOS_TRACK_USER))$data['IOS_TRACK_USER'] = $this->generateAuthToken($IOS_TRACK_USER, $auth_sha_key);
        $domain = get_server_domain($_SERVER['HTTP_HOST']);
        $data['WEB_USER'] = $this->generateAuthToken($domain, $auth_sha_key);
        return $data;
    }
    public function getAuthTokenWeb(){
        return encrypt_bycrypt($this->getPackageData()['WEB_USER']);
    }
    public function getCSRFTokens(){
        if(stripos_arr($_SERVER['SCRIPT_NAME'],$this->exclude_webview_files)!== false){
            $num = 1;
        }
        else if($_SERVER['SCRIPT_NAME'] == "/index.php"){
            $num = $this->tokens_count;
        }
        else {
            $num = $this->tokens_count_default;
        }
        $CSRF_TOKENS = $SESS_CSRF_TOKENS = array();
        if(isset($_COOKIE['amifnctgk3hhsec'])&& !empty($_COOKIE['amifnctgk3hhsec'])){
            $SESS_CSRF_TOKENS = json_decode($_COOKIE['amifnctgk3hhsec'], true);
        }
        $total_tokens = scount($SESS_CSRF_TOKENS);
        if($total_tokens < $num){
            for($i = 0;
            $i <($num - $total_tokens);
            $i++){
                $SESS_CSRF_TOKENS[] = $this->getAuthTokenWeb();
            }
        }
        $CSRF_TOKENS = $SESS_CSRF_TOKENS;
        return $CSRF_TOKENS;
    }
    private function validate(){
        global $AUTH_OBJ, $ENABLE_DATA_ENCRYPTION;
        if(!empty($_POST)&& stripos_arr($_SERVER['REQUEST_URI'], $this->exclude)=== false){
            if(strtoupper($ENABLE_DATA_ENCRYPTION)!= "YES"){
                return true;
            }
            $http_auth_token = $this->getHttpAuthToken();
            if(isset($_POST['_csrf_tok'])&& !empty($_POST['_csrf_tok'])){
                $http_auth_token = $_POST['_csrf_tok'];
            }
            if(! \is_string($http_auth_token)){
                return false;
            }
            $CSRF_TOKENS = json_decode($_COOKIE['amifnctgk3hhsec'], true);
            foreach($CSRF_TOKENS as $k => $TOKEN){
                $valid = $AUTH_OBJ->VerifyPassword($this->getPackageData()['WEB_USER'], $http_auth_token);
                if($valid || $valid == 1){
                    unset($CSRF_TOKENS[$k]);
                    $CSRF_TOKENS = array_values($CSRF_TOKENS);
                    if(empty($CSRF_TOKENS)){
                        $CSRF_TOKENS = $this->getCSRFTokens();
                    }
                    setcookie('amifnctgk3hhsec', json_encode($CSRF_TOKENS, JSON_UNESCAPED_UNICODE), time()+ 86400, '/');
                    return true;
                }
            }
            return false;
        }
        else {
            $this->initAuth();
        }
        return true;
    }
}
class EventMessageCls {
    const RN_USER = "USER";
    const RN_PROVIDER = "PROVIDER";
    const RN_COMPANY = "COMPANY";
    const RN_KIOSK = "KIOSK";
    const RN_TRACK_USER = "TRACK_USER";
    private $key_file;
    private $key_id;
    private $team_id;
    private $app_bundle_id;
    private $apns_url;
    private $notification_sound;
    private $custom_notification;
    private $custom_notification_text;
    public function __construct(){
        global $tconfig, $APNS_KEY_ID, $APNS_TEAM_ID, $APNS_PRIVATE_KEY_FILE_NAME, $APP_MODE, $APNS_URL_LIVE, $APNS_URL_SANDBOX;
        $this->key_file = preg_replace('/(\/+)/','/', $tconfig['tpanel_path']). $APNS_PRIVATE_KEY_FILE_NAME;
        $this->key_id = $APNS_KEY_ID;
        $this->team_id = $APNS_TEAM_ID;
        if(strtoupper($APP_MODE)== "PRODUCTION"){
            $this->apns_url = $APNS_URL_LIVE;
        }
        else {
            $this->apns_url = $APNS_URL_SANDBOX;
        }
        $this->notification_sound = "default";
        $this->custom_notification = "No";
        $this->custom_notification_text = "";
    }
    public function send($generalData, $UserType){
        global $IOS_USER, $IOS_DRIVER, $IOS_STORE, $IOS_KIOSK, $IOS_TRACK_USER, $APP_MODE;
        $alertMsgArr = $AndroidTokensArr = $IosTokensArr = $AndroidMsgArr = $IosMsgArr = $eAppTerminateArr = $addRequestSentArr = $channelNameArr = $publishMsgArr = $tripStatusMsgArr = $eUrlModeArr = $HmsTokensArr = $HmsMsgArr = array();
        $dataArr = $generalData;
        $requestSent = 'Yes';
        if(isset($dataArr['requestSent'])&& strtoupper($dataArr['requestSent'])== "NO"){
            $requestSent = 'No';
        }
        $ReqMsgCode = isset($dataArr['ReqMsgCode'])? $dataArr['ReqMsgCode'] : '0';
        $isTaxiBid = isset($dataArr['isTaxiBid'])? $dataArr['isTaxiBid'] : 'No';
        $getSoundData = getCustomeNotificationSound($dataArr);
        if(strtoupper($UserType)== self::RN_USER){
            $this->app_bundle_id = $IOS_USER;
            $this->notification_sound = $getSoundData['USER_NOTIFICATION'];
        }
        elseif(strtoupper($UserType)== self::RN_PROVIDER){
            $this->app_bundle_id = $IOS_DRIVER;
            $this->notification_sound = $getSoundData['PROVIDER_NOTIFICATION'];
        }
        elseif(strtoupper($UserType)== self::RN_COMPANY){
            $this->app_bundle_id = $IOS_STORE;
            $this->notification_sound = $getSoundData['STORE_NOTIFICATION'];
        }
        elseif(strtoupper($UserType)== self::RN_KIOSK){
            $this->app_bundle_id = $IOS_KIOSK;
        }
        elseif(strtoupper($UserType)== self::RN_TRACK_USER){
            $this->app_bundle_id = $IOS_TRACK_USER;
        }
        else {
            return false;
        }
        foreach($generalData['GENERAL_DATA'] as $generalData){
            $isAlertMsgArr = is_array($generalData['alertMsg'])? true : false;
            $isMsgArr = is_array($generalData['message'])? true : false;
            if(!$isMsgArr && isJsonTextGT($generalData['message'])){
                $generalData['message'] = json_decode($generalData['message'], true);
            }
            elseif(!$isMsgArr && !isJsonTextGT($generalData['message'])){
                $generalData['message'] = array();
                $generalData['message']['vTitle'] = $generalData['alertMsg'];
                $generalData['message']['vSound'] = $this->notification_sound;
                $generalData['message']['vRandomCode'] = time();
            }
            if(strtoupper($generalData['eDeviceType'])== "IOS" && $generalData['eAppTerminate'] == "Yes"){
                $explodeData = explode("_", $this->notification_sound);
                if(scount($explodeData)> 1){
                    $this->notification_sound = $explodeData[1];
                }
            }
            if($isMsgArr){
                if(!isset($generalData['message']['CustomNotification'])){
                    $messageJson = $generalData['message'];
                    if(isJsonText($generalData['message'])){
                        $messageJson = json_decode($generalData['message']);
                    }
                    $this->custom_notification = !empty($messageJson->CustomNotification)? $messageJson->CustomNotification : "No";
                }
                else {
                    $this->custom_notification = $generalData['message']['CustomNotification'];
                }
                if(strtoupper($this->custom_notification)=="YES"){
                    $this->custom_notification_text = "CUSTOM_NOTI_ORDER";
                }
                if(!isset($generalData['message']['vTitle'])){
                    $generalData['message']['vTitle'] = $generalData['alertMsg'];
                }
                if(!isset($generalData['message']['vSound'])){
                    $generalData['message']['vSound'] = $this->notification_sound;
                }
            }
            if(strtoupper($generalData['eHmsDevice'])== "YES"){
                $HmsTokensArr[] = $generalData['deviceToken'];
                $alertMsgArr[] = $generalData['alertMsg'];
                $HmsMsgArr[] = $generalData['message'];
            }
            else if(strtoupper($generalData['eDeviceType'])== "ANDROID"){
                $AndroidTokensArr[] = $generalData['deviceToken'];
                $AndroidMsgArr[] = $generalData['message'];
            }
            else {
                $IosTokensArr[] = $generalData['deviceToken'];
                $alertMsgArr[] = $generalData['alertMsg'];
                $IosMsgArr[] = $generalData['message'];
                $eAppTerminateArr[] = $generalData['eAppTerminate'];
                if(!empty($generalData['eDebugMode'])&& strtoupper($generalData['eDebugMode'])== "YES" && strtoupper($APP_MODE)== "PRODUCTION"){
                    $eUrlModeArr[] = "sandbox";
                }
                else {
                    $eUrlModeArr[] = strtoupper($APP_MODE)== "PRODUCTION" ? "live" : "sandbox";
                }
            }
            if(isset($generalData['addRequestSentArr'])){
                $addRequestSentArr[] = $generalData['addRequestSentArr'];
            }
            if(isset($generalData['orderEventChannelName'])){
                $channelNameArr[] = $generalData['orderEventChannelName'];
                $publishMsgArr[] = $generalData['message'];
            }
            if(isset($generalData['channelName'])){
                $channelNameArr[] = $generalData['channelName'];
                $publishMsgArr[] = $generalData['message'];
            }
            if(isset($generalData['tripStatusMsgArr'])){
                $tripStatusMsgArr[] = $generalData['tripStatusMsgArr'];
            }
        }
        if(isset($addRequestSentArr)&& !empty($addRequestSentArr)){
            $this->addRequestSent($addRequestSentArr, $requestSent, $ReqMsgCode, $isTaxiBid);
        }
        if($requestSent == "Yes"){
            if(isset($tripStatusMsgArr)&& !empty($tripStatusMsgArr)){
                $this->addTripStatusMessage($tripStatusMsgArr);
            }
            if(isset($channelNameArr)&& !empty($channelNameArr)){
                $this->publishEventMessage($channelNameArr, $publishMsgArr);
            }
            if(isset($AndroidTokensArr)&& !empty($AndroidTokensArr)){
                $this->executeRequestAndroid($AndroidTokensArr, $AndroidMsgArr);
            }
            if(isset($IosTokensArr)&& !empty($IosTokensArr)){
                $this->executeRequestIos($IosTokensArr, $IosMsgArr, $alertMsgArr, $eAppTerminateArr, $eUrlModeArr);
            }
            if(isset($HmsTokensArr)&& !empty($HmsTokensArr)){
                $this->executeRequestHuawei($HmsTokensArr, $HmsMsgArr, $alertMsgArr);
            }
        }
        return true;
    }
    private function executeRequestIos($registration_ids, $message, $alertMsg, $eAppTerminate, $eUrlMode){
        $notifications = array();
        foreach($registration_ids as $key => $deviceToken){
            $body = array();
            $body['aps'] = array('alert' => $alertMsg[$key], 'content-available' => 1, 'body' => $message[$key], 'sound' => $this->notification_sound,'category' => $this->custom_notification_text);
            if(strtoupper($eAppTerminate[$key])== "NO"){
             $body['aps']['alert'] = "";
             $body['aps']['sound'] = "";
              // ❌ NÃO INSERIR apns-push-type aqui, pois isso vai nos headers, não no payload
         }

            $LiveActivity = "No";
            $VoipNotification = "No";
            if(isset($message[$key]['LiveActivity'])&& $message[$key]['LiveActivity'] == "Yes"){
                $LiveActivity = "Yes";
                $body['aps']['timestamp'] = time();
                if(isset($message[$key]['LiveActivityEnd'])&& $message[$key]['LiveActivityEnd'] == "Yes"){
                    $body['aps']['event'] = "end";
                    $body['aps']['dismissal-date'] = strtotime("-1 minute", time());
                }
                else {
                    $body['aps']['event'] = "update";
                }
                $body['aps']['content-state'] = $message[$key]['LiveActivityData'];
            }
            if(isset($message[$key]['MsgType'])&& $message[$key]['MsgType'] == "VOIP"){
                if($message[$key]['isForVoip'] == "Yes"){
                    $VoipNotification = "Yes";
                    $body['callerName'] = $message[$key]['iFromMemberName'];
                    $body['uuid'] = $this->generateUUIDv4();
                    unset($body['aps']['alert']);
                    unset($body['aps']['sound']);
                    unset($body['aps']['apns-push-type']);
                }
            }
            $notifications[] = array('token' => $deviceToken, 'body' => json_encode($body, JSON_UNESCAPED_UNICODE), 'eUrlMode' => $eUrlMode[$key], 'LiveActivity' => $LiveActivity, 'VoipNotification' => $VoipNotification);
        }
        $this->executeRequestMultiIos($notifications);
    }
    
   private function executeRequestMultiIos(array $notifications) {
        global $APNS_URL_LIVE, $APNS_URL_SANDBOX;
        // Definir constante HTTP/2 se não existir
        if (!defined('CURL_HTTP_VERSION_2_0')) {
            define('CURL_HTTP_VERSION_2_0', 3);
        }

        $mh = curl_multi_init();
        $requests = [];

        foreach ($notifications as $notification) {
            // 1. Escolhe o endpoint (Sandbox ou Produção)
            $this->apns_url = (strtoupper($notification['eUrlMode']) === 'SANDBOX')
                ? $APNS_URL_SANDBOX
                : $APNS_URL_LIVE;
            $url = "{$this->apns_url}/3/device/{$notification['token']}";

            // 2. Gera o JWT (token de autorização)
            $jwt = $this->getAuthorizationToken();
            $bundleid = $this->app_bundle_id;

            // 3. Monta os headers apropriados
            $headers = [
                "apns-topic: {$bundleid}",
                "authorization: bearer {$jwt}",
                "content-type: application/json"
            ];

            // Define tipo de push e prioridade
            if (!empty($notification['VoipNotification']) && $notification['VoipNotification'] === "Yes") {
    $headers[] = "apns-push-type: voip";
    $headers[] = "apns-priority: 10";
    $headers[] = "apns-expiration: 60";

} elseif (!empty($notification['LiveActivity']) && $notification['LiveActivity'] === "Yes") {
    $headers[] = "apns-push-type: liveactivity";
    $headers[] = "apns-priority: 10";

} else {
    $payload = json_decode($notification['body'], true);
    if (
        empty($payload['aps']['alert']) &&
        empty($payload['aps']['sound'])
    ) {
        $headers[] = "apns-push-type: background";
        $headers[] = "apns-priority: 5"; // baixa prioridade para background
    } else {
        $headers[] = "apns-push-type: alert";
        $headers[] = "apns-priority: 10";
    }
}


            // 4. Assegura que o corpo está em JSON puro
            $bodyJson = is_string($notification['body'])
                ? $notification['body']
                : json_encode($notification['body']);

            // 5. Inicializa o handle cURL
            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_2_0);
            curl_setopt($ch, CURLOPT_PORT, 443);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $bodyJson);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_HEADER, true);

            // Adiciona ao multi handle
            curl_multi_add_handle($mh, $ch);
            $requests[] = ['handle' => $ch, 'url' => $url];
        }

        // 6. Executa todas as requisições
        do {
            $status = curl_multi_exec($mh, $running);
            if ($running) {
                curl_multi_select($mh);
            }
        } while ($running && $status === CURLM_OK);

        // 7. Coleta respostas e faz cleanup
        foreach ($requests as $req) {
            $ch = $req['handle'];
            $response = curl_multi_getcontent($ch);
            $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

            if (isset($_REQUEST['debug_noti'])) {
                echo "HEADERS:<pre>" . print_r($headers, true) . "</pre>";
                echo "BODY:<pre>" . htmlspecialchars($bodyJson) . "</pre>";

                echo "URL: {$req['url']}<br>";
                echo "HTTP Code: {$httpCode}<br>";
                echo nl2br(htmlspecialchars($response)) . "<br><br>";
            }

            curl_multi_remove_handle($mh, $ch);
            curl_close($ch);
        }

        curl_multi_close($mh);
    }

    private function getAuthorizationToken(){
        $key = openssl_pkey_get_private('file://'.$this->key_file);
        $header = ['alg'=>'ES256','kid'=>$this->key_id];
        $claims = ['iss'=>$this->team_id,'iat'=>time()];
        $header_encoded = $this->base64($header);
        $claims_encoded = $this->base64($claims);
        $signature = '';
        openssl_sign($header_encoded . '.' . $claims_encoded, $signature, $key, 'sha256');
        $jwt = $header_encoded . '.' . $claims_encoded . '.' . base64_encode($signature);
        return $jwt;
    }
    private function base64($data){
        return rtrim(strtr(base64_encode(json_encode($data)), '+/', '-_'), '=');
    }
    private function executeRequestAndroid($registration_ids, $message){
        global $GOOGLE_SENDER_ID;
        if(scount($registration_ids)> 499){
            $newArr = array_chunk($registration_ids, 499);
            $newArrMsg = array_chunk($message, 499);
            foreach($newArr as $k => $newRegistration_ids){
                $result = $this->executeRequestAndroid($newRegistration_ids, $newArrMsg[$k]);
            }
        }
        if(scount($registration_ids)> 1 && scount($message)> 1 && !isAssocArrGT($message)){
            $this->executeRequestMultiAndroid($registration_ids, $message);
        }
        else {
            $message = isJsonText($message)? json_decode($message, true):(!isAssocArrGT($message)? $message[0] : $message);
            $payload = array();
            $payload['message']['token'] = $registration_ids[0];
            $payload['message']['data']['message'] = json_encode($message, JSON_UNESCAPED_UNICODE);
            $payload['message']['android']['priority'] = "high";
            $finalFields = json_encode($payload, JSON_UNESCAPED_UNICODE);
            $headers = array('Authorization: Bearer '. $this->getAccessTokenAndroid(), 'Content-Type: application/json',);
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, 'https://fcm.googleapis.com/v1/projects/' . $GOOGLE_SENDER_ID . '/messages:send');
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $finalFields);
            $response = curl_exec($ch);
            $responseArr = json_decode($response);
            $success = $responseArr->success;
            if(isset($_REQUEST['debug_noti'])){
                echo "<pre>";
                print_r($responseArr);
                print_r($message);
                exit;
            }
            curl_close($ch);
            return true;
        }
    }
    private function executeRequestMultiAndroid($registration_ids, $message){
        global $GOOGLE_SENDER_ID;
        $requests = array();
        $mh = curl_multi_init();
        $headers = array('Authorization: Bearer '. $this->getAccessTokenAndroid(), 'Content-Type: application/json',);
        foreach($registration_ids as $key => $value){
            $payload = array();
            $payload['message']['token'] = $value;
            $payload['message']['data']['message'] = json_encode($message[$key], JSON_UNESCAPED_UNICODE);
            $payload['message']['android']['priority'] = "high";
            $finalFields = json_encode($payload, JSON_UNESCAPED_UNICODE);
            $requests[$key] = array();
            $requests[$key]['curl_handle'] = curl_init('https://fcm.googleapis.com/v1/projects/' . $GOOGLE_SENDER_ID . '/messages:send');
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_HTTPHEADER, $headers);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_POST, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_POSTFIELDS, $finalFields);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_RETURNTRANSFER, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_HEADER, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_SSL_VERIFYPEER, false);
            curl_multi_add_handle($mh, $requests[$key]['curl_handle']);
        }
        $stillRunning = false;
        do {
            $status = curl_multi_exec($mh, $stillRunning);
            if($stillRunning){
                curl_multi_select($mh);
            }
        }
        while($stillRunning && $status == CURLM_OK);
        $error = 0;
        $result = array();
        foreach($requests as $k => $request){
            $result = curl_multi_getcontent($request['curl_handle']);
            curl_multi_remove_handle($mh, $request['curl_handle']);
            curl_close($requests[$k]['curl_handle']);
            if(isset($_REQUEST['debug_noti'])){
                echo "<pre>";
                print_r($result);
            }
        }
        curl_multi_close($mh);
        if(isset($_REQUEST['debug_noti'])){
            exit();
        }
        return true;
    }
    private function getAccessTokenAndroid(){
        putenv('GOOGLE_APPLICATION_CREDENTIALS=' . $this->getConfigFile());
        $client = new Google\Client();
        $client->useApplicationDefaultCredentials();
        $client->addScope(Google\Service\FirebaseCloudMessaging::FIREBASE_MESSAGING);
        $client->refreshTokenWithAssertion();
        $token = $client->getAccessToken();
        $result = $token['access_token'];
        return $result;
    }
    private function getConfigFile(){
        global $tconfig;
        $file_path = $tconfig['tsite_script_file_path'] . 'gcs_config.json';
        if(file_exists($tconfig['tsite_script_file_path'] . 'fcm_credentials/' . GCS_SUFFIX . '_credentials.json')){
            $file_path = $tconfig['tsite_script_file_path'] . 'fcm_credentials/' . GCS_SUFFIX . '_credentials.json';
        }
        return $file_path;
    }
    private function getAccessTokenHuawei(){
        global $HMS_CLIENT_ID, $HMS_SECRET_KEY;
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://oauth-login.cloud.huawei.com/oauth2/v3/token');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
        curl_setopt($ch, CURLOPT_HTTPHEADER, [ 'Content-Type' => 'application/x-www-form-urlencoded', ]);
        curl_setopt($ch, CURLOPT_POSTFIELDS, 'grant_type=client_credentials&client_id=' . $HMS_CLIENT_ID . '&client_secret=' . $HMS_SECRET_KEY);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
        $response = curl_exec($ch);
        curl_close($ch);
        $response = json_decode($response, true);
        return $response['access_token'];
    }
    private function executeRequestHuawei($registration_ids, $message, $alertMsg){
        global $HMS_PROJECT_ID;
        if(scount($registration_ids)> 999){
            $newArr = array_chunk($registration_ids, 999);
            $newArrMsg = array_chunk($message, 999);
            foreach($newArr as $k => $newRegistration_ids){
                $result = $this->executeRequestHuawei($newRegistration_ids, $newArrMsg[$k], $alertMsg);
            }
        }
        if(scount($registration_ids)> 1 && scount($message)> 1 && !isAssocArrGT($message)){
            $this->executeRequestMultiHuawei($registration_ids, $message, $alertMsg);
        }
        else {
            $message = isJsonText($message)? json_decode($message, true):(!isAssocArrGT($message)? $message[0] : $message);
            $post_data = array('validate_only' => false, 'message' => array('android' => array('urgency' => "NORMAL", 'ttl' => "10000s",), 'data' => json_encode($message), 'token' => $registration_ids));
            $finalFields = json_encode($post_data);
            $headers = array('Authorization: Bearer ' . $this->getAccessTokenHuawei(), 'Content-Type: application/json',);
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, 'https://push-api.cloud.huawei.com/v2/' . $HMS_PROJECT_ID . '/messages:send');
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $finalFields);
            $response = curl_exec($ch);
            if($response === false){
            }
            $responseArr = json_decode($response);
            $success = $responseArr->success;
            if(isset($_REQUEST['debug_noti'])){
                echo "<pre>";
                print_r($responseArr);
                print_r($registration_ids);
                print_r($message);
                exit;
            }
            curl_close($ch);
            return true;
        }
    }
    private function executeRequestMultiHuawei($registration_ids, $message, $alertMsg){
        global $HMS_PROJECT_ID;
        $requests = array();
        $mh = curl_multi_init();
        $headers = array('Authorization: Bearer ' . $this->getAccessTokenHuawei(), 'Content-Type: application/json',);
        foreach($registration_ids as $key => $value){
            $post_data = array('validate_only' => false, 'message' => array('notification' => array('title' => $alertMsg[$key], 'body' => $message[$key], 'click_action' => array('type' => 3),), 'android' => array('urgency' => "NORMAL", 'ttl' => "10000s", 'notification' => array('title' => $alertMsg[$key], 'body' => $message[$key], 'click_action' => array('type' => 3),),), 'data' => $message[$key], 'foreground_show' => false, 'token' => array($value)));
            $finalFields = json_encode($post_data, JSON_UNESCAPED_UNICODE);
            $requests[$key] = array();
            $requests[$key]['curl_handle'] = curl_init('https://push-api.cloud.huawei.com/v2/' . $HMS_PROJECT_ID . '/messages:send');
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_HTTPHEADER, $headers);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_POST, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_POSTFIELDS, $finalFields);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_RETURNTRANSFER, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_HEADER, true);
            curl_setopt($requests[$key]['curl_handle'], CURLOPT_SSL_VERIFYPEER, false);
            curl_multi_add_handle($mh, $requests[$key]['curl_handle']);
        }
        $stillRunning = false;
        do {
            $status = curl_multi_exec($mh, $stillRunning);
            if($stillRunning){
                curl_multi_select($mh);
            }
        }
        while($stillRunning && $status == CURLM_OK);
        $error = 0;
        $result = array();
        foreach($requests as $k => $request){
            $result = curl_multi_getcontent($request['curl_handle']);
            curl_multi_remove_handle($mh, $request['curl_handle']);
            curl_close($requests[$k]['curl_handle']);
            if(isset($_REQUEST['debug_noti'])){
                echo "<pre>";
                print_r($result);
            }
        }
        curl_multi_close($mh);
        if(isset($_REQUEST['debug_noti'])){
            exit();
        }
        return true;
    }
    private function publishEventMessage($channelNameArr, $messageArr){
        global $PUBSUB_TECHNIQUE, $PUBNUB_PUBLISH_KEY, $PUBNUB_SUBSCRIBE_KEY, $uuid;
        foreach($channelNameArr as $key => $channelName){
            $message = json_encode($messageArr[$key], JSON_UNESCAPED_UNICODE);
            if($PUBSUB_TECHNIQUE == "SocketCluster"){
                $this->executeRequest($channelName, $message);
            }
            else if($PUBSUB_TECHNIQUE == "PubNub"){
                global $pubNubClsObj;
                if(empty($pubNubClsObj)){
                    $pubnub = new Pubnub\Pubnub(array("publish_key" => $PUBNUB_PUBLISH_KEY, "subscribe_key" => $PUBNUB_SUBSCRIBE_KEY, "uuid" => $uuid));
                    $pubNubClsObj = $pubnub;
                }
                else {
                    $pubnub = $pubNubClsObj;
                }
                $info = $pubnub->publish($channelName, $message);
            }
        }
        return true;
    }
    private function addRequestSent($addRequestSentArr, $requestSent = "No", $ReqMsgCode="", $isTaxiBid = "No"){
        global $obj, $MONGO_OP_OBJ;
        $passenger_requests_arr = $driver_request_arr = array();
        $serverTimeZone = date_default_timezone_get();
        $currDate = @date("Y-m-d H:i:s");
        $datetime = converToTz($currDate, "UTC", $serverTimeZone);
        $datetime = new DateTime($datetime);
        $currDate = $datetime->format('Y-m-d\TH:i:s.u\Z');
        $currDateDB = @date("Y-m-d H:i:s");
        $data_userRequestDB = array();
        $data_userRequestDB['iUserId'] = $addRequestSentArr[0]['iUserId'];
        $data_userRequestDB['iDriverId'] = 0;
        $data_userRequestDB['tMessage'] = json_encode($addRequestSentArr[0]['tMessage'], JSON_UNESCAPED_UNICODE);
        $data_userRequestDB['iMsgCode'] = $addRequestSentArr[0]['iMsgCode'];
        $data_userRequestDB['dAddedDate'] = $currDateDB;
        $data_userRequestDB['vParentMsgCode'] = $ReqMsgCode;
        $dataId = $obj->MySQLQueryPerform("passenger_requests", $data_userRequestDB, 'insert');
        foreach($addRequestSentArr as $addRequestSent){
            $data_userRequest = $data_driverRequest = array();
            $data_userRequest['iUserId'] = $addRequestSent['iUserId'];
            $data_userRequest['iDriverId'] = $addRequestSent['iDriverId'];
            $data_userRequest['tMessage'] = json_encode($addRequestSent['tMessage'], JSON_UNESCAPED_UNICODE);
            $data_userRequest['iMsgCode'] = $addRequestSent['iMsgCode'];
            $data_userRequest['dAddedDate'] = $currDate;
            $data_userRequest['vParentMsgCode'] = $ReqMsgCode;
            if($requestSent == "No"){
                $data_userRequest['eType'] = $addRequestSent['eType'];
                $data_userRequest['eFavDriver'] = $addRequestSent['eFavDriver'];
                $data_userRequest['eIsPremium'] = $addRequestSent['eIsPremium'];
                $data_userRequest['distance'] = $addRequestSent['distance'];
                if(isset($addRequestSent['iCompanyId'])){
                    $data_userRequest['iCompanyId'] = $addRequestSent['iCompanyId'];
                }
                $data_userRequest['iCabBookingId'] = 0;
                if(isset($addRequestSent['iCabBookingId'])){
                    $data_userRequest['iCabBookingId'] = $addRequestSent['iCabBookingId'];
                }
                $passenger_requests_arr[] = $data_userRequest;
            }
            $data_driverRequest['iDriverId'] = $addRequestSent['iDriverId'];
            $data_driverRequest['iRequestId'] = $dataId;
            $data_driverRequest['iUserId'] = $addRequestSent['iUserId'];
            $data_driverRequest['iTripId'] = 0;
            $data_driverRequest['eStatus'] = "Pending";
            $data_driverRequest['vMsgCode'] = $addRequestSent['iMsgCode'];
            $data_driverRequest['vStartLatlong'] = $addRequestSent['vStartLatlong'];
            $data_driverRequest['vEndLatlong'] = $addRequestSent['vEndLatlong'];
            $data_driverRequest['tStartAddress'] = $addRequestSent['tStartAddress'];
            $data_driverRequest['tEndAddress'] = $addRequestSent['tEndAddress'];
            $data_driverRequest['tDate'] = $currDate;
            $data_driverRequest['dAddedDate'] = $currDate;
            if(isset($addRequestSent['iOrderId'])){
                $data_driverRequest['iOrderId'] = $addRequestSent['iOrderId'];
            }
            if($requestSent == "No"){
                $currDateDB = @date("Y-m-d H:i:s");
                $data_driverRequestDB = $data_driverRequest;
                $data_driverRequestDB['tDate'] = $currDateDB;
                $data_driverRequestDB['dAddedDate'] = $currDateDB;
                $obj->MySQLQueryPerform("driver_request", $data_driverRequestDB, 'insert');
                $data_driverRequest['statusLog']['Pending'] = $currDate;
                unset($data_driverRequest['iRequestId']);
                $driver_request_arr[] = $data_driverRequest;
            }
        }
        if($requestSent == "No"){
            if(!empty($passenger_requests_arr)){
                $passenger_requests_arr_final = array('iUserId' => $passenger_requests_arr[0]['iUserId'], 'iMsgCode' => $passenger_requests_arr[0]['iMsgCode'], 'dAddedDate' => $passenger_requests_arr[0]['dAddedDate'], 'eStatus' => 'Requesting', 'eType' => $passenger_requests_arr[0]['eType']);
                if(isset($passenger_requests_arr[0]['iCompanyId'])){
                    $passenger_requests_arr_final['iCompanyId'] = $passenger_requests_arr[0]['iCompanyId'];
                }
                $passenger_requests_arr_final['DRIVER_DATA'] = array();
                $c = 1;
                foreach($passenger_requests_arr as $req){
                    $req['order'] = $c;
                    $passenger_requests_arr_final['DRIVER_DATA'][$req['iDriverId']] = $req;
                    $c++;
                }
                $MONGO_OP_OBJ->addUserRequest($passenger_requests_arr_final);
            }
            if(!empty($driver_request_arr)){
                $driver_request_arr_final = array('vMsgCode' => $driver_request_arr[0]['vMsgCode'], 'dAddedDate' => $driver_request_arr[0]['dAddedDate']);
                $driver_request_arr_final['DRIVER_DATA'] = array();
                foreach($driver_request_arr as $req){
                    $driver_request_arr_final['DRIVER_DATA'][$req['iDriverId']] = $req;
                }
                $MONGO_OP_OBJ->addDriverRequest($driver_request_arr_final);
                $vMsgCode = $driver_request_arr[0]['vMsgCode'];
            }
            $passenger_requests_arr_final = json_encode(array($passenger_requests_arr_final), JSON_HEX_QUOT | JSON_HEX_TAG | JSON_UNESCAPED_UNICODE);
            $this->sendRequest(['userRequestsArr' => $passenger_requests_arr_final, 'vMsgCode' => $vMsgCode, 'isTaxiBid' => $isTaxiBid]);
        }
        return true;
    }
    private function addTripStatusMessage($tripStatusMsgArr){
        global $obj;
        foreach($tripStatusMsgArr as $tripStatusMsg){
            $DataTripMessages = array();
            $DataTripMessages['tMessage'] = json_encode($tripStatusMsg['tMessage'], JSON_UNESCAPED_UNICODE);
            $DataTripMessages['iDriverId'] = $tripStatusMsg['iDriverId'];
            $DataTripMessages['iTripId'] = $tripStatusMsg['iTripId'];
            $DataTripMessages['iUserId'] = $tripStatusMsg['iUserId'];
            $DataTripMessages['eFromUserType'] = $tripStatusMsg['eFromUserType'];
            $DataTripMessages['eToUserType'] = $tripStatusMsg['eToUserType'];
            $DataTripMessages['eReceived'] = $tripStatusMsg['eReceived'];
            $DataTripMessages['dAddedDate'] = @date("Y-m-d H:i:s");
            if(isset($tripStatusMsg['iOrderId'])){
                $DataTripMessages['iOrderId'] = $tripStatusMsg['iOrderId'];
            }
            $obj->MySQLQueryPerform("trip_status_messages", $DataTripMessages, 'insert');
        }
        return true;
    }
    public static function executeRequest($channelNames, $message){
        global $tconfig;
        $url = PHP_SOCKET_URL;
        $fields = [ 'CHANNEL_NAME' => $channelNames, 'DATA_TO_PUBLISH' => $message, 'SERVICE_AUTH_KEY' => "SERVICE_AUTH_KEY_XXXXXXXX", 'PORT_TO_CONNECT' => $tconfig["tsite_host_sc_port"], 'SOCKET_CLS_HOST' => $tconfig["tsite_sc_host"], 'SOCKET_CLS_PROTOCOL' => $tconfig["tsite_sc_protocol"] ];
        $fields_string = http_build_query($fields);
        $ch = curl_init();
        curl_setopt($ch,CURLOPT_URL, $url);
        curl_setopt($ch,CURLOPT_POST, true);
        curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string);
        curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch,CURLOPT_RETURNTRANSFER, true);
        $result = curl_exec($ch);
        return $result;
    }
    private function sendRequest($postData = array()){
        global $AUTH_MEMBER_OBJ;
        $postData['GeneralDeviceType'] = isset($_REQUEST['GeneralDeviceType'])? $_REQUEST['GeneralDeviceType'] : '';
        $postData['GeneralUserType'] = isset($_REQUEST['GeneralUserType'])? $_REQUEST['GeneralUserType'] : 'Passenger';
        if(empty($postData['GeneralDeviceType'])){
            $postData['GeneralDeviceType'] = "Android";
        }
        $package_tokens_arr = $AUTH_MEMBER_OBJ->getPackageData();
        if(strtoupper($postData['GeneralUserType'])== "COMPANY"){
            if(strtoupper($postData['GeneralDeviceType'])== "ANDROID"){
                $token = $package_tokens_arr['ANDROID_STORE'];
            }
            else {
                $token = $package_tokens_arr['IOS_STORE'];
            }
        }
        elseif(strtoupper($postData['GeneralUserType'])== "HOTEL"){
            $token = $package_tokens_arr['ANDROID_KIOSK'];
        }
        else {
            if(strtoupper($postData['GeneralDeviceType'])== "ANDROID"){
                $token = $package_tokens_arr['ANDROID_USER'];
            }
            else {
                $token = $package_tokens_arr['IOS_USER'];
            }
        }
        $token = encrypt_bycrypt($token);
        $ch = curl_init();
        curl_setopt($ch,CURLOPT_URL, APP_SERVICE_URL . 'sendRequestToDrivers');
        curl_setopt($ch,CURLOPT_POST, true);
        curl_setopt($ch,CURLOPT_POSTFIELDS, $postData);
        curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch,CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [ 'Authorization: Bearer ' . $token ]);
        $response = curl_exec($ch);
        $error_msg = curl_error($ch);
        if(!empty($error_msg)){
        }
        $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
    }
    private function generateUUIDv4(){
        $data = random_bytes(16);
        $data[6] = chr(ord($data[6])& 0x0f | 0x40);
        $data[8] = chr(ord($data[8])& 0x3f | 0x80);
        $uuid = vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4));
        return $uuid;
    }
}
class Language {
    public function __construct(){
    }
    public function FetchMemberSelectedLanguage($vEmail){
        global $obj, $vSystemDefaultLangCode;
        $preflang = "EN";
        $sql = "select vLang from register_user where vEmail ='" . $vEmail . "'";
        $res = $obj->MySQLSelect($sql);
        if(scount($res)> 0){
            $preflang = $res[0]['vLang'];
        }
        else {
            $sql = "select vLang From register_driver where vEmail = '" . $vEmail . "'";
            $res1 = $obj->MySQLSelect($sql);
            if(scount($res1)> 0){
                $preflang = $res1[0]['vLang'];
            }
            else {
                $sql = "SELECT vLang FROM `newsletter` where vEmail = '" . $vEmail . "'";
                $res3 = $obj->MySQLSelect($sql);
                if(!empty($res3)&& !empty($res3[0]['vLang'])){
                    $preflang = $res3[0]['vLang'];
                }
                else {
                    if(!empty($vSystemDefaultLangCode)){
                        $preflang = $vSystemDefaultLangCode;
                    }
                    if(empty($preflang)){
                        $sql = "select vCode from language_master where eDefault = 'Yes'";
                        $lang1 = $obj->MySQLSelect($sql);
                        if(scount($lang1)> 0){
                            $preflang = $lang1[0]['vCode'];
                        }
                    }
                }
            }
        }
        return $preflang;
    }
    public function FetchMemberSelectedLanguageDir($lang){
        global $obj, $Data_ALL_langArr;
        if(!empty($Data_ALL_langArr)&& scount($Data_ALL_langArr)> 0){
            foreach($Data_ALL_langArr as $language_item){
                if(strtoupper($language_item['vCode'])== strtoupper($lang)){
                    $preflangdir = $language_item['eDirectionCode'];
                }
            }
        }
        if(empty($preflangdir)){
            $sql = "select eDirectionCode from language_master where vCode = '" . $lang . "'";
            $lang1 = $obj->MySQLSelect($sql);
            $preflangdir = $lang1[0]['eDirectionCode'];
        }
        return $preflangdir;
    }
    public function FetchSystemDefaultLangName(){
        global $obj, $vSystemDefaultLangCode, $vSystemDefaultLangName;
        if(!empty($vSystemDefaultLangName)){
            return $vSystemDefaultLangName;
        }
        $sql = "SELECT vTitle FROM language_master where eStatus='Active' AND eDefault = 'Yes'";
        $data = $obj->MySQLSelect($sql);
        $vTitle = isset($data[0]["vTitle"])? $data[0]["vTitle"] : 'EN';
        return $vTitle;
    }
    public function FetchSystemDefaultLang(){
        global $obj, $vSystemDefaultLangCode, $vSystemDefaultLangName, $vSystemDefaultLangDirection, $oCache;
        if(empty($vSystemDefaultLangCode)){
            $defaultLangApcKey = md5('system_default_lang');
            $getDefaultLangCacheData = $oCache->getData($defaultLangApcKey);
            if(!empty($getDefaultLangCacheData)&& scount($getDefaultLangCacheData)> 0){
                $default_label = $getDefaultLangCacheData;
            }
            else {
                $sql = "SELECT `vTitle`, `vCode`, `eDirectionCode` FROM `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes' ";
                $default_label = $obj->MySQLSelect($sql);
                $oCache->setData($defaultLangApcKey, $default_label);
            }
            $vSystemDefaultLangCode =(isset($default_label[0]['vCode'])&& !empty($default_label[0]['vCode']))? $default_label[0]['vCode'] : 'EN';
            $vSystemDefaultLangName =(isset($default_label[0]['vTitle'])&& !empty($default_label[0]['vTitle']))? $default_label[0]['vTitle'] : 'EN';
            $vSystemDefaultLangDirection =(isset($default_label[0]['eDirectionCode'])&& !empty($default_label[0]['eDirectionCode']))? $default_label[0]['eDirectionCode'] : 'ltr';
        }
        return $vSystemDefaultLangCode;
    }
    public function getDefaultLanguageData(){
        global $obj, $vSystemDefaultLangCode, $vSystemDefaultLangName, $vSystemDefaultLangDirection, $oCache;
        if(empty($vSystemDefaultLangCode)){
            $defaultLangApcKey = md5('system_default_lang_data');
            $getDefaultLangCacheData = $oCache->getData($defaultLangApcKey);
            if(!empty($getDefaultLangCacheData)&& scount($getDefaultLangCacheData)> 0){
                $default_label = $getDefaultLangCacheData;
            }
            else {
                $sql = "SELECT `vTitle`, `vCode`, `eDirectionCode` FROM `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes' ";
                $default_label = $obj->MySQLSelect($sql);
                $oCache->setData($defaultLangApcKey, $default_label);
            }
            $vSystemDefaultLangCode =(isset($default_label[0]['vCode'])&& !empty($default_label[0]['vCode']))? $default_label[0]['vCode'] : 'EN';
            $vSystemDefaultLangName =(isset($default_label[0]['vTitle'])&& !empty($default_label[0]['vTitle']))? $default_label[0]['vTitle'] : 'EN';
            $vSystemDefaultLangDirection =(isset($default_label[0]['eDirectionCode'])&& !empty($default_label[0]['eDirectionCode']))? $default_label[0]['eDirectionCode'] : 'ltr';
        }
        $dataArr['vSystemDefaultLangCode']= $vSystemDefaultLangCode;
        $dataArr['vSystemDefaultLangName']= $vSystemDefaultLangName;
        $dataArr['vSystemDefaultLangDirection']= $vSystemDefaultLangDirection;
        return $dataArr;
    }
    public function FetchLanguageLabels($lCode = '', $directValue = "", $iServiceId = ""){
        global $obj, $APP_TYPE, $oCache;
        $defaultLangCodeApcKey = md5('system_default_lang_code');
        $getDefaultLangCodeCacheData = $oCache->getData($defaultLangCodeApcKey);
        if(!empty($getDefaultLangCodeCacheData)&& scount($getDefaultLangCodeCacheData)> 0){
            $default_label = $getDefaultLangCodeCacheData;
        }
        else {
            $sql = "SELECT `vCode` FROM `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes' ";
            $default_label = $obj->MySQLSelect($sql);
            $oCache->setData($defaultLangCodeApcKey, $default_label);
        }
        if($lCode == ''){
            $lCode =(isset($default_label[0]['vCode'])&& $default_label[0]['vCode'])? $default_label[0]['vCode'] : 'EN';
        }
        $LangLabelsApcKey = md5('language_label_union_other_' . $lCode);
        $getLangLabelsCacheData = $oCache->getData($LangLabelsApcKey);
        if(!empty($getLangLabelsCacheData)&& scount($getLangLabelsCacheData)> 0){
            $all_label = $getLangLabelsCacheData;
        }
        else {
            $sql = "SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = '" . $lCode . "' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = '" . $lCode . "' ";
            $all_label = $obj->MySQLSelect($sql);
            $oCache->setData($LangLabelsApcKey, $all_label);
        }
        $x = array();
        for($i = 0;
        $i < scount($all_label);
        $i++){
            $vLabel = $all_label[$i]['vLabel'];
            $vValue = $all_label[$i]['vValue'];
            $x[$vLabel] = $vValue;
        }
        $LangLabelsENApcKey = md5('language_label_union_other_EN');
        $getLangLabelsENCacheData = $oCache->getData($LangLabelsENApcKey);
        if(!empty($getLangLabelsENCacheData)&& scount($getLangLabelsENCacheData)> 0){
            $all_label_en = $getLangLabelsENCacheData;
        }
        else {
            $sql_en = "SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = 'EN' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = 'EN'";
            $all_label_en = $obj->MySQLSelect($sql_en);
            $oCache->setData($LangLabelsENApcKey, $all_label_en);
        }
        if(scount($all_label_en)> 0){
            for($i = 0;
            $i < scount($all_label_en);
            $i++){
                $vLabel_tmp = $all_label_en[$i]['vLabel'];
                $vValue_tmp = $all_label_en[$i]['vValue'];
                if(isset($x[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $x)){
                    if($x[$vLabel_tmp] == ""){
                        $x[$vLabel_tmp] = $vValue_tmp;
                    }
                }
                else {
                    $x[$vLabel_tmp] = $vValue_tmp;
                }
            }
        }
        if($APP_TYPE != 'Delivery'){
            if($iServiceId > 0){
                $LangLabelsServiceApcKey = md5('language_label_service_' . $iServiceId . '_' . $lCode);
                $getLangLabelsServiceCacheData = $oCache->getData($LangLabelsServiceApcKey);
                if(!empty($getLangLabelsServiceCacheData)&& scount($getLangLabelsServiceCacheData)> 0){
                    $all_label = $getLangLabelsServiceCacheData;
                }
                else {
                    $sql = "SELECT `vLabel` , `vValue` FROM `language_label_" . $iServiceId . "` WHERE `vCode` = '" . $lCode . "'";
                    $all_label = $obj->MySQLSelect($sql);
                    $oCache->setData($LangLabelsServiceApcKey, $all_label);
                }
                if(!empty($all_label)){
                    for($i = 0;
                    $i < scount($all_label);
                    $i++){
                        $vLabel = $all_label[$i]['vLabel'];
                        $vValue = $all_label[$i]['vValue'];
                        $x[$vLabel] = $vValue;
                    }
                    $LangLabelsServiceENApcKey = md5('language_label_service_' . $iServiceId . '_EN');
                    $getLangLabelsServiceENCacheData = $oCache->getData($LangLabelsServiceENApcKey);
                    if(!empty($getLangLabelsServiceENCacheData)&& scount($getLangLabelsServiceENCacheData)> 0){
                        $all_label_en = $getLangLabelsServiceENCacheData;
                    }
                    else {
                        $sql_en = "SELECT `vLabel` , `vValue` FROM `language_label_" . $iServiceId . "` WHERE `vCode` = 'EN'";
                        $all_label_en = $obj->MySQLSelect($sql_en);
                        $oCache->setData($LangLabelsServiceENApcKey, $all_label_en);
                    }
                    if(scount($all_label_en)> 0){
                        for($i = 0;
                        $i < scount($all_label_en);
                        $i++){
                            $vLabel_tmp = $all_label_en[$i]['vLabel'];
                            $vValue_tmp = $all_label_en[$i]['vValue'];
                            if(isset($x[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $x)){
                                if($x[$vLabel_tmp] == ""){
                                    $x[$vLabel_tmp] = $vValue_tmp;
                                }
                            }
                            else {
                                $x[$vLabel_tmp] = $vValue_tmp;
                            }
                        }
                    }
                }
            }
        }
        $x['vCode'] = $lCode;
        if($directValue == ""){
            $returnArr['Action'] = "1";
            $returnArr['LanguageLabels'] = $x;
            return $returnArr;
        }
        else {
            return $x;
        }
    }
    public function FetchLanguageLabelsWeb($lCode = '', $directValue = "", $iServiceId = ""){
        global $obj, $APP_TYPE,$vSystemDefaultLangCode,$languageLabelDataArr,$oCache;
        if(!empty($vSystemDefaultLangCode)){
            $defaultLangCode = $vSystemDefaultLangCode;
        }
        else {
            $default_label = $obj->MySQLSelect("SELECT `vCode` FROM `language_master` WHERE eStatus = 'Active' AND `eDefault` = 'Yes' ");
            $defaultLangCode = $default_label[0]['vCode'];
        }
        if($lCode == ''){
            $lCode =(isset($defaultLangCode)&& $defaultLangCode)? $defaultLangCode: 'EN';
        }
        $LangLabelsWebApcKey = md5('language_label_union_other_' . $lCode);
        $getLangLabelsWebCacheData = $oCache->getData($LangLabelsWebApcKey);
        if(!empty($getLangLabelsWebCacheData)&& scount($getLangLabelsWebCacheData)> 0){
            $all_label = $getLangLabelsWebCacheData;
        }
        else {
            $sql = "SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = '" . $lCode . "' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = '" . $lCode . "' ";
            $all_label = $obj->MySQLSelect($sql);
            $oCache->setData($LangLabelsWebApcKey, $all_label);
        }
        $x = array();
        for($i = 0;
        $i < scount($all_label);
        $i++){
            $vLabel = $all_label[$i]['vLabel'];
            $vValue = $all_label[$i]['vValue'];
            $x[$vLabel] = $vValue;
        }
        $LangLabelsWebENApcKey = md5('language_label_union_other_EN');
        $getLangLabelsWebENCacheData = $oCache->getData($LangLabelsWebENApcKey);
        if(!empty($getLangLabelsWebENCacheData)&& scount($getLangLabelsWebENCacheData)> 0){
            $all_label_en = $getLangLabelsWebENCacheData;
        }
        else {
            $sql_en = "SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = 'EN' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = 'EN'";
            $all_label_en = $obj->MySQLSelect($sql_en);
            $oCache->setData($LangLabelsWebENApcKey, $all_label_en);
        }
        if(scount($all_label_en)> 0){
            for($i = 0;
            $i < scount($all_label_en);
            $i++){
                $vLabel_tmp = $all_label_en[$i]['vLabel'];
                $vValue_tmp = $all_label_en[$i]['vValue'];
                if(isset($x[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $x)){
                    if($x[$vLabel_tmp] == ""){
                        $x[$vLabel_tmp] = $vValue_tmp;
                    }
                }
                else {
                    $x[$vLabel_tmp] = $vValue_tmp;
                }
            }
        }
        if($APP_TYPE != 'Delivery'){
            if($iServiceId > 0){
                $LangLabelsServiceApcKey = md5('language_label_service_' . $iServiceId . '_' . $lCode);
                $getLangLabelsServiceCacheData = $oCache->getData($LangLabelsServiceApcKey);
                if(!empty($getLangLabelsServiceCacheData)&& scount($getLangLabelsServiceCacheData)> 0){
                    $all_label = $getLangLabelsServiceCacheData;
                }
                else {
                    $sql = "SELECT `vLabel` , `vValue` FROM `language_label_" . $iServiceId . "` WHERE `vCode` = '" . $lCode . "'";
                    $all_label = $obj->MySQLSelect($sql);
                    $oCache->setData($LangLabelsServiceApcKey, $all_label);
                }
                for($i = 0;
                $i < scount($all_label);
                $i++){
                    $vLabel = $all_label[$i]['vLabel'];
                    $vValue = $all_label[$i]['vValue'];
                    $x[$vLabel] = $vValue;
                }
                $LangLabelsServiceENApcKey = md5('language_label_service_' . $iServiceId . '_EN');
                $getLangLabelsServiceENCacheData = $oCache->getData($LangLabelsServiceENApcKey);
                if(!empty($getLangLabelsServiceENCacheData)&& scount($getLangLabelsServiceENCacheData)> 0){
                    $all_label_en = $getLangLabelsServiceENCacheData;
                }
                else {
                    $sql_en = "SELECT `vLabel` , `vValue` FROM `language_label_" . $iServiceId . "` WHERE `vCode` = 'EN'";
                    $all_label_en = $obj->MySQLSelect($sql_en);
                    $oCache->setData($LangLabelsServiceENApcKey, $all_label_en);
                }
                if(scount($all_label_en)> 0){
                    for($i = 0;
                    $i < scount($all_label_en);
                    $i++){
                        $vLabel_tmp = $all_label_en[$i]['vLabel'];
                        $vValue_tmp = $all_label_en[$i]['vValue'];
                        if(isset($x[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $x)){
                            if($x[$vLabel_tmp] == ""){
                                $x[$vLabel_tmp] = $vValue_tmp;
                            }
                        }
                        else {
                            $x[$vLabel_tmp] = $vValue_tmp;
                        }
                    }
                }
            }
        }
        $x['vCode'] = $lCode;
        if($directValue == ""){
            $returnArr['Action'] = "1";
            $returnArr['LanguageLabels'] = $x;
            return $returnArr;
        }
        else {
            return $x;
        }
    }
    public function checkOtherLangDataExist($data,$lang,$type_arr){
        global $tconfig,$template;
        if($lang=='EN'){
            return $data;
        }
        foreach($type_arr as $key=>$value){
            if(empty($data[$value.$lang])&& !empty($data[$value."EN"])){
                $data[$value.$lang] = $data[$value."EN"];
            }
            $pos = strpos($value, 'img');
            if($pos!==false){
                if(!file_exists($tconfig["tsite_upload_apptype_page_images_panel"].$template.'/'.$data[$value.$lang])){
                    $data[$value.$lang] = $data[$value."EN"];
                }
            }
        }
        return $data;
    }
    public function FetchDefaultLangData($field=""){
        global $vSystemDefaultLangCode,$vSystemDefaultLangName,$vSystemDefaultLangDirection,$vSystemDefaultLangvGMapLangCode,$Data_ALL_langArr;
        if(strtoupper($field)== "VCODE"){
            if(!empty($vSystemDefaultLangCode)){
                return $vSystemDefaultLangCode;
            }
            else {
                $vCode = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
                return $vCode;
            }
        }
        else if(strtoupper($field)== "VTITLE"){
            if(!empty($vSystemDefaultLangName)){
                return $vSystemDefaultLangName;
            }
            else {
                $vTitle = get_value('language_master', 'vTitle', 'eDefault', 'Yes', '', 'true');
                return $vTitle;
            }
        }
        else if(strtoupper($field)== "EDIRECTIONCODE"){
            if(!empty($vSystemDefaultLangDirection)){
                return $vSystemDefaultLangDirection;
            }
            else {
                $eDirectionCode = get_value('language_master', 'eDirectionCode', 'eDefault', 'Yes', '', 'true');
                return $eDirectionCode;
            }
        }
        else if(strtoupper($field)== "VGMAPLANGCODE"){
            if(!empty($vSystemDefaultLangvGMapLangCode)){
                return $vSystemDefaultLangvGMapLangCode;
            }
            else {
                $vGMapLangCode = get_value('language_master', 'vTitle', 'eDefault', 'Yes', '', 'true');
                return $vGMapLangCode;
            }
        }
        else {
            return $Data_ALL_langArr;
        }
    }
    public function checkLanguageExist($langCode = "EN"){
        global $obj;
        $langData = $obj->MySQLSelect("SELECT vCode FROM language_master WHERE vCode = '" . strtoupper($langCode). "' ");
        if(scount($langData)> 0){
            return true;
        }
        else {
            return false;
        }
    }
    public function getLangDataDefaultFirst($db_master_data){
        global $default_lang;
        $db_master = $db_master_data;
        $EN_available = $this->checkLanguageExist();
        foreach($db_master as $dkey => $dval){
            if($EN_available){
                if($dval['vCode'] == "EN"){
                    unset($db_master[$dkey]);
                    array_unshift($db_master, $dval);
                }
            }
            else {
                if($dval['vCode'] == $default_lang){
                    unset($db_master[$dkey]);
                    array_unshift($db_master, $dval);
                }
            }
        }
        return $db_master;
    }
    public function getLanguageData($lang){
        global $obj, $Data_ALL_langArr;
        if(!empty($Data_ALL_langArr)&& scount($Data_ALL_langArr)> 0){
            foreach($Data_ALL_langArr as $language_item){
                if(strtoupper($language_item['vCode'])== strtoupper($lang)){
                    return $language_item;
                }
            }
        }
        $result = $obj->MySQLSelect("SELECT * FROM language_master WHERE vCode = '".$lang."'");
        return $result[0];
    }
}
class Modules {
    public function __construct(){
    }
    public function isAirFlightModuleAvailable($admin = '', $isFromConfig = "No"){
        global $ENABLE_FLY_VEHICLES, $tconfig, $APP_TYPE, $obj;
        if(strtoupper($APP_TYPE)== "RIDE" || strtoupper($APP_TYPE)== "DELIVERY" || strtoupper($APP_TYPE)== "RIDE-DELIVERY" || strtoupper($APP_TYPE)== "UBERX" || strtoupper(ONLYDELIVERALL)== "YES"){
            return false;
        }
        $fly_stations_filepath = $tconfig["tpanel_path"] . "include/features/include_fly_stations.php";
        if(empty($ENABLE_FLY_VEHICLES)){
            $ENABLE_FLY_VEHICLES = get_value('configurations', 'vValue', 'vName', 'ENABLE_FLY_VEHICLES', '', true);
        }
        $fly_data = $obj->MySQLSelect("SELECT iVehicleCategoryId FROM " . getVehicleCategoryTblName(). " WHERE eCatType = 'Fly' AND eStatus != 'Deleted'");
        if(file_exists($fly_stations_filepath)&& strtoupper($ENABLE_FLY_VEHICLES)== 'YES' && !empty($fly_data)){
            $flyModuleAvailable = true;
            if($flyModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO"){
                return $this->isRideFeatureAvailable();
            }
            return $flyModuleAvailable;
        }
        return false;
    }
    public function isGojekGopayModuleAvailable(){
        global $obj, $APP_TYPE, $PACKAGE_TYPE, $generalSystemConfigDataArr, $tconfig;
        $gojek_gopay_filepath = $tconfig["tpanel_path"] . "include/features/include_gojek_gopay.php";
        if(!empty($generalSystemConfigDataArr['ENABLE_GOPAY'])){
            $EnableGopay = $generalSystemConfigDataArr['ENABLE_GOPAY'];
        }
        else {
            $EnableGopay = get_value('configurations_payment', 'vValue', 'vName', 'ENABLE_GOPAY', '', true);
        }
        if(file_exists($gojek_gopay_filepath)&& strtoupper($EnableGopay)== 'YES'){
            return true;
        }
        return false;
    }
    public function isDriverSubscriptionModuleAvailable(){
        global $obj, $APP_TYPE, $PACKAGE_TYPE, $CONFIG_OBJ, $generalSystemConfigDataArr, $DRIVER_SUBSCRIPTION_ENABLE, $tconfig;
        $DriverSubscriptionFilepath = $tconfig["tpanel_path"] . "include/features/include_driver_subscription.php";
        if(empty($DRIVER_SUBSCRIPTION_ENABLE)){
            $DRIVER_SUBSCRIPTION_ENABLE = $DRIVER_SUBSCRIPTION_ENABLE[0]['vValue'];
        }
        if(file_exists($DriverSubscriptionFilepath)&& strtoupper($DRIVER_SUBSCRIPTION_ENABLE)== 'YES' && ONLYDELIVERALL != "Yes"){
            return true;
        }
        return false;
    }
    public function isOrganizationModuleEnable(){
        global $tab, $ENABLE_CORPORATE_PROFILE;
        if(PACKAGE_TYPE == 'SHARK' &&($tab == "true")&& $ENABLE_CORPORATE_PROFILE == 'Yes' && strtoupper(APP_TYPE)!= "DELIVERY" && strtoupper(APP_TYPE)!= "UBERX" && strtoupper(ONLYDELIVERALL)!= "YES"){
            $IS_CORPORATE_PROFILE_ENABLED = strtoupper($ENABLE_CORPORATE_PROFILE)== "YES" ? true : false;
        }
        else {
            $IS_CORPORATE_PROFILE_ENABLED = false;
        }
        return $IS_CORPORATE_PROFILE_ENABLED;
    }
    public function isInsuranceReportEnable(){
        global $ENABLE_INSURANCE_IDLE_REPORT, $ENABLE_INSURANCE_ACCEPT_REPORT, $ENABLE_INSURANCE_TRIP_REPORT;
        if(PACKAGE_TYPE == 'SHARK' && strtoupper(APP_TYPE)!= 'UBERX' && strtoupper(ONLYDELIVERALL)!= "YES" &&($ENABLE_INSURANCE_IDLE_REPORT == 'Yes' || $ENABLE_INSURANCE_ACCEPT_REPORT == 'Yes' || $ENABLE_INSURANCE_TRIP_REPORT == 'Yes')){
            return true;
        }
        else {
            return false;
        }
    }
    public function isManualBookingAvailable(){
        global $THEME_OBJ;
        if((strtoupper($THEME_OBJ->isXThemeActive())== 'YES')&& strtoupper(ENABLE_EXTENDED_VERSION_MANUAL_BOOKING)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isMongoDBAvailable(){
        global $obj;
        if(strtoupper(ENABLE_MONGO_CONNECTION)== "YES" && $obj->isMongoDBConnected()){
            return true;
        }
        return false;
    }
    public function isMemcachedAvailable(){
        if(!empty(ENABLE_MEMCACHED)&& strtoupper(ENABLE_MEMCACHED)== "YES"){
            return true;
        }
        return false;
    }
    public function mapAPIreplacementAvailable(){
        global $tconfig, $addOnsDataArr_orig, $obj;
        $isMapiReplacementAvail = false;
        if($this->isMongoDBAvailable()&&(file_exists($tconfig["tpanel_path"] . '/' . SITE_ADMIN_URL . "/map_api_setting.php")&& file_exists($tconfig["tpanel_path"] . '/' . SITE_ADMIN_URL . "/map_api_mongo_auth_places_action.php")&& file_exists($tconfig["tpanel_path"] . '/' . SITE_ADMIN_URL . "/map_api_mongo_auth_places.php"))){
            if(empty($addOnsDataArr_orig)){
                $addOnsDataArr_orig = $obj->MySQLSelect("SELECT lAddOnConfiguration,eCubejekX,eCubeX FROM setup_info LIMIT 0,1");
            }
            $addOnsJSONObj = json_decode($addOnsDataArr_orig[0]['lAddOnConfiguration'], true);
            $GOOGLE_PLAN_VAL = intVal($addOnsJSONObj['GOOGLE_PLAN']);
            $GOOGLE_PLAN = empty($addOnsJSONObj['GOOGLE_PLAN'])? "No" :(($GOOGLE_PLAN_VAL == 1 || $GOOGLE_PLAN_VAL == 2 || $GOOGLE_PLAN_VAL == 3)? "Yes" : "No");
            if($GOOGLE_PLAN == "Yes"){
                $isMapiReplacementAvail = true;
            }
        }
        return $isMapiReplacementAvail;
    }
    public function isDocumentExpiredFeatureEnable(){
        return !empty(ENABLE_EXPIRE_DOCUMENT)&& strtoupper(ENABLE_EXPIRE_DOCUMENT)== "YES" ? true : false;
    }
    public function isAutoCreditToDriverModuleAvailable(){
        global $obj, $generalSystemConfigDataArr, $tconfig;
        $auto_credit_driver_filepath = $tconfig["tpanel_path"] . "include/features/include_auto_credit_driver.php";
        if(!empty($generalSystemConfigDataArr['CREDIT_TO_WALLET_ENABLE'])){
            $EnableCreditWalletDriver = $generalSystemConfigDataArr['CREDIT_TO_WALLET_ENABLE'];
        }
        else {
            $EnableCreditWalletDriver = get_value('configurations_payment', 'vValue', 'vName', 'CREDIT_TO_WALLET_ENABLE', '', true);
        }
        if(file_exists($auto_credit_driver_filepath)&& strtoupper($EnableCreditWalletDriver)== 'YES'){
            return true;
        }
        return false;
    }
    public function isEnableHotelPanel($isFromConfig = "No"){
        if(strtoupper(APP_TYPE)== "UBERX" || strtoupper(APP_TYPE)== "DELIVERY" || strtoupper(ONLYDELIVERALL)== "YES" || !$this->isRideFeatureAvailable($isFromConfig)){
            return false;
        }
        return !empty(ENABLEHOTELPANEL)&& strtoupper(ENABLEHOTELPANEL)== "YES" ? true : false;
    }
    public function isEnableKioskPanel($isFromConfig = "No"){
        if(strtoupper(APP_TYPE)== "UBERX" || strtoupper(APP_TYPE)== "DELIVERY" || strtoupper(ONLYDELIVERALL)== "YES" || !$this->isRideFeatureAvailable($isFromConfig)){
            return false;
        }
        return !empty(ENABLEKIOSKPANEL)&& strtoupper(ENABLEKIOSKPANEL)== "YES" ? true : false;
    }
    public function isStoreClassificationEnable(){
        global $ENABLE_STORE_CATEGORIES_MODULE;
        if(!empty($ENABLE_STORE_CATEGORIES_MODULE)&& strtoupper($ENABLE_STORE_CATEGORIES_MODULE)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isFavouriteStoreModuleAvailable(){
        global $ENABLE_FAVORITE_STORE_MODULE, $tconfig;
        $fav_store_file_path = $tconfig["tpanel_path"] . "include/features/include_fav_store.php";
        if(file_exists($fav_store_file_path)&& strtoupper($ENABLE_FAVORITE_STORE_MODULE)== 'YES' && strtoupper(DELIVERALL)== "YES"){
            return true;
        }
        return false;
    }
    public function isDeliveryPreferenceEnable(){
        global $ENABLE_DELIVERY_PREFERENCE;
        return !empty($ENABLE_DELIVERY_PREFERENCE)&& strtoupper($ENABLE_DELIVERY_PREFERENCE)== "YES" ? true : false;
    }
    public function isTakeAwayEnable(){
        global $APP_PAYMENT_MODE, $ENABLE_TAKE_AWAY;
        if($ENABLE_TAKE_AWAY == 'Yes' && strtoupper($APP_PAYMENT_MODE)!= "CASH"){
            return true;
        }
        else {
            return false;
        }
    }
    public function isSingleStoreSelection(){
        global $IS_SINGLE_STORE_SELECTION;
        if(!empty($IS_SINGLE_STORE_SELECTION)&& strtoupper($IS_SINGLE_STORE_SELECTION)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isStorePersonalDriverAvailable(){
        global $ENABLE_ADD_PROVIDER_FROM_STORE;
        if(!empty($ENABLE_ADD_PROVIDER_FROM_STORE)&& strtoupper($ENABLE_ADD_PROVIDER_FROM_STORE)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableStoreSafetyProcedure(){
        global $ENABLE_SAFETY_PRACTICE;
        if(!empty($ENABLE_SAFETY_PRACTICE)&& strtoupper($ENABLE_SAFETY_PRACTICE)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isRideFeatureAvailable($isFromConfig = "No"){
        if((!empty(ONLYDELIVERALL)&& strtoupper(ONLYDELIVERALL)== "YES")|| strtoupper(APP_TYPE)== "DELIVERY" || strtoupper(APP_TYPE)== "UBERX" ||(defined('ENABLE_DELIVERYKING_THEME')&& strtoupper(ENABLE_DELIVERYKING_THEME)== "YES")|| strtoupper(RIDE_ENABLED)== "NO"){
            return false;
        }
        $rideModuleAvailable =(!empty(RIDE_MODULE_AVAILABLE)&& strtoupper(RIDE_MODULE_AVAILABLE)== "NO")|| strtoupper(RIDE_ENABLED)== "NO" ? false : true;
        if($rideModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("Ride")? true : false;
        }
        return $rideModuleAvailable;
    }
    public function isDeliverAllFeatureAvailable($isFromConfig = "No"){
        if((!empty(DELIVERALL)&& strtoupper(DELIVERALL)== "NO")|| strtoupper(APP_TYPE)== "RIDE" || strtoupper(APP_TYPE)== "DELIVERY" || strtoupper(APP_TYPE)== "RIDE-DELIVERY" || strtoupper(APP_TYPE)== "UBERX" || strtoupper(DELIVERALL_ENABLED)== "NO"){
            return false;
        }
        $deliverallModuleAvailable =(!empty(DELIVERALL_MODULE_AVAILABLE)&& strtoupper(DELIVERALL_MODULE_AVAILABLE)== "NO")|| strtoupper(DELIVERALL_ENABLED)== "NO" ? false : true;
        if($deliverallModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            if($this->isEnableAppHomeScreenLayoutV3()){
                return isMasterServiceCategoryAvailable("DeliverAll")? true : false;
            }
            else {
                return isMasterServiceCategoryAvailable("Deliver")? true : false;
            }
        }
        return $deliverallModuleAvailable;
    }
    public function isDeliveryFeatureAvailable($isFromConfig = "No"){
        if((!empty(ONLYDELIVERALL)&& strtoupper(ONLYDELIVERALL)== "YES")|| strtoupper(APP_TYPE)== "RIDE" || strtoupper(APP_TYPE)== "UBERX" || strtoupper(DELIVERY_ENABLED)== "NO"){
            return false;
        }
        $deliveryModuleAvailable =(!empty(DELIVERY_MODULE_AVAILABLE)&& strtoupper(DELIVERY_MODULE_AVAILABLE)== "NO")|| strtoupper(DELIVERY_ENABLED)== "NO" ? false : true;
        if($deliveryModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("Deliver")? true : false;
        }
        return $deliveryModuleAvailable;
    }
    public function isUberXFeatureAvailable($isFromConfig = "No"){
        global $obj, $oCache;
        if(strtoupper(ENABEL_SERVICE_PROVIDER_MODULE)== 'NO' ||(defined('ENABLE_DELIVERYKING_THEME')&& strtoupper(ENABLE_DELIVERYKING_THEME)== "YES")|| strtoupper(UFX_ENABLED)== "NO"){
            return false;
        }
        if(strtoupper(ONLYDELIVERALL)== 'YES'){
            return false;
        }
        if(!empty(IS_CUBE_X_THEME)&& IS_CUBE_X_THEME == "Yes"){
            return false;
        }
        if(strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX" || strtoupper(APP_TYPE)== "UBERX" || strtoupper(UFX_ENABLED)== "YES"){
            $ufx_data = $obj->MySQLSelect("SELECT COUNT(iVehicleCategoryId)AS Total FROM " . getVehicleCategoryTblName(). " WHERE eCatType = 'ServiceProvider'");
            if(!empty($ufx_data[0]['Total'])&& $ufx_data[0]['Total'] > 0){
                $ufxModuleAvailable = true;
                if($ufxModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
                    return isMasterServiceCategoryAvailable("UberX")? true : false;
                }
                return $ufxModuleAvailable;
            }
            else {
                return false;
            }
        }
        return false;
    }
    public function isRentalFeatureAvailable(){
        global $obj;
        if((!empty(ONLYDELIVERALL)&& strtoupper(ONLYDELIVERALL)== "YES")|| strtoupper(APP_TYPE)== "DELIVERY" || strtoupper(APP_TYPE)== "UBERX" ||(defined('ENABLE_DELIVERYKING_THEME')&& strtoupper(ENABLE_DELIVERYKING_THEME)== "YES")){
            return false;
        }
        $rental_data = $obj->MySQLSelect("SELECT COUNT(iVehicleCategoryId)AS Total FROM " . getVehicleCategoryTblName(). " WHERE(eCatType = 'Rental' OR eCatType = 'MotoRental')AND eStatus='Active'");
        if(empty($rental_data[0]['Total'])|| $rental_data[0]['Total'] == 0){
            return false;
        }
        return(!empty(ENABLE_RENTAL_OPTION)&& strtoupper(ENABLE_RENTAL_OPTION)== "YES")? true : false;
    }
    public function isEnableServerRequirementValidation(){
        if(!empty(ENABLE_SERVER_REQUIREMENT_VALIDATION)&& strtoupper(ENABLE_SERVER_REQUIREMENT_VALIDATION)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isEnableTermsServiceCategories(){
        global $ENABLE_TERMS_SERVICE_CATEGORIES;
        return !empty($ENABLE_TERMS_SERVICE_CATEGORIES)&& strtoupper($ENABLE_TERMS_SERVICE_CATEGORIES)== "YES" ? true : false;
    }
    public function isEnableProofUploadServiceCategories(){
        global $ENABLE_PROOF_UPLOAD_SERVICE_CATEGORIES;
        return !empty($ENABLE_PROOF_UPLOAD_SERVICE_CATEGORIES)&& strtoupper($ENABLE_PROOF_UPLOAD_SERVICE_CATEGORIES)== "YES" ? true : false;
    }
    public function isOnlyDeliverAllSystem(){
        if($this->isRideFeatureAvailable()== false && $this->isDeliveryFeatureAvailable()== false && $this->isUberXFeatureAvailable()== false && $this->isDeliverAllFeatureAvailable()== true){
            return true;
        }
        return false;
    }
    public function isEnableNewWalletWithdrawalFlowForDriver(){
        return !empty(ENABLE_NEW_WALLET_WITHDRAWAL_FLOW_DRIVER)&& strtoupper(ENABLE_NEW_WALLET_WITHDRAWAL_FLOW_DRIVER)== "YES" ? true : false;
    }
    public function isEnableBulkImportItems(){
        return !empty(ENABLE_BULK_ITEM_DATA)&& strtoupper(ENABLE_BULK_ITEM_DATA)== "YES" ? true : false;
    }
    public function isEnableDistanceWiseDeliveryChargeOrder(){
        global $ENABLE_CUSTOM_DELIVERY_CHARGE_ORDER;
        if(!empty($ENABLE_CUSTOM_DELIVERY_CHARGE_ORDER)&& strtoupper($ENABLE_CUSTOM_DELIVERY_CHARGE_ORDER)== 'YES'){
            return true;
        }
        return false;
    }
    public function isEnableDeliveryTipFeatureDeliverAll(){
        global $ENABLE_TIP_MODULE_DELIVERALL;
        if(!empty($ENABLE_TIP_MODULE_DELIVERALL)&& strtoupper($ENABLE_TIP_MODULE_DELIVERALL)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableRoundingMethod(){
        global $ENABLE_ROUNDING_OPTIONS;
        if(!empty($ENABLE_ROUNDING_OPTIONS)&& strtoupper($ENABLE_ROUNDING_OPTIONS)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableReverseFormatFeature(){
        global $ENABLE_REVERSE_FORMATTING;
        if(!empty($ENABLE_REVERSE_FORMATTING)&& strtoupper($ENABLE_REVERSE_FORMATTING)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableMultiLevelReferralSystem(){
        global $MULTI_LEVEL_REFERRAL_SCHEME_ENABLE, $REFERRAL_SCHEME_ENABLE;
        if(!empty($MULTI_LEVEL_REFERRAL_SCHEME_ENABLE)&& !empty($REFERRAL_SCHEME_ENABLE)&& strtoupper($MULTI_LEVEL_REFERRAL_SCHEME_ENABLE)== "YES" && strtoupper($REFERRAL_SCHEME_ENABLE)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableAnywhereDeliveryFeature($isFromConfig = "No"){
        global $ENABLE_BUY_ANY_SERVICE_MODULE;
        if((!empty($ENABLE_BUY_ANY_SERVICE_MODULE)&& strtoupper($ENABLE_BUY_ANY_SERVICE_MODULE)== "YES")&&(strtoupper(GENIE_ENABLED)== "YES" || strtoupper(RUNNER_ENABLED)== "YES")){
            $genieModuleAvailable = true;
            if($genieModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO"){
                return isMasterServiceCategoryAvailable("Deliver")? true : false;
            }
            return $genieModuleAvailable;
        }
        return false;
    }
    public function isEnableOutstandingRestriction(){
        global $ENABLE_OUTSTANDING_RESTRICTION;
        if(!empty($ENABLE_OUTSTANDING_RESTRICTION)&& strtoupper($ENABLE_OUTSTANDING_RESTRICTION)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableAppHomePageListView(){
        global $APP_HOME_PAGE_LIST_VIEW_ENABLED;
        if(!empty($APP_HOME_PAGE_LIST_VIEW_ENABLED)&& strtoupper($APP_HOME_PAGE_LIST_VIEW_ENABLED)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableServiceWiseProviderDoc(){
        global $ENABLE_SERVICE_TYPE_WISE_PROVIDER_DOC;
        if(!empty($ENABLE_SERVICE_TYPE_WISE_PROVIDER_DOC)&& strtoupper($ENABLE_SERVICE_TYPE_WISE_PROVIDER_DOC)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableDeliveryScheduleLaterBooking(){
        global $DELIVERY_LATER_BOOKING_ENABLED;
        if(!empty($DELIVERY_LATER_BOOKING_ENABLED)&& strtoupper($DELIVERY_LATER_BOOKING_ENABLED)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableRideFareModelStrategy(){
        global $ENABLE_FARE_MODEL_STRATEGY;
        if(!empty($ENABLE_FARE_MODEL_STRATEGY)&& strtoupper($ENABLE_FARE_MODEL_STRATEGY)== "YES" && $this->isRideFeatureAvailable()== true){
            return true;
        }
        return false;
    }
    public function isEnableItemSearchStoreOrder(){
        global $ENABLE_ITEM_SEARCH_STORE_ORDER;
        if(!empty($ENABLE_ITEM_SEARCH_STORE_ORDER)&& strtoupper($ENABLE_ITEM_SEARCH_STORE_ORDER)== "YES" && $this->isDeliverAllFeatureAvailable()== true){
            return true;
        }
        return false;
    }
    public function isEnableTimeslotFeature(){
        global $ENABLE_TIMESLOT_ADDON;
        if(!empty($ENABLE_TIMESLOT_ADDON)&& strtoupper($ENABLE_TIMESLOT_ADDON)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableRestrictPassengerLimit(){
        global $ENABLE_RESTRICT_PASSENGER_LIMIT;
        if(!empty($ENABLE_RESTRICT_PASSENGER_LIMIT)&& strtoupper($ENABLE_RESTRICT_PASSENGER_LIMIT)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableSafetyGuidelines(){
        global $ENABLE_SAFETY_CHECKLIST;
        if(!empty($ENABLE_SAFETY_CHECKLIST)&& strtoupper($ENABLE_SAFETY_CHECKLIST)== "YES"){
            return true;
        }
        return false;
    }
    public function isEnableStoreWiseCommission(){
        global $ENABLE_STORE_WISE_COMMISSION;
        if(!empty($ENABLE_STORE_WISE_COMMISSION)&& strtoupper($ENABLE_STORE_WISE_COMMISSION)== "YES"){
            return true;
        }
        return false;
    }
    public function autoDeductDriverCommision($eSystem){
        global $COMMISION_DEDUCT_ENABLE, $COMMISION_DEDUCT_ENABLE_DELIVERALL;
        if(strtoupper($eSystem)== "DELIVERALL"){
            return $COMMISION_DEDUCT_ENABLE_DELIVERALL;
        }
        return $COMMISION_DEDUCT_ENABLE;
    }
    public function isApplyTaxOnTollAndOtherCharges(){
        return !empty(ENABLE_TAX_IN_TOLL_OTHER_CHARGES)&& strtoupper(ENABLE_TAX_IN_TOLL_OTHER_CHARGES)== "YES" ? true : false;
    }
    public function isEnableMsiteFacility(){
        global $ENABLE_MSITE_FACILITY;
        return !empty($ENABLE_MSITE_FACILITY)&& strtoupper($ENABLE_MSITE_FACILITY)== "YES" ? true : false;
    }
    public function isEnableVoiceDeliveryInstructionsOrder(){
        global $ENABLE_DELIVERY_INSTRUCTIONS_ORDERS;
        return !empty($ENABLE_DELIVERY_INSTRUCTIONS_ORDERS)&& strtoupper($ENABLE_DELIVERY_INSTRUCTIONS_ORDERS)== "YES" ? true : false;
    }
    public function isEnableAutoAcceptStoreOrder(){
        global $ENABLE_AUTO_ACCEPT_STORE_ORDER;
        return !empty($ENABLE_AUTO_ACCEPT_STORE_ORDER)&& strtoupper($ENABLE_AUTO_ACCEPT_STORE_ORDER)== "YES" ? true : false;
    }
    public function isEnableManualAssignProvider(){
        global $ENABLE_ASSIGN_DRIVER_DELIVERALL_ADMIN;
        return !empty($ENABLE_ASSIGN_DRIVER_DELIVERALL_ADMIN)&& strtoupper($ENABLE_ASSIGN_DRIVER_DELIVERALL_ADMIN)== "YES" ? true : false;
    }
    public function isEnableAcceptingOrderFromWeb(){
        global $ENABLE_ACCEPT_ORDER_WEB_PLATFORM;
        return !empty($ENABLE_ACCEPT_ORDER_WEB_PLATFORM)&& strtoupper($ENABLE_ACCEPT_ORDER_WEB_PLATFORM)== "YES" ? true : false;
    }
    public function isEnableDeliveryHelper(){
        global $ENABLE_DELIVERY_HELPER;
        return !empty($ENABLE_DELIVERY_HELPER)&& strtoupper($ENABLE_DELIVERY_HELPER)== "YES" ? true : false;
    }
    public function isEnableStorePhotoUploadFacility(){
        global $ENABLE_STORE_WISE_BANNER;
        return !empty($ENABLE_STORE_WISE_BANNER)&& strtoupper($ENABLE_STORE_WISE_BANNER)== "YES" ? true : false;
    }
    public function isEnableCancelDriverOrder(){
        global $ENABLE_CANCEL_DRIVER_ORDER;
        return !empty($ENABLE_CANCEL_DRIVER_ORDER)&& strtoupper($ENABLE_CANCEL_DRIVER_ORDER)== "YES" ? true : false;
    }
    public function isEnableOrderInventoryStore(){
        global $ENABLE_ORDER_INVENTORY_STORE;
        return !empty($ENABLE_ORDER_INVENTORY_STORE)&& strtoupper($ENABLE_ORDER_INVENTORY_STORE)== "YES" ? true : false;
    }
    public function isEnableOTPVerificationRide(){
        global $ENABLE_OTP_RIDE;
        return !empty($ENABLE_OTP_RIDE)&& strtoupper($ENABLE_OTP_RIDE)== "YES" ? true : false;
    }
    public function isEnableOTPVerificationDelivery(){
        global $ENABLE_OTP_DELIVERY;
        return !empty($ENABLE_OTP_DELIVERY)&& strtoupper($ENABLE_OTP_DELIVERY)== "YES" ? true : false;
    }
    public function isEnableOTPVerificationUberX(){
        global $ENABLE_OTP_UFX;
        return !empty($ENABLE_OTP_UFX)&& strtoupper($ENABLE_OTP_UFX)== "YES" ? true : false;
    }
    public function isEnableOTPVerificationDeliverAll(){
        global $ENABLE_OTP_DELIVERALL;
        return !empty($ENABLE_OTP_DELIVERALL)&& strtoupper($ENABLE_OTP_DELIVERALL)== "YES" ? true : false;
    }
    public function isEnableCustomNotification(){
        global $ENABLE_CUSTOM_NOTIFICATION;
        return !empty($ENABLE_CUSTOM_NOTIFICATION)&& strtoupper($ENABLE_CUSTOM_NOTIFICATION)== "YES" ? true : false;
    }
    public function isEnableWalletWithdrawRequestRestriction(){
        global $ENABLE_WALLET_WITHDRAWAL_REQUEST_RESTRICTION;
        return !empty($ENABLE_WALLET_WITHDRAWAL_REQUEST_RESTRICTION)&& strtoupper($ENABLE_WALLET_WITHDRAWAL_REQUEST_RESTRICTION)== "YES" ? true : false;
    }
    public function isEnableAcceptMultipleOrders(){
        global $ENABLE_ACCEPT_MULTIPLE_ORDERS;
        return !empty($ENABLE_ACCEPT_MULTIPLE_ORDERS)&& strtoupper($ENABLE_ACCEPT_MULTIPLE_ORDERS)== "YES" ? true : false;
    }
    public function isEnableRideDeliveryV1(){
        global $ENABLE_RIDE_DELIVERY_NEW_FLOW;
        return !empty($ENABLE_RIDE_DELIVERY_NEW_FLOW)&& strtoupper($ENABLE_RIDE_DELIVERY_NEW_FLOW)== "YES" ? true : false;
    }
    public function isEnableAppHomeScreenLayoutV1(){
        global $ENABLE_NEW_HOME_SCREEN_LAYOUT_APP;
        return !empty($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP)&& strtoupper($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP)== "YES" ? true : false;
    }
    public function isEnableSearchUfxServices(){
        global $ENABLE_SEARCH_UFX_SERVICES;
        return !empty($ENABLE_SEARCH_UFX_SERVICES)&& strtoupper($ENABLE_SEARCH_UFX_SERVICES)== "YES" ? true : false;
    }
    public function isEnableMultiOptionsToppings(){
        global $ENABLE_MULTI_OPTIONS_ADDONS;
        return !empty($ENABLE_MULTI_OPTIONS_ADDONS)&& strtoupper($ENABLE_MULTI_OPTIONS_ADDONS)== "YES" ? true : false;
    }
    public function isEnableFoodRatingDetailFlow(){
        global $ENABLE_FOOD_RATING_DETAIL_FLOW;
        return !empty($ENABLE_FOOD_RATING_DETAIL_FLOW)&& strtoupper($ENABLE_FOOD_RATING_DETAIL_FLOW)== "YES" ? true : false;
    }
    public function isEnableCookieConsent(){
        global $ENABLE_COOKIE_CONSENT;
        return !empty($ENABLE_COOKIE_CONSENT)&& strtoupper($ENABLE_COOKIE_CONSENT)== "YES" ? true : false;
    }
    public function isEnableRequireMenuItemSKU(){
        global $ENABLE_REQUIRE_MENU_ITEM_SKU;
        return !empty($ENABLE_REQUIRE_MENU_ITEM_SKU)&& strtoupper($ENABLE_REQUIRE_MENU_ITEM_SKU)== "YES" ? true : false;
    }
    public function isEnableStoreMultiServiceCategories(){
        global $ENABLE_STORE_MULTI_SERVICE_CATEGORIES;
        return !empty($ENABLE_STORE_MULTI_SERVICE_CATEGORIES)&& strtoupper($ENABLE_STORE_MULTI_SERVICE_CATEGORIES)== "YES" ? true : false;
    }
    public function isEnableLocationwiseBanner(){
        global $ENABLE_LOCATION_WISE_BANNER;
        return !empty($ENABLE_LOCATION_WISE_BANNER)&& strtoupper($ENABLE_LOCATION_WISE_BANNER)== "YES" ? true : false;
    }
    public function isEnableFreeDeliveryOrStoreSpecificPromoCode(){
        global $ENABLE_FREE_DELIVERY_OR_STORE_SPECIFIC_PROMO_CODE;
        return !empty($ENABLE_FREE_DELIVERY_OR_STORE_SPECIFIC_PROMO_CODE)&& strtoupper($ENABLE_FREE_DELIVERY_OR_STORE_SPECIFIC_PROMO_CODE)== "YES" ? true : false;
    }
    public function isEnableCountrywiseNotification(){
        global $ENABLE_COUNTRY_WISE_PUSH_NOTIFICATION;
        return !empty($ENABLE_COUNTRY_WISE_PUSH_NOTIFICATION)&& strtoupper($ENABLE_COUNTRY_WISE_PUSH_NOTIFICATION)== "YES" ? true : false;
    }
    public function isEnableLocationWisePromoCode(){
        global $ENABLE_LOCATION_WISE_PROMO_CODE;
        return !empty($ENABLE_LOCATION_WISE_PROMO_CODE)&& strtoupper($ENABLE_LOCATION_WISE_PROMO_CODE)== "YES" ? true : false;
    }
    public function isEnableDriverArrivalDistance(){
        global $ENABLE_DRIVER_ARRIVAL_DISTANCE_TO_USER_PICKUP_ADDRESS;
        return !empty($ENABLE_DRIVER_ARRIVAL_DISTANCE_TO_USER_PICKUP_ADDRESS)&& strtoupper($ENABLE_DRIVER_ARRIVAL_DISTANCE_TO_USER_PICKUP_ADDRESS)== "YES" ? true : false;
    }
    public function isEnableAppleLoginForProvider(){
        global $ENABLE_APPLE_LOGIN_FOR_PROVIDER;
        return !empty($ENABLE_APPLE_LOGIN_FOR_PROVIDER)&& strtoupper($ENABLE_APPLE_LOGIN_FOR_PROVIDER)== "YES" ? true : false;
    }
    public function isEnableAppleLoginForUser(){
        global $ENABLE_APPLE_LOGIN_FOR_USER;
        return !empty($ENABLE_APPLE_LOGIN_FOR_USER)&& strtoupper($ENABLE_APPLE_LOGIN_FOR_USER)== "YES" ? true : false;
    }
    public function isEnableSmartLogin(){
        global $ENABLE_SMART_LOGIN;
        return !empty($ENABLE_SMART_LOGIN)&& strtoupper($ENABLE_SMART_LOGIN)== "YES" ? true : false;
    }
    public function isEnableMultiDeliveryInBooking(){
        if($_SERVER['HTTP_HOST'] == "cubejekdev.bbcsproducts.net"){
            return false;
        }
        else {
            return false;
        }
    }
    public function checkFavDriverModule(){
        global $ENABLE_FAVORITE_DRIVER_MODULE, $tconfig;
        $fav_driver_file_path = $tconfig["tpanel_path"] . "include/features/include_fav_driver.php";
        if(file_exists($fav_driver_file_path)&& !empty($ENABLE_FAVORITE_DRIVER_MODULE)&& strtoupper($ENABLE_FAVORITE_DRIVER_MODULE)== 'YES' && strtoupper(ONLYDELIVERALL)== "NO"){
            return true;
        }
        return false;
    }
    public function checkDriverDestinationModule($adminfilepath = 0){
        global $ENABLE_DRIVER_DESTINATIONS, $APP_TYPE, $tconfig;
        $driver_destination_file_path = $tconfig["tpanel_path"] . "include/features/include_destinations_driver.php";
        if(file_exists($driver_destination_file_path)&& !empty($ENABLE_DRIVER_DESTINATIONS)&& strtoupper($ENABLE_DRIVER_DESTINATIONS)== 'YES' &&(($APP_TYPE == "Ride-Delivery")||($APP_TYPE == "Ride-Delivery-UberX")||($APP_TYPE == "Ride"))){
            return true;
        }
        return false;
    }
    public function checkSharkPackage(){
        global $tconfig, $type;
        if(strtoupper(PACKAGE_TYPE)!= "SHARK"){
            return false;
        }
        $shark_file_path = $tconfig['tpanel_path'] . "include/include_webservice_sharkfeatures.php";
        if(file_exists($shark_file_path)){
            include_once($shark_file_path);
            return true;
        }
        return false;
    }
    public function checkStopOverPointModule(){
        global $ENABLE_STOPOVER_POINT, $APP_TYPE, $tconfig;
        $stop_over_point_file_path = $tconfig["tpanel_path"] . "include/features/include_stop_over_point.php";
        if(file_exists($stop_over_point_file_path)&& !empty($ENABLE_STOPOVER_POINT)&& strtoupper($ENABLE_STOPOVER_POINT)== 'YES' &&(($APP_TYPE == "Ride-Delivery")||($APP_TYPE == "Ride-Delivery-UberX")||($APP_TYPE == "Ride"))){
            return true;
        }
        return false;
    }
    public function isDonationFeatureAvailable(){
        global $obj, $APP_TYPE, $DONATION_ENABLE, $CONFIG_OBJ, $tconfig;
        $DonationFilepath = $tconfig["tpanel_path"] . "include/features/include_donation.php";
        if(empty($DONATION_ENABLE)){
            $DONATION_ENABLE = $CONFIG_OBJ->getConfigurations("configurations", "DONATION_ENABLE");
        }
        if(file_exists($DonationFilepath)&& !empty($DONATION_ENABLE)&& strtoupper($DONATION_ENABLE)== 'YES'){
            return true;
        }
        return false;
    }
    public function isUfxFeatureAvailable(){
        global $obj, $ufx_data, $cacheKeysArr, $oCache;
        if(strtoupper(ENABEL_SERVICE_PROVIDER_MODULE)== 'NO'){
            return "No";
        }
        if(strtoupper(ONLYDELIVERALL)== 'YES'){
            return "No";
        }
        if(!empty(IS_CUBE_X_THEME)&& IS_CUBE_X_THEME == "Yes"){
            return "No";
        }
        if(strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX" || strtoupper(APP_TYPE)== "UBERX" || strtoupper(UFX_ENABLED)== "YES"){
            $ufx_data = $obj->MySQLSelect("SELECT COUNT(iVehicleCategoryId)AS Total FROM " . getVehicleCategoryTblName(). " WHERE 1=1 AND eCatType = 'ServiceProvider'");
            if(!empty($ufx_data[0]['Total'])&& $ufx_data[0]['Total'] > 0){
                return "Yes";
            }
            else {
                return "No";
            }
        }
        return "No";
    }
    public function isEnableServiceTypeWiseProviderDocument(){
        global $APP_TYPE, $ENABLE_SERVICE_TYPE_WISE_PROVIDER_DOC;
        if(strtoupper($ENABLE_SERVICE_TYPE_WISE_PROVIDER_DOC)!= "YES"){
            return "No";
        }
        if($APP_TYPE == 'Ride-Delivery-UberX' || $APP_TYPE == 'UberX' || ONLYDELIVERALL == 'No'){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public function isEnableDriverRewardModule(){
        global $ENABLE_DRIVER_REWARD_MODULE;
        return !empty($ENABLE_DRIVER_REWARD_MODULE)&& strtoupper($ENABLE_DRIVER_REWARD_MODULE)== "YES" ? true : false;
    }
    public function isEnableRiderRewardModule(){
        global $ENABLE_RIDER_REWARD_MODULE;
        return !empty($ENABLE_RIDER_REWARD_MODULE)&& strtoupper($ENABLE_RIDER_REWARD_MODULE)== "YES" ? true : false;
    }
    public function isEnableAppHomeScreenLayoutV2(){
        global $ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_22;
        return !empty($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_22)&& strtoupper($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_22)== "YES" ? true : false;
    }
    public function isSendRequestToDriverBeforFinishTripModule(){
        global $ENABLE_SEND_REQUEST_BEFORE_TRIP_END;
        return !empty($ENABLE_SEND_REQUEST_BEFORE_TRIP_END)&& strtoupper($ENABLE_SEND_REQUEST_BEFORE_TRIP_END)== "YES" ? true : false;
    }
    public function isEnableGoogleAds(){
        global $ENABLE_GOOGLE_ADS;
        return !empty($ENABLE_GOOGLE_ADS)&& strtoupper($ENABLE_GOOGLE_ADS)== "YES" ? true : false;
    }
    public function isEnableFacebookAds(){
        global $ENABLE_FACEBOOK_ADS;
        return !empty($ENABLE_FACEBOOK_ADS)&& strtoupper($ENABLE_FACEBOOK_ADS)== "YES" ? true : false;
    }
    public function isEnableBiddingServices($isFromConfig = "No"){
        global $ENABLE_BIDDING_SERVICES, $master_service_category_tbl;
        $serviceBidModuleAvailable =(!empty($ENABLE_BIDDING_SERVICES)&& strtoupper($ENABLE_BIDDING_SERVICES)== "YES")|| strtoupper(BIDDING_ENABLED)== "YES" ? true : false;
        if($serviceBidModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" &&(strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX" || strtoupper(APP_TYPE)== "UBERX")){
            return isMasterServiceCategoryAvailable("Bidding")? true : false;
        }
        return $serviceBidModuleAvailable;
    }
    public function isEnableVideoConsultingService($isFromConfig = "No"){
        global $ENABLE_VIDEO_CONSULTING_SERVICE;
        $videoConsultModuleAvailable =(!empty($ENABLE_VIDEO_CONSULTING_SERVICE)&& strtoupper($ENABLE_VIDEO_CONSULTING_SERVICE)== "YES")|| strtoupper(VC_ENABLED)== "YES" ? true : false;
        if($videoConsultModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" &&(strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX" || strtoupper(APP_TYPE)== "UBERX")){
            return isMasterServiceCategoryAvailable("VideoConsult")? true : false;
        }
        return $videoConsultModuleAvailable;
    }
    public function isEnableItemMultipleImageVideoUpload(){
        global $ENABLE_ITEM_MULTIPLE_IMAGE_VIDEO_UPLOAD;
        return !empty($ENABLE_ITEM_MULTIPLE_IMAGE_VIDEO_UPLOAD)&& strtoupper($ENABLE_ITEM_MULTIPLE_IMAGE_VIDEO_UPLOAD)== "YES" ? true : false;
    }
    public function isEnableAccountDeletion(){
        global $ENABLE_ACCOUNT_DELETION;
        return !empty($ENABLE_ACCOUNT_DELETION)&& strtoupper($ENABLE_ACCOUNT_DELETION)== "YES" ? true : false;
    }
    public function isEnableAppHomeScreenLayout(){
        return $this->isEnableAppHomeScreenLayoutV1()|| $this->isEnableAppHomeScreenLayoutV2()|| $this->isEnableAppHomeScreenLayoutV3()? true : false;
    }
    public function isEnableAdminPanelV2(){
        global $THEME_OBJ;
        if(strtoupper($THEME_OBJ->isCubeJekXv3ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isProThemeActive())== 'YES' || strtoupper($THEME_OBJ->isServiceXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isCubeXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isRideCXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isDeliveryKingXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isDeliverallXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isDeliveryXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isRideDeliveryXv2ThemeActive())== 'YES' || strtoupper($THEME_OBJ->isMedicalServicev2ThemeActive())== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isEnableMedicalServices($isFromConfig = "No"){
        global $ENABLE_MEDICAL_SERVICES;
        $medicalServiceModuleAvailable =(!empty($ENABLE_MEDICAL_SERVICES)&& strtoupper($ENABLE_MEDICAL_SERVICES)== "YES")|| strtoupper(MED_UFX_ENABLED)== "YES" ? true : false;
        if($medicalServiceModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("MedicalServices")? true : false;
        }
        return $medicalServiceModuleAvailable;
    }
    public function isEnableSkipRatingRide(){
        global $ENABLE_SKIP_RATING_RIDE;
        return !empty($ENABLE_SKIP_RATING_RIDE)&& strtoupper($ENABLE_SKIP_RATING_RIDE)== "YES" ? true : false;
    }
    public function isEnableRentItemService($isFromConfig = "No"){
        global $ENABLE_RENT_ITEM_SERVICES;
        $rentItemModuleAvailable =(!empty($ENABLE_RENT_ITEM_SERVICES)&& strtoupper($ENABLE_RENT_ITEM_SERVICES)== "YES")|| strtoupper(RENT_ITEM_ENABLED)== "YES" ? true : false;
        if($rentItemModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("RentItem")? true : false;
        }
        return $rentItemModuleAvailable;
    }
    public function isEnableRentEstateService($isFromConfig = "No"){
        global $ENABLE_RENT_ESTATE_SERVICES;
        $rentEstateModuleAvailable =(!empty($ENABLE_RENT_ESTATE_SERVICES)&& strtoupper($ENABLE_RENT_ESTATE_SERVICES)== "YES")|| strtoupper(RENT_ESTATE_ENABLED)== "YES" ? true : false;
        if($rentEstateModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("RentEstate")? true : false;
        }
        return $rentEstateModuleAvailable;
    }
    public function isEnableRentCarsService($isFromConfig = "No"){
        global $ENABLE_RENT_CARS_SERVICES;
        $rentCarsModuleAvailable =(!empty($ENABLE_RENT_CARS_SERVICES)&& strtoupper($ENABLE_RENT_CARS_SERVICES)== "YES")|| strtoupper(RENT_CARS_ENABLED)== "YES" ? true : false;
        if($rentCarsModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("RentCars")? true : false;
        }
        return $rentCarsModuleAvailable;
    }
    public function isEnableRating(){
        global $ENABLE_RATING;
        return !empty($ENABLE_RATING)&& strtoupper($ENABLE_RATING)== "YES" ? true : false;
    }
    public function isEnableTip(){
        global $ENABLE_TIP_MODULE;
        return !empty($ENABLE_TIP_MODULE)&& strtoupper($ENABLE_TIP_MODULE)== "YES" ? true : false;
    }
    public function isEnableBiddingWiseProviderDoc(){
        global $ENABLE_BIDDING_WISE_PROVIDER_DOC;
        return !empty($ENABLE_BIDDING_WISE_PROVIDER_DOC)&& strtoupper($ENABLE_BIDDING_WISE_PROVIDER_DOC)== "YES" ? true : false;
    }
    public function isEnableNearByService($isFromConfig = "No"){
        global $ENABLE_NEARBY_SERVICES;
        $nearbyModuleAvailable =(!empty($ENABLE_NEARBY_SERVICES)&& strtoupper($ENABLE_NEARBY_SERVICES)== "YES")|| strtoupper(NEARBY_ENABLED)== "YES" ? true : false;
        if($nearbyModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("NearBy")? true : false;
        }
        return $nearbyModuleAvailable;
    }
    public function isEnableTrackServiceFeature($isFromConfig = "No"){
        global $ENABLE_TRACK_SERVICE;
        $trackServiceModuleAvailable =(!empty($ENABLE_TRACK_SERVICE)&& strtoupper($ENABLE_TRACK_SERVICE)== "YES")|| strtoupper(TRACK_SERVICE_ENABLED)== "YES" ? true : false;
        if($trackServiceModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("TrackService")? true : false;
        }
        return $trackServiceModuleAvailable;
    }
    public function isEnableRideShareService($isFromConfig = "No"){
        global $ENABLE_RIDE_SHARE_SERVICE;
        $rideShareModuleAvailable =(!empty($ENABLE_RIDE_SHARE_SERVICE)&& strtoupper($ENABLE_RIDE_SHARE_SERVICE)== "YES")|| strtoupper(RIDE_SHARE_ENABLED)== "YES" ? true : false;
        if($rideShareModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("RideShare")? true : false;
        }
        return $rideShareModuleAvailable;
    }
    public function isEnableGiftCardFeature(){
        global $ENABLE_GIFT_CARD_FEATURE;
        return !empty($ENABLE_GIFT_CARD_FEATURE)&& strtoupper($ENABLE_GIFT_CARD_FEATURE)== "YES" ? true : false;
    }
    public function isEnableAppHomeScreenLayoutV3(){
        global $ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_23;
        return !empty($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_23)&& strtoupper($ENABLE_NEW_HOME_SCREEN_LAYOUT_APP_23)== "YES" ? true : false;
    }
    public function isEnableAdminPanelV3Pro(){
        global $APP_TYPE,$THEME_OBJ;
        if(strtoupper($THEME_OBJ->isProThemeActive())== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isEnableTrackAnyServiceFeature($isFromConfig = "No"){
        global $ENABLE_TRACK_ANY_SERVICE;
        $trackAnyServiceModuleAvailable =(!empty($ENABLE_TRACK_ANY_SERVICE)&& strtoupper($ENABLE_TRACK_ANY_SERVICE)== "YES")|| strtoupper(TRACK_ANY_SERVICE_ENABLED)== "YES" ? true : false;
        if($trackAnyServiceModuleAvailable && $this->isEnableAppHomeScreenLayout()&& strtoupper($isFromConfig)== "NO" && strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("TrackAnyService")? true : false;
        }
        return $trackAnyServiceModuleAvailable;
    }
    public function isEnableGenieFeature($isFromConfig = "No"){
        $GenieFeatureAvailable =(strtoupper(GENIE_ENABLED)== "YES")? true : false;
        if($GenieFeatureAvailable && strtoupper($isFromConfig)== "NO" && $this->isEnableAppHomeScreenLayout()&& strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isVehicleCategoryAvailable("Genie")? true : false;
        }
        return $GenieFeatureAvailable;
    }
    public function isEnableRunnerFeature($isFromConfig = "No"){
        $RunnerFeatureAvailable =(strtoupper(RUNNER_ENABLED)== "YES")? true : false;
        if($RunnerFeatureAvailable && strtoupper($isFromConfig)== "NO" && $this->isEnableAppHomeScreenLayout()&& strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isVehicleCategoryAvailable("Runner")? true : false;
        }
        return $RunnerFeatureAvailable;
    }
    public function isEnableParkingFeature($isFromConfig = "No"){
        $ParkingFeatureAvailable =(strtoupper(PARKING_ENABLED)== "YES")? true : false;
        if($ParkingFeatureAvailable && strtoupper($isFromConfig)== "NO" && $this->isEnableAppHomeScreenLayout()&& strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX"){
            return isMasterServiceCategoryAvailable("Parking")? true : false;
        }
        return $ParkingFeatureAvailable;
    }
    public function isEnableTaxiBidFeature($isFromConfig = "No"){
        $TaxiBiFeatureAvailable = strtoupper(TAXI_BID_ENABLED)== "YES";
        if($TaxiBiFeatureAvailable && strtoupper($isFromConfig)== "NO" && $this->isEnableAppHomeScreenLayout()&&(strtoupper(APP_TYPE)== "RIDE-DELIVERY-UBERX" || strtoupper(APP_TYPE)== "RIDE" || strtoupper(APP_TYPE)== "RIDE-DELIVERY")){
            return isMasterServiceCategoryAvailable("TaxiBid")? true : false;
        }
        return $TaxiBiFeatureAvailable;
    }
    public function isOnlyEnableRideSharingPro(){
        $onlyEnableRideSharingPro =(strtoupper(ONLY_ENABLE_RIDE_SHARING_PRO)== "YES")? true : false;
        return $onlyEnableRideSharingPro;
    }
    public function isOnlyEnableBuySellRentPro(){
        $onlyEnableBuySellRentPro =(strtoupper(ONLY_ENABLE_BUY_SELL_RENT_PRO)== "YES")? true : false;
        return $onlyEnableBuySellRentPro;
    }
    public function isOnlyEnableFETApp(){
        $onlyEnableFETApp =(strtoupper(ONLY_ENABLE_FET_APP)== "YES")? true : false;
        return $onlyEnableFETApp;
    }
    public function isEnablePremiumDriverPreference(){
        global $ENABLE_PREMIUM_DRIVER_PREFERENCE;
        return !empty($ENABLE_PREMIUM_DRIVER_PREFERENCE)&& strtoupper($ENABLE_PREMIUM_DRIVER_PREFERENCE)== "YES" ? true : false;
    }
    public function isEnableAutoAssignOccupiedDrivers(){
        global $ENABLE_AUTO_ASSIGN_OCCUPIED_DRIVERS;
        return !empty($ENABLE_AUTO_ASSIGN_OCCUPIED_DRIVERS)&& strtoupper($ENABLE_AUTO_ASSIGN_OCCUPIED_DRIVERS)== "YES" ? true : false;
    }
    public function isEnableSafetyTools(){
        global $ENABLE_SAFETY_TOOLS;
        return !empty($ENABLE_SAFETY_TOOLS)&& strtoupper($ENABLE_SAFETY_TOOLS)== "YES" ? true : false;
    }
    public function isEnableScheduledRideFlow(){
        global $ENABLE_SCHEDULED_RIDE_FLOW;
        return !empty($ENABLE_SCHEDULED_RIDE_FLOW)&& strtoupper($ENABLE_SCHEDULED_RIDE_FLOW)== "YES" ? true : false;
    }
    public function isInterCityFeatureAvailable(){
        $isInterCityFeatureAvailable =(strtoupper(INTERCITY_ENABLED)== "YES")? true : false;
        return $isInterCityFeatureAvailable;
    }
    public function isEnableAdminPanelV4(){
        if(strtoupper(ENABLE_ADMIN_PANEL_V4_THEME)== 'YES'){
            return true;
        }
        else {
            return false;
        }
    }
    public function isEnableAppHomeScreenLayoutV4(){
        global $ENABLE_APP_HOME_SCREEN_24;
        return !empty($ENABLE_APP_HOME_SCREEN_24)&& strtoupper($ENABLE_APP_HOME_SCREEN_24)== "YES" ? true : false;
    }
    public function isEnableCarSizeServiceTypeAmount(){
        global $parent_ufx_catid,$ENABLE_CAR_SIZE_WISE_SERVICE_TYPE_AMOUNT;
        if($parent_ufx_catid == 1 && strtoupper($ENABLE_CAR_SIZE_WISE_SERVICE_TYPE_AMOUNT)== "YES"){
            return true;
        }
        else {
            return false;
        }
    }
    public function isCubeXGcApp(){
        if(defined('IS_CUBEXGC_APP')&& strtoupper(constVal("IS_CUBEXGC_APP"))== "YES"){
            return true;
        }
        else {
            return false;
        }
    }
}
class RefactorApp {
    function __construct(){
    }
    public static function addTimeslotToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['STORE_INDIVIDUALDAY_AVAILABILITY_MODULE'])&&($_REQUEST['STORE_INDIVIDUALDAY_AVAILABILITY_MODULE'] == "Yes" || $_REQUEST['STORE_INDIVIDUALDAY_AVAILABILITY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Timeslot Feature'] = $_REQUEST['STORE_INDIVIDUALDAY_AVAILABILITY_MODULE_FILES'];
        }
    }
    public static function addSearchByItemNameToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['STORE_SEARCH_BY_ITEM_NAME_MODULE'])&&($_REQUEST['STORE_SEARCH_BY_ITEM_NAME_MODULE'] == "Yes" || $_REQUEST['STORE_SEARCH_BY_ITEM_NAME_MODULE'] == "YES")){
            return $deleteAppFilesArr['Item Search For Store Order Feature'] = $_REQUEST['STORE_SEARCH_BY_ITEM_NAME_MODULE_FILES'];
        }
    }
    public static function addTollFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['MANUAL_TOLL_FEATURE_MODULE'])&&($_REQUEST['MANUAL_TOLL_FEATURE_MODULE'] == "Yes" || $_REQUEST['MANUAL_TOLL_FEATURE_MODULE'] == "YES")){
            return $deleteAppFilesArr['Manual Toll Feature'] = $_REQUEST['MANUAL_TOLL_FEATURE_MODULE_FILES'];
        }
    }
    public static function addSafetyToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['SAFETY_MODULE'])&&($_REQUEST['SAFETY_MODULE'] == "Yes" || $_REQUEST['SAFETY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Safety Feature'] = $_REQUEST['SAFETY_MODULE_FILES'];
        }
    }
    public static function addSafetyRatingToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['SAFETY_RATING_MODULE'])&&($_REQUEST['SAFETY_RATING_MODULE'] == "Yes" || $_REQUEST['SAFETY_RATING_MODULE'] == "YES")){
            return $deleteAppFilesArr['Safety Rating Feature'] = $_REQUEST['SAFETY_RATING_MODULE_FILES'];
        }
    }
    public static function addSafetyCheckListToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['SAFETY_CHECK_LIST_MODULE'])&&($_REQUEST['SAFETY_CHECK_LIST_MODULE'] == "Yes" || $_REQUEST['SAFETY_CHECK_LIST_MODULE'] == "YES")){
            return $deleteAppFilesArr['Safety Check List Feature'] = $_REQUEST['SAFETY_CHECK_LIST_MODULE_FILES'];
        }
    }
    public static function addSafetyFacemaskVerificationToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['SAFETY_FACEMASK_VERIFICATION_MODULE'])&&($_REQUEST['SAFETY_FACEMASK_VERIFICATION_MODULE'] == "Yes" || $_REQUEST['SAFETY_FACEMASK_VERIFICATION_MODULE'] == "YES")){
            return $deleteAppFilesArr['Safety Facemask Verification Feature'] = $_REQUEST['SAFETY_FACEMASK_VERIFICATION_MODULE_FILES'];
        }
    }
    public static function addEighteenPlusToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['EIGHTEEN_PLUS_FEATURE_MODULE'])&&($_REQUEST['EIGHTEEN_PLUS_FEATURE_MODULE'] == "Yes" || $_REQUEST['EIGHTEEN_PLUS_FEATURE_MODULE'] == "YES")){
            return $deleteAppFilesArr['Eighteen Plus Feature'] = $_REQUEST['EIGHTEEN_PLUS_FEATURE_MODULE_FILES'];
        }
    }
    public static function addGenieFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['GENIE_FEATURE_MODULE'])&&($_REQUEST['GENIE_FEATURE_MODULE'] == "Yes" || $_REQUEST['GENIE_FEATURE_MODULE'] == "YES")){
            return $deleteAppFilesArr['Genie Feature'] = $_REQUEST['GENIE_FEATURE_MODULE_FILES'];
        }
    }
    public static function addContactlessFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['CONTACTLESS_DELIVERY_MODULE'])&&($_REQUEST['CONTACTLESS_DELIVERY_MODULE'] == "Yes" || $_REQUEST['CONTACTLESS_DELIVERY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Contactless Feature'] = $_REQUEST['CONTACTLESS_DELIVERY_MODULE_FILES'];
        }
    }
    public static function addMultiSingleStoreToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['MULTI_SINGLE_STORE_MODULE'])&&($_REQUEST['MULTI_SINGLE_STORE_MODULE'] == "Yes" || $_REQUEST['MULTI_SINGLE_STORE_MODULE'] == "YES")){
            return $deleteAppFilesArr['Multi Single Store Feature'] = $_REQUEST['MULTI_SINGLE_STORE_MODULE_FILES'];
        }
    }
    public static function addCategorywiseStoeToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['CATEGORY_WISE_STORE_MODULE'])&&($_REQUEST['CATEGORY_WISE_STORE_MODULE'] == "Yes" || $_REQUEST['CATEGORY_WISE_STORE_MODULE'] == "YES")){
            return $deleteAppFilesArr['Category Wise Store Feature'] = $_REQUEST['CATEGORY_WISE_STORE_MODULE_FILES'];
        }
    }
    public static function addWayBillToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['WAYBILL_MODULE'])&&($_REQUEST['WAYBILL_MODULE'] == "Yes" || $_REQUEST['WAYBILL_MODULE'] == "YES")){
            return $deleteAppFilesArr['WayBill Feature'] = $_REQUEST['WAYBILL_MODULE_FILES'];
        }
    }
    public static function addDeliverAllToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['DELIVER_ALL'])&&($_REQUEST['DELIVER_ALL'] == "Yes" || $_REQUEST['DELIVER_ALL'] == "YES")){
            return $deleteAppFilesArr['DeliverAll Feature(Food/Grocery/DeliverAll etc.)'] = $_REQUEST['DELIVER_ALL_FILES'];
        }
    }
    public static function addMultiDeliveryToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['MULTI_DELIVERY'])&&($_REQUEST['MULTI_DELIVERY'] == "Yes" || $_REQUEST['MULTI_DELIVERY'] == "YES")){
            return $deleteAppFilesArr['Multi Delivery Feature'] = $_REQUEST['MULTI_DELIVERY_FILES'];
        }
    }
    public static function addSingleDeliveryToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['DELIVERY_MODULE'])&&($_REQUEST['DELIVERY_MODULE'] == "Yes" || $_REQUEST['DELIVERY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Single Delivery Feature'] = $_REQUEST['DELIVERY_MODULE_FILES'];
        }
    }
    public static function addUberXServicesToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['UBERX_SERVICE'])&&($_REQUEST['UBERX_SERVICE'] == "Yes" || $_REQUEST['UBERX_SERVICE'] == "YES")){
            return $deleteAppFilesArr['UberX(Other Services like - Carwash etc)Feature'] = $_REQUEST['UBERX_FILES'];
        }
    }
    public static function addOnGoingJobsToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['ON_GOING_JOB_SECTION'])&&($_REQUEST['ON_GOING_JOB_SECTION'] == "Yes" || $_REQUEST['ON_GOING_JOB_SECTION'] == "YES")){
            return $deleteAppFilesArr['OnGoing Job Section(UberX/Multi)'] = $_REQUEST['ON_GOING_JOB_SECTION_FILES'];
        }
    }
    public static function addCommonDeliveryTypesToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['COMMON_DELIVERY_TYPE_SECTION'])&&($_REQUEST['COMMON_DELIVERY_TYPE_SECTION'] == "Yes" || $_REQUEST['COMMON_DELIVERY_TYPE_SECTION'] == "YES")){
            return $deleteAppFilesArr['Common Delivery Type Section(For Ride-Delivery/Delivery/MultiDelivery/Cubejek)'] = $_REQUEST['COMMON_DELIVERY_TYPE_SECTION_FILES'];
        }
    }
    public static function addRentalFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['RENTAL_FEATURE'])&&($_REQUEST['RENTAL_FEATURE'] == "Yes" || $_REQUEST['RENTAL_FEATURE'] == "YES")){
            return $deleteAppFilesArr['Rental Feature'] = $_REQUEST['RENTAL_SERVICE_FILES'];
        }
    }
    public static function addRideSectionToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['RIDE_SECTION'])&&($_REQUEST['RIDE_SECTION'] == "Yes" || $_REQUEST['RIDE_SECTION'] == "YES")){
            return $deleteAppFilesArr['Ride Section'] = $_REQUEST['RIDE_SECTION_FILES'];
        }
    }
    public static function addPoolFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['POOL_MODULE'])&&($_REQUEST['POOL_MODULE'] == "Yes" || $_REQUEST['POOL_MODULE'] == "YES")){
            return $deleteAppFilesArr['Pool Feature'] = $_REQUEST['POOL_MODULE_FILES'];
        }
    }
    public static function addFlyFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['FLY_MODULE'])&&($_REQUEST['FLY_MODULE'] == "Yes" || $_REQUEST['FLY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Fly Feature'] = $_REQUEST['FLY_MODULE_FILES'];
        }
    }
    public static function addBusinessProfileFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['BUSINESS_PROFILE_FEATURE'])&&($_REQUEST['BUSINESS_PROFILE_FEATURE'] == "Yes" || $_REQUEST['BUSINESS_PROFILE_FEATURE'] == "YES")){
            return $deleteAppFilesArr['Business Profile Feature'] = $_REQUEST['BUSINESS_PROFILE_FILES'];
        }
    }
    public static function addRDUToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['RDU_SECTION'])&&($_REQUEST['RDU_SECTION'] == "Yes" || $_REQUEST['RDU_SECTION'] == "YES")){
            return $deleteAppFilesArr['RDU Section Files'] = $_REQUEST['RDU_SECTION_FILES'];
        }
    }
    public static function addVOIPToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['VOIP_SERVICE'])&&($_REQUEST['VOIP_SERVICE'] == "Yes" || $_REQUEST['VOIP_SERVICE'] == "YES")){
            return $deleteAppFilesArr['VOIP Feature'] = $_REQUEST['VOIP_SERVICE_FILES'];
        }
    }
    public static function addFavDriverToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['FAV_DRIVER_SECTION'])&&($_REQUEST['FAV_DRIVER_SECTION'] == "Yes" || $_REQUEST['FAV_DRIVER_SECTION'] == "YES")){
            return $deleteAppFilesArr['Favourite Driver Feature'] = $_REQUEST['FAV_DRIVER_SECTION_FILES'];
        }
    }
    public static function addBookForElseToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['BOOK_FOR_ELSE_SECTION'])&&($_REQUEST['BOOK_FOR_ELSE_SECTION'] == "Yes" || $_REQUEST['BOOK_FOR_ELSE_SECTION'] == "YES")){
            return $deleteAppFilesArr['Book for someone else Feature'] = $_REQUEST['BOOK_FOR_ELSE_SECTION_FILES'];
        }
    }
    public static function addEndOfDayTripToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['END_OF_DAY_TRIP_SECTION'])&&($_REQUEST['END_OF_DAY_TRIP_SECTION'] == "Yes" || $_REQUEST['END_OF_DAY_TRIP_SECTION'] == "YES")){
            return $deleteAppFilesArr['EndOfDayTrip Feature'] = $_REQUEST['END_OF_DAY_TRIP_SECTION_FILES'];
        }
    }
    public static function addMultiStopOverPointsToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['STOP_OVER_POINT_SECTION'])&&($_REQUEST['STOP_OVER_POINT_SECTION'] == "Yes" || $_REQUEST['STOP_OVER_POINT_SECTION'] == "YES")){
            return $deleteAppFilesArr['Multi StopOverPoint Feature'] = $_REQUEST['STOP_OVER_POINT_SECTION_FILES'];
        }
    }
    public static function addDriverSubscriptionToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['DRIVER_SUBSCRIPTION_SECTION'])&&($_REQUEST['DRIVER_SUBSCRIPTION_SECTION'] == "Yes" || $_REQUEST['DRIVER_SUBSCRIPTION_SECTION'] == "YES")){
            return $deleteAppFilesArr['Driver Subscription Feature'] = $_REQUEST['DRIVER_SUBSCRIPTION_SECTION_FILES'];
        }
    }
    public static function addDonationToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['DONATION_SECTION'])&&($_REQUEST['DONATION_SECTION'] == "Yes" || $_REQUEST['DONATION_SECTION'] == "YES")){
            return $deleteAppFilesArr['Donation Feature'] = $_REQUEST['DONATION_SECTION_FILES'];
        }
    }
    public static function addGoJekGoPayToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['GO_PAY_SECTION'])&&($_REQUEST['GO_PAY_SECTION'] == "Yes" || $_REQUEST['GO_PAY_SECTION'] == "YES")){
            return $deleteAppFilesArr['Wallet to Wallet money Feature'] = $_REQUEST['GO_PAY_SECTION_FILES'];
        }
    }
    public static function addThermalPrintToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['THERMAL_PRINT_MODULE'])&&($_REQUEST['THERMAL_PRINT_MODULE'] == "Yes" || $_REQUEST['THERMAL_PRINT_MODULE'] == "YES")){
            return $deleteAppFilesArr['Thermal Print Feature'] = $_REQUEST['THERMAL_PRINT_MODULE_FILES'];
        }
    }
    public static function addAppleWatchAppToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['APPLE_WATCH_MODULE'])&&($_REQUEST['APPLE_WATCH_MODULE'] == "Yes" || $_REQUEST['APPLE_WATCH_MODULE'] == "YES")){
            $_REQUEST['APPLE_WATCH_FILES'] = "WatchApp,WatchApp Extension, " . $_REQUEST['APPLE_WATCH_FILES'];
            return $deleteAppFilesArr['Apple Watch Feature'] = $_REQUEST['APPLE_WATCH_FILES'];
        }
    }
    public static function addBidFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['BID_SERVICE'])&&($_REQUEST['BID_SERVICE'] == "Yes" || $_REQUEST['BID_SERVICE'] == "YES")){
            return $deleteAppFilesArr['Service Bidding Feature'] = $_REQUEST['BID_SERVICE_FILES'];
        }
    }
    public static function addLiveActivityFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['LIVE_ACTIVITY_MODULE'])&&($_REQUEST['LIVE_ACTIVITY_MODULE'] == "Yes" || $_REQUEST['LIVE_ACTIVITY_MODULE'] == "YES")){
            $_REQUEST['LIVE_ACTIVITY_FILES'] = "LiveActivityData, " . $_REQUEST['LIVE_ACTIVITY_FILES'];
            return $deleteAppFilesArr['Live Activity Feature'] = $_REQUEST['LIVE_ACTIVITY_FILES'];
        }
    }
    public static function addBuySellRentFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['RENT_ITEM_SERVICE'])&&($_REQUEST['RENT_ITEM_SERVICE'] == "Yes" || $_REQUEST['RENT_ITEM_SERVICE'] == "YES")){
            return $deleteAppFilesArr['Buy,Sell,Rent Feature'] = $_REQUEST['RENT_ITEM_SERVICE_FILES'];
        }
    }
    public static function addTrackingFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['TRACKING_MODULE'])&&($_REQUEST['TRACKING_MODULE'] == "Yes" || $_REQUEST['TRACKING_MODULE'] == "YES")){
            return $deleteAppFilesArr['Tracking Feature'] = $_REQUEST['TRACKING_MODULE_FILES'];
        }
    }
    public static function addRideShareFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['RIDE_SHARE_PRO_MODULE'])&&($_REQUEST['RIDE_SHARE_PRO_MODULE'] == "Yes" || $_REQUEST['RIDE_SHARE_PRO_MODULE'] == "YES")){
            return $deleteAppFilesArr['Ride Sharing Feature'] = $_REQUEST['RIDE_SHARE_PRO_MODULE_FILES'];
        }
    }
    public static function addNearByFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['NEARBY_MODULE'])&&($_REQUEST['NEARBY_MODULE'] == "Yes" || $_REQUEST['NEARBY_MODULE'] == "YES")){
            return $deleteAppFilesArr['Nearby Feature'] = $_REQUEST['NEARBY_MODULE_FILES'];
        }
    }
    public static function addGiftCardFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['GIFTCARD_MODULE'])&&($_REQUEST['GIFTCARD_MODULE'] == "Yes" || $_REQUEST['GIFTCARD_MODULE'] == "YES")){
            return $deleteAppFilesArr['Gift Card Feature'] = $_REQUEST['GIFTCARD_MODULE_FILES'];
        }
    }
    public static function addParkingFeatureToDeliteList(){
        global $_REQUEST, $deleteAppFilesArr;
        if(!empty($_REQUEST['PARKING_MODULE'])&&($_REQUEST['PARKING_MODULE'] == "Yes" || $_REQUEST['PARKING_MODULE'] == "YES")){
            return $deleteAppFilesArr['Parking Feature'] = $_REQUEST['PARKING_MODULE_FILES'];
        }
    }
}
class Referral {
    public function __construct(){
    }
    public function ValidateReferralCode($id){
        global $obj;
        $str = "";
        $sql = "SELECT iUserId,vRefCode FROM register_user WHERE vRefCode = '" . $id . "' AND(eStatus = 'Active' || eStatus = 'Inactive')";
        $db_user = $obj->MySQLSelect($sql);
        if(scount($db_user)> 0){
            $eRefType = 'Rider';
            $str .= $db_user[0]['iUserId'] . "|" . $eRefType;
        }
        else {
            $sql = "SELECT iDriverId,vRefCode FROM register_driver WHERE vRefCode = '" . $id . "'AND(eStatus = 'Active' || eStatus = 'Inactive')";
            $db_driver = $obj->MySQLSelect($sql);
            if(scount($db_driver)> 0){
                $eRefType = 'Driver';
                $str .= $db_driver[0]['iDriverId'] . "|" . $eRefType;
            }
            else {
                $str .= 0;
            }
        }
        return $str;
    }
    public function GenerateReferralCode($ereftype){
        global $obj;
        $str = "";
        $milliseconds = time();
        $shareCode = $this->randomAlphaNum(5);
        $timeDigitsStr = strval($milliseconds);
        $shareCode = $shareCode . substr($timeDigitsStr, strlen($timeDigitsStr)- 4, strlen($timeDigitsStr)- 1);
        if($ereftype == "Rider"){
            $newstring = $shareCode;
            $str .= 'pr' . $newstring;
        }
        else if($ereftype == "Driver"){
            $newstring = $shareCode;
            $str .= 'dr' . $newstring;
        }
        $sql_chk_user = "SELECT ru.vRefCode as pRefCode FROM register_user as ru WHERE ru.vRefCode = '" . $str . "'";
        $sql_chk_driver = "SELECT rd.vRefCode as dRefCode FROM register_driver as rd WHERE rd.vRefCode = '" . $str . "'";
        $result_chk_user = $obj->MySQLSelect($sql_chk_user);
        $result_chk_driver = $obj->MySQLSelect($sql_chk_driver);
        if((scount($result_chk_user)> 0 && !empty($result_chk_user))||(scount($result_chk_driver)> 0 && !empty($result_chk_driver))){
            $str = $this->GenerateReferralCode($ereftype);
        }
        return $str;
    }
    public function randomAlphaNum($length){
        $rangeMin = pow(36, $length - 1);
        $rangeMax = pow(36, $length)- 1;
        $base10Rand = mt_rand($rangeMin, $rangeMax);
        $newRand = base_convert($base10Rand, 10, 36);
        return $newRand;
    }
    public function CreditReferralAmountSingle($iTripId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT,$tripDetailsArr,$userDetailsArr, $WALLET_OBJ, $COMM_MEDIA_OBJ, $CONFIG_OBJ;
        if(isset($tripDetailsArr['trips_'.$iTripId])){
            $db_result = $tripDetailsArr['trips_'.$iTripId];
        }
        else {
            $db_result = $obj->MySQLSelect("SELECT * from trips where iTripId=" . $iTripId);
            $tripDetailsArr['trips_'.$iTripId] = $db_result;
        }
        $getPaymentStatus = $obj->MySQLSelect("SELECT iTripId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iTripId='" . $iTripId . "'");
        $walletArr = array();
        for($h = 0;
        $h < scount($getPaymentStatus);
        $h++){
            $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iTripId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
        }
        $count_rider = scount($db_result);
        if($count_rider > 0){
            if(isset($userDetailsArr['register_user_'.$db_result[0]['iUserId']])){
                $db_rider_user = $userDetailsArr['register_user_'.$db_result[0]['iUserId']];
                if(scount($db_rider_user)> 0){
                    $db_rider_user[0]['currency'] = $db_rider_user[0]['vCurrencyPassenger'];
                    $db_rider_user[0]['tripusername'] = $db_rider_user[0]['vName']." ".$db_rider_user[0]['vLastName'];
                }
            }
            else {
                $db_rider_user = $obj->MySQLSelect("SELECT vCurrencyPassenger AS currency,iUserId,iRefUserId ,eRefType, CONCAT(vName,' ',vLastName)as tripusername from register_user where iUserId=" . $db_result[0]['iUserId']);
            }
            $count_rider_user = scount($db_rider_user);
            if($count_rider_user > 0){
                $iRefUserId = $db_rider_user[0]['iRefUserId'];
                $iUserId = $db_rider_user[0]['iUserId'];
                $eRefType = $db_rider_user[0]['eRefType'];
                if($iRefUserId != 0){
                    $sql1 = "SELECT iUserId,vRideNo from trips where iUserId='" . $iUserId . "' AND iActive = 'Finished'";
                    $db_trips_user = $obj->MySQLSelect($sql1);
                    $count_rider = scount($db_trips_user);
                    $bsql1 = "SELECT iUserId,vBiddingPostNo,iBiddingPostId from bidding_post where iUserId = '" . $iUserId . "' AND eStatus = 'Completed'";
                    $db_bidding_task_user = $obj->MySQLSelect($bsql1);
                    $count_rider_bidding = scount($db_bidding_task_user);
                    if($count_rider == 1 && $count_rider_bidding == 0){
                        $eFor = "Referrer";
                        $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                        $dDate = Date('Y-m-d H:i:s');
                        $ePaymentStatus = "Unsettelled";
                        if(!isset($walletArr['Credit'][$eRefType][$iTripId][$eFor])){
                            $WALLET_OBJ->PerformWalletTransaction($iRefUserId, $eRefType, $REFERRAL_AMOUNT, 'Credit', $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                        }
                        if($eRefType=="Driver"){
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_driver where iDriverId='" . $iRefUserId . "'";
                        }
                        else {
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_user where iUserId='" . $iRefUserId . "'";
                        }
                        $db_user_refer = $obj->MySQLSelect($sql12);
                        $vEmailrider = $db_user_refer[0]['vEmail'];
                    }
                }
            }
            if(isset($userDetailsArr['register_driver_'.$db_result[0]['iDriverId']])){
                $db_driver_user = $userDetailsArr['register_driver_'.$db_result[0]['iDriverId']];
                if(scount($db_driver_user)> 0){
                    $db_driver_user[0]['currency'] = $db_driver_user[0]['vCurrencyDriver'];
                    $db_driver_user[0]['tripusername'] = $db_driver_user[0]['vName']." ".$db_driver_user[0]['vLastName'];
                }
            }
            else {
                $db_driver_user = $obj->MySQLSelect("SELECT iRefUserId,iDriverId,eRefType, CONCAT(vName,' ',vLastName)as tripusername,vCurrencyDriver As currency from register_driver where iDriverId=" . $db_result[0]['iDriverId']);
            }
            $count_driver_user = scount($db_driver_user);
            if($count_driver_user > 0){
                $iRefUserId = $db_driver_user[0]['iRefUserId'];
                $iDriverId = $db_driver_user[0]['iDriverId'];
                $eRefType = $db_driver_user[0]['eRefType'];
                if($iRefUserId != 0){
                    $sql1 = "SELECT iDriverId,vRideNo from trips where iDriverId='" . $iDriverId . "' AND iActive = 'Finished'";
                    $db_trips_driver = $obj->MySQLSelect($sql1);
                    $count_driver = scount($db_trips_driver);
                    $bsql1 = "SELECT iDriverId,vBiddingPostNo,iBiddingPostId from bidding_post where iDriverId='" . $iDriverId . "' AND eStatus = 'Completed'";
                    $db_bidding_task_driver = $obj->MySQLSelect($bsql1);
                    $count_driver_bidding = scount($db_bidding_task_driver);
                    if($count_driver == 1 && $count_driver_bidding == 0){
                        $eFor_Driver = "Referrer";
                        $tDescription_Driver = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                        $dDate_Driver = Date('Y-m-d H:i:s');
                        $ePaymentStatus_Driver = "Unsettelled";
                        if(!isset($walletArr['Credit'][$eRefType][$iTripId][$eFor_Driver])){
                            $WALLET_OBJ->PerformWalletTransaction($iRefUserId, $eRefType, $REFERRAL_AMOUNT, 'Credit', $iTripId, $eFor_Driver, $tDescription_Driver, $ePaymentStatus_Driver, $dDate_Driver);
                        }
                        if($eRefType=="Driver"){
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_driver where iDriverId='" . $iRefUserId . "'";
                        }
                        else {
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_user where iUserId='" . $iRefUserId . "'";
                        }
                        $db_driver_refer = $obj->MySQLSelect($sql12);
                        $vEmaildriver = $db_driver_refer[0]['vEmail'];
                    }
                }
            }
        }
        $vEmail = '';
        $currency = "";
        if(!empty($vEmaildriver)){
            $vEmail = $vEmaildriver;
            $userName = $db_driver_refer[0]['username'];
            $tripusername = $db_driver_user[0]['tripusername'];
            $currency = $db_driver_user[0]['currency'];
        }
        else if(!empty($vEmailrider)){
            $vEmail = $vEmailrider;
            $userName = $db_user_refer[0]['username'];
            $tripusername = $db_rider_user[0]['tripusername'];
            $currency = $db_rider_user[0]['currency'];
        }
        if(!empty($vEmail)){
            $REFERRAL_AMOUNT = $WALLET_OBJ->MemberCurrencyWalletBalance(0, $REFERRAL_AMOUNT, $currency);
            $maildatadeliverd['vEmail'] = $vEmail;
            $maildatadeliverd['UserName'] = $userName;
            $maildatadeliverd['EMAIL_NAME'] = $userName;
            $maildatadeliverd['TripUserName'] = $tripusername;
            if(empty($COMPANY_NAME)){
                $COMPANY_NAME = $CONFIG_OBJ->getConfigurations("configurations", "COMPANY_NAME");
                $COMPANY_NAME = $COMPANY_NAME[0]['vValue'];
            }
            $maildatadeliverd['CompanyName'] = $COMPANY_NAME;
            $maildatadeliverd['amount'] = $REFERRAL_AMOUNT;
            $mailResponse = $COMM_MEDIA_OBJ->SendMailToMember("REFERRAL_AMOUNT_CREDIT_TO_USER", $maildatadeliverd);
        }
        return $count_rider;
    }
    public function CreditReferralAmount($iTripId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT_EARN_STRATEGY, $REFERRAL_SCHEME_ENABLE, $MODULES_OBJ, $REFERRAL_LEVEL,$WALLET_OBJ;
        if(!$MODULES_OBJ->isEnableMultiLevelReferralSystem()){
            if(strtoupper($REFERRAL_SCHEME_ENABLE)== "YES"){
                $this->CreditReferralAmountSingle($iTripId);
            }
        }
        else {
            $sql = "SELECT iUserId,iDriverId,iFare,eSystem,iOrderId,fWalletDebit from trips where iTripId=" . $iTripId;
            $db_result = $obj->MySQLSelect($sql);
            $count_rider = scount($db_result);
            $getPaymentStatus = $obj->MySQLSelect("SELECT iTripId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iTripId='" . $iTripId . "'");
            $walletArr = array();
            for($h = 0;
            $h < scount($getPaymentStatus);
            $h++){
                $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iTripId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
            }
            if($count_rider > 0){
                $iFare = $db_result[0]['iFare'] + $db_result[0]['fWalletDebit'];
                if($db_result[0]['eSystem'] == "DeliverAll"){
                    $db_result_order = $obj->MySQLSelect("SELECT fNetTotal,fWalletDebit FROM orders WHERE iOrderId = " . $db_result[0]['iOrderId']);
                    $iFare = $db_result_order[0]['fNetTotal'] + $db_result_order[0]['fWalletDebit'];
                }
                $refSql = "SELECT * FROM multi_level_referral_master WHERE eStatus = 'Active' ORDER BY iLevel LIMIT $REFERRAL_LEVEL";
                $refData = $obj->MySQLSelect($refSql);
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $db_result[0]['iUserId']." AND eUserType = 'Rider'";
                $db_rider_user = $obj->MySQLSelect($sql);
                $count_rider_user = scount($db_rider_user);
                if($count_rider_user > 0){
                    if($db_rider_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_rider_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $sql1 = "SELECT iUserId,vRideNo from trips where iUserId='" . $db_rider_user[0]['iMemberId'] . "' AND iActive = 'Finished'";
                        $db_trips_user = $obj->MySQLSelect($sql1);
                        $count_rider = scount($db_trips_user);
                        $bsql1 = "SELECT iUserId,vBiddingPostNo,iBiddingPostId from bidding_post where iUserId='" . $db_rider_user[0]['iMemberId'] . "' AND eStatus = 'Completed'";
                        $db_bidding_task_user = $obj->MySQLSelect($bsql1);
                        $count_rider_bidding = scount($db_bidding_task_user);
                        if($count_rider == 1 && $count_rider_bidding == 0){
                            $refRiderCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refRiderCount])){
                                    $refMemberId = $tReferrerInfo[$refRiderCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refRiderCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor = "Referrer";
                                    $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate = Date('Y-m-d H:i:s');
                                    $ePaymentStatus = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iTripId][$eFor])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                                    }
                                    if(isset($wallet_id)){
                                        $where = ' iUserWalletId = '.$wallet_id;
                                        $wallet_update_data['fromUserId'] = $db_rider_user[0]['iMemberId'];
                                        $wallet_update_data['fromUserType'] = $db_rider_user[0]['eUserType'];
                                        $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                    }
                                }
                                $refRiderCount++;
                            }
                        }
                    }
                }
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $db_result[0]['iDriverId']." AND eUserType = 'Driver'";
                $db_driver_user = $obj->MySQLSelect($sql);
                $count_driver_user = scount($db_driver_user);
                if($count_driver_user > 0){
                    if($db_driver_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_driver_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $sql1 = "SELECT iDriverId,vRideNo from trips where iDriverId='" . $db_driver_user[0]['iMemberId'] . "' AND iActive = 'Finished'";
                        $db_trips_driver = $obj->MySQLSelect($sql1);
                        $count_driver = scount($db_trips_driver);
                        $bsql1 = "SELECT iDriverId,vBiddingPostNo,iBiddingPostId from bidding_post where iDriverId='" . $db_driver_user[0]['iMemberId'] . "' AND eStatus = 'Completed'";
                        $db_bidding_task_driver = $obj->MySQLSelect($bsql1);
                        $count_driver_bidding = scount($db_bidding_task_driver);
                        if($count_driver == 1 && $count_driver_bidding == 0){
                            $refDriverCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refDriverCount])){
                                    $refMemberId = $tReferrerInfo[$refDriverCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refDriverCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor_Driver = "Referrer";
                                    $tDescription_Driver = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate_Driver = Date('Y-m-d H:i:s');
                                    $ePaymentStatus_Driver = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iTripId][$eFor_Driver])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iTripId, $eFor_Driver, $tDescription_Driver, $ePaymentStatus_Driver, $dDate_Driver);
                                    }
                                    if(isset($wallet_id)){
                                        $where = ' iUserWalletId = '.$wallet_id;
                                        $wallet_update_data['fromUserId'] = $db_driver_user[0]['iMemberId'];
                                        $wallet_update_data['fromUserType'] = $db_driver_user[0]['eUserType'];
                                        $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                    }
                                }
                                $refDriverCount++;
                            }
                        }
                    }
                }
            }
            return $count_rider;
        }
    }
    public function CreditReferralAmountSingleTakeAway($iOrderId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT, $COMM_MEDIA_OBJ, $WALLET_OBJ, $CONFIG_OBJ;
        $orderSql = "SELECT iUserId FROM orders WHERE iOrderId=".$iOrderId;
        $ordersData = $obj->MySQLSelect($orderSql);
        $sql = "SELECT vCurrencyPassenger AS currency,iUserId,iRefUserId ,eRefType, CONCAT(vName,' ',vLastName)as orderusername from register_user where iUserId=" . $ordersData[0]['iUserId'];
        $db_order_user = $obj->MySQLSelect($sql);
        $count_order_user = scount($db_order_user);
        if($count_order_user > 0){
            $iRefUserId = $db_order_user[0]['iRefUserId'];
            $iUserId = $db_order_user[0]['iUserId'];
            $eRefType = $db_order_user[0]['eRefType'];
            if($iRefUserId != 0){
                $eFor = "Referrer";
                $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                $dDate = Date('Y-m-d H:i:s');
                $ePaymentStatus = "Unsettelled";
                $WALLET_OBJ->PerformWalletTransaction($iRefUserId, $eRefType, $REFERRAL_AMOUNT, 'Credit', $iOrderId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                if($eRefType == "Rider"){
                    $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_user where iUserId='" . $iRefUserId . "'";
                }
                else {
                    $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_driver where iDriverId='" . $iRefUserId . "'";
                }
                $db_user_refer = $obj->MySQLSelect($sql12);
                $vEmailorder = $db_user_refer[0]['vEmail'];
            }
        }
        $vEmail = '';
        $currency = "";
        if(!empty($vEmailorder)){
            $vEmail = $vEmailorder;
            $userName = $db_user_refer[0]['username'];
            $orderusername = $db_order_user[0]['orderusername'];
            $currency = $db_driver_user[0]['currency'];
        }
        if(!empty($vEmail)){
            $REFERRAL_AMOUNT = $WALLET_OBJ->MemberCurrencyWalletBalance(0, $REFERRAL_AMOUNT, $currency);
            $maildatadeliverd['vEmail'] = $vEmail;
            $maildatadeliverd['UserName'] = $userName;
            $maildatadeliverd['EMAIL_NAME'] = $userName;
            $maildatadeliverd['TripUserName'] = $orderusername;
            if(empty($COMPANY_NAME)){
                $COMPANY_NAME = $CONFIG_OBJ->getConfigurations("configurations", "COMPANY_NAME");
                $COMPANY_NAME = $COMPANY_NAME[0]['vValue'];
            }
            $maildatadeliverd['CompanyName'] = $COMPANY_NAME;
            $maildatadeliverd['amount'] = $REFERRAL_AMOUNT;
            $mailResponse = $COMM_MEDIA_OBJ->SendMailToMember("REFERRAL_AMOUNT_CREDIT_TO_USER", $maildatadeliverd);
        }
    }
    public function CreditReferralAmountTakeAway($iOrderId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT, $REFERRAL_SCHEME_ENABLE, $MODULES_OBJ, $COMM_MEDIA_OBJ, $WALLET_OBJ, $CONFIG_OBJ, $REFERRAL_LEVEL,$REFERRAL_AMOUNT_EARN_STRATEGY;
        if(!$MODULES_OBJ->isEnableMultiLevelReferralSystem()){
            if(strtoupper($REFERRAL_SCHEME_ENABLE)== "YES"){
                $this->CreditReferralAmountSingleTakeAway($iOrderId);
            }
        }
        else {
            $orderSql = "SELECT * FROM orders WHERE iOrderId=".$iOrderId;
            $ordersData = $obj->MySQLSelect($orderSql);
            $count_rider = scount($ordersData);
            $getPaymentStatus = $obj->MySQLSelect("SELECT iOrderId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iOrderId='" . $iOrderId . "'");
            $walletArr = array();
            for($h = 0;
            $h < scount($getPaymentStatus);
            $h++){
                $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iOrderId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
            }
            if($count_rider > 0){
                $iFare = $ordersData[0]['fNetTotal'] + $ordersData[0]['fWalletDebit'];
                $refSql = "SELECT * FROM multi_level_referral_master WHERE eStatus = 'Active' ORDER BY iLevel LIMIT $REFERRAL_LEVEL";
                $refData = $obj->MySQLSelect($refSql);
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $ordersData[0]['iUserId']." AND eUserType = 'Rider'";
                $db_rider_user = $obj->MySQLSelect($sql);
                $count_rider_user = scount($db_rider_user);
                if($count_rider_user > 0){
                    if($db_rider_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_rider_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $sql1 = "SELECT iUserId,vOrderNo from orders where iUserId='" . $db_rider_user[0]['iMemberId'] . "' AND iStatusCode = '6'";
                        $db_trips_user = $obj->MySQLSelect($sql1);
                        $count_rider = scount($db_trips_user);
                        if($count_rider == 1){
                            $refRiderCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refRiderCount])){
                                    $refMemberId = $tReferrerInfo[$refRiderCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refRiderCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor = "Referrer";
                                    $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate = Date('Y-m-d H:i:s');
                                    $ePaymentStatus = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iOrderId][$eFor])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iOrderId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                                    }
                                    $where = ' iUserWalletId = '.$wallet_id;
                                    $wallet_update_data['fromUserId'] = $db_rider_user[0]['iMemberId'];
                                    $wallet_update_data['fromUserType'] = $db_rider_user[0]['eUserType'];
                                    $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                }
                                $refRiderCount++;
                            }
                        }
                    }
                }
            }
            return $count_rider;
        }
    }
    public function CreditReferralAmountSingleBidding($iBiddingPostId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT,$tripDetailsArr,$userDetailsArr, $WALLET_OBJ, $COMM_MEDIA_OBJ, $CONFIG_OBJ,$BIDDING_OBJ;
        $db_result = $BIDDING_OBJ->getBiddingPost('webservice', $iBiddingPostId);
        $count_rider = scount($db_result);
        $getPaymentStatus = $obj->MySQLSelect("SELECT iBiddingPostId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iBiddingPostId='" . $iBiddingPostId . "'");
        $walletArr = array();
        for($h = 0;
        $h < scount($getPaymentStatus);
        $h++){
            $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iBiddingPostId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
        }
        if($count_rider > 0){
            if(isset($userDetailsArr['register_user_'.$db_result[0]['iUserId']])){
                $db_rider_user = $userDetailsArr['register_user_'.$db_result[0]['iUserId']];
                if(scount($db_rider_user)> 0){
                    $db_rider_user[0]['currency'] = $db_rider_user[0]['vCurrencyPassenger'];
                    $db_rider_user[0]['tripusername'] = $db_rider_user[0]['vName']." ".$db_rider_user[0]['vLastName'];
                }
            }
            else {
                $db_rider_user = $obj->MySQLSelect("SELECT vCurrencyPassenger AS currency,iUserId,iRefUserId ,eRefType, CONCAT(vName,' ',vLastName)as tripusername from register_user where iUserId=" . $db_result[0]['iUserId']);
            }
            $count_rider_user = scount($db_rider_user);
            if($count_rider_user > 0){
                $iRefUserId = $db_rider_user[0]['iRefUserId'];
                $iUserId = $db_rider_user[0]['iUserId'];
                $eRefType = $db_rider_user[0]['eRefType'];
                if($iRefUserId != 0){
                    $sql1 = "SELECT iUserId,vRideNo from trips where iUserId='" . $iUserId . "' AND iActive = 'Finished'";
                    $db_trips_user = $obj->MySQLSelect($sql1);
                    $count_rider = scount($db_trips_user);
                    $bsql1 = "SELECT iUserId,vBiddingPostNo,iBiddingPostId from bidding_post where iUserId = '" . $iUserId . "' AND eStatus = 'Completed'";
                    $db_bidding_task_user = $obj->MySQLSelect($bsql1);
                    $count_rider_bidding = scount($db_bidding_task_user);
                    if($count_rider == 0 && $count_rider_bidding == 1){
                        $eFor = "Referrer";
                        $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                        $dDate = Date('Y-m-d H:i:s');
                        $ePaymentStatus = "Unsettelled";
                        if(!isset($walletArr['Credit'][$eRefType][$iBiddingPostId][$eFor])){
                            $WALLET_OBJ->PerformWalletTransaction($iRefUserId, $eRefType, $REFERRAL_AMOUNT, 'Credit', $iBiddingPostId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                        }
                        if($eRefType=="Driver"){
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_driver where iDriverId='" . $iRefUserId . "'";
                        }
                        else {
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_user where iUserId='" . $iRefUserId . "'";
                        }
                        $db_user_refer = $obj->MySQLSelect($sql12);
                        $vEmailrider = $db_user_refer[0]['vEmail'];
                    }
                }
            }
            if(isset($userDetailsArr['register_driver_'.$db_result[0]['iDriverId']])){
                $db_driver_user = $userDetailsArr['register_driver_'.$db_result[0]['iDriverId']];
                if(scount($db_driver_user)> 0){
                    $db_driver_user[0]['currency'] = $db_driver_user[0]['vCurrencyDriver'];
                    $db_driver_user[0]['tripusername'] = $db_driver_user[0]['vName']." ".$db_driver_user[0]['vLastName'];
                }
            }
            else {
                $db_driver_user = $obj->MySQLSelect("SELECT iRefUserId,iDriverId,eRefType, CONCAT(vName,' ',vLastName)as tripusername,vCurrencyDriver As currency from register_driver where iDriverId=" . $db_result[0]['iDriverId']);
            }
            $count_driver_user = scount($db_driver_user);
            if($count_driver_user > 0){
                $iRefUserId = $db_driver_user[0]['iRefUserId'];
                $iDriverId = $db_driver_user[0]['iDriverId'];
                $eRefType = $db_driver_user[0]['eRefType'];
                if($iRefUserId != 0){
                    $sql1 = "SELECT iDriverId,vRideNo from trips where iDriverId='" . $iDriverId . "' AND iActive = 'Finished'";
                    $db_trips_driver = $obj->MySQLSelect($sql1);
                    $count_driver = scount($db_trips_driver);
                    $bsql1 = "SELECT iDriverId,vBiddingPostNo,iBiddingPostId from bidding_post where iDriverId='" . $iDriverId . "' AND eStatus = 'Completed'";
                    $db_bidding_task_driver = $obj->MySQLSelect($bsql1);
                    $count_driver_bidding = scount($db_bidding_task_driver);
                    if($count_driver == 0 && $count_driver_bidding == 1){
                        $eFor_Driver = "Referrer";
                        $tDescription_Driver = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                        $dDate_Driver = Date('Y-m-d H:i:s');
                        $ePaymentStatus_Driver = "Unsettelled";
                        if(!isset($walletArr['Credit'][$eRefType][$iBiddingPostId][$eFor_Driver])){
                            $WALLET_OBJ->PerformWalletTransaction($iRefUserId, $eRefType, $REFERRAL_AMOUNT, 'Credit', $iBiddingPostId, $eFor_Driver, $tDescription_Driver, $ePaymentStatus_Driver, $dDate_Driver);
                        }
                        if($eRefType=="Driver"){
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_driver where iDriverId='" . $iRefUserId . "'";
                        }
                        else {
                            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username from register_user where iUserId='" . $iRefUserId . "'";
                        }
                        $db_driver_refer = $obj->MySQLSelect($sql12);
                        $vEmaildriver = $db_driver_refer[0]['vEmail'];
                    }
                }
            }
        }
        $vEmail = '';
        $currency = "";
        if(!empty($vEmaildriver)){
            $vEmail = $vEmaildriver;
            $userName = $db_driver_refer[0]['username'];
            $tripusername = $db_driver_user[0]['tripusername'];
            $currency = $db_driver_user[0]['currency'];
        }
        else if(!empty($vEmailrider)){
            $vEmail = $vEmailrider;
            $userName = $db_user_refer[0]['username'];
            $tripusername = $db_rider_user[0]['tripusername'];
            $currency = $db_rider_user[0]['currency'];
        }
        if(!empty($vEmail)){
            $REFERRAL_AMOUNT = $WALLET_OBJ->MemberCurrencyWalletBalance(0, $REFERRAL_AMOUNT, $currency);
            $maildatadeliverd['vEmail'] = $vEmail;
            $maildatadeliverd['UserName'] = $userName;
            $maildatadeliverd['EMAIL_NAME'] = $userName;
            $maildatadeliverd['TripUserName'] = $tripusername;
            if(empty($COMPANY_NAME)){
                $COMPANY_NAME = $CONFIG_OBJ->getConfigurations("configurations", "COMPANY_NAME");
                $COMPANY_NAME = $COMPANY_NAME[0]['vValue'];
            }
            $maildatadeliverd['CompanyName'] = $COMPANY_NAME;
            $maildatadeliverd['amount'] = $REFERRAL_AMOUNT;
            $mailResponse = $COMM_MEDIA_OBJ->SendMailToMember("REFERRAL_AMOUNT_CREDIT_TO_USER", $maildatadeliverd);
        }
        return $count_rider;
    }
    public function CreditReferralAmountBidding($iBiddingPostId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT_EARN_STRATEGY, $REFERRAL_SCHEME_ENABLE, $MODULES_OBJ, $REFERRAL_LEVEL,$WALLET_OBJ,$BIDDING_OBJ;
        if(!$MODULES_OBJ->isEnableMultiLevelReferralSystem()){
            if(strtoupper($REFERRAL_SCHEME_ENABLE)== "YES"){
                $this->CreditReferralAmountSingleBidding($iBiddingPostId);
            }
        }
        else {
            $getbiddingresult = $obj->MySQLSelect("SELECT * FROM bidding_post WHERE iBiddingPostId='" . $iBiddingPostId . "'");
            $count_rider = scount($getbiddingresult);
            $db_result = $BIDDING_OBJ->getBiddingPost('webservice', $iBiddingPostId);
            $getPaymentStatus = $obj->MySQLSelect("SELECT iBiddingPostId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iBiddingPostId='" . $iBiddingPostId . "'");
            $walletArr = array();
            for($h = 0;
            $h < scount($getPaymentStatus);
            $h++){
                $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iBiddingPostId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
            }
            if($count_rider > 0){
                $iFare = $db_result[0]['fBiddingAmount'];
                $refSql = "SELECT * FROM multi_level_referral_master WHERE eStatus = 'Active' ORDER BY iLevel LIMIT $REFERRAL_LEVEL";
                $refData = $obj->MySQLSelect($refSql);
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $db_result[0]['iUserId']." AND eUserType = 'Rider'";
                $db_rider_user = $obj->MySQLSelect($sql);
                $count_rider_user = scount($db_rider_user);
                if($count_rider_user > 0){
                    if($db_rider_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_rider_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $sql1 = "SELECT iUserId,vRideNo from trips where iUserId='" . $db_rider_user[0]['iMemberId'] . "' AND iActive = 'Finished'";
                        $db_trips_user = $obj->MySQLSelect($sql1);
                        $count_rider = scount($db_trips_user);
                        $bsql1 = "SELECT iUserId,vBiddingPostNo,iBiddingPostId from bidding_post where iUserId='" . $db_rider_user[0]['iMemberId'] . "' AND eStatus = 'Completed'";
                        $db_bidding_task_user = $obj->MySQLSelect($bsql1);
                        $count_rider_bidding = scount($db_bidding_task_user);
                        if($count_rider == 0 && $count_rider_bidding == 1){
                            $refRiderCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refRiderCount])){
                                    $refMemberId = $tReferrerInfo[$refRiderCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refRiderCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor = "Referrer";
                                    $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate = Date('Y-m-d H:i:s');
                                    $ePaymentStatus = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iBiddingPostId][$eFor])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iBiddingPostId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                                        $where = ' iUserWalletId = '.$wallet_id;
                                        $wallet_update_data['fromUserId'] = $db_rider_user[0]['iMemberId'];
                                        $wallet_update_data['fromUserType'] = $db_rider_user[0]['eUserType'];
                                        $wallet_update_data['iBiddingPostId'] = $iBiddingPostId;
                                        $wallet_update_data['iTripId'] = 0;
                                        $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                    }
                                }
                                $refRiderCount++;
                            }
                        }
                    }
                }
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $db_result[0]['iDriverId']." AND eUserType = 'Driver'";
                $db_driver_user = $obj->MySQLSelect($sql);
                $count_driver_user = scount($db_driver_user);
                if($count_driver_user > 0){
                    if($db_driver_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_driver_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $sql1 = "SELECT iDriverId,vRideNo from trips where iDriverId='" . $db_driver_user[0]['iMemberId'] . "' AND iActive = 'Finished'";
                        $db_trips_driver = $obj->MySQLSelect($sql1);
                        $count_driver = scount($db_trips_driver);
                        $bsql1 = "SELECT iDriverId,vBiddingPostNo,iBiddingPostId from bidding_post where iDriverId='" . $db_driver_user[0]['iMemberId'] . "' AND eStatus = 'Completed'";
                        $db_bidding_task_driver = $obj->MySQLSelect($bsql1);
                        $count_driver_bidding = scount($db_bidding_task_driver);
                        if($count_driver == 0 && $count_driver_bidding == 1){
                            $refDriverCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refDriverCount])){
                                    $refMemberId = $tReferrerInfo[$refDriverCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refDriverCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor_Driver = "Referrer";
                                    $tDescription_Driver = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate_Driver = Date('Y-m-d H:i:s');
                                    $ePaymentStatus_Driver = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iBiddingPostId][$eFor_Driver])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iBiddingPostId, $eFor_Driver, $tDescription_Driver, $ePaymentStatus_Driver, $dDate_Driver);
                                        $where = ' iUserWalletId = '.$wallet_id;
                                        $wallet_update_data['fromUserId'] = $db_driver_user[0]['iMemberId'];
                                        $wallet_update_data['fromUserType'] = $db_driver_user[0]['eUserType'];
                                        $wallet_update_data['iBiddingPostId'] = $iBiddingPostId;
                                        $wallet_update_data['iTripId'] = 0;
                                        $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                    }
                                }
                                $refDriverCount++;
                            }
                        }
                    }
                }
            }
            return $count_rider;
        }
    }
    public function CreditReferralAmountRideShare($iBookingId){
        global $obj, $COMPANY_NAME, $REFERRAL_AMOUNT_EARN_STRATEGY, $REFERRAL_SCHEME_ENABLE, $MODULES_OBJ, $REFERRAL_LEVEL,$WALLET_OBJ,$BIDDING_OBJ;
        if(!$MODULES_OBJ->isEnableMultiLevelReferralSystem()){
            if(strtoupper($REFERRAL_SCHEME_ENABLE)== "YES"){
                $this->CreditReferralAmountSingleBidding($iBookingId);
            }
        }
        else {
            $getPublishedRideBookingResult = $obj->MySQLSelect("SELECT * FROM ride_share_bookings WHERE iBookingId ='" . $iBookingId . "'");
            $count_rider = scount($getPublishedRideBookingResult);
            $db_result = $getPublishedRideBookingResult;
            $getPaymentStatus = $obj->MySQLSelect("SELECT iBookingId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iBookingId='" . $iBookingId . "'");
            $walletArr = array();
            for($h = 0;
            $h < scount($getPaymentStatus);
            $h++){
                $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iBookingId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
            }
            if($count_rider > 0){
                $iFare = $db_result[0]['fTotal'];
                $refSql = "SELECT * FROM multi_level_referral_master WHERE eStatus = 'Active' ORDER BY iLevel LIMIT $REFERRAL_LEVEL";
                $refData = $obj->MySQLSelect($refSql);
                $sql = "SELECT iMemberId,eUserType,tReferrerInfo from user_referrer_transaction where iMemberId = " . $db_result[0]['iUserId']." AND eUserType = 'Rider'";
                $db_rider_user = $obj->MySQLSelect($sql);
                $count_rider_user = scount($db_rider_user);
                if($count_rider_user > 0){
                    if($db_rider_user[0]['tReferrerInfo'] != ""){
                        $tReferrerInfo = json_decode($db_rider_user[0]['tReferrerInfo'], true);
                        $position = array_column($tReferrerInfo, 'Position of Referrer');
                        array_multisort($position, SORT_DESC, $tReferrerInfo);
                        $rssql1 = "SELECT * FROM ride_share_bookings rsb JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)WHERE pr.eTrackingStatus = 'PaymentCollect' AND `iBookingId` = '" . $iBookingId . "'";
                        $db_ride_share_user = $obj->MySQLSelect($rssql1);
                        $count_ride_share_user = scount($db_ride_share_user);
                        if($count_ride_share_user == 1){
                            $refRiderCount = 0;
                            foreach($refData as $refLevel){
                                if(isset($tReferrerInfo[$refRiderCount])){
                                    $refMemberId = $tReferrerInfo[$refRiderCount]['iMemberId'];
                                    $refUserType = $tReferrerInfo[$refRiderCount]['eUserType'];
                                    $refAmount = $refLevel['iAmount'];
                                    if($REFERRAL_AMOUNT_EARN_STRATEGY == "Percentage"){
                                        $refAmount =($refLevel['iAmount'] / 100)* $iFare;
                                    }
                                    $refAmount = setTwoDecimalPoint($refAmount, 2);
                                    $eFor = "Referrer";
                                    $tDescription = "#LBL_REFERRAL_AMOUNT_CREDIT#";
                                    $dDate = Date('Y-m-d H:i:s');
                                    $ePaymentStatus = "Unsettelled";
                                    if(!isset($walletArr['Credit'][$refUserType][$iBookingId][$eFor])){
                                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($refMemberId, $refUserType, $refAmount, 'Credit', $iBiddingPostId, $eFor, $tDescription, $ePaymentStatus, $dDate);
                                        $where = ' iUserWalletId = '.$wallet_id;
                                        $wallet_update_data['fromUserId'] = $db_rider_user[0]['iMemberId'];
                                        $wallet_update_data['fromUserType'] = $db_rider_user[0]['eUserType'];
                                        $wallet_update_data['iBookingId'] = $iBookingId;
                                        $wallet_update_data['iTripId'] = 0;
                                        $obj->MySQLQueryPerform('user_wallet', $wallet_update_data, 'update', $where);
                                    }
                                }
                                $refRiderCount++;
                            }
                        }
                    }
                }
            }
            return $count_rider;
        }
    }
}
class ReplaceWord {
    public static function getInstance(){
        return new ReplaceWord();
    }
    public function __construct(){
        global $obj;
    }
    public function replace($keywords, $ignore_db_tables = array()){
        global $obj;
        $all_tables = $this->getAllDBTables();
        foreach($keywords as $searchStr => $replaceStr){
            $all_search_results = array();
            foreach($all_tables as $table){
                if(in_array($table, $ignore_db_tables)){
                    continue;
                }
                $sql = "SELECT GROUP_CONCAT(`COLUMN_NAME`)as TABLE_COLUMNS, GROUP_CONCAT(`DATA_TYPE`)as DATA_TYPE_ALL FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE `TABLE_NAME`='$table' AND `TABLE_SCHEMA`='".TSITE_DB."';
                ";
                $results = $obj->MySQLSelect($sql);
                $TABLE_COLUMNS = explode(',', $results[0]['TABLE_COLUMNS']);
                $TABLE_COLUMNS_DATA_TYPE = explode(',', $results[0]['DATA_TYPE_ALL']);
                $column1 = $TABLE_COLUMNS[0];
                $column_str = "(CONVERT(`$column1` USING utf8)RLIKE '[[:<:]]" . addslashes($searchStr). "[[:>:]]'";
                foreach($TABLE_COLUMNS as $colkey => $column){
                    if(!in_array($TABLE_COLUMNS_DATA_TYPE[$colkey], ["varchar", "text", "mediumtext", "longtext", "json"])){
                        continue;
                    }
                    $column_str .= " OR CONVERT(`$column` USING utf8)RLIKE '[[:<:]]" . addslashes($searchStr). "[[:>:]]'";
                }
                $column_str .= ")";
                $sql1 = "SELECT * FROM $table WHERE " . $column_str;
                $search_results = $obj->MySQLSelect($sql1);
                if(!empty($search_results)&& scount($search_results)> 0){
                    $primary_key_data = $obj->MySQLSelect("SHOW KEYS FROM $table WHERE Key_name = 'PRIMARY'");
                    $primary_key = $primary_key_data[0]['Column_name'];
                    foreach($search_results as $rows){
                        foreach($rows as $key => $value){
                            if(preg_match("/\b" . $searchStr . "\b/", $value)){
                                $all_search_results[$table][$primary_key][$rows[$primary_key]][] = $key;
                            }
                        }
                    }
                    $table_primary_key_results_all = array();
                    if(isset($all_search_results[$table][$primary_key])){
                        $table_results = $all_search_results[$table][$primary_key];
                        $table_primary_key_ids = array_keys($table_results);
                        $table_primary_key_ids = implode(',', $table_primary_key_ids);
                        $table_primary_key_results = array_values($table_results);
                        foreach($table_primary_key_results as $key => $value){
                            $table_primary_key_results_all = array_merge($table_primary_key_results_all, $value);
                        }
                        $table_primary_key_results_all = array_unique($table_primary_key_results_all);
                        $table_primary_key_results_all = implode(',', $table_primary_key_results_all);
                        $all_search_results[$table][$primary_key] = array('primary_key_ids' => $table_primary_key_ids, 'table_fields' => $table_primary_key_results_all);
                    }
                }
            }
            foreach($all_search_results as $key => $value){
                $primary_key_field = array_keys($value)[0];
                $table_fields = $value[$primary_key_field]['table_fields'];
                $table_ids = $value[$primary_key_field]['primary_key_ids'];
                $table_fields_arr = explode(',', $table_fields);
                $sql = "SELECT $primary_key_field,$table_fields FROM $key WHERE $primary_key_field IN($table_ids)";
                $res = $obj->MySQLSelect($sql);
                if(!empty($res)&& scount($res)){
                    foreach($res as $row){
                        $sql_update = "UPDATE $key SET ";
                        $update_data = array();
                        $sql_update_str = "";
                        foreach($table_fields_arr as $field){
                            $update_data = $this->replaceWord($row[$field], $searchStr, $replaceStr);
                            $sql_update_str .= " $field = '" . $obj->SqlEscapeString($update_data). "', ";
                        }
                        $sql_update_str = rtrim($sql_update_str, ", ");
                        $sql_update .= $sql_update_str . " WHERE $primary_key_field = " . $row[$primary_key_field];
                        $obj->sql_query($sql_update);
                    }
                }
            }
        }
    }
    private function getAllDBTables(){
        global $obj;
        $allDbTables = $obj->MySQLSelect("SELECT DISTINCT(TABLE_NAME)FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND `TABLE_SCHEMA`='".TSITE_DB."' ORDER BY TABLE_NAME");
        $tablesArr = array();
        foreach($allDbTables as $value){
            $tablesArr[] = $value['TABLE_NAME'];
        }
        return $tablesArr;
    }
    private function replaceWord($string, $searchStr, $replaceStr){
        $string = preg_replace("/\b(?<!#)" . $searchStr . "(?<!" . $replaceStr . ")\b/", $replaceStr, $string);
        return $string;
    }
}
class StaticPage {
    public function __construct(){
    }
    public function FetchStaticPage($id, $lang_code = "EN"){
        global $obj,$vSystemDefaultLangCode,$cacheKeysArr, $LANG_OBJ;
        $data['meta_title'] = $data['meta_keyword'] = $data['meta_desc'] = $data['page_title'] = $data['page_desc'] = $data['vImage'] = $data['vImage1'] = $data['vImage2'] = "";
        if(is_array($id)){
            $implodeId = implode(",",$id);
            $data = $obj->MySQLSelect("SELECT * FROM pages WHERE iPageId IN($implodeId)");
            $staticDataArr = array();
            for($g=0;
            $g<scount($data);
            $g++){
                $pageData = array();
                $pageData['meta_title'] = $data[$g]["vTitle"];
                $pageData['vImage'] = $data[$g]["vImage"];
                $pageData['meta_keyword'] = $data[$g]["tMetaKeyword"];
                $pageData['meta_desc'] = $data[$g]["tMetaDescription"];
                $pageData['page_title'] = $data[$g]["vPageTitle_" . $lang_code];
                $pageData['page_desc'] = $data[$g]["tPageDesc_" . $lang_code];
                if(empty($pageData['page_title'])&& empty($pageData['page_desc'])){
                    if($vSystemDefaultLangCode != ""){
                        $lang_code = $vSystemDefaultLangCode;
                    }
                    else {
                        $lang_code = $LANG_OBJ->FetchDefaultLangData("vCode");
                    }
                    $pageData['page_title'] = $data[$g]["vPageTitle_" . $lang_code];
                    $pageData['page_desc'] = $data[$g]["tPageDesc_" . $lang_code];
                }
                $pageData['vImage1'] = $data[$g]["vImage1"];
                $pageData['vImage2'] = $data[$g]["vImage2"];
                $pageData['vUserImage'] = $data[$g]["vUserImage"];
                $pageData['vDriverImage'] = $data[$g]["vDriverImage"];
                $pageData['vCompanyImage'] = $data[$g]["vCompanyImage"];
                $pageData['vStoreImage'] = $data[$g]["vStoreImage"];
                $pageData['vOrgImage'] = $data[$g]["vOrgImage"];
                $pageData['vTrackingImage'] = $data[$g]["vTrackingImage"];
                $staticDataArr[$data[$g]['iPageId']] = $pageData;
            }
            return $staticDataArr;
        }
        else if($id != ''){
            $data = $this->getStaticPageData($id);
            if(scount($data)> 0){
                $data['meta_title'] = $data[0]["vTitle"];
                $data['vImage'] = $data[0]["vImage"];
                $data['meta_keyword'] = $data[0]["tMetaKeyword"];
                $data['meta_desc'] = $data[0]["tMetaDescription"];
                $data['page_title'] = $data[0]["vPageTitle_" . $lang_code];
                $data['page_desc'] = $data[0]["tPageDesc_" . $lang_code];
                if(empty($data['page_title'])&& empty($data['page_desc'])){
                    if($vSystemDefaultLangCode != ""){
                        $lang_code = $vSystemDefaultLangCode;
                    }
                    else {
                        $lang_code = $LANG_OBJ->FetchDefaultLangData("vCode");
                    }
                    $data['page_title'] = $data[0]["vPageTitle_" . $lang_code];
                    $data['page_desc'] = $data[0]["tPageDesc_" . $lang_code];
                }
                $data['vImage1'] = $data[0]["vImage1"];
                $data['vImage2'] = $data[0]["vImage2"];
                $data['vUserImage'] = $data[0]["vUserImage"];
                $data['vDriverImage'] = $data[0]["vDriverImage"];
                $data['vCompanyImage'] = $data[0]["vCompanyImage"];
                $data['vStoreImage'] = $data[0]["vStoreImage"];
                $data['vOrgImage'] = $data[0]["vOrgImage"];
                $data['vTrackingImage'] = $data[0]["vTrackingImage"];
            }
        }
        return $data;
    }
    private function getStaticPageData($page_id){
        global $obj, $oCache, $cacheKeysArr;
        $staticPageApcKey = md5($cacheKeysArr['pages']);
        $getStaticCacheData = $oCache->getData($staticPageApcKey);
        if(!empty($getStaticCacheData)&& scount($getStaticCacheData)> 0){
            $data = $getStaticCacheData;
        }
        else {
            $data = $obj->MySQLSelect("SELECT * FROM pages");
            $setPagesCacheData = $oCache->setData($staticPageApcKey, $data);
        }
        foreach($data as $pageData){
            if($pageData['iPageId'] == $page_id){
                $pageDataTmp[0] = $pageData;
                return $pageDataTmp;
            }
        }
    }
    public function FetchSeoSetting($id){
        global $obj;
        if($id != ''){
            $q = "SELECT * FROM seo_sections WHERE iId = " . $id;
            $data = $obj->MySQLSelect($q);
            if(scount($data)> 0){
                $data['meta_title'] = $data[0]["vPagetitle"];
                $data['meta_keyword'] = $data[0]["vMetakeyword"];
                $data['meta_desc'] = $data[0]["tDescription"];
            }
        }
        return $data;
    }
    public function gethomeDataNew($vCode){
        global $obj;
        if($vCode != ''){
            $q = "SELECT * FROM homecontent WHERE vCode = '" . $vCode . "'";
            $data = $obj->MySQLSelect($q);
            if(scount($data)> 0){
                $data['meta_title'] = $data[0]["vPagetitle"];
                $data['meta_keyword'] = '';
                $data['meta_desc'] = $data[0]["tDescription"];
            }
            if(empty($data)){
                $q = "SELECT * FROM homecontent WHERE vCode = 'EN'";
                $data = $obj->MySQLSelect($q);
            }
        }
        return $data;
    }
}
class SystemTheme {
    private $sys_template = '';
    private $sys_templatePath = '';
    private $sys_logogpath = '';
    function __construct(){
    }
    public static function getInstance(){
        return new SystemTheme();
    }
    public function getTheme(){
        global $APP_TYPE, $tconfig, $obj, $parent_ufx_catid;
        $tab = "false";
        if($APP_TYPE == 'Ride'){
            $tab = "true";
            $template = 'Ride';
        }
        else if($APP_TYPE == 'Delivery'){
            $tab = "true";
            $template = 'Delivery';
        }
        else if($APP_TYPE == 'Ride-Delivery'){
            $tab = "true";
            $template = 'Ride-Delivery';
        }
        else if($APP_TYPE == 'Ride-Delivery-UberX'){
            $tab = "true";
            $template = 'Ride-Delivery-UberX';
        }
        else if($APP_TYPE == 'UberX'){
            if(self::isServiceXThemeActive()== 'Yes'){
                $tName = 'ServiceX';
            }
            elseif(self::isServiceXv2ThemeActive()== 'Yes'){
                $tName = 'ServiceXv2';
            }
            elseif(self::isProSPThemeActive()== 'Yes'){
                $tName = 'ProService';
            }
            else {
                $tName = 'UberX';
            }
            $Ssql = "SELECT iMasterVehicleCategoryId FROM `vehicle_category` WHERE eStatus='Active' and iParentId=0 and iMasterVehicleCategoryId > 0 AND iVehicleCategoryId='".$parent_ufx_catid."'";
            $ServiceData = $obj->MySQLSelect($Ssql);
            if(!empty($ServiceData)){
                if(scount($ServiceData)< 1){
                    $vService = $tName;
                }
                else {
                    $vService =$iMasterVehicleCategoryId= $ServiceData[0]['iMasterVehicleCategoryId'];
                }
            }
            else {
                $vService = $tName;
                if(self::isServiceXv2ThemeActive()== 'Yes' || self::isProSPThemeActive()== 'Yes'){
                    $vService = 'ServiceX';
                }
            }
            $template = $tName . '/' . $vService;
            if(file_exists($tconfig["tpanel_path"] . "templates/" . $template . "/")){
                $template = $tName .'/'. $vService;
            }
            else {
                $template = $tName.'/'.$tName;
            }
        }
        else if($APP_TYPE == 'Delivery'){
            $template = 'uber';
        }
        if(self::isCubexThemeActive()== 'Yes'){
            $template = 'Cubex';
        }
        else if(self::isCubeJekXThemeActive()== 'Yes'){
            $template = 'CJX';
        }
        else if(self::isCubeJekXv2ThemeActive()== 'Yes'){
            $template = 'CJXv2';
        }
        else if(self::isCubeJekXv3ThemeActive()== 'Yes'){
            $template = 'CJXv3';
        }
        else if(self::isCubeJekXv3ProThemeActive()== 'Yes'){
            $template = 'CJXv3Pro';
        }
        else if(self::isCJXDoctorv2ThemeActive()== 'Yes'){
            $template = 'CJDoc';
        }
        else if(self::isRideCXThemeActive()== 'Yes'){
            $template = 'RideCX';
        }
        else if(self::isDeliveryXThemeActive()== 'Yes'){
            $template = 'DeliveryX';
        }
        else if(self::isDeliveryKingThemeActive()== 'Yes'){
            $template = 'DeliveryKing';
        }
        else if(self::isRideDeliveryXThemeActive()== 'Yes'){
            $template = 'Ride-Delivery-X';
        }
        else if(self::isRideCXv2ThemeActive()== 'Yes'){
            $template = 'RideCXv2';
        }
        else if(self::isCubeXv2ThemeActive()== 'Yes'){
            $template = 'CubeXv2';
        }
        else if(self::isDeliveryKingXv2ThemeActive()== 'Yes'){
            $template = 'DeliveryKingv2';
        }
        else if(self::isDeliveryXv2ThemeActive()== 'Yes'){
            $template = 'DeliveryXv2';
        }
        else if(self::isMedicalServicev2ThemeActive()== 'Yes'){
            $template = 'CJDocv2';
        }
        else if(self::isPXTProThemeActive()== 'Yes'){
            $template = 'PXTPro';
        }
        else if(self::isPXRDProThemeActive()== 'Yes'){
            $template = 'PXRDPro';
        }
        else if(self::isPXCProThemeActive()== 'Yes'){
            $template = 'ProCX';
        }
        else if(self::isProDeliveryThemeActive()== 'Yes'){
            $template = 'ProDY';
        }
        else if(self::isProDeliveryKingThemeActive()== 'Yes'){
            $template = 'ProDK';
        }
        else if(self::isProRideShareThemeActive()== 'Yes'){
            $template = 'ProRS';
        }
        else if(self::isProBuySellRentThemeActive()== 'Yes'){
            $template = 'ProBSR';
        }
        else if(self::isProFETThemeActive()== 'Yes'){
            $template = 'ProFET';
        }
        else if(self::isProMSThemeActive()== 'Yes'){
            $template = 'ProMS';
        }
        else if(self::isProKXThemeActive()== 'Yes'){
            $template = 'ProKX';
        }
        else if(self::isProPTXThemeActive()== 'Yes'){
            $template = 'ProPTX';
        }
        else if(self::isProXRDThemeActive()== 'Yes'){
            $template = 'ProXRD';
        }
        else if(self::isProBTYAIOThemeActive()== 'Yes'){
            $template = 'ProBTYAIO';
        }
        else if(self::isProCubeXGCThemeActive()== 'Yes'){
            $template = 'ProGBX';
        }
        else if(self::isProBSRXThemeActive()== 'Yes'){
            $template = 'ProBSRX';
        }
        if(ONLYDELIVERALL == 'Yes'){
            $template = $this->getDeliverAllTheme();
        }
        $this->sys_template = $template;
        $this->sys_templatePath = "templates/" . $template . "/";
        $this->sys_logogpath = 'assets/img/apptype/' . $template . '/';
        SystemInfo::redefineVariables(get_defined_vars());
    }
    private function getDeliverAllTheme(){
        global $tconfig;
        $tab = "true";
        $template = '';
        $eDeliverallTheme = self::isDeliverallXThemeActive();
        $eDeliverallThemev2 = self::isDeliverallXv2ThemeActive();
        $eProDeliverallTheme = self::isProDeliverallThemeActive();
        $serviceCategories_data = json_decode(ServiceData);
        if(!empty($serviceCategories_data)){
            if(scount($serviceCategories_data)> 1){
                $template = "Deliverall/deliverall";
                if(strtoupper($eDeliverallTheme)== 'YES'){
                    $template = "DeliverallX/deliverall";
                }
                if(strtoupper($eDeliverallThemev2)== 'YES'){
                    $template = "DeliverallXv2/deliverall";
                }
                if(strtoupper($eProDeliverallTheme)== 'YES'){
                    $template = "ProDAX/deliverall";
                }
            }
            else {
                $vService = $serviceCategories_data[0]->vService;
                $template = "Deliverall/" . $vService;
                if(strtoupper($eDeliverallTheme)== 'YES'){
                    $template = "DeliverallX/" . $vService;
                }
                if(strtoupper($eDeliverallThemev2)== 'YES'){
                    $template = "DeliverallXv2/" . $vService;
                }
                if(strtoupper($eProDeliverallTheme)== 'YES'){
                    $template = "ProDAX/" . $vService;
                }
                if(!file_exists($tconfig["tpanel_path"] . "templates/" . $template . "/")){
                    $template = "Deliverall/deliverall";
                    if(strtoupper($eDeliverallTheme)== 'YES'){
                        $template = "DeliverallX/deliverall";
                    }
                    if(strtoupper($eDeliverallThemev2)== 'YES'){
                        $template = "DeliverallXv2/deliverall";
                    }
                    if(strtoupper($eProDeliverallTheme)== 'YES'){
                        $template = "ProDAX/deliverall";
                    }
                }
            }
        }
        SystemInfo::redefineVariables(get_defined_vars());
        return $template;
    }
    public function getTemplate(){
        return $this->sys_template;
    }
    public function getTemplatePath(){
        return $this->sys_templatePath;
    }
    public function getLogoPath(){
        return $this->sys_logogpath;
    }
    public static function isCubeJekXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_CUBEJEK_X_THEME)&& ENABLE_CUBEJEK_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCubeJekXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_CUBEJEK_X_V2_THEME)&& ENABLE_CUBEJEK_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCJXDoctorv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_CJX_X_DOCTOR_V2_THEME)&& ENABLE_CJX_X_DOCTOR_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isXThemeActive(){
        return "Yes";
    }
    public static function isRideCXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride' && !empty(ENABLE_RIDE_CX_THEME)&& ENABLE_RIDE_CX_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliverallXThemeActive(){
        if(ONLYDELIVERALL == 'Yes' && !empty(ENABLE_DELIVERALL_X_THEME)&& ENABLE_DELIVERALL_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliverallXv2ThemeActive(){
        if(ONLYDELIVERALL == 'Yes' && !empty(ENABLE_DELIVERALL_X_V2_THEME)&& ENABLE_DELIVERALL_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isRideDeliveryXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery' && !empty(ENABLE_RIDE_DELIVERY_X_THEME)&& ENABLE_RIDE_DELIVERY_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliveryXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Delivery' && !empty(ENABLE_DELIVERY_X_THEME)&& ENABLE_DELIVERY_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliveryKingThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_DELIVERYKING_THEME)&& ENABLE_DELIVERYKING_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isServiceXThemeActive(){
        global $APP_TYPE;
        if(strtoupper(APP_TYPE)== "UBERX" && !empty(ENABLE_SERVICE_X_THEME)&& ENABLE_SERVICE_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCubexThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(IS_CUBE_X_THEME)&& IS_CUBE_X_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCubeJekXv3ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_CUBEJEK_X_V3_THEME)&& ENABLE_CUBEJEK_X_V3_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCubeJekXv3ProThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_CUBEJEK_X_V3_PRO_THEME)&& ENABLE_CUBEJEK_X_V3_PRO_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isServiceXv2ThemeActive(){
        global $APP_TYPE;
        if(strtoupper(APP_TYPE)== "UBERX" && !empty(ENABLE_SERVICE_X_V2_THEME)&& ENABLE_SERVICE_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isRideCXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride' && !empty(ENABLE_RIDE_CX_V2_THEME)&& ENABLE_RIDE_CX_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isCubeXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(IS_CUBE_X_V2_THEME)&& IS_CUBE_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliveryKingXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_DELIVERYKING_X_V2_THEME)&& ENABLE_DELIVERYKING_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isDeliveryXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Delivery' && !empty(ENABLE_DELIVERY_X_V2_THEME)&& ENABLE_DELIVERY_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isRideDeliveryXv2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery' && !empty(ENABLE_RIDE_DELIVERY_X_V2_THEME)&& ENABLE_RIDE_DELIVERY_X_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isMedicalServicev2ThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_MEDICAL_SERVICE_V2_THEME)&& ENABLE_MEDICAL_SERVICE_V2_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isPXTProThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride' && !empty(ENABLE_PXTPRO_THEME)&& ENABLE_PXTPRO_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isPXRDProThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery' && !empty(ENABLE_PXRDPRO_THEME)&& ENABLE_PXRDPRO_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isPXCProThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PXCPRO_THEME)&& ENABLE_PXCPRO_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProSPThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'UberX' && !empty(ENABLE_PROSP_THEME)&& ENABLE_PROSP_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProDeliverallThemeActive(){
        if(ONLYDELIVERALL == 'Yes' && !empty(ENABLE_PRO_DELIVERALL_THEME)&& ENABLE_PRO_DELIVERALL_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProDeliveryThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Delivery' && !empty(ENABLE_PRO_DELIVERY_THEME)&& ENABLE_PRO_DELIVERY_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProDeliveryKingThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PRO_DELIVERYKING_THEME)&& ENABLE_PRO_DELIVERYKING_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProRideShareThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PRORS_THEME)&& ENABLE_PRORS_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProBuySellRentThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PROBSR_THEME)&& ENABLE_PROBSR_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProFETThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PROFET_THEME)&& ENABLE_PROFET_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProMSThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PROMS_THEME)&& ENABLE_PROMS_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProKXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PRO_KX_THEME)&& ENABLE_PRO_KX_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProPTXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride' && !empty(ENABLE_PROPTX_THEME)&& ENABLE_PROPTX_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProXRDThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery' && !empty(ENABLE_PROXRD_THEME)&& ENABLE_PROXRD_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProBTYAIOThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'UberX' && !empty(ENABLE_PROBTYAIO_THEME)&& ENABLE_PROBTYAIO_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProCubeXGCThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PROCUBEXGC_THEME)&& ENABLE_PROCUBEXGC_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProBSRXThemeActive(){
        global $APP_TYPE;
        if($APP_TYPE == 'Ride-Delivery-UberX' && !empty(ENABLE_PROBSRX_THEME)&& ENABLE_PROBSRX_THEME == "Yes"){
            return "Yes";
        }
        else {
            return "No";
        }
    }
    public static function isProThemeActive(){
        return "Yes";
    }
}
class UploadFile {
    public function __construct(){
        global $tconfig;
        if(!empty($_FILES)){
            foreach($_FILES as $key => $value){
                if(!is_array($_FILES[$key]['name'])){
                    $vfile_name = $_FILES[$key]['name'];
                    $temp_name = $_FILES[$key]['tmp_name'];
                    $tmp = explode(".", $vfile_name);
                    $ext = $tmp[scount($tmp)- 1];
                    if(strtolower($ext)== "heic"){
                        $this->convertImage($temp_name);
                        $vImage1 = "$tmp[0]".".jpg";
                        $_FILES[$key]['name'] = $vImage1;
                        $_FILES[$key]['size'] = filesize($temp_name);
                    }
                    $this->adjustImageOrientation($ext,$temp_name);
                }
                else {
                    $count = scount($_FILES[$key]['name']);
                    for($i = 0;
                    $i <($count);
                    $i++){
                        $vfile_name = $_FILES[$key]['name'][$i];
                        $temp_name = $_FILES[$key]['tmp_name'][$i];
                        $tmp = explode(".", $vfile_name);
                        $ext = $tmp[scount($tmp)- 1];
                        if(strtolower($ext)== "heic"){
                            $this->convertImage($temp_name);
                            $vImage1 = "$tmp[0]".".jpg";
                            $_FILES[$key]['name'][$i] = $vImage1;
                            $_FILES[$key]['size'][$i] = filesize($temp_name);
                        }
                        $this->adjustImageOrientation($ext,$temp_name);
                    }
                }
            }
        }
    }
    public function convertImage($path, $format = "jpg"){
        $uploadedImage = fopen($path, 'a+');
        $img = new Imagick();
        $img->readImageFile($uploadedImage);
        $img->setFormat($format);
        $img->setImageFormat($format);
        file_put_contents($path, $img);
        return true;
    }
    public function UploadImage($photopath, $vphoto, $vphoto_name, $prefix = '', $vaildExt = "gif,jpg,jpeg,bmp,png"){
        global $langage_lbl;
        $msg = "";
        if(!empty($vphoto_name)and is_file($vphoto)){
            $vphoto_name = $this->getRevisedFileName($vphoto_name);
            $tmp = explode(".", $vphoto_name);
            $ext = $tmp[scount($tmp)- 1];
            $vaildExt_arr = explode(",", strtoupper($vaildExt));
            if(in_array(strtoupper($ext), $vaildExt_arr)){
                $vphotofile = $vphoto_name;
                $ftppath1 = $photopath . $vphotofile;
                if(!copy($vphoto, $ftppath1)){
                    $vphotofile = '';
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_UNSUCCESS_MSG'];
                }
                else {
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_SUCCESS_MSG'];
                }
            }
            else {
                $vphotofile = '';
                $msg = $langage_lbl['LBL_FILE_EXT_VALID_ERROR_MSG'] . $vaildExt . "!!!";
            }
        }
        $ret[0] = $vphotofile;
        $ret[1] = $msg;
        return $ret;
    }
    public function getRevisedFileName($FileName){
        $time_val = time();
        $filename_temp = mt_rand(1111111, 9999999);
        $fileextarr = explode(".", basename($FileName));
        $file_ext = strtolower($fileextarr[scount($fileextarr)- 1]);
        $file_name = $time_val.$filename_temp.".".$file_ext;
        return $file_name;
    }
    public function GeneralUploadImage($temp_name, $image_name, $path, $size1, $size2 = "", $size3 = "", $size4 = "", $option = "", $modulename = "", $original = "", $size5 = "", $temp_gallery=""){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        global $tconfig;
        $thumb = new thumbnail;
        $image_name = $this->getRevisedFileName($image_name);
        $imgExt_arr = explode(",", strtoupper($tconfig["tsite_upload_image_file_extensions"]));
        $time_val = time();
        $vImage1 = $temp_name;
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $filename = mt_rand(11111, 99999);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if(in_array(strtoupper($fileextension), $imgExt_arr)){
            ExifCleaning::adjustImageOrientation($temp_name);
        }
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            if($option == 'menu' && $option != ""){
                list($width, $height)= getimagesize($temp_gallery . "/" . $vImage_name1);
                $size3 = $width;
            }
            if($original == "Y" || $original == "y"){
                copy($temp_gallery . "/" . $vImage_name1, $path . $time_val . "_" . $filename . "." . $fileextension);
            }
            if(!empty($size1)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size1);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "1" . "_" . $time_val . "_" . $filename . "." . $fileextension);
            }
            if(!empty($size2)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size2);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "2" . "_" . $time_val . "_" . $filename . "." . $fileextension);
            }
            if(!empty($size3)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size3);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "3" . "_" . $time_val . "_" . $filename . "." . $fileextension);
            }
            if(!empty($size4)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size4);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "4" . "_" . $time_val . "_" . $filename . "." . $fileextension);
            }
            if(!empty($size5)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size5);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "5" . "_" . $time_val . "_" . $filename . "." . $fileextension);
            }
            @unlink($temp_gallery . "/" . $vImage_name1);
            @unlink($path . $old_image1);
            @unlink($path . "1_" . $old_image1);
            @unlink($path . "2_" . $old_image1);
            @unlink($path . "3_" . $old_image1);
            @unlink($path . "4_" . $old_image1);
            @unlink($path . "5_" . $old_image1);
            $vImage1 = $time_val . "_" . $filename . "." . $fileextension;
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function GeneralUploadImageService($temp_name, $image_name, $path, $size1, $size2 = "", $size3 = "", $size4 = "", $option = "", $modulename = "", $original = "", $size5 = "", $temp_gallery=""){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        $thumb = new thumbnail;
        $vImage1 = $temp_name;
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            if($option == 'menu' && $option != ""){
                list($width, $height)= getimagesize($temp_gallery . "/" . $vImage_name1);
                $size3 = $width;
            }
            if($original == "Y" || $original == "y"){
                copy($temp_gallery . "/" . $vImage_name1, $path . "org_" . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            if(!empty($size1)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size1);
                $thumb->jpeg_quality(100);
                $thumb->save($path . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            if(!empty($size2)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size2);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "2_" . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            if(!empty($size3)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size3);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "3_" . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            if(!empty($size4)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size4);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "4_" . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            if(!empty($size5)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size5);
                $thumb->jpeg_quality(100);
                $thumb->save($path . "5_" . $filename . "_" . date("YmdHis"). "." . $fileextension);
            }
            @unlink($temp_gallery . "/" . $vImage_name1);
            @unlink($path . $old_image1);
            @unlink($path . "1_" . $old_image1);
            @unlink($path . "2_" . $old_image1);
            @unlink($path . "3_" . $old_image1);
            @unlink($path . "4_" . $old_image1);
            @unlink($path . "5_" . $old_image1);
            $vImage1 = $filename . "_" . date("YmdHis"). "." . $fileextension;
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function GeneralFileUpload($filepath, $vfile, $vfile_name, $prefix = '', $vaildExt = "mp3,wav"){
        global $langage_lbl,$tconfig;
        $vfile_name = $this->getRevisedFileName($vfile_name);
        $imgExt_arr = explode(",", strtoupper($tconfig["tsite_upload_image_file_extensions"]));
        $msg = "";
        if(!empty($vfile_name)and is_file($vfile)){
            $vfile_name = replace_content($vfile_name);
            $tmp = explode(".", $vfile_name);
            for($i = 0;
            $i < scount($tmp)- 1;
            $i++){
                $tmp1[] = $tmp[$i];
            }
            $file = implode("_", $tmp1);
            $ext = $tmp[scount($tmp)- 1];
            $vaildExt_arr = explode(",", strtoupper($vaildExt));
            $vaildExt_arr = array_map('trim', $vaildExt_arr);
            if(in_array(strtoupper($ext), $vaildExt_arr)){
                if(in_array(strtoupper($ext), $imgExt_arr)){
                    ExifCleaning::adjustImageOrientation($vfile);
                }
                $random = substr(rand(),0,3);
                $vfilefile = date("YmdHis").$random.".".$ext;
                $vfilefile1 = date("YmdHis").$random;
                $ftppath1 = $filepath . $vfilefile;
                if(!copy($vfile, $ftppath1)){
                    $vfilefile = '';
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_UNSUCCESS_MSG'];
                    $errorflag = "1";
                }
                else {
                    @chmod($vfile, 0777);
                    @chmod($ftppath1 . "/" . $vfile, 0777);
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_SUCCESS_MSG'];
                    $errorflag = "0";
                }
            }
            else {
                $vfilefile = '';
                $msg = $langage_lbl['LBL_FILE_EXT_VALID_ERROR_MSG'] . $vaildExt . "!!!";
                $errorflag = "1";
            }
        }
        $ret[0] = $vfilefile;
        $ret[1] = $msg;
        $ret[2] = $errorflag;
        return $ret;
    }
    public function GeneralFileUploadHome($filepath, $vfile, $vfile_name, $prefix = '', $vaildExt = "mp3,wav", $vCode = "EN"){
        global $langage_lbl;
        $msg = "";
        if(!empty($vfile_name)and is_file($vfile)){
            $vfile_name = $this->getRevisedFileName($vfile_name);
            $tmp = explode(".", $vfile_name);
            for($i = 0;
            $i < scount($tmp)- 1;
            $i++){
                $tmp1[] = $tmp[$i];
            }
            $file = implode("_", $tmp1);
            $ext = $tmp[scount($tmp)- 1];
            $vaildExt_arr = explode(",", strtoupper($vaildExt));
            if(in_array(strtoupper($ext), $vaildExt_arr)){
                $random = substr(rand(),0,3);
                $vfilefile = date("YmdHis"). $random . "_" . $vCode . "." . $ext;
                $ftppath1 = $filepath . $vfilefile;
                if(!copy($vfile, $ftppath1)){
                    $vfilefile = '';
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_UNSUCCESS_MSG'];
                    $errorflag = "1";
                }
                else {
                    @chmod($vfile, 0777);
                    @chmod($ftppath1 . "/" . $vfile, 0777);
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_SUCCESS_MSG'];
                    $errorflag = "0";
                }
            }
            else {
                $vfilefile = '';
                $msg = $langage_lbl['LBL_FILE_EXT_VALID_ERROR_MSG'] . $vaildExt . "!!!";
                $errorflag = "1";
            }
        }
        $ret[0] = $vfilefile;
        $ret[1] = $msg;
        $ret[2] = $errorflag;
        return $ret;
    }
    public function img_data_upload($temp_gallery, $vImage_name1, $path, $size1, $size2, $size3, $size4){
        global $thumb;
        $vImage_name1 = replace_content($vImage_name1);
        $filename = $vImage_name1;
        $time_val = time();
        $img_arr = explode(".", $vImage_name1);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if(!empty($size1)){
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto((int)$size1);
            $thumb->jpeg_quality(100);
            $thumb->save($path . "1" . "_" . $filename);
        }
        if(!empty($size2)){
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto((int)$size2);
            $thumb->jpeg_quality(100);
            $thumb->save($path . "2" . "_" . $filename);
        }
        if(!empty($size3)){
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto((int)$size3);
            $thumb->jpeg_quality(100);
            $thumb->save($path . "3" . "_" . $filename);
        }
        if(!empty($size4)){
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto((int)$size4);
            $thumb->jpeg_quality(100);
            $thumb->save($path . "4" . "_" . $filename);
        }
        $vImage1 = $filename;
        return $vImage1;
    }
    public function uploadImagesOrFiles($temp_name, $image_name, $path, $size1, $size2 = "", $size3 = "", $size4 = "", $option = "", $modulename = "", $original = "", $size5 = "", $temp_gallery="", $vehicle_type="", $hover=""){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        global $currrent_upload_time;
        if($currrent_upload_time != ''){
            $time_val = $currrent_upload_time;
        }
        else {
            $time_val = time();
        }
        $time_val = $time_val . "_" . mt_rand(11111, 99999);
        $thumb = new thumbnail;
        $vImage1 = $temp_name;
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $filename = mt_rand(11111, 99999);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            if($option == 'menu' && $option != ""){
                list($width, $height)= getimagesize($temp_gallery . "/" . $vImage_name1);
                $size3 = $width;
            }
            if($original == "Y" || $original == "y"){
                copy($temp_gallery . "/" . $vImage_name1, $path . $time_val . "." . $fileextension);
            }
            if(!empty($size1)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size1);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "mdpi" . "_" . $hover . $time_val . "." . $fileextension, $path . $time_val . "." . $fileextension, $size1, "360");
            }
            if(!empty($size2)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size2);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "hdpi" . "_" . $hover . $time_val . "." . $fileextension, $path . $time_val . "." . $fileextension, $size2, "360");
            }
            if(!empty($size3)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size3);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xhdpi" . "_" . $hover . $time_val . "." . $fileextension, $path . $time_val . "." . $fileextension, $size3, "360");
            }
            if(!empty($size4)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size4);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xxhdpi" . "_" . $hover . $time_val . "." . $fileextension, $path . $time_val . "." . $fileextension, $size4, "360");
            }
            if(!empty($size5)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size5);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xxxhdpi" . "_" . $hover . $time_val . "." . $fileextension, $path . $time_val . "." . $fileextension, $size5, "360");
            }
            $vImage1 = $time_val . "." . $fileextension;
            @unlink($temp_gallery . "/" . $vImage_name1);
            @unlink($path . $old_image1);
            @unlink($path . "1_" . $old_image1);
            @unlink($path . "2_" . $old_image1);
            @unlink($path . "3_" . $old_image1);
            @unlink($path . "4_" . $old_image1);
            @unlink($path . "5_" . $old_image1);
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function GeneralImageUploadVehicleCategoryAndroid($temp_name, $image_name, $path, $size1, $size2 = "", $size3 = "", $size4 = "", $option = "", $modulename = "", $original = "", $size5 = "", $temp_gallery="", $vehicle_type="", $hover=""){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        global $currrent_upload_time;
        if($currrent_upload_time != ''){
            $time_val = $currrent_upload_time;
        }
        else {
            $time_val = time();
        }
        $thumb = new thumbnail;
        $vImage1 = $temp_name;
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $filename = mt_rand(11111, 99999);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            if($option == 'menu' && $option != ""){
                list($width, $height)= getimagesize($temp_gallery . "/" . $vImage_name1);
                $size3 = $width;
            }
            if($original == "Y" || $original == "y"){
                copy($temp_gallery . "/" . $vImage_name1, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension);
            }
            if(!empty($size1)){
                $thumb->createthumbnail($temp_gallery . $vImage_name1);
                $thumb->size_auto($size1);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "mdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size1, "360");
            }
            if(!empty($size2)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size2);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "hdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size2, "360");
            }
            if(!empty($size3)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size3);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xhdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size3, "360");
            }
            if(!empty($size4)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size4);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xxhdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size4, "360");
            }
            if(!empty($size5)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size5);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "xxxhdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size5, "360");
            }
            $vImage1 = $time_val . "_" . $filename . "." . $fileextension;
            @unlink($temp_gallery . "/" . $vImage_name1);
            @unlink($path . $old_image1);
            @unlink($path . "1_" . $old_image1);
            @unlink($path . "2_" . $old_image1);
            @unlink($path . "3_" . $old_image1);
            @unlink($path . "4_" . $old_image1);
            @unlink($path . "5_" . $old_image1);
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function GeneralImageUploadVehicleCategoryIOS($temp_name, $image_name, $path, $size1, $size2 = "", $size3 = "", $size4 = "", $option = "", $modulename = "", $original = "", $size5 = "", $temp_gallery="", $vehicle_type="", $hover=""){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        $thumb = new thumbnail;
        global $currrent_upload_time;
        if($currrent_upload_time != ''){
            $time_val = $currrent_upload_time;
        }
        else {
            $time_val = time();
        }
        $vImage1 = $temp_name;
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $filename = mt_rand(11111, 99999);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            if($option == 'menu' && $option != ""){
                list($width, $height)= getimagesize($temp_gallery . "/" . $vImage_name1);
                $size3 = $width;
            }
            if($original == "Y" || $original == "y"){
                copy($temp_gallery . "/" . $vImage_name1, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension);
            }
            if(!empty($size1)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size1);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "mdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size1, "360");
            }
            if(!empty($size2)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size2);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "hdpi" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size2, "360");
            }
            if(!empty($size3)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size3);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "1x" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size3, "360");
            }
            if(!empty($size4)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size4);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "2x" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size4, "360");
            }
            if(!empty($size5)){
                $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
                $thumb->size_auto($size5);
                $thumb->jpeg_quality(100);
                $thumb->save_pngs($path . "3x" . "_" . $hover . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $path . "ic_car_" . $vehicle_type . "_" . $time_val . "." . $fileextension, $size5, "360");
            }
            $vImage1 = $time_val . "_" . $filename . "." . $fileextension;
            @unlink($temp_gallery . "/" . $vImage_name1);
            @unlink($path . $old_image1);
            @unlink($path . "1_" . $old_image1);
            @unlink($path . "2_" . $old_image1);
            @unlink($path . "3_" . $old_image1);
            @unlink($path . "4_" . $old_image1);
            @unlink($path . "5_" . $old_image1);
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function GeneralImageUploadVehicleType($vehicleid, $image_name, $temp_name, $old_image_name){
        include_once TPATH_CLASS . 'Imagecrop.class.php';
        $thumb = new thumbnail;
        global $currrent_upload_time, $tconfig;
        if($currrent_upload_time != ''){
            $time_val = $currrent_upload_time;
        }
        else {
            $time_val = time();
        }
        $vImage1 = $temp_name;
        $img_path = $tconfig["tsite_upload_images_vehicle_type_path"];
        $temp_gallery = $img_path . '/' . $vehicleid;
        if($vehicleid != ""){
            $check_file['vLogo'] = $old_image_name;
            $android_path = $img_path . '/' . $vehicleid . '/android';
            $ios_path = $img_path . '/' . $vehicleid . '/ios';
            if($check_file['vLogo'] != '' && file_exists($check_file['vLogo'])){
                @unlink($android_path . '/' . $old_image_name);
                @unlink($android_path . '/mdpi_' . $old_image_name);
                @unlink($android_path . '/hdpi_' . $old_image_name);
                @unlink($android_path . '/xhdpi_' . $old_image_name);
                @unlink($android_path . '/xxhdpi_' . $old_image_name);
                @unlink($android_path . '/xxxhdpi_' . $old_image_name);
                @unlink($ios_path . '/' . $old_image_name);
                @unlink($ios_path . '/1x_' . $old_image_name);
                @unlink($ios_path . '/2x_' . $old_image_name);
                @unlink($ios_path . '/3x_' . $old_image_name);
            }
        }
        $Photo_Gallery_folder = $img_path . '/' . $vehicleid . '/';
        $Photo_Gallery_folder_android = $Photo_Gallery_folder . 'android/';
        $Photo_Gallery_folder_ios = $Photo_Gallery_folder . 'ios/';
        if(!is_dir($Photo_Gallery_folder)){
            mkdir($Photo_Gallery_folder, 0777);
            mkdir($Photo_Gallery_folder_android, 0777);
            mkdir($Photo_Gallery_folder_ios, 0777);
        }
        $vImage_name1 = str_replace(" ", "_", trim($image_name));
        $img_arr = explode(".", $vImage_name1);
        if($modulename == ''){
            $filename = $img_arr[0];
        }
        else {
            $filename = $modulename;
        }
        $filename = mt_rand(11111, 99999);
        $fileextension = strtolower($img_arr[scount($img_arr)- 1]);
        if($vImage1 != ""){
            copy($vImage1, $temp_gallery . "/" . $vImage_name1);
            copy($temp_gallery . "/" . $vImage_name1, $Photo_Gallery_folder_android . $time_val . "." . $fileextension);
            copy($temp_gallery . "/" . $vImage_name1, $Photo_Gallery_folder_ios . $time_val . "." . $fileextension);
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size1_android"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_android . "mdpi" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_android . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size1_android"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size2_android"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_android . "hdpi" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_android . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size2_android"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size3_both"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_android . "xhdpi" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_android . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size3_both"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size4_android"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_android . "xxhdpi" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_android . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size4_android"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size5_both"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_android . "xxxhdpi" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_android . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size5_both"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size3_both"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_ios . "1x" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_ios . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size3_both"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size5_both"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_ios . "2x" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_ios . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size5_both"], "360");
            $thumb->createthumbnail($temp_gallery . "/" . $vImage_name1);
            $thumb->size_auto($tconfig["tsite_upload_images_vehicle_type_size5_ios"]);
            $thumb->jpeg_quality(100);
            $thumb->save_pngs($Photo_Gallery_folder_ios . "3x" . "_" . $time_val . "." . $fileextension, $Photo_Gallery_folder_ios . $time_val . "." . $fileextension, $tconfig["tsite_upload_images_vehicle_type_size5_ios"], "360");
            @unlink($temp_gallery . "/" . $vImage_name1);
            $vImage1 = $time_val . "_" . $filename . "." . $fileextension;
            return $vImage1;
        }
        else {
            return $old_image1;
        }
    }
    public function UploadFileHome($filepath, $vfile, $vfile_name, $prefix = '', $vaildExt = "mp3,wav", $vCode = "EN"){
        global $currrent_upload_time, $langage_lbl;
        $msg = "";
        if($currrent_upload_time != ''){
            $time_val = $currrent_upload_time;
        }
        else {
            $time_val = time();
        }
        if(!empty($vfile_name)and is_file($vfile)){
            $vfile_name = replace_content($vfile_name);
            $tmp = explode(".", $vfile_name);
            for($i = 0;
            $i < scount($tmp)- 1;
            $i++){
                $tmp1[] = $tmp[$i];
            }
            $file = implode("_", $tmp1);
            $ext = $tmp[scount($tmp)- 1];
            $vaildExt_arr = explode(",", strtoupper($vaildExt));
            if(in_array(strtoupper($ext), $vaildExt_arr)){
                $vfilefile = $file . $time_val . "." . $ext;
                $ftppath1 = $filepath . $vfilefile;
                if(!copy($vfile, $ftppath1)){
                    $vfilefile = '';
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_UNSUCCESS_MSG'];
                    $errorflag = "1";
                }
                else {
                    $msg = $langage_lbl['LBL_FILE_UPLOADED_SUCCESS_MSG'];
                    $errorflag = "0";
                }
            }
            else {
                $vfilefile = '';
                $msg = $langage_lbl['LBL_FILE_EXT_VALID_ERROR_MSG'] . $vaildExt . "!!!";
                $errorflag = "1";
            }
        }
        $ret[0] = $vfilefile;
        $ret[1] = $msg;
        $ret[2] = $errorflag;
        return $ret;
    }
    public function GetFileExtension($file_name){
        $filecheck = basename($file_name);
        $fileextarr = explode(".", $filecheck);
        $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
        if($ext != "jpg" && $ext != "gif" && $ext != "png" && $ext != "jpeg" && $ext != "bmp"){
            $check_ext = 'is_file';
        }
        else {
            $check_ext = 'is_image';
        }
        return $check_ext;
    }
    private function adjustImageOrientation($ext, $temp_name){
        global $tconfig;
        if(!class_exists('ExifCleaning')){
            require_once($tconfig['tpanel_path'] . 'assets/libraries/class.ExifCleaning.php');
        }
        $imgExt_arr = explode(",",strtoupper($tconfig["tsite_upload_image_file_extensions"]));
        if(in_array(strtoupper($ext),$imgExt_arr)){
            ExifCleaning::adjustImageOrientation($temp_name);
        }
    }
}
class Wallet {
    public function __construct(){
    }
    public function PerformWalletTransaction($iUserId, $eUserType, $iBalance, $eType, $iTripId, $eFor, $tDescription, $ePaymentStatus, $dDate,$iOrderId=0,$iTmpRentItemPostId=0,$iBookingId=0){
        global $obj,$Data_ALL_currency_Arr,$currencyAssociateArr,$vSystemDefaultCurrencySymbol,$vSystemDefaultCurrencyRatio, $COMM_MEDIA_OBJ;
        $sql = "INSERT INTO `user_wallet`(`iUserId`,`eUserType`,`iBalance`,`eType`,`iTripId`, `eFor`, `tDescription`, `ePaymentStatus`, `dDate`,`iOrderId`,`iTmpRentItemPostId` , `iBookingId`)VALUES('" . $iUserId . "','" . $eUserType . "', '" . $iBalance . "','" . $eType . "', '" . $iTripId . "', '" . $eFor . "', '" . $tDescription . "', '" . $ePaymentStatus . "', '" . $dDate . "','".$iOrderId."','".$iTmpRentItemPostId."' ,'".$iBookingId."')";
        $result = $obj->MySQLInsert($sql);
        $db_curr = array();
        for($g=0;
        $g<scount($Data_ALL_currency_Arr);
        $g++){
            if(strtoupper($Data_ALL_currency_Arr[$g]['eStatus'])== "ACTIVE"){
                $db_curr[] = $Data_ALL_currency_Arr[$g];
            }
        }
        $where = " iUserWalletId = '" . $result . "'";
        $data_currency_ratio = array();
        for($i = 0;
        $i < scount($db_curr);
        $i++){
            $data_currency_ratio['fRatio_' . $db_curr[$i]['vName']] = $db_curr[$i]['Ratio'];
        }
        $obj->MySQLQueryPerform("user_wallet", $data_currency_ratio, 'update', $where);
        if($eUserType == 'Rider'){
            $fieldname = 'iUserId';
            $tablename = 'register_user as ru';
            $tablename_alt = "register_user";
            $getfields = 'ru.vCurrencyPassenger as currency, cu.ratio, cu.vSymbol, cu.vName, ru.vEmail, CONCAT(ru.vName, " ", ru.vLastName)AS username';
            $currencyField = 'vCurrencyPassenger as vCurrency,iUserId as iMemberId, CONCAT(ru.vName, " ", ru.vLastName)AS username';
            $currencyFieldName = "vCurrencyPassenger";
            $onfields = "ON ru.vCurrencyPassenger = cu.vName";
        }
        else {
            $fieldname = 'iDriverId';
            $tablename = 'register_driver as rd';
            $tablename_alt = "register_driver";
            $getfields = 'rd.vCurrencyDriver as currency, cu.ratio, cu.vSymbol, cu.vName, rd.vEmail, CONCAT(rd.vName, " ", rd.vLastName)AS username';
            $currencyField = 'vCurrencyDriver as vCurrency,iDriverId as iMemberId, CONCAT(rd.vName, " ", rd.vLastName)AS username';
            $currencyFieldName = "vCurrencyDriver";
            $onfields = "ON rd.vCurrencyDriver = cu.vName";
        }
        if(isset($userDetailsArr[$tablename_alt.'_'.$iUserId])){
            $getUserData = $userDetailsArr[$tablename_alt.'_'.$iUserId];
        }
        else {
            $getUserData = $obj->MySQLSelect("SELECT *,$currencyField FROM ".$tablename." WHERE $fieldname='".$iUserId."'");
            $userDetailsArr[$tablename_alt.'_'.$iUserId] = $getUserData;
        }
        if(scount($getUserData)> 0){
            $getUserData[0]['vCurrency'] = $getUserData[0][$currencyFieldName];
            $getUserData[0]['username'] = $getUserData[0]['vName']." ".$getUserData[0]['vLastName'];
        }
        $currencySymbol = $currencyRatio = $currencyCode = "";
        if(isset($currencyAssociateArr[$getUserData[0][$currencyFieldName]])){
            $currencySymbol = $currencyAssociateArr[$getUserData[0][$currencyFieldName]]['vSymbol'];
            $currencyRatio = $currencyAssociateArr[$getUserData[0][$currencyFieldName]]['Ratio'];
            $currencyCode = $currencyAssociateArr[$getUserData[0][$currencyFieldName]]['vName'];
        }
        if(($currencySymbol == "" || $currencySymbol == NULL)||($currencyRatio == "" || $currencyRatio == NULL)){
            if(!empty($vSystemDefaultCurrencySymbol)&& !empty($vSystemDefaultCurrencyRatio)){
                $DefaultCurrencyData = array();
                $DefaultCurrencyData[0]['vSymbol'] = $vSystemDefaultCurrencySymbol;
                $DefaultCurrencyData[0]['ratio'] = $vSystemDefaultCurrencyRatio;
            }
            else {
                $DefaultCurrencyData = get_value('currency', 'vSymbol,ratio,vName', 'eDefault', 'Yes');
            }
            $currencySymbol = $DefaultCurrencyData[0]['vSymbol'];
            $currencyRatio = $DefaultCurrencyData[0]['ratio'];
            $currencyCode = $DefaultCurrencyData[0]['vName'];
        }
        $fAmount = $iBalance * $currencyRatio;
        $fAmount = number_format($fAmount, 2);
        $maildata['username'] = $getUserData[0]['username'];
        $maildata['EMAIL_NAME'] = $getUserData[0]['username'];
        $maildata['vEmail'] = $getUserData[0]['vEmail'];
        $maildata['amount'] = formateNumAsPerCurrency($fAmount,$currencyCode);
        if($eFor != 'Referrer'){
            if($eType == 'Credit'){
                $status = $COMM_MEDIA_OBJ->SendMailToMember("WALLET_MONEY_CREDITED", $maildata);
            }
            else if($eType == 'Debit'){
                $status = $COMM_MEDIA_OBJ->SendMailToMember("WALLET_MONEY_DEBITED", $maildata);
            }
        }
        else {
            if(isset($tripDetailsArr['trips_'.$iTripId])){
                $db_result = $tripDetailsArr['trips_'.$iTripId];
            }
            else {
                $db_result = $obj->MySQLSelect("SELECT * from trips where iTripId=" . $iTripId);
                $tripDetailsArr['trips_'.$iTripId] = $db_result;
            }
            if($eUserType == 'Rider'){
                if(isset($userDetailsArr['register_user_'.$db_result[0]['iUserId']])){
                    $db_rider_user = $userDetailsArr['register_user_'.$db_result[0]['iUserId']];
                    if(scount($db_rider_user)> 0){
                        $db_rider_user[0]['currency'] = $db_rider_user[0]['vCurrencyPassenger'];
                        $db_rider_user[0]['tripusername'] = $db_rider_user[0]['vName']." ".$db_rider_user[0]['vLastName'];
                    }
                }
                else {
                    $db_rider_user = $obj->MySQLSelect("SELECT vCurrencyPassenger AS currency,iUserId,iRefUserId ,eRefType, CONCAT(vName,' ',vLastName)as tripusername from register_user where iUserId=" . $db_result[0]['iUserId']);
                }
                $tripusername = $db_rider_user[0]['tripusername'];
            }
            else {
                if(isset($userDetailsArr['register_driver_'.$db_result[0]['iDriverId']])){
                    $db_driver_user = $userDetailsArr['register_driver_'.$db_result[0]['iDriverId']];
                    if(scount($db_driver_user)> 0){
                        $db_driver_user[0]['currency'] = $db_driver_user[0]['vCurrencyDriver'];
                        $db_driver_user[0]['tripusername'] = $db_driver_user[0]['vName']." ".$db_driver_user[0]['vLastName'];
                    }
                }
                else {
                    $db_driver_user = $obj->MySQLSelect("SELECT iRefUserId,iDriverId,eRefType, CONCAT(vName,' ',vLastName)as tripusername,vCurrencyDriver As currency from register_driver where iDriverId=" . $db_result[0]['iDriverId']);
                }
                $tripusername = $db_driver_user[0]['tripusername'];
            }
            $maildata['tripusername'] = $tripusername;
            $Data_Referrer_Email['tMailInfo'] = json_encode($maildata);
            $Data_Referrer_Email['dDate'] = Date('Y-m-d H:i:s');
            $obj->MySQLQueryPerform("wallet_money_referrer_email", $Data_Referrer_Email, 'insert');
        }
        return $result;
    }
    public function FetchMemberWalletBalance($sess_iMemberId, $type, $IS_DEDUCT_ACTIVE_TRIP_AMOUNT = false){
        global $obj, $SYSTEM_PAYMENT_FLOW, $ePayWallet, $MODULES_OBJ;
        $getUserWallet = $obj->MySQLSelect("SELECT eType,SUM(iBalance)as totBalance FROM user_wallet WHERE iUserId = '" . $sess_iMemberId . "' AND eUserType = '" . $type . "' GROUP BY eType");
        $debitBalance = $creditBalance = 0;
        if(scount($getUserWallet)> 0){
            for($d = 0;
            $d < scount($getUserWallet);
            $d++){
                $eType = $getUserWallet[$d]['eType'];
                $totBalance = $getUserWallet[$d]['totBalance'];
                if($eType == "Credit"){
                    $creditBalance += $totBalance;
                }
                else if($eType == "Debit"){
                    $debitBalance += $totBalance;
                }
            }
        }
        $balance = $creditBalance - $debitBalance;
        if($IS_DEDUCT_ACTIVE_TRIP_AMOUNT == true && $type == "Rider" && strtoupper($ePayWallet)== "YES"){
            $sql_auth_chk = "SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM trips as tr WHERE tr.iActive != 'Canceled' AND tr.iActive != 'Finished' AND tr.tUserWalletBalance != '' AND tr.vTripPaymentMode = 'Wallet' AND tr.iUserId = '" . $sess_iMemberId . "'";
            $data_user_bal_trips = $obj->MySQLSelect($sql_auth_chk);
            $currDateTime = date("Y-m-d H:i:s");
            $sql_auth_riderLater = $obj->MySQLSelect("SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM cab_booking as CB WHERE CB.eStatus NOT IN('Declined','Failed','Cancel','Completed')AND CB.tUserWalletBalance != '' AND CB.iUserId = '" . $sess_iMemberId . "' AND dBooking_date >='" . $currDateTime . "'");
            if(strtoupper(DELIVERALL)== "YES"){
                $sql_auth_orders_chk = "SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM orders as ord WHERE ord.ePaid = 'No' AND ord.iStatusCode IN(1,2,4,5,12)AND ord.ePaymentOption = 'Wallet' AND ord.iUserId = '" . $sess_iMemberId . "'";
                $data_user_bal_orders = $obj->MySQLSelect($sql_auth_orders_chk);
            }
            if($MODULES_OBJ->isEnableRideShareService()){
                $todayDate = date('Y-m-d H:i:s');
                $sql_auth_rideshare_chk = "SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM ride_share_bookings WHERE eStatus = 'Pending' AND ePaymentOption = 'Wallet' AND iUserId = '" . $sess_iMemberId . "' AND dBookingDate > '$todayDate' ";
                $data_user_bal_rideshare = $obj->MySQLSelect($sql_auth_rideshare_chk);
            }
            $tUserWalletBalance = 0;
            $returnArr = array();
            $returnArr['WalletBalance'] = strval($balance);
            $returnArr['AutorizedWalletBalance'] = strval($balance);
            if(!empty($data_user_bal_trips)&& scount($data_user_bal_trips)> 0){
                $returnArr['AutorizedWalletBalance'] -= $data_user_bal_trips[0]['tUserWalletBalance'];
            }
            if(!empty($sql_auth_riderLater)&& scount($sql_auth_riderLater)> 0){
                $returnArr['AutorizedWalletBalance'] -= $sql_auth_riderLater[0]['tUserWalletBalance'];
            }
            if(!empty($data_user_bal_orders)&& scount($data_user_bal_orders)> 0){
                $returnArr['AutorizedWalletBalance'] -= $data_user_bal_orders[0]['tUserWalletBalance'];
            }
            if(!empty($data_user_bal_rideshare)&& scount($data_user_bal_rideshare)> 0){
                $returnArr['AutorizedWalletBalance'] -= $data_user_bal_rideshare[0]['tUserWalletBalance'];
            }
            if($returnArr['AutorizedWalletBalance'] < 0){
                $returnArr['AutorizedWalletBalance'] = 0;
            }
            $returnArr['TotalAuthorizedAmount'] = strval(0);
            $returnArr['CurrentBalance'] = strval($balance);
            if(scount($data_user_bal_trips)> 0 && !empty($data_user_bal_trips)){
                if($data_user_bal_trips[0]['tUserWalletBalance'] < 0){
                    $data_user_bal_trips[0]['tUserWalletBalance'] = 0;
                }
                $tUserWalletBalance += round($data_user_bal_trips[0]['tUserWalletBalance'], 2);
            }
            if(!empty($sql_auth_riderLater)&& scount($sql_auth_riderLater)> 0){
                $tUserWalletBalance += round($sql_auth_riderLater[0]['tUserWalletBalance'], 2);
            }
            if(!empty($data_user_bal_orders)&& scount($data_user_bal_orders)> 0){
                $tUserWalletBalance += round($data_user_bal_orders[0]['tUserWalletBalance'], 2);
            }
            if(!empty($data_user_bal_rideshare)&& scount($data_user_bal_rideshare)> 0){
                $tUserWalletBalance += round($data_user_bal_rideshare[0]['tUserWalletBalance'], 2);
            }
            $balance = $balance - $tUserWalletBalance;
            if($balance < 0){
                $balance = 0;
            }
            $returnArr['TotalAuthorizedAmount'] = strval($tUserWalletBalance);
            $returnArr['CurrentBalance'] = strval($balance);
            return $returnArr;
        }
        return $balance;
    }
    public function FetchMemberCurrencyWalletBalance($sess_iMemberId, $type, $IS_DEDUCT_ACTIVE_TRIP_AMOUNT = false){
        global $obj, $SYSTEM_PAYMENT_FLOW, $ePayWallet;
        if($type == "Rider"){
            $sqld = "SELECT ru.vCurrencyPassenger as vCurrency,cu.vSymbol FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $sess_iMemberId . "'";
        }
        else {
            $sqld = "SELECT rd.vCurrencyDriver as vCurrency,cu.vSymbol FROM register_driver as rd LEFT JOIN currency as cu ON rd.vCurrencyDriver = cu.vName WHERE iDriverId = '" . $sess_iMemberId . "'";
        }
        $db_currency = $obj->MySQLSelect($sqld);
        $vCurrency = $db_currency[0]['vCurrency'];
        $vSymbol = $db_currency[0]['vSymbol'];
        if($vCurrency == "" || $vCurrency == null){
            $sql = "SELECT vName,vSymbol from currency WHERE eDefault = 'Yes'";
            $currencyData = $obj->MySQLSelect($sql);
            $vCurrency = $currencyData[0]['vName'];
            $vSymbol = $currencyData[0]['vSymbol'];
        }
        $getUserWallet = $obj->MySQLSelect("SELECT eType,SUM(iBalance*fRatio_" . $vCurrency . ")as totBalance FROM user_wallet WHERE iUserId = '" . $sess_iMemberId . "' AND eUserType = '" . $type . "' GROUP BY eType");
        $debitBalance = $creditBalance = 0;
        if(scount($getUserWallet)> 0){
            for($d = 0;
            $d < scount($getUserWallet);
            $d++){
                $eType = $getUserWallet[$d]['eType'];
                $totBalance = $getUserWallet[$d]['totBalance'];
                if($eType == "Credit"){
                    $creditBalance += $totBalance;
                }
                else if($eType == "Debit"){
                    $debitBalance += $totBalance;
                }
            }
        }
        $balance = $creditBalance - $debitBalance;
        if($IS_DEDUCT_ACTIVE_TRIP_AMOUNT == true && $type == "Rider" && strtoupper($ePayWallet)== "YES"){
            $sql_auth_chk = "SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM trips as tr WHERE tr.iActive != 'Canceled' AND tr.iActive != 'Finished' AND tr.tUserWalletBalance != '' AND tr.vTripPaymentMode = 'Wallet' AND tr.iUserId = '" . $sess_iMemberId . "'";
            $data_user_bal_trips = $obj->MySQLSelect($sql_auth_chk);
            $currDateTime = date("Y-m-d H:i:s");
            $sql_auth_riderLater = $obj->MySQLSelect("SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM cab_booking as CB WHERE CB.eStatus NOT IN('Declined','Failed','Cancel','Completed')AND CB.tUserWalletBalance != '' AND CB.iUserId = '" . $sess_iMemberId . "' AND dBooking_date >='" . $currDateTime . "'");
            if(strtoupper(DELIVERALL)== "YES"){
                $sql_auth_orders_chk = "SELECT SUM(tUserWalletBalance)as tUserWalletBalance FROM orders as ord WHERE ord.ePaid = 'No' AND ord.iStatusCode IN(1,2,4,5,12)AND ord.ePaymentOption = 'Card' AND ord.iUserId = '" . $sess_iMemberId . "'";
                $data_user_bal_orders = $obj->MySQLSelect($sql_auth_orders_chk);
            }
            $tUserWalletBalance = 0;
            $returnArr = array();
            $returnArr['WalletBalance'] = strval($balance);
            $returnArr['AutorizedWalletBalance'] = strval($balance);
            if(!empty($data_user_bal_trips)&& scount($data_user_bal_trips)> 0){
                $returnArr['AutorizedWalletBalance'] -= $data_user_bal_trips[0]['tUserWalletBalance'];
            }
            if(!empty($sql_auth_riderLater)&& scount($sql_auth_riderLater)> 0){
                $returnArr['AutorizedWalletBalance'] -= $sql_auth_riderLater[0]['tUserWalletBalance'];
            }
            if(!empty($data_user_bal_orders)&& scount($data_user_bal_orders)> 0){
                $returnArr['AutorizedWalletBalance'] -= $data_user_bal_orders[0]['tUserWalletBalance'];
            }
            if($returnArr['AutorizedWalletBalance'] < 0){
                $returnArr['AutorizedWalletBalance'] = 0;
            }
            $returnArr['TotalAuthorizedAmount'] = strval(0);
            $returnArr['CurrentBalance'] = strval($balance);
            if(scount($data_user_bal_trips)> 0 && !empty($data_user_bal_trips)){
                if($data_user_bal_trips[0]['tUserWalletBalance'] < 0){
                    $data_user_bal_trips[0]['tUserWalletBalance'] = 0;
                }
                $tUserWalletBalance += round($data_user_bal_trips[0]['tUserWalletBalance'], 2);
            }
            if(!empty($sql_auth_riderLater)&& scount($sql_auth_riderLater)> 0 && !empty($sql_auth_riderLater)){
                $tUserWalletBalance += round($sql_auth_riderLater[0]['tUserWalletBalance'], 2);
            }
            if(!empty($data_user_bal_orders)&& scount($data_user_bal_orders)> 0 && !empty($data_user_bal_orders)){
                $tUserWalletBalance += round($data_user_bal_orders[0]['tUserWalletBalance'], 2);
            }
            $balance = $balance - $tUserWalletBalance;
            if($balance < 0){
                $balance = 0;
            }
            $returnArr['TotalAuthorizedAmount'] = strval($tUserWalletBalance);
            $returnArr['CurrentBalance'] = strval($balance);
            return $returnArr;
        }
        return $balance;
    }
    public function FetchMemberWalletBalanceApp($sess_iMemberId, $type, $Original = 'No', $IS_RETRIVE_DATA_ORIG = 'No'){
        global $obj,$UserCurrencyLanguageDetailsArr,$DriverCurrencyLanguageDetailsArr,$vSystemDefaultCurrencyName,$vSystemDefaultCurrencySymbol,$currencyAssociateArr;
        if($type == "Rider"){
            $tblname = "register_user";
            $fieldName = "iUserId";
            $currencyField = "vCurrencyPassenger";
        }
        else {
            $tblname = "register_driver";
            $fieldName = "iDriverId";
            $currencyField = "vCurrencyDriver";
        }
        if(isset($userDetailsArr[$tblname."_".$sess_iMemberId])){
            $memberData = $userDetailsArr[$tblname."_".$sess_iMemberId];
        }
        else {
            $memberData = $obj->MySQLSelect("SELECT *,$fieldName AS iMemberId FROM ".$tblname." WHERE $fieldName='".$sess_iMemberId."'");
            $userDetailsArr[$tblname."_".$sess_iMemberId] = $memberData;
        }
        $uservSymbol = $memberData[0][$currencyField];
        if(isset($currencyAssociateArr[$uservSymbol])){
            $userCurrencyData = $currencyAssociateArr[$uservSymbol];
            $userCurrencySymbol =$vSymbol= $userCurrencyData['vSymbol'];
            $vCurrency = $userCurrencyData['vName'];
            $Ratio = $userCurrencyData['Ratio'];
        }
        else {
            $userCurrencyData = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='".$uservSymbol."'");
            $vSymbol = $userCurrencyData[0]['vSymbol'];
            $vCurrency = $userCurrencyData[0]['vName'];
            $Ratio = $userCurrencyData[0]['Ratio'];
        }
        if($vCurrency == "" || $vCurrency == null){
            if(!empty($vSystemDefaultCurrencyName)&& !empty($vSystemDefaultCurrencySymbol)&& !empty($vSystemDefaultCurrencyRatio)){
                $vCurrency = $vSystemDefaultCurrencyName;
                $vSymbol = $vSystemDefaultCurrencySymbol;
                $Ratio = $vSystemDefaultCurrencyRatio;
            }
            else {
                $currencyData = $obj->MySQLSelect("SELECT vName,vSymbol,Ratio from currency WHERE eDefault = 'Yes'");
                $vCurrency = $currencyData[0]['vName'];
                $vSymbol = $currencyData[0]['vSymbol'];
                $Ratio = $currencyData[0]['Ratio'];
            }
        }
        $getUserWallet = $obj->MySQLSelect("SELECT * FROM user_wallet WHERE iUserId = '" . $sess_iMemberId . "' AND eUserType = '" . $type . "' ");
        $debitBalance = $creditBalance = 0;
        if(scount($getUserWallet)> 0){
            for($d = 0;
            $d < scount($getUserWallet);
            $d++){
                $eType = $getUserWallet[$d]['eType'];
                if($eType == "Credit"){
                    $totBalance = $getUserWallet[$d]['iBalance']* $getUserWallet[$d]['fRatio_' . $vCurrency];
                    $creditBalance += $totBalance;
                }
                else if($eType == "Debit"){
                    $totBalance = $getUserWallet[$d]['iBalance']* $getUserWallet[$d]['fRatio_' . $vCurrency];
                    $debitBalance += $totBalance;
                }
            }
        }
        $balance = $creditBalance - $debitBalance;
        if(strtoupper($IS_RETRIVE_DATA_ORIG)== "YES"){
            if($balance <= 0){
                if($type == "Rider"){
                    $finalamt = "0.00";
                }
                else {
                    $finalamt = number_format($balance, 2, '.', '');
                }
            }
            else {
                $finalamt = number_format($balance, 2, '.', '');
            }
            $arr_data = array();
            $arr_data['CURRENCY_SYMBOL'] = $vSymbol;
            $arr_data['ORIG_AMOUNT'] = $finalamt;
            $arr_data['DISPLAY_AMOUNT'] = formateNumAsPerCurrency($finalamt,$vCurrency);
            return $arr_data;
        }
        if($Original == 'Yes'){
            if($balance <= 0){
                $finalamt = formateNumAsPerCurrency(0.00,$vCurrency);
            }
            else {
                $finalamt = formateNumAsPerCurrency($balance,$vCurrency);
            }
        }
        else {
            if($balance <= 0){
                $finalamt = formateNumAsPerCurrency(0.00,$vCurrency);
            }
            else {
                $finalamt = formateNumAsPerCurrency($balance,$vCurrency);
            }
        }
        return $finalamt;
    }
    public function MemberCurrencyWalletBalance($currencyratio, $amount, $currencysymbol){
        global $obj,$currencyAssociateArr;
        $parameter = 2;
        if(isset($currencyAssociateArr[$currencysymbol])){
            $userCurrencyData = $currencyAssociateArr[$currencysymbol];
            $db_currency = array();
            $db_currency[0]['vSymbol'] = $userCurrencyData['vSymbol'];
            $db_currency[0]['vName'] = $userCurrencyData['vName'];
            $db_currency[0]['Ratio'] = $userCurrencyData['Ratio'];
        }
        else {
            $db_currency = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='".$currencysymbol."'");
        }
        $db_currency_name = $db_currency[0]['vName'];
        if($currencyratio == '' || $currencyratio == 0){
            $amt = $amount * $db_currency[0]['Ratio'];
        }
        else {
            $amt = $amount * $currencyratio;
        }
        if($amt == 0){
            $finalamt = $db_currency[0]['vSymbol'] . " 0.00";
            return $finalamt;
        }
        else {
            $finalamt = formateNumAsPerCurrency($amt,$db_currency_name);
            return $finalamt;
        }
    }
    public function MemberCurrencyWalletBalanceFront($currencyratio, $amount, $currencysymbol){
        global $obj,$currencyAssociateArr;
        $parameter = 2;
        if(isset($currencyAssociateArr[$currencysymbol])){
            $userCurrencyData = $currencyAssociateArr[$currencysymbol];
            $db_currency = array();
            $db_currency[0]['vSymbol'] = $userCurrencyData['vSymbol'];
            $db_currency[0]['vName'] = $userCurrencyData['vName'];
            $db_currency[0]['Ratio'] = $userCurrencyData['Ratio'];
        }
        else {
            $db_currency = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='".$currencysymbol."'");
        }
        if($currencyratio == '' || $currencyratio == 0){
            $amt = $amount;
        }
        else {
            $amt = $amount * $currencyratio;
        }
        if($amt == 0){
            $finalamt = $db_currency[0]['vSymbol'] . " 0.00";
            return $finalamt;
        }
        else {
            $finalamt = formateNumAsPerCurrency($amt,$currencysymbol);
            return $finalamt;
        }
    }
}
class Bidding {
    public $tablename, $biddingPostTable, $register_user, $register_driver, $user_address, $bidding_driver_request,$bidding_driver_service,$bidding_request_to_driver,$bidding_offer,$bidding_post_media,$other_id;
    function __construct(){
        global $obj;
        $this->tablename = 'bidding_service';
        $this->biddingPostTable = 'bidding_post';
        $this->register_user = 'register_user';
        $this->register_driver = 'register_driver';
        $this->user_address = 'user_address';
        $this->bidding_driver_request = 'bidding_driver_request';
        $this->bidding_driver_service = 'bidding_driver_service';
        $this->bidding_request_to_driver = 'driver_bidding_request';
        $this->bidding_offer = 'bidding_offer';
        $this->bidding_post_media = 'bidding_post_media';
        $bidding = $obj->MySQLSelect("SELECT iBiddingId FROM $this->tablename WHERE 1 = 1 AND eOther = 'Yes'");
        $this->other_id =(!empty($bidding)&& $bidding[0]['iBiddingId'])? $bidding[0]['iBiddingId'] : 0;
    }
    public function getBiddingTotalCount($use, $iParent_Id = 0){
        global $obj;
        $estatus = '';
        if($use == 'admin'){
            $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
        }
        $iParentId = "iParentId = '" . $iParent_Id . "'";
        $result = $obj->MySQLSelect("SELECT count(iBiddingId)as count FROM $this->tablename WHERE 1 = 1 AND " . $iParentId . " $estatus ");
        return $result[0]['count'];
    }
    public function getBiddingMaster($use, $ssql = '', $start = 0, $per_page = 0, $vLanguage = "EN", $ord = '', $reqArr = []){
        global $obj, $MODULES_OBJ;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            $estatus = "AND(estatus = 'Active' || estatus = 'Inactive')";
        }
        if($use == 'webservice'){
            $estatus = "AND estatus = 'Active'";
        }
        if(empty($ord)){
            $ord = " ORDER BY iDisplayOrder";
        }
        $db_fields = "";
        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()|| $MODULES_OBJ->isEnableAppHomeScreenLayoutV4()){
            $db_fields .= ", vImage1";
        }
        $sql = "SELECT eOther,vTitle,iBiddingId,vImage,vTitle,tDescription,iParentId,eStatus,iDisplayOrder,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescription $db_fields FROM " . $this->tablename . " WHERE 1 = 1 " . $estatus . " " . $ssql . " AND iParentId = 0 " . $ord . " " . $limit . "";
        $bidding_master_categories = $obj->MySQLSelect($sql);
        $return_array = array();
        if($use == 'webservice'){
            foreach($bidding_master_categories as $key => $mServiceCategory){
                $return_array[$key] = $this->getBiddingQuery_array($mServiceCategory, $reqArr);
            }
        }
        else {
            $return_array = $bidding_master_categories;
        }
        return $return_array;
    }
    public function getBiddingQuery_array($biddingArray, $reqArr = []){
        global $tconfig, $APP_TYPE, $MODULES_OBJ;
        $return_array['vListLogo'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage'];
        $return_array['tListDescription'] = $biddingArray['tDescription'];
        $return_array['vCategory'] = $biddingArray['vTitle'];
        $return_array['iBiddingId'] = $biddingArray['iBiddingId'];
        $return_array['eCatType'] = 'Bidding';
        $return_array['eCatViewType'] = strtoupper($APP_TYPE)== "UBERX" ? 'Icon' : 'List';
        $return_array['other'] = $biddingArray['eOther'];
        $return_array['iParentId'] = $biddingArray['iParentId'];
        $return_array['vTitle'] = $biddingArray['vTitle'];
        $return_array['vLogo_image'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage'];
        $return_array['vLogo'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage'];
        $return_array['iDisplayOrder'] = $biddingArray['iDisplayOrder'];
        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()&& $biddingArray['iParentId'] == 0){
            $return_array['vListLogo'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage1'];
            $return_array['vLogo_image'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage1'];
            $return_array['vLogo'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage1'];
            $return_array['vImage'] = $tconfig["tsite_upload_images_bidding"] . $biddingArray['vImage1'];
            $return_array['isRoundImage'] = "Yes";
            if($MODULES_OBJ->isEnableAppHomeScreenLayoutV4()){
                $return_array['isRoundImage'] = "No";
            }
        }
        $returnarray = [];
        if(scount($reqArr)> 0){
            foreach($return_array as $key => $a){
                if(in_array($key, $reqArr)){
                    $returnarray[$key] = $a;
                }
            }
            $return_array = $returnarray;
        }
        return $return_array;
    }
    public function getBiddingSubCategory($use, $iParent_Id, $ssql = '', $start = 0, $per_page = 0, $vLanguage = 'EN', $ord = '', $reqArr = []){
        global $obj, $MODULES_OBJ;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
        }
        if($use == 'webservice'){
            $estatus = 'AND estatus = "Active"';
        }
        $iParentId = "iParentId IN(" . $iParent_Id . ")";
        $db_fields = "";
        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()|| $MODULES_OBJ->isEnableAppHomeScreenLayoutV4()){
            $db_fields .= ", vImage1";
        }
        $sql = "SELECT eOther,iBiddingId,vImage,vTitle,tDescription,iParentId,eStatus,iDisplayOrder,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescription $db_fields FROM $this->tablename WHERE 1 = 1 $estatus $ssql AND " . $iParentId . " $ord " . $limit . "";
        $bidding_master_subcategories = $obj->MySQLSelect($sql);
        $return_array = array();
        if($use == 'webservice'){
            foreach($bidding_master_subcategories as $key => $mServiceSubCategory){
                $return_array[$key] = $this->getBiddingQuery_array($mServiceSubCategory, $reqArr);
            }
        }
        else {
            $return_array = $bidding_master_subcategories;
        }
        return $return_array;
    }
    public function createOtherSubcategory($use, $biddingPost, $vLanguage = "EN"){
        global $obj;
        $db_master = $obj->MySQLSelect("SELECT * FROM `language_master` ORDER BY `iDispOrder`");
        for($i = 0;
        $i < scount($db_master);
        $i++){
            if($db_master[$i]['vCode'] == $vLanguage || $db_master[$i]['vCode'] == 'EN'){
                $vCategoryNameArr["vTitle_" . $db_master[$i]['vCode']] = $biddingPost['vServiceName'];
                $tDescriptionArr["tDescription_" . $db_master[$i]['vCode']] = $biddingPost['tDescription'];
            }
            else {
                $vCategoryNameArr["vTitle_" . $db_master[$i]['vCode']] = '';
                $tDescriptionArr["tDescription_" . $db_master[$i]['vCode']] = '';
            }
        }
        $jsonDescription = getJsonFromAnArr($tDescriptionArr);
        $jsonCategoryName = getJsonFromAnArr($vCategoryNameArr);
        $query_p['iParentId'] = $this->other_id;
        $query_p['vTitle'] = $jsonCategoryName;
        $query_p['eStatus'] = 'Active';
        $query_p['iDisplayOrder'] = 1;
        $query_p['vImage'] = '';
        return $obj->MySQLQueryPerform($this->tablename, $query_p, 'insert');
    }
    public function createBiddingPost($use, $biddingPost, $vLanguage = "EN"){
        global $obj;
        return $obj->MySQLQueryPerform($this->biddingPostTable, $biddingPost, 'insert');
    }
    public function updateBiddingPost($use, $biddingPost, $where, $vLanguage = "EN"){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->biddingPostTable, $biddingPost, 'update', $where);
        if($biddingPost['eStatus'] == "Accepted"){
            $obj->sql_query("UPDATE " . $this->bidding_request_to_driver . " SET eStatus = 'Accepted' WHERE iBiddingPostId = '" . $biddingPost['iBiddingPostId'] . "' AND iDriverId = '" . $biddingPost['iDriverId'] . "'");
            $obj->sql_query("UPDATE bidding_offer as bo,(SELECT IOfferId FROM bidding_offer WHERE iBiddingPostId = '" . $biddingPost['iBiddingPostId'] . "' ORDER BY IOfferId DESC LIMIT 1)as bo1 SET bo.eStatus = 'Accepted' WHERE bo.IOfferId = bo1.IOfferId");
        }
        elseif($biddingPost['eStatus'] == "Cancelled"){
            $this->sendCancelNotification($biddingPost['iBiddingPostId']);
        }
        return $id;
    }
    private function sendCancelNotification($iBiddingPostId){
        global $obj, $LANG_OBJ, $EVENT_MSG_OBJ;
        $all_providers = $obj->MySQLSelect("SELECT rd.eDeviceType, rd.iGcmRegId, rd.eAppTerminate, rd.eDebugMode, rd.eHmsDevice, dbr.iDriverId, rd.vLang, bp.vBiddingPostNo FROM $this->bidding_request_to_driver as dbr LEFT JOIN $this->register_driver as rd ON rd.iDriverId = dbr.iDriverId LEFT JOIN $this->biddingPostTable as bp ON bp.iBiddingPostId = dbr.iBiddingPostId WHERE dbr.iBiddingPostId = '$iBiddingPostId' AND dbr.eStatus != 'Decline'");
        $notifiactondata = $final_message = array();
        $final_message['Message'] = "BiddingTaskCancelled";
        $final_message['MsgType'] = "BiddingTaskCancelled";
        $final_message['iBiddingPostId'] = $iBiddingPostId;
        $final_message['time'] = time();
        $final_message['eType'] = "Bidding";
        foreach($all_providers as $provider){
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($provider['vLang'], "1", "");
            $alertMsg_db = str_replace("#TASK_NO#", $provider['vBiddingPostNo'], $languageLabelsArr['LBL_BIDDING_TASK_CANCELLED_MSG']);
            $final_message['vTitle'] = $alertMsg_db;
            $notifiactondata[] = array('eDeviceType' => $provider['eDeviceType'], 'deviceToken' => $provider['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $provider['eAppTerminate'], 'eDebugMode' => $provider['eDebugMode'], 'eHmsDevice' => $provider['eHmsDevice'], 'message' => $final_message, 'channelName' => "CAB_REQUEST_DRIVER_" . $provider['iDriverId']);
        }
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $notifiactondata), RN_PROVIDER);
    }
    public function biddingdriverrequest($use, $iDriverId = '', $iBiddingId = '', $sql1 = ''){
        global $obj;
        if($use == "webservice"){
            if(isset($iDriverId)&& !empty($iDriverId)){
                $sql1 .= "AND iDriverId = '" . $iDriverId . "'";
            }
            if(isset($iBiddingId)&& !empty($iBiddingId)){
                $sql1 .= "AND iBiddingId = '" . $iBiddingId . "'";
            }
        }
        $bidding = $obj->MySQLSelect("SELECT iRequestId,iBiddingId FROM $this->bidding_driver_request WHERE 1 = 1 $sql1");
        return $bidding;
    }
    public function biddingdriverrequestcount($use, $iDriverId, $iBiddingId, $sql1 = ''){
        global $obj;
        if($use == "webservice"){
            $sql1 .= "AND iDriverId = '" . $iDriverId . "' AND iBiddingId = '" . $iBiddingId . "'";
        }
        $bidding = $obj->MySQLSelect("SELECT count(iRequestId)as count FROM $this->bidding_driver_request WHERE 1 = 1 $sql1");
        return $bidding[0]['count'];
    }
    public function createbiddingdriverrequest($use, $creDataArr){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->bidding_driver_request, $creDataArr, 'insert');
        return $id;
    }
    public function createbiddingDriverService($use, $creDataArr){
        global $obj;
        $data = $this->biddingDriverService($use, $creDataArr['iDriverId']);
        if(scount($data)== 0){
            $id = $obj->MySQLQueryPerform($this->bidding_driver_service, $creDataArr, 'insert');
            return $id;
        }
    }
    public function biddingDriverService($use, $iDriverId = '', $iBiddingId = '', $sql1 = ''){
        global $obj;
        if($use == "webservice"){
            if(isset($iDriverId)&& !empty($iDriverId)){
                $sql1 .= "AND iDriverId = '" . $iDriverId . "'";
            }
        }
        $query = "SELECT iDriverId,vBiddingId FROM $this->bidding_driver_service WHERE 1 = 1 $sql1";
        $bidding = $obj->MySQLSelect($query);
        return $bidding;
    }
    public function updatebiddingDriverService($use, $data, $where){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->bidding_driver_service, $data, 'update', $where);
        return $id;
    }
    public function sendRequestToDriver($use, $biddingPostId = ''){
        global $obj, $LIST_DRIVER_LIMIT_BY_DISTANCE;
        $vLatitude = 'vWorkLocationLatitude';
        $vLongitude = 'vWorkLocationLongitude';
        $getBiddingPostData = $this->getBiddingPost($use, $biddingPostId);
        $iBiddingId = $getBiddingPostData[0]['iBiddingId'];
        $iBiddingIds = explode(',', $iBiddingId);
        $s = '';
        foreach($iBiddingIds as $b){
            $s .= "AND FIND_IN_SET($b, vBiddingId)> 0 ";
        }
        $getbiddingDriverService = $this->biddingDriverService($use, '', '', $s);
        $iDriverId = '';
        if(scount($getbiddingDriverService)){
            $iDriverId = $this->multiToSingle($getbiddingDriverService, 'iDriverId');
            $iDriverId = implode(',', $iDriverId);
        }
        $sourceLat = $getBiddingPostData[0]['vLatitude'];
        $sourceLon = $getBiddingPostData[0]['vLongitude'];
        $sql = "SELECT *, ROUND((6371 * acos(cos(radians(" . $sourceLat . "))* cos(radians(ROUND(" . $vLatitude . ",8)))* cos(radians(ROUND(" . $vLongitude . ",8))- radians(" . $sourceLon . "))+ sin(radians(" . $sourceLat . "))* sin(radians(ROUND(" . $vLatitude . ",8))))),2)AS distance,iDriverId FROM `register_driver` WHERE(" . $vLatitude . " != '' AND " . $vLongitude . " != '' AND iDriverId IN($iDriverId)AND eStatus='active' AND eIsBlocked = 'No' AND eLogout = 'No')HAVING distance < " . $LIST_DRIVER_LIMIT_BY_DISTANCE . "";
        if($_REQUEST['test']){
            echo $sql;
            exit;
        }
        $Data = $obj->MySQLSelect($sql);
        return $Data;
    }
    public function getBiddingPost($use, $biddingPostid = '', $iUserId = '', $vLanguage = "EN", $ord = '', $farray = array(), $iDriverId = '', $ListBidding = 0){
        global $obj, $userDeviceData, $setupInfoDataArr;
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : '';
        $date_ = date("Y-m-d H:i:s", strtotime(date("Y-m-d H:i:s")));
        $serverTimeZone = date_default_timezone_get();
        $TimeZoneOffset = '';
        if(!empty($vTimeZone)){
            $TimeZoneOffset = converToTz($date_, $serverTimeZone, $vTimeZone, "P");
        }
        $sql_1 = '';
        $join = '';
        $join_1 = '';
        $order_by = 'iBiddingPostId';
        $limit = '';
        $select_parameter = '';
        if($use == "webservice"){
            if(!empty($biddingPostid)){
                $sql_1 .= "AND bp.iBiddingPostId = " . $biddingPostid . "";
            }
            if(!empty($iUserId)){
                $sql_1 .= "AND bp.iUserId = " . $iUserId . "";
                $join = "LEFT JOIN $this->register_driver as rd ON(bp.iDriverId = rd.iDriverId)";
                $select_parameter .= ",rd.vAvgRating, CONCAT(rd.vName ,' ', rd.vLastName)as driverFullName , rd.vImage as driverImage";
            }
            if(isset($iDriverId)&& !empty($iDriverId)){
                $join = "JOIN $this->bidding_request_to_driver as brd ON(brd.iBiddingPostId = bp.iBiddingPostId)";
                $sql_1 .= " AND brd.iDriverId = " . $iDriverId . " AND brd.DeclineByUser != 'Driver'";
                $select_parameter .= ",brd.eStatus as eStatus";
            }
            if($userDeviceData == 1){
                if(isset($iDriverId)&& !empty($iDriverId)){
                    $select_parameter .= ",brd.eDeviceType,brd.iGcmRegId,brd.eDebugMode,brd.eAppTerminate,brd.eHmsDevice";
                }
            }
            $missing_Date = $isExpired = $having = "";
            $isExpired = "CASE WHEN bp.vTaskStatus ='Pending' THEN bp.dBiddingDate <((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)ELSE '0' END as isExpired,";
            if(isset($farray['vFilterParam'])&& !empty($farray['vFilterParam'])){
                if($farray['vFilterParam'] == "Inprocess"){
                    $sql_1 .= " AND bp.vTaskStatus IN('Active', 'Arrived', 'Ongoing')AND bp.iDriverId = '$iDriverId' ";
                }
                elseif($farray['vFilterParam'] == "Accepted"){
                    if(isset($iDriverId)&& !empty($iDriverId)){
                        $sql_1 .= " AND bp.eStatus = 'Accepted' AND bp.iDriverId = '$iDriverId'";
                        $sql_1 .= " AND bp.dBiddingDate >((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)";
                    }
                    else {
                        $sql_1 .= " AND bp.eStatus = 'Accepted'";
                        $sql_1 .= " AND bp.dBiddingDate >((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)";
                        $isExpired = '';
                    }
                }
                elseif($farray['vFilterParam'] == "Closed"){
                    $sql_1 .= " AND brd.eStatus IN('Closed')AND bp.eStatus = 'Accepted' AND bp.iDriverId != '$iDriverId'";
                    $isExpired = '';
                }
                elseif($farray['vFilterParam'] == "Expired"){
                    $sql_1 .= " AND bp.eStatus IN('Pending' ,'Accepted')AND bp.dBiddingDate <((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)";
                    if(isset($iDriverId)&& !empty($iDriverId)){
                    }
                }
                elseif($farray['vFilterParam'] == "Cancelled"){
                    if(isset($iDriverId)&& !empty($iDriverId)){
                        $sql_1 .= " AND(brd.eStatus IN('Decline')OR bp.eStatus = 'Cancelled')";
                    }
                    else {
                        $sql_1 .= " AND bp.eStatus = 'Cancelled'";
                    }
                    $isExpired = '';
                }
                elseif($farray['vFilterParam'] == "Completed"){
                    if(isset($iDriverId)&& !empty($iDriverId)){
                        $sql_1 .= " AND bp.eStatus = 'Completed' AND bp.iDriverId = '$iDriverId'";
                    }
                    else {
                        $sql_1 .= " AND bp.eStatus = 'Completed'";
                    }
                }
                else {
                    if(isset($iDriverId)&& !empty($iDriverId)){
                        $sql_1 .= " AND brd.eStatus IN('Pending','Reoffer','Accepted')";
                    }
                    $sql_1 .= " AND bp.eStatus = '" . $farray['vFilterParam'] . "'";
                    $sql_1 .= " AND bp.eStatus IN('Pending')AND bp.dBiddingDate >((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)";
                }
            }
            else {
            }
            if(!isset($farray['missingDate'])&& isset($iDriverId)&& !empty($iDriverId)&& isset($farray['vFromDate'])&& !empty($farray['vFromDate'])&& in_array($farray['vFilterParam'], [ 'Inprocess', 'Expired', 'Completed', 'Cancelled' ])){
                $date = $farray['vFromDate'] . " " . "12:01:00";
                $date = date("Y-m-d H:i:s", strtotime($date));
                $serverTimeZone = date_default_timezone_get();
                $date = converToTz($date, $serverTimeZone, $vTimeZone, "Y-m-d");
                $sql_1 .= "AND DATE(bp.dBiddingDate)= '" . $date . "' ";
            }
            if(isset($farray['missingDate'])&& isset($farray['vFromDate'])&& !empty($farray['vFromDate'])){
                $dSetupDate = $setupInfoDataArr[0]['dSetupDate'];
                $yearFromDate = date('Y-m-d 00:00:00', strtotime($dSetupDate));
                $yearToDate = date('Y-m-d 23:59:59', strtotime($farray['vFromDate']));
                $missing_Date = ', DATE(bp.dBiddingDate)as StartDate';
                $sql_1 .= " AND(bp.dBiddingDate BETWEEN '$yearFromDate' AND '$yearToDate')GROUP BY DATE(bp.dBiddingDate)";
            }
            $ord = 'ORDER BY ' . $order_by . ' DESC';
        }
        $sql = "SELECT bp.eStatus as eStatusMain, JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle, $isExpired bp.*,user_address.vServiceAddress, user_address.vBuildingNo, user_address.vLandmark, user_address.vAddressType, user_address.vServiceAddress, user_address.vLatitude,user_address.vLongitude $missing_Date $select_parameter FROM $this->biddingPostTable as bp JOIN $this->register_user as user ON(bp.iUserId = user.iUserId)JOIN $this->tablename as bs ON(bp.iBiddingId = bs.iBiddingId)$join $join_1 LEFT JOIN $this->user_address as user_address ON(bp.iAddressId = user_address.iUserAddressId)WHERE 1 = 1 $sql_1 $having $ord $limit";
        if($ListBidding == 1){
            $sql = "SELECT bp.iBiddingPostId FROM $this->biddingPostTable as bp JOIN $this->register_user as user ON(bp.iUserId = user.iUserId)JOIN $this->tablename as bs ON(bp.iBiddingId = bs.iBiddingId)$join $join_1 LEFT JOIN $this->user_address as user_address ON(bp.iAddressId = user_address.iUserAddressId)WHERE 1 = 1 $sql_1 $ord";
        }
        $bidding = $obj->MySQLSelect($sql);
        if(isset($farray['missingDate'])){
            $bidding = array_column($bidding, 'StartDate');
        }
        return $bidding;
    }
    public function multiToSingle($array, $k){
        $returnarr = [];
        foreach($array as $key => $a){
            $returnarr[$key] = $a[$k];
        }
        return $returnarr;
    }
    public function saveBiddingRequestToDriver($use, $creDataArr){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->bidding_request_to_driver, $creDataArr, 'insert');
        return $id;
    }
    public function getDriverBiddingRequest($use, $biddingPostId = '', $vCurrency = '', $lang = '', $fBiddingAmount = '', $iDriverId = '', $getBiddingPost = array()){
        global $obj, $tconfig, $LANG_OBJ, $GeneralUserType;
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $sql1 = '';
        if($use == "webservice"){
            if(isset($biddingPostId)&& !empty($biddingPostId)){
                $sql1 .= "AND iBiddingPostId = '" . $biddingPostId . "'";
            }
            if(isset($iDriverId)&& !empty($iDriverId)){
                $sql1 .= "AND iDriverId = '" . $iDriverId . "'";
            }
        }
        $query = "SELECT iDriverId,eStatus,dLUpdateDate,iCancelReasonId,DeclineByUser FROM $this->bidding_request_to_driver WHERE 1 = 1 $sql1";
        $bidding_request_to_driver = $obj->MySQLSelect($query);
        $return = [];
        if(scount($bidding_request_to_driver)> 0){
            foreach($bidding_request_to_driver as $key => $value){
                $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
                if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                    $query_4 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Reoffer' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
                    $bidding_final_offer = $obj->MySQLSelect($query_4);
                    if(empty($bidding_final_offer)){
                        $bidding_final_offer = $getBiddingPost;
                        $bidding_final_offer[0]['amount'] = $getBiddingPost[0]['fBiddingAmount'];
                    }
                }
                $query_3 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Reoffer' AND UserType = 'Passenger' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
                $bidding_offer_by_user = $obj->MySQLSelect($query_3);
                $bidding_request_to_driver[$key]['iBiddingPostId'] = $biddingPostId;
                $bidding_request_to_driver[$key]['vBiddingPostNo'] = $getBiddingPost[0]['vBiddingPostNo'];
                $bidding_request_to_driver[$key]['biddingAmountTitle'] = "";
                $bidding_request_to_driver[$key]['biddingAmount'] = "";
                $bidding_request_to_driver[$key]['biddingReofferAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_DRIVER'];
                $bidding_request_to_driver[$key]['biddingfinalAmountTitle'] = $languageLabelsArr['LBL_BIDDING_FINAL_TASK_AMOUNT'];
                if(scount($bidding_offer_by_user)> 0){
                    $bidding_request_to_driver[$key]['biddingAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_ME'];
                    $bidding_request_to_driver[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                    $bidding_request_to_driver[$key]['description_user'] = $bidding_offer_by_user[0]['description'];
                }
                else if($GeneralUserType == "Driver"){
                    $bidding_request_to_driver[$key]['biddingAmount'] = $fBiddingAmount;
                }
                $query_1 = "SELECT vName,vLastName,vCurrencyDriver,vImage FROM $this->register_driver WHERE 1 = 1 AND iDriverId = " . $value['iDriverId'] . " ";
                $register_driver = $obj->MySQLSelect($query_1);
                $bidding_request_to_driver[$key]['vName'] = $register_driver[0]['vName'] . ' ' . $register_driver[0]['vLastName'];
                $bidding_request_to_driver[$key]['vAvgRating'] = $this->getAvgRating($value['iDriverId'], 'Driver');
                if(isset($register_driver[0]['vImage'])&& !empty($register_driver[0]['vImage'])){
                    $bidding_request_to_driver[$key]['vImage'] = $tconfig["tsite_upload_images_driver"] . '/' . $value['iDriverId'] . '/3_' . $register_driver[0]['vImage'];
                }
                else {
                    $bidding_request_to_driver[$key]['vImage'] = '';
                }
                $query_2 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Reoffer' AND UserType = 'Driver' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
                $bidding_offer = $obj->MySQLSelect($query_2);
                $bidding_offer_ = $bidding_offer[0]['amount'];
                $bidding_offer_by_user_ = $bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'];
                $bidding_final_offer_ = $bidding_final_offer[0]['amount'] * $currency[0]['ratio'];
                $bidding_request_to_driver[$key]['description_driver'] = "";
                if($bidding_offer_ > 0){
                    if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                        $bidding_request_to_driver[$key]['biddingReofferAmount_'] = $bidding_final_offer_;
                    }
                    else {
                        $bidding_request_to_driver[$key]['biddingAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_ME'];
                        if(scount($bidding_offer_by_user)> 0){
                            $bidding_request_to_driver[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        }
                        else {
                            $bidding_request_to_driver[$key]['biddingAmount'] = $fBiddingAmount;
                        }
                        $bidding_request_to_driver[$key]['biddingReofferAmount_'] = formateNumAsPerCurrency($bidding_offer_ * $currency[0]['ratio'], $vCurrency);
                        $bidding_request_to_driver[$key]['description_driver'] = !empty($bidding_offer[0]['description'])? $bidding_offer[0]['description'] : "";
                    }
                }
                else {
                    $bidding_request_to_driver[$key]['biddingReofferAmount_'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
                }
                if($value['eStatus'] == "Pending"){
                    $bidding_request_to_driver[$key]['showAcceptBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                    $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_WAITING_PROVIDER_RESPONSE_MSG'];
                    $return[] = $bidding_request_to_driver[$key];
                }
                if($value['eStatus'] == "Reoffer"){
                    if(scount($bidding_offer)> 0){
                        $bidding_request_to_driver[$key]['eStatus'] = 'Reoffer';
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        $bidding_request_to_driver[$key]['showAcceptBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'Yes';
                        if($bidding_offer_by_user_ > 0 && $bidding_offer[0]['IOfferId'] < $bidding_offer_by_user[0]['IOfferId']){
                            $bidding_request_to_driver[$key]['showAcceptBtn'] = 'No';
                            $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                            $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                            $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_WAITING_PROVIDER_RESPONSE_MSG'];
                        }
                        $return[] = $bidding_request_to_driver[$key];
                    }
                }
                if($value['eStatus'] == "Accepted"){
                    if(scount($bidding_offer)> 0){
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                    }
                    else {
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = '';
                    }
                    if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                        $bidding_request_to_driver[$key]['biddingFinalAmount'] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        $bidding_request_to_driver[$key]['biddingReofferAmountTitle'] = "";
                        $bidding_request_to_driver[$key]['biddingReofferAmount_'] = "";
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = "";
                        $bidding_request_to_driver[$key]['biddingAmountTitle'] = "";
                        $bidding_request_to_driver[$key]['biddingAmount'] = "";
                        $bidding_request_to_driver[$key]['showConfirmBtn'] = 'No';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_START_BIDDING_TASK_MSG'];
                    }
                    else {
                        $bidding_request_to_driver[$key]['showConfirmBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                    }
                    $return[] = $bidding_request_to_driver[$key];
                }
                if($value['eStatus'] == "Decline"){
                    $cancel_reason = $obj->MySQLSelect("SELECT vTitle_" . $lang . " FROM `cancel_reason` WHERE `iCancelReasonId` = " . $value['iCancelReasonId']);
                    if(isset($cancel_reason[0]["vTitle_" . $lang])&& !empty($cancel_reason[0]["vTitle_" . $lang])){
                        $bidding_request_to_driver[$key]['cancelReason'] = $languageLabelsArr['LBL_TASK_CANCELLED_TXT'] . ': ' . $cancel_reason[0]["vTitle_" . $lang];
                    }
                    else {
                        $bidding_request_to_driver[$key]['cancelReason'] = '';
                    }
                    if($bidding_request_to_driver[$key]['DeclineByUser'] == "Driver"){
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_BIDDING_DECLINED_PROVIDER_MSG'];
                    }
                    else {
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_BIDDING_DECLINED_USER_MSG'];
                    }
                    $bidding_request_to_driver[$key]['showConfirmBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                    $return[] = $bidding_request_to_driver[$key];
                }
            }
            if(!empty($return)){
                $dLUpdateDate = array_column($return, 'dLUpdateDate');
                array_multisort($dLUpdateDate, SORT_DESC, $return);
            }
        }
        return $return;
    }
    public function getAvgRating($iMemberId, $UserType){
        if(function_exists('getMemberAvgRating')){
            return getMemberAvgRating($iMemberId, $UserType);
        }
        global $obj;
        if($UserType == "Passenger"){
            $iMemberField = 'iUserId';
            $OtherUserType = "Driver";
        }
        else {
            $iMemberField = 'iDriverId';
            $OtherUserType = "Passenger";
        }
        $bidding_posts = $obj->MySQLSelect("SELECT GROUP_CONCAT(iBiddingPostId)as iBiddingPostIds FROM $this->biddingPostTable WHERE $iMemberField = '$iMemberId' AND eStatus = 'Completed'");
        $iBiddingPostIds = $bidding_posts[0]['iBiddingPostIds'];
        $average_rating = "0.0";
        if(!empty($iBiddingPostIds)){
            $total_ratings_count = $obj->MySQLSelect("SELECT COUNT(iRatingId)as rating_count, SUM(fRating)as total_rating FROM bidding_service_ratings WHERE iBiddingPostId IN($iBiddingPostIds)AND eUserType = '$OtherUserType'");
            $rating_count = $total_ratings_count[0]['rating_count'];
            $total_rating = $total_ratings_count[0]['total_rating'];
            if($rating_count > 0){
                $average_rating = round($total_rating / $rating_count, 1);
            }
        }
        return $average_rating;
    }
    public function UserBiddingRequest($biddingPostId, $vCurrency, $notification = '', $iDriverId = ''){
        global $tconfig, $obj, $LANG_OBJ, $GeneralUserType;
        $lang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : "";
        if($lang == "" || $lang == NULL){
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $sql1 = '';
        if(isset($biddingPostId)&& !empty($biddingPostId)){
            $sql1 .= "AND iBiddingPostId = '" . $biddingPostId . "'";
        }
        if(isset($iDriverId)&& !empty($iDriverId)){
            $sql1 .= "AND iDriverId = '" . $iDriverId . "'";
        }
        $query = "SELECT iDriverId,eStatus,dLUpdateDate,iCancelReasonId,DeclineByUser FROM $this->bidding_request_to_driver WHERE 1 = 1 $sql1";
        $bidding_request_to_driver = $obj->MySQLSelect($query);
        $getBiddingPost = $this->getBiddingPost('webservice', $biddingPostId);
        $return = [];
        if(scount($bidding_request_to_driver)> 0){
            foreach($bidding_request_to_driver as $key => $value){
                $query_1 = "SELECT vName,vLastName,vCurrencyDriver,vImage FROM $this->register_driver WHERE 1 = 1 AND iDriverId = " . $value['iDriverId'] . " ";
                $register_driver = $obj->MySQLSelect($query_1);
                $bidding_request_to_driver[$key]['vName'] = $register_driver[0]['vName'] . ' ' . $register_driver[0]['vLastName'];
                $bidding_request_to_driver[$key]['vAvgRating'] = $this->getAvgRating($value['iDriverId'], 'Driver');
                if(isset($register_driver[0]['vImage'])&& !empty($register_driver[0]['vImage'])){
                    $bidding_request_to_driver[$key]['vImage'] = $tconfig["tsite_upload_images_driver"] . '/' . $value['iDriverId'] . '/3_' . $register_driver[0]['vImage'];
                }
                else {
                    $bidding_request_to_driver[$key]['vImage'] = '';
                }
                $bidding_request_to_driver[$key]['eJobType'] = "Bidding";
                $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
                $bidding_request_to_driver[$key]['iBiddingPostId'] = $biddingPostId;
                $bidding_request_to_driver[$key]['vBiddingPostNo'] = $getBiddingPost[0]['vBiddingPostNo'];
                $bidding_request_to_driver[$key]['biddingAmountTitle'] = "";
                $bidding_request_to_driver[$key]['biddingAmount'] = "";
                $bidding_request_to_driver[$key]['biddingReofferAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_DRIVER'];
                $bidding_request_to_driver[$key]['biddingfinalAmountTitle'] = $languageLabelsArr['LBL_BIDDING_FINAL_TASK_AMOUNT'];
                if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                    $query_4 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Accepted' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
                    $bidding_final_offer = $obj->MySQLSelect($query_4);
                    if(empty($bidding_final_offer)){
                        $bidding_final_offer = $getBiddingPost;
                        $bidding_final_offer[0]['amount'] = $getBiddingPost[0]['fBiddingAmount'];
                    }
                }
                $query_3 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND(eStatus = 'Reoffer' || eStatus = 'Accepted')AND UserType = 'Passenger' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
                $bidding_offer_by_user = $obj->MySQLSelect($query_3);
                $query_2 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Reoffer' AND UserType = 'Driver' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
                $bidding_offer = $obj->MySQLSelect($query_2);
                if(scount($bidding_offer_by_user)> 0){
                    $bidding_request_to_driver[$key]['biddingAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_ME'];
                    $bidding_request_to_driver[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                    $bidding_request_to_driver[$key]['description_user'] = $bidding_offer_by_user[0]['description'];
                }
                else if($GeneralUserType == "Driver"){
                    $bidding_request_to_driver[$key]['biddingAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
                }
                $bidding_request_to_driver[$key]['description_driver'] = "";
                if($value['eStatus'] == "Pending"){
                    $bidding_request_to_driver[$key]['showAcceptBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                    $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_WAITING_PROVIDER_RESPONSE_MSG'];
                    $return[] = $bidding_request_to_driver[$key];
                }
                if($value['eStatus'] == "Reoffer"){
                    if(scount($bidding_offer)> 0){
                        $bidding_request_to_driver[$key]['eStatus'] = 'Reoffer';
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        $bidding_request_to_driver[$key]['showAcceptBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['description_driver'] = !empty($bidding_offer[0]['description'])? $bidding_offer[0]['description'] : "";
                        if($bidding_offer[0]['IOfferId'] < $bidding_offer_by_user[0]['IOfferId']){
                            $bidding_request_to_driver[$key]['showAcceptBtn'] = 'No';
                            $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                            $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                            $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_WAITING_PROVIDER_RESPONSE_MSG'];
                        }
                        $return[] = $bidding_request_to_driver[$key];
                    }
                }
                if($value['eStatus'] == "Accepted"){
                    $bidding_request_to_driver[$key]['biddingConfirmAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
                    ;
                    if(scount($bidding_offer)> 0){
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        if($getBiddingPost[0]['eStatus'] == 'Accepted' && $bidding_offer[0]['IOfferId'] < $bidding_offer_by_user[0]['IOfferId']){
                            $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                            $bidding_request_to_driver[$key]['biddingConfirmAmount'] = $bidding_request_to_driver[$key]['biddingReofferAmount'];
                        }
                        else {
                            $bidding_request_to_driver[$key]['biddingConfirmAmount'] = $bidding_request_to_driver[$key]['biddingAmount'];
                        }
                    }
                    else {
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = '';
                    }
                    $bidding_request_to_driver[$key]['description_driver'] = !empty($bidding_offer[0]['description'])? $bidding_offer[0]['description'] : "";
                    if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                        $bidding_request_to_driver[$key]['biddingFinalAmount'] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                        $bidding_request_to_driver[$key]['biddingConfirmAmount'] = '';
                        $bidding_request_to_driver[$key]['description_driver'] = '';
                        $bidding_request_to_driver[$key]['description_user'] = '';
                        $bidding_request_to_driver[$key]['biddingReofferAmountTitle'] = "";
                        $bidding_request_to_driver[$key]['biddingReofferAmount_'] = "";
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = "";
                        $bidding_request_to_driver[$key]['biddingAmountTitle'] = "";
                        $bidding_request_to_driver[$key]['biddingAmount'] = "";
                        $bidding_request_to_driver[$key]['showConfirmBtn'] = 'No';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_START_BIDDING_TASK_MSG'];
                    }
                    else {
                        $bidding_request_to_driver[$key]['showConfirmBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showDeclineBtn'] = 'Yes';
                        $bidding_request_to_driver[$key]['showReofferBtn'] = 'No';
                    }
                    $return[] = $bidding_request_to_driver[$key];
                }
                if($value['eStatus'] == "Decline"){
                    if(scount($bidding_offer)> 0){
                        $bidding_request_to_driver[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                    }
                    $cancel_reason = $obj->MySQLSelect("SELECT vTitle_" . $lang . " FROM `cancel_reason` WHERE `iCancelReasonId` = " . $value['iCancelReasonId']);
                    if(isset($cancel_reason[0]["vTitle_" . $lang])&& !empty($cancel_reason[0]["vTitle_" . $lang])){
                        $bidding_request_to_driver[$key]['cancelReason'] = $languageLabelsArr['LBL_TASK_CANCELLED_TXT'] . ': ' . $cancel_reason[0]["vTitle_" . $lang];
                    }
                    else {
                        $bidding_request_to_driver[$key]['cancelReason'] = '';
                    }
                    if($bidding_request_to_driver[$key]['DeclineByUser'] == "Driver"){
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_BIDDING_DECLINED_PROVIDER_MSG'];
                    }
                    else {
                        $bidding_request_to_driver[$key]['eStatusMsg'] = $languageLabelsArr['LBL_BIDDING_DECLINED_USER_MSG'];
                    }
                    $bidding_request_to_driver[$key]['showConfirmBtn'] = 'No';
                    $bidding_request_to_driver[$key]['showDeclineBtn'] = 'No';
                    $return[] = $bidding_request_to_driver[$key];
                }
            }
            if(!empty($return)){
                $dLUpdateDate = array_column($return, 'dLUpdateDate');
                array_multisort($dLUpdateDate, SORT_DESC, $return);
            }
        }
        return $return;
    }
    public function DriverBiddingRequest($biddingPostId, $vCurrency, $iDriverId, $notification = ''){
        global $obj, $tconfig, $LANG_OBJ, $GeneralUserType;
        $lang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : "";
        if($lang == "" || $lang == NULL){
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $sql1 = '';
        $sql1 .= "AND iBiddingPostId = '" . $biddingPostId . "' AND iDriverId = '" . $iDriverId . "'";
        $query = "SELECT * FROM $this->bidding_request_to_driver WHERE 1 = 1 $sql1";
        $bidding_request_to_driver = $obj->MySQLSelect($query);
        $getBiddingPost = $this->getBiddingPost('webservice', $biddingPostId);
        $return = [];
        $value = $bidding_request_to_driver[0];
        $key = 0;
        $iBiddingId = explode(',', $getBiddingPost[0]['iBiddingId']);
        $_title = $getBiddingPost[0]['vTitle'];
        if(scount($iBiddingId)> 1){
            $getbidding_ = $this->getbidding('webservice', $getBiddingPost[0]['iBiddingId'], $lang);
            $vtitle_ = $this->multiToSingle($getbidding_, 'vCategory');
            $_title = implode(',', $vtitle_);
        }
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
        $biddingPostIdArr[$key]['vServiceName'] = $_title;
        $biddingPostIdArr[$key]['fBiddingAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
        $biddingPostIdArr[$key]['tDescription'] = $getBiddingPost[0]['tDescription'];
        $biddingPostIdArr[$key]['eStatus'] = $getBiddingPost[0]['eStatus'];
        $systemTimeZone = date_default_timezone_get();
        $biddingPostIdArr[$key]['dBiddingDate'] = converToTz($getBiddingPost[0]['dBiddingDate'], $getBiddingPost[0]['vTimeZone'], $systemTimeZone);
        $userdata = $obj->MySQLSelect("SELECT vName,vLastName FROM `register_user` WHERE iUserId=" . $getBiddingPost[0]['iUserId']);
        $biddingPostIdArr[$key]['Name'] = $userdata[0]['vName'] . ' ' . $userdata[0]['vLastName'];
        $biddingPostIdArr[$key]['vServiceAddress'] = $getBiddingPost[0]['vServiceAddress'];
        $biddingPostIdArr[$key]['vBiddingPostNo'] = $getBiddingPost[0]['vBiddingPostNo'];
        $biddingPostIdArr[$key]['biddingReofferAmountTitle'] = $languageLabelsArr['LBL_BIDDING_TASK_BUDGET_TXT'];
        $biddingPostIdArr[$key]['biddingAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_ME'];
        $biddingPostIdArr[$key]['biddingfinalAmountTitle'] = $languageLabelsArr['LBL_BIDDING_FINAL_TASK_AMOUNT'];
        $biddingPostIdArr[$key]['iUserId'] = $getBiddingPost[0]['iUserId'];
        $biddingPostIdArr[$key]['iBiddingPostId'] = $biddingPostId;
        $buttonCheck = $this->buttonCheck('webservice', $biddingPostId, $iDriverId);
        $biddingPostIdArr[$key]['showAcceptBtn'] = $buttonCheck['showAcceptBtn'] == 'No' ? 'No' : 'Yes';
        $biddingPostIdArr[$key]['showDeclineBtn'] = $buttonCheck['showDeclineBtn'] == 'No' ? 'No' : 'Yes';
        $biddingPostIdArr[$key]['showReOfferBtn'] = "No";
        if($buttonCheck['showAcceptBtn'] == "Yes" && $buttonCheck['showDeclineBtn'] == "Yes"){
            $biddingPostIdArr[$key]['showReOfferBtn'] = "Yes";
        }
        else {
            $biddingPostIdArr[$key]['eStatusMsg'] = $languageLabelsArr['LBL_WAITING_USER_CONFIRM_MSG'];
        }
        if($getBiddingPost[0]['eStatus'] == "Accepted"){
            $biddingPostIdArr[$key]['eStatusMsg'] = "";
            $biddingPostIdArr[$key]['showStartTaskBtn'] = "Yes";
            if($getBiddingPost[0]['iDriverId'] != $iDriverId){
                $biddingPostIdArr[$key]['showAcceptBtn'] = $biddingPostIdArr[$key]['showDeclineBtn'] = $biddingPostIdArr[$key]['showReOfferBtn'] = $biddingPostIdArr[$key]['showStartTaskBtn'] = "No";
                $biddingPostIdArr[$key]['eStatusMsg'] = $languageLabelsArr['LBL_SAME_TASK_EXIST_TXT'];
            }
        }
        elseif($getBiddingPost[0]['eStatus'] == "Cancelled"){
            $biddingPostIdArr[$key]['showAcceptBtn'] = "No";
            $biddingPostIdArr[$key]['showDeclineBtn'] = "No";
            $biddingPostIdArr[$key]['showReOfferBtn'] = "No";
            $cancel_reason = $getBiddingPost[0]['iCancelReasonId'] > 0 ? $this->getCancelReason($getBiddingPost[0]['iCancelReasonId'], $lang): $getBiddingPost[0]['vCancelReason'];
            $biddingPostIdArr[$key]['cancelReason'] = $languageLabelsArr['LBL_TASK_CANCELLED_TXT'] . ': ' . $cancel_reason;
        }
        $query_3 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND(eStatus = 'Reoffer' || eStatus = 'Accepted')AND UserType = 'Passenger' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
        $bidding_offer_by_user = $obj->MySQLSelect($query_3);
        $query_2 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND(eStatus = 'Reoffer'|| eStatus = 'Accepted')AND UserType = 'Driver' AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC";
        $bidding_offer = $obj->MySQLSelect($query_2);
        if($getBiddingPost[0]['eStatus'] == 'Accepted' || $value['eStatus'] == "Accepted"){
            $query_4 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND iDriverId = " . $value['iDriverId'] . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
            $bidding_final_offer = $obj->MySQLSelect($query_4);
            if(empty($bidding_final_offer)){
                $bidding_final_offer = $getBiddingPost;
                $bidding_final_offer[0]['amount'] = $getBiddingPost[0]['fBiddingAmount'];
            }
            $bid_wallet_amount = $bidding_final_offer[0]['amount'];
        }
        if(scount($bidding_offer_by_user)> 0){
            $biddingPostIdArr[$key]['biddingReofferAmountTitle'] = $languageLabelsArr['LBL_AMOUNT_BY_USER'];
            $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
            $bidding_offer_by_user_ = $bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'];
        }
        else {
            $biddingPostIdArr[$key]['biddingAmount'] = '';
            $bidding_offer_by_user_ = 0;
        }
        $biddingPostIdArr[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
        $biddingPostIdArr[$key]['description_user'] = !empty($bidding_offer_by_user[0]['description'])? $bidding_offer_by_user[0]['description'] : '';
        $biddingPostIdArr[$key]['description_driver'] = !empty($bidding_offer[0]['description'])? $bidding_offer[0]['description'] : '';
        $biddingPostIdArr[$key]['biddingWalletMsg'] = "";
        if($value['eStatus'] == "Reoffer"){
            if(scount($bidding_offer)> 0){
                if($bidding_offer[0]['amount'] > 0){
                    $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                }
                if($bidding_offer_by_user[0]['amount'] > 0){
                    $biddingPostIdArr[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                }
                if($bidding_offer[0]['IOfferId'] < $bidding_offer_by_user[0]['IOfferId']){
                }
            }
        }
        if($value['eStatus'] == "Accepted"){
            $biddingPostIdArr[$key]['biddingConfirmAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
            $finalAmount = $getBiddingPost[0]['fBiddingAmount'];
            if(isset($bidding_offer[0]['amount'])&& $bidding_offer[0]['amount'] > 0){
                $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
            }
            if(isset($bidding_offer_by_user[0]['amount'])&& $bidding_offer_by_user[0]['amount'] > 0){
                $biddingPostIdArr[$key]['biddingReofferAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                $biddingPostIdArr[$key]['biddingConfirmAmount'] = $biddingPostIdArr[$key]['biddingReofferAmount'];
                $finalAmount = $bidding_offer_by_user[0]['amount'];
            }
            if($getBiddingPost[0]['eStatus'] == 'Accepted'){
                $biddingPostIdArr[$key]['biddingFinalAmount'] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                $biddingPostIdArr[$key]['biddingConfirmAmount'] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                $finalAmount = $bidding_final_offer[0]['amount'];
            }
            $fCommissionAmount =($finalAmount * $getBiddingPost[0]['fCommission'])/ 100;
            $fCommissionAmount = formateNumAsPerCurrency($fCommissionAmount * $currency[0]['ratio'], $vCurrency);
            $biddingPostIdArr[$key]['biddingWalletMsg'] = str_replace("#AMOUNT#", $fCommissionAmount, $languageLabelsArr['LBL_MAINTAIN_WALLET_BALANCE_BID_MSG']);
        }
        if($value['eStatus'] == "Decline"){
            if($value['DeclineByUser'] == 'Passenger'){
                if($bidding_offer[0]['amount'] > 0){
                    $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                }
                $biddingPostIdArr[$key]['eStatusMsg'] = $languageLabelsArr['LBL_BIDDING_USER_DECLINED_MSG'];
                $cancel_reason = $value['iCancelReasonId'] > 0 ? $this->getCancelReason($value['iCancelReasonId'], $lang): '';
                $biddingPostIdArr[$key]['biddingWalletMsg'] = $languageLabelsArr['LBL_TASK_CANCELLED_TXT'] . ': ' . $cancel_reason;
            }
        }
        $biddingPostIdArr[$key]['showChatIcon'] = 'No';
        if($value['eStatus'] == "Reoffer" || $value['eStatus'] == "Accepted" || $value['eStatus'] == "Pending"){
            $biddingPostIdArr[$key]['showChatIcon'] = 'Yes';
        }
        if($value['eStatus'] == "Closed"){
            $biddingPostIdArr[$key]['showAcceptBtn'] = "No";
            $biddingPostIdArr[$key]['showDeclineBtn'] = "No";
            $biddingPostIdArr[$key]['showReOfferBtn'] = "No";
            $biddingPostIdArr[$key]['eStatusMsg'] = '';
            $biddingPostIdArr[$key]['showChatIcon'] = 'No';
            $biddingPostIdArr[$key]['biddingWalletMsg'] = $languageLabelsArr['LBL_SAME_TASK_EXIST_MSG'];
        }
        if($getBiddingPost[0]['isExpired'] == "1"){
            $biddingPostIdArr[$key]['showAcceptBtn'] = "No";
            $biddingPostIdArr[$key]['showDeclineBtn'] = "No";
            $biddingPostIdArr[$key]['showReOfferBtn'] = "No";
            $biddingPostIdArr[$key]['eStatusMsg'] = '';
        }
        if($notification == 'notification'){
            if(scount($bidding_offer)> 0){
                $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                if($bidding_offer_by_user_ > 0 && $bidding_offer[0]['IOfferId'] < $bidding_offer_by_user[0]['IOfferId']){
                    $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($bidding_offer_by_user[0]['amount'] * $currency[0]['ratio'], $vCurrency);
                }
            }
            else {
                $biddingPostIdArr[$key]['biddingAmount'] = formateNumAsPerCurrency($getBiddingPost[0]['fBiddingAmount'] * $currency[0]['ratio'], $vCurrency);
            }
        }
        return $biddingPostIdArr;
    }
    public function getbidding($use, $iBiddingId, $vLanguage = "EN", $reqArr = []){
        global $obj, $MODULES_OBJ;
        $sql = '';
        $iBiddingId_ = explode(',', $iBiddingId);
        if(scount($iBiddingId_)> 1){
            $sql .= " iBiddingId IN(" . $iBiddingId . ")";
        }
        else {
            $sql .= "iBiddingId = '" . $iBiddingId . "'";
        }
        $db_fields = "";
        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()|| $MODULES_OBJ->isEnableAppHomeScreenLayoutV4()){
            $db_fields .= ", vImage1";
        }
        $bidding = $obj->MySQLSelect("SELECT eStatus,iDisplayOrder,eOther,iBiddingId,vImage,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescription,iParentId,tDescription as tDescription_json,vTitle as vTitle_json,fCommission $db_fields FROM $this->tablename WHERE 1 = 1 AND $sql");
        $return_array = array();
        if($use == 'webservice'){
            foreach($bidding as $key => $mServiceCategory){
                $return_array[$key] = $this->getBiddingQuery_array($mServiceCategory, $reqArr);
            }
        }
        else {
            $return_array = $bidding;
        }
        if(scount($iBiddingId_)> 1){
            return $return_array;
        }
        else {
            return $return_array[0];
        }
    }
    public function buttonCheck($use, $biddingPostId = '', $iDriverId = '', $iUserId = ''){
        global $obj;
        $sql1 = '';
        if($use == "webservice"){
            if(isset($biddingPostId)&& !empty($biddingPostId)){
                $sql1 .= "AND iBiddingPostId = '" . $biddingPostId . "' AND iDriverId = '$iDriverId'";
            }
        }
        $query = "SELECT iDriverId,eStatus,dLUpdateDate,DeclineByUser FROM $this->bidding_request_to_driver WHERE 1 = 1 $sql1";
        $bidding_request_to_driver = $obj->MySQLSelect($query);
        $bidding_request_to_driver = $bidding_request_to_driver[0];
        if($bidding_request_to_driver['eStatus'] == 'Accepted'){
            $btnStatus['showAcceptBtn'] = 'No';
            $btnStatus['showDeclineBtn'] = 'No';
            $btnStatus['showDetailBtn'] = 'Yes';
        }
        if($bidding_request_to_driver['eStatus'] == 'Reoffer'){
            $sql = '';
            if(isset($iDriverId)&& !empty($iDriverId)){
                $sql .= "AND iDriverId = " . $iDriverId . "";
            }
            if(isset($iUserId)&& !empty($iUserId)){
                $sql .= "AND iUserId = " . $iUserId . "";
            }
            $query_2 = "SELECT UserType,iDriverId,iUserId FROM $this->bidding_offer WHERE 1 = 1 $sql AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
            $bidding_offer = $obj->MySQLSelect($query_2);
            if(scount($bidding_offer)> 0){
                if(isset($iDriverId)&& !empty($iDriverId)){
                    if($bidding_offer[0]['UserType'] == 'Driver'){
                        $btnStatus['showAcceptBtn'] = 'No';
                        $btnStatus['showDeclineBtn'] = 'No';
                        $btnStatus['showDetailBtn'] = 'Yes';
                    }
                    else {
                        $btnStatus['showAcceptBtn'] = 'Yes';
                        $btnStatus['showDeclineBtn'] = 'Yes';
                        $btnStatus['showDetailBtn'] = 'Yes';
                    }
                }
                if(isset($iUserId)&& !empty($iUserId)){
                    if($bidding_offer[0]['UserType'] == 'Passenger'){
                        $btnStatus['showAcceptBtn'] = 'No';
                        $btnStatus['showDeclineBtn'] = 'No';
                        $btnStatus['showDetailBtn'] = 'Yes';
                    }
                    else {
                        $btnStatus['showAcceptBtn'] = 'Yes';
                        $btnStatus['showDeclineBtn'] = 'Yes';
                        $btnStatus['showDetailBtn'] = 'Yes';
                    }
                }
            }
            else {
                $btnStatus['showAcceptBtn'] = 'Yes';
                $btnStatus['showDeclineBtn'] = 'Yes';
                $btnStatus['showDetailBtn'] = 'Yes';
            }
        }
        if($bidding_request_to_driver['eStatus'] == 'Pending'){
            $btnStatus['showAcceptBtn'] = 'Yes';
            $btnStatus['showDeclineBtn'] = 'Yes';
            $btnStatus['showDetailBtn'] = 'Yes';
        }
        if($bidding_request_to_driver['eStatus'] == 'Decline'){
            if($bidding_request_to_driver['DeclineByUser'] == 'Passenger'){
                $btnStatus['showAcceptBtn'] = 'No';
                $btnStatus['showDeclineBtn'] = 'No';
                $btnStatus['showDetailBtn'] = 'Yes';
            }
            else {
                $btnStatus['showAcceptBtn'] = 'No';
                $btnStatus['showDeclineBtn'] = 'No';
                $btnStatus['showDetailBtn'] = 'Yes';
            }
        }
        return $btnStatus;
    }
    public function getCancelReason($iCancelReasonId, $vLang){
        global $obj;
        $cancel_reason_data = $obj->MySQLSelect("SELECT vTitle_$vLang as vTitle FROM cancel_reason WHERE iCancelReasonId = '$iCancelReasonId'");
        return $cancel_reason_data[0]['vTitle'];
    }
    public function updateBiddingRequestTo($use, $data, $where){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->bidding_request_to_driver, $data, 'update', $where);
        if($data['eStatus'] == "Accepted"){
            $obj->sql_query("UPDATE bidding_offer as bo,(SELECT IOfferId FROM bidding_offer WHERE iBiddingPostId = '" . $data['iBiddingPostId'] . "' ORDER BY IOfferId DESC LIMIT 1)as bo1 SET bo.eStatus = 'Accepted' WHERE bo.IOfferId = bo1.IOfferId");
        }
        return $id;
    }
    public function create_bidding_offer($use, $creDataArr){
        global $obj;
        $id = $obj->MySQLQueryPerform($this->bidding_offer, $creDataArr, 'insert');
        $obj->sql_query("UPDATE " . $this->bidding_request_to_driver . " SET eStatus = 'Reoffer' WHERE iBiddingPostId = '" . $creDataArr['iBiddingPostId'] . "' AND iDriverId = '" . $creDataArr['iDriverId'] . "'");
        return $id;
    }
    public function getBiddingLastAmount($iDriverId, $biddingPostId){
        global $obj;
        $query_4 = "SELECT * FROM $this->bidding_offer WHERE 1 = 1 AND iDriverId = " . $iDriverId . " AND iBiddingPostId = " . $biddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
        return $obj->MySQLSelect($query_4);
    }
    public function updateTaskStatus($iBiddingPostId, $iDriverId, $status){
        global $obj, $LANG_OBJ, $ENABLE_OTP_AFTER_BIDDING, $COMM_MEDIA_OBJ, $REFERRAL_OBJ;
        $biddingPostData = $obj->MySQLSelect("SELECT iUserId FROM bidding_post WHERE iBiddingPostId = '$iBiddingPostId'");
        $userData = $obj->MySQLSelect("SELECT vLang,eDeviceType,iGcmRegId,eAppTerminate,eDebugMode,eHmsDevice FROM register_user WHERE iUserId = '" . $biddingPostData[0]['iUserId'] . "'");
        $driverData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as driverName FROM register_driver WHERE iDriverId = '" . $iDriverId . "'");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userData[0]['vLang'], "1", "");
        $Data_update = $notifiactondata = $final_message = array();
        if($status == "Active"){
            $this->checkWalletBalanceDriver($iBiddingPostId, $iDriverId);
            $this->checkAvailability($iDriverId);
            $this->checkStartingTime($iBiddingPostId, $iDriverId);
            $fOutStandingAmount = GetPassengerOutstandingAmount($biddingPostData[0]['iUserId']);
            if($fOutStandingAmount == 0){
                $Data_update['fOutStandingAmount'] = $fOutStandingAmount;
            }
            $Data_update['dStartDate'] = date('Y-m-d H:i:s');
            if($ENABLE_OTP_AFTER_BIDDING == 'Yes'){
                $Data_update['eAskCodeToUser'] = "Yes";
                $Data_update['vRandomCode'] = $vRandomCode = generateCommonRandom();
                $passangerPhoneCode = $userData[0]['vPhoneCode'];
                $passangervPhone = $userData[0]['vPhone'];
                $DRIVER_TXT = $languageLabelsArr['LBL_PROVIDER'];
                $Data_SMS['OTP'] = $vRandomCode;
                $Data_SMS['DRIVER'] = $DRIVER_TXT;
                $sms_message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("START_TRIP_OTP", $Data_SMS, "", $userData[0]['vLang']);
                $result_sms = $COMM_MEDIA_OBJ->SendSystemSMS($passangervPhone, $passangerPhoneCode, $sms_message_layout);
                $userData[0]['bookerName'] = $userData[0]['vName'] . " " . $userData[0]['vLastName'];
                $Data_Mail['OTP'] = $vRandomCode;
                $Data_Mail['FROMNAME'] = $userData[0]['bookerName'];
                $Data_Mail['EMAIL_NAME'] = $userData[0]['bookerName'];
                $Data_Mail['vEmail'] = $userData[0]['vEmail'];
                $Data_Mail['DRIVER'] = $DRIVER_TXT;
                $sendemail = $COMM_MEDIA_OBJ->SendMailToMember("START_TRIP_OTP", $Data_Mail);
            }
            $alertMsg_db = $languageLabelsArr['LBL_PROVIDER'] . " " . $driverData[0]['driverName'] . " " . $languageLabelsArr['LBL_PROVIDER_ARRIVING_BIDDING_TXT'];
            $final_message['Message'] = "BiddingTaskStarted";
            $final_message['MsgType'] = "BiddingTaskStarted";
        }
        elseif($status == "Arrived"){
            $Data_update['dTaskArrivedDate'] = date('Y-m-d H:i:s');
            $alertMsg_db = $languageLabelsArr['LBL_PROVIDER_ARRIVED_BIDDING_TXT'];
            $final_message['Message'] = "BiddingTaskArrived";
            $final_message['MsgType'] = "BiddingTaskArrived";
        }
        elseif($status == "Ongoing"){
            $Data_update['dTaskStartDate'] = date('Y-m-d H:i:s');
            $alertMsg_db = $languageLabelsArr['LBL_USER_START_TASK_TXT'];
            $final_message['Message'] = "BiddingTaskOngoing";
            $final_message['MsgType'] = "BiddingTaskOngoing";
        }
        elseif($status == "Finished"){
            $Data_update['dTaskEndDate'] = date('Y-m-d H:i:s');
            $alertMsg_db = $languageLabelsArr['LBL_USER_START_END_TXT'];
            $final_message['Message'] = "BiddingTaskFinished";
            $final_message['MsgType'] = "BiddingTaskFinished";
            $Data_update['eStatus'] = "Completed";
        }
        $Data_update['vTaskStatus'] = $status;
        $where = " iBiddingPostId = '$iBiddingPostId'";
        $obj->MySQLQueryPerform($this->biddingPostTable, $Data_update, 'update', $where);
        $obj->sql_query("UPDATE $this->register_driver SET vTaskStatus = '$status', iBiddingPostId = '$iBiddingPostId' WHERE iDriverId = '$iDriverId'");
        $obj->sql_query("UPDATE $this->register_user SET vTaskStatus = '$status', iBiddingPostId = '$iBiddingPostId' WHERE iUserId = '" . $biddingPostData[0]['iUserId'] . "'");
        if($status == "Finished"){
            $REFERRAL_OBJ->CreditReferralAmountBidding($iBiddingPostId);
        }
        $final_message['iBiddingPostId'] = $iBiddingPostId;
        $final_message['time'] = time();
        $final_message['vTitle'] = $alertMsg_db;
        $final_message['eType'] = "Bidding";
        $final_message['tRandomCode'] = time();
        $notifiactondata['eDeviceType'] = $userData[0]['eDeviceType'];
        $notifiactondata['iGcmRegId'] = $userData[0]['iGcmRegId'];
        $notifiactondata['eAppTerminate'] = $userData[0]['eAppTerminate'];
        $notifiactondata['eDebugMode'] = $userData[0]['eDebugMode'];
        $notifiactondata['eHmsDevice'] = $userData[0]['eHmsDevice'];
        $notifiactondata['alertMsg_db'] = $alertMsg_db;
        $notifiactondata['final_message'] = $final_message;
        $notifiactondata['channelName'] = "PASSENGER_" . $biddingPostData[0]['iUserId'];
        $notifiactondata['NOTI_USER_TYPE'] = RN_USER;
        $this->sendNotification($notifiactondata);
        return true;
    }
    public function checkWalletBalanceDriver($iBiddingPostId, $iDriverId){
        global $obj, $tconfig, $LANG_OBJ, $MODULES_OBJ, $WALLET_OBJ;
        $row = $obj->MySQLSelect("SELECT vLang,vCurrencyDriver FROM `register_driver` WHERE iDriverId='" . $iDriverId . "'");
        $lang = $row[0]['vLang'];
        $vCurrency = $row[0]['vCurrencyDriver'];
        if($lang == "" || $lang == NULL){
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
        $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision('General');
        if($enableCommisionDeduct == 'Yes'){
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iDriverId, "Driver");
            $getbiddingFinalAmount = $this->getbiddingFinalAmount($iBiddingPostId);
            $getBiddingPost = $this->getBiddingPost('webservice', $iBiddingPostId);
            $ePaymentOption = $getBiddingPost[0]['ePaymentOption'];
            $fCommissionAmount =($getbiddingFinalAmount * $getBiddingPost[0]['fCommission'])/ 100;
            if(strtolower($ePaymentOption)== "cash"){
                if($fCommissionAmount > $user_available_balance){
                    $returnArr = array();
                    $returnArr['Action'] = "0";
                    $fCommissionAmountdisplay = formateNumAsPerCurrency($fCommissionAmount * $currency[0]['ratio'], $vCurrency);
                    $walletmsg = str_replace("#AMOUNT#", $fCommissionAmountdisplay, $languageLabelsArr['LBL_MAINTAIN_WALLET_BALANCE_BID_MSG']);
                    $returnArr["message"] = $walletmsg;
                    setDataResponse($returnArr);
                }
            }
        }
    }
    public function getbiddingFinalAmount($iBiddingPostId){
        global $obj;
        $query = "SELECT amount FROM $this->bidding_offer WHERE `eStatus` = 'Accepted' AND iBiddingPostId = " . $iBiddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
        $bidding_final_offer = $obj->MySQLSelect($query);
        if(scount($bidding_final_offer)== 0){
            $query = "SELECT fBiddingAmount FROM " . $this->biddingPostTable . " WHERE iBiddingPostId = " . $iBiddingPostId . "";
            $bidding_final_offer = $obj->MySQLSelect($query);
            $bidding_final_offer[0]['amount'] = $bidding_final_offer[0]['fBiddingAmount'];
        }
        $return = $bidding_final_offer[0]['amount'];
        return $return;
    }
    public function checkAvailability($iDriverId){
        global $obj;
        $driverData = $obj->MySQLSelect("SELECT vTripStatus, vTaskStatus FROM register_driver WHERE iDriverId = '$iDriverId'");
        if(in_array($driverData[0]['vTripStatus'], [ 'Active', 'Arrived', 'On Going Trip' ])|| in_array($driverData[0]['vTaskStatus'], [ 'Active', 'Arrived', 'Ongoing', 'Finished' ])){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_START_BIDDING_TASK_VALIDATION_MSG";
            setDataResponse($returnArr);
        }
    }
    public function checkStartingTime($iBiddingPostId, $iDriverId){
        global $obj, $BIDDING_LATER_ACCEPT_BEFORE_INTERVAL, $CONFIG_OBJ;
        $driverData = $obj->MySQLSelect("SELECT vLang FROM register_driver WHERE iDriverId = '$iDriverId'");
        $vDriverLangCode = $driverData[0]['vLang'];
        if(empty($BIDDING_LATER_ACCEPT_BEFORE_INTERVAL)){
            $CONFIG_OBJ->getConfigurations("configurations", "BIDDING_LATER_ACCEPT_BEFORE_INTERVAL");
        }
        $additional_mins = $BIDDING_LATER_ACCEPT_BEFORE_INTERVAL;
        $additional_mins_into_secs = $additional_mins * 60;
        $getBiddingPost = $this->getBiddingPost('webservice', $iBiddingPostId);
        $dBooking_date = $getBiddingPost[0]['dBiddingDate'];
        $currDate = date('Y-m-d H:i:s');
        $datediff = abs(strtotime($dBooking_date)- strtotime($currDate));
        if($datediff > $additional_mins_into_secs){
            if(isset($langLabelArr['LBL_MINUTES_TXT'])){
                $mins = $langLabelArr['LBL_MINUTES_TXT'];
            }
            else {
                $mins = get_value('language_label', 'vValue', 'vLabel', 'LBL_MINUTES_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            if(isset($langLabelArr['LBL_HOURS_TXT'])){
                $hrs = $langLabelArr['LBL_HOURS_TXT'];
            }
            else {
                $hrs = get_value('language_label', 'vValue', 'vLabel', 'LBL_HOURS_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            if(isset($langLabelArr['LBL_RIDE_LATER_START_VALIDATION_TXT'])){
                $LBL_RIDE_LATER_START_VALIDATION_TXT = $langLabelArr['LBL_RIDE_LATER_START_VALIDATION_TXT'];
            }
            else {
                $LBL_RIDE_LATER_START_VALIDATION_TXT = get_value('language_label', 'vValue', 'vLabel', 'LBL_RIDE_LATER_START_VALIDATION_TXT', " and vCode='" . $vDriverLangCode . "'", 'true');
            }
            if($additional_mins <= 60){
                $beforetext = $additional_mins . " " . $mins;
                $message = str_replace('####', $beforetext, $LBL_RIDE_LATER_START_VALIDATION_TXT);
            }
            else {
                $hours = floor($additional_mins / 60);
                $beforetext = $hours . " " . $hrs;
                $message = str_replace('####', $beforetext, $LBL_RIDE_LATER_START_VALIDATION_TXT);
            }
            $returnArr['Action'] = "0";
            $returnArr['message'] = $message;
            setDataResponse($returnArr);
        }
    }
    public function sendNotification($usersData){
        global $EVENT_MSG_OBJ;
        $generalDataArr[] = array('eDeviceType' => $usersData['eDeviceType'], 'deviceToken' => $usersData['iGcmRegId'], 'alertMsg' => $usersData['alertMsg_db'], 'eAppTerminate' => $usersData['eAppTerminate'], 'eDebugMode' => $usersData['eDebugMode'], 'eHmsDevice' => $usersData['eHmsDevice'], 'message' => $usersData['final_message'], 'channelName' => $usersData['channelName']);
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), $usersData['NOTI_USER_TYPE']);
    }
    public function getTaskDetails($iBiddingPostId, $vLang = ""){
        global $obj, $ENABLE_OTP_AFTER_BIDDING, $MODULES_OBJ;
        $bidding_post_data = $obj->MySQLSelect("SELECT bid.isSkipRating,bid.iUserId,bid.iDriverId,bid.eAskCodeToUser,bid.vRandomCode, bid.vBiddingPostNo, bid.vTaskStatus, bid.ePaid, bid.dBiddingDate, bid.iBiddingId, ru.vName, ru.vLastName, ru.iGcmRegId, ru.vPhone, ru.vPhoneCode, ru.vImgName, ua.vLatitude, ua.vLongitude, ua.vAddressType, ua.vServiceAddress, JSON_UNQUOTE(JSON_VALUE(bs.vTitle, '$.vTitle_" . $vLang . "'))as vTitle FROM $this->biddingPostTable as bid LEFT JOIN $this->register_user as ru ON ru.iUserId = bid.iUserId LEFT JOIN user_address as ua ON ua.iUserAddressId = bid.iAddressId LEFT JOIN $this->tablename as bs ON bs.iBiddingId = bid.iBiddingId WHERE bid.iBiddingPostId = '$iBiddingPostId'");
        $returnArr = array();
        $returnArr['vName'] = $bidding_post_data[0]['vName'];
        $returnArr['vLastName'] = $bidding_post_data[0]['vLastName'];
        $returnArr['vAvgRating'] = $this->getAvgRating($bidding_post_data[0]['iUserId'], 'Passenger');
        $returnArr['iUserId'] = $bidding_post_data[0]['iUserId'];
        $returnArr['iGcmRegId'] = $bidding_post_data[0]['iGcmRegId'];
        $returnArr['vPhone'] = $bidding_post_data[0]['vPhone'];
        $returnArr['vPhoneCode'] = $bidding_post_data[0]['vPhoneCode'];
        $returnArr['vImgName'] = $bidding_post_data[0]['vImgName'];
        $returnArr['sourceLatitude'] = $bidding_post_data[0]['vLatitude'];
        $returnArr['sourceLongitude'] = $bidding_post_data[0]['vLongitude'];
        $returnArr['tSaddress'] = !empty($bidding_post_data[0]['vAddressType'])? $bidding_post_data[0]['vAddressType'] . "\n" . $bidding_post_data[0]['vServiceAddress'] : $bidding_post_data[0]['vServiceAddress'];
        $returnArr['eType'] = "Bidding";
        $returnArr['iBiddingPostId'] = $iBiddingPostId;
        $returnArr['vBiddingPostNo'] = $bidding_post_data[0]['vBiddingPostNo'];
        $returnArr['ePaymentCollect'] = $bidding_post_data[0]['ePaid'];
        $returnArr['dBiddingDate'] = $bidding_post_data[0]['dBiddingDate'];
        $returnArr['isSkipRating'] = $bidding_post_data[0]['isSkipRating'];
        if($ENABLE_OTP_AFTER_BIDDING == 'Yes'){
            if($bidding_post_data[0]['vTaskStatus'] == 'Ongoing'){
                $returnArr['eAskCodeToUser'] = $bidding_post_data[0]['eAskCodeToUser'];
            }
            $returnArr['vText'] =(!empty($bidding_post_data[0]['vRandomCode']))? encodeVerificationCode($bidding_post_data[0]['vRandomCode']): "";
        }
        $returnArr['vServiceName'] = $this->getServiceTitle('webservice', $bidding_post_data[0]['iBiddingId'], $bidding_post_data[0]['vTitle'], $vLang);
        if($bidding_post_data[0]['vTaskStatus'] == "Finished"){
            $returnArr['Ratings_From_Driver'] = "Not Done";
            if($this->checkRatingDone($bidding_post_data[0]['iDriverId'], 'Driver', $iBiddingPostId)){
                $returnArr['Ratings_From_Driver'] = "Done";
            }
        }
        if($bidding_post_data[0]['isSkipRating'] == 'Yes' && $MODULES_OBJ->isEnableSkipRatingRide()){
            $returnArr['Ratings_From_Driver'] = "Done";
        }
        return $returnArr;
    }
    public function getServiceTitle($use, $iBiddingId, $vTitle, $lang){
        $iBiddingId = explode(',', $iBiddingId);
        $_title = $vTitle;
        if(scount($iBiddingId)> 1){
            $getbidding_ = $this->getbidding('webservice', $iBiddingId, $lang);
            $vtitle_ = $this->multiToSingle($getbidding_, 'vCategory');
            $_title = implode(',', $vtitle_);
        }
        return $_title;
    }
    private function checkRatingDone($iMemberId, $UserType, $iBiddingPostId){
        global $obj;
        $check_rating = $obj->MySQLSelect("SELECT iRatingId FROM bidding_service_ratings WHERE eFromUserType = '$UserType' AND iBiddingPostId = '$iBiddingPostId'");
        if(!empty($check_rating)&& scount($check_rating)> 0){
            return true;
        }
        return false;
    }
    public function getDriverTaskDetails($iBiddingPostId){
        global $obj, $LANG_OBJ,$ENABLE_24_HOUR_FORMAT,$DATE_FORMAT_OBJ;
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : '';
        $Data = array();
        $sql = "SELECT ru.iUserId,ru.vImgName as riderImage,concat(ru.vName,' ',ru.vLastName)as riderName, ru.vPhoneCode ,ru.vPhone as riderMobile,ru.vTaskStatus as driverStatus,bid.vBiddingPostNo, bid.iDriverId, bid.vContactName, bid.vTaskStatus,bid.dAddedDate,bid.dConfirmDate,bid.dStartDate, bid.dTaskStartDate, bid.dTaskArrivedDate, bid.dTaskEndDate, ua.vAddressType,ua.vServiceAddress FROM bidding_post as bid LEFT JOIN register_user as ru ON ru.iUserId=bid.iUserId LEFT JOIN user_address as ua ON ua.iUserAddressId = bid.iAddressId WHERE bid.iBiddingPostId = '" . $iBiddingPostId . "'";
        $dataUser = $obj->MySQLSelect($sql);
        $dataUser[0]['tSaddress'] = !empty($dataUser[0]['vAddressType'])? $dataUser[0]['vAddressType'] . "\n" . $dataUser[0]['vServiceAddress'] : $dataUser[0]['vServiceAddress'];
        $dataUser[0]['riderRating'] = $this->getAvgRating($dataUser[0]['iUserId'], 'Passenger');
        $Data['driverDetails'] = $dataUser[0];
        $vLangCode = get_value('register_driver', 'vLang', 'iDriverId', $dataUser[0]['iDriverId'], '', 'true');
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $lbl_at = $languageLabelsArr['LBL_AT_GENERAL'];
        $lbl_minago = $languageLabelsArr['LBL_MIN_AGO'];
        $Driver_Task_Posted = $languageLabelsArr['LBL_USER_BID_POST_TXT'];
        $Driver_Accept_Request = $languageLabelsArr['LBL_PROVIDER_ACCEPTED_TASK_SELF_TXT'];
        $Driver_Confirm_Request = $languageLabelsArr['LBL_PROVIDER_CONFIRMED_TASK_TXT'];
        $Driver_Arrived_Pick_Location = $languageLabelsArr['LBL_PROVIDER_ARRIVED_SERVICE_LOCATION_SELF_TXT'];
        $Driver_Start_job = $languageLabelsArr['LBL_PROVIDER_START_TASK_BIDDING_SELF_TXT'];
        $Driver_Finished_job = $languageLabelsArr['LBL_PROVIDER_FINISHED_TASK_SELF_TXT'];
        $testBool = 1;
        if(scount($dataUser)> 0){
            $Data['States'] = array();
            $Data_dAddedDate = $dataUser[0]['dAddedDate'];
            $Data_dAddedDate_convert = $dataUser[0]['dAddedDate'];
            $Data_dConfirmDate = $dataUser[0]['dConfirmDate'];
            $Data_dConfirmDate_convert = $dataUser[0]['dConfirmDate'];
            $Data_dStartDate = $dataUser[0]['dStartDate'];
            $Data_dStartDate_convert = $dataUser[0]['dStartDate'];
            $Data_dTaskArrivedDate = $dataUser[0]['dTaskArrivedDate'];
            $Data_dTaskArrivedDate_convert = $dataUser[0]['dTaskArrivedDate'];
            $Data_dTaskStartDate = $dataUser[0]['dTaskStartDate'];
            $Data_dTaskStartDate_convert = $dataUser[0]['dTaskStartDate'];
            $Data_dTaskEndDate = $dataUser[0]['dTaskEndDate'];
            $Data_dTaskEndDate_convert = $dataUser[0]['dTaskEndDate'];
            if(!empty($vTimeZone)){
                if($Data_dAddedDate != "" && $Data_dAddedDate != "0000-00-00 00:00:00"){
                    $Data_dAddedDate_convert = converToTz($Data_dAddedDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dConfirmDate != "" && $Data_dConfirmDate != "0000-00-00 00:00:00"){
                    $Data_dConfirmDate_convert = converToTz($Data_dConfirmDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dStartDate != "" && $Data_dStartDate != "0000-00-00 00:00:00"){
                    $Data_dStartDate_convert = converToTz($Data_dStartDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskArrivedDate != "" && $Data_dTaskArrivedDate != "0000-00-00 00:00:00"){
                    $Data_dTaskArrivedDate_convert = converToTz($Data_dTaskArrivedDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskStartDate != "" && $Data_dTaskStartDate != "0000-00-00 00:00:00"){
                    $Data_dTaskStartDate_convert = converToTz($Data_dTaskStartDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskEndDate != "" && $Data_dTaskEndDate != "0000-00-00 00:00:00"){
                    $Data_dTaskEndDate_convert = converToTz($Data_dTaskEndDate_convert, $vTimeZone, date_default_timezone_get());
                }
            }
            $i = 0;
            if($Data_dAddedDate != "" && $Data_dAddedDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Task_Posted;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dAddedDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dAddedDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dAddedDate_convert;
                $date_data_array = array('tdate' => $Data_dAddedDate_convert, 'langCode' => $vLangCode);
                $getDriverTaskAddedDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverTaskAddedDateFormat)){
                    foreach($getDriverTaskAddedDateFormat as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dAddedDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Added";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dStartDate != "" && $Data_dStartDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Accept_Request;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dStartDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dStartDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dStartDate_convert;
                $date_data_array = array('tdate' => $Data_dStartDate_convert, 'langCode' => $vLangCode);
                $getDriverTaskStartDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverTaskStartDateFormat)){
                    foreach($getDriverTaskStartDateFormat as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dStartDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Accept";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dConfirmDate != "" && $Data_dConfirmDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Confirm_Request;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dConfirmDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dConfirmDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dConfirmDate_convert;
                $date_data_array = array('tdate' => $Data_dConfirmDate_convert, 'langCode' => $vLangCode);
                $getDriverTaskConfirmDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverTaskConfirmDateFormat)){
                    foreach($getDriverTaskConfirmDateFormat as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dConfirmDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Confirm";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskArrivedDate != "" && $Data_dTaskArrivedDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Arrived_Pick_Location;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskArrivedDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskArrivedDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskArrivedDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskArrivedDate_convert, 'langCode' => $vLangCode);
                $getDriverTaskArrivedDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverTaskArrivedDateFormat)){
                    foreach($getDriverTaskArrivedDateFormat as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskArrivedDate_convert)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Arrived";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskStartDate != "" && $Data_dTaskStartDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Start_job;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskStartDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskStartDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskStartDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskStartDate_convert, 'langCode' => $vLangCode);
                $getDriverTaskDateFormatForStart = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverTaskDateFormatForStart)){
                    foreach($getDriverTaskDateFormatForStart as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskStartDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Ongoing";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskEndDate != "" && $Data_dTaskEndDate != "0000-00-00 00:00:00" && $testBool == 1 && $dataUser[0]['vTaskStatus'] == "Finished"){
                $Data['States'][$i]['text'] = $Driver_Finished_job;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskEndDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskEndDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskEndDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskEndDate_convert, 'langCode' => $vLangCode);
                $getDriverEndTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getDriverEndTaskDateFormat)){
                    foreach($getDriverEndTaskDateFormat as $driver_task_datetime_key => $driver_task_datetime_val){
                        $Data['States'][$i][$driver_task_datetime_key] = $driver_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskEndDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Finished";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
        }
        else {
            $Data['States'] = array();
        }
        return $Data;
    }
    public function getUserTaskDetails($iBiddingPostId){
        global $obj, $LANG_OBJ, $tconfig, $ENABLE_OTP_AFTER_BIDDING,$ENABLE_24_HOUR_FORMAT,$DATE_FORMAT_OBJ;
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : '';
        $sql = "SELECT bid.eAskCodeToUser,bid.vRandomCode,rd.iDriverId,rd.vImage as driverImage,concat(rd.vName,' ',rd.vLastName)as driverName, rd.vCode ,rd.vPhone as driverMobile,rd.vTaskStatus as driverStatus, rd.vImage, bid.iUserId, bid.vBiddingPostNo, bid.vContactName, bid.vTaskStatus,bid.dAddedDate,bid.dConfirmDate,bid.dStartDate, bid.dTaskStartDate, bid.dTaskArrivedDate, bid.dTaskEndDate, ua.vAddressType,ua.vServiceAddress FROM bidding_post as bid LEFT JOIN register_driver as rd ON rd.iDriverId=bid.iDriverId LEFT JOIN user_address as ua ON ua.iUserAddressId = bid.iAddressId WHERE bid.iBiddingPostId = '" . $iBiddingPostId . "'";
        $dataUser = $obj->MySQLSelect($sql);
        $dataUser[0]['tSaddress'] = !empty($dataUser[0]['vAddressType'])? $dataUser[0]['vAddressType'] . "\n" . $dataUser[0]['vServiceAddress'] : $dataUser[0]['vServiceAddress'];
        $dataUser[0]['driverImage'] = !empty($dataUser[0]['vImage'])? $tconfig["tsite_upload_images_driver"] . "/" . $dataUser[0]['iDriverId'] . "/2_" . $dataUser[0]['vImage'] : "";
        $dataUser[0]['driverRating'] = $this->getAvgRating($dataUser[0]['iDriverId'], 'Driver');
        $Data['driverDetails'] = $dataUser[0];
        $vLangCode = get_value('register_user', 'vLang', 'iUserId', $dataUser[0]['iUserId'], '', 'true');
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $lbl_at = $languageLabelsArr['LBL_AT_GENERAL'];
        $lbl_minago = $languageLabelsArr['LBL_MIN_AGO'];
        $Driver_Task_Posted = $languageLabelsArr['LBL_USER_BID_POST_SELF_TXT'];
        $Driver_Accept_Request = $languageLabelsArr['LBL_PROVIDER_ACCEPTED_TASK_TXT'];
        $Driver_Confirm_Request = $languageLabelsArr['LBL_PROVIDER_CONFIRMED_TASK_SELF_TXT'];
        $Driver_Arrived_Pick_Location = $languageLabelsArr['LBL_PROVIDER_ARRIVED_SERVICE_LOCATION_TXT'];
        $Driver_Start_job = $languageLabelsArr['LBL_PROVIDER_START_TASK_BIDDING_TXT'];
        $Driver_Finished_job = $languageLabelsArr['LBL_PROVIDER_FINISHED_TASK_TXT'];
        if($ENABLE_OTP_AFTER_BIDDING == 'Yes'){
            $Driver_Start_job = $Driver_Start_job . $languageLabelsArr['LBL_YOUR_TRIP_OTP_TXT'] . ' : ' . $dataUser[0]['vRandomCode'];
        }
        $testBool = 1;
        if(scount($dataUser)> 0){
            $Data['States'] = array();
            $Data_dAddedDate = $dataUser[0]['dAddedDate'];
            $Data_dAddedDate_convert = $dataUser[0]['dAddedDate'];
            $Data_dConfirmDate = $dataUser[0]['dConfirmDate'];
            $Data_dConfirmDate_convert = $dataUser[0]['dConfirmDate'];
            $Data_dStartDate = $dataUser[0]['dStartDate'];
            $Data_dStartDate_convert = $dataUser[0]['dStartDate'];
            $Data_dTaskArrivedDate = $dataUser[0]['dTaskArrivedDate'];
            $Data_dTaskArrivedDate_convert = $dataUser[0]['dTaskArrivedDate'];
            $Data_dTaskStartDate = $dataUser[0]['dTaskStartDate'];
            $Data_dTaskStartDate_convert = $dataUser[0]['dTaskStartDate'];
            $Data_dTaskEndDate = $dataUser[0]['dTaskEndDate'];
            $Data_dTaskEndDate_convert = $dataUser[0]['dTaskEndDate'];
            if(!empty($vTimeZone)){
                if($Data_dAddedDate != "" && $Data_dAddedDate != "0000-00-00 00:00:00"){
                    $Data_dAddedDate_convert = converToTz($Data_dAddedDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dConfirmDate != "" && $Data_dConfirmDate != "0000-00-00 00:00:00"){
                    $Data_dConfirmDate_convert = converToTz($Data_dConfirmDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dStartDate != "" && $Data_dStartDate != "0000-00-00 00:00:00"){
                    $Data_dStartDate_convert = converToTz($Data_dStartDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskArrivedDate != "" && $Data_dTaskArrivedDate != "0000-00-00 00:00:00"){
                    $Data_dTaskArrivedDate_convert = converToTz($Data_dTaskArrivedDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskStartDate != "" && $Data_dTaskStartDate != "0000-00-00 00:00:00"){
                    $Data_dTaskStartDate_convert = converToTz($Data_dTaskStartDate_convert, $vTimeZone, date_default_timezone_get());
                }
                if($Data_dTaskEndDate != "" && $Data_dTaskEndDate != "0000-00-00 00:00:00"){
                    $Data_dTaskEndDate_convert = converToTz($Data_dTaskEndDate_convert, $vTimeZone, date_default_timezone_get());
                }
            }
            $i = 0;
            if($Data_dAddedDate != "" && $Data_dAddedDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Task_Posted;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dAddedDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dAddedDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dAddedDate_convert;
                $date_data_array = array('tdate' => $Data_dAddedDate_convert, 'langCode' => $vLangCode);
                $getUserAddedTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getUserAddedTaskDateFormat)){
                    foreach($getUserAddedTaskDateFormat as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dAddedDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Added";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dStartDate != "" && $Data_dStartDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Accept_Request;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dStartDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dStartDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dStartDate_convert;
                $date_data_array = array('tdate' => $Data_dStartDate_convert, 'langCode' => $vLangCode);
                $getStartUserTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getStartUserTaskDateFormat)){
                    foreach($getStartUserTaskDateFormat as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dStartDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Accept";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dConfirmDate != "" && $Data_dConfirmDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Confirm_Request;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dConfirmDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dConfirmDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dConfirmDate_convert;
                $date_data_array = array('tdate' => $Data_dConfirmDate_convert, 'langCode' => $vLangCode);
                $getConfirmUserTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getConfirmUserTaskDateFormat)){
                    foreach($getConfirmUserTaskDateFormat as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dConfirmDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Confirm";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskArrivedDate != "" && $Data_dTaskArrivedDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Arrived_Pick_Location;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskArrivedDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskArrivedDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskArrivedDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskArrivedDate_convert, 'langCode' => $vLangCode);
                $getUserArrivedTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getUserArrivedTaskDateFormat)){
                    foreach($getUserArrivedTaskDateFormat as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskArrivedDate_convert)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Arrived";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskStartDate != "" && $Data_dTaskStartDate != "0000-00-00 00:00:00" && $testBool == 1){
                $Data['States'][$i]['text'] = $Driver_Start_job;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskStartDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskStartDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskStartDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskStartDate_convert, 'langCode' => $vLangCode);
                $getUserTaskDateFormatStartDate = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getUserTaskDateFormatStartDate)){
                    foreach($getUserTaskDateFormatStartDate as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskStartDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Ongoing";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
            else {
                $testBool = 0;
            }
            if($Data_dTaskEndDate != "" && $Data_dTaskEndDate != "0000-00-00 00:00:00" && $testBool == 1 && $dataUser[0]['vTaskStatus'] == "Finished"){
                $Data['States'][$i]['text'] = $Driver_Finished_job;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $Data['States'][$i]['time'] = date("H:i", strtotime($Data_dTaskEndDate_convert));
                }
                else {
                    $Data['States'][$i]['time'] = date("h:i A", strtotime($Data_dTaskEndDate_convert));
                }
                $Data['States'][$i]['dateOrig'] = $Data_dTaskEndDate_convert;
                $date_data_array = array('tdate' => $Data_dTaskEndDate_convert, 'langCode' => $vLangCode);
                $getUserEndTaskDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                if(!empty($getUserEndTaskDateFormat)){
                    foreach($getUserEndTaskDateFormat as $user_task_datetime_key => $user_task_datetime_val){
                        $Data['States'][$i][$user_task_datetime_key] = $user_task_datetime_val;
                    }
                }
                $Data['States'][$i]['timediff'] = @round(abs(strtotime($Data_dTaskEndDate)- strtotime(date("Y-m-d H:i:s")))/ 60, 0). " " . $lbl_minago;
                $Data['States'][$i]['type'] = "Finished";
                $Data['States'][$i]['eType'] = "Bidding";
                $i++;
            }
        }
        else {
            $Data['States'] = array();
        }
        return $Data;
    }
    public function getFareDetails($iBiddingPostId, $iMemberId, $GeneralUserType, $use = "", $PAGE_MODE = "History"){
        global $ENABLE_TAX_FOR_BIDDING_SERVICE, $obj, $LANG_OBJ, $tconfig, $WALLET_OBJ,$DATE_FORMAT_OBJ;
        if($use == 'user'){
            $vlang = $_SESSION['sess_lang'];
            $getBiddingPost = $this->getBiddingPost('webservice', $iBiddingPostId, '', $vlang);
        }
        else {
            $getBiddingPost = $this->getBiddingPost('webservice', $iBiddingPostId, '');
        }
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : $getBiddingPost[0]['vTimeZone'];
        $serverTimeZone = date_default_timezone_get();
        $sql = "SELECT amount FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Accepted' AND iBiddingPostId = " . $iBiddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
        $bidding_final_offer = $obj->MySQLSelect($sql);
        if(empty($bidding_final_offer)){
            $bidding_final_offer[0]['amount'] = $getBiddingPost[0]['fBiddingAmount'];
        }
        $total_fare = $bidding_final_offer[0]['amount'];
        $fTax1 = $getBiddingPost[0]['fTax1'];
        $fTax2 = $getBiddingPost[0]['fTax2'];
        $fTax1Percentage = $getBiddingPost[0]['fTax1Percentage'];
        $fTax2Percentage = $getBiddingPost[0]['fTax2Percentage'];
        if($ENABLE_TAX_FOR_BIDDING_SERVICE == "Yes"){
            $total_fare = $total_fare + $fTax1 + $fTax2;
        }
        $fWalletDebit = 0;
        if($GeneralUserType == "Driver"){
            $row = $obj->MySQLSelect("SELECT vLang, vCurrencyDriver, vEmail FROM `register_driver` WHERE iDriverId='$iMemberId'");
            $vCurrency = $row[0]['vCurrencyDriver'];
            $lang = $row[0]['vLang'];
            $vEmail = $row[0]['vEmail'];
        }
        else {
            $row = $obj->MySQLSelect("SELECT vLang, vCurrencyPassenger, vEmail FROM `register_user` WHERE iUserId='$iMemberId'");
            $lang = $row[0]['vLang'];
            $vCurrency = $row[0]['vCurrencyPassenger'];
            $vEmail = $row[0]['vEmail'];
        }
        if($use == 'user'){
            $lang = $_SESSION['sess_lang'];
        }
        $user_wallet_debit_amount = 0;
        $eWalletDebitAllow = $getBiddingPost[0]['eWalletDebit'];
        $tUserWalletBalance = $getBiddingPost[0]['tUserWalletBalance'];
        if($eWalletDebitAllow == "Yes"){
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($getBiddingPost[0]['iUserId'], "Rider");
            if($user_available_balance > 0){
                $totalCurrentActiveTripsArr = FetchTotalOngoingTrips($iMemberId);
                $totalCurrentActiveTripsIdsArr = $totalCurrentActiveTripsArr['ActiveTripIds'];
                $totalCurrentActiveOrderIdsArr = $totalCurrentActiveTripsArr['ActiveOrderIds'];
                $totalCurrentActiveBidIdsArr = $totalCurrentActiveTripsArr['ActiveBidIds'];
                $totalCurrentActiveTripsCount = $totalCurrentActiveTripsArr['TotalCount'];
                if(($totalCurrentActiveTripsCount > 1 || in_array($iBiddingPostId, $totalCurrentActiveBidIdsArr)== false)&& $ePaymentOption == "Wallet" && $tUserWalletBalance > 0){
                    $user_available_balance = $tUserWalletBalance;
                }
                $wallet_fare = $total_fare;
                $total_fare = 0;
                if($wallet_fare > $user_available_balance){
                    $user_wallet_debit_amount = $user_available_balance;
                }
                else {
                    $user_wallet_debit_amount = $wallet_fare;
                    $total_fare = 0;
                }
            }
            $fWalletDebit = $user_wallet_debit_amount;
        }
        $fWalletDebit = $getBiddingPost[0]['fWalletDebit'] > 0 ? $getBiddingPost[0]['fWalletDebit'] : $fWalletDebit;
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $vTitle = $this->getServiceTitle('webservice', $getBiddingPost[0]['iBiddingId'], $getBiddingPost[0]['vTitle'], $lang);
        $fOutStandingAmount = $getBiddingPost[0]['fOutStandingAmount'];
        $fCommission = round((($bidding_final_offer[0]['amount'] * $getBiddingPost[0]['fCommission'])/ 100), 2);
        $bidding_final_offer_amount = $bidding_final_offer[0]['amount'];
        if($ENABLE_TAX_FOR_BIDDING_SERVICE == "Yes"){
            $bidding_final_offer_amount = $bidding_final_offer_amount + $fTax1 + $fTax2;
        }
        if($GeneralUserType == "Driver"){
            if($PAGE_MODE == "History"){
                $Subtotal =($bidding_final_offer_amount -($fCommission + $fTax1 + $fTax2))+ $fOutStandingAmount;
            }
            else {
                $Subtotal =($bidding_final_offer_amount - $fWalletDebit)+ $fOutStandingAmount;
            }
        }
        else {
            $Subtotal =($bidding_final_offer_amount - $fWalletDebit)+ $fOutStandingAmount;
        }
        $Subtotal_member = $Subtotal * $currency[0]['ratio'];
        $Subtotal_member =($Subtotal_member > 0)? $Subtotal_member : 0;
        $return_arr = array();
        $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_BIDDING_FINAL_AMOUNT']] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
        if($GeneralUserType == "Driver"){
            if($PAGE_MODE == "Display"){
                if($fTax1 > 0){
                    $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                    $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX1_TXT'] . " @ " . $fTax1Percentage . " % "] = formateNumAsPerCurrency($fTax1 * $currency[0]['ratio'], $vCurrency);
                }
                if($fTax2 > 0){
                    $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                    $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX2_TXT'] . " @ " . $fTax2Percentage . " % "] = formateNumAsPerCurrency($fTax2 * $currency[0]['ratio'], $vCurrency);
                }
            }
        }
        else {
            if($fTax1 > 0){
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX1_TXT'] . " @ " . $fTax1Percentage . " % "] = formateNumAsPerCurrency($fTax1 * $currency[0]['ratio'], $vCurrency);
            }
            if($fTax2 > 0){
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX2_TXT'] . " @ " . $fTax2Percentage . " % "] = formateNumAsPerCurrency($fTax2 * $currency[0]['ratio'], $vCurrency);
            }
        }
        if($fOutStandingAmount > 0){
            $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_OUTSTANDING_AMOUNT_TXT']] = formateNumAsPerCurrency($fOutStandingAmount * $currency[0]['ratio'], $vCurrency);
        }
        if($GeneralUserType == "Driver"){
            if($fWalletDebit > 0 && $PAGE_MODE == "Display"){
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_WALLET_ADJUSTMENT']] = "-" . formateNumAsPerCurrency($fWalletDebit * $currency[0]['ratio'], $vCurrency);
            }
        }
        else {
            if($fWalletDebit > 0){
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_WALLET_ADJUSTMENT']] = "-" . formateNumAsPerCurrency($fWalletDebit * $currency[0]['ratio'], $vCurrency);
            }
        }
        if($fCommission > 0 && $GeneralUserType == "Driver" && $PAGE_MODE == "History"){
            $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_Commission']] = "-" . formateNumAsPerCurrency($fCommission * $currency[0]['ratio'], $vCurrency);
        }
        if($GeneralUserType == "Driver"){
            if($PAGE_MODE == "Display"){
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][]['Subtotal'] = formateNumAsPerCurrency($Subtotal_member, $vCurrency);
            }
            else {
                $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
                $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_EARNED_AMOUNT']] = formateNumAsPerCurrency($Subtotal_member, $vCurrency);
            }
        }
        else {
            $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
            $return_arr['FareDetailsNewArr'][]['Subtotal'] = formateNumAsPerCurrency($Subtotal_member, $vCurrency);
        }
        $return_arr['FareSubTotal'] = formateNumAsPerCurrency($Subtotal_member, $vCurrency);
        $return_arr['vBiddingPostNo'] = $getBiddingPost[0]['vBiddingPostNo'];
        if($getBiddingPost[0]['dStartDate'] == "0000-00-00 00:00:00" && !empty($vTimeZone)){
            $return_arr['dBiddingDate'] = converToTz($getBiddingPost[0]['dBiddingDate'], $vTimeZone,$serverTimeZone);
        }
        else {
            $return_arr['dBiddingDate'] = converToTz($getBiddingPost[0]['dStartDate'],$vTimeZone,$serverTimeZone);
        }
        $date_data_array = array('tdate' => $return_arr['dBiddingDate'], 'langCode' => $vlang);
        $getFareDateFormat = DateformatCls::getNewDateFormat($date_data_array);
        foreach($getFareDateFormat as $fare_datetime_key => $fare_datetime_val){
            $return_arr[$fare_datetime_key] = $fare_datetime_val;
        }
        $return_arr['tSaddress'] = $getBiddingPost[0]['vServiceAddress'];
        $return_arr['vServiceDetailTitle'] = isset($vTitle)? $vTitle : '';
        $return_arr['vBiddingPaymentMode'] = $getBiddingPost[0]['ePaymentOption'];
        $return_arr['vTaskStatus'] = $getBiddingPost[0]['vTaskStatus'];
        $return_arr['eStatus'] = $getBiddingPost[0]['eStatus'];
        $return_arr['ePayWallet'] = $getBiddingPost[0]['ePaymentOption'] == "Wallet" ? "Yes" : "No";
        $return_arr['fWalletAmountAdjusted'] = formateNumAsPerCurrency($fWalletDebit * $currency[0]['ratio'], $vCurrency);
        $return_arr['userlang'] = $lang;
        $return_arr['usercurrency'] = $vCurrency;
        $return_arr['userEmail'] = $vEmail;
        $return_arr['eWalletAmtAdjusted'] = "No";
        if($eWalletDebitAllow == "Yes"){
            $return_arr['eWalletAmtAdjusted'] = "Yes";
        }
        if($Subtotal > 0 && $return_arr['ePayWallet'] == "Yes"){
            $return_arr['ePayWallet'] = "No";
        }
        if($getBiddingPost[0]['eStatus'] == "Cancelled"){
            $return_arr['vCancelReason'] = $getBiddingPost[0]['iCancelReasonId'] > 0 ? $this->getCancelReason($getBiddingPost[0]['iCancelReasonId'], $lang): $getBiddingPost[0]['vCancelReason'];
            $return_arr['eCancelledBy'] = $getBiddingPost[0]['eCancelBy'] == "User" ? $languageLabelsArr['LBL_RIDER'] : $languageLabelsArr['LBL_PROVIDER'];
        }
        if($GeneralUserType == "Passenger"){
            $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as driverName, vImage FROM register_driver WHERE iDriverId = '" . $getBiddingPost[0]['iDriverId'] . "' ");
            if(!empty($userData)){
                $return_arr['driverAvgRating'] = $this->getAvgRating($getBiddingPost[0]['iDriverId'], 'Driver');
                $return_arr['driverName'] = $userData[0]['driverName'];
                $return_arr['driverImage'] = $tconfig["tsite_upload_images_driver"] . "/" . $getBiddingPost[0]['iDriverId'] . "/2_" . $userData[0]['vImage'];
                $return_arr['is_rating'] =($this->checkRatingDone($iMemberId, "Passenger", $iBiddingPostId))? "Yes" : "No";
            }
            $TripRatingData = $this->getBiddingRating("Passenger", $iBiddingPostId);
        }
        else {
            $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName, vImgName FROM register_user WHERE iUserId = '" . $getBiddingPost[0]['iUserId'] . "' ");
            $return_arr['userAvgRating'] = $this->getAvgRating($getBiddingPost[0]['iUserId'], 'Passenger');
            $return_arr['userName'] = $userData[0]['userName'];
            $return_arr['userImage'] = $tconfig['tsite_upload_images_passenger'] . "/" . $getBiddingPost[0]['iUserId'] . "/" . $userData[0]['vImgName'];
            $return_arr['is_rating'] =($this->checkRatingDone($iMemberId, "Driver", $iBiddingPostId))? "Yes" : "No";
            $TripRatingData = $this->getBiddingRating("Driver", $iBiddingPostId);
        }
        $return_arr['TripRating'] = 0;
        if(!empty($TripRatingData)&& scount($TripRatingData)> 0){
            $return_arr['TripRating'] = $TripRatingData[0]['fRating'];
        }
        $return_arr['iBiddingPostId'] = $iBiddingPostId;
        $returnArr['Action'] = "1";
        $returnArr['message'] = $return_arr;
        if($use == 'mail' || $use == 'user'){
            return $return_arr;
        }
        setDataResponse($returnArr);
    }
    public function getBiddingRating($UserType, $iBiddingPostId){
        global $obj;
        $check_rating = $obj->MySQLSelect("SELECT fRating FROM bidding_service_ratings WHERE eFromUserType = '$UserType' AND iBiddingPostId = '$iBiddingPostId'");
        return $check_rating;
    }
    public function collectPayment($iBiddingPostId, $iDriverId){
        global $ENABLE_TAX_FOR_BIDDING_SERVICE,$obj, $WALLET_OBJ, $APP_PAYMENT_METHOD, $EVENT_MSG_OBJ, $LANG_OBJ, $EXTRA_MONEY_CASH_OR_OUTSTANDING, $MODULES_OBJ, $OPTIMIZE_DATA_OBJ;
        $bidding_post_data = $obj->MySQLSelect("SELECT fTax2,fTax1,iUserId, ePaymentOption, eWalletDebit, vBiddingPostNo, iPaymentInfoId, tUserWalletBalance, fOutStandingAmount,fCommission FROM bidding_post WHERE iBiddingPostId = '$iBiddingPostId'");
        $ePaymentOption = $bidding_post_data[0]['ePaymentOption'];
        $eWalletDebitAllow = $bidding_post_data[0]['eWalletDebit'];
        $iUserId = $bidding_post_data[0]['iUserId'];
        $vBiddingPostNo = $bidding_post_data[0]['vBiddingPostNo'];
        $fCommission = $bidding_post_data[0]['fCommission'];
        $tUserWalletBalance = $bidding_post_data[0]['tUserWalletBalance'];
        $fOutStandingAmount = $bidding_post_data[0]['fOutStandingAmount'];
        $fTax2 = $bidding_post_data[0]['fTax2'];
        $fTax1 = $bidding_post_data[0]['fTax1'];
        $isCollectCash = isset($_REQUEST['isCollectCash'])? $_REQUEST['isCollectCash'] : '';
        $getbiddingFinalAmount = $this->getbiddingFinalAmount($iBiddingPostId);
        $total_fare = $getbiddingFinalAmount + $fOutStandingAmount;
        if(strtoupper($ENABLE_TAX_FOR_BIDDING_SERVICE)== 'YES'){
            $total_fare = $total_fare + $fTax2+ $fTax1;
        }
        $userData = $obj->MySQLSelect("SELECT vCountry, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vLang, eHmsDevice FROM register_user WHERE iUserId='$iUserId'");
        $vLangCode = $userData[0]['vLang'];
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $countryPaymentMethod = $obj->MySQLSelect("SELECT vPaymentGateway FROM country WHERE vCountryCode = '" . $userData[0]['vCountry'] . "'");
        $USER_APP_PAYMENT_METHOD = $APP_PAYMENT_METHOD;
        if(!empty($countryPaymentMethod[0]['vPaymentGateway'])){
            $USER_APP_PAYMENT_METHOD = $countryPaymentMethod[0]['vPaymentGateway'];
        }
        $TOKENIZED_STATUS = strtoupper($USER_APP_PAYMENT_METHOD). '_TOKENIZED';
        global $$TOKENIZED_STATUS;
        $IS_TOKENIZED = $$TOKENIZED_STATUS;
        $user_wallet_debit_amount = 0;
        if($eWalletDebitAllow == "Yes"){
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iUserId, "Rider");
            if($user_available_balance > 0){
                $totalCurrentActiveTripsArr = FetchTotalOngoingTrips($iUserId);
                $totalCurrentActiveTripsIdsArr = $totalCurrentActiveTripsArr['ActiveTripIds'];
                $totalCurrentActiveOrderIdsArr = $totalCurrentActiveTripsArr['ActiveOrderIds'];
                $totalCurrentActiveBidIdsArr = $totalCurrentActiveTripsArr['ActiveBidIds'];
                $totalCurrentActiveTripsCount = $totalCurrentActiveTripsArr['TotalCount'];
                if(($totalCurrentActiveTripsCount > 1 || in_array($iBiddingPostId, $totalCurrentActiveBidIdsArr)== false)&& $ePaymentOption == "Wallet" && $tUserWalletBalance > 0){
                    $user_available_balance = $tUserWalletBalance;
                }
                $wallet_fare = $total_fare;
                $total_fare = 0;
                if($wallet_fare > $user_available_balance){
                    $user_wallet_debit_amount = $user_available_balance;
                    $total_fare = $wallet_fare - $user_wallet_debit_amount;
                }
                else {
                    $user_wallet_debit_amount = $wallet_fare;
                    $total_fare = 0;
                }
            }
            if($user_wallet_debit_amount > 0){
                $data_wallet['iUserId'] = $iUserId;
                $data_wallet['eUserType'] = "Rider";
                $data_wallet['iBalance'] = $user_wallet_debit_amount;
                $data_wallet['eType'] = "Debit";
                $data_wallet['dDate'] = date("Y-m-d H:i:s");
                $data_wallet['eFor'] = "Booking";
                $data_wallet['ePaymentStatus'] = "Settelled";
                $data_wallet['tDescription'] = "#LBL_DEBITED_BOOKING_BIDDING# " . $vBiddingPostNo;
                $getPaymentStatus = $obj->MySQLSelect("SELECT iBiddingPostId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iBiddingPostId='" . $iBiddingPostId . "'");
                $walletArr = array();
                for($h = 0;
                $h < scount($getPaymentStatus);
                $h++){
                    $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iBiddingPostId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
                }
                if(!isset($walletArr[$data_wallet['eType']][$data_wallet['eUserType']][$iBiddingPostId][$data_wallet['eFor']])){
                    $wallet_id = $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], 0, $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
                    $obj->sql_query("UPDATE user_wallet SET iTripId = 0, iBiddingPostId = '" . $iBiddingPostId . "' WHERE iUserWalletId = '$wallet_id'");
                }
                $data_update_task['fWalletDebit'] = $user_wallet_debit_amount;
                $where = " iBiddingPostId = '$iBiddingPostId'";
                $obj->MySQLQueryPerform("bidding_post", $data_update_task, "update", $where);
            }
        }
        if($ePaymentOption == "Card" && $isCollectCash == ""){
            if($total_fare > 0){
                $AMOUNT = $total_fare;
                $iMemberId = $iUserId;
                $UserType = "Passenger";
                $iPaymentInfoId = $bidding_post_data[0]['iPaymentInfoId'];
                $paymentData = array("amount" => $AMOUNT, "description" => $description, "iMemberId" => $iMemberId, "UserType" => $UserType, "iPaymentInfoId" => $iPaymentInfoId,);
                if(strtoupper($IS_TOKENIZED)== "NO"){
                    $paymentData['return_url'] = $tconfig['tsite_url'];
                    $paymentData['eType'] = $eType;
                }
                $result =(PaymentGateways::getInstance())->execute($paymentData);
                if($result['Action'] == "1"){
                    if(isset($result['AUTHENTICATION_REQUIRED'])){
                        $fOutStandingAmount = $total_fare;
                        $tDescription = "Amount charge for bid oustanding balance";
                        $extraParams = "eType=" . $eType . "&ePaymentType=ChargeOutstandingAmount&tSessionId=" . $userData[0]['tSessionId'] . "&GeneralMemberId=" . $iUserId . "&GeneralUserType=Passenger&iServiceId=&AMOUNT=" . $fOutStandingAmount . "&PAGE_TYPE=CHARGE_OUTSTANDING_AMT&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&description=" . urlencode($tDescription);
                        $OUTSTANDING_PAYMENT_URL = $tconfig['tsite_url'] . 'assets/libraries/webview/payment_mode_select.php?' . $extraParams;
                        $alertMsg = str_replace("#TASK_NO#", $vBiddingPostNo, $languageLabelsArr['LBL_BIDDING_OUTSTANDING_PAYMENT_PENDING_MSG']);
                        $message_arr = array();
                        $message_arr['Message'] = "OutstandingGenerated";
                        $message_arr['iBiddingPostId'] = $iBiddingPostId;
                        $message_arr['iUserId'] = $iUserId;
                        $message_arr['vBiddingPostNo'] = $vBiddingPostNo;
                        $message_arr['vTitle'] = $alertMsg;
                        $message_arr['tSessionId'] = $userData[0]['tSessionId'];
                        $message_arr['PAYMENT_URL'] = $OUTSTANDING_PAYMENT_URL;
                        $message_arr['vMsgCode'] = strval(time());
                        $channelName = "PASSENGER_" . $iUserId;
                        $generalDataArr[] = array('eDeviceType' => $userData[0]['eDeviceType'], 'deviceToken' => $userData[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $userData[0]['eAppTerminate'], 'eDebugMode' => $userData[0]['eDebugMode'], 'eHmsDevice' => $userData[0]['eHmsDevice'], 'message' => $message_arr, 'channelName' => $channelName,);
                        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
                    }
                    else {
                        $payment_id = $result['payment_id'];
                        $where_payments = " iPaymentId = '" . $payment_id . "'";
                        $data_payments['iBiddingPostId'] = $iBiddingPostId;
                        $data_payments['eEvent'] = "Bidding";
                        $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
                    }
                }
                else {
                    $returnArr['message1'] = "LBL_COLLECT_CASH";
                    if(strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING)== "OUTSTANDING"){
                        $returnArr['message1'] = "LBL_PAY_LATER_TXT";
                    }
                    $returnArr = array_merge($returnArr, $result);
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = $languageLabelsArr['LBL_CHARGE_COLLECT_FAILED'];
                    if(isset($result['message'])){
                        $returnArr['message'] = $result['message'];
                    }
                    setDataResponse($returnArr);
                }
            }
        }
        elseif(($ePaymentOption == "Card" || $ePaymentOption == "Wallet")&& $isCollectCash == "true"){
            if(strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING)== "CASH"){
                $data_update_task['ePaymentOption'] = "Cash";
            }
            else {
                $fOutStandingAmount = $total_fare;
            }
        }
        elseif($total_fare > 0 && $ePaymentOption == "Wallet" && $isCollectCash == ""){
            $returnArr['Action'] = "0";
            if(strtoupper($EXTRA_MONEY_CASH_OR_OUTSTANDING)== "OUTSTANDING"){
                $returnArr['message1'] = "LBL_PAY_LATER_TXT";
            }
            $returnArr['message'] = $languageLabelsArr['LBL_LOW_WALLET_BALANCE'];
            setDataResponse($returnArr);
        }
        if($ePaymentOption == "Cash" && $fOutStandingAmount > 0){
            $obj->sql_query("UPDATE trip_outstanding_amount SET ePaidByPassenger = 'Yes',iBiddingPostId='" . $iBiddingPostId . "', vBidAdjusmentId = '" . $vBiddingPostNo . "' WHERE iUserId = '" . $iUserId . "' AND ePaymentBy = 'Passenger'");
        }
        $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision('General');
        if($enableCommisionDeduct == 'Yes'){
            if($ePaymentOption == "Cash" && $isCollectCash == ""){
                $fCommissiondebit = round(($total_fare * $fCommission)/ 100, 2);
                $iBalance = $fCommissiondebit + $fOutStandingAmount;
                $data_wallet['iUserId'] = $iDriverId;
                $data_wallet['eUserType'] = "Driver";
                $data_wallet['iBalance'] = $iBalance;
                $data_wallet['eType'] = "Debit";
                $data_wallet['dDate'] = date("Y-m-d H:i:s");
                $data_wallet['eFor'] = "Withdrawl";
                $data_wallet['ePaymentStatus'] = "Settelled";
                $data_wallet['tDescription'] = "#LBL_DEBITED_SITE_EARNING_BOOKING# " . $vBiddingPostNo;
                $getPaymentStatus = $obj->MySQLSelect("SELECT iBiddingPostId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iBiddingPostId='" . $iBiddingPostId . "'");
                $walletArr = array();
                for($h = 0;
                $h < scount($getPaymentStatus);
                $h++){
                    $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iBiddingPostId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
                }
                if($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()){
                    $Where = " iBiddingPostId = '" . $iBiddingPostId . "'";
                    $Data_update_driver_paymentstatus = array();
                    $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Settelled";
                    $Update_Payment_Id = $obj->MySQLQueryPerform("bidding_post", $Data_update_driver_paymentstatus, 'update', $Where);
                    if(!isset($walletArr[$data_wallet['eType']][$data_wallet['eUserType']][$iBiddingPostId][$data_wallet['eFor']])){
                        $wallet_id = $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], 0, $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
                        $obj->sql_query("UPDATE user_wallet SET iTripId = 0, iBiddingPostId = '" . $iBiddingPostId . "' WHERE iUserWalletId = '$wallet_id'");
                    }
                }
                else {
                    $Where = " iBiddingPostId = '" . $iBiddingPostId . "'";
                    $Data_update_driver_paymentstatus = array();
                    if($total_fare >= $iBalance){
                        $Data_update_driver_paymentstatus['eDriverPaymentStatus'] = "Settelled";
                        $Update_Payment_Id = $obj->MySQLQueryPerform("bidding_post", $Data_update_driver_paymentstatus, 'update', $Where);
                        if(!isset($walletArr[$data_wallet['eType']][$data_wallet['eUserType']][$iBiddingPostId][$data_wallet['eFor']])){
                            $wallet_id = $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], 0, $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
                            $obj->sql_query("UPDATE user_wallet SET iTripId = 0, iBiddingPostId = '" . $iBiddingPostId . "' WHERE iUserWalletId = '$wallet_id'");
                        }
                    }
                }
            }
        }
        if($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()){
            if($MODULES_OBJ->isAutoCreditToDriverModuleAvailable()){
                include_once('include/features/include_auto_credit_driver.php');
            }
            $Data = array();
            $Data['ePaymentStatus'] = 'Settelled';
            $Data['isCollectCash'] = $isCollectCash;
            $Data['iUserId'] = $iUserId;
            $Data['iBiddingPostId'] = $iBiddingPostId;
            $Data['vBiddingPostNo'] = $vBiddingPostNo;
            autoCreditDriverEarningBidding($Data, "CollectPayment");
        }
        $OPTIMIZE_DATA_OBJ->DeleteMemberServiceDetails($iBiddingPostId, 'Bidding');
        $data_update_task['ePaid'] = "Yes";
        $where = " iBiddingPostId = '$iBiddingPostId'";
        $obj->MySQLQueryPerform("bidding_post", $data_update_task, "update", $where);
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
        setDataResponse($returnArr);
    }
    public function submitRating($iBiddingPostId, $iMemberId, $UserType){
        global $obj, $MODULES_OBJ;
        $rating = isset($_REQUEST["rating"])? $_REQUEST["rating"] : '';
        $message = isset($_REQUEST["message"])? $_REQUEST["message"] : '';
        $isSkipRating = isset($_REQUEST["isSkipRating"])? $_REQUEST["isSkipRating"] : 'No';
        $bidding_post_data = $obj->MySQLSelect("SELECT iUserId, iDriverId FROM bidding_post WHERE iBiddingPostId = '$iBiddingPostId'");
        if($UserType == "Passenger"){
            $tableName = "register_user";
            $where = "iUserId='" . $bidding_post_data[0]['iUserId'] . "'";
            $eFromUserType = $UserType;
            $eToUserType = "Driver";
            $avgRatingiMemberId = $bidding_post_data[0]['iDriverId'];
            $tableNameMember = "register_driver";
            $where_member = " iDriverId = '$avgRatingiMemberId'";
        }
        else {
            $tableName = "register_driver";
            $where = "iDriverId='" . $bidding_post_data[0]['iDriverId'] . "'";
            $eFromUserType = $UserType;
            $eToUserType = "Passenger";
            $avgRatingiMemberId = $bidding_post_data[0]['iUserId'];
            $tableNameMember = "register_user";
            $where_member = " iUserId = '$avgRatingiMemberId'";
        }
        if($this->checkRatingDone($iMemberId, $UserType, $iBiddingPostId)){
            $Data_update['vTaskStatus'] = "NONE";
            $obj->MySQLQueryPerform($tableName, $Data_update, 'update', $where);
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_TASK_FINISHED_TXT";
            if($UserType == "Passenger"){
                $returnArr['USER_DATA'] = getPassengerDetailInfo($iMemberId);
            }
            else {
                $returnArr['USER_DATA'] = getDriverDetailInfo($iMemberId);
            }
        }
        else {
            if(!$MODULES_OBJ->isEnableSkipRatingRide()){
                $isSkipRating = "No";
            }
            if($isSkipRating == 'No'){
                $Data_update_ratings = array();
                $Data_update_ratings['iBiddingPostId'] = $iBiddingPostId;
                $Data_update_ratings['fRating'] = $rating;
                $Data_update_ratings['tMessage'] = $message;
                $Data_update_ratings['eUserType'] = $UserType;
                $Data_update_ratings['eFromUserType'] = $eFromUserType;
                $Data_update_ratings['eToUserType'] = $eToUserType;
                $id = $obj->MySQLQueryPerform("bidding_service_ratings", $Data_update_ratings, 'insert');
                $Data_update['vTaskStatus'] = "NONE";
                $obj->MySQLQueryPerform($tableName, $Data_update, 'update', $where);
                $Data_update_member['vAvgRating'] = FetchUserAvgRating($avgRatingiMemberId, $UserType);
                $obj->MySQLQueryPerform($tableNameMember, $Data_update_member, 'update', $where_member);
            }
            if($isSkipRating == "Yes"){
                $iUserId = $bidding_post_data[0]['iUserId'];
                $trip_where = "iBiddingPostId='" . $iBiddingPostId . "'";
                $trip_data_update['isSkipRating'] = 'Yes';
                $id = $obj->MySQLQueryPerform('bidding_post', $trip_data_update, 'update', $trip_where);
            }
            if($id > 0){
                $returnArr['Action'] = "1";
                $returnArr['message'] = "LBL_TASK_FINISHED_TXT";
                if($UserType == "Passenger"){
                    $returnArr['USER_DATA'] = getPassengerDetailInfo($iMemberId);
                }
                else {
                    $returnArr['USER_DATA'] = getDriverDetailInfo($iMemberId);
                }
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            }
        }
        setDataResponse($returnArr);
    }
    public function getParentBiddingCategory($iBiddingId){
        global $obj, $MODULES_OBJ;
        $bidService = $obj->MySQLSelect("SELECT iParentId FROM $this->tablename WHERE iBiddingId = '$iBiddingId'");
        $iParentId = $bidService[0]['iParentId'];
        $db_fields = "";
        if($MODULES_OBJ->isEnableAppHomeScreenLayoutV3()){
            $db_fields .= ", vImage1";
        }
        $bidServiceArr = $obj->MySQLSelect("SELECT vImage,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescription, fCommission $db_fields FROM $this->tablename WHERE iBiddingId = '$iParentId'");
        return $bidServiceArr[0];
    }
    public function GenerateBidOutstandingAmount($iBiddingPostId){
        global $obj;
    }
    public function getFareDetailsGeneral($iBiddingPostId, $iMemberId = '', $GeneralUserType = ''){
        global $ENABLE_TAX_FOR_BIDDING_SERVICE,$obj, $LANG_OBJ, $tconfig, $WALLET_OBJ;
        $getBiddingPost = $this->getBiddingPost('webservice', $iBiddingPostId);
        $sql = "SELECT amount FROM $this->bidding_offer WHERE 1 = 1 AND eStatus = 'Accepted' AND iBiddingPostId = " . $iBiddingPostId . " ORDER BY `IOfferId` DESC LIMIT 1";
        $bidding_final_offer = $obj->MySQLSelect($sql);
        if(empty($bidding_final_offer)){
            $bidding_final_offer[0]['amount'] = $getBiddingPost[0]['fBiddingAmount'];
        }
        $total_fare = $bidding_final_offer[0]['amount'];
        $fTax1 = $getBiddingPost[0]['fTax1'];
        $fTax2 = $getBiddingPost[0]['fTax2'];
        $fTax1Percentage = $getBiddingPost[0]['fTax1Percentage'];
        $fTax2Percentage = $getBiddingPost[0]['fTax2Percentage'];
        $ePaymentOption = $getBiddingPost[0]['ePaymentOption'];
        if($ENABLE_TAX_FOR_BIDDING_SERVICE == "Yes"){
            $total_fare = $total_fare + $fTax1 + $fTax2;
        }
        $fWalletDebit = 0;
        $currencyData = $obj->MySQLSelect("SELECT vName,vSymbol from currency WHERE eDefault = 'Yes'");
        $vCurrency = $currencyData[0]['vName'];
        $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        $user_wallet_debit_amount = 0;
        $eWalletDebitAllow = $getBiddingPost[0]['eWalletDebit'];
        $tUserWalletBalance = $getBiddingPost[0]['tUserWalletBalance'];
        if($eWalletDebitAllow == "Yes"){
            $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($getBiddingPost[0]['iUserId'], "Rider");
            if($user_available_balance > 0){
                $totalCurrentActiveTripsArr = FetchTotalOngoingTrips($iMemberId);
                $totalCurrentActiveTripsIdsArr = $totalCurrentActiveTripsArr['ActiveTripIds'];
                $totalCurrentActiveOrderIdsArr = $totalCurrentActiveTripsArr['ActiveOrderIds'];
                $totalCurrentActiveBidIdsArr = $totalCurrentActiveTripsArr['ActiveBidIds'];
                $totalCurrentActiveTripsCount = $totalCurrentActiveTripsArr['TotalCount'];
                if(($totalCurrentActiveTripsCount > 1 || in_array($iBiddingPostId, $totalCurrentActiveBidIdsArr)== false)&& $ePaymentOption == "Wallet" && $tUserWalletBalance > 0){
                    $user_available_balance = $tUserWalletBalance;
                }
                $wallet_fare = $total_fare;
                $total_fare = 0;
                if($wallet_fare > $user_available_balance){
                    $user_wallet_debit_amount = $user_available_balance;
                }
                else {
                    $user_wallet_debit_amount = $wallet_fare;
                    $total_fare = 0;
                }
            }
            $fWalletDebit = $user_wallet_debit_amount;
        }
        $fWalletDebit = $getBiddingPost[0]['fWalletDebit'] > 0 ? $getBiddingPost[0]['fWalletDebit'] : $fWalletDebit;
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrency . "'");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $vTitle = $this->getServiceTitle('webservice', $getBiddingPost[0]['iBiddingId'], $getBiddingPost[0]['vTitle'], $lang);
        $fOutStandingAmount = $getBiddingPost[0]['fOutStandingAmount'];
        $fCommission = round((($bidding_final_offer[0]['amount'] * $getBiddingPost[0]['fCommission'])/ 100), 2);
        $bidding_final_offer_amount = round($bidding_final_offer[0]['amount'], 2);
        if($ENABLE_TAX_FOR_BIDDING_SERVICE == "Yes"){
            $bidding_final_offer_amount = $bidding_final_offer_amount + $fTax1 + $fTax2;
        }
        if($GeneralUserType == "Driver"){
            $Subtotal = $bidding_final_offer_amount - $fWalletDebit - $fCommission + $fOutStandingAmount;
        }
        else {
            $Subtotal = $bidding_final_offer_amount - $fWalletDebit + $fOutStandingAmount;
        }
        $return_arr = array();
        $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_BIDDING_FINAL_AMOUNT']] = formateNumAsPerCurrency($bidding_final_offer[0]['amount'] * $currency[0]['ratio'], $vCurrency);
        if($fTax1 > 0){
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX1_TXT'] . " @ " . $fTax1Percentage . " % "] = formateNumAsPerCurrency($fTax1 * $currency[0]['ratio'], $vCurrency);
        }
        if($fTax2 > 0){
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_TAX2_TXT'] . " @ " . $fTax2Percentage . " % "] = formateNumAsPerCurrency($fTax2 * $currency[0]['ratio'], $vCurrency);
        }
        if($fOutStandingAmount > 0){
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_OUTSTANDING_AMOUNT_TXT']] = formateNumAsPerCurrency($fOutStandingAmount * $currency[0]['ratio'], $vCurrency);
        }
        if($fWalletDebit > 0){
            $return_arr['FareDetailsNewArr'][][$languageLabelsArr['LBL_WALLET_ADJUSTMENT']] = "-" . formateNumAsPerCurrency($fWalletDebit * $currency[0]['ratio'], $vCurrency);
        }
        $return_arr['FareDetailsNewArr'][]['eDisplaySeperator'] = 'Yes';
        $return_arr['FareDetailsNewArr'][]['Subtotal'] = formateNumAsPerCurrency($Subtotal * $currency[0]['ratio'], $vCurrency);
        $return_arr['FareSubTotal'] = formateNumAsPerCurrency($Subtotal * $currency[0]['ratio'], $vCurrency);
        $return_arr['vBiddingPostNo'] = $getBiddingPost[0]['vBiddingPostNo'];
        $return_arr['dStartDate'] = $getBiddingPost[0]['dStartDate'];
        if($getBiddingPost[0]['dStartDate'] == "0000-00-00 00:00:00"){
            $return_arr['dBiddingDate'] = $getBiddingPost[0]['dBiddingDate'];
        }
        else {
            $return_arr['dBiddingDate'] = $getBiddingPost[0]['dStartDate'];
        }
        $return_arr['vTimeZone'] = $getBiddingPost[0]['vTimeZone'];
        $return_arr['tSaddress'] = $getBiddingPost[0]['vServiceAddress'];
        $return_arr['vServiceDetailTitle'] = isset($vTitle)? $vTitle : '';
        $return_arr['vBiddingPaymentMode'] = $getBiddingPost[0]['ePaymentOption'];
        $return_arr['vTaskStatus'] = $getBiddingPost[0]['vTaskStatus'];
        $return_arr['eStatus'] = $getBiddingPost[0]['eStatus'];
        $return_arr['fCommission'] = formateNumAsPerCurrency($fCommission * $currency[0]['ratio'], $vCurrency);
        $return_arr['ePayWallet'] = $getBiddingPost[0]['ePaymentOption'] == "Wallet" ? "Yes" : "No";
        if($Subtotal > 0 && $return_arr['ePayWallet'] == "Yes"){
            $return_arr['ePayWallet'] = "No";
        }
        if($getBiddingPost[0]['eStatus'] == "Cancelled"){
            $return_arr['vCancelReason'] = $getBiddingPost[0]['iCancelReasonId'] > 0 ? $this->getCancelReason($getBiddingPost[0]['iCancelReasonId'], $lang): $getBiddingPost[0]['vCancelReason'];
            $return_arr['eCancelledBy'] = $getBiddingPost[0]['eCancelBy'] == "User" ? $languageLabelsArr['LBL_RIDER'] : $languageLabelsArr['LBL_PROVIDER'];
        }
        $driverData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as driverName, vImage,vEmail as drivermail,iDriverId FROM register_driver WHERE iDriverId = '" . $getBiddingPost[0]['iDriverId'] . "' ");
        $return_arr['iDriverId'] = $getBiddingPost[0]['iDriverId'];
        if(!empty($driverData)){
            $return_arr['driverAvgRating'] = $this->getAvgRating($getBiddingPost[0]['iDriverId'], 'Driver');
            $return_arr['driverName'] = $driverData[0]['driverName'];
            $return_arr['drivermail'] = $driverData[0]['drivermail'];
            $return_arr['driverImage'] = $tconfig["tsite_upload_images_driver"] . "/" . $getBiddingPost[0]['iDriverId'] . "/2_" . $driverData[0]['vImage'];
            $return_arr['is_rating'] =($this->checkRatingDone($iMemberId, "Passenger", $iBiddingPostId))? "Yes" : "No";
        }
        $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName, vImgName,vEmail as usermail,iUserId FROM register_user WHERE iUserId = '" . $getBiddingPost[0]['iUserId'] . "' ");
        $return_arr['iUserId'] = $getBiddingPost[0]['iUserId'];
        $return_arr['userAvgRating'] = $this->getAvgRating($getBiddingPost[0]['iUserId'], 'Passenger');
        $return_arr['userName'] = $userData[0]['userName'];
        $return_arr['usermail'] = $userData[0]['usermail'];
        $return_arr['userImage'] = $tconfig['tsite_upload_images_passenger'] . "/" . $getBiddingPost[0]['iUserId'] . "/" . $userData[0]['vImgName'];
        $PassengerRatingData = $this->getBiddingRating("Passenger", $iBiddingPostId);
        $DriverRatingData = $this->getBiddingRating("Driver", $iBiddingPostId);
        $return_arr['PassengerTripRating'] = 0;
        if(!empty($PassengerRatingData)&& scount($PassengerRatingData)> 0){
            $return_arr['PassengerTripRating'] = $PassengerRatingData[0]['fRating'];
        }
        $return_arr['DriverTripRating'] = 0;
        if(!empty($DriverRatingData)&& scount($DriverRatingData)> 0){
            $return_arr['DriverTripRating'] = $DriverRatingData[0]['fRating'];
        }
        return $return_arr;
    }
    public function uploadbiddingmedia($image_name, $image_object, $iImageId = '', $iBiddingPostId = ''){
        global $tconfig, $UPLOAD_OBJ, $obj, $eMediaType, $iUserId;
        $vImageName = $message = '';
        $id = 0;
        $valid_Ext = "jpg,jpeg,gif,png,mp4,webm,mov,wmv,avi,flv,mkv,mp3,wav";
        if($eMediaType == 'Video'){
            $message = 'LBL_VIDEO_UPLOAD_SUCCESS_NOTE';
            $valid_Ext = $tconfig['tsite_upload_video_file_extensions'];
        }
        elseif($eMediaType == 'Audio'){
            $message = 'LBL_AUDIO_UPLOAD_SUCCESS_NOTE';
            $valid_Ext = $tconfig['tsite_upload_audio_file_extensions'];
        }
        elseif($eMediaType == 'Image'){
            $message = 'LBL_IMAGE_UPLOAD_SUCCESS_NOTE';
            $valid_Ext = $tconfig['tsite_upload_image_file_extensions'];
        }
        elseif($eMediaType == 'Document'){
            $message = 'LBL_DOC_UPLOAD_SUCCESS_NOTE';
            $valid_Ext = $tconfig['tsite_upload_docs_file_extensions'];
        }
        if($image_name != ""){
            $Photo_Gallery_folder = $tconfig['tsite_upload_bidding_media_image_path'];
            if(!is_dir($Photo_Gallery_folder)){
                mkdir($Photo_Gallery_folder, 0777);
                chmod($Photo_Gallery_folder, 0777);
            }
            $imgext = explode('.', $image_name);
            $unique = uniqid('', true);
            $file_name = substr($unique, strlen($unique)- 4, strlen($unique));
            $new_imagename = $file_name . "." . $imgext[1];
            $vFile = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $new_imagename, $prefix = '', $valid_Ext);
            $vImageName = $vFile[0];
        }
        if($vImageName != ''){
            if($eMediaType == 'Video'){
                $message = 'LBL_VIDEO_UPLOAD_SUCCESS_NOTE';
            }
            elseif($eMediaType == 'Audio'){
                $message = 'LBL_AUDIO_UPLOAD_SUCCESS_NOTE';
            }
            elseif($eMediaType == 'Image'){
                $message = 'LBL_IMAGE_UPLOAD_SUCCESS_NOTE';
            }
            elseif($eMediaType == 'Document'){
                $message = 'LBL_DOC_UPLOAD_SUCCESS_NOTE';
            }
            $Data_update_images['vImage'] = $vImageName;
            $Data_update_images['eMediaType'] = $eMediaType;
            $Data_update_images['iBiddingPostId'] = $iBiddingPostId;
            $Data_update_images['iUserId'] = $iUserId;
            $Data_update_images['tAddedDate'] = @date("Y-m-d H:i:s");
            $id = $obj->MySQLQueryPerform($this->bidding_post_media, $Data_update_images, 'insert');
        }
        if($id > 0 && $vImageName != ''){
            $returnArr['Action'] = "1";
            $returnArr['ibiddingPostMediaId'] = $id;
            $returnArr['message'] = $message;
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
        return $returnArr;
    }
    public function EditBiddingPostMedia($ibiddingPostMediaId, $iBiddingPostId){
        global $obj;
        $data_update_bidding_post_media['iBiddingPostId'] = $iBiddingPostId;
        $where = " ibiddingPostMediaId IN($ibiddingPostMediaId)AND iBiddingPostId = 0";
        $obj->MySQLQueryPerform($this->bidding_post_media, $data_update_bidding_post_media, "update", $where);
    }
    public function deleteallbiddingmedia($iBiddingPostId, $iUserId): array {
        $bidding_post_media = $this->getBiddingMediaSQLDATA($iBiddingPostId, $iUserId);
        $i = 0;
        $action_type = 'DELETEALL';
        foreach($bidding_post_media as $media){
            $this->deletebiddingmedia($media['ibiddingPostMediaId'], $action_type);
        }
        $getBiddingMedia = $this->getbiddingmedia($iBiddingPostId, $iUserId);
        $returnArr = [];
        if(scount($bidding_post_media)> 0){
            $returnArr['Action'] = "1";
            $returnArr['BiddingPostMedia'] = $getBiddingMedia;
            $returnArr['message'] = "LBL_DELETE_ALL_MEDIA_SUCCESS_NOTE";
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
        return $returnArr;
    }
    public function getBiddingMediaSQLDATA($iBiddingPostId, $iUserId, $GeneralUserType = ''){
        global $obj, $tconfig;
        $Photo_Gallery_folder = $tconfig['tsite_upload_bidding_media_image'];
        if(empty($iBiddingPostId)){
            $iBiddingPostId = 0;
        }
        $iUserId_sql = '';
        if($GeneralUserType == 'Driver'){
            $iUserId_sql = '';
        }
        else {
            $iUserId_sql = "AND iUserId = " . $iUserId;
        }
        $sql = "SELECT *,'' as vFileName,'' as thumnails,vImage as vImageName,CONCAT('" . $Photo_Gallery_folder . "','/',vImage)AS vImage FROM " . $this->bidding_post_media . " Where iBiddingPostId = " . $iBiddingPostId . " " . $iUserId_sql ." ORDER BY ibiddingPostMediaId DESC";
        return $obj->MySQLSelect($sql);
    }
    public function deletebiddingmedia($iImageId, $action_type = 'DELETE', $iBiddingPostId = 0, $iUserId = 0): array {
        global $tconfig, $obj, $eMediaType;
        $message = '';
        $Photo_Gallery_folder = $tconfig['tsite_upload_bidding_media_image_path'];
        $OldImageName = get_value($this->bidding_post_media, 'vImage', 'ibiddingPostMediaId', $iImageId, '', 'true');
        if($OldImageName != ''){
            unlink($Photo_Gallery_folder . $OldImageName);
            $tmpArr = explode(".", $OldImageName);
            $thumb_img = $tmpArr[0] . '.png';
            unlink($Photo_Gallery_folder . 'thumnails/' . $thumb_img);
        }
        $sql = "DELETE FROM $this->bidding_post_media WHERE `ibiddingPostMediaId`='" . $iImageId . "'";
        $id = $obj->sql_query($sql);
        $returnArr = [];
        if($action_type == 'DELETE'){
            if($eMediaType == 'Video'){
                $message = 'LBL_VIDEO_DELETE_SUCCESS_NOTE';
            }
            elseif($eMediaType == 'Audio'){
                $message = 'LBL_AUDIO_DELETE_SUCCESS_NOTE';
            }
            elseif($eMediaType == 'Image'){
                $message = 'LBL_IMAGE_DELETE_SUCCESS_NOTE';
            }
            else {
                $message = 'LBL_DOC_DELETE_SUCCESS_NOTE';
            }
            $getBiddingMedia = $this->getbiddingmedia($iBiddingPostId, $iUserId);
            if($id > 0){
                $returnArr['BiddingPostMedia'] = $getBiddingMedia['BiddingPostMedia'];
                $returnArr['Action'] = "1";
                $returnArr['message'] = $message;
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            }
        }
        return $returnArr;
    }
    public function getbiddingmedia($iBiddingPostId, $iUserId, $UserType = ''){
        global $tconfig;
        $Photo_Gallery_folder = $tconfig['tsite_upload_bidding_media_image'];
        $bidding_post_media = $this->getBiddingMediaSQLDATA($iBiddingPostId, $iUserId, $UserType);
        $BiddingPostMedia = [];
        $BiddingPostMedia['Video'] = [];
        $BiddingPostMedia['Audio'] = [];
        $BiddingPostMedia['Image'] = [];
        $i = 0;
        foreach($bidding_post_media as $media){
            if($media['eMediaType'] == 'Video'){
                $media['thumnails'] = $this->getVideoThumbBiddingMedia($media['vImageName']);
                $media['vImage'] = $this->videoConvertTomp4($media['vImageName']);
                $media['deleteMsg'] = 'LBL_ASK_FOR_DELETE_VIDEO';
            }
            if($media['eMediaType'] == 'Audio'){
                $audioCount = scount($BiddingPostMedia['Audio'])+ 1;
                $media['vFileName'] = 'Audio File ' . $audioCount;
                $media['deleteMsg'] = 'LBL_ASK_FOR_DELETE_AUDIO';
            }
            if($media['eMediaType'] == 'Image'){
                $media['deleteMsg'] = 'LBL_ASK_FOR_DELETE_IMAGE';
            }
            if($media['eMediaType'] == 'Document'){
                $media['deleteMsg'] = 'LBL_ASK_FOR_DELETE_DOCUMENT';
            }
            $bidding_post_media[$i] = $media;
            $i++;
        }
        if($BiddingPostMedia){
            $returnArr['Action'] = "1";
            $returnArr['BiddingPostMedia'] = $bidding_post_media;
        }
        else {
            $returnArr['Action'] = "0";
        }
        return $returnArr;
    }
    function getVideoThumbBiddingMedia($video_file){
        global $tconfig;
        $tmpArr = explode(".", $video_file);
        $thumb_img = $tmpArr[0] . '.png';
        $img_url = "";
        if(!is_dir($tconfig["tsite_upload_bidding_media_image_path"] . 'thumnails/')){
            mkdir($tconfig["tsite_upload_bidding_media_image_path"] . 'thumnails/', 0777);
            chmod($tconfig["tsite_upload_bidding_media_image_path"] . 'thumnails/', 0777);
        }
        $img_path = $tconfig["tsite_upload_bidding_media_image_path"] . 'thumnails/' . $thumb_img;
        $img_url = $tconfig["tsite_upload_bidding_media_image"] . '/thumnails/' . $thumb_img;
        if(!file_exists($img_path)){
            $sec = 3;
            $vFile = $tconfig["tsite_upload_bidding_media_image_path"] . $video_file;
            if($tmpArr[1] == 'mkv'){
                $img_path = $tconfig["tsite_upload_bidding_media_image_path"] . 'thumnails/' . $thumb_img;
                $ffmpeg = FFMpeg\FFMpeg::create();
                $video = $ffmpeg->open($vFile);
                $format = new FFMpeg\Format\Video\X264();
                $format->setAudioCodec("libmp3lame");
                $thumb_video = $tmpArr[0] . '.mp4';
                $vFile = $tconfig["tsite_upload_bidding_media_image_path"] . $thumb_video;
                $video->save($format, $vFile);
            }
            $ffprobe = FFMpeg\FFProbe::create();
            $vDuration = $ffprobe->streams($vFile)->videos()->first()->get('duration');
            if($vDuration < 3){
                $sec = floor($vDuration);
            }
            $ffmpeg = FFMpeg\FFMpeg::create();
            $video = $ffmpeg->open($vFile);
            $frame = $video->frame(FFMpeg\Coordinate\TimeCode::fromSeconds($sec));
            $frame->save($img_path);
        }
        return $img_url;
    }
    function videoConvertTomp4($video_file){
        global $tconfig;
        $tmpArr = explode(".", $video_file);
        $thumb_img = $tmpArr[0] . '.mp4';
        $vFile = "";
        $img_path = $tconfig["tsite_upload_bidding_media_image_path"] . $thumb_img;
        $img_url = $tconfig["tsite_upload_bidding_media_image"] . '/' . $thumb_img;
        if(!file_exists($img_path)){
            $vFile = $tconfig["tsite_upload_bidding_media_image_path"] . $video_file;
            $ffmpeg = FFMpeg\FFMpeg::create();
            $video = $ffmpeg->open($vFile);
            $format = new FFMpeg\Format\Video\X264();
            $format->setAudioCodec("libmp3lame");
            $thumb_video = $tmpArr[0] . '.mp4';
            $vFile = $tconfig["tsite_upload_bidding_media_image_path"] . $thumb_video;
            $video->save($format, $vFile);
        }
        return $img_url;
    }
    function getBiddingDriverStats($use, $biddingPostid = '', $iUserId = '', $vLanguage = "EN", $ord = '', $farray = array(), $iDriverId = ''){
        global $BIDDING_OBJ, $currency, $register_driver, $obj;
        $data = $this->getBiddingPost($use, $biddingPostid, $iUserId, $vLanguage, $ord, $farray, $iDriverId, $ListBidding = 1);
        $return['TripCount'] = scount($data);
        $totalEarnings = 0;
        for($t = 0;
        $t < scount($data);
        $t++){
            $iFare = $BIDDING_OBJ->getDriverEarning($data[$t]['iBiddingPostId'])['DriverEarning'];
            $iFareSum = str_replace(',', '', $iFare);
            $totalEarnings += $iFareSum;
        }
        $return['TotalEarning'] = $totalEarnings;
        $return['TotalEarningAmount'] = formateNumAsPerCurrency($totalEarnings * $currency[0]['ratio'], $register_driver[0]['vCurrencyDriver']);
        $iBiddingPostId = array_column($data, 'iBiddingPostId');
        $bid = implode(',', $iBiddingPostId);
        $avgRating_query = 'SELECT SUM(fRating)as fRating FROM `bidding_service_ratings` WHERE eToUserType = "Driver" AND iBiddingPostId IN("' . $bid . '")';
        $avgRating = $obj->sql_query($avgRating_query);
        $return['AvgRating'] = 0;
        if(!empty($avgRating)&& $return['TripCount'] != 0){
            $return['AvgRating'] = $avgRating[0]['fRating'] / $return['TripCount'];
        }
        return $return;
    }
    public function getDriverEarning($iBiddingPostId){
        global $obj;
        $biddingFinalAmount = $this->getbiddingFinalAmount($iBiddingPostId);
        $sql = "SELECT fCommission FROM bidding_post WHERE iBiddingPostId = '$iBiddingPostId' ";
        $biddingData = $obj->MySQLSelect($sql);
        $fCommission = round((($biddingFinalAmount * $biddingData[0]['fCommission'])/ 100), 2);
        $data['DriverEarning'] = $biddingFinalAmount - $fCommission;
        return $data;
    }
    function getFilterPriority($driverId){
        global $obj;
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : '';
        $date_ = date("Y-m-d H:i:s", strtotime(date("Y-m-d H:i:s")));
        $serverTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $TimeZoneOffset = converToTz($date_, $serverTimeZone, $vTimeZone, "P");
        }
        $sql = "SELECT count(*)as count FROM `driver_bidding_request` dbp JOIN bidding_post bp on(bp.iBiddingPostId = dbp.iBiddingPostId)WHERE dbp.iDriverId = " . $driverId . " AND bp.eStatus = 'Pending' AND dbp.eStatus IN('Pending' , 'Reoffer','Accepted')AND bp.dBiddingDate > CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "')";
        $data = $obj->MySQLSelect($sql);
        $pandingCount = $data[0]['count'];
        $filter = 'Pending';
        if(empty($pandingCount)|| $pandingCount == 0){
            $sql = "SELECT count(*)as count FROM bidding_post bp WHERE bp.eStatus = 'Accepted' AND bp.iDriverId = '" . $driverId . "'";
            $Accepteddata = $obj->MySQLSelect($sql);
            $AcceptedCount = $Accepteddata[0]['count'];
            $filter = 'Accepted';
            if(empty($AcceptedCount)|| $AcceptedCount == 0){
                $filter = 'Pending';
            }
        }
        $res['filter'] = $filter;
        return $res;
    }
    function getBiddingDocument($diverId, $db_vehicle){
        global $obj;
        $sql = "SELECT vBiddingId FROM `bidding_driver_service` WHERE iDriverId = {
            $diverId
        }
        ";
        $bidding_driver_service = $obj->MySQLSelect($sql);
        $sql = "SELECT iBiddingId FROM `bidding_driver_request` WHERE iDriverId = {
            $diverId
        }
        ";
        $bidding_driver_request = $obj->MySQLSelect($sql);
        $iBiddingId_2 = $iBiddingId_1 = $iBiddingId_arr = [];
        if(isset($bidding_driver_request)&& !empty($bidding_driver_request)){
            $iBiddingId_1 = array_column($bidding_driver_request, 'iBiddingId');
        }
        if(isset($bidding_driver_service)&& !empty($bidding_driver_service)){
            $iBiddingId_2 = explode(',', $bidding_driver_service[0]['vBiddingId']);
        }
        $iBiddingId_arr = array_merge($iBiddingId_1, $iBiddingId_2);
        $iBiddingId_arr = array_values(array_unique($iBiddingId_arr, SORT_REGULAR));
        $docNameArray = array_column($db_vehicle, 'doc_name');
        $docNameArrayCount = array_count_values($docNameArray);
        $iParentId_arr = $biddingCategoryIdArray = [];
        for($i = 0;
        $i < scount($iBiddingId_arr);
        $i++){
            $bid = $iBiddingId_arr[$i];
            $iParentId = get_value('bidding_service', 'iParentId', 'iBiddingId', $bid, '', 'true');
            $iBidding_Id = get_value('bidding_service', 'iBiddingId', 'iBiddingId', $iParentId, 'and eStatus = "Active"', 'true');
            if(in_array($iParentId, $iParentId_arr)|| empty($iBidding_Id)){
            }
            else {
                array_push($iParentId_arr, $iParentId);
                foreach($db_vehicle as $key => $value){
                    if($value['iBiddingId'] == $iParentId){
                        array_push($biddingCategoryIdArray, $value);
                    }
                }
            }
        }
        return $biddingCategoryIdArray;
    }
    function driverPaymentCal($driver_payment){
        if(isset($driver_payment)&& !empty($driver_payment)){
            $total_fOutStandingAmount = $total_driver_payment = $total_Amount = $Outstanding_amount_cash_trip = $total_tip = $total_cash_received = $final_amount_pay_provider = $final_amount_take_from_provider = $total_admin_commission = 0;
            foreach($driver_payment as $payment){
                $fOutStandingAmount = $payment['fOutStandingAmount'];
                $fBiddingAmount = $payment['fBiddingAmount'];
                $fCommission_percentage = $payment['fCommission'];
                $fCommission_percentage =($fBiddingAmount * $fCommission_percentage)/ 100;
                if($payment['ePaymentOption'] == 'Cash'){
                    $total_cash_received += $fBiddingAmount;
                    $final_amount_take_from_provider += $fCommission_percentage;
                    $total_driver_payment +=($fBiddingAmount - $fCommission_percentage)- $fBiddingAmount;
                }
                else if($payment['ePaymentOption'] == 'Card'){
                    $total_driver_payment = $final_amount_pay_provider +=($fBiddingAmount - $fCommission_percentage);
                }
                else if($payment['ePaymentOption'] == 'Wallet'){
                    $total_driver_payment = $final_amount_pay_provider +=($fBiddingAmount - $fCommission_percentage);
                }
                $total_admin_commission += $fCommission_percentage;
                $total_Amount += $fBiddingAmount;
                $total_fOutStandingAmount += $fOutStandingAmount;
            }
            $driverPayment['total_cash_received'] = $total_cash_received;
            $driverPayment['final_amount_pay_provider'] = $final_amount_pay_provider;
            $driverPayment['final_amount_take_from_provider'] = $final_amount_take_from_provider;
            $driverPayment['total_admin_commission'] = $total_admin_commission;
            $driverPayment['total_amount'] = $total_Amount;
            $driverPayment['total_tip'] = 0;
            $driverPayment['total_Outstanding'] = $total_fOutStandingAmount;
            $driverPayment['total_driver_payment'] = $total_driver_payment;
            return $driverPayment;
        }
    }
    function PaymentSummeryBidding($finalPayment = 'No'){
        global $obj, $LANG_OBJ;
        $iMemberId = $_REQUEST["GeneralMemberId"] ?? '';
        $UserType = $_REQUEST["GeneralUserType"] ?? 'Passenger';
        $iBiddingPostId = $_REQUEST["iBiddingPostId"] ?? '';
        $iDriverId = $_REQUEST["iDriverId"] ?? '';
        $vLang = $_REQUEST["vLang"] ?? '';
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", "");
        $sql = "SELECT user.vCurrencyPassenger, bp.fBiddingAmount,bp.fOutStandingAmount FROM bidding_post as bp JOIN $this->register_user as user ON(bp.iUserId = user.iUserId)WHERE bp.iBiddingPostId = '" . $iBiddingPostId . "'";
        $bidding_post = $obj->MySQLSelect($sql)[0];
        if(isset($bidding_post)&& !empty($bidding_post)){
            $vCurrencyPassenger = $bidding_post['vCurrencyPassenger'];
            $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $vCurrencyPassenger . "'");
            if(strtoupper($finalPayment)== 'YES'){
                $bidding_post['fBiddingAmount'] = $this->getbiddingFinalAmount($iBiddingPostId);
            }
            else {
                $DriverLastAmount = $this->getBiddingLastAmount($iDriverId, $iBiddingPostId);
                if(isset($DriverLastAmount)&& !empty($DriverLastAmount)){
                    $bidding_post['fBiddingAmount'] = $DriverLastAmount[0]['amount'];
                }
            }
            $fOutStandingAmount = $bidding_post['fOutStandingAmount'];
            $fBiddingAmount = $bidding_post['fBiddingAmount'];
            $fTaxAmount2 = $fTaxAmount1 = $discountValue = 0;
            $TaxArr = getMemberCountryTax($iDriverId, "Driver");
            $fTax1 = $TaxArr['fTax1'];
            $fTax2 = $TaxArr['fTax2'];
            if($fTax1 > 0){
                $fTaxAmount1 = round(((($bidding_post['fBiddingAmount'] - $discountValue)* $fTax1)/ 100), 2);
            }
            if($fTax2 > 0){
                $fTaxAmount2 = round(((($bidding_post['fBiddingAmount'] - $discountValue)* $fTax2)/ 100), 2);
            }
            $TotalFare =($fBiddingAmount + $fTaxAmount1 + $fTaxAmount2 + $fOutStandingAmount)- $discountValue;
            if(strtoupper($finalPayment)== 'YES'){
                $returnArr['fTax1Percentage'] = $fTax1;
                $returnArr['fTax2Percentage'] = $fTax2;
                $returnArr['fTax1'] = $fTaxAmount1;
                $returnArr['fTax2'] = $fTaxAmount2;
                $returnArr['TotalFare'] = $TotalFare;
                return $returnArr;
            }
            $tripFareDetailsArr = [];
            if($fBiddingAmount){
                $tripFareDetailsArr[][$languageLabelsArr['LBL_BIDDING_FINAL_AMOUNT']] = formateNumAsPerCurrency($fBiddingAmount * $currency[0]['ratio'], $currency[0]['vName']);
            }
            if($fOutStandingAmount > 0){
                $tripFareDetailsArr[][$languageLabelsArr['LBL_OUTSTANDING_AMOUNT_TXT']] = formateNumAsPerCurrency($fOutStandingAmount * $currency[0]['ratio'], $currency[0]['vName']);
            }
            if($fTax1 > 0){
                $tripFareDetailsArr[][$languageLabelsArr['LBL_TAX1_TXT'] . " @ " . $fTax1 . " % "] = formateNumAsPerCurrency($fTaxAmount1 * $currency[0]['ratio'], $currency[0]['vName']);
            }
            if($fTax2 > 0){
                $tripFareDetailsArr[][$languageLabelsArr['LBL_TAX2_TXT'] . " @ " . $fTax2 . " % "] = formateNumAsPerCurrency($fTaxAmount2 * $currency[0]['ratio'], $currency[0]['vName']);
            }
            $tripFareDetailsArr[]['eDisplaySeperator'] = 'Yes';
            $tripFareDetailsArr[]['Subtotal'] = formateNumAsPerCurrency($TotalFare * $currency[0]['ratio'], $currency[0]['vName']);
            $returnArr = [];
            $returnArr['bidding_fare_arr'] = $tripFareDetailsArr;
            $returnArr['Action'] = 1;
        }
        else {
            $returnArr = [];
            $returnArr['message'] = "LBL_NO_RECORDS_FOUND1";
            $returnArr['Action'] = 0;
        }
        setDataResponse($returnArr);
    }
}
class Delete_account {
    function __construct(){
    }
    public function accountDelete($iMemberId, $UserType){
        global $tconfig, $APPSTORE_MODE_IOS;
        if(strtoupper($APPSTORE_MODE_IOS)== "REVIEW"){
            $returnArr['Action'] = 1;
            $returnArr['message'] = 'LBL_CONTINUE_DELETE_ACCOUNT';
            $returnArr['Url'] = $tconfig['tsite_url'] . 'account_delete_process.php?GeneralMemberId=' . $iMemberId . '&GeneralUserType=' . $UserType;
            setDataResponse($returnArr);
        }
        if($UserType == 'Passenger'){
            $data = $this->checkAccountDelete_User($iMemberId);
        }
        else if($UserType == 'Driver'){
            $data = $this->checkAccountDelete_Driver($iMemberId);
        }
        else if($UserType == 'Company'){
            $data = $this->checkAccoutDelete_Store($iMemberId);
        }
        else if($UserType == 'Tracking'){
            $data = $this->checkAccoutDelete_Tracking($iMemberId);
        }
        if(!empty($data)&& scount($data)> 0){
            $returnArr['Action'] = $data['status'];
            $returnArr['message'] = $data['message'];
            if($data['status'] == 1){
                $returnArr['Url'] = $tconfig['tsite_url'] . 'account_delete_process.php?GeneralMemberId=' . $iMemberId . '&GeneralUserType=' . $UserType;
            }
        }
        else {
            $returnArr['Action'] = 0;
            $returnArr['message'] = '--';
        }
        setDataResponse($returnArr);
    }
    private function checkAccountDelete_User($iMemberId){
        global $obj, $MODULES_OBJ;
        $OutstandingAmount = GetPassengerOutstandingAmount($iMemberId);
        $register_user = $obj->MySQLSelect("SELECT iUserId, vTripStatus FROM `register_user` WHERE iUserId = '" . $iMemberId . "'");
        $trips = $obj->MySQLSelect("SELECT iTripId,iActive FROM `trips` WHERE iUserId = '" . $iMemberId . "' AND iActive IN('Active' , 'On Going Trip','Arrived')");
        $cab_request_now = $obj->MySQLSelect("SELECT iTripId,eStatus FROM `cab_request_now` WHERE iUserId = '" . $iMemberId . "' AND iTripId != '' AND eStatus IN('Pending')");
        $CurrentDate = date("Y-m-d H:i:s");
        $subSqlBook = " AND dBooking_date > '$CurrentDate'";
        $cab_booking = $obj->MySQLSelect("SELECT iTripId,eStatus FROM `cab_booking` WHERE iUserId = '" . $iMemberId . "' AND eStatus IN('Pending','Assign','Accepted')$subSqlBook ");
        $orders = array();
        if($MODULES_OBJ->isDeliverAllFeatureAvailable()){
            $orders = $obj->MySQLSelect("SELECT iOrderId,iStatusCode FROM `orders` WHERE `iUserId` = '" . $iMemberId . "' AND iStatusCode IN(1,2,4,5)");
        }
        $Arr_Return['status'] = 0;
        if($OutstandingAmount == 0 && scount($trips)== 0 && scount($cab_request_now)== 0 && scount($cab_booking)== 0 && scount($orders)== 0){
            $Arr_Return['status'] = 1;
            $Arr_Return['message'] = 'LBL_CONTINUE_DELETE_ACCOUNT';
        }
        else {
            if($OutstandingAmount > 0){
                $LBL_MES = 'LBL_DELETE_ACCOUNT_PENDING_OUTSTANDING_AMOUNT';
            }
            else if(scount($trips)> 0 || scount($cab_request_now)> 0 || scount($cab_booking)> 0 || scount($orders)> 0){
                $LBL_MES = 'LBL_DELETE_ACCOUNT_PENDING_TRIP_ORDER_JOB';
            }
            $Arr_Return['message'] = $LBL_MES;
        }
        return $Arr_Return;
    }
    private function checkAccountDelete_Driver($iMemberId){
        global $obj;
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : '';
        $serverTimeZone = date_default_timezone_get();
        $date_ = date("Y-m-d H:i:s", strtotime(date("Y-m-d H:i:s")));
        $TimeZoneOffset = converToTz($date_, $serverTimeZone, $vTimeZone, "P");
        $subSqlBook = " AND dBooking_date >((CONVERT_TZ(NOW(), 'SYSTEM', '" . $TimeZoneOffset . "'))- INTERVAL 30 MINUTE)";
        $trips = $obj->MySQLSelect("SELECT iTripId,iDriverId,iActive,eDriverPaymentStatus FROM `trips` WHERE iDriverId = '" . $iMemberId . "' AND iActive != 'Canceled' AND eDriverPaymentStatus = 'Unsettelled' ");
        $cab_booking = $obj->MySQLSelect("SELECT iTripId,eStatus FROM `cab_booking` WHERE iDriverId = '" . $iMemberId . "' AND eStatus IN('Pending','Assign','Accepted')$subSqlBook");
        $Arr_Return['status'] = 0;
        if(scount($trips)== 0 && scount($cab_booking)== 0){
            $Arr_Return['status'] = 1;
            $Arr_Return['message'] = 'LBL_CONTINUE_DELETE_ACCOUNT';
        }
        else {
            if(scount($trips)> 0 || scount($cab_booking)> 0){
                $LBL_MES = 'LBL_DELETE_ACCOUNT_PENDING_TRIP_ORDER_JOB';
            }
            $Arr_Return['message'] = $LBL_MES;
        }
        return $Arr_Return;
    }
    private function checkAccoutDelete_Store($iMemberId){
        global $obj;
        $statusCode = "1,2,4,5";
        $orders = $obj->MySQLSelect("SELECT iOrderId FROM orders WHERE iCompanyId='" . $iMemberId . "' AND iStatusCode IN($statusCode)");
        $Arr_Return['status'] = 0;
        if(scount($orders)== 0){
            $Arr_Return['status'] = 1;
            $Arr_Return['message'] = 'LBL_CONTINUE_DELETE_ACCOUNT';
        }
        else {
            if(scount($orders)> 0){
                $LBL_MES = 'LBL_DELETE_ACCOUNT_PENDING_TRIP_ORDER_JOB';
            }
            $Arr_Return['message'] = $LBL_MES;
        }
        return $Arr_Return;
    }
    private function checkAccoutDelete_Tracking($iMemberId){
        global $obj;
        $Tracking_user = $obj->MySQLSelect("SELECT iTrackServiceUserId FROM track_service_users WHERE iTrackServiceUserId='" . $iMemberId . "'");
        $Arr_Return['status'] = 0;
        if(scount($Tracking_user)> 0){
            $Arr_Return['status'] = 1;
            $Arr_Return['message'] = 'LBL_CONTINUE_DELETE_ACCOUNT';
        }
        else {
            $Arr_Return['message'] = '--';
        }
        return $Arr_Return;
    }
    public function signIn($iMemberId, $UserType, $mobileNo, $vPhoneCode, $email){
        global $obj, $SIGN_IN_OPTION;
        $checkValid = checkMemberDataInfo($mobileNo, '', $UserType, $vPhoneCode, $iMemberId, '', 1);
        if($UserType == "Driver"){
            $getData = $this->getDriverDetails($iMemberId, $mobileNo);
        }
        else if($UserType == "Company"){
            $getData = $this->getCompanyDetails($iMemberId, $mobileNo);
        }
        else if($UserType == 'Tracking'){
            $getData = $this->getTrackingUserDetails($iMemberId);
        }
        else {
            $getData = $this->getUserDetails($iMemberId, $mobileNo);
        }
        $returnArr['Action'] = '1';
        if($checkValid['status'] == 1){
            $returnArr['showEnterPassword'] = 'No';
            $returnArr['showEnterOTP'] = 'No';
            if($SIGN_IN_OPTION == 'Password'){
                $returnArr['showEnterPassword'] = 'Yes';
            }
            else if($SIGN_IN_OPTION == 'OTP'){
                $returnArr['showEnterOTP'] = 'Yes';
                $this->sendOtp($iMemberId, $UserType, $vPhoneCode, $mobileNo);
            }
        }
        else {
            $returnArr['message'] = 'LBL_INVALID_PHONE_NUMBER';
            $returnArr['Action'] = '0';
        }
        return $returnArr;
    }
    public function AuthenticateMember($iMemberId, $UserType, $mobileNo, $vPhoneCode, $email, $password){
        global $obj, $SIGN_IN_OPTION, $AUTH_OBJ;
        $checkValid = checkMemberDataInfo($mobileNo, '', $UserType, $vPhoneCode, $iMemberId, '', 1);
        if($checkValid['status'] == 1){
            if($UserType == "Driver"){
                $returnArr['Details'] = $this->getDriverDetails($iMemberId);
            }
            else if($UserType == "Company"){
                $returnArr['Details'] = $this->getCompanyDetails($iMemberId);
            }
            else if($UserType == "Tracking"){
                $returnArr['Details'] = $this->getTrackingUserDetails($iMemberId);
            }
            else {
                $returnArr['Details'] = $this->getUserDetails($iMemberId);
            }
            if(strtoupper($SIGN_IN_OPTION)== "PASSWORD"){
                $hash = $returnArr['Details']['vPassword'];
                $checkValidPass = $AUTH_OBJ->VerifyPassword($password, $hash);
                if($checkValidPass == 0){
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_WRONG_DETAIL";
                }
                else {
                    $returnArr['Action'] = '1';
                }
            }
        }
        else {
            $returnArr['Action'] = '0';
            $returnArr['message'] = 'LBL_NOT_FIND';
        }
        return $returnArr;
    }
    private function sendOtp($iMemberId, $UserType, $vPhoneCode, $mobileNo){
        global $LANG_OBJ, $obj, $MOBILE_NO_VERIFICATION_METHOD, $COMM_MEDIA_OBJ, $SITE_NAME;
        $otp = mt_rand(1000, 9999);
        $Data_update_member['iOTP'] = $otp;
        $Data_update_member_c['vOTP'] = $otp;
        $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $str = "SELECT * from send_message_templates where vEmail_Code = 'AUTH_OTP'";
        $res = $obj->MySQLSelect($str);
        $prefix = $res[0]['vBody_' . $vLangCode];
        $message = str_replace(["#OTP#", "#SITE_NAME#"], [$otp, $SITE_NAME], $prefix);
        $toMobileNum = "+" . $vPhoneCode . $mobileNo;
        $returnArr['MOBILE_NO_VERIFICATION_METHOD'] = $MOBILE_NO_VERIFICATION_METHOD;
        if(strtoupper($MOBILE_NO_VERIFICATION_METHOD)!= "FIREBASE"){
            $countryData = get_value('country', 'vPhoneCode', 'vCountryCode', $vPhoneCode);
            $vPhoneCode = $countryData[0]['vPhoneCode'];
            $result = $COMM_MEDIA_OBJ->SendSystemSMS($mobileNo, $vPhoneCode,$message);
        }
        else {
            $result = 1;
        }
        if($result == 1){
            if($UserType == "Driver"){
                $where = " iDriverId = '$iMemberId' ";
                $obj->MySQLQueryPerform('register_driver', $Data_update_member, 'update', $where);
            }
            else if($UserType == "Company"){
                $where = " iCompanyId = '$iMemberId' ";
                $obj->MySQLQueryPerform('company', $Data_update_member_c, 'update', $where);
            }
            else {
                $where = " iUserId = '$iMemberId' ";
                $obj->MySQLQueryPerform('register_user', $Data_update_member, 'update', $where);
            }
        }
        return $result;
    }
    public function AuthenticateMemberWithOtp($iMemberId, $UserType, $mobileNo, $vPhoneCode, $otp , $isOtpVerifyDone){
        global $obj;
        $checkValid = checkMemberDataInfo($mobileNo, '', $UserType, $vPhoneCode, $iMemberId, '');
        if($checkValid['status'] == 1){
            if(empty($otp)&& $isOtpVerifyDone == 0){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_VERIFICATION_CODE_INVALID";
                return $returnArr;
            }
            if($UserType == "Driver"){
                $query_1 = "SELECT iDriverId FROM register_driver WHERE 1 = 1 AND iDriverId = " . $iMemberId . " AND iOTP = " . $otp;
            }
            elseif($UserType == "Company"){
                $query_1 = "SELECT iCompanyId FROM company WHERE 1 = 1 AND iCompanyId = " . $iMemberId . " AND vOTP = " . $otp;
            }
            else {
                $query_1 = "SELECT iUserId FROM register_user WHERE iUserId = '" . $iMemberId . "' AND iOTP =" . $otp;
            }
            $data = $obj->MySQLSelect($query_1);
            if(scount($data)== 0 && $isOtpVerifyDone == 0){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_VERIFICATION_CODE_INVALID";
            }
            else {
                if($UserType == "Driver"){
                    $returnArr['Details'] = $this->getDriverDetails($iMemberId);
                }
                elseif($UserType == "Company"){
                    $returnArr['Details'] = $this->getCompanyDetails($iMemberId);
                }
                else {
                    $returnArr['Details'] = $this->getUserDetails($iMemberId);
                }
                $returnArr['Action'] = '1';
            }
        }
        else {
            $returnArr['Action'] = '0';
            $returnArr['message'] = 'LBL_NOT_FIND';
        }
        return $returnArr;
    }
    private function getDriverDetails($iMemberId, $phoneNo = ''){
        global $obj, $tconfig;
        $sql = '';
        if($phoneNo != ''){
            $sql .= "AND vPhone = '$phoneNo'";
        }
        $query_1 = "SELECT vName,vLastName,vCurrencyDriver,vImage,vPassword,eStatus FROM register_driver WHERE 1 = 1 AND iDriverId = " . $iMemberId . " $sql";
        $register_driver = $obj->MySQLSelect($query_1);
        $return_arr['vPassword'] = $register_driver[0]['vPassword'];
        $return_arr['eStatus'] = $register_driver[0]['eStatus'];
        $return_arr['userName'] = $register_driver[0]['vName'] . ' ' . $register_driver[0]['vLastName'];
        $return_arr['userImage'] = '';
        if(isset($register_driver[0]['vImage'])&& !empty($register_driver[0]['vImage'])){
            $return_arr['userImage'] = $tconfig["tsite_upload_images_driver"] . '/' . $iMemberId . '/3_' . $register_driver[0]['vImage'];
        }
        else {
            $return_arr['userImage'] = 'assets/img/profile-user-img.png';
        }
        return $return_arr;
    }
    private function getCompanyDetails($iCompanyId, $phoneNo = ''){
        global $obj, $tconfig;
        $sql = '';
        if($phoneNo != ''){
            $sql .= "AND vPhone = '$phoneNo'";
        }
        $query_1 = "SELECT vCompany,vImage,vPassword,eStatus FROM company WHERE 1 = 1 AND iCompanyId = " . $iCompanyId . " $sql";
        $company = $obj->MySQLSelect($query_1);
        $return_arr['userName'] = $company[0]['vCompany'];
        $return_arr['vPassword'] = $company[0]['vPassword'];
        $return_arr['eStatus'] = $company[0]['eStatus'];
        if(isset($company[0]['vImage'])&& !empty($company[0]['vImage'])){
            $return_arr['userImage'] = $tconfig['tsite_upload_images_compnay'] . '/' . $iCompanyId . '/3_' . $company[0]['vImage'];
        }
        else {
            $return_arr['userImage'] = 'assets/img/profile-user-img.png';
        }
        return $return_arr;
    }
    private function getUserDetails($iMemberId, $phoneNo = ''){
        global $obj, $tconfig;
        $sql = '';
        if($phoneNo != ''){
            $sql .= "AND vPhone = '$phoneNo'";
        }
        $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName, vImgName,vPassword,eStatus FROM register_user WHERE iUserId = '" . $iMemberId . "' $sql");
        $return_arr['userName'] = $userData[0]['userName'];
        $return_arr['vPassword'] = $userData[0]['vPassword'];
        $return_arr['eStatus'] = $userData[0]['eStatus'];
        $return_arr['userImage'] = '';
        if(isset($userData[0]['vImgName'])&& !empty($userData[0]['vImgName'])){
            $return_arr['userImage'] = $tconfig['tsite_upload_images_passenger'] . "/" . $iMemberId . "/" . $userData[0]['vImgName'];
        }
        else {
            $return_arr['userImage'] = 'assets/img/profile-user-img.png';
        }
        return $return_arr;
    }
    private function getTrackingUserDetails($iMemberId, $phoneNo = ''){
        global $obj, $tconfig;
        $sql = '';
        if($phoneNo != ''){
            $sql .= "AND vPhone = '$phoneNo'";
        }
        $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName, vImage,vPassword,eStatus FROM track_service_users WHERE iTrackServiceUserId = '" . $iMemberId . "' $sql");
        $return_arr['userName'] = $userData[0]['userName'];
        $return_arr['vPassword'] = $userData[0]['vPassword'];
        $return_arr['eStatus'] = $userData[0]['eStatus'];
        $return_arr['userImage'] = '';
        if(isset($userData[0]['vImage'])&& !empty($userData[0]['vImage'])){
            $return_arr['userImage'] = $tconfig['tsite_upload_images_track_company_user'] . "/" . $iMemberId . "/" . $userData[0]['vImage'];
        }
        else {
            $return_arr['userImage'] = 'assets/img/profile-user-img.png';
        }
        return $return_arr;
    }
    public function updateUser($iMemberId){
        global $obj;
        $userData = get_value('register_user', 'vPhone,vFbId', 'iUserId', $iMemberId, '');
        $where = " iUserId = '$iMemberId' ";
        $Data_update_member['eStatus'] = 'Deleted';
        $Data_update_member['vPhone'] = $userData[0]['vPhone'] .'(Deleted)';
        if(!empty($userData[0]['vFbId'])&& $userData[0]['vFbId'] != 0){
            $Data_update_member['vFbId'] = $userData[0]['vFbId'] .'(Deleted)';
        }
        $register_user = $obj->MySQLQueryPerform('register_user', $Data_update_member, 'update', $where);
    }
    public function updateDriver($iMemberId){
        global $obj;
        $driverData = get_value('register_driver', 'vPhone,vFbId', 'iDriverId', $iMemberId, '');
        $where = " iDriverId = '$iMemberId' ";
        $Data_update_member['vPhone'] = $driverData[0]['vPhone'] . '(Deleted)';
        if(!empty($driverData[0]['vFbId'])&& $driverData[0]['vFbId'] != 0){
            $Data_update_member['vFbId'] = $driverData[0]['vFbId'] .'(Deleted)';
        }
        $Data_update_member['eStatus'] = 'Deleted';
        $obj->MySQLQueryPerform('register_driver', $Data_update_member, 'update', $where);
    }
    public function updateCompany($iMemberId){
        global $obj;
        $vPhone = get_value('company', 'vPhone', 'iCompanyId', $iMemberId, '', 'true');
        $where = " iCompanyId = '$iMemberId' ";
        $Data_update_member['vPhone'] = $vPhone .'(Deleted)';
        $Data_update_member['eStatus'] = 'Deleted';
        $obj->MySQLQueryPerform('company', $Data_update_member, 'update', $where);
    }
    public function updateTrackingUser($iMemberId){
        global $obj;
        $vPhone = get_value('track_service_users', 'vPhone', 'iTrackServiceUserId', $iMemberId, '', 'true');
        $where = " iTrackServiceUserId = '$iMemberId' ";
        $Data_update_member['vPhone'] = $vPhone. '(Deleted)';
        $Data_update_member['eStatus'] = 'Deleted';
        $obj->MySQLQueryPerform('track_service_users', $Data_update_member, 'update', $where);
    }
}
class DriverReward {
    public $campaign,$LastRewardId;
    function __construct(){
        $this->campaign = 'reward_campaign';
        $this->LastRewardId = $this->getLastLevel();
    }
    public function getDriverRewardInfo($driverId, $vLanguage){
        global $obj, $tconfig, $LANG_OBJ, $LevelTag;
        $row = array();
        $driverReward = $this->driverAchiveLetestReward($driverId, $vLanguage);
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", '');
        $ActiveCampaign = $this->getActiveCampaign();
        if(!empty($driverReward)&&($driverReward[0]['eRewardLevel'] == $this->LastRewardId)){
            $LevelTag = "Achieved";
        }
        if($LevelTag == "Achieved"){
            if(isset($driverReward)&& empty($driverReward)){
                $returnArr['Action'] = 0;
                $returnArr['message'] = 'LBL_NO_DATA_FOUND';
                setDataResponse($returnArr);
            }
            $completedRewardinfo = $this->completedRewardinfo($driverReward, $vLanguage, $driverId, 'detailsReward');
        }
        else {
            $completedRewardinfo = $this->completedRewardinfo($driverReward, $vLanguage, $driverId, 'nextReward');
        }
        $row = $completedRewardinfo;
        if(!empty($driverReward)&& $driverReward[0]['eRewardLevel'] == $this->LastRewardId){
            $row['reward_completed_text'] = $languageLabelsArr['LBL_REWARD_COMPLETED_TEXT'];
            $row['all_reward_completed'] = 'yes';
            $row['reward_details'] = [];
        }
        else {
            $row['all_reward_completed'] = 'no';
        }
        $rewarimage = $tconfig["tsite_upload_images_reward"] . '/';
        $rewardSettings = $obj->MySQLSelect("SELECT * , CONCAT('" . $rewarimage . "',iRewardId,'/',vImage)as vImage, JSON_UNQUOTE(JSON_VALUE(vLevel, '$.vLevel_" . $vLanguage . "'))as vLevel FROM `reward_settings` WHERE eStatus = 'Active' ORDER BY eRewardLevel ASC ");
        $vCurrency = get_value('register_driver', 'vCurrencyDriver', 'iDriverId', $driverId, '', 'true');
        $currency_ratio = get_value('currency', 'Ratio', 'vName', $vCurrency, '', 'true');
        $rewardSettings_ = [];
        for($i = 0;
        $i < scount($rewardSettings);
        $i++){
            $localdata = $rewardSettings[$i];
            $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => str_replace('#LABEL#', $localdata['vLevel'], $languageLabelsArr['LBL_REWARD_LABEL']), 'vValue' => '');
            if($localdata['vMinimumTrips'] > 0){
                $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_MINIMUM_TRIPS_INFO'], 'vValue' => '≥' . $localdata['vMinimumTrips']);
            }
            if($localdata['fRatings'] > 0){
                $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_RATINGS_INFO'], 'vValue' => '≥' . $localdata['fRatings'] . ' ★');
            }
            if($localdata['iAcceptanceRate'] > 0){
                $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_ACCEPTANCE_RATE_INFO'], 'vValue' => '≥' . $localdata['iAcceptanceRate'] . '%');
            }
            if($localdata['iCancellationRate'] > 0){
                $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_CANCELLATION_RATE_INFO'], 'vValue' => '≤' . $localdata['iCancellationRate'] . '%');
            }
            $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_REWARD_AMOUNT_TXT'], 'vValue' => formateNumAsPerCurrency(calculate($localdata['fCredit'] , $currency_ratio ,'*'), $vCurrency),);
            if($localdata['iOnlineHours'] > 0){
                $rewardSettings_[$i]['level_criteria'][] = array('vTitle' => $languageLabelsArr['LBL_ONLINE_HOURS_REWARD_INFO'], 'vValue' => '≥' . $localdata['iOnlineHours'] . " " . $languageLabelsArr["LBL_HOURS_REWARD_TXT"]);
            }
            $rewardSettings_[$i]['level_criteria'][] = array('content' => $languageLabelsArr['LBL_REWARD_AMOUNT_DESC']);
            if(isset($ActiveCampaign)&& !empty($ActiveCampaign)){
                $driverReward_ = $obj->MySQLSelect("SELECT dr.tHistory, rs.vMinimumTrips as reward_vMinimumTrips, rs.fRatings as reward_fRatings,rs.iAcceptanceRate as reward_iAcceptanceRate,rs.iCancellationRate as reward_iCancellationRate, JSON_UNQUOTE(JSON_VALUE(rs.vLevel, '$.vLevel_".$vLanguage."'))as vLevel,rs.vImage,dr.iRewardId,dr.tDate,dr.iAcceptanceRate,dr.iCancellationRate,dr.fRatings,dr.vMinimumTrips,dr.fCredit FROM `driver_reward` as dr JOIN reward_settings as rs ON dr.iRewardId = rs.iRewardId WHERE dr.iCampaignId = ".$ActiveCampaign[0]['iCampaignId']." AND dr.iRewardId = ".$localdata['iRewardId']." AND dr.iDriverId = ".$driverId." ");
                if(scount($driverReward_)> 0){
                    $d = $this->completedRewardinfo($driverReward_,$vLanguage,$driverId,'detailsReward',1);
                    $d['reward_details'][] = array('content' => $d['REWARD_AMOUNT_TEXT']);
                    $rewardSettings_[$i]['status'] = '1';
                    $rewardSettings_[$i]['data'] = $d;
                }
            }
        }
        $row['reward_earned'] = !empty($driverReward)&& $driverReward[0]['iRewardId'] ? "Yes" : "No";
        $row['default_reward_image'] = $tconfig['tsite_url'] . 'assets/img/reward.png';
        $row['default_reward_title'] = $languageLabelsArr['LBL_REWARD_FEATURE_TITLE'];
        $rewardSettings_ = $this->removeExtraReward($rewardSettings_);
        $row['rewards_to_achieve'] = $rewardSettings_;
        $CampaignDate = $this->getCampaignDate($languageLabelsArr);
        $row['DISPLAY_START_DATE'] = $CampaignDate['DISPLAY_START_DATE'];
        $row['START_DATE'] = $CampaignDate['START_DATE'];
        $row['END_DATE'] = $CampaignDate['END_DATE'];
        $row['ENABLE_ACHIEVED_BTN'] = "Yes";
        $row['ENABLE_NEXT_LEVEL'] = "Yes";
        if(strtoupper($row['reward_earned'])== strtoupper("NO")){
            $row['ENABLE_ACHIEVED_BTN'] = "No";
        }
        if(strtoupper($row['all_reward_completed'])== strtoupper("YES")){
            $row['ENABLE_NEXT_LEVEL'] = "No";
        }
        if($LevelTag == "Achieved"){
            $date_data_array = array('tdate' => $driverReward[0]['tDate'], 'langCode' =>$vLanguage);
            $driverRewardDateFormat = DateformatCls::getNewDateFormat($date_data_array);
            if(!empty($driverRewardDateFormat)){
                $row['DISPLAY_START_DATE'] = $languageLabelsArr['LBL_DRIVER_REWARD_START_DATE_TEXT'] . ' ' . $driverRewardDateFormat['tDisplayDate'];
            }
            $row['START_DATE'] = $languageLabelsArr['LBL_DRIVER_REWARD_ACHIEVED_DATE_TEXT'] . ' ' . DateTime($driverReward[0]['tDate'], 14);
            $row['END_DATE'] = '';
        }
        return $row;
    }
    public function removeExtraReward($rewardSettings_){
        if(isset($rewardSettings_)&& !empty($rewardSettings_)){
            $ARR = [];
            $RewardNotDone = 0;
            foreach($rewardSettings_ as $key => $rewardSettings){
                if($rewardSettings['status'] == 1){
                    $ARR[] = $rewardSettings;
                }
                else {
                    $keyPlusOne = $key + 1;
                    if(!isset($rewardSettings_[$keyPlusOne]['status'])){
                        $ARR[] = $rewardSettings;
                    }
                }
            }
            return $ARR;
        }
    }
    public function completedRewardinfo($driverReward, $vLanguage, $driverId, $type, $how_it_work = 0){
        global $obj, $tconfig, $LANG_OBJ;
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", '');
        $driverRewardId = !empty($driverReward)? $driverReward[0]['iRewardId'] : 0;
        $getnextachivement = $this->getNextAchivementLevel($driverRewardId, $driverId, $vLanguage);
        if($type == 'nextReward'){
            $row['vTitle'] = str_replace("#REWARD#", $getnextachivement['vLevel'], $languageLabelsArr['LBL_REWARD_UNLOCK_TXT']);
            if(!empty($getnextachivement)){
                $row['vImage'] = $tconfig["tsite_upload_images_reward"] . '/' . $getnextachivement['iRewardId'] . '/' . $getnextachivement['vImage'];
            }
            else {
                $row['vImage'] = "";
            }
        }
        if($type == 'detailsReward'){
            $row['vTitle'] = !empty($driverReward)&& $driverReward[0]['vLevel'] ? $driverReward[0]['vLevel'] : '';
            if(!empty($driverReward)){
                $row['vImage'] = $tconfig["tsite_upload_images_reward"] . '/' . $driverReward[0]['iRewardId'] . '/' . $driverReward[0]['vImage'];
            }
            else {
                $row['vImage'] = "";
            }
        }
        $row['REWARD_ACHIEVED_TEXT'] = !empty($driverReward)&& $driverReward[0]['vLevel'] ? $driverReward[0]['vLevel'] : '';
        if(!empty($driverReward)){
            $row['REWARD_ACHIEVED_VIMAGE'] = $tconfig["tsite_upload_images_reward"] . '/' . $driverReward[0]['iRewardId'] . '/' . $driverReward[0]['vImage'];
        }
        else {
            $row['REWARD_ACHIEVED_VIMAGE'] = "";
        }
        $ActiveCampaign = $this->getActiveCampaign();
        $duration_sql = '';
        if(scount($ActiveCampaign)> 0){
            $duration_sql = " AND Date(tEndDate)BETWEEN '" . $ActiveCampaign[0]['dStart_date'] . "' AND '" . $ActiveCampaign[0]['dEnd_date'] . "' ";
        }
        $reward_date = !empty($driverReward)&& $driverReward[0]['tDate'] ? date('M d', strtotime($driverReward[0]['tDate'])): "";
        $Total_trip = $obj->MySQLSelect("SELECT iDriverId FROM `trips` WHERE `iDriverId` = " . $driverId . "");
        $completed_trip = $obj->MySQLSelect("SELECT iDriverId FROM `trips` WHERE `iDriverId` = " . $driverId . " AND iActive = 'Finished' $duration_sql ");
        $uncompleted_trip = $obj->MySQLSelect("SELECT iDriverId FROM `trips` WHERE `iDriverId` = " . $driverId . " AND iActive NOT IN('Finished')");
        $row['completed_trip'] =(scount($completed_trip)> $getnextachivement['vMinimumTrips'])? $getnextachivement['vMinimumTrips'] : scount($completed_trip);
        $row['completed_trip'] = !empty($row['completed_trip'])? $row['completed_trip'] : 0;
        if(scount($ActiveCampaign)== 0){
            $row['completed_trip'] = 0;
        }
        $row['Total_trip'] = !empty($getnextachivement['vMinimumTrips'])? $getnextachivement['vMinimumTrips'] : 0;
        $row['Uncompleted_trip'] = $row['Total_trip'] - $row['completed_trip'];
        $getnextachivementdate = !empty($getnextachivement['tDate'])? date('M d', strtotime($getnextachivement['tDate'])): "";
        $co = date('y-m-d H:i:s', strtotime("+" . $getnextachivement['iDuration'] . "days"));
        $getnextachivementdate = $co ? date('d M', strtotime($co)): "";
        $row['unlock_date'] = str_replace(array('#TITLE#'), array($getnextachivement['vLevel']), $languageLabelsArr['LBL_REWARD_UNLOCK_DATE']);
        $completed_trip_percentage = round(calculate($row['completed_trip'] , $row['Total_trip'] , '/')* 100);
        $uncompleted_trip_percentage = round(calculate($row['Uncompleted_trip'] , $row['Total_trip'] ,'/')* 100);
        $row['completed_trip_percentage'] =($completed_trip_percentage > 0)? $completed_trip_percentage : 0;
        $row['uncompleted_trip_percentage'] =($uncompleted_trip_percentage > 0)? $uncompleted_trip_percentage : 0;
        if($type == 'detailsReward'){
            $History = $driverReward[0]['tHistory'];
            $History = json_decode($History,true);
            $row['Uncompleted_trip'] = 0;
            $row['completed_trip_percentage'] = 100;
            $row['uncompleted_trip_percentage'] = 0;
            if(isset($History['fRatings'])){
                $driverReward[0]['reward_fRatings'] = $History['fRatings'];
            }
            if(isset($History['iAcceptanceRate'])){
                $driverReward[0]['reward_iAcceptanceRate'] = $History['iAcceptanceRate'];
            }
            if(isset($History['iCancellationRate'])){
                $driverReward[0]['reward_iCancellationRate'] = $History['iCancellationRate'];
            }
            if(isset($History['vMinimumTrips'])){
                $driverReward[0]['reward_vMinimumTrips'] = $History['vMinimumTrips'];
            }
            if($how_it_work == 1){
                $row['reward_details'][] = array('AchivedTitle' => $row['vTitle'],);
            }
            if($driverReward[0]['vMinimumTrips'] > 0){
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_MINIMUM_TRIPS'], 'vValue' => !empty($driverReward[0]['reward_vMinimumTrips'])? $driverReward[0]['reward_vMinimumTrips'] : 0, 'is_completed' => 'Yes', 'TEXT' => $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"],);
            }
            if($driverReward[0]['reward_fRatings'] > 0){
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_STAR_RATING'], 'vValue' => !empty($driverReward[0]['reward_fRatings'])? $driverReward[0]['reward_fRatings'] : 0, 'is_completed' => 'Yes', 'TEXT' => $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"],);
            }
            if($driverReward[0]['reward_iAcceptanceRate'] > 0){
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_ACCEPTANCE_RATE_REWARD'], 'vValue' => $driverReward[0]['reward_iAcceptanceRate'] . '%', 'is_completed' => 'Yes', 'TEXT' => $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"],);
            }
            if($driverReward[0]['reward_iCancellationRate'] > 0){
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_CANCELLATION_RATE_REWARD'], 'vValue' => $driverReward[0]['reward_iCancellationRate'] . '%', 'is_completed' => 'Yes', 'TEXT' => $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"],);
            }
            if($driverReward[0]['iOnlineHours'] > 0){
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_ONLINE_HOURS_REWARD_TEXT'], 'vValue' => $driverReward[0]['iOnlineHours'] . " " . $languageLabelsArr["LBL_HOURS_REWARD_TXT"], 'is_completed' => 'Yes', 'TEXT' => $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"],);
            }
        }
        if($type == 'nextReward'){
            if($getnextachivement['vMinimumTrips'] > 0){
                $completed_trip_count = scount($completed_trip);
                $Trips = "No";
                if($getnextachivement['vMinimumTrips'] <= $completed_trip_count){
                    $Trips = "Yes";
                }
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_MINIMUM_TRIPS'], 'vValue' => !empty($getnextachivement['vMinimumTrips'])? $getnextachivement['vMinimumTrips'] : 0, 'is_completed' => $Trips, 'TEXT' => $Trips == "Yes" ? $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"] : $languageLabelsArr["LBL_DRIVER_REWARD_PENDING_TEXT"],);
            }
            if($getnextachivement['fRatings'] > 0){
                $Ratings = $this->checkRewardCriteria($driverId, 'rating', $getnextachivement['fRatings']);
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_STAR_RATING'], 'vValue' => !empty($getnextachivement['fRatings'])? $getnextachivement['fRatings'] : 0, 'is_completed' => $Ratings, 'TEXT' => $Ratings == "Yes" ? $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"] : $languageLabelsArr["LBL_DRIVER_REWARD_PENDING_TEXT"],);
            }
            if($getnextachivement['iAcceptanceRate'] > 0){
                $iAcceptanceRate = $this->checkRewardCriteria($driverId, 'acceptance_rate', $getnextachivement['iAcceptanceRate']);
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_ACCEPTANCE_RATE_REWARD'], 'vValue' => $getnextachivement['iAcceptanceRate'] . '%', 'is_completed' => $iAcceptanceRate, 'TEXT' => $iAcceptanceRate == "Yes" ? $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"] : $languageLabelsArr["LBL_DRIVER_REWARD_PENDING_TEXT"],);
            }
            if($getnextachivement['iCancellationRate'] > 0){
                $iCancellationRate = $this->checkRewardCriteria($driverId, 'cancellation_rate', $getnextachivement['iCancellationRate']);
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_CANCELLATION_RATE_REWARD'], 'vValue' => $getnextachivement['iCancellationRate'] . '%', 'is_completed' => $iCancellationRate, 'TEXT' => $iCancellationRate == "Yes" ? $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"] : $languageLabelsArr["LBL_DRIVER_REWARD_PENDING_TEXT"],);
            }
            if($getnextachivement['iOnlineHours'] > 0){
                $iOnlineHours = $this->checkRewardCriteria($driverId, 'checkOnlineHours', $getnextachivement['iOnlineHours']);
                $row['reward_details'][] = array('vTitle' => $languageLabelsArr['LBL_ONLINE_HOURS_REWARD_TEXT'], 'vValue' => $getnextachivement['iOnlineHours'] . " " . $languageLabelsArr["LBL_HOURS_REWARD_TXT"], 'is_completed' => $iOnlineHours, 'TEXT' => $iOnlineHours == "Yes" ? $languageLabelsArr["LBL_DRIVER_REWARD_ACHIEVED_TEXT"] : $languageLabelsArr["LBL_DRIVER_REWARD_PENDING_TEXT"],);
            }
        }
        $row['REWARD_HOW_IT_WORKS'] = $tconfig['tsite_url'] . 'reward_how_it_work.php?iPageId=57&vLang=' . $vLanguage;
        if($type == 'nextReward'){
            $row['REWARD_AMOUNT'] = $this->getDriverCurrency($driverId, $getnextachivement['fCredit']);
            $row['REWARD_AMOUNT_TEXT'] = $languageLabelsArr["LBL_REWARD_AMOUNT_DESC_TXT"];
        }
        else {
            $row['REWARD_AMOUNT'] = $this->getDriverCurrency($driverId, $driverReward[0]['fCredit']);
            $row['completed_trip'] = $row['Total_trip'] = $driverReward[0]['vMinimumTrips'];
            $row['REWARD_AMOUNT_TEXT'] = str_replace(['#AMOUNT#'], [$row['REWARD_AMOUNT']], $languageLabelsArr["LBL_REWARD_CREDITED_INTO_WALLET_TEXT"]);
        }
        return $row;
    }
    public function getNextAchivementLevel($iRewardId, $driverId, $vLanguage){
        $driverReward = $this->driverAchiveLetestReward($driverId, $vLanguage);
        if(scount($driverReward)> 0){
            $driverReward_ = $driverReward[0];
            $iRewardId = $this->IsEnableReward($driverReward_['eRewardLevel']);
            $rewarddata = $this->getrewardLevel($iRewardId, $vLanguage);
        }
        else {
            $iRewardId = 1;
            $iRewardId = $this->IsEnableReward(0);
            $rewarddata = $this->getrewardLevel($iRewardId, $vLanguage);
        }
        return $rewarddata;
    }
    public function IsEnableReward($iRewardId = 0){
        global $obj;
        $rewardSettings = $obj->MySQLSelect("SELECT eRewardLevel FROM `reward_settings` WHERE eRewardLevel > {
            $iRewardId
        }
        AND eStatus = 'Active' ORDER BY eRewardLevel ASC ");
        if(isset($rewardSettings)&& !empty($rewardSettings)){
            return $rewardSettings[0]['eRewardLevel'];
        }
    }
    public function getLastLevel(){
        global $obj;
        $rewardSettings = $obj->MySQLSelect("SELECT MAX(eRewardLevel)as eRewardLevel FROM `reward_settings` WHERE eStatus = 'Active'");
        if(isset($rewardSettings)&& !empty($rewardSettings)){
            return $rewardSettings[0]['eRewardLevel'];
        }
    }
    public function assignDriverReward($driverId){
        global $obj;
        $ActiveCampaign = $this->getActiveCampaign();
        if(scount($ActiveCampaign)== 0){
            return 0;
        }
        $duration_sql = " AND Date(tDate)BETWEEN '" . $ActiveCampaign[0]['dStart_date'] . "' AND '" . $ActiveCampaign[0]['dEnd_date'] . "' ";
        $sql = "SELECT rs.iDriverId,COUNT(case when rs.eStatus = 'Accept' then 1 else NULL end)`Accept` , COUNT(case when rs.eStatus != '' then 1 else NULL end)`Total Request` , COUNT(case when(rs.eStatus = 'Decline' AND rs.eAcceptAttempted = 'No')then 1 else NULL end)`Decline` , COUNT(case when rs.eAcceptAttempted = 'Yes' then 1 else NULL end)`Missed` FROM driver_request rs WHERE iDriverId = " . $driverId . $duration_sql;
        $driver_request = $obj->MySQLSelect($sql);
        $Accept = $driver_request[0]['Accept'];
        $Request = $driver_request[0]['Total Request'];
        $missed = $driver_request[0]['Missed'];
        $aceptance_percentage = round(calculate((100 *($Accept + $missed)), $Request , '/'), 2);
        $duration_sql_1 = " AND Date(tEndDate)BETWEEN '" . $ActiveCampaign[0]['dStart_date'] . "' AND '" . $ActiveCampaign[0]['dEnd_date'] . "' ";
        $trips = $obj->MySQLSelect("SELECT iDriverId ,COUNT(case when iActive = 'Canceled' then 1 else NULL end)`Total_Canceled` , COUNT(case when iActive != '' then 1 else NULL end)`Total_Request` , COUNT(case when iActive != '' AND iActive = 'Finished' then 1 else NULL end)`minimum_trip` FROM `trips` WHERE `iDriverId` = " . $driverId . " $duration_sql_1");
        $cancellation_rate = round(calculate($trips[0]['Total_Canceled'] , $trips[0]['Total_Request'] , '/')* 100);
        $minimum_trip = $trips[0]['minimum_trip'];
        $register_driver_vAvgRating = CalculateMemberAvgRating($driverId, 'Driver', $ActiveCampaign[0]['dStart_date'], $ActiveCampaign[0]['dEnd_date']);
        return $this->rewardCalculation($driverId, $day = 0, $minimum_trip, $register_driver_vAvgRating, $aceptance_percentage, $cancellation_rate);
    }
    public function driverAchiveLetestReward($driverId, $vLanguage){
        global $obj;
        $ActiveCampaign = $this->getActiveCampaign();
        $sql1 = '';
        if(scount($ActiveCampaign)== 0){
            $ActiveCampaignId = 0;
            $sql1 .= 'AND dr.iCampaignId = "' . $ActiveCampaignId . '"';
        }
        else {
            $ActiveCampaignId = $ActiveCampaign[0]['iCampaignId'];
            $sql1 .= 'AND dr.iCampaignId = "' . $ActiveCampaignId . '"';
        }
        $driverReward = $obj->MySQLSelect("SELECT dr.tHistory ,JSON_UNQUOTE(JSON_VALUE(rs.vLevel, '$.vLevel_" . $vLanguage . "'))as vLevel ,rs.vImage,dr.eRewardLevel,dr.iRewardId,dr.tDate,dr.iAcceptanceRate,dr.iCancellationRate,dr.fRatings,dr.iCampaignId , dr.fCredit , dr.vMinimumTrips FROM `driver_reward` as dr JOIN reward_settings as rs ON dr.iRewardId = rs.iRewardId WHERE dr.iDriverId = " . $driverId . " $sql1 ORDER BY dr.iDriverReward DESC");
        return $driverReward;
    }
    public function getrewardLevel($iRewardId, $vLanguage){
        global $obj, $oCache;
        $rewardSettingsApcKey = md5('REWARD_SETTINGS_' . $vLanguage);
        $getRewardSettingsCacheData = $oCache->getData($rewardSettingsApcKey);
        if(!empty($getRewardSettingsCacheData)&& scount($getRewardSettingsCacheData)> 0){
            $rewardSettings = $getRewardSettingsCacheData;
        }
        else {
            $rewardSettings = $obj->MySQLSelect("SELECT * , JSON_UNQUOTE(JSON_VALUE(vLevel, '$.vLevel_" . $vLanguage . "'))as vLevel FROM `reward_settings` ");
            $oCache->setData($rewardSettingsApcKey, $rewardSettings);
        }
        $rewardSettings = $obj->MySQLSelect("SELECT * , JSON_UNQUOTE(JSON_VALUE(vLevel, '$.vLevel_" . $vLanguage . "'))as vLevel FROM `reward_settings` ");
        $rewardSettingsArr = array();
        foreach($rewardSettings as $setting){
            $rewardSettingsArr[$setting['eRewardLevel']] = $setting;
        }
        return $rewardSettingsArr[$iRewardId];
    }
    public function rewardCalculation($driverId, $day, $minimum_trip, $register_driver_vAvgRating, $aceptance_percentage, $cancellation_rate){
        global $WALLET_OBJ, $obj;
        $vLanguage = get_value('register_driver', 'vLang', 'iDriverId', $driverId, '', 'true');
        if($vLanguage == "" || $vLanguage == NULL){
            $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $driverReward = $this->driverAchiveLetestReward($driverId, $vLanguage);
        $rewarddata = $this->getNextAchivementLevel($driverReward[0]['iRewardId'], $driverId, $vLanguage);
        $yes_to_reaward = [];
        if(scount($driverReward)> 0){
            $driverReward_ = $driverReward[0];
            if($driverReward_['eRewardLevel'] == $this->LastRewardId){
                $yes_to_reaward['status'] = 2;
                return $yes_to_reaward;
            }
        }
        if($rewarddata['vMinimumTrips'] <= $minimum_trip && $rewarddata['fRatings'] <= $register_driver_vAvgRating && $rewarddata['iAcceptanceRate'] <= $aceptance_percentage && $rewarddata['iCancellationRate'] >= $cancellation_rate){
            $tbl_name = "driver_reward";
            $ActiveCampaign = $this->getActiveCampaign();
            $Campaign = '';
            if(scount($ActiveCampaign)> 0){
                $Campaign = "`iCampaignId` = '" . $ActiveCampaign[0]['iCampaignId'] . "',";
            }
            $yes_to_reaward['status'] = 1;
            $q = "INSERT INTO ";
            $where = '';
            $query = $q . " `" . $tbl_name . "` SET `iDriverId` = '" . $driverId . "', `iRewardId` = '" . $rewarddata['iRewardId'] . "', `eRewardLevel` = '" . $rewarddata['eRewardLevel'] . "', `vMinimumTrips` = '" . $minimum_trip . "', `fRatings` = '" . $register_driver_vAvgRating . "', `iAcceptanceRate` = '" . $aceptance_percentage . "', `iCancellationRate` = '" . $cancellation_rate . "', `iDuration` = '" . $day . "', `tHistory` = '" . $this->makeHistoryArr($rewarddata['eRewardLevel']). "', $Campaign `fCredit` = '" . $rewarddata['fCredit'] . "', `tDate` = '" . date("y-m-d H:i:s"). "'" . $where;
            $obj->sql_query($query);
            $data_wallet['iUserId'] = $driverId;
            $data_wallet['eUserType'] = "Driver";
            $data_wallet['iBalance'] = $rewarddata['fCredit'];
            $data_wallet['eType'] = "Credit";
            $data_wallet['dDate'] = date("Y-m-d H:i:s");
            $data_wallet['iTripId'] = 0;
            $data_wallet['eFor'] = "Deposit";
            $data_wallet['ePaymentStatus'] = "Settelled";
            $data_wallet['tDescription'] = "#LBL_REWARD_AMOUNT_CREDITED# " . $rewarddata['vLevel'];
            $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], $data_wallet['iTripId'], $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
            $this->driverNoti($driverId, $rewarddata['vLevel'], $rewarddata['fCredit']);
        }
        else {
            $yes_to_reaward['status'] = 0;
        }
        return $yes_to_reaward;
    }
    public function getAllCampaign(){
        global $obj, $LANG_OBJ;
        $vLanguage = $LANG_OBJ->FetchSystemDefaultLang();
        $campaign = $obj->MySQLSelect("SELECT iCampaignId,eCurrentActive,vTitle as Title FROM " . $this->campaign . " WHERE eStatus = 'Active' AND dEnd_date >= CURDATE()");
        return $campaign;
    }
    public function getActiveCampaign(){
        global $obj;
        $todayDate = date('Y-m-d');
        $campaign = $obj->MySQLSelect("SELECT iCampaignId,vTitle,dStart_date,dEnd_date FROM " . $this->campaign . " WHERE dStart_date <= '$todayDate' AND dEnd_date >= '$todayDate' AND eStatus = 'Active' LIMIT 1");
        return $campaign;
    }
    public function updateCurrentActiveCampaign($CurrentActive){
        global $obj, $LANG_OBJ;
        $vLanguage = $LANG_OBJ->FetchSystemDefaultLang();
        $campaign = $obj->MySQLSelect("SELECT iCampaignId,eCurrentActive,vTitle as Title FROM " . $this->campaign . " WHERE eCurrentActive = 'Yes' AND dEnd_date >= CURDATE()");
        $arr = [];
        if(scount($campaign)== 0){
            $obj->sql_query("UPDATE campaign SET eCurrentActive = 'No'");
            $query_p['eCurrentActive'] = 'Yes';
            $where = " iCampaignId = '$CurrentActive'";
            $obj->MySQLQueryPerform($this->campaign, $query_p, 'update', $where);
            $arr['status'] = 1;
        }
        else {
            $arr['status'] = 0;
        }
        return $arr;
    }
    public function getCampaign(){
        global $obj;
        $campaign = $obj->MySQLSelect("SELECT iCampaignId,dStart_date,dEnd_date,eStatus,eCurrentActive,vTitle as Title FROM " . $this->campaign);
        return $campaign;
    }
    public function getCampaignById($id){
        global $obj, $LANG_OBJ;
        $vLanguage = $LANG_OBJ->FetchSystemDefaultLang();
        $campaign = $obj->MySQLSelect("SELECT vTitle as vTitle_json,iCampaignId,dStart_date,dEnd_date,eStatus,eCurrentActive,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as Title FROM " . $this->campaign . " WHERE iCampaignId = " . $id . "");
        return $campaign[0];
    }
    public function notifyCampaignCancelled($campaign_id){
        global $obj, $EVENT_MSG_OBJ, $LANG_OBJ, $default_lang;
        $campaign = $obj->MySQLSelect("SELECT iCampaignId FROM " . $this->campaign . " WHERE dStart_date <= CURDATE()AND dEnd_date >= CURDATE()AND iCampaignId = '$campaign_id'");
        if(!empty($campaign)&& scount($campaign)> 0){
            $all_drivers = $obj->MySQLSelect("SELECT iDriverId, iGcmRegId, eDebugMode, eAppTerminate, eDeviceType, eHmsDevice FROM register_driver WHERE eStatus = 'Active'");
            $lang_labels = $LANG_OBJ->FetchLanguageLabels($default_lang, "1", "");
            $final_message = array();
            $final_message['Message'] = "RewardProgramCancelled";
            $final_message['MsgType'] = "RewardProgramCancelled";
            $final_message['vTitle'] = $lang_labels['LBL_REWARD_PROGRAM_CANCELLED_ADMIN'];
            $final_message['time'] = time();
            $generalDataArr = array();
            foreach($all_drivers as $driver){
                $generalDataArr[] = array('eDeviceType' => $driver['eDeviceType'], 'deviceToken' => $driver['iGcmRegId'], 'alertMsg' => $lang_labels['LBL_REWARD_PROGRAM_CANCELLED_ADMIN'], 'eAppTerminate' => $driver['eAppTerminate'], 'eDebugMode' => $driver['eDebugMode'], 'eHmsDevice' => $driver['eHmsDevice'], 'message' => $final_message, 'channelName' => "DRIVER_" . $driver['iDriverId']);
            }
            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
        }
    }
    public function validateCampaignDates($start_date, $end_date, $campaign_id){
        global $obj;
        $ssql = "";
        if(!empty($campaign_id)){
            $ssql = " AND iCampaignId != '$campaign_id' ";
        }
        if(!empty($start_date)){
            $start_date = date('Y-m-d', strtotime($start_date));
            $campaign = $obj->MySQLSelect("SELECT iCampaignId FROM reward_campaign WHERE '$start_date' >= dStart_date AND '$start_date' <= dEnd_date AND eStatus = 'Active' $ssql");
            if(!empty($campaign)&& scount($campaign)> 0){
                return false;
            }
        }
        if(!empty($end_date)){
            $end_date = date('Y-m-d', strtotime($end_date));
            $campaign = $obj->MySQLSelect("SELECT iCampaignId FROM reward_campaign WHERE '$end_date' >= dStart_date AND '$end_date' <= dEnd_date AND eStatus = 'Active' $ssql");
            if(!empty($campaign)&& scount($campaign)> 0){
                return false;
            }
        }
        return true;
    }
    private function checkRewardCriteria($iDriverId, $criteria, $value){
        global $obj;
        $ActiveCampaign = $this->getActiveCampaign();
        if(scount($ActiveCampaign)== 0){
            return 0;
        }
        if($criteria == "rating"){
            $register_driver_vAvgRating = CalculateMemberAvgRating($iDriverId, 'Driver', $ActiveCampaign[0]['dStart_date'], $ActiveCampaign[0]['dEnd_date']);
            if($register_driver_vAvgRating >= $value){
                return "Yes";
            }
        }
        elseif($criteria == "acceptance_rate"){
            $duration_sql = " AND Date(tDate)BETWEEN '" . $ActiveCampaign[0]['dStart_date'] . "' AND '" . $ActiveCampaign[0]['dEnd_date'] . "' ";
            $sql = "SELECT rs.iDriverId,COUNT(case when rs.eStatus = 'Accept' then 1 else NULL end)`Accept` , COUNT(case when rs.eStatus != '' then 1 else NULL end)`Total Request` , COUNT(case when(rs.eStatus = 'Decline' AND rs.eAcceptAttempted = 'No')then 1 else NULL end)`Decline` , COUNT(case when rs.eAcceptAttempted = 'Yes' then 1 else NULL end)`Missed` FROM driver_request rs WHERE iDriverId = " . $iDriverId . $duration_sql;
            $driver_request = $obj->MySQLSelect($sql);
            $Accept = $driver_request[0]['Accept'];
            $Request = $driver_request[0]['Total Request'];
            $missed = $driver_request[0]['Missed'];
            $acceptance_percentage = round(calculate((100 *($Accept + $missed)), $Request , '/'), 2);
            if($acceptance_percentage >= $value){
                return "Yes";
            }
        }
        elseif($criteria == "cancellation_rate"){
            $duration_sql_1 = " AND Date(tEndDate)BETWEEN '" . $ActiveCampaign[0]['dStart_date'] . "' AND '" . $ActiveCampaign[0]['dEnd_date'] . "' ";
            $trips = $obj->MySQLSelect("SELECT iDriverId ,COUNT(case when iActive = 'Canceled' then 1 else NULL end)`Total_Canceled` , COUNT(case when iActive != '' then 1 else NULL end)`Total_Request` , COUNT(case when iActive != '' AND iActive = 'Finished' then 1 else NULL end)`minimum_trip` FROM `trips` WHERE `iDriverId` = " . $iDriverId . " $duration_sql_1");
            $cancellation_rate = round(calculate($trips[0]['Total_Canceled'] , $trips[0]['Total_Request'] ,'/')* 100);
            if($cancellation_rate <= $value){
                return "Yes";
            }
        }
        elseif($criteria == "checkOnlineHours"){
            $OnlineHours = $this->checkWorkingHours($iDriverId, $value);
            if($OnlineHours){
                return "Yes";
            }
        }
        return "No";
    }
    public function checkWorkingHours($iDriverId, $iOnlineHours){
        $dayWiseHours = $this->getDriverDateWiseWorkingHours($iDriverId);
        if(isset($dayWiseHours)&& !empty($dayWiseHours)){
            foreach($dayWiseHours as $day){
                if($day < $iOnlineHours){
                    return false;
                }
            }
            return true;
        }
    }
    public function getDriverDateWiseWorkingHours($iDriverId){
        $getActiveCamData = $this->getActiveCampaign();
        if(isset($getActiveCamData)&& !empty($getActiveCamData)){
            $StartDate = $getActiveCamData[0]['dStart_date'];
            $EndDate = $getActiveCamData[0]['dEnd_date'];
            $dataArr = $this->getDatesFromRange($StartDate, $EndDate);
            if($StartDate == $EndDate){
                $dataArr = [$StartDate];
            }
            $dayWiseTotalHours = [];
            if(isset($dataArr)&& !empty($dataArr)){
                foreach($dataArr as $date){
                    $dayWiseTotalHours[$date] = 0;
                }
            }
            if(isset($dataArr)&& !empty($dataArr)){
                foreach($dataArr as $date){
                    $startDate = $date . " 00:00:00";
                    $endDate = $date . " 23:59:59";
                    $startDate = date('Y-m-d H:i:s', strtotime($startDate));
                    $endDate = date('Y-m-d H:i:s', strtotime($endDate));
                    $dayWiseTotalHours = $this->CheckDriverWorkingHours($iDriverId, $startDate, $endDate, $date, $dayWiseTotalHours);
                }
            }
            return $dayWiseTotalHours;
        }
    }
    private function getDatesFromRange($start, $end, $format = 'Y-m-d'){
        return array_map(function($timestamp)use($format){
            return date($format, $timestamp);
        }
        , range(strtotime($start)+($start < $end ? 4000 : 8000), strtotime($end)+($start < $end ? 8000 : 4000), 86400));
    }
    private function CheckDriverWorkingHours($iDriverId, $startDate, $endDate, $date, $dayWiseTotalHours){
        global $obj;
        $startDate = $startDate;
        $endDate = $endDate;
        $driver_log_report = $obj->MySQLSelect("SELECT dlr.dLoginDateTime, dlr.dLogoutDateTime FROM driver_log_report AS dlr LEFT JOIN register_driver AS rd ON rd.iDriverId = dlr.iDriverId WHERE dlr.iDriverId = '$iDriverId' AND Date(dlr.dLoginDateTime)BETWEEN '$startDate' AND '$endDate' ORDER BY dlr.iDriverLogId DESC");
        $total_time = 0;
        $last_log_date = "";
        if(!empty($driver_log_report)){
            $log_count = 0;
            foreach($driver_log_report as $log){
                $dstart1 = $log['dLoginDateTime'];
                if(!($log['dLogoutDateTime'] == '0000-00-00 00:00:00' || $log['dLogoutDateTime'] == '')){
                    $dLogoutDateTime1 = $log['dLogoutDateTime'];
                    $LoginDate = date('Y-m-d', strtotime($dstart1));
                    $LogOutDate = date('Y-m-d', strtotime($dLogoutDateTime1));
                    if($LoginDate == $LogOutDate){
                        $totalhours1 = get_left_days_jobsave($dLogoutDateTime1, $dstart1);
                        $total_time += $totalhours1;
                    }
                    else {
                        $dStart_ORG = $dstart1;
                        $dLogoutDateTime = $date . " 23:59:59";
                        $totalhours1 = get_left_days_jobsave($dLogoutDateTime, $dStart_ORG);
                        $total_time += $totalhours1;
                        $dStart_date = date('Y-m-d', strtotime($dStart_ORG));
                        $dEnd_date = date('Y-m-d', strtotime($dLogoutDateTime1));
                        $dataArr = $this->getDatesFromRange($dStart_date, $dEnd_date);
                        if(isset($dataArr)&& !empty($dataArr)){
                            $lastKey = scount($dataArr)- 1;
                            foreach($dataArr as $key => $date1){
                                if(!in_array($key, [0])&& $lastKey != $key){
                                    $totalhour = 24;
                                    $dayWiseTotalHours[$date1] = $totalhour;
                                }
                                else if($lastKey == $key){
                                    $dStart_ORG = $date1 . " 00:00:00";
                                    $dLogoutDateTime = $dLogoutDateTime1;
                                    $totalhour = get_left_days_jobsave($dLogoutDateTime, $dStart_ORG);
                                    if($totalhour > 0){
                                        $totalhour = $this->secondMinutes($totalhour);
                                    }
                                    $dayWiseTotalHours[$date1] = $totalhour;
                                }
                            }
                        }
                    }
                }
            }
        }
        if($total_time > 0){
            $total_time = $this->secondMinutes($total_time);
        }
        $dayWiseTotalHours[$date] = $dayWiseTotalHours[$date] + $total_time;
        return $dayWiseTotalHours;
    }
    private function secondMinutes($seconds){
        $hours = floor($seconds / 3600);
        $seconds -= $hours * 3600;
        $minutes = floor($seconds / 60);
        $seconds -= $minutes * 60;
        $total = $hours . "." . $minutes;
        return $total;
    }
    public function driverNoti($DriverId, $level, $amount){
        global $COMM_MEDIA_OBJ, $obj, $EVENT_MSG_OBJ, $LANG_OBJ;
        $vLangCode = isset($_REQUEST['vGeneralLang'])? clean($_REQUEST['vGeneralLang']): '';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $Amount = $this->getDriverCurrency($DriverId, $amount);
        $row1 = $obj->MySQLSelect("SELECT vEmail, vCode , vPhone, eHmsDevice , iDriverId, vCurrencyDriver, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName FROM `register_driver` WHERE iDriverId = '" . $DriverId . "'");
        $vLangCode = $row1[0]['vLang'];
        $DriverName = $row1[0]['vName'] . ' ' . $row1[0]['vLastName'];
        $Data_SMS['REWARD_NAME'] = $level;
        $Data_SMS['DRIVER_NAME'] = $DriverName;
        $vPhone = $row1[0]['vPhone'];
        $vCode = $row1[0]['vCode'];
        $sms_message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate("NOTIFY_DRIVER_ABOUT_REWARD", $Data_SMS, "", $vLangCode);
        $result_sms = $COMM_MEDIA_OBJ->SendSystemSMS($vPhone, $vCode, $sms_message_layout);
        if(isset($row1[0]['vEmail'])&& !empty($row1[0]['vEmail'])){
            $MAIL_TEMPLATE = "REWARD_AMOUNT_CREDIT_TO_DRIVER";
            $mailArr['REWARD_NAME'] = $level;
            $mailArr['DRIVER_NAME'] = $DriverName;
            $mailArr['vEmail'] = $row1[0]['vEmail'];
            $mailArr['AMOUNT'] = $Amount;
            $arr['MAIL'] = $COMM_MEDIA_OBJ->SendMailToMember($MAIL_TEMPLATE, $mailArr);
        }
        $alertMsg = str_replace([ '#DRIVER_NAME#', '#REWARD_NAME#' ], [ $DriverName, $level ], $languageLabelsArr["NOTIFY_DRIVER_ABOUT_REWARD_TEXT"]);
        $generalDataArr = $final_message = array();
        $generalDataArr[] = array('eDeviceType' => $row1[0]['eDeviceType'], 'deviceToken' => $row1[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $row1[0]['eAppTerminate'], 'eDebugMode' => $row1[0]['eDebugMode'], 'message' => $alertMsg, 'eHmsDevice' => $row1[0]['eHmsDevice']);
        $arr['NOTIFICATION'] = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
    }
    function getDriverCurrency($DriverId, $amount){
        global $obj;
        $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username, vCurrencyDriver from register_driver where iDriverId='" . $DriverId . "'";
        $db_user_data = $obj->MySQLSelect($sql12);
        $vCurrencyDriver = $db_user_data[0]['vCurrencyDriver'];
        $userCurrencyData = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='" . $vCurrencyDriver . "'");
        $userCurrencySymbol = $userCurrencyData[0]['vSymbol'];
        $userCurrencyRatio = $userCurrencyData[0]['Ratio'];
        $Userrewardamounts = round(($amount * $userCurrencyRatio), 2);
        return formateNumAsPerCurrency($Userrewardamounts, $vCurrencyDriver);
    }
    function getCampaignDate($languageLabelsArr){
        $ActiveCampaign = $this->getActiveCampaign();
        $arr = [];
        if(isset($ActiveCampaign)&& !empty($ActiveCampaign)){
            $ActiveCampaign = $ActiveCampaign[0];
            $date_data_array = array('tdate' => $ActiveCampaign['dStart_date'], 'langCode' =>'EN');
            $ActiveCampaignStartDateFormat = DateformatCls::getNewDateFormat($date_data_array);
            if(!empty($ActiveCampaignStartDateFormat)){
                $arr['DISPLAY_START_DATE'] = $languageLabelsArr['LBL_DRIVER_REWARD_START_DATE_TEXT'] . ' ' . $ActiveCampaignStartDateFormat['tDisplayDate'];
            }
            $arr['START_DATE'] = $languageLabelsArr['LBL_DRIVER_REWARD_START_DATE_TEXT'] . ' ' . DateTime($ActiveCampaign['dStart_date'], 14);
            $arr['END_DATE'] = $languageLabelsArr['LBL_DRIVER_REWARD_END_DATE_TEXT'] . ' ' . $languageLabelsArr['LBL_DRIVER_REWARD_ONGOING_TEXT'];
            return $arr;
        }
    }
    function isDriverRewardEnable(){
        global $obj;
        $DriverReward = false;
        $userCurrencyData = $obj->MySQLSelect("SELECT COUNT(iRewardId)as count FROM `reward_settings` WHERE eStatus = 'Active'");
        if($userCurrencyData[0]['count'] > 0){
            $DriverReward = true;
        }
        return $DriverReward;
    }
    function makeHistoryArr($iRewardId){
        global $obj;
        $data = $this->getrewardLevel($iRewardId,'');
        unset($data['vLevel'] ,$data['vImage']);
        return json_encode($data);
    }
}
class GiftCard {
    public $GiftCardImageTable,$GiftCardTable;
    function __construct(){
        $this->GiftCardImageTable = 'gift_card_images';
        $this->GiftCardTable = 'gift_cards';
    }
    public function getGiftCardImages($id = ''){
        global $obj, $tconfig, $LANG_OBJ, $Data_ALL_langArr;
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "loadStaticInfo"){
            $all_images = $obj->MySQLSelect("SELECT * FROM $this->GiftCardImageTable WHERE eStatus = 'Active' ");
            $imageArr = [];
            foreach($all_images as $image){
                $imageArr[$image['vCode']][] = array('vImage' => $tconfig["tsite_upload_images_gift_card"] . '/' . $image['vImage'], 'iGiftCardImageId' => $image['iGiftCardImageId']);
            }
            if(!empty($Data_ALL_langArr)&& scount($Data_ALL_langArr)> 0){
                $language_master = $Data_ALL_langArr;
            }
            else {
                $language_master = $obj->MySQLSelect("SELECT vCode FROM language_master ORDER BY iDispOrder ASC");
            }
            $langImagesArr = array();
            foreach($language_master as $lang){
                $langImagesArr[$lang['vCode']] = $imageArr[$lang['vCode']];
            }
            return $langImagesArr;
        }
        $vLangCode = isset($_REQUEST['vGeneralLang'])? clean($_REQUEST['vGeneralLang']): $LANG_OBJ->FetchDefaultLangData("vCode");
        $sql = '';
        if($id > 0){
            $sql .= " AND iGiftCardImageId = {
                $id
            }
            ";
        }
        $sql = "SELECT * FROM $this->GiftCardImageTable WHERE vCode = '".$vLangCode."' AND eStatus = 'Active' $sql ORDER BY iDisplayOrder ASC";
        $data = $obj->MySQLSelect($sql);
        $i = 0;
        $imageArr = [];
        foreach($data as $d){
            $imageArr[$i]['vImage'] = $tconfig["tsite_upload_images_gift_card"] . '/' . $d['vImage'];
            $imageArr[$i]['iGiftCardImageId'] = $d['iGiftCardImageId'];
            $i++;
        }
        return $imageArr;
    }
    public function SendGiftCard(){
        global $obj, $tconfig, $COMM_MEDIA_OBJ, $LANG_OBJ;
        $MemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $UserType = isset($_REQUEST["GeneralUserType"])? $_REQUEST["GeneralUserType"] : '';
        $fAmount = isset($_REQUEST["fAmount"])? $_REQUEST["fAmount"] : '';
        $tReceiverName = isset($_REQUEST["tReceiverName"])? $_REQUEST["tReceiverName"] : '';
        $tReceiverEmail = isset($_REQUEST["tReceiverEmail"])? $_REQUEST["tReceiverEmail"] : '';
        $tReceiverMessage = isset($_REQUEST["tReceiverMessage"])? $_REQUEST["tReceiverMessage"] : '';
        $vPhone = isset($_REQUEST["vReceiverPhone"])? $_REQUEST["vReceiverPhone"] : '';
        $vPhoneCode = isset($_REQUEST["vReceiverPhoneCode"])? $_REQUEST["vReceiverPhoneCode"] : '';
        $iGiftCardImageId = isset($_REQUEST["iGiftCardImageId"])? $_REQUEST["iGiftCardImageId"] : '';
        $vTimeZone = isset($_REQUEST['vTimeZone'])? $_REQUEST['vTimeZone'] : "";
        $payStatus = isset($_REQUEST['payStatus'])? $_REQUEST['payStatus'] : '';
        $iPaymentId = isset($_REQUEST['payment_id'])? $_REQUEST['payment_id'] : '';
        $SYSTEM_TYPE = isset($_REQUEST['SYSTEM_TYPE'])? $_REQUEST['SYSTEM_TYPE'] : 'APP';
        $GeneralDeviceType = isset($_REQUEST['GeneralDeviceType'])? $_REQUEST['GeneralDeviceType'] : '';
        $vGeneralLang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : '';
        $vGiftCardCode = $this->GenerateGiftCardCode();
        if($UserType == 'Passenger'){
            $MemberData = $this->getUserData($MemberId);
            $UserTypeForDB = 'User';
        }
        else {
            $MemberData = $this->getUserData($MemberId, 'Driver');
            $UserTypeForDB = 'Driver';
        }
        $vLangCode = $MemberData['lang'];
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $MemberData['vCurrency'] . "'");
        $returnArr = $GenerateGiftCard = $ReceiverDetails = [];
        $id = '';
        $ReceiverDetails['tReceiverName'] = $tReceiverName;
        $ReceiverDetails['tReceiverEmail'] = $tReceiverEmail;
        $ReceiverDetails['tReceiverMessage'] = $tReceiverMessage;
        $ReceiverDetails['vReceiverPhone'] = $vPhone;
        $ReceiverDetails['vReceiverPhoneCode'] = $vPhoneCode;
        $ReceiverDetails = json_encode($ReceiverDetails);
        if($payStatus == "succeeded"){
            $fAmount_org = $fAmount;
            $fAmount = $fAmount / $currency[0]['ratio'];
            $GenerateGiftCard['vGiftCardCode'] = $vGiftCardCode;
            $GenerateGiftCard['fAmount'] = $fAmount;
            $GenerateGiftCard['eStatus'] = 'Active';
            $GenerateGiftCard['dAddedDate'] = date('Y-m-d H:i:s');
            $GenerateGiftCard['iCreatedById'] = $MemberId;
            $GenerateGiftCard['eCreatedBy'] = $UserTypeForDB;
            $GenerateGiftCard['tReceiverDetails'] = $ReceiverDetails;
            $GenerateGiftCard['iGiftCardImageId'] = $iGiftCardImageId;
            if($iPaymentId > 0){
                $GenerateGiftCard['iPaymentId'] = $iPaymentId;
                $GenerateGiftCard['ePaymentOption'] = 'Card';
            }
            $GenerateGiftCard['ePaymentOption'] = 'Wallet';
            $id = $obj->MySQLQueryPerform($this->GiftCardTable, $GenerateGiftCard, 'insert');
            $transaction_id = 0;
            if($iPaymentId > 0){
                $where_payments = " iPaymentId = '".$iPaymentId."'";
                $data_payments['iGiftCardId'] = $id;
                $data_payments['eEvent'] = "giftCard";
                $obj->MySQLQueryPerform("payments",$data_payments,'update',$where_payments);
                $payment_data = $obj->MySQLSelect("SELECT tPaymentUserID FROM payments WHERE iPaymentId = $iPaymentId");
                $transaction_id = $payment_data[0]['tPaymentUserID'];
            }
            if(!empty($tReceiverEmail)){
                $maildata['vEmail'] = $tReceiverEmail;
                $data = $COMM_MEDIA_OBJ->giftCardeMailSent($_REQUEST, $vGiftCardCode,$maildata, "GIFT_CARD_RECEIVED");
            }
            $dataArraySMSNew['RECEIVER_NAME'] = $tReceiverName;
            $dataArraySMSNew['GIFT_CARD_CODE'] = $vGiftCardCode;
            $dataArraySMSNew['SENDER_NAME'] = $MemberData['userName'];
            $dataArraySMSNew['AMOUNT'] = formateNumAsPerCurrency($fAmount_org, $MemberData['vCurrency']);
            $message = $COMM_MEDIA_OBJ->GetSMSTemplate('GIFT_CARD_RECEIVED', $dataArraySMSNew, "", $vLangCode);
            $result = $COMM_MEDIA_OBJ->SendSystemSMS($vPhone, $vPhoneCode, $message);
            if(!empty($MemberData['vEmail'])){
                $_REQUEST['EMAIL_TYPE'] = "GiftCardGenerate";
                $maildata = [];
                $maildata['vEmail'] = $MemberData['vEmail'];
                $data = $COMM_MEDIA_OBJ->giftCardeMailSent($_REQUEST, $vGiftCardCode, $maildata, "GIFT_CARD_INFO_SEND");
            }
            $dataArraySMSNew = [];
            $dataArraySMSNew['SENDER_NAME'] = $MemberData['userName'];
            $dataArraySMSNew['AMOUNT'] = formateNumAsPerCurrency($fAmount_org, $MemberData['vCurrency']);
            $dataArraySMSNew['RECEIVER_NAME'] = $tReceiverName;
            $dataArraySMSNew['GIFT_CARD_CODE'] = $vGiftCardCode;
            $message = $COMM_MEDIA_OBJ->GetSMSTemplate('GIFT_CARD_INFO_SEND', $dataArraySMSNew, "", $vLangCode);
            $result = $COMM_MEDIA_OBJ->SendSystemSMS($MemberData['vPhone'], $MemberData['vPhoneCode'], $message);
            $returnUrl = $tconfig['tsite_url'] . "assets/libraries/webview/success.php?message=LBL_PAYMENT_SUCCESS_TXT&SYSTEM_TYPE=" . $SYSTEM_TYPE . "&TIME=" . time(). "&PAGE_TYPE=GIFT_CARD_PAYMENT&iTransactionId=" . $transaction_id . "&giftCode=" . $vGiftCardCode . "&vLang=" . $vLangCode;
            $returnArr['isRedirect'] = "Yes";
            $returnArr['RESPONSE_URL'] = $returnUrl;
            setDataResponse($returnArr);
        }
        else {
            $current_url_arr['type'] = $_REQUEST['type'];
            $current_url_arr['iMemberId'] = $MemberId;
            $current_url_arr['tReceiverEmail'] = $tReceiverEmail;
            $current_url_arr['vReceiverPhone'] = $vPhone;
            $current_url_arr['iGiftCardImageId'] = $iGiftCardImageId;
            $current_url_arr['fAmount'] = $fAmount;
            $current_url_arr['vReceiverPhoneCode'] = $vPhoneCode;
            $current_url_arr['tReceiverName'] = $tReceiverName;
            $current_url_arr['tReceiverMessage'] = $tReceiverMessage;
            $current_url_arr['GeneralMemberId'] = $MemberId;
            $current_url_arr['GeneralUserType'] = $UserType;
            $current_url_arr['vTimeZone'] = $vTimeZone;
            $current_url_arr['SYSTEM_TYPE'] = $SYSTEM_TYPE;
            $current_url_arr['GeneralDeviceType'] = $GeneralDeviceType;
            $current_url_arr['vGeneralLang'] = $vGeneralLang;
            $current_url_arr = http_build_query($current_url_arr);
            $GiftCardAmount = $fAmount;
            $system_default_GiftCardAmount = $fAmount / $currency[0]['ratio'];
            $tDescription = "Payment for gift card.";
            $current_url =(isset($_SERVER['HTTPS'])? 'https' : 'http'). '://' . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'] . '&TIME=' . time();
            $extraParams = "&ePaymentType=GiftCardPayment&GeneralDeviceType=" . $GeneralDeviceType . "&tSessionId=" . $MemberData['tSessionId'] . "&GeneralMemberId=" . $MemberId . "&GeneralUserType=" . $UserType . "&iServiceId=&AMOUNT=" . $GiftCardAmount . "&SYSTEM_DEFAULT_AMOUNT=" . $system_default_GiftCardAmount . "&PAGE_TYPE=GIFT_CARD_PAYMENT&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes&description=" . urlencode($tDescription). "&IsReturnUrlEncode=1&returnUrl=" . base64_encode($current_url_arr);
            $returnArr['GIFT_CARD_PAYMENT_URL'] = $tconfig['tsite_url'] . 'assets/libraries/webview/payment_mode_select.php?' . $extraParams;
            $returnArr['Action'] = "1";
        }
        setDataResponse($returnArr);
    }
    public function GenerateGiftCardCode(){
        global $obj;
        $random = RandomString(10, 'Yes');
        $db_str = $obj->MySQLSelect("SELECT vGiftCardCode FROM $this->GiftCardTable WHERE vGiftCardCode ='" . $random . "'");
        if(!empty($db_str)&& scount($db_str)> 0){
            $code = GenerateGiftCardCode();
        }
        else {
            $code = $random;
        }
        return $code;
    }
    public function getUserData($UserId, $userType = 'Passenger'){
        global $obj;
        if($userType == 'Passenger' || $userType == 'User'){
            $row = $obj->MySQLSelect("SELECT vEmail,vPhoneCode,vPhone,tSessionId, vCurrencyPassenger as vCurrency, vName, vLastName, CONCAT(vName , ' ' , vLastName)as userName , vLang as lang FROM `register_user` WHERE iUserId = '$UserId'");
        }
        else {
            $row = $obj->MySQLSelect("SELECT vEmail,vCode as vPhoneCode , vPhone,tSessionId, vCurrencyDriver as vCurrency, vName, vLastName,CONCAT(vName , ' ' , vLastName)as userName ,vLang as lang FROM `register_driver` WHERE iDriverId = '$UserId'");
        }
        return $row[0];
    }
    public function duplicateCode($code,$iGiftCardId = ''){
        global $obj;
        $ssql = '';
        if(!empty($iGiftCardId)){
            $ssql = " AND iGiftCardId != '".$iGiftCardId."'";
        }
        $db_str = $obj->MySQLSelect("SELECT vGiftCardCode FROM $this->GiftCardTable WHERE vGiftCardCode ='" . $code . "' $ssql");
        if(!empty($db_str)&& scount($db_str)> 0){
            $code = 0;
        }
        else {
            $code = 1;
        }
        return $code;
    }
    public function getDriverData($DriverId){
        global $obj;
        $row = $obj->MySQLSelect("SELECT tSessionId, vCurrencyDriver, vName, vLastName,vLang FROM `register_driver` WHERE iDriverId = '$DriverId'");
        $arr = [];
        $arr['vCurrency'] = $row[0]['vCurrencyDriver'];
        $arr['lang'] = $row[0]['vLang'];
        return $arr;
    }
    public function RedeemGiftCard(){
        global $obj, $WALLET_OBJ, $COMM_MEDIA_OBJ;
        $MemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $UserType = isset($_REQUEST["UserType"])? $_REQUEST["UserType"] : '';
        $vGiftCardCode = isset($_REQUEST["vGiftCardCode"])? $_REQUEST["vGiftCardCode"] : '';
        if($UserType == 'Passenger'){
            $UserTypeForDB = 'Passenger';
            $eUserType_DB = 'UserSpecific';
            $wallet_user_type = 'Rider';
        }
        else {
            $wallet_user_type = $UserTypeForDB = 'Driver';
            $eUserType_DB = 'DriverSpecific';
        }
        $GiftCardData = $obj->MySQLSelect("SELECT eRedeemed,iCreatedById, eCreatedBy,fAmount,eCreatedBy,iGiftCardId, eUserType FROM $this->GiftCardTable WHERE vGiftCardCode = '" . $vGiftCardCode . "' AND eStatus = 'Active' ");
        if(!empty($GiftCardData)&& scount($GiftCardData)> 0 && $GiftCardData[0]['eRedeemed'] == 'No'){
            $dRedeemedDate = date('Y-m-d H:i:s');
            $updateArr['eRedeemed'] = 'Yes';
            $updateArr['dRedeemedDate'] = $dRedeemedDate;
            $updateArr['eReceiverId'] = $MemberId;
            $updateArr['eReceiverUserType'] = $UserTypeForDB;
            if($GiftCardData[0]['eCreatedBy'] == 'Admin' && $GiftCardData[0]['eUserType'] != 'Anyone'){
                $WHERE = " vGiftCardCode = '" . $vGiftCardCode . "' AND iMemberId = '" . $MemberId . "' AND eUserType = '" . $eUserType_DB . "' ";
                $validGiftCard = $obj->MySQLSelect("SELECT eCreatedBy,iGiftCardId FROM $this->GiftCardTable WHERE eRedeemed = 'No' AND $WHERE");
                if(!empty($validGiftCard)&& scount($validGiftCard)> 0){
                }
                else {
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_GIFT_CARD_CODE_INVALID";
                    setDataResponse($returnArr);
                }
            }
            else {
                $WHERE = " vGiftCardCode = '" . $vGiftCardCode . "'";
            }
            $obj->MySQLQueryPerform($this->GiftCardTable, $updateArr, 'update', $WHERE);
            $data_user_wallet['iUserId'] = $MemberId;
            $data_user_wallet['eUserType'] = $wallet_user_type;
            $data_user_wallet['iBalance'] = $GiftCardData[0]['fAmount'];
            $data_user_wallet['eType'] = "Credit";
            $data_user_wallet['dDate'] = @date("Y-m-d H:i:s");
            $data_user_wallet['iTripId'] = '';
            $data_user_wallet['eFor'] = "Gift card";
            $data_user_wallet['ePaymentStatus'] = "Settelled";
            $data_user_wallet['tDescription'] = "#LBL_GIFT_CARD_CREDITED#" . 'Code : ' . strtoupper($vGiftCardCode);
            $data_user_wallet['iOrderId'] = '';
            $WALLET_OBJ->PerformWalletTransaction($data_user_wallet['iUserId'], $data_user_wallet['eUserType'], $data_user_wallet['iBalance'], $data_user_wallet['eType'], $data_user_wallet['iTripId'], $data_user_wallet['eFor'], $data_user_wallet['tDescription'], $data_user_wallet['ePaymentStatus'], $data_user_wallet['dDate'], $data_user_wallet['iOrderId']);
            $MemberData = $this->getUserData($GiftCardData[0]['iCreatedById'], $GiftCardData[0]['eCreatedBy']);
            if(!empty($MemberData['vEmail'])){
                $_REQUEST['EMAIL_TYPE'] = "GiftCardRedeemMailToSender";
                $_REQUEST['iGiftCardId'] = $GiftCardData[0]['iGiftCardId'];
                $maildata = [];
                $maildata['vEmail'] = $MemberData['vEmail'];
                $data = $COMM_MEDIA_OBJ->giftCardeMailSent($_REQUEST, $vGiftCardCode, $maildata, 'GIFT_CARD_REDEEM_SUCCESSFULLY_SENT_TO_SENDER');
            }
            $MemberData = $this->getUserData($MemberId, $UserType);
            if(!empty($MemberData['vEmail'])){
                $_REQUEST['EMAIL_TYPE'] = "GiftCardRedeemMailToReceiver";
                $_REQUEST['iGiftCardId'] = $GiftCardData[0]['iGiftCardId'];
                $maildata = [];
                $maildata['vEmail'] = $MemberData['vEmail'];
                $data = $COMM_MEDIA_OBJ->giftCardeMailSent($_REQUEST, $vGiftCardCode, $maildata, 'GIFT_CARD_REDEEM_SUCCESSFULLY_SENT_TO_SENDER');
            }
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_GIFT_CARD_CODE_REDEEM_SUCCESS_MSG";
            $returnArr['message_title'] = "LBL_GIFT_CARD_CODE_REDEEM_SUCCESS_TITLE";
        }
        else if(!empty($GiftCardData)&& scount($GiftCardData)> 0 && $GiftCardData[0]['eRedeemed'] == 'Yes'){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_GIFT_CARD_CODE_ALREADY_USED";
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_GIFT_CARD_CODE_INVALID";
        }
        setDataResponse($returnArr);
    }
    public function getGiftCardById($iGiftCardId){
        global $obj;
        $GiftCardData = $obj->MySQLSelect("SELECT vGiftCardCode , eReceiverUserType , eReceiverId, iCreatedById, eCreatedBy,fAmount,eCreatedBy,iGiftCardId, eUserType FROM $this->GiftCardTable WHERE iGiftCardId = '" . $iGiftCardId . "' ");
        return $GiftCardData;
    }
    public function PreviewGiftCard(){
        global $tconfig;
        $ReceiverName = isset($_REQUEST["ReceiverName"])? $_REQUEST["ReceiverName"] : '';
        $Amount = isset($_REQUEST["Amount"])? $_REQUEST["Amount"] : '';
        $GiftCardImageId = isset($_REQUEST["GiftCardImageId"])? $_REQUEST["GiftCardImageId"] : '';
        $GeneralMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $GeneralUserType = isset($_REQUEST["GeneralUserType"])? $_REQUEST["GeneralUserType"] : '';
        $SenderMsg = isset($_REQUEST["SenderMsg"])? $_REQUEST["SenderMsg"] : '';
        $returnArr['Action'] = "1";
        $returnArr['GIFT_CARD_PREVIEW_URL'] = $tconfig['tsite_url'] . 'preview_gift_card.php?ReceiverName=' . $ReceiverName . '&Amount=' . $Amount . '&GiftCardImageId=' . $GiftCardImageId . '&GeneralMemberId=' . $GeneralMemberId . '&GeneralUserType=' . $GeneralUserType . '&SenderMsg=' . $SenderMsg;
        setDataResponse($returnArr);
    }
    public function GetGiftCardDetails(){
        global $obj, $tconfig, $GIFT_CARD_MAX_AMOUNT, $Data_ALL_currency_Arr;
        $GeneralMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $GeneralUserType = isset($_REQUEST["GeneralUserType"])? $_REQUEST["GeneralUserType"] : '';
        $vCurrency = isset($_REQUEST["vCurrency"])? $_REQUEST["vCurrency"] : '';
        $vGeneralLang = isset($_REQUEST["vGeneralLang"])? $_REQUEST["vGeneralLang"] : '';
        if($GeneralUserType == "Driver"){
            $tbl_name = "register_driver";
            $currencyField = "vCurrencyDriver";
            $memberField = "iDriverId";
        }
        else {
            $tbl_name = "register_user";
            $currencyField = "vCurrencyPassenger";
            $memberField = "iUserId";
        }
        if(!empty($GeneralMemberId)){
            $memberData = $obj->MySQLSelect("SELECT $currencyField as vCurrency FROM $tbl_name WHERE $memberField = '$GeneralMemberId' ");
            $vCurrency = $memberData[0]['vCurrency'];
            $CurrencyRatio = get_value('currency', 'Ratio', 'vName', $vCurrency, '', 'true');
        }
        $returnData['GIFT_CARD_IMAGES'] = $this->getGiftCardImages();
        $returnData['GIFT_CARD_MAX_AMOUNT'] = round($GIFT_CARD_MAX_AMOUNT*$CurrencyRatio);
        $returnData['GIFT_CARD_MAX_AMOUNT_WITH_SYMBOL'] = formateNumAsPerCurrency(($GIFT_CARD_MAX_AMOUNT*$CurrencyRatio), $vCurrency);
        $returnData['PREVIEW_GIFT_CARD_URL'] = $tconfig['tsite_url'] . 'preview_gift_card.php?';
        $returnData['TERMS_&_CONDITIONS_GIFT_CARD_URL'] = $tconfig['tsite_url'] . 'terms_conditions_gift_card.php';
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "loadStaticInfo"){
            if(!empty($Data_ALL_currency_Arr)&& scount($Data_ALL_currency_Arr)> 0){
                $currency_master = $Data_ALL_currency_Arr;
            }
            else {
                $currency_master = $obj->MySQLSelect("SELECT vName FROM currency ORDER BY iDispOrder ASC");
            }
            $returnData['GIFT_CARD_MAX_AMOUNT_WITH_SYMBOL'] = $returnData['GIFT_CARD_MAX_AMOUNT'] = array();
            foreach($currency_master as $currency){
                $fRatioPassenger = $currency['Ratio'];
                $returnData['GIFT_CARD_MAX_AMOUNT_WITH_SYMBOL'][$currency['vName']] = formateNumAsPerCurrency(($GIFT_CARD_MAX_AMOUNT*$fRatioPassenger), $currency['vName']);
                $returnData['GIFT_CARD_MAX_AMOUNT'][$currency['vName']] = round($GIFT_CARD_MAX_AMOUNT*$fRatioPassenger);
            }
        }
        return $returnData;
    }
}
class MainInterCity {
    function __construct(){
    }
    public function findNearestKilometer($array, $target){
        $nearestGreater = null;
        $nearestLower = null;
        foreach($array as $element){
            if($element['fKiloMeter'] > $target){
                if($nearestGreater === null || $element['fKiloMeter'] < $nearestGreater){
                    $nearestGreater = $element['fKiloMeter'];
                    $nearestPackage = $element['iRentalPackageId'];
                }
            }
            elseif($element['fKiloMeter'] < $target){
                if($nearestLower === null || $element['fKiloMeter'] > $nearestLower){
                    $nearestLower = $element['fKiloMeter'];
                    $nearestPackage = $element['iRentalPackageId'];
                }
            }
        }
        return $nearestPackage;
    }
    public function getRentalPackageUsingDistance($interCityData, $RentalPackagesData){
        global $tconfig, $languageAssociateArr, $userDetailsArr, $obj,$LANG_OBJ;
        $iUserId = $interCityData['GeneralMemberId'];
        $iVehicleTypeId = $interCityData['iVehicleTypeId'];
        $UserType = $interCityData['UserType'];
        $userData = $userDetailsArr['register_user_' . $iUserId] ?? null;
        if(!$userData){
            $userData = $obj->MySQLSelect("SELECT *, iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
            $userDetailsArr['register_user_' . $iUserId] = $userData;
        }
        $vLangCode = $userData[0]['vLang'] ?? $LANG_OBJ->FetchDefaultLangData("vCode");
        $vGMapLangCode = $languageAssociateArr[$vLangCode]['vGMapLangCode'] ?? get_value('language_master', 'vGMapLangCode', 'vCode', $vLangCode, '', 'true');
        $requestlatlongDataArr = [ 'SOURCE_LATITUDE' => $interCityData['tStartLatitude'], 'SOURCE_LONGITUDE' => $interCityData['tStartLongitude'], 'DEST_LATITUDE' => $interCityData['tDestLatitude'], 'DEST_LONGITUDE' => $interCityData['tDestLongitude'], 'LANGUAGE_CODE' => $vGMapLangCode, ];
        $direction_data = getPathInfoBetweenLocations($requestlatlongDataArr);
        $distance = $direction_data['distance'] / 1000;
        $distance_google_directions = getRentalKilometer_ByCountry($iUserId, $UserType, $iVehicleTypeId, $distance, true);
        $getdistance = $distance_google_directions['AllowedDistance'];
        $getdistance = $getdistance*2;
        $nearestPackage = $this->findNearestKilometer($RentalPackagesData, $getdistance);
        foreach($RentalPackagesData as $k => $package){
            if($nearestPackage == $package['iRentalPackageId']){
                $RentalPackagesData[$k]['isSelected'] = 'Yes';
            }
        }
        $RentalPackagesData = $this->sortRentalpackageData($RentalPackagesData);
        return $RentalPackagesData;
    }
    public function sortRentalpackageData($RentalPackagesData){
        usort($RentalPackagesData, function($a, $b){
            if(isset($a['isSelected'])&& isset($b['isSelected'])){
                if($a['isSelected'] == $b['isSelected']){
                    return 0;
                }
                return($a['isSelected'] < $b['isSelected'])? 1 : -1;
            }
            elseif(isset($a['isSelected'])){
                return -1;
            }
            elseif(isset($b['isSelected'])){
                return 1;
            }
            else {
                return 0;
            }
        });
        return $RentalPackagesData;
    }
    public function AddStatus($iTripId,$destinationArr=array()){
        global $tconfig, $obj;
        if(isset($tripDetailsArr['trips_' . $iTripId])){
            $TripData = $tripDetailsArr['trips_' . $iTripId];
        }
        else {
            $TripData = $obj->MySQLSelect("SELECT * FROM trips WHERE iTripId='" . $iTripId . "'");
            $tripDetailsArr['trips_' . $iTripId] = $TripData;
        }
        if(!empty($destinationArr)){
            $tEndLat = $destinationArr['destination_lat'];
            $tEndLong = $destinationArr['destination_lon'];
            $tDaddress = $destinationArr['dAddress'];
            if(empty($tDaddress)){
                $tDaddress = getLocationNameLatLog($tEndLat, $tEndLong);
            }
        }
        $TripStatusLogData = $obj->MySQLSelect("SELECT * FROM trips_status_logs WHERE iTripId = '".$iTripId."' ORDER BY eTripStatus DESC LIMIT 1");
        $Data_Status_log = array();
        if(empty($TripStatusLogData)){
            $Data_Status_log['eTripStatus']= 'Reached';
            $Data_Status_log['iTripId']= $iTripId;
            $Data_Status_log['dDateTime']= @date("Y-m-d H:i:s");
            $Data_Status_log['tEndLat']= $tEndLat;
            $Data_Status_log['tEndLong']= $tEndLong;
            $Data_Status_log['tDaddress']= $tDaddress;
            $eTripStatus = 'Reached';
            $this->sendnotificationforInterCity($iTripId,$eTripStatus);
        }
        else if(scount($TripStatusLogData)== "1" && $TripStatusLogData[0]['eTripStatus'] == 'Reached'){
            $Data_Status_log['eTripStatus']= 'StartToReturn';
            $Data_Status_log['iTripId']= $iTripId;
            $Data_Status_log['dDateTime']= @date("Y-m-d H:i:s");
            $Data_Status_log['tEndLat']= $tEndLat;
            $Data_Status_log['tEndLong']= $tEndLong;
            $Data_Status_log['tDaddress']= $tDaddress;
            $eTripStatus = 'StartToReturn';
            $this->sendnotificationforInterCity($iTripId,$eTripStatus);
        }
        $iTripLogId = $obj->MySQLQueryPerform("trips_status_logs", $Data_Status_log, "insert");
        return $iTripLogId;
    }
    function sendnotificationforInterCity($iTripId,$eTripStatus){
        global $obj, $userDetailsArr, $vSystemDefaultLangCode, $languageLabelDataArr, $EVENT_MSG_OBJ, $LANG_OBJ, $MODULES_OBJ, $tripDetailsArr;
        $returnArr = array();
        $tripId = $iTripId;
        if(isset($tripDetailsArr['trips_' . $tripId])){
            $UberXTripData = $tripDetailsArr['trips_' . $tripId];
        }
        else {
            $UberXTripData = $obj->MySQLSelect("SELECT *,fRatio_" . $vCurrencyDriver . " as fRatioDriver FROM trips WHERE iTripId='" . $tripId . "'");
            $tripDetailsArr['trips_' . $tripId] = $UberXTripData;
        }
        $driverId = $UberXTripData[0]['iDriverId'];
        $iUserId = $UberXTripData[0]['iUserId'];
        if(isset($userDetailsArr['register_driver_' . $driverId])){
            $result22 = $userDetailsArr['register_driver_' . $driverId];
        }
        else {
            $result22 = $obj->MySQLSelect("SELECT *,idriverId as iMemberId FROM register_driver idriverId='" . $driverId . "'");
            $userDetailsArr['register_driver_' . $driverId] = $result22;
        }
        $tableName = "register_user";
        $iMemberId_VALUE = $iUserId;
        $iMemberId_KEY = "iUserId";
        if(isset($userDetailsArr[$tableName . "_" . $iMemberId_VALUE])){
            $AppData = $userDetailsArr[$tableName . "_" . $iMemberId_VALUE];
        }
        else {
            $AppData = get_value($tableName, '*,' . $iMemberId_KEY . ' as iMemberId', $iMemberId_KEY, $iMemberId_VALUE);
            $userDetailsArr[$tableName . "_" . $iMemberId_VALUE] = $AppData;
        }
        $eType = $UberXTripData[0]['eType'];
        if(scount($AppData)> 0){
            $vLangCode = $AppData[0]['vLang'];
            $tSessionId = $AppData[0]['tSessionId'];
        }
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", $iServiceId);
        if($eTripStatus == 'Reached'){
            $alertMsg = $languageLabelsArr['LBL_INTERCITY_MARKASREACHED_NOTE'];
            $message = "Reached";
        }
        else if($eTripStatus == 'StartToReturn'){
            $alertMsg = $languageLabelsArr['LBL_INTERCITY_STARTTORETURN_NOTE'];
            $message = "StartToReturn";
        }
        $message_arr = array();
        $message_arr['ShowTripFare'] = "false";
        $message_arr['Message'] = $message;
        $message_arr['iTripId'] = $tripId;
        $message_arr['iDriverId'] = $driverId;
        $message_arr['driverName'] = $result22[0]['vName'] . " " . $result22[0]['vLastName'];
        $message_arr['tSessionId'] = $tSessionId;
        $message_arr['vRideNo'] = $UberXTripData[0]['vRideNo'];
        $message_arr['iTripDeliveryLocationId'] = 0;
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['Is_Last_Delivery'] = "Yes";
        $message_arr['eType'] = $eType;
        $message_arr['CustomNotification'] = $MODULES_OBJ->isEnableCustomNotification()? "Yes" : "No";
        $message_arr['CustomViewBtn'] = "Yes";
        $message_arr['CustomTrackDetails'] = "No";
        $message_arr['LBL_VIEW_DETAILS'] = $languageLabelsArr['LBL_VIEW_DETAILS'];
        $message_arr['LBL_TRACK_ORDER'] = $languageLabelsArr['LBL_TRACK_ORDER'];
        $customNotiArray = GetCustomNotificationDetails($tripId, $message_arr['vTitle'], $vLangCode);
        $message_arr['CustomTitle'] = $customNotiArray[0]['vCurrentStatus'];
        $message_arr['CustomSubTitle'] = $customNotiArray[0]['vCurrentStatus_Track'];
        $message_arr['CustomMessage'] = $customNotiArray;
        $message = json_encode($message_arr, JSON_UNESCAPED_UNICODE);
        $DataTripMessages['tMessage'] = $message;
        $DataTripMessages['iDriverId'] = $driverId;
        $DataTripMessages['iTripId'] = $tripId;
        $DataTripMessages['iUserId'] = $iUserId;
        $DataTripMessages['eFromUserType'] = "Driver";
        $DataTripMessages['eToUserType'] = "Passenger";
        $DataTripMessages['eReceived'] = "No";
        $DataTripMessages['dAddedDate'] = @date("Y-m-d H:i:s");
        $obj->MySQLQueryPerform("trip_status_messages", $DataTripMessages, 'insert');
        $iAppVersion = $AppData[0]['iAppVersion'];
        $eDeviceType = $AppData[0]['eDeviceType'];
        $eLogout = $AppData[0]['eLogout'];
        $tLocationUpdateDate = $AppData[0]['tLocationUpdateDate'];
        $iGcmRegId = $AppData[0]['iGcmRegId'];
        $tSessionId = $AppData[0]['tSessionId'];
        $eAppTerminate = $AppData[0]['eAppTerminate'];
        $eDebugMode = $AppData[0]['eDebugMode'];
        $eHmsDevice = $AppData[0]['eHmsDevice'];
        $cmpMinutes = ceil((fetchtripstatustimeMAXinterval()+ $intervalmins)/ 60);
        $compare_date = @date('Y-m-d H:i:s', strtotime('-' . $cmpMinutes . ' minutes'));
        $alertSendAllowed = true;
        $tLocUpdateDate = date("Y-m-d H:i:s", strtotime($tLocationUpdateDate));
        if($tLocUpdateDate < $compare_date){
            $alertSendAllowed = true;
        }
        $channelName = "PASSENGER_" . $iUserId;
        $message_arr['tSessionId'] = $tSessionId;
        $message_arr['eSystem'] = "";
        $generalDataArr[] = array('eDeviceType' => $eDeviceType, 'deviceToken' => $iGcmRegId, 'alertMsg' => $alertMsg, 'eAppTerminate' => $eAppTerminate, 'eDebugMode' => $eDebugMode, 'eHmsDevice' => $eHmsDevice, 'message' => $message_arr, 'channelName' => $channelName, 'tripStatusMsgArr' => array('tMessage' => $message_arr, 'iDriverId' => $driverId, 'iTripId' => $tripId, 'iUserId' => $iUserId, 'eFromUserType' => "Driver", 'eToUserType' => "Passenger", 'eReceived' => "No"));
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
        return;
    }
}
class MenuItemMedia {
    function __construct(){
        if(isset($_POST['delete_img'])&& $_POST['delete_img']){
            $this->delete_images();
        }
    }
    public function delete_images(){
        global $obj, $tconfig;
        if(isset($_POST['delete_img'])&& !empty($_POST['delete_img'])){
            $delete_img = explode(',', $_POST['delete_img']);
            if(isset($delete_img[0])&& empty($delete_img[0])){
                unset($delete_img[0]);
            }
            foreach($delete_img as $id){
                $sql = "SELECT * FROM `menu_item_media` WHERE iMediaId = '$id'";
                $data = $obj->MySQLSelect($sql);
                $oldImage = $data[0]['vImage'];
                $img_path = $tconfig["tsite_upload_images_menu_item_path"];
                $temp_gallery = $img_path . '/';
                $oldFilePath = $temp_gallery . $oldImage;
                if($oldImage != '' && file_exists($oldFilePath)){
                    unlink($img_path . '/' . $oldImage);
                }
                $sql = "DELETE FROM `menu_item_media` WHERE iMediaId = " . $id . " ";
                $obj->sql_query($sql);
            }
        }
    }
    public function multiImageHTMl($label = '', $id =''){
        global $tconfig;
        $getImageVideo = $this->getImageVideo($id);
        $html = "";
        $html .= ' <div class="row"> <div class="col-md-12 col-sm-12"> <label>' . $label . '</label> </div>';
        $class = "hidden";
        if(scount($getImageVideo)> 0){
            $class = "show";
        }
        $html .= '<div class="col-md-12 col-sm-12"> <div class="manage-banner-section ' . $class . '"> <div id ="gallery" class="banner-img-block">';
        foreach($getImageVideo as $IV){
            $imgUrl = $tconfig["tsite_upload_images_menu_item"] . '/' . $IV['vImage'];
            $fileextarr = explode(".", $IV['vImage']);
            $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
            if($IV['vImage'] != ''){
                if(in_array($ext, ['mp4', 'mov', 'wmv', 'avi', 'flv', 'mkv', 'webm'])){
                    $imgUrl = $this->videoConvertTomp4($IV['vImage']);
                    $html .= '<div id = "' . $IV['iMediaId'] . '" class="banner-img setImageRatio shine setImageRatio1JS " ><video class="resize_video" controls> <source src="' . $imgUrl . '" > </video> <div attr-id = "' . $IV['iMediaId'] . '" class= "removebtn item-video">Delete</div></div>';
                }
                else {
                    $html .= '<div id = "' . $IV['iMediaId'] . '" class="banner-img setImageRatio shine setImageRatio1JS " ><img class = "resize_image resizeImageWithJs" attr-image-src="'. $imgUrl. '" /><div attr-name = "' . $IV['vImage'] . '" attr-id = "' . $IV['iMediaId'] . '" class= "removebtn ">Delete</div></div>';
                }
            }
        }
        $html .= '</div></div></div> <div class="col-md-12 col-sm-12"> <div class="imageupload"> <div class="file-tab"> <span id="multi_img001"> </span> <div> <input multiple id = "previewmultiImg" name="vMultiImage[]" type="file" class="form-control"> <input value = "" id = "delete_img" name="delete_img" type="hidden" class="form-control"> <b> '.constVal("IMAGE_RATIO_INSTRUCTION_NOTES").'</b> </div> </div> </div> </div> </div> ';
        return $html;
    }
    public function getImageVideo($id){
        global $obj;
        $sql = "SELECT * FROM `menu_item_media` WHERE iMenuItemId='$id' ";
        return $obj->MySQLSelect($sql);
    }
    function videoConvertTomp4($video_file){
        global $tconfig;
        $tmpArr = explode(".", $video_file);
        $thumb_img = $tmpArr[0] . '.mp4';
        $img_url = "";
        $img_path = $tconfig["tsite_upload_images_menu_item_path"] . '/' . $thumb_img;
        $vFile = $tconfig["tsite_upload_images_menu_item_path"] . '/' . $video_file;
        $mainVideoUrl = $tconfig["tsite_upload_images_menu_item"] . '/' . $video_file;
        if($tmpArr[1] != "mp4" && file_exists($vFile)){
            if(!file_exists($img_path)){
                $ffmpeg = FFMpeg\FFMpeg::create();
                $video = $ffmpeg->open($vFile);
                $format = new FFMpeg\Format\Video\X264();
                $format->setAudioCodec("libmp3lame");
                $video->save($format, $img_path);
            }
        }
        $img = $tconfig["tsite_upload_images_menu_item"] . '/' . $thumb_img;
        if(file_exists($img_path)){
            $img_url = $img;
        }
        elseif(file_exists($vFile)){
            $img_url = $mainVideoUrl;
        }
        return $img_url;
    }
    public function uploadImageVideo($file, $tsite_upload_images_menu_item_path){
        global $UPLOAD_OBJ,$tconfig;
        $img1 = [];
        if(isset($_FILES['vMultiImage'])&& !empty($_FILES['vMultiImage'])){
            $img_path = $tsite_upload_images_menu_item_path;
            $temp_gallery = $img_path . '/';
            for($i = 0;
            $i < scount($_FILES['vMultiImage']['name']);
            $i++){
                $image_object = $_FILES['vMultiImage']['tmp_name'][$i];
                $image_name = $_FILES['vMultiImage']['name'][$i];
                $Photo_Gallery_folder = $img_path . '/';
                $fileextarr = explode(".", $_FILES['vMultiImage']['name'][$i]);
                $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
                $tsite_upload_video_file_extensions = explode(",", $tconfig["tsite_upload_video_file_extensions"]);
                $tsite_upload_image_file_extensions = explode(",", $tconfig["tsite_upload_image_file_extensions"]);
                if(in_array($ext, $tsite_upload_video_file_extensions)){
                    $image_name = mt_rand(11111, 99999).'.'.$ext;
                    $target_file = $Photo_Gallery_folder . basename($image_name);
                    if(move_uploaded_file($image_object, $target_file)){
                    }
                    else {
                    }
                    $img1[] = $image_name;
                    $this->getVideoThumbImage($image_name);
                }
                else if(in_array($ext, $tsite_upload_image_file_extensions)){
                    $img_name = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder, $image_object, $image_name, '', $tconfig["tsite_upload_image_file_extensions"]);
                    $img1[] = $img_name[0];
                }
            }
        }
        return $img1;
    }
    public function delete_image(){
        if(isset($_REQUEST['deleteId'])&& !empty($_REQUEST['deleteId'])){
            global $obj, $tconfig;
            $oldImage = $_REQUEST['name'];
            $img_path = $tconfig["tsite_upload_images_menu_item_path"];
            $temp_gallery = $img_path . '/';
            $oldFilePath = $temp_gallery . $oldImage;
            if($oldImage != '' && file_exists($oldFilePath)){
                unlink($img_path . '/' . $oldImage);
            }
            $sql = "DELETE FROM `menu_item_media` WHERE iMediaId = " . $_REQUEST['deleteId'] . " ";
            echo $obj->MySQLSelect($sql);
        }
    }
    public function findTheExt($fileName){
        $fileextarr = explode(".", $fileName);
        $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
        return $ext;
    }
    public function getItemMedia($id){
        global $tconfig;
        $itemimimgUrl = $tconfig["tsite_upload_images_menu_item"];
        $item_media = $this->getImageVideo($id);
        $dbItemData['MenuItemMedia'] = array();
        if(!empty($item_media)){
            $mCount = 0;
            foreach($item_media as $media){
                $tmp = explode(".", $media['vImage']);
                for($i = 0;
                $i < scount($tmp)- 1;
                $i++){
                    $tmp1[] = $tmp[$i];
                }
                $file = implode("_", $tmp1);
                $ext = $tmp[scount($tmp)- 1];
                $videoExt_arr = array('MP4', 'MOV', 'WMV', 'AVI', 'FLV', 'MKV', 'WEBM');
                $dbItemData['MenuItemMedia'][$mCount]['vImage'] = $itemimimgUrl . '/' . $media['vImage'];
                $dbItemData['MenuItemMedia'][$mCount]['eFileType'] = 'Image';
                $dbItemData['MenuItemMedia'][$mCount]['ThumbImage'] = '';
                if(in_array(strtoupper($ext), $videoExt_arr)){
                    $dbItemData['MenuItemMedia'][$mCount]['eFileType'] = 'Video';
                    $dbItemData['MenuItemMedia'][$mCount]['ThumbImage'] = $this->getVideoThumbImage($media['vImage']);
                }
                $mCount++;
            }
        }
        return $dbItemData;
    }
    public function getVideoThumbImage($video_file){
        global $tconfig;
        $tmpArr = explode(".", $video_file);
        $thumb_img = $tmpArr[0] . '.png';
        $img_path = $tconfig["tsite_upload_images_menu_item_path"] . '/thumnails/' . $thumb_img;
        $img_url = $tconfig["tsite_upload_images_menu_item"] . '/thumnails/' . $thumb_img;
        if(!is_dir($tconfig["tsite_upload_images_menu_item_path"] . '/thumnails/')){
            mkdir($tconfig["tsite_upload_images_menu_item_path"] . '/thumnails/', 0777);
            chmod($tconfig["tsite_upload_images_menu_item_path"] . '/thumnails/', 0777);
        }
        if(file_exists($img_path)){
            return $img_url;
        }
        else {
            $sec = 3;
            $vFile = $tconfig["tsite_upload_images_menu_item_path"] . '/' . $video_file;
            if(file_exists($vFile)){
                $thumb_video = $tmpArr[0] . '.mp4';
                if($tmpArr[1] == 'mkv'){
                    if(!file_exists($tconfig["tsite_upload_images_menu_item_path"] . '/' . $thumb_video)){
                        $ffmpeg = FFMpeg\FFMpeg::create();
                        $video = $ffmpeg->open($vFile);
                        $format = new FFMpeg\Format\Video\X264();
                        $format->setAudioCodec("libmp3lame");
                        $vFile = $tconfig["tsite_upload_images_menu_item_path"] . '/' . $thumb_video;
                        $video->save($format, $vFile);
                    }
                    else {
                        $vFile = $tconfig["tsite_upload_images_menu_item_path"] . '/' . $thumb_video;
                    }
                }
                $ffprobe = FFMpeg\FFProbe::create();
                $vDuration = $ffprobe->streams($vFile)->videos()->first()->get('duration');
                if($vDuration < 3){
                    $sec = floor($vDuration);
                }
                $ffmpeg = FFMpeg\FFMpeg::create();
                $video = $ffmpeg->open($vFile);
                $frame = $video->frame(FFMpeg\Coordinate\TimeCode::fromSeconds($sec));
                $frame->save($img_path);
                return $img_url;
            }
            else {
                return "";
            }
        }
    }
}
class NearBy {
    public $near_by_category,$near_by_Places,$vCurrentTime,$languageLabelsArr,$system_default_timezone;
    function __construct(){
        $this->near_by_category = "nearby_category";
        $this->near_by_Places = "nearby_places";
        $this->vCurrentTime = @date("Y-m-d H:i:s");
        $this->languageLabelsArr = [];
        $this->system_default_timezone = date_default_timezone_get();
    }
    public function getNearByCategoryTotalCount($use, $ssql = ''){
        global $obj;
        $estatus = '';
        if($use == 'admin'){
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        $result = $obj->MySQLSelect("SELECT count(iNearByCategoryId)as count FROM $this->near_by_category WHERE 1 = 1 $estatus $ssql");
        return $result[0]['count'];
    }
    public function getNearByPlacesTotalCount($use, $ssql = ''){
        global $obj;
        $estatus = '';
        if($use == 'admin'){
            if(empty($ssql)){
                $estatus = 'AND(np.estatus = "Active" || np.estatus = "Inactive")';
            }
        }
        $sql = "SELECT count(iNearByPlacesId)as count FROM $this->near_by_Places as np JOIN $this->near_by_category as nc ON(nc.iNearByCategoryId = np.iNearByCategoryId)WHERE 1 = 1 AND nc.eStatus != 'Deleted' $estatus $ssql ";
        $result = $obj->MySQLSelect($sql);
        return $result[0]['count'];
    }
    public function getUser($iUserId){
        global $obj;
        $user = $obj->MySQLSelect("SELECT vPhoneCode,vCountry FROM `register_user` WHERE iUserId = '" . $iUserId . "'");
        return $user[0];
    }
    public function getUserNearByPlaces($use){
        global $LIST_PLACES_LIMIT_BY_DISTANCE, $obj, $tconfig, $LANG_OBJ, $DRIVER_ARRIVED_MIN_TIME_PER_MINUTE, $MODULES_OBJ,$_REQUEST;
        $GeneralMemberId = isset($_REQUEST['GeneralMemberId'])? clean($_REQUEST['GeneralMemberId']): '';
        $vLongitude = isset($_REQUEST['vLongitude'])? clean($_REQUEST['vLongitude']): '';
        $vLatitude = isset($_REQUEST['vLatitude'])? clean($_REQUEST['vLatitude']): '';
        $iCategoryId = isset($_REQUEST['iCategoryId'])? clean($_REQUEST['iCategoryId']): '';
        $lang = isset($_REQUEST['vGeneralLang'])? clean($_REQUEST['vGeneralLang']): '';
        $searchWord = isset($_REQUEST['searchWord'])? $_REQUEST['searchWord'] : "";
        $iNearByPlacesId = isset($_REQUEST['iNearByPlacesId'])? $_REQUEST['iNearByPlacesId'] : "";
        $page = isset($_REQUEST['page'])? trim($_REQUEST['page']): 1;
        $userData = $this->getUser($GeneralMemberId);
        $sql = "SELECT eUnit FROM `country` WHERE vCountryCode = '" . $userData['vCountry'] . "'";
        $CountryData = $obj->MySQLSelect($sql);
        $eUnit = $CountryData[0]['eUnit'];
        if($lang == "" || $lang == NULL){
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        if($iNearByPlacesId != ''){
            $place_display = 1;
        }
        $this->languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $sourceLat = $vLatitude;
        $sourceLon = $vLongitude;
        $vLatitude = 'vPlacesLocationLat';
        $vLongitude = 'vPlacesLocationLong';
        $sql_1 = '';
        if($iNearByPlacesId != ''){
            $sql_1 .= " AND iNearByPlacesId = '" . $iNearByPlacesId . "'";
        }
        $sql = "SELECT ROUND((6371 * acos(cos(radians(" . $sourceLat . "))* cos(radians(ROUND(" . $vLatitude . ",8)))* cos(radians(ROUND(" . $vLongitude . ",8))- radians(" . $sourceLon . "))+ sin(radians(" . $sourceLat . "))* sin(radians(ROUND(" . $vLatitude . ",8))))),2)AS distance,iNearByPlacesId FROM `nearby_places` WHERE(" . $vLatitude . " != '' AND " . $vLongitude . " != '' AND eStatus='active')AND iNearByCategoryId = " . $iCategoryId . " $sql_1 HAVING distance < " . $LIST_PLACES_LIMIT_BY_DISTANCE . "";
        $data = $obj->MySQLSelect($sql);
        $iNearByPlacesId = implode(',', array_column($data, 'iNearByPlacesId'));
        $PlacesData = $this->getNearByPlace($use, $iNearByPlacesId, $lang, $searchWord);
        if($place_display != 1){
            $Category = $this->getNearByCategory('webservice', '', '', '', $lang, '', ['iCategoryId', 'vTitle','vListLogo']);
            $key = array_search($iCategoryId, array_column($Category, 'iCategoryId'));
            if($key >= 0){
                $selectedCategory = $Category[$key];
                unset($Category[$key]);
                array_unshift($Category, $selectedCategory);
            }
            $returnArr['BANNER_DATA'] = $this->getBanner($lang);
            $returnArr['CATEGORY'] = $Category;
            $returnArr['SELECTED_CATEGORY_ID'] = $iCategoryId;
        }
        if(isset($PlacesData)&& !empty($PlacesData)){
            $i = 0;
            foreach($PlacesData as $Places){
                $keys = array_search($Places['iNearByPlacesId'], array_column($data, 'iNearByPlacesId'));
                if($eUnit == "Miles"){
                    $distance = number_format(round($data[$keys]['distance'] * KM_TO_MILES_RATIO, 2)). " " . $this->languageLabelsArr['LBL_MILE_DISTANCE_TXT'];
                }
                else {
                    $distance = number_format($data[$keys]['distance']). " " . $this->languageLabelsArr['LBL_KM_DISTANCE_TXT'];
                }
                $PlacesData[$i]['duration'] = $distance;
                $PlacesData[$i]['vPhoneWithCode'] = "+" . $Places['vPhoneWithCode'];
                $PlacesData[$i]['distance'] = $data[$keys]['distance'];
                if(!empty($Places['vImage'])&& file_exists($tconfig['tsite_upload_images_nearby_item_path'] . $Places['vImage'])){
                    $PlacesData[$i]['vImages'][0] = $tconfig['tsite_upload_images_nearby_item'] . $Places['vImage'];
                }
                else {
                    $PlacesData[$i]['vImages'] = array();
                }
                $WorkingHoursDetails = $this->GetPlacesWorkingHoursDetails($Places['vWorkingHours']);
                $PlacesData[$i]['placesStatus'] = $WorkingHoursDetails['placesStatus'];
                $PlacesData[$i]['statusMessage'] = $WorkingHoursDetails['statusMessage'];
                if($place_display == 1){
                    $PlacesData[$i]['duration'] = $this->languageLabelsArr['LBL_APPROX_DISTANCE_TXT'] ." ". str_replace('#HOURS#', $distance, $this->languageLabelsArr['LBL_AWAY_NEARBY']);
                    foreach($WorkingHoursDetails as $key => $Places_){
                        $PlacesData[$i][$key] = $Places_;
                    }
                    $PlacesData[$i]['placesStatus'] = $WorkingHoursDetails['placesStatus'];
                    $PlacesData[$i]['statusMessage'] = $WorkingHoursDetails['statusMessage'];
                    $PlacesData[$i]['openCloseTimeMessage'] = $WorkingHoursDetails['openCloseTimeMessage'];
                    $PlacesData[$i]['ServiceAction'] = $this->serviceAction($lang, $Places);
                }
                if($Places['iCompanyId'] > 0 && $MODULES_OBJ->isDeliverAllFeatureAvailable()){
                    $getCompanyDetails = $this->getCompanyDetails($Places['iCompanyId'], $place_display);
                    if($place_display == 1){
                        foreach($getCompanyDetails as $key => $Places_){
                            if(isset($PlacesData[$i][$key])){
                                $PlacesData[$i][$key] = $Places_;
                            }
                        }
                    }
                    else {
                        $PlacesData[$i]['placesStatus'] = $getCompanyDetails['placesStatus'];
                        $PlacesData[$i]['statusMessage'] = $getCompanyDetails['statusMessage'];
                    }
                }
                if($Places['storeActive'] == 'Inactive'){
                    $PlacesData[$i]['openCloseTimeMessage'] = '';
                }
                unset($PlacesData[$i]['vWorkingHours'], $PlacesData[$i]['vImage']);
                $i++;
            }
            $total = scount($PlacesData);
            $per_page = 7;
            $totalPages = ceil($total / $per_page);
            $start_limit =($page - 1)* $per_page;
            $PlacesData = array_slice($PlacesData, $start_limit, $per_page);
            $returnArr['Action'] = "1";
            $returnArr['Places'] = $PlacesData;
            $returnArr['totalPages'] = $totalPages;
            if($totalPages > $page){
                $returnArr['NextPage'] =($page + 1);
            }
            else {
                $returnArr['NextPage'] = "0";
            }
            $returnArr['message'] = "";
            setDataResponse($returnArr);
        }
        else {
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_NO_DATA_AVAIL";
            $returnArr['Places'] = [];
            setDataResponse($returnArr);
        }
    }
    public function getNearByPlace($use, $iNearByPlacesId, $vLanguage = "EN", $searchWord = ''){
        global $obj;
        $HAVING = $sql = '';
        $iNearByPlacesId_ = explode(',', $iNearByPlacesId);
        if(scount($iNearByPlacesId_)> 1){
            $sql .= " np.iNearByPlacesId IN(" . $iNearByPlacesId . ")";
        }
        else {
            $sql .= " np.iNearByPlacesId = '" . $iNearByPlacesId . "'";
        }
        if($searchWord != ""){
            $sql .= " AND(np.vTitle like '%$searchWord%')";
        }
        if($use == "webservice"){
        }
        $sql = "SELECT CASE WHEN c.iCompanyId > 0 THEN c.eStatus ELSE 'Active' END as storeActive, np.iServiceId,JSON_UNQUOTE(JSON_VALUE(nc.vTitle, '$.vTitle_" . $vLanguage . "'))as vCategoryName , np.iNearByPlacesId, np.iNearByCategoryId, np.vPlacesLocation, np.vPlacesLocationLat, np.vPlacesLocationLong, np.vAddress, np.vWorkingHours, np.vPhone,CONCAT(np.vCode,np.vPhone)as vPhoneWithCode, np.iCompanyId, np.vOfferDiscount, JSON_UNQUOTE(JSON_VALUE(np.vAboutPlaces, '$.vAboutPlaces_" . $vLanguage . "'))as vAboutPlaces, np.vAboutPlaces as vAboutPlacesOrg, np.eStatus, np.vImage, np.vTitle ,np.vCode FROM $this->near_by_Places as np JOIN $this->near_by_category as nc ON(nc.iNearByCategoryId = np.iNearByCategoryId)LEFT JOIN company as c ON(c.iCompanyId = np.iCompanyId)WHERE 1 = 1 AND $sql $HAVING";
        $nearbyPlaces = $obj->MySQLSelect($sql);
        $return_array = $nearbyPlaces;
        if(scount($iNearByPlacesId_)> 1 || $use == 'webservice'){
            return $return_array;
        }
        else {
            return $return_array[0];
        }
    }
    public function getNearByCategory($use, $ssql = '', $start = 0, $per_page = 0, $vLanguage = "EN", $ord = '', $reqArr = []){
        global $obj;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        if(empty($ord)){
            $ord = " ORDER BY iDisplayOrder";
        }
        if($use == 'webservice'){
            $estatus = 'AND estatus = "Active"';
        }
        $sql = "SELECT iNearByCategoryId, iNearByCategoryId as near_by_cat ,(SELECT count(np.iNearByCategoryId)FROM nearby_places np WHERE np.iNearByCategoryId = near_by_cat AND eStatus != 'Deleted')as totalPlaces , vImage, eStatus, iDisplayOrder, vTitle as vTitle_json, JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle, vTextColor, vBgColor FROM $this->near_by_category WHERE 1 = 1 $estatus $ssql $ord " . $limit . "";
        $nearby_master_categories = $obj->MySQLSelect($sql);
        if($use == 'webservice'){
            foreach($nearby_master_categories as $key => $mServiceCategory){
                $return_array[$key] = $this->getNearByQuery_array($mServiceCategory, $reqArr);
            }
        }
        else {
            $return_array = $nearby_master_categories;
        }
        return $return_array;
    }
    public function getNearByQuery_array($mServiceCategory, $reqArr){
        global $tconfig, $APP_TYPE;
        $return_array = [];
        $return_array['iCategoryId'] = $mServiceCategory['iNearByCategoryId'];
        $return_array['vTitle'] = $mServiceCategory['vTitle'];
        $return_array['vCategory'] = $mServiceCategory['vTitle'];
        $return_array['vTextColor'] = $mServiceCategory['vTextColor'];
        $return_array['vBgColor'] = getColorFromImage($tconfig["tsite_upload_images_nearby_item_path"] . $mServiceCategory['vImage']);
        $return_array['vImage'] = $tconfig["tsite_upload_images_nearby_item"] . $mServiceCategory['vImage'];
        $return_array['eCatType'] = 'NearBy';
        $return_array['vListLogo'] = $tconfig["tsite_upload_images_nearby_item"] . $mServiceCategory['vImage'];
        $return_array['isRoundImage'] = 'Yes';
        $return_array['iDisplayOrder'] = $mServiceCategory['iDisplayOrder'];
        if(scount($reqArr)> 0){
            foreach($return_array as $key => $a){
                if(in_array($key, $reqArr)){
                    $returnarray[$key] = $a;
                }
            }
            $return_array = $returnarray;
        }
        return $return_array;
    }
    public function getBanner($vLanguage){
        global $obj, $tconfig;
        $whereloc = " AND iLocationid IN('-1')";
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $vLanguage . "' AND vImage != '' AND eStatus = 'Active' AND(iServiceId = '0' OR iServiceId = '')AND eBuyAnyService NOT IN('Genie', 'Runner')AND eType = 'NearBy' AND eFor = 'General' $whereloc ORDER BY iDisplayOrder ASC");
        $dataOfBanners = array();
        $count = 0;
        for($i = 0;
        $i < scount($Data_banners);
        $i++){
            if(isset($Data_banners[$i]['vImage'])&& $Data_banners[$i]['vImage'] != ""){
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $dataOfBanners[$count]['vStatusBarColor'] = $Data_banners[$i]['vStatusBarColor'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                if(file_exists($banner_img_path)&& empty($Data_banners[$i]['vStatusBarColor'])){
                    $dataOfBanners[$count]['vStatusBarColor'] = getColorFromImage($banner_img_path);
                    $obj->sql_query("UPDATE banners SET vStatusBarColor = '" . $dataOfBanners[$count]['vStatusBarColor'] . "' WHERE iUniqueId = '" . $Data_banners[$i]['iUniqueId'] . "'");
                }
                $count++;
            }
        }
        return $dataOfBanners;
    }
    public function ConvertMinutestoHumanReadable($minutes){
        $days = floor($minutes / 1440);
        $hours = floor(($minutes - $days * 1440)/ 60);
        $minutes = $minutes -($days * 1440)-($hours * 60);
        $returnText = '';
        if($days >= 1){
            if($days == 1){
                $day_text = $this->languageLabelsArr['LBL_DAY_TXT'];
            }
            else {
                $day_text = $this->languageLabelsArr['LBL_DAYS_TXT'];
            }
            $returnText .= $days . ' ' . $day_text;
        }
        if($hours >= 1){
            if($hours == 1){
                $hour_text = $this->languageLabelsArr['LBL_HOUR_TXT'];
            }
            else {
                $hour_text = $this->languageLabelsArr['LBL_HOURS_TXT'];
            }
            $returnText .= ' ' . $hours . ' ' . $hour_text;
        }
        if($minutes >= 0){
            $returnText .= ' ' . round($minutes). ' ' . $this->languageLabelsArr['LBL_MINUTES_TXT'];
        }
        return trim($returnText);
    }
    private function GetPlacesWorkingHoursDetails($vWorkingHours){
        global $ENABLE_24_HOUR_FORMAT,$MODULES_OBJ;
        $vWorkingHoursNew = json_decode($vWorkingHours, true);
        if($MODULES_OBJ->isEnableTimeslotFeature()){
            $vWorkingHours = $vWorkingHoursNew['TimeSlotsNew'];
        }
        else {
            $vWorkingHours = $vWorkingHoursNew['TimeSlotsOld'];
        }
        $DayWiseKey = $this->getDayWiseKey();
        $fromTime = str_replace(['PM', 'AM'], ['', ''], $vWorkingHours[$DayWiseKey['vFromTimeSlot1']]);
        $toTime = str_replace(['PM', 'AM'], ['', ''], $vWorkingHours[$DayWiseKey['vToTimeSlot1']]);
        $fromTime = date("H:i", strtotime($this->timezone($fromTime)));
        $toTime = date("H:i", strtotime($this->timezone($toTime)));
        $DayWiseKey2 = $this->getDayWiseKey2();
        $fromTime2_org = $vWorkingHours[$DayWiseKey2['vFromTimeSlot2']];
        $toTime2_org = $vWorkingHours[$DayWiseKey2['vToTimeSlot2']];
        $fromTime2 = str_replace(['PM', 'AM'], ['', ''], $vWorkingHours[$DayWiseKey2['vFromTimeSlot2']]);
        $toTime2 = str_replace(['PM', 'AM'], ['', ''], $vWorkingHours[$DayWiseKey2['vToTimeSlot2']]);
        $fromTime2 = date("H:i", strtotime($this->timezone($fromTime2)));
        $toTime2 = date("H:i", strtotime($this->timezone($toTime2)));
        $date = @date("H:i", strtotime($this->timezone($this->vCurrentTime)));
        $status = "Closed";
        $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_CLOSED_STATUS_TXT'];
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $open_close_time = str_replace('#TIME#', date("H:i", strtotime($fromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
        }
        else {
            $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($fromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
        }
        if(isBetween($fromTime, $toTime, $date)== 1){
            $status = "Open";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_OPEN_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($toTime)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($toTime)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
        }
        else if(isBetween($fromTime2, $toTime2, $date)== 1 && $fromTime2_org != ""){
            $status = "Open";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_OPEN_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($toTime2)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($toTime2)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
        }
        else if(!empty($fromTime2_org)&& $fromTime2_org != "" && !empty($toTime2_org)){
            $solt2DayWiseKey = $this->getDayWiseKey2();
            $NextfromTime = str_replace(['PM', 'AM'], ['', ''], $vWorkingHours[$solt2DayWiseKey['vFromTimeSlot2']]);
            $NextfromTime = date("H:i", strtotime($this->timezone($NextfromTime)));
            $status = "Closed";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_CLOSED_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
            }
        }
        if($MODULES_OBJ->isEnableTimeslotFeature()){
            $days = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            foreach($days as $day){
                $DayWiseKey = $this->getDayWiseKey($day);
                if(empty($vWorkingHours[$DayWiseKey['vFromTimeSlot1']])&& empty($vWorkingHours[$DayWiseKey['vToTimeSlot1']])){
                    $fromTime = "";
                    $toTime = "";
                }
                else {
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime = date("H:i", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("H:i", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey['vToTimeSlot1']]))));
                    }
                    else {
                        $fromTime = date("h:i A", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("h:i A", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey['vToTimeSlot1']]))));
                    }
                }
                $DayWiseKey2 = $this->getDayWiseKey2($day);
                if(!isset($vWorkingHours[$DayWiseKey2['vFromTimeSlot2']])|| empty($vWorkingHours[$DayWiseKey2['vFromTimeSlot2']])){
                    $vWorkingHours[$DayWiseKey2['vFromTimeSlot2']] = "00:00";
                    $vWorkingHours[$DayWiseKey2['vToTimeSlot2']] = "00:00";
                    $from2to2 = '';
                }
                else {
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime2 = date("H:i", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("H:i", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey2['vToTimeSlot2']]))));
                    }
                    else {
                        $fromTime2 = date("h:i A", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("h:i A", strtotime($this->timezone(str_replace(['PM', 'AM', ''], ['', '', ''], $vWorkingHours[$DayWiseKey2['vToTimeSlot2']]))));
                    }
                    $from2to2 = $fromTime2 . '-' . $toTime2;
                }
                if(!empty($fromTime)&& !empty($toTime)){
                    if(!empty($from2to2)){
                        $returnArr[$DayWiseKey['vToTimeSlot1']] = $fromTime . '-' . $toTime . "\n" . $from2to2;
                    }
                    else {
                        $returnArr[$DayWiseKey['vToTimeSlot1']] = $fromTime . '-' . $toTime;
                    }
                }
                else if(empty($fromTime)&& empty($toTime)&& !empty($from2to2)){
                    $returnArr[$DayWiseKey['vToTimeSlot1']] = $from2to2;
                }
                else {
                    $returnArr[$DayWiseKey['vToTimeSlot1']] = 'Closed';
                }
            }
        }
        else {
            $returnArr = $this->getNearByTimeSlotSimple($vWorkingHours);
        }
        $returnArr['placesStatus'] = $status;
        $returnArr['statusMessage'] = $message;
        $returnArr['openCloseTimeMessage'] = $open_close_time;
        return $returnArr;
    }
    public function getDayWiseKey($day = ""){
        global $MODULES_OBJ;
        $vCurrentTime = @date("Y-m-d H:i:s");
        $dayDefault = $day;
        if($day == ''){
            $day = date('l', strtotime($this->vCurrentTime));
        }
        if(!$MODULES_OBJ->isEnableTimeslotFeature()&& $dayDefault == ""){
            if($day == "Saturday" || $day == "Sunday"){
                $day = "SaturdayANDSunday";
            }
            else {
                $day = "MondayToFriday";
            }
        }
        switch($day){
            case $day == "Monday": $vFromTimeSlot1 = "vMonFromSlot1";
            $vToTimeSlot1 = "vMonToSlot1";
            break;
            case $day == "Tuesday": $vFromTimeSlot1 = "vTueFromSlot1";
            $vToTimeSlot1 = "vTueToSlot1";
            break;
            case $day == "Wednesday": $vFromTimeSlot1 = "vWedFromSlot1";
            $vToTimeSlot1 = "vWedToSlot1";
            break;
            case $day == "Thursday": $vFromTimeSlot1 = "vThuFromSlot1";
            $vToTimeSlot1 = "vThuToSlot1";
            break;
            case $day == "Friday": $vFromTimeSlot1 = "vFriFromSlot1";
            $vToTimeSlot1 = "vFriToSlot1";
            break;
            case $day == "Saturday": $vFromTimeSlot1 = "vSatFromSlot1";
            $vToTimeSlot1 = "vSatToSlot1";
            break;
            case $day == "Sunday": $vFromTimeSlot1 = "vSunFromSlot1";
            $vToTimeSlot1 = "vSunToSlot1";
            break;
            case $day == "SaturdayANDSunday": $vFromTimeSlot1 = "vFromSatSunTimeSlot1";
            $vToTimeSlot1 = "vToSatSunTimeSlot1";
            break;
            case $day == "MondayToFriday": $vFromTimeSlot1 = "vFromMonFriTimeSlot1";
            $vToTimeSlot1 = "vToMonFriTimeSlot1";
            break;
            default: echo "break in generalFunction()@ 54XX";
            exit;
            break;
        }
        $arr['vFromTimeSlot1'] = $vFromTimeSlot1;
        $arr['vToTimeSlot1'] = $vToTimeSlot1;
        return $arr;
    }
    private function timezone($time){
        $vTimeZone = isset($_REQUEST['vTimeZone'])? clean($_REQUEST['vTimeZone']): '';
        return $time;
    }
    public function getDayWiseKey2($day = ""){
        global $MODULES_OBJ;
        $dayDefault = $day;
        if($day == ''){
            $day = date('l', strtotime($this->vCurrentTime));
        }
        if(!$MODULES_OBJ->isEnableTimeslotFeature()&& $dayDefault == ""){
            if($day == "Saturday" || $day == "Sunday"){
                $day = "SaturdayANDSunday";
            }
            else {
                $day = "MondayToFriday";
            }
        }
        switch($day){
            case $day == "Monday": $vFromTimeSlot1 = "vMonFromSlot2";
            $vToTimeSlot1 = "vMonToSlot2";
            break;
            case $day == "Tuesday": $vFromTimeSlot1 = "vTueFromSlot2";
            $vToTimeSlot1 = "vTueToSlot2";
            break;
            case $day == "Wednesday": $vFromTimeSlot1 = "vWedFromSlot2";
            $vToTimeSlot1 = "vWedToSlot2";
            break;
            case $day == "Thursday": $vFromTimeSlot1 = "vThuFromSlot2";
            $vToTimeSlot1 = "vThuToSlot2";
            break;
            case $day == "Friday": $vFromTimeSlot1 = "vFriFromSlot2";
            $vToTimeSlot1 = "vFriToSlot2";
            break;
            case $day == "Saturday": $vFromTimeSlot1 = "vSatFromSlot2";
            $vToTimeSlot1 = "vSatToSlot2";
            break;
            case $day == "Sunday": $vFromTimeSlot1 = "vSunFromSlot2";
            $vToTimeSlot1 = "vSunToSlot2";
            break;
            case $day == "SaturdayANDSunday": $vFromTimeSlot1 = "vFromSatSunTimeSlot2";
            $vToTimeSlot1 = "vToSatSunTimeSlot2";
            break;
            case $day == "MondayToFriday": $vFromTimeSlot1 = "vFromMonFriTimeSlot2";
            $vToTimeSlot1 = "vToMonFriTimeSlot2";
            break;
            default: echo "break in generalFunction()@ 54XX";
            exit;
            break;
        }
        $arr['vFromTimeSlot2'] = $vFromTimeSlot1;
        $arr['vToTimeSlot2'] = $vToTimeSlot1;
        return $arr;
    }
    public function serviceAction($lang, $PlacesData){
        global $tconfig, $MODULES_OBJ;
        $i = 0;
        $result_arr = [];
        $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_CALL_THIS_PLACE_NEARBY'];
        $result_arr[$i]['eType'] = 'Call';
        $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/customer-service.png';
        $result_arr[$i]['vPhone'] = '+'.$PlacesData['vPhoneWithCode'];
        $i++;
        $isEnableGenieFeature = $MODULES_OBJ->isEnableGenieFeature();
        if($MODULES_OBJ->isRideFeatureAvailable()&&(($PlacesData['iCompanyId'] > 0 && $PlacesData['storeActive'] == 'Active')|| $PlacesData['iCompanyId'] == 0)){
            $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_BOOK_TAXI_NEARBY'];
            $result_arr[$i]['eType'] = 'Taxi';
            $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/taxi.png';
            $result_arr[$i]['vPlacesLocationLat'] = $PlacesData['vPlacesLocationLat'];
            $result_arr[$i]['vPlacesLocationLong'] = $PlacesData['vPlacesLocationLong'];
            $result_arr[$i]['vPlacesLocation'] = $PlacesData['vPlacesLocation'];
            $i++;
        }
        if(!empty($PlacesData['iCompanyId'])&& $MODULES_OBJ->isDeliverAllFeatureAvailable()&& $PlacesData['storeActive'] == 'Active'){
            if($PlacesData['iServiceId'] == 1){
                $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_ORDER_FOOD_NEARBY'];
                $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/fast-food.png';
            }
            else {
                $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_ORDER_ITEMS_NEARBY'];
                $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/grocery.png';
            }
            $result_arr[$i]['eType'] = 'DeliveryAll';
            $result_arr[$i]['CompanyDetails'] = $this->getCompanyDetails($PlacesData['iCompanyId']);
            $i++;
        }
        else if($MODULES_OBJ->isEnableAnywhereDeliveryFeature()&& $isEnableGenieFeature && $PlacesData['iCompanyId'] == 0){
            $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_ORDER_ANYTHING_NEARBY'];
            $result_arr[$i]['eType'] = 'Genie';
            $result_arr[$i]['vPlacesLocationLat'] = $PlacesData['vPlacesLocationLat'];
            $result_arr[$i]['vPlacesLocationLong'] = $PlacesData['vPlacesLocationLong'];
            $result_arr[$i]['vPlacesLocation'] = $PlacesData['vPlacesLocation'];
            $result_arr[$i]['vStoreName'] = $PlacesData['vTitle'];
            $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/grocery.png';
            $i++;
        }
        $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_LOCATION_NEARBY'];
        $result_arr[$i]['eType'] = 'Location';
        $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/map.png';
        $result_arr[$i]['vPlacesLocationLat'] = $PlacesData['vPlacesLocationLat'];
        $result_arr[$i]['vPlacesLocationLong'] = $PlacesData['vPlacesLocationLong'];
        $result_arr[$i]['vPlacesLocation'] = $PlacesData['vPlacesLocation'];
        $i++;
        if($PlacesData['vOfferDiscount'] != ''){
            $result_arr[$i]['vTitle'] = $this->languageLabelsArr['LBL_DISCOUNT_AND_OFFER_NEARBY'];
            $result_arr[$i]['eType'] = 'DiscountOffer';
            $result_arr[$i]['vImage'] = $tconfig["tsite_img"] . '/discount.png';
            $result_arr[$i]['vOfferDiscount'] = $PlacesData['vOfferDiscount'];
        }
        return $result_arr;
    }
    public function getCompanyDetails($iCompanyId, $slot = 1){
        global $obj, $iServiceId,$MODULES_OBJ,$LANG_OBJ,$ENABLE_24_HOUR_FORMAT;
        $iUserId = $this->iUserId;
        $getCompanyDetails = FetchNearByStores('', '', $this->iUserId, '', '', '', $iServiceId, $iCompanyId);
        $ServiceCategoryData = $obj->MySQLSelect("SELECT eType FROM service_categories WHERE iServiceId = $iServiceId");
        $getCompanyDetails[0]['ispriceshow'] = $ServiceCategoryData[0]['eType'];
        $CompanyDetails = $getCompanyDetails[0];
        $returnArr['Restaurant_Safety_URL'] = $CompanyDetails['Restaurant_Safety_URL'];
        $returnArr['Restaurant_Safety_Icon'] = $CompanyDetails['Restaurant_Safety_Icon'];
        $returnArr['Restaurant_Safety_Status'] = $CompanyDetails['Restaurant_Safety_Status'];
        $returnArr['Restaurant_Cuisine'] = $CompanyDetails['Restaurant_Cuisine'];
        $returnArr['vAvgRating'] = $CompanyDetails['vAvgRating'];
        $returnArr['vCaddress'] = $CompanyDetails['vCaddress'];
        $returnArr['vCoverImage'] = $CompanyDetails['vCoverImage'];
        $returnArr['iCompanyId'] = $CompanyDetails['iCompanyId'];
        $returnArr['vCompany'] = $CompanyDetails['vCompany'];
        $returnArr['restaurantstatus'] = $CompanyDetails['restaurantstatus'];
        $returnArr['ispriceshow'] = $CompanyDetails['ispriceshow'];
        $returnArr['eAvailable'] = $CompanyDetails['eAvailable'];
        $returnArr['timeslotavailable'] = $CompanyDetails['timeslotavailable'];
        $returnArr['iServiceId'] = $CompanyDetails['iServiceId'];
        $DayWiseKey = $this->getDayWiseKey();
        $fromTime = date("H:i", strtotime($this->timezone($CompanyDetails[$DayWiseKey['vFromTimeSlot1']])));
        $toTime = date("H:i", strtotime($this->timezone($CompanyDetails[$DayWiseKey['vToTimeSlot1']])));
        $DayWiseKey2 = $this->getDayWiseKey2();
        $vFromTimeSlot2_org = $CompanyDetails[$DayWiseKey2['vFromTimeSlot2']];
        $vToTimeSlot2_org = $CompanyDetails[$DayWiseKey2['vToTimeSlot2']];
        $fromTime2 = date("H:i", strtotime($this->timezone($CompanyDetails[$DayWiseKey2['vFromTimeSlot2']])));
        $toTime2 = date("H:i", strtotime($this->timezone($CompanyDetails[$DayWiseKey2['vToTimeSlot2']])));
        $date = @date("H:i", strtotime($this->timezone($this->vCurrentTime)));
        $NextDayWiseKey = date('l', strtotime('+1 day', strtotime($date)));
        $NextDayWiseKey = $this->getDayWiseKey($NextDayWiseKey);
        $NextfromTime = date("H:i", strtotime($CompanyDetails[$NextDayWiseKey['vFromTimeSlot1']]));
        $status = "Closed";
        $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_CLOSED_STATUS_TXT'];
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $open_close_time = str_replace('#TIME#', date("H:i", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
        }
        else {
            $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
        }
        if(isBetween($fromTime, $toTime, $date)== 1){
            $status = "Open";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_OPEN_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($toTime)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($toTime)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
        }
        else if(isBetween($fromTime2, $toTime2, $date)== 1 && $vFromTimeSlot2_org != "00:00"){
            $status = "Open";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_OPEN_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($toTime2)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($toTime2)), $this->languageLabelsArr['LBL_OPEN_TIME_NEARBY']);
            }
        }
        else if(!empty($fromTime2)&& $vFromTimeSlot2_org != "00:00" && !empty($toTime2)){
            $solt2DayWiseKey = $this->getDayWiseKey2();
            $NextfromTime = date("H:i", strtotime($this->timezone($CompanyDetails[$solt2DayWiseKey['vFromTimeSlot2']])));
            $status = "Closed";
            $message = $this->languageLabelsArr['LBL_NEARBY_PLACE_CLOSED_STATUS_TXT'];
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $open_close_time = str_replace('#TIME#', date("H:i", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
            }
            else {
                $open_close_time = str_replace('#TIME#', date("h:i A", strtotime($NextfromTime)), $this->languageLabelsArr['LBL_CLOSED_TIME_NEARBY']);
            }
        }
        if($MODULES_OBJ->isEnableTimeslotFeature()){
            $days = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            foreach($days as $day){
                $DayWiseKey = $this->getDayWiseKey($day);
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $fromTime = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey['vFromTimeSlot1']]))));
                    $toTime = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey['vToTimeSlot1']]))));
                }
                else {
                    $fromTime = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey['vFromTimeSlot1']]))));
                    $toTime = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey['vToTimeSlot1']]))));
                }
                $DayWiseKey2 = $this->getDayWiseKey2($day);
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $fromTime2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey2['vFromTimeSlot2']]))));
                    $toTime2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey2['vToTimeSlot2']]))));
                }
                else {
                    $fromTime2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey2['vFromTimeSlot2']]))));
                    $toTime2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($CompanyDetails[$DayWiseKey2['vToTimeSlot2']]))));
                }
                $returnArr[$DayWiseKey['vToTimeSlot1']] = $fromTime . '-' . $toTime . "\n" . $fromTime2 . '-' . $toTime2;
            }
        }
        else {
            $vWorkingHours= array();
            $vWorkingHours['vFromMonFriTimeSlot1'] = $CompanyDetails['vFromMonFriTimeSlot1'];
            $vWorkingHours['vToMonFriTimeSlot1'] = $CompanyDetails['vToMonFriTimeSlot1'];
            $vWorkingHours['vFromSatSunTimeSlot1'] = $CompanyDetails['vFromSatSunTimeSlot1'];
            $vWorkingHours['vToSatSunTimeSlot1'] = $CompanyDetails['vToSatSunTimeSlot1'];
            $vWorkingHours['vFromMonFriTimeSlot2'] = $CompanyDetails['vFromMonFriTimeSlot2'];
            $vWorkingHours['vToMonFriTimeSlot2'] = $CompanyDetails['vToMonFriTimeSlot2'];
            $vWorkingHours['vFromSatSunTimeSlot2'] = $CompanyDetails['vFromSatSunTimeSlot2'];
            $vWorkingHours['vToSatSunTimeSlot2'] = $CompanyDetails['vToSatSunTimeSlot2'];
            $returnArr = $this->getNearByTimeSlotSimple($vWorkingHours);
        }
        $returnArr['placesStatus'] = $status;
        $returnArr['statusMessage'] = $message;
        $returnArr['openCloseTimeMessage'] = $open_close_time;
        if($slot == 0){
            $returnArr = [];
            $returnArr['placesStatus'] = $status;
            $returnArr['statusMessage'] = $message;
        }
        return $returnArr;
    }
    public function getNearByPlaces($use, $ssql = '', $start = 0, $per_page = 0, $vLanguage = "EN", $ord = '', $reqArr = []){
        global $obj;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            if(empty($ssql)){
                $estatus = 'AND(np.estatus = "Active" || np.estatus = "Inactive")';
            }
        }
        if(empty($ord)){
            $ord = " ORDER BY iDisplayOrder";
        }
        $sql = "SELECT JSON_UNQUOTE(JSON_VALUE(nc.vTitle, '$.vTitle_" . $vLanguage . "'))as categoryName , nc.iNearByCategoryId, nc.eStatus as categoryStatus, np.iNearByPlacesId, np.iNearByCategoryId, np.vPlacesLocation, np.vPlacesLocationLat, np.vPlacesLocationLong, np.vAddress, np.vWorkingHours, np.vPhone, np.iCompanyId, np.vOfferDiscount, JSON_UNQUOTE(JSON_VALUE(np.vAboutPlaces, '$.vAboutPlaces_" . $vLanguage . "'))as vAboutPlaces, np.eStatus, np.vImage, np.vTitle FROM $this->near_by_Places as np JOIN $this->near_by_category as nc ON(nc.iNearByCategoryId = np.iNearByCategoryId)WHERE 1 = 1 AND nc.eStatus != 'Deleted' $estatus $ssql $ord " . $limit . "";
        $places = $obj->MySQLSelect($sql);
        $return_array = $places;
        return $return_array;
    }
    public function getNearByCat($use, $iNearByCategoryId, $vLanguage = "EN"){
        global $obj;
        $sql = '';
        $iNearByCategoryId_ = explode(',', $iNearByCategoryId);
        if(scount($iNearByCategoryId_)> 1){
            $sql .= " iNearByCategoryId IN(" . $iNearByCategoryId . ")";
        }
        else {
            $sql .= "iNearByCategoryId = '" . $iNearByCategoryId . "'";
        }
        $nearbyCat = $obj->MySQLSelect("SELECT eStatus,iDisplayOrder,iNearByCategoryId,vImage,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,vTitle as vTitle_json, vTextColor, vBgColor FROM $this->near_by_category WHERE 1 = 1 AND $sql");
        $return_array = $nearbyCat;
        if(scount($iNearByCategoryId_)> 1){
            return $return_array;
        }
        else {
            return $return_array[0];
        }
    }
    public function getStore($use, $iNearByPlacesId = ''){
        global $obj;
        $sql = '';
        if(!empty($iNearByPlacesId)){
            $sql = " AND iNearByPlacesId != '" . $iNearByPlacesId . "'";
        }
        $sql = "SELECT GROUP_CONCAT(DISTINCT(iCompanyId))as iCompanyId FROM `nearby_places` WHERE 1 = 1 $sql";
        $db_storelist = $obj->MySQLSelect($sql);
        return $db_storelist[0];
    }
    function getNearByTimeSlotSimple($vWorkingHours){
        $returnArr = [];
        $days = ["MondayToFriday","SaturdayANDSunday"];
        $dayKey = ["monfritimeslot_Time","satsuntimeslot_Time"];
        foreach($days as $key => $dayList){
            $DaysWiseKey = $this->getDayWiseKey($dayList);
            $DaysWiseKey2 = $this->getDayWiseKey2($dayList);
            $fromTime = $this->formatTime($vWorkingHours[$DaysWiseKey['vFromTimeSlot1']]);
            $toTime = $this->formatTime($vWorkingHours[$DaysWiseKey['vToTimeSlot1']]);
            $returnArr[$dayKey[$key]] = "$fromTime-$toTime";
            if($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']] != $vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]){
                $fromTime2 = $this->formatTime($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']]);
                $toTime2 = $this->formatTime($vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]);
                if($fromTime2 != $toTime2){
                    $returnArr[$dayKey[$key]] = "$fromTime-$toTime\n$fromTime2-$toTime2";
                }
                else {
                    $returnArr[$dayKey[$key]] = '';
                }
            }
        }
        $returnArr['monfritimeslot_TXT'] = $this->languageLabelsArr['LBL_NEAR_BY_MON_FRI_TIME_TXT'];
        $returnArr['satsuntimeslot_TXT'] = $this->languageLabelsArr['LBL_NEAR_BY_SAT_SUN_TXT'];
        return $returnArr;
    }
    function formatTime($timeString){
        global $ENABLE_24_HOUR_FORMAT;
        $time = preg_replace("/[A-MP]+/", "", $timeString);
        if($ENABLE_24_HOUR_FORMAT == "No"){
            $date = date("h:i A", strtotime($time));
        }
        else {
            $date = date("H:i", strtotime($time));
        }
        return $date;
    }
    function getNearByTimeSlotSimple_bkp($vWorkingHours){
        global $obj, $tconfig,$LANG_OBJ,$iServiceId,$ENABLE_24_HOUR_FORMAT;
        $daysss = array("MondayToFriday","SaturdayANDSunday");
        foreach($daysss as $dayss){
            $DaysWiseKey = $this->getDayWiseKey($dayss);
            $DaysWiseKey2 = $this->getDayWiseKey2($dayss);
            if($dayss == "MondayToFriday"){
                $days = array('Monday','Tuesday','Wednesday','Thursday','Friday');
                foreach($days as $day){
                    $DayWiseKey = $this->getDayWiseKey($day);
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vToTimeSlot1']]))));
                    }
                    else {
                        $fromTime = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vToTimeSlot1']]))));
                    }
                    $DayWiseKey2 = $this->getDayWiseKey2($day);
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime2 = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]))));
                    }
                    else {
                        $fromTime2 = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]))));
                    }
                    $returnArr[$DayWiseKey['vToTimeSlot1']] = $fromTime.'-'.$toTime."\n".$fromTime2.'-'.$toTime2;
                }
            }
            else {
                $days = array('Saturday','Sunday');
                foreach($days as $day){
                    $DayWiseKey = $this->getDayWiseKey($day);
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vToTimeSlot1']]))));
                    }
                    else {
                        $fromTime = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vFromTimeSlot1']]))));
                        $toTime = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey['vToTimeSlot1']]))));
                    }
                    $DayWiseKey2 = $this->getDayWiseKey2($day);
                    if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                        $fromTime2 = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("H:i",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]))));
                    }
                    else {
                        $fromTime2 = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vFromTimeSlot2']]))));
                        $toTime2 = date("h:i A",strtotime(str_replace(['PM','AM',''],['', '', ''],$this->timezone($vWorkingHours[$DaysWiseKey2['vToTimeSlot2']]))));
                    }
                    $returnArr[$DayWiseKey['vToTimeSlot1']] = $fromTime.'-'.$toTime."\n".$fromTime2.'-'.$toTime2;
                }
            }
        }
        return $returnArr;
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($_REQUEST['vGeneralLang'], "1", $iServiceId);
        $selectedLang = $languageLabelsArr['vCode'];
        $vFromMonFriTimeSlot1 = $vWorkingHours['vFromMonFriTimeSlot1'];
        $vToMonFriTimeSlot1 = $vWorkingHours['vToMonFriTimeSlot1'];
        $vFromMonFriTimeSlot2 = $vWorkingHours['vFromMonFriTimeSlot2'];
        $vToMonFriTimeSlot2 = $vWorkingHours['vToMonFriTimeSlot2'];
        $vFromSatSunTimeSlot1 = $vWorkingHours['vFromSatSunTimeSlot1'];
        $vToSatSunTimeSlot1 = $vWorkingHours['vToSatSunTimeSlot1'];
        $vFromSatSunTimeSlot2 = $vWorkingHours['vFromSatSunTimeSlot2'];
        $vToSatSunTimeSlot2 = $vWorkingHours['vToSatSunTimeSlot2'];
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $vFromMonFriTimeSlot1 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromMonFriTimeSlot1))));
            $vToMonFriTimeSlot1 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToMonFriTimeSlot1))));
            $vFromMonFriTimeSlot2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromMonFriTimeSlot2))));
            $vToMonFriTimeSlot2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToMonFriTimeSlot2))));
            $vFromSatSunTimeSlot1 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromSatSunTimeSlot1))));
            $vToSatSunTimeSlot1 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToSatSunTimeSlot1))));
            $vFromSatSunTimeSlot2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromSatSunTimeSlot2))));
            $vToSatSunTimeSlot2 = date("H:i", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToSatSunTimeSlot2))));
        }
        else {
            $vFromMonFriTimeSlot1 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromMonFriTimeSlot1))));
            $vToMonFriTimeSlot1 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToMonFriTimeSlot1))));
            $vFromMonFriTimeSlot2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromMonFriTimeSlot2))));
            $vToMonFriTimeSlot2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToMonFriTimeSlot2))));
            $vFromSatSunTimeSlot1 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromSatSunTimeSlot1))));
            $vToSatSunTimeSlot1 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToSatSunTimeSlot1))));
            $vFromSatSunTimeSlot2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vFromSatSunTimeSlot2))));
            $vToSatSunTimeSlot2 = date("h:i A", strtotime(str_replace(['PM', 'AM', ''], ['', '', ''], $this->timezone($vToSatSunTimeSlot2))));
        }
        if($vFromMonFriTimeSlot1 == "00:00" && $vToMonFriTimeSlot1 == "00:00" && $vFromMonFriTimeSlot2 == "00:00" && $vToMonFriTimeSlot2 == "00:00"){
            $monfritimeslot_TXT = "";
            $monfritimeslot_Time = "";
        }
        if($vFromMonFriTimeSlot1 != "00:00" && $vToMonFriTimeSlot1 != "00:00" && $vFromMonFriTimeSlot2 != "00:00" && $vToMonFriTimeSlot2 != "00:00"){
            $monfritimeslot_TXT = $languageLabelsArr['LBL_MON_FRI_TIME_TXT'];
            $monfritimeslot_Time = $vFromMonFriTimeSlot1 . "-" . $vToMonFriTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromMonFriTimeSlot2 . "-" . $vToMonFriTimeSlot2;
        }
        if($vFromMonFriTimeSlot1 == "00:00" && $vToMonFriTimeSlot1 != "00:00" && $vFromMonFriTimeSlot2 != "00:00" && $vToMonFriTimeSlot2 != "00:00"){
            $monfritimeslot_TXT = $languageLabelsArr['LBL_MON_FRI_TIME_TXT'];
            $monfritimeslot_Time = $vFromMonFriTimeSlot1 . "-" . $vToMonFriTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromMonFriTimeSlot2 . "-" . $vToMonFriTimeSlot2;
        }
        if($vFromMonFriTimeSlot1 != "00:00" && $vToMonFriTimeSlot1 != "00:00" && $vFromMonFriTimeSlot2 == "00:00" && $vToMonFriTimeSlot2 != "00:00"){
            $monfritimeslot_TXT = $languageLabelsArr['LBL_MON_FRI_TIME_TXT'];
            $monfritimeslot_Time = $vFromMonFriTimeSlot1 . "-" . $vToMonFriTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromMonFriTimeSlot2 . "-" . $vToMonFriTimeSlot2;
        }
        if($vFromMonFriTimeSlot1 != "00:00" && $vToMonFriTimeSlot1 != "00:00" && $vFromMonFriTimeSlot2 == "00:00" && $vToMonFriTimeSlot2 == "00:00"){
            $monfritimeslot_TXT = $languageLabelsArr['LBL_MON_FRI_TIME_TXT'];
            $monfritimeslot_Time = $vFromMonFriTimeSlot1 . "-" . $vToMonFriTimeSlot1;
        }
        if($vFromMonFriTimeSlot1 == "00:00" && $vToMonFriTimeSlot1 == "00:00" && $vFromMonFriTimeSlot2 != "00:00" && $vToMonFriTimeSlot2 != "00:00"){
            $monfritimeslot_TXT = $languageLabelsArr['LBL_MON_FRI_TIME_TXT'];
            $monfritimeslot_Time = $vFromMonFriTimeSlot2 . "-" . $vToMonFriTimeSlot2;
        }
        if($vFromSatSunTimeSlot1 == "00:00" && $vToSatSunTimeSlot1 == "00:00" && $vFromSatSunTimeSlot2 == "00:00" && $vToSatSunTimeSlot2 == "00:00"){
            $satsuntimeslot_TXT = "";
            $satsuntimeslot_Time = "";
        }
        if($vFromSatSunTimeSlot1 != "00:00" && $vToSatSunTimeSlot1 != "00:00" && $vFromSatSunTimeSlot2 != "00:00" && $vToSatSunTimeSlot2 != "00:00"){
            $satsuntimeslot_TXT = $languageLabelsArr['LBL_SAT_SUN_TXT'];
            $satsuntimeslot_Time = $vFromSatSunTimeSlot1 . "-" . $vToSatSunTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromSatSunTimeSlot2 . "-" . $vToSatSunTimeSlot2;
        }
        if($vFromSatSunTimeSlot1 == "00:00" && $vToSatSunTimeSlot1 != "00:00" && $vFromSatSunTimeSlot2 != "00:00" && $vToSatSunTimeSlot2 != "00:00"){
            $satsuntimeslot_TXT = $languageLabelsArr['LBL_SAT_SUN_TXT'];
            $satsuntimeslot_Time = $vFromSatSunTimeSlot1 . "-" . $vToSatSunTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromSatSunTimeSlot2 . "-" . $vToSatSunTimeSlot2;
        }
        if($vFromSatSunTimeSlot1 != "00:00" && $vToSatSunTimeSlot1 != "00:00" && $vFromSatSunTimeSlot2 == "00:00" && $vToSatSunTimeSlot2 != "00:00"){
            $satsuntimeslot_TXT = $languageLabelsArr['LBL_SAT_SUN_TXT'];
            $satsuntimeslot_Time = $vFromSatSunTimeSlot1 . "-" . $vToSatSunTimeSlot1 . " " . $languageLabelsArr['LBL_TIMSLOT_AND_OTHER_TXT'] . " " . $vFromSatSunTimeSlot2 . "-" . $vToSatSunTimeSlot2;
        }
        if($vFromSatSunTimeSlot1 != "00:00" && $vToSatSunTimeSlot1 != "00:00" && $vFromSatSunTimeSlot2 == "00:00" && $vToSatSunTimeSlot2 == "00:00"){
            $satsuntimeslot_TXT = $languageLabelsArr['LBL_SAT_SUN_TXT'];
            $satsuntimeslot_Time = $vFromSatSunTimeSlot1 . "-" . $vToSatSunTimeSlot1;
        }
        if($vFromSatSunTimeSlot1 == "00:00" && $vToSatSunTimeSlot1 == "00:00" && $vFromSatSunTimeSlot2 != "00:00" && $vToSatSunTimeSlot2 != "00:00"){
            $satsuntimeslot_TXT = $languageLabelsArr['LBL_SAT_SUN_TXT'];
            $satsuntimeslot_Time = $vFromSatSunTimeSlot2 . "-" . $vToSatSunTimeSlot2;
        }
        $returnArr['monfritimeslot_TXT'] = $monfritimeslot_TXT;
        $returnArr['monfritimeslot_Time'] = $monfritimeslot_Time;
        $returnArr['satsuntimeslot_TXT'] = $satsuntimeslot_TXT;
        $returnArr['satsuntimeslot_Time'] = $satsuntimeslot_Time;
        return $returnArr;
    }
}
class RentItem {
    public $tablename,$rentitem_post,$rentitem_post_tmp,$PaymentPlanTableName,$rentitem_images,$rent_item_post_status_log,$rent_item_sendquery_log,$rentitem_payment_log,$other_id;
    function __construct(){
        global $obj;
        $this->tablename = 'rent_items_category';
        $this->rentitem_post = 'rentitem_post';
        $this->rentitem_post_tmp = 'rentitem_post_tmp';
        $this->PaymentPlanTableName = 'rent_item_payment_plan';
        $this->rentitem_images = 'rentitem_images';
        $this->rent_item_post_status_log = 'rent_item_post_status_log';
        $this->rent_item_sendquery_log = 'rent_item_sendquery_log';
        $this->rentitem_payment_log = 'rentitem_payment_log';
        $rentitem = $obj->MySQLSelect("SELECT iRentItemId FROM $this->tablename WHERE 1 = 1 ");
        $this->other_id =(!empty($rentitem)&& $rentitem[0]['iRentItemId'])? $rentitem[0]['iRentItemId'] : 0;
    }
    public function getRentItemTotalCount($use, $iParent_Id = 0, $cat_id = "", $ssql = ""){
        global $obj;
        $estatus = '';
        if($use == 'admin'){
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        $iParentId = "iParentId = '" . $iParent_Id . "'";
        if(!empty($cat_id)){
            $iMasterServiceCategoryId = base64_decode(base64_decode($cat_id));
            $iMSql = " AND iMasterServiceCategoryId = '" . $iMasterServiceCategoryId . "'";
        }
        $result = $obj->MySQLSelect("SELECT count(iRentItemId)as count FROM $this->tablename WHERE 1 = 1 AND " . $iParentId . $iMSql . " $estatus $ssql ");
        return $result[0]['count'];
    }
    public function getRentItemMaster($use, $ssql = '', $start = 0, $per_page = 0, $vLanguage = "EN", $ord = '', $reqArr = []){
        global $obj;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        if($use == 'webservice'){
            $estatus = 'AND estatus = "Active"';
        }
        if(empty($ord)){
            $ord = " ORDER BY iDisplayOrder";
        }
        $sql = "SELECT vTitle, iRentItemId, vImage, vImage1, vTitle, tDescription, iParentId, eStatus, iDisplayOrder, JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,iMasterServiceCategoryId FROM $this->tablename WHERE 1 = 1 $estatus $ssql AND iParentId = 0 $ord " . $limit . "";
        $rentitem_master_categories = $obj->MySQLSelect($sql);
        $return_array = array();
        if($use == 'webservice'){
            foreach($rentitem_master_categories as $key => $mServiceCategory){
                $return_array[$key] = $this->getRentItemQuery_array($mServiceCategory, $reqArr);
            }
        }
        else {
            $return_array = $rentitem_master_categories;
        }
        return $return_array;
    }
    public function getRentItemQuery_array($rentitemArray, $reqArr = []){
        global $tconfig, $APP_TYPE, $MODULES_OBJ, $master_service_category_tbl;
        $return_array['vTitle'] = $rentitemArray['vTitle'];
        $return_array['iCategoryId'] = $rentitemArray['iRentItemId'];
        $return_array['vCategory'] = $rentitemArray['vTitle'];
        $return_array['vImage'] = $tconfig["tsite_upload_images_rent_item"] . $rentitemArray['vImage'];
        if(!empty($rentitemArray['vImage1'])){
            $return_array['vImage1'] = $tconfig["tsite_upload_images_rent_item"] . $rentitemArray['vImage1'];
        }
        if(!empty($rentitemArray['iMasterServiceCategoryId'])){
            $eTypeNew = $this->getRentItemMasterData($rentitemArray['iMasterServiceCategoryId'], 'eType');
        }
        if(isset($rentitemArray['iMasterServiceCategoryId'])&& $rentitemArray['iMasterServiceCategoryId'] != '0'){
            $return_array['eCatType'] = $eTypeNew;
        }
        else {
            $return_array['eCatType'] = 'RentItem';
        }
        $return_array['vListLogo'] = $tconfig["tsite_upload_images_rent_item"] . $rentitemArray['vImage'];
        $returnarray = [];
        if(scount($reqArr)> 0){
            foreach($return_array as $key => $a){
                if(in_array($key, $reqArr)){
                    $returnarray[$key] = $a;
                }
            }
            $return_array = $returnarray;
        }
        return $return_array;
    }
    public function getPaymentPlanTotalCount($use, $ssql = ""){
        global $obj;
        $estatus = '';
        if($use == 'admin'){
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        $result = $obj->MySQLSelect("SELECT count(iPaymentPlanId)as count FROM $this->PaymentPlanTableName WHERE 1 = 1 $ssql $estatus");
        return $result[0]['count'];
    }
    function createRentItemPost($use, $RentItemPostData, $iTmpRentItemPostId = "", $vLanguage = "EN", $reqArr = []){
        global $obj;
        if(!empty($iTmpRentItemPostId)){
            $where = " iTmpRentItemPostId = '" . $iTmpRentItemPostId . "'";
            $iTmpRentItemPostIdNew = $obj->MySQLQueryPerform($this->rentitem_post_tmp, $RentItemPostData, 'update', $where);
            $iTmpRentItemPostIdNew = $iTmpRentItemPostId;
        }
        else {
            $iTmpRentItemPostIdNew = $obj->MySQLQueryPerform($this->rentitem_post_tmp, $RentItemPostData, 'insert');
        }
        $sql = "SELECT * FROM $this->rentitem_post_tmp WHERE iTmpRentItemPostId ='" . $iTmpRentItemPostIdNew . "'";
        $data = $obj->MySQLSelect($sql);
        $allData = array();
        foreach($data as $key => $value){
            $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $value['vCurrencyPassenger'] . "'");
            $allData['iTmpRentItemPostId'] = $value['iTmpRentItemPostId'];
            $allData['iItemCategoryId'] = $value['iItemCategoryId'];
            $allData['iItemSubCategoryId'] = $value['iItemSubCategoryId'];
            $reqArr = array('vTitle');
            $getrentitem = $this->getrentitem('webservice', $value['iItemCategoryId'], $vLanguage, $reqArr);
            $subsql = " AND iRentItemId = '" . $value['iItemSubCategoryId'] . "'";
            $DatanewArr = $this->getRentItemSubCategory('webservice', $value['iItemCategoryId'], $subsql, '', '', $vLanguage, '', $reqArr);
            $allData['vCatName'] = $getrentitem['vTitle'];
            $allData['vSubCatName'] = $DatanewArr[0]['vTitle'];
            $allData['vRentItemPostNo'] = "# " . $value['vRentItemPostNo'];
            $allData['iUserId'] = $value['iUserId'];
            $allData['vTimeZone'] = $value['vTimeZone'];
            $allData['vLocation'] = $value['vLocation'];
            $allData['vLatitude'] = $value['vLatitude'];
            $allData['vLongitude'] = $value['vLongitude'];
            $allData['vBuildingNo'] = $value['vBuildingNo'];
            $allData['vAddress'] = $value['vAddress'];
            $allData['fAmount'] = formateNumAsPerCurrency($value['fAmount'] * $currency[0]['ratio'], $value['vCurrencyPassenger']);
            $allData['fAmountWithoutSymbol'] = $value['fAmount'];
            $allData['eStatus'] = $value['eStatus'];
            $allData['vCurrencyPassenger'] = $value['vCurrencyPassenger'];
            $allData['eIsUserNumberDisplay'] = $value['eIsUserNumberDisplay'];
            $allData['eIsUserAddressDisplay'] = $value['eIsUserAddressDisplay'];
            $allData['eRentItemDuration'] = $value['eRentItemDuration'];
            $imgIds = explode(",", $value['vImageIds']);
            $getImages = $this->getRentItemImage("webservice", $value['iItemCategoryId'], $value['iUserId'], $vLanguage, $imgIds);
            $imagesarr = array();
            foreach($getImages as $k => $val){
                if(!empty($iTmpRentItemPostIdNew)&& !empty($val['iRentImageId'])){
                    $where = " iRentImageId = '" . $val['iRentImageId'] . "'";
                    $RentItemImgData['iTmpRentItemPostId'] = $iTmpRentItemPostIdNew;
                    $rentitemimgData = $obj->MySQLQueryPerform($this->rentitem_images, $RentItemImgData, 'update', $where);
                }
                $imagesarr[$k]['iRentImageId'] = $val['iRentImageId'];
                $imagesarr[$k]['vImage'] = $val['vImage'];
                $imagesarr[$k]['eFileType'] = $val['eFileType'];
                $imagesarr[$k]['ThumbImage'] = $val['ThumbImage'];
            }
            $allData['Images'] = $imagesarr;
            $rentitemFieldarray = $vItemName = array();
            $tFieldsArr = json_decode($value['tFieldsArr'], true);
            $tFields_Details_Arr = [];
            foreach($tFieldsArr as $k => $arryfields){
                $tFields_Details_Arr[0][$arryfields['iData']] = $arryfields['value'];
            }
            foreach($tFields_Details_Arr as $k => $arryfields){
                foreach($arryfields as $iRentFieldId => $valuerentfield){
                    $getRentItemFields = $this->getRentItemFields("webservice", $iRentFieldId, "","", $vLanguage);
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eTitle'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eName'] = 'Yes';
                        $vItemName[$iRentFieldId] = $valuerentfield;
                    }
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eDescription'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eDescription'] = 'Yes';
                    }
                    $rentitemFieldarray[$iRentFieldId]['iOrder'] = $getRentItemFields[0]['iOrder'];
                    $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $valuerentfield;
                    $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                    $rentitemFieldarray[$iRentFieldId]['vValue'] = $valuerentfield;
                    if($getRentItemFields[0]['eInputType'] == 'Select' && $iRentFieldId == $getRentItemFields[0]['iRentFieldId']){
                        $vFieldName = get_value('rent_item_fields_option', 'JSON_UNQUOTE(JSON_VALUE(tFieldName, "$.tOptionNameLang_' . $vLanguage . '"))', 'iOptionId', $valuerentfield, '', 'true');
                        $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $vFieldName;
                        $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                        $rentitemFieldarray[$iRentFieldId]['vValue'] = $vFieldName;
                    }
                }
            }
            $rentitemFieldarray = array_values($rentitemFieldarray);
            $key_values = array_column($rentitemFieldarray, 'iOrder');
            array_multisort($key_values, SORT_ASC, $rentitemFieldarray);
            $rentitemFieldarrayNew = array();
            $rentitemFieldarr = array();
            foreach($rentitemFieldarray as $key => $subArr){
                if(scount($vItemName)> 1 && $subArr['eName'] == 'Yes'){
                    ksort($vItemName, SORT_NUMERIC);
                    $subArr['vItemName'] = implode(" - ", $vItemName);
                }
                $vTitleNew = $subArr['vTitle'];
                $vValueNew = $subArr['vValue'];
                unset($subArr['iOrder']);
                unset($subArr['vTitle']);
                unset($subArr['vValue']);
                $rentitemFieldarrayNew[] = $subArr;
                $ADDArr['vTitle'] = $vTitleNew;
                $ADDArr['vValue'] = $vValueNew;
                if(isset($subArr['eName'])&& !empty($subArr['eName'])){
                    $ADDArr['eName'] = $subArr['eName'];
                }
                else {
                    unset($ADDArr['eName']);
                }
                if(isset($subArr['eDescription'])&& !empty($subArr['eDescription'])){
                    $ADDArr['eDescription'] = $subArr['eDescription'];
                }
                else {
                    unset($ADDArr['eDescription']);
                }
                if(isset($subArr['vItemName'])&& !empty($subArr['vItemName'])){
                    $ADDArr['vItemName'] = $subArr['vItemName'];
                }
                else {
                    unset($ADDArr['vItemName']);
                }
                $rentitemFieldarr[] = $ADDArr;
            }
            $allData['RentitemFieldarray'] = $rentitemFieldarrayNew;
            $allData['RentitemFieldArr'] = $rentitemFieldarr;
            $timeslot = array();
            $weekdayArray = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            foreach($weekdayArray as $weekdayname){
                if($weekdayname == 'Monday'){
                    if($value['vMonFromSlot'] != "00:00:00" && $value['vMonToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vMonFromSlot'])). ' - ' . date("h:i A", strtotime($value['vMonToSlot']));
                    }
                }
                else if($weekdayname == 'Tuesday'){
                    if($value['vTueFromSlot'] != "00:00:00" && $value['vTueToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vTueFromSlot'])). ' - ' . date("h:i A", strtotime($value['vTueToSlot']));
                    }
                }
                else if($weekdayname == 'Wednesday'){
                    if($value['vWedFromSlot'] != "00:00:00" && $value['vWedToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vWedFromSlot'])). ' - ' . date("h:i A", strtotime($value['vWedToSlot']));
                    }
                }
                else if($weekdayname == 'Thursday'){
                    if($value['vThuFromSlot'] != "00:00:00" && $value['vThuToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vThuFromSlot'])). ' - ' . date("h:i A", strtotime($value['vThuToSlot']));
                    }
                }
                else if($weekdayname == 'Friday'){
                    if($value['vFriFromSlot'] != "00:00:00" && $value['vFriToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vFriFromSlot'])). ' - ' . date("h:i A", strtotime($value['vFriToSlot']));
                    }
                }
                else if($weekdayname == 'Saturday'){
                    if($value['vSatFromSlot'] != "00:00:00" && $value['vSatToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSatFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSatToSlot']));
                    }
                }
                else if($weekdayname == 'Sunday'){
                    if($value['vSunFromSlot'] != "00:00:00" && $value['vSunToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSunFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSunToSlot']));
                    }
                }
            }
            $allData['timeslot'] = $timeslot;
        }
        return $allData;
    }
    public function getRentItemImage($use, $iItemCategoryId = "", $iUserId = "", $vLanguage = "EN", $iRentImageIdArr = [], $iRentItemPostId = "", $iTmpRentItemPostId = "", $reqArr = []){
        global $obj, $tconfig;
        $ssql = "";
        if(!empty($iUserId)&& empty($iRentImageIdArr)&& empty($iRentItemPostId)&& empty($iTmpRentItemPostId)){
            $ssql .= " AND iRentItemPostId = 0 AND iTmpRentItemPostId = 0";
        }
        if($iRentItemPostId != ""){
            $ssql .= " AND iRentItemPostId ='$iRentItemPostId'";
        }
        if($iTmpRentItemPostId != ""){
            $ssql .= " AND iTmpRentItemPostId ='$iTmpRentItemPostId'";
        }
        if(!empty($iRentImageIdArr)){
            $iRentImageIds = implode(",", $iRentImageIdArr);
            $getImages = $obj->MySQLSelect("SELECT * FROM rentitem_images WHERE iRentImageId IN($iRentImageIds)$ssql ORDER BY `iRentImageId` DESC ");
        }
        else {
            $getImages = $obj->MySQLSelect("SELECT * FROM rentitem_images WHERE iUserId='" . $iUserId . "' AND iItemCategoryId = '" . $iItemCategoryId . "' $ssql ORDER BY `iRentImageId` DESC ");
        }
        for($p = 0;
        $p < scount($getImages);
        $p++){
            $tmp = explode(".", $getImages[$p]['vImage']);
            for($i = 0;
            $i < scount($tmp)- 1;
            $i++){
                $tmp1[] = $tmp[$i];
            }
            $file = implode("_", $tmp1);
            $ext = $tmp[scount($tmp)- 1];
            $videoExt_arr = array('MP4', 'MOV', 'WMV', 'AVI', 'FLV', 'MKV', 'WEBM');
            $getImages[$p]['eFileType'] = 'Image';
            $getImages[$p]['ThumbImage'] = '';
            if(in_array(strtoupper($ext), $videoExt_arr)){
                $getImages[$p]['eFileType'] = 'Video';
                $getImages[$p]['ThumbImage'] = $this->getVideoThumbImageProvider($getImages[$p]['vImage']);
            }
            $getImages[$p]['vImage'] = $tconfig['tsite_upload_images_rent_item'] . $getImages[$p]['vImage'];
        }
        return $getImages;
    }
    function getVideoThumbImageProvider($video_file){
        global $tconfig;
        $tmpArr = explode(".", $video_file);
        for($i = 0;
        $i < scount($tmpArr)- 1;
        $i++){
            $tmpArr1[] = $tmpArr[$i];
        }
        $file = implode("_", $tmpArr1);
        $thumb_img = $file . '.png';
        if(!is_dir($tconfig["tsite_upload_images_rent_item_path"] . '/thumnails/')){
            mkdir($tconfig["tsite_upload_images_rent_item_path"] . '/thumnails/', 0777);
            chmod($tconfig["tsite_upload_images_rent_item_path"] . '/thumnails/', 0777);
        }
        $img_path = $tconfig["tsite_upload_images_rent_item_path"] . '/thumnails/' . $thumb_img;
        $img_url = $tconfig["tsite_upload_images_rent_item"] . 'thumnails/' . $thumb_img;
        if(file_exists($img_path)){
            return $img_url;
        }
        else {
            $sec = 3;
            $vFile = $tconfig["tsite_upload_images_rent_item_path"] . $video_file;
            if(file_exists($vFile)){
                $ffprobe = FFMpeg\FFProbe::create();
                $vDuration = $ffprobe->streams($vFile)->videos()->first()->get('duration');
                if($vDuration < 3){
                    $sec = floor($vDuration);
                }
                $ffmpeg = FFMpeg\FFMpeg::create();
                $video = $ffmpeg->open($vFile);
                $frame = $video->frame(FFMpeg\Coordinate\TimeCode::fromSeconds($sec));
                $frame->save($img_path);
            }
            return $img_url;
        }
    }
    public function getRentItemFields($use, $iRentFieldId = "", $iRentItemId = "", $iRentItemPostId = "", $vLanguage = "EN", $reqArr = []){
        global $obj;
        if(!empty($iRentItemId)){
            $sql = "SELECT iRentFieldId,vFieldName,iRentItemId,eInputType,eAllowFloat,eRequired,eEditable,iOrder,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tFieldName_" . $vLanguage . "'))as tFieldName,JSON_UNQUOTE(JSON_VALUE(tDesc, '$.tDesc_" . $vLanguage . "'))as tDesc,eStatus,eDescription,eTitle,eListing from rentitem_fields where eStatus='Active' AND iRentItemId='" . $iRentItemId . "' order by iOrder ASC";
        }
        else if(!empty($iRentFieldId)){
            $sql = "SELECT iRentFieldId,vFieldName,iRentItemId,eInputType,eAllowFloat,eRequired,eEditable,iOrder,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tFieldName_" . $vLanguage . "'))as tFieldName,JSON_UNQUOTE(JSON_VALUE(tDesc, '$.tDesc_" . $vLanguage . "'))as tDesc,eStatus,eDescription,eTitle,eListing from rentitem_fields where iRentFieldId='" . $iRentFieldId . "' order by iOrder ASC";
        }
        else {
            $sql = "SELECT iRentFieldId,vFieldName,iRentItemId,eInputType,eAllowFloat,eRequired,eEditable,iOrder,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tFieldName_" . $vLanguage . "'))as tFieldName,JSON_UNQUOTE(JSON_VALUE(tDesc, '$.tDesc_" . $vLanguage . "'))as tDesc,eStatus,eDescription,eTitle,eListing from rentitem_fields where eStatus='Active' order by iOrder ASC";
        }
        $db_fields = $obj->MySQLSelect($sql);
        $getPostFieldVal = "SELECT tFieldsArr FROM `rentitem_post` WHERE iRentItemPostId = '" . $iRentItemPostId . "'";
        $db_post_fields = $obj->MySQLSelect($getPostFieldVal);
        $newarray = [];
        if(!empty($db_post_fields)){
            $tFieldsArr = json_decode($db_post_fields[0]['tFieldsArr'], true);
            foreach($tFieldsArr as $k => $arryfields){
                $newarray[$arryfields['iData']] = $arryfields['value'];
            }
        }
        if(scount($db_fields)> 0){
            for($i = 0;
            $i < scount($db_fields);
            $i++){
                $Data_Field[$i]['vFieldName'] = $db_fields[$i]['tFieldName'];
                $Data_Field[$i]['iRentItemId'] = $db_fields[$i]['iRentItemId'];
                $Data_Field[$i]['tFieldName'] = $db_fields[$i]['tFieldName'];
                if($db_fields[$i]['tDesc'] != null){
                    $Data_Field[$i]['tDesc'] = $db_fields[$i]['tDesc'];
                }
                else {
                    $Data_Field[$i]['tDesc'] = "";
                }
                $Data_Field[$i]['eInputType'] = $db_fields[$i]['eInputType'];
                if($db_fields[$i]['eInputType'] == "Select"){
                    $Data_Field[$i]['Options'] = $this->getSelectOptions($db_fields[$i]['iRentFieldId'], $vLanguage);
                }
                $Data_Field[$i]['eAllowFloat'] = $db_fields[$i]['eAllowFloat'];
                $Data_Field[$i]['eRequired'] = $db_fields[$i]['eRequired'];
                $Data_Field[$i]['eEditable'] = $db_fields[$i]['eEditable'];
                $Data_Field[$i]['iRentFieldId'] = $db_fields[$i]['iRentFieldId'];
                $Data_Field[$i]['eStatus'] = $db_fields[$i]['eStatus'];
                $Data_Field[$i]['eDescription'] = $db_fields[$i]['eDescription'];
                $Data_Field[$i]['eTitle'] = $db_fields[$i]['eTitle'];
                $Data_Field[$i]['eListing'] = $db_fields[$i]['eListing'];
                $Data_Field[$i]['iOrder'] = $db_fields[$i]['iOrder'];
                if(!empty($newarray[$db_fields[$i]['iRentFieldId']])){
                    $getRentItemFields = $this->getRentItemFields("webservice", $db_fields[$i]['iRentFieldId'], "","", $vLanguage);
                    if($getRentItemFields[0]['eInputType'] == 'Select'){
                        $vFieldName = get_value('rent_item_fields_option', "JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tOptionNameLang_" . $vLanguage . "'))", 'iOptionId', $newarray[$db_fields[$i]['iRentFieldId']], '', 'true');
                        $Data_Field[$i]['vAddedValue'] = $vFieldName;
                        $Data_Field[$i]['iSelectedOptioId'] = $newarray[$db_fields[$i]['iRentFieldId']];
                        $eListingTypeOptions = get_value('rent_item_fields_option', 'eListingType', 'iOptionId', $newarray[$db_fields[$i]['iRentFieldId']], '', 'true');
                        if($eListingTypeOptions == "Rent"){
                            $Data_Field[$i]['isBuySell'] = "No";
                        }
                        else if($eListingTypeOptions == "Sale"){
                            $Data_Field[$i]['isBuySell'] = "Yes";
                        }
                    }
                    else {
                        $Data_Field[$i]['vAddedValue'] = $newarray[$db_fields[$i]['iRentFieldId']];
                    }
                }
                else {
                    $Data_Field[$i]['vAddedValue'] = "";
                }
            }
        }
        return $Data_Field;
    }
    function getSelectOptions($iRentFieldId, $vLanguage = "EN"){
        global $obj;
        $sql = "SELECT iOptionId,vFieldName,iRentFieldId,eStatus,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tOptionNameLang_" . $vLanguage . "'))as tFieldName,eListingType FROM rent_item_fields_option WHERE iRentFieldId='" . $iRentFieldId . "' AND eStatus = 'Active' ORDER BY iOptionId ASC";
        $db_fields = $obj->MySQLSelect($sql);
        $dbFieldsArray = array();
        foreach($db_fields as $key => $value){
            $dbFieldsArray[$key]['iOptionId'] = $value['iOptionId'];
            if($value['tFieldName'] != ""){
                $dbFieldsArray[$key]['vTitle'] = $value['tFieldName'];
                $dbFieldsArray[$key]['vFieldName'] = $value['tFieldName'];
            }
            else {
                $dbFieldsArray[$key]['vTitle'] = $value['vFieldName'];
                $dbFieldsArray[$key]['vFieldName'] = $value['vFieldName'];
            }
            $dbFieldsArray[$key]['iRentFieldId'] = $value['iRentFieldId'];
            if(!empty($value['eListingType'])){
                $dbFieldsArray[$key]['eListingTypeOptions'] = $value['eListingType'];
            }
        }
        return $dbFieldsArray;
    }
    function createRentItemFinalPost($use, $iTmpRentItemPostId, $iRentItemPostId, $iMemberId, $iPaymentPlanId, $vLanguage = "EN", $isfree = "No", $finalarray = array(), $reqArr = []){
        global $obj;
        $postarray = $paymentArray = array();
        if(($iTmpRentItemPostId != "")&& empty($finalarray)){
            $getPostData = $this->getRentItemPostData("webservice", $iTmpRentItemPostId, $iMemberId, $vLanguage);
            $postarray['iItemCategoryId'] = $getPostData[0]['iItemCategoryId'];
            $postarray['iItemSubCategoryId'] = $getPostData[0]['iItemSubCategoryId'];
            $postarray['iTmpRentItemPostId'] = $getPostData[0]['iTmpRentItemPostId'];
            $postarray['vTimeZone'] = $getPostData[0]['vTimeZone'];
            $postarray['iUserId'] = $getPostData[0]['iUserId'];
            $postarray['vRentItemPostNo'] = rand(10000000, 99999999);
            $postarray['vLocation'] = $getPostData[0]['vLocation'];
            $postarray['vLatitude'] = $getPostData[0]['vLatitude'];
            $postarray['vLongitude'] = $getPostData[0]['vLongitude'];
            $postarray['vBuildingNo'] = $getPostData[0]['vBuildingNo'];
            $postarray['vAddress'] = $getPostData[0]['vAddress'];
            $postarray['fAmount'] = $getPostData[0]['fAmount'];
            $postarray['dPickupAvailableDate'] = $getPostData[0]['dPickupAvailableDate'];
            $postarray['dPickupAvailableTime'] = $getPostData[0]['dPickupAvailableTime'];
            $postarray['eStatus'] = 'Pending';
            $getRentItemPaymentPlanAmount = $this->getRentItemPlan("webservice", $iPaymentPlanId, $vLanguage);
            $paymentArray['iPaymentPlanId'] = $getRentItemPaymentPlanAmount['iPaymentPlanId'];
            $paymentArray['iTotalDays'] = $getRentItemPaymentPlanAmount['iTotalDays'];
            $paymentArray['iTotalPost'] = $getRentItemPaymentPlanAmount['iTotalPost'];
            $paymentArray['iTotalPost'] = $getRentItemPaymentPlanAmount['iTotalPost'];
            $paymentArray['fAmount'] = $getRentItemPaymentPlanAmount['fAmount'];
            $paymentArray['eStatus'] = $getRentItemPaymentPlanAmount['eStatus'];
            $paymentArray['vPlanNameDefault'] = $getRentItemPaymentPlanAmount['vPlanNameDefault'];
            $paymentArray['eFreePlan'] = $getRentItemPaymentPlanAmount['eFreePlan'];
            $paymentArray['eFeaturedPlan'] = $getRentItemPaymentPlanAmount['eFeaturedPlan'];
            $paymentArray['iMasterServiceCategoryId'] = $getRentItemPaymentPlanAmount['iMasterServiceCategoryId'];
            $jsonPaymentString = json_encode($paymentArray);
            $postarray['tPaymentPlanDetails'] = $jsonPaymentString;
            if(SITE_TYPE == "Demo"){
                $iTotalDays = $getRentItemPaymentPlanAmount['iTotalDays'];
                $addeddate = ' +' . $iTotalDays . ' days';
                $renewdate = date('Y-m-d H:i:s', strtotime($addeddate));
                $dApprovedDate = date('Y-m-d H:i:s');
                $postarray['eStatus'] = 'Approved';
                $postarray['dApprovedDate'] = $dApprovedDate;
                $postarray['dRenewDate'] = $renewdate;
            }
            $postarray['iPaymentPlanId'] = $iPaymentPlanId;
            $postarray['eRentItemDuration'] = $getPostData[0]['eRentItemDuration'];
            $postarray['vImageIds'] = $getPostData[0]['vImageIds'];
            $postarray['tFieldsArr'] = $getPostData[0]['tFieldsArr'];
            $postarray['dRentItemPostDateTmp'] = $getPostData[0]['dRentItemPostDate'];
            $postarray['eIsFavourite'] = "No";
            $postarray['eIsUserNumberDisplay'] = $getPostData[0]['eIsUserNumberDisplay'];
            $postarray['eIsUserAddressDisplay'] = $getPostData[0]['eIsUserAddressDisplay'];
            $postarray['vMonFromSlot'] = $getPostData[0]['vMonFromSlot'];
            $postarray['vMonToSlot'] = $getPostData[0]['vMonToSlot'];
            $postarray['vTueFromSlot'] = $getPostData[0]['vTueFromSlot'];
            $postarray['vTueToSlot'] = $getPostData[0]['vTueToSlot'];
            $postarray['vWedFromSlot'] = $getPostData[0]['vWedFromSlot'];
            $postarray['vWedToSlot'] = $getPostData[0]['vWedToSlot'];
            $postarray['vThuFromSlot'] = $getPostData[0]['vThuFromSlot'];
            $postarray['vThuToSlot'] = $getPostData[0]['vThuToSlot'];
            $postarray['vFriFromSlot'] = $getPostData[0]['vFriFromSlot'];
            $postarray['vFriToSlot'] = $getPostData[0]['vFriToSlot'];
            $postarray['vSatFromSlot'] = $getPostData[0]['vSatFromSlot'];
            $postarray['vSatToSlot'] = $getPostData[0]['vSatToSlot'];
            $postarray['vSunFromSlot'] = $getPostData[0]['vSunFromSlot'];
            $postarray['vSunToSlot'] = $getPostData[0]['vSunToSlot'];
        }
        else {
            $postarray = $finalarray;
        }
        if(!empty($iRentItemPostId)){
            $where = " iRentItemPostId = '" . $iRentItemPostId . "'";
            $iRentItemPostIdNew = $obj->MySQLQueryPerform($this->rentitem_post, $postarray, 'update', $where);
            $iRentItemPostIdNew = $iRentItemPostId;
        }
        else {
            $iRentItemPostIdNew = $obj->MySQLQueryPerform($this->rentitem_post, $postarray, 'insert');
        }
        if($isfree == "Yes"){
            $where_rentitem = " iRentItemPostId = '" . $iRentItemPostIdNew . "'";
            $data_rentitems['ePaid'] = 'Yes';
            $data_rentitems['eUserPayment'] = 'Settled';
            $obj->MySQLQueryPerform($this->rentitem_post, $data_rentitems, 'update', $where_rentitem);
        }
        if(!empty($iTmpRentItemPostId)&& !empty($iRentItemPostIdNew)){
            $where = " iTmpRentItemPostId = '" . $iTmpRentItemPostId . "'";
            $RentItemPostData['iPaymentPlanId'] = $iPaymentPlanId;
            $RentItemPostData['eStatus'] = "Completed";
            $RentItemPostData['iRentItemPostId'] = $iRentItemPostIdNew;
            $iTmpRentItemPostIdNew = $obj->MySQLQueryPerform($this->rentitem_post_tmp, $RentItemPostData, 'update', $where);
        }
        $sql = "SELECT * FROM $this->rentitem_post WHERE iRentItemPostId ='" . $iRentItemPostIdNew . "'";
        $data = $obj->MySQLSelect($sql);
        $allData = array();
        foreach($data as $key => $value){
            $iUserId = $value['iUserId'];
            $tblName = "register_user";
            if(isset($userDetailsArr[$tblName . "_" . $iUserId])&& scount($userDetailsArr[$tblName . "_" . $iUserId])> 0){
                $Data = $userDetailsArr[$tblName . "_" . $iUserId];
            }
            else {
                $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
                $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
            }
            $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $Data[0]['vCurrencyPassenger'] . "'");
            $allData['iRentItemPostId'] = $value['iRentItemPostId'];
            $allData['iTmpRentItemPostId'] = $value['iTmpRentItemPostId'];
            $allData['iItemCategoryId'] = $value['iItemCategoryId'];
            $allData['iItemSubCategoryId'] = $value['iItemSubCategoryId'];
            $reqArr = array('vTitle');
            $getrentitem = $this->getrentitem('webservice', $value['iItemCategoryId'], $vLanguage, $reqArr);
            $subsql = " AND iRentItemId = '" . $value['iItemSubCategoryId'] . "'";
            $DatanewArr = $this->getRentItemSubCategory('webservice', $value['iItemCategoryId'], $subsql, '', '', $vLanguage, '', $reqArr);
            $allData['vCatName'] = $getrentitem['vTitle'];
            $allData['vSubCatName'] = $DatanewArr[0]['vTitle'];
            $allData['vRentItemPostNo'] = "# " . $value['vRentItemPostNo'];
            $allData['iUserId'] = $value['iUserId'];
            $allData['vTimeZone'] = $value['vTimeZone'];
            $allData['vLocation'] = $value['vLocation'];
            $allData['vLatitude'] = $value['vLatitude'];
            $allData['vLongitude'] = $value['vLongitude'];
            $allData['vBuildingNo'] = $value['vBuildingNo'];
            $allData['eIsFavourite'] = $value['eIsFavourite'];
            $allData['vAddress'] = $value['vAddress'];
            $allData['fAmount'] = formateNumAsPerCurrency($value['fAmount'] * $currency[0]['ratio'], $Data[0]['vCurrencyPassenger']);
            $allData['fAmountWithoutSymbol'] = $value['fAmount'];
            $allData['eStatus'] = $value['eStatus'];
            $allData['dRentItemPostDateTmp'] = $value['dRentItemPostDate'];
            $allData['eRentItemDuration'] = $value['eRentItemDuration'];
            $imgIds = explode(",", $value['vImageIds']);
            $getImages = $this->getRentItemImage("webservice", $value['iItemCategoryId'], $value['iUserId'], $vLanguage, $imgIds);
            $imagesarr = array();
            foreach($getImages as $k => $val){
                if(!empty($value['iRentItemPostId'])&& !empty($val['iRentImageId'])){
                    $where = " iRentImageId = '" . $val['iRentImageId'] . "'";
                    $RentItemImgData['iRentItemPostId'] = $value['iRentItemPostId'];
                    $rentitemimgData = $obj->MySQLQueryPerform($this->rentitem_images, $RentItemImgData, 'update', $where);
                }
                $imagesarr[$k]['iRentImageId'] = $val['iRentImageId'];
                $imagesarr[$k]['vImage'] = $val['vImage'];
                $imagesarr[$k]['eFileType'] = $val['eFileType'];
                $imagesarr[$k]['ThumbImage'] = $val['ThumbImage'];
            }
            $allData['Images'] = $imagesarr;
            $rentitemFieldarray = array();
            $tFieldsArr = json_decode($value['tFieldsArr'], true);
            $tFields_Details_Arr = [];
            foreach($tFieldsArr as $k => $arryfields){
                $tFields_Details_Arr[0][$arryfields['iData']] = $arryfields['value'];
            }
            foreach($tFields_Details_Arr as $k => $arryfields){
                foreach($arryfields as $iRentFieldId => $valuerentfield){
                    $getRentItemFields = $this->getRentItemFields("webservice", $iRentFieldId, "","", $vLanguage);
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eTitle'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eName'] = 'Yes';
                        $allData['vItemName'] = $valuerentfield;
                    }
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eDescription'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eDescription'] = 'Yes';
                    }
                    $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $valuerentfield;
                    $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                    $rentitemFieldarray[$iRentFieldId]['vValue'] = $valuerentfield;
                    if($getRentItemFields[0]['eInputType'] == 'Select' && $iRentFieldId == $getRentItemFields[0]['iRentFieldId']){
                        $vFieldName = get_value('rent_item_fields_option', 'JSON_UNQUOTE(JSON_VALUE(tFieldName, "$.tOptionNameLang_' . $vLanguage . '"))', 'iOptionId', $valuerentfield, '', 'true');
                        $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $vFieldName;
                        $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                        $rentitemFieldarray[$iRentFieldId]['vValue'] = $vFieldName;
                    }
                }
            }
            $allData['RentitemFieldarray'] = array_values($rentitemFieldarray);
            $rentitemFieldarr = array();
            foreach($rentitemFieldarray as $key => $subArr){
                $ADDArr['vTitle'] = $subArr['vTitle'];
                $ADDArr['vValue'] = $subArr['vValue'];
                if(isset($subArr['eName'])&& !empty($subArr['eName'])){
                    $ADDArr['eName'] = $subArr['eName'];
                }
                else {
                    unset($ADDArr['eName']);
                }
                if(isset($subArr['eDescription'])&& !empty($subArr['eDescription'])){
                    $ADDArr['eDescription'] = $subArr['eDescription'];
                }
                else {
                    unset($ADDArr['eDescription']);
                }
                if(isset($subArr['vItemName'])&& !empty($subArr['vItemName'])){
                    $ADDArr['vItemName'] = $subArr['vItemName'];
                }
                else {
                    unset($ADDArr['vItemName']);
                }
                $rentitemFieldarr[] = $ADDArr;
            }
            $allData['RentitemFieldArr'] = $rentitemFieldarr;
            $weekdayArray = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            $timeslot = array();
            foreach($weekdayArray as $weekdayname){
                if($weekdayname == 'Monday'){
                    if($value['vMonFromSlot'] != "00:00:00" && $value['vMonToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vMonFromSlot'])). ' - ' . date("h:i A", strtotime($value['vMonToSlot']));
                    }
                }
                else if($weekdayname == 'Tuesday'){
                    if($value['vTueFromSlot'] != "00:00:00" && $value['vTueToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vTueFromSlot'])). ' - ' . date("h:i A", strtotime($value['vTueToSlot']));
                    }
                }
                else if($weekdayname == 'Wednesday'){
                    if($value['vWedFromSlot'] != "00:00:00" && $value['vWedToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vWedFromSlot'])). ' - ' . date("h:i A", strtotime($value['vWedToSlot']));
                    }
                }
                else if($weekdayname == 'Thursday'){
                    if($value['vThuFromSlot'] != "00:00:00" && $value['vThuToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vThuFromSlot'])). ' - ' . date("h:i A", strtotime($value['vThuToSlot']));
                    }
                }
                else if($weekdayname == 'Friday'){
                    if($value['vFriFromSlot'] != "00:00:00" && $value['vFriToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vFriFromSlot'])). ' - ' . date("h:i A", strtotime($value['vFriToSlot']));
                    }
                }
                else if($weekdayname == 'Saturday'){
                    if($value['vSatFromSlot'] != "00:00:00" && $value['vSatToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSatFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSatToSlot']));
                    }
                }
                else if($weekdayname == 'Sunday'){
                    if($value['vSunFromSlot'] != "00:00:00" && $value['vSunToSlot'] != "00:00:00"){
                        $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSunFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSunToSlot']));
                    }
                }
            }
            $allData['timeslot'] = $timeslot;
        }
        return $allData;
    }
    function getRentItemPostData($use, $iTmpRentItemPostId, $iMemberId, $vLanguage = "EN", $reqArr = []){
        global $obj;
        $sql = "SELECT * FROM $this->rentitem_post_tmp WHERE iTmpRentItemPostId ='" . $iTmpRentItemPostId . "'";
        $allData = $obj->MySQLSelect($sql);
        return $allData;
    }
    function getRentItemPostFinalOwner($use, $iRentItemPostId, $iUserId, $vLanguage = "EN", $For = "", $iCategoryId = "", $reqArr = []){
        global $obj, $LANG_OBJ, $tconfig;
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", "0");
        $where = "";
        if(!empty($iUserId)){
            $where .= " AND iUserId ='" . $iUserId . "'";
        }
        if(!empty($iCategoryId)){
            $where .= " AND iItemCategoryId = '" . $iCategoryId . "'";
        }
        if(!empty($iRentItemPostId)){
            $where .= " AND iRentItemPostId !='" . $iRentItemPostId . "' AND eStatus = 'Approved' ";
        }
        $sql = "SELECT * FROM $this->rentitem_post WHERE 1 = 1 $where AND eStatus != 'Deleted'";
        $data = $obj->MySQLSelect($sql);
        $allData = $alldatanewArr = $rentitemDataArr = array();
        foreach($data as $key => $value){
            $iUserId = $value['iUserId'];
            $tblName = "register_user";
            if(isset($userDetailsArr[$tblName . "_" . $iUserId])&& scount($userDetailsArr[$tblName . "_" . $iUserId])> 0){
                $Data = $userDetailsArr[$tblName . "_" . $iUserId];
            }
            else {
                $Data = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
                $userDetailsArr[$tblName . "_" . $iUserId] = $Data;
            }
            $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $Data[0]['vCurrencyPassenger'] . "'");
            $allData['iRentItemPostId'] = $value['iRentItemPostId'];
            $allData['iTmpRentItemPostId'] = $value['iTmpRentItemPostId'];
            $allData['iItemCategoryId'] = $value['iItemCategoryId'];
            $allData['iItemSubCategoryId'] = $value['iItemSubCategoryId'];
            $reqArr = array('vTitle');
            $getrentitem = $this->getrentitem('webservice', $value['iItemCategoryId'], $vLanguage, $reqArr);
            $subsql = " AND iRentItemId = '" . $value['iItemSubCategoryId'] . "'";
            $DatanewArr = $this->getRentItemSubCategory('webservice', $value['iItemCategoryId'], $subsql, '', '', $vLanguage, '', $reqArr);
            $allData['vCatName'] = $getrentitem['vTitle'];
            if(!empty($DatanewArr[0]['vTitle'])){
                $allData['vCatName'] = $getrentitem['vTitle'] . " - " . $DatanewArr[0]['vTitle'];
            }
            $allData['vRentItemPostNo'] = "# " . $value['vRentItemPostNo'];
            $allData['iUserId'] = $value['iUserId'];
            $allData['vUserName'] = $Data[0]['vName'] . ' ' . $Data[0]['vLastName'];
            $allData['vUserEmail'] = $Data[0]['vEmail'];
            $allData['vUserPhone'] = '+' . $Data[0]['vPhoneCode'] . ' ' . $Data[0]['vPhone'];
            $allData['eIsUserAddressDisplay'] = $value['eIsUserAddressDisplay'];
            $allData['eIsUserNumberDisplay'] = $value['eIsUserNumberDisplay'];
            $Photo_Gallery_folder_path = $tconfig['tsite_upload_images_passenger_path'] . "/" . $iUserId . "/";
            $Photo_Gallery_folder = $tconfig['tsite_upload_images_passenger'] . "/" . $iUserId . "/";
            $imgpath = $Photo_Gallery_folder_path . "2_" . $Data[0]['vImgName'];
            if($Data[0]['vImgName'] != "" && file_exists($imgpath)){
                $imgpath1 = $Photo_Gallery_folder . "2_" . $Data[0]['vImgName'];
            }
            else {
                $imgpath1 = "";
            }
            $allData['vUserImage'] = $imgpath1;
            $allData['vTimeZone'] = $value['vTimeZone'];
            $allData['vLocation'] = $value['vLocation'];
            $allData['vLatitude'] = $value['vLatitude'];
            $allData['vLongitude'] = $value['vLongitude'];
            $allData['vBuildingNo'] = $value['vBuildingNo'];
            $allData['eIsFavourite'] = $value['eIsFavourite'];
            $allData['vAddress'] = $value['vAddress'];
            $allData['iPaymentPlanId'] = $value['iPaymentPlanId'];
            $allData['fAmount'] = formateNumAsPerCurrency($value['fAmount'] * $currency[0]['ratio'], $Data[0]['vCurrencyPassenger']);
            $allData['fAmountWithoutSymbol'] = $value['fAmount'];
            if($value['eStatus'] == 'Pending'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_PENDING']);
            }
            else if($value['eStatus'] == 'Approved' && $date2 >= $date_now){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_APPROVED']);
            }
            else if($value['eStatus'] == 'Approved' && $date2 < $date_now){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_EXPIRED']);
            }
            else if($value['eStatus'] == 'Deleted'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_DELETED']);
            }
            else {
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_REJECT']);
            }
            $allData['eStatus'] = $value['eStatus'];
            $allData['eStatusOrg'] = $value['eStatus'];
            $allData['dRentItemPostDate'] = $value['dRentItemPostDate'];
            $allData['PostedTxt'] = $languageLabelsArr['LBL_RENT_POSTED_BY']. " " . clearName($Data[0]['vName'] . ' ' . $Data[0]['vLastName']). ", " . date_format(date_create($value['dRentItemPostDate']), "d F, Y");
            $allData['eRentItemDuration'] = $value['eRentItemDuration'];
            $addday = '+ 1 ' . strtolower($value['eRentItemDuration']);
            $NewDate = Date('Y-m-d h:i:s', strtotime($value['dRentItemPostDate'] . $addday));
            $allData['eRentItemDurationDate'] = $NewDate;
            $date_now = new DateTime();
            $date2 = new DateTime($NewDate);
            if($value['eStatus'] == 'Pending'){
                $allData['eRentItemDurationDateTxt'] = $languageLabelsArr['LBL_RENT_ITEM_WAITING_APPROVAL'];
            }
            else if($value['eStatus'] == 'Approved' && $date2 >= $date_now){
                $allData['eRentItemDurationDateTxt'] = addslashes($languageLabelsArr['LBL_VALID_TILL_TXT']). " " . date_format(date_create($NewDate), "d F, Y");
            }
            else if($value['eStatus'] == 'Approved' && $date2 < $date_now){
                $allData['eRentItemDurationDateTxt'] = addslashes($languageLabelsArr['LBL_EXPIRED_TXT']);
            }
            else {
                $allData['eRentItemDurationDateTxt'] = "";
            }
            $imgIds = explode(",", $value['vImageIds']);
            $getImages = $this->getRentItemImage("webservice", $value['iItemCategoryId'], $value['iUserId'], $vLanguage, $imgIds);
            $imagesarr = array();
            foreach($getImages as $k => $val){
                $imagesarr[$k]['iRentImageId'] = $val['iRentImageId'];
                $imagesarr[$k]['vImage'] = $val['vImage'];
                $imagesarr[$k]['eFileType'] = $val['eFileType'];
                $imagesarr[$k]['ThumbImage'] = $val['ThumbImage'];
            }
            $allData['Images'] = $imagesarr;
            $rentitemFieldarray = array();
            $tFieldsArr = json_decode($value['tFieldsArr'], true);
            $tFields_Details_Arr = [];
            foreach($tFieldsArr as $k => $arryfields){
                $tFields_Details_Arr[0][$arryfields['iData']] = $arryfields['value'];
            }
            foreach($tFields_Details_Arr as $k => $arryfields){
                foreach($arryfields as $iRentFieldId => $value1){
                    $getRentItemFields = $this->getRentItemFields("webservice", $iRentFieldId, "","", $vLanguage);
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eTitle'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eName'] = 'Yes';
                        $allData['vItemName'] = $value1;
                    }
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eDescription'] == 'Yes'){
                        $rentitemFieldarray[$iRentFieldId]['eDescription'] = 'Yes';
                    }
                    $rentitemFieldarray[$iRentFieldId]['iOrder'] = $getRentItemFields[0]['iOrder'];
                    $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $value1;
                    if($getRentItemFields[0]['eInputType'] == 'Select' && $iRentFieldId == $getRentItemFields[0]['iRentFieldId']){
                        $vFieldName = get_value('rent_item_fields_option', 'vFieldName', 'iOptionId', $value1, '', 'true');
                        $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $vFieldName;
                    }
                }
            }
            $rentitemFieldarray = array_values($rentitemFieldarray);
            $key_values = array_column($rentitemFieldarray, 'iOrder');
            array_multisort($key_values, SORT_ASC, $rentitemFieldarray);
            $rentitemFieldarrayNew = array();
            foreach($rentitemFieldarray as $key => $subArr){
                unset($subArr['iOrder']);
                $rentitemFieldarrayNew[] = $subArr;
            }
            $allData['RentitemFieldarray'] = $rentitemFieldarrayNew;
            $timeslot = array();
            $weekdayArray = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            foreach($weekdayArray as $weekdayname){
                if($weekdayname == 'Monday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vMonFromSlot'])). ' - ' . date("h:i A", strtotime($value['vMonToSlot']));
                }
                else if($weekdayname == 'Tuesday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vTueFromSlot'])). ' - ' . date("h:i A", strtotime($value['vTueToSlot']));
                }
                else if($weekdayname == 'Wednesday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vWedFromSlot'])). ' - ' . date("h:i A", strtotime($value['vWedToSlot']));
                }
                else if($weekdayname == 'Thursday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vThuFromSlot'])). ' - ' . date("h:i A", strtotime($value['vThuToSlot']));
                }
                else if($weekdayname == 'Friday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vFriFromSlot'])). ' - ' . date("h:i A", strtotime($value['vFriToSlot']));
                }
                else if($weekdayname == 'Saturday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSatFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSatToSlot']));
                }
                else if($weekdayname == 'Sunday'){
                    $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSunFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSunToSlot']));
                }
            }
            $allData['timeslot'] = $timeslot;
            $alldatanewArr[] = $allData;
        }
        return $alldatanewArr;
    }
    public function getrentitem($use, $iRentItemId, $vLanguage = "EN", $reqArr = []){
        global $obj;
        $sql = '';
        $iRentItemId = explode(',', $iRentItemId);
        if(scount($iRentItemId)> 1){
            $sql .= " iRentItemId IN(" . $iRentItemId . ")";
        }
        else {
            $sql .= "iRentItemId = '" . $iRentItemId[0] . "'";
        }
        $rentitem = $obj->MySQLSelect("SELECT eStatus,iDisplayOrder,iRentItemId,vImage,vImage1,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle,iParentId,vTitle as vTitle_json,fCommission FROM $this->tablename WHERE 1 = 1 AND $sql");
        $return_array = array();
        if($use == 'webservice'){
            foreach($rentitem as $key => $mServiceCategory){
                $return_array[$key] = $this->getRentItemQuery_array($mServiceCategory, $reqArr);
            }
        }
        else {
            $return_array = $rentitem;
        }
        if(scount($iRentItemId)> 1){
            return $return_array;
        }
        else {
            return $return_array[0];
        }
    }
    public function getRentItemSubCategory($use, $iParent_Id, $ssql = '', $start = 0, $per_page = 0, $vLanguage = 'EN', $ord = '', $reqArr = []){
        global $obj;
        $limit = '';
        $estatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            if(empty($ssql)){
                $estatus = 'AND(estatus = "Active" || estatus = "Inactive")';
            }
        }
        if($use == 'webservice'){
            $estatus = 'AND estatus = "Active"';
        }
        $iParentId = "iParentId = '" . $iParent_Id . "'";
        $sql = "SELECT iRentItemId, vImage, vImage1 , iParentId, eStatus, iDisplayOrder,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle FROM $this->tablename WHERE 1 = 1 $estatus $ssql AND " . $iParentId . " $ord " . $limit . "";
        $rent_item_master_subcategories = $obj->MySQLSelect($sql);
        $return_array = array();
        if($use == 'webservice'){
            foreach($rent_item_master_subcategories as $key => $mServiceSubCategory){
                $return_array[$key] = $this->getRentItemQuery_array($mServiceSubCategory, $reqArr);
            }
        }
        else {
            $return_array = $rent_item_master_subcategories;
        }
        return $return_array;
    }
    function rentPostDelete($iMemberId, $iRentItemPostId, $eDeletedBy = "", $vLanguage = "EN",$eType = ""){
        global $obj;
        if(isset($iRentItemPostId)&& !empty($iRentItemPostId)){
            $where = " iRentItemPostId = '" . $iRentItemPostId . "'";
            $RentItemPostData['eStatus'] = 'Deleted';
            $RentItemPostData['eDeletedBy'] = $eDeletedBy;
            $RentItemPostData1 = $obj->MySQLQueryPerform($this->rentitem_post, $RentItemPostData, 'update', $where);
            if($RentItemPostData1 == 1){
                $returnArr['Action'] = "1";
                $getRentItemPostData = $this->getRentItemPostFinal("webservice", "", $iMemberId, $vLanguage,"","",$eType);
                if(empty($getRentItemPostData)){
                    $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
                }
                $returnArr['message2'] = "LBL_RENT_POST_DELETE_TXT";
            }
            else {
                $returnArr['Action'] = 0;
                $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
            }
        }
        else {
            $returnArr['Action'] = 0;
            $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
        }
        setDataResponse($returnArr);
    }
    function getRentItemPostFinal($use, $iRentItemPostId, $iUserId, $vLanguage = "EN", $For = "", $iCategoryId = "", $eType = "", $reqArr = []){
        global $obj, $LANG_OBJ, $tconfig, $MODULES_OBJ, $master_service_category_tbl,$_REQUEST;
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", "0");
        $postpage = isset($_REQUEST['page'])? trim($_REQUEST['page']): 1;
        $SYSTEM_TYPE = isset($_REQUEST['SYSTEM_TYPE'])? $_REQUEST['SYSTEM_TYPE'] : "";
        $startDate = isset($_REQUEST['startDate'])? $_REQUEST['startDate'] : "";
        $endDate = isset($_REQUEST['endDate'])? $_REQUEST['endDate'] : "";
        $dsql = '';
        if($SYSTEM_TYPE == "WEB"){
            if($startDate != ''){
                $dsql .= " AND Date(rp.dRentItemPostDate)>='" . $startDate . "'";
            }
            if($endDate != ''){
                $dsql .= " AND Date(rp.dRentItemPostDate)<='" . $endDate . "'";
            }
        }
        $postlimit = "";
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] != "GetRentPostForAllUser"){
            $post_per_page = 5;
            $post_start_limit =($postpage - 1)* $post_per_page;
            $postlimit = " LIMIT " . $post_start_limit . ", " . $post_per_page;
        }
        $where = "";
        if(!empty($iUserId)&& $For != 'All'){
            $where .= " AND rp.iUserId ='" . $iUserId . "'";
        }
        if(!empty($iUserId)&& $For == 'All'){
            $where .= " AND rp.eStatus = 'Approved' ";
        }
        if(!empty($iCategoryId)){
            $where .= " AND rp.iItemCategoryId = '" . $iCategoryId . "'";
        }
        if(!empty($iRentItemPostId)){
            $where .= " AND rp.iRentItemPostId ='" . $iRentItemPostId . "'";
        }
        if($use != "Web"){
            $where .= " AND((rp.eStatus != 'Deleted')OR(rp.eStatus = 'Deleted' AND rp.eDeletedBy = 'Admin'))";
        }
        $msql = "";
        if(!empty($eType)){
            $iMasterServiceCategoryId = $this->getRentItemMasterData($eType, 'iMasterServiceCategoryId');
            if(!empty($iMasterServiceCategoryId)){
                $msql = " AND rc.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
            }
        }
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] != "GetRentPostForAllUser"){
            $tsql = "SELECT iRentItemPostId FROM $this->rentitem_post as rp LEFT JOIN rent_items_category as rc on rc.iRentItemId =rp.iItemCategoryId WHERE 1 = 1 $where $msql ORDER BY rp.iRentItemPostId DESC";
            $TotalPostData = $obj->MySQLSelect($tsql);
            $totalNum = scount($TotalPostData);
            $TotalPages = ceil($totalNum / $post_per_page);
        }
        $sql = "SELECT rp.*,rc.iMasterServiceCategoryId FROM $this->rentitem_post as rp LEFT JOIN rent_items_category as rc on rc.iRentItemId =rp.iItemCategoryId WHERE 1 = 1 $where $msql $dsql ORDER BY rp.dRentItemPostDate DESC $postlimit";
        $data = $obj->MySQLSelect($sql);
        $allData = $alldatanewArr = $rentitemDataArr = array();
        $userData = $obj->MySQLSelect("SELECT vCurrencyPassenger,vEmail,iUserId as iMemberId FROM register_user WHERE iUserId='" . $iUserId . "'");
        if(!empty($userData)){
            $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $userData[0]['vCurrencyPassenger'] . "'");
        }
        else {
            $currency = get_value('currency', 'ratio,vName', 'eDefault', 'Yes', '');
            $userData[0]['vCurrencyPassenger'] = $currency[0]['vName'];
        }
        if($For == "All" && $use == "Web"){
            $currency = get_value('currency', 'ratio,vName', 'eDefault', 'Yes', '');
            $userData[0]['vCurrencyPassenger'] = $currency[0]['vName'];
        }
        foreach($data as $key => $value){
            if($value['iRentItemPostId'] != ""){
                $sendcontactQuerylog = $obj->MySQLSelect("SELECT count(iLogId)as Total FROM $this->rent_item_sendquery_log WHERE iRentItemPostId='" . $value['iRentItemPostId'] . "' AND iMemberId = '" . $iUserId . "'");
                if($sendcontactQuerylog[0]['Total'] > 0){
                    $allData['isOwnerPostSendInquiry'] = "Yes";
                }
                else {
                    $allData['isOwnerPostSendInquiry'] = "No";
                }
            }
            $tblName = "register_user";
            if($For == "All"){
                if(isset($userDetailsArr[$tblName . "_" . $value['iUserId']])&& scount($userDetailsArr[$tblName . "_" . $value['iUserId']])> 0){
                    $PostUserData = $userDetailsArr[$tblName . "_" . $value['iUserId']];
                }
                else {
                    $PostUserData = $obj->MySQLSelect("SELECT vName,vLastName,vEmail,vPhoneCode,vPhone,vImgName,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $value['iUserId'] . "'");
                    $userDetailsArr[$tblName . "_" . $value['iUserId']] = $PostUserData;
                }
            }
            else {
                if(isset($userDetailsArr[$tblName . "_" . $iUserId])&& scount($userDetailsArr[$tblName . "_" . $iUserId])> 0){
                    $PostUserData = $userDetailsArr[$tblName . "_" . $iUserId];
                }
                else {
                    $PostUserData = $obj->MySQLSelect("SELECT vName,vLastName,vEmail,vPhoneCode,vPhone,vImgName,iUserId as iMemberId FROM " . $tblName . " WHERE iUserId='" . $iUserId . "'");
                    $userDetailsArr[$tblName . "_" . $iUserId] = $PostUserData;
                }
            }
            $allData['iRentItemPostId'] = $value['iRentItemPostId'];
            $allData['iTmpRentItemPostId'] = $value['iTmpRentItemPostId'];
            $allData['iItemCategoryId'] = $value['iItemCategoryId'];
            $allData['iItemSubCategoryId'] = $value['iItemSubCategoryId'];
            if(!empty($eType)){
                $allData['eType'] = $eType;
            }
            $reqArr1 = array('vTitle');
            $getrentitem = $obj->MySQLSelect("SELECT iRentItemId,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_" . $vLanguage . "'))as vTitle FROM $this->tablename WHERE 1 = 1 AND iRentItemId = '" . $value['iItemCategoryId'] . "'");
            $subsql = " AND iRentItemId = '" . $value['iItemSubCategoryId'] . "'";
            $DatanewArr = $this->getRentItemSubCategory('webservice', $value['iItemCategoryId'], $subsql, '', '', $vLanguage, '', $reqArr1);
            if(!empty($DatanewArr[0]['vTitle'])){
                $allData['vCatName'] = $getrentitem[0]['vTitle'] . " - " . $DatanewArr[0]['vTitle'];
            }
            else {
                $allData['vCatName'] = $getrentitem[0]['vTitle'];
            }
            $allData['vRentItemPostNo'] = addslashes($languageLabelsArr['LBL_RENT_POST_NO_TXT']). "# " . $value['vRentItemPostNo'];
            $allData['vRentItemPostNoMail'] = $value['vRentItemPostNo'];
            $allData['iUserId'] = $value['iUserId'];
            if(!empty($PostUserData)){
                $allData['vUserName'] = $PostUserData[0]['vName'] . ' ' . $PostUserData[0]['vLastName'];
                $allData['vUserEmail'] = $PostUserData[0]['vEmail'];
                $allData['vUserPhone'] = '+' . $PostUserData[0]['vPhoneCode'] . $PostUserData[0]['vPhone'];
                $Photo_Gallery_folder_path = $tconfig['tsite_upload_images_passenger_path'] . "/" . $iUserId . "/";
                $Photo_Gallery_folder = $tconfig['tsite_upload_images_passenger'] . "/" . $iUserId . "/";
                $imgpath = $Photo_Gallery_folder_path . "2_" . $PostUserData[0]['vImgName'];
                if($PostUserData[0]['vImgName'] != "" && file_exists($imgpath)){
                    $imgpath1 = $Photo_Gallery_folder . "2_" . $PostUserData[0]['vImgName'];
                }
                else {
                    $imgpath1 = "";
                }
            }
            else {
                $allData['vUserName'] = '';
                $allData['vUserEmail'] = '';
                $allData['vUserPhone'] = '';
                $imgpath1 = "";
            }
            $allData['vUserImage'] = $imgpath1;
            $allData['vTimeZone'] = $value['vTimeZone'];
            $allData['vLocation'] = $value['vLocation'];
            $allData['vLatitude'] = $value['vLatitude'];
            $allData['vLongitude'] = $value['vLongitude'];
            $allData['vBuildingNo'] = $value['vBuildingNo'];
            $allData['eIsFavourite'] = $value['eIsFavourite'];
            $allData['vAddress'] = $value['vAddress'];
            $allData['eIsUserNumberDisplay'] = $value['eIsUserNumberDisplay'];
            $allData['eIsUserAddressDisplay'] = $value['eIsUserAddressDisplay'];
            $allData['iPaymentPlanId'] = $value['iPaymentPlanId'];
            $sql = " AND iPaymentPlanId='" . $value['iPaymentPlanId'] . "'";
            $rent_item_payment_plan = $this->getRentItemPaymentPlan("webservice", $sql, "", "", $vLanguage);
            $allData['eFreePlan'] = $rent_item_payment_plan[0]['eFreePlan'];
            if(strtolower($rent_item_payment_plan[0]['eFreePlan'])== 'no'){
                $allData['eFeatured'] = addslashes($languageLabelsArr['LBL_RENT_FEATURED']);
            }
            else {
                $allData['eFeatured'] = "";
            }
            $dataarray = array();
            if(!empty($rent_item_payment_plan)){
                $dataarray['vPlanName'] = $rent_item_payment_plan[0]['vPlanName'];
                $dataarray['iPaymentPlanId'] = $rent_item_payment_plan[0]['iPaymentPlanId'];
                if($rent_item_payment_plan[0]['fAmount'] == "0.00"){
                    $dataarray['fAmount'] = "";
                }
                else {
                    $dataarray['fAmount'] = formateNumAsPerCurrency($rent_item_payment_plan[0]['fAmount'] * $currency[0]['ratio'], $userData[0]['vCurrencyPassenger']);
                }
            }
            $allData['RentItemPlanData'] = $dataarray;
            $allData['fAmount'] = formateNumAsPerCurrency($value['fAmount'] * $currency[0]['ratio'], $userData[0]['vCurrencyPassenger']);
            $allData['fAmountWithoutSymbol'] = setTwoDecimalPoint($value['fAmount'] * $currency[0]['ratio']);
            $date_now = new DateTime();
            if($value['eStatus'] == 'Pending'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_PENDING']);
            }
            else if($value['eStatus'] == 'Approved'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_APPROVED']);
            }
            else if($value['eStatus'] == 'Expired'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_EXPIRED']);
            }
            else if($value['eStatus'] == 'Deleted'){
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_DELETED']);
            }
            else {
                $eStatus = addslashes($languageLabelsArr['LBL_RENT_REJECT']);
            }
            $allData['eStatus'] = $eStatus;
            $allData['eStatusOrg'] = $value['eStatus'];
            if($value['eStatus'] == 'Deleted'){
                $allData['vRejectReason'] = $value['vDeletedReason'];
            }
            else {
                $allData['vRejectReason'] = $value['vRejectReason'];
            }
            $allData['dRentItemPostDate'] = $value['dRentItemPostDate'];
            $allData['dApprovedDate'] = $value['dApprovedDate'];
            $allData['dRenewDate'] = $value['dRenewDate'];
            if($value['dRentItemPostDate'] != "0000-00-00 00:00:00"){
                $date_data_array = array('tdate' => date("Y-m-d", strtotime($value['dRentItemPostDate'])), 'langCode' => $vLanguage);
                $getdRentItemPostDate = DateformatCls::getNewDateFormat($date_data_array);
                if(count($PostUserData)> 0 && isset($getdRentItemPostDate)){
                    $allData['PostedTxt'] = $languageLabelsArr['LBL_RENT_POSTED_BY']. " " . clearName($PostUserData[0]['vName'] . ' ' . $PostUserData[0]['vLastName']). ", " .$getdRentItemPostDate['tDisplayDate'];
                }
                else {
                    $allData['PostedTxt'] = $languageLabelsArr['LBL_RENT_POSTED_BY']. " , " .$getdRentItemPostDate['tDisplayDate'];
                }
            }
            else {
                if(count($PostUserData)> 0 && isset($getdRentItemPostDate)){
                    $allData['PostedTxt'] = $languageLabelsArr['LBL_RENT_POSTED_BY']. " " . clearName($PostUserData[0]['vName'] . ' ' . $PostUserData[0]['vLastName']). ", " . date_format(date_create($value['dRentItemPostDate']), "d F, Y");
                }
                else {
                    $allData['PostedTxt'] = $languageLabelsArr['LBL_RENT_POSTED_BY']. " , " .$getdRentItemPostDate['tDisplayDate'];
                }
            }
            $allData['eRentItemDuration'] = $value['eRentItemDuration'];
            $addday = '+ 1 ' . strtolower($value['eRentItemDuration']);
            if($value['dRenewDate'] != "0000-00-00 00:00:00"){
                $date_data_array_drenew = array('tdate' => date("Y-m-d", strtotime($value['dRenewDate'])), 'langCode' => $vLanguage);
                $getdRentItemRenewDate = DateformatCls::getNewDateFormat($date_data_array_drenew);
                $displayDate = $getdRentItemRenewDate['tDisplayDate'];
                $NewDate = Date('Y-m-d h:i:s', strtotime($value['dRenewDate']));
            }
            else {
                $NewDate = Date('Y-m-d h:i:s', strtotime($value['dRenewDate']));
                $displayDate = date_format(date_create($NewDate), "d F, Y");
            }
            $allData['eRentItemDurationDate'] = isset($NewDate)? $NewDate : '';
            $date_now = new DateTime();
            if(!empty($NewDate)){
                $date2 = new DateTime($NewDate);
            }
            else {
                $date2 = '';
            }
            if($value['eStatus'] == 'Pending' && !empty($date2)){
                $allData['eRentItemDurationDateTxt'] = $languageLabelsArr['LBL_RENT_ITEM_WAITING_APPROVAL'];
            }
            elseif($value['eStatus'] == 'Approved' && !empty($date2)){
                if($date2 >= $date_now){
                    $allData['eRentItemDurationDateTxt'] = addslashes($languageLabelsArr['LBL_VALID_TILL_TXT']). " " . $displayDate;
                }
                else {
                    $allData['eRentItemDurationDateTxt'] = addslashes($languageLabelsArr['LBL_EXPIRED_TXT']);
                }
            }
            else if($value['eStatus'] == 'Deleted' && $value['eDeletedBy'] == "Admin"){
                $allData['eRentItemDurationDateTxt'] = $languageLabelsArr['LBL_RENT_DELETED_BY_ADMIN'] ?? 'Deleted By Admin';
            }
            elseif($value['eStatus'] == 'Approved' && empty($date2)){
                $allData['eRentItemDurationDateTxt'] = addslashes($languageLabelsArr['LBL_APPROVED_TXT']);
            }
            else {
                $allData['eRentItemDurationDateTxt'] = "";
            }
            $imgIds = explode(",", $value['vImageIds']);
            $getImages = $this->getRentItemImage("webservice", $value['iItemCategoryId'], $value['iUserId'], $vLanguage, $imgIds);
            $imagesarr = array();
            if(!empty($getImages)){
                foreach($getImages as $k => $val){
                    $imagesarr[$k]['iRentImageId'] = $val['iRentImageId'];
                    $imagesarr[$k]['vImage'] = $val['vImage'];
                    $imagesarr[$k]['eFileType'] = $val['eFileType'];
                    $imagesarr[$k]['ThumbImage'] = $val['ThumbImage'];
                }
            }
            else {
                $imagesarr[0]['iRentImageId'] = "";
                $imagesarr[0]['vImage'] = "";
                $imagesarr[0]['eFileType'] = "";
                $imagesarr[0]['ThumbImage'] = "";
            }
            $allData['Images'] = $imagesarr;
            $rentitemFieldarray = $itemname = array();
            $tFieldsArr = json_decode($value['tFieldsArr'], true);
            $tFields_Details_Arr = [];
            if(isset($tFieldsArr)&& !empty($tFieldsArr)&& is_array($tFieldsArr)){
                foreach($tFieldsArr as $k => $arryfields){
                    if(is_array($arryfields)){
                        $tFields_Details_Arr[0][$arryfields['iData']] = $arryfields['value'];
                    }
                }
            }
            if(isset($tFields_Details_Arr)&& !empty($tFields_Details_Arr)){
                foreach($tFields_Details_Arr as $k => $arryfields){
                    foreach($arryfields as $iRentFieldId => $value1){
                        $getRentItemFields = $this->getRentItemFields("webservice",$iRentFieldId,"","",$vLanguage);
                        if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eTitle'] == 'Yes'){
                            $rentitemFieldarray[$iRentFieldId]['eName'] = 'Yes';
                            $itemname[] = $value1;
                            $allData['vItemName'] = $value1;
                        }
                        if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eDescription'] == 'Yes'){
                            $rentitemFieldarray[$iRentFieldId]['eDescription'] = 'Yes';
                        }
                        if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eListing'] == 'Yes' && $getRentItemFields[0]['eInputType'] == 'Select'){
                            $sql = "SELECT iOptionId,vFieldName,iRentFieldId,eStatus,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tOptionNameLang_".$vLanguage."'))as tFieldName,eListingType FROM rent_item_fields_option WHERE iOptionId='".$value1."'";
                            $db_fields = $obj->MySQLSelect($sql);
                            $tFieldName = $db_fields[0]['tFieldName'];
                            $vFieldName = $db_fields[0]['vFieldName'];
                            $eListingTypeOptions = $db_fields[0]['eListingType'];
                            if($eListingTypeOptions == "Rent"){
                                $allData['isBuySell'] = "No";
                            }
                            else if($eListingTypeOptions == "Sale"){
                                $allData['isBuySell'] = "Yes";
                            }
                            $allData['eListingType'] = !empty($tFieldName)?$tFieldName:$vFieldName;
                            $allData['eListingTypeWeb'] = $vFieldName;
                        }
                        $rentitemFieldarray[$iRentFieldId]['iOrder'] = $getRentItemFields[0]['iOrder'];
                        $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $value1;
                        $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                        $rentitemFieldarray[$iRentFieldId]['vValue'] = $value1;
                        if($getRentItemFields[0]['vFieldName'] == "Make"){
                            $allData['vCarMake'] = $value1;
                        }
                        if($getRentItemFields[0]['vFieldName'] == "Model"){
                            $allData['vCarModel'] = $value1;
                        }
                        if($getRentItemFields[0]['eInputType'] == 'Select' && $iRentFieldId == $getRentItemFields[0]['iRentFieldId']){
                            $vFieldName = get_value('rent_item_fields_option','vFieldName','iOptionId',$value1,'','true');
                            $rentitemFieldarray[$iRentFieldId][$getRentItemFields[0]['tFieldName']] = $vFieldName;
                            if($getRentItemFields[0]['vFieldName'] == "Property Type"){
                                $allData['vPropertyTypeName'] = $vFieldName;
                            }
                            $rentitemFieldarray[$iRentFieldId]['vTitle'] = $getRentItemFields[0]['tFieldName'];
                            $rentitemFieldarray[$iRentFieldId]['vValue'] = $vFieldName;
                        }
                    }
                }
            }
            if(is_array($itemname)){
                $allData['vItemName'] = implode(" - ", $itemname);
            }
            $rentitemFieldarray = array_values($rentitemFieldarray);
            $key_values = array_column($rentitemFieldarray, 'iOrder');
            array_multisort($key_values, SORT_ASC, $rentitemFieldarray);
            $rentitemFieldarrayNew = array();
            $rentitemFieldarr = array();
            foreach($rentitemFieldarray as $key => $subArr){
                $vTitleNew = $subArr['vTitle'];
                $vValueNew = $subArr['vValue'];
                unset($subArr['vTitle']);
                unset($subArr['vValue']);
                unset($subArr['iOrder']);
                $rentitemFieldarrayNew[] = $subArr;
                $ADDArr['vTitle'] = $vTitleNew;
                $ADDArr['vValue'] = $vValueNew;
                if(isset($subArr['eName'])&& !empty($subArr['eName'])){
                    $ADDArr['eName'] = $subArr['eName'];
                }
                else {
                    unset($ADDArr['eName']);
                }
                if(isset($subArr['eDescription'])&& !empty($subArr['eDescription'])){
                    $ADDArr['eDescription'] = $subArr['eDescription'];
                }
                else {
                    unset($ADDArr['eDescription']);
                }
                $rentitemFieldarr[] = $ADDArr;
            }
            $allData['RentitemFieldarray'] = $rentitemFieldarrayNew;
            $allData['RentitemFieldArr'] = $rentitemFieldarr;
            $allData['tFieldsArr'] = isset($tFields_Details_Arr)&& !empty($tFields_Details_Arr)? array_values($tFields_Details_Arr[0]): [];
            $weekdayArray = array('Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday');
            $timeslot = array();
            if($value['eStatus'] == 'Approved' || $use == 'Web'){
                foreach($weekdayArray as $weekdayname){
                    if($weekdayname == 'Monday'){
                        if($value['vMonFromSlot'] != "00:00:00" && $value['vMonToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vMonFromSlot'])). ' - ' . date("h:i A", strtotime($value['vMonToSlot']));
                        }
                    }
                    else if($weekdayname == 'Tuesday'){
                        if($value['vTueFromSlot'] != "00:00:00" && $value['vTueToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vTueFromSlot'])). ' - ' . date("h:i A", strtotime($value['vTueToSlot']));
                        }
                    }
                    else if($weekdayname == 'Wednesday'){
                        if($value['vWedFromSlot'] != "00:00:00" && $value['vWedToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vWedFromSlot'])). ' - ' . date("h:i A", strtotime($value['vWedToSlot']));
                        }
                    }
                    else if($weekdayname == 'Thursday'){
                        if($value['vThuFromSlot'] != "00:00:00" && $value['vThuToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vThuFromSlot'])). ' - ' . date("h:i A", strtotime($value['vThuToSlot']));
                        }
                    }
                    else if($weekdayname == 'Friday'){
                        if($value['vFriFromSlot'] != "00:00:00" && $value['vFriToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vFriFromSlot'])). ' - ' . date("h:i A", strtotime($value['vFriToSlot']));
                        }
                    }
                    else if($weekdayname == 'Saturday'){
                        if($value['vSatFromSlot'] != "00:00:00" && $value['vSatToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSatFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSatToSlot']));
                        }
                    }
                    else if($weekdayname == 'Sunday'){
                        if($value['vSunFromSlot'] != "00:00:00" && $value['vSunToSlot'] != "00:00:00"){
                            $timeslot[][$weekdayname] = date("h:i A", strtotime($value['vSunFromSlot'])). ' - ' . date("h:i A", strtotime($value['vSunToSlot']));
                        }
                    }
                }
            }
            else {
                $timingArray = array('vMonFromSlot', 'vMonToSlot', 'vTueFromSlot', 'vTueToSlot', 'vWedFromSlot', 'vWedToSlot', 'vThuFromSlot', 'vThuToSlot', 'vFriFromSlot', 'vFriToSlot', 'vSatFromSlot', 'vSatToSlot', 'vSunFromSlot', 'vSunToSlot');
                $arrayKey = $tempCntr = 0;
                $timeslot = array();
                for($j = 0;
                $j < scount($timingArray);
                $j++){
                    if($value[$timingArray[$j]] != "00:00:00" && $value[$timingArray[$j + 1]] != "00:00:00"){
                        $newdateFromTime = date("h:i A", strtotime($value[$timingArray[$j]]));
                    }
                    else {
                        $newdateFromTime = $languageLabelsArr['LBL_From'];
                    }
                    $tempArry = array('dayname' => getDaynameBylabel($timingArray[$j]), 'field' => getDaynameBylabel($timingArray[$j], "field"), $timingArray[$j] => $newdateFromTime,);
                    $returnArr['timeslot'][$arrayKey][$tempCntr] = $tempArry;
                    $j++;
                    if($value[$timingArray[$j - 1]] != "00:00:00" && $value[$timingArray[$j]] != "00:00:00"){
                        $newdateToTime = date("h:i A", strtotime($value[$timingArray[$j]]));
                    }
                    else {
                        $newdateToTime = $languageLabelsArr['LBL_To'];
                    }
                    $returnArr['timeslot'][$arrayKey][$tempCntr][$timingArray[$j]] = $newdateToTime;
                    $timeslot[] = $returnArr['timeslot'][$arrayKey][$tempCntr];
                }
            }
            $allData['timeslot'] = $timeslot;
            $vBgColor = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR, 1)];
            $allData['typeBGColor'] = $vBgColor;
            if(isset($_REQUEST['type'])&& $_REQUEST['type'] != "GetRentPostForAllUser"){
                $allData['totalNum'] = $totalNum;
                $allData['TotalPages'] = $TotalPages;
            }
            $alldatanewArr[] = $allData;
        }
        $returnarray = [];
        if(scount($reqArr)> 0 && !empty($reqArr)){
            foreach($alldatanewArr as $key => $a){
                foreach($a as $k => $val){
                    if(in_array($k, $reqArr)){
                        $returnarray[$k] = $val;
                    }
                }
            }
            $alldatanewArr = $returnarray;
        }
        if(isset($_REQUEST['test'])){
        }
        return $alldatanewArr;
    }
    public function getRentItemPaymentPlan($use, $ssql = '', $start = 0, $per_page = 0, $vLanguage = "EN", $iRentItemPostId = "", $ord = '', $reqArr = []){
        global $obj,$LANG_OBJ;
        $limit = '';
        $eStatus = '';
        if($use == 'admin'){
            $limit = "LIMIT $start, $per_page";
            if($start == 0 && $per_page == 0){
                $limit = '';
            }
            if(empty($ssql)){
                $eStatus = 'AND(eStatus = "Active" || eStatus = "Inactive")';
            }
        }
        if($use == 'webservice'){
            $eStatus = 'AND eStatus = "Active"';
        }
        if(empty($ord)){
            $ord = " ORDER BY iPaymentPlanId";
        }
        $pSql = "";
        if(!empty($iRentItemPostId)){
            $iPaymentPlanId = get_value($this->rentitem_payment_log, 'iPaymentPlanId', 'iRentItemPostId', $iRentItemPostId, '', 'true');
            if($iPaymentPlanId != ""){
                $paymnetstring = "1," . $iPaymentPlanId;
            }
            else {
                $paymnetstring = "1";
            }
            $pSql = " AND iPaymentPlanId NOT IN(" . $paymnetstring . ")";
        }
        $sql = "SELECT iPaymentPlanId, vPlanName, iTotalDays,iTotalPost, fAmount, eStatus, JSON_UNQUOTE(JSON_VALUE(vPlanName, '$.vPlanName_" . $vLanguage . "'))as vPlanName, JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescription, eAvailability, eFreePlan FROM $this->PaymentPlanTableName WHERE 1 = 1 $pSql $eStatus $ssql $ord " . $limit . "";
        $rentitem_plan_master_categories = $obj->MySQLSelect($sql);
        foreach($rentitem_plan_master_categories as $key => $value){
            if(trim($value['tDescription'])== "" || $value['tDescription'] == null){
                $rentitem_plan_master_categories[$key]['tDescription'] = "";
            }
        }
        $return_array = array();
        $return_array = $rentitem_plan_master_categories;
        return $return_array;
    }
    function UpdateUserFavouriteRentPost($iMemberId, $iRentItemPostId, $eIsFavourite = "No"){
        global $obj;
        if(isset($iRentItemPostId)&& !empty($iRentItemPostId)){
            $where = " iRentItemPostId = '" . $iRentItemPostId . "'";
            $RentItemPostData['eIsFavourite'] = $eIsFavourite;
            $RentItemPostData1 = $obj->MySQLQueryPerform($this->rentitem_post, $RentItemPostData, 'update', $where);
            if($RentItemPostData1 == 1){
                $returnArr['Action'] = "1";
                $getRentItemPostData = $this->getRentItemPostFinal("webservice", "", $iMemberId, $vLanguage);
                $returnArr['message'] = $getRentItemPostData;
                if($eIsFavourite == 'Yes'){
                    $returnArr['message2'] = "LBL_RENT_ITEM_FAVOURITE_ADDED_SUCESSFULLY";
                }
                else {
                    $returnArr['message2'] = "LBL_RENT_ITEM_FAVOURITE_REMOVE_SUCESSFULLY";
                }
            }
            else {
                $returnArr['Action'] = 0;
                $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
            }
        }
        else {
            $returnArr['Action'] = 0;
            $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
        }
        setDataResponse($returnArr);
    }
    function createRentItemlog($use, $iRentItemPostId, $iMemberId = "", $vLanguage = "EN"){
        global $obj;
        $postlogarray = array();
        if($iRentItemPostId != ""){
            $getPostData = $this->getRentItemPostFinal("webservice", $iRentItemPostId, $iMemberId, $vLanguage);
            $postlogarray['iRentItemPostId'] = $getPostData[0]['iRentItemPostId'];
            $postlogarray['eStatus'] = $getPostData[0]['eStatusOrg'];
            $iRentItemPostLogId = $obj->MySQLQueryPerform($this->rent_item_post_status_log, $postlogarray, 'insert');
        }
        return $iRentItemPostLogId;
    }
    function createRentItemPaymentlog($use, $iPaymentPlanId, $iRentItemPostId, $iMemberId = "", $vLanguage = "EN"){
        global $obj;
        $postlogarray = array();
        $getRentItemPaymentPlanAmount = $this->getRentItemPlan("webservice", $iPaymentPlanId, $vLanguage);
        if(!empty($iPaymentPlanId)&& !empty($iMemberId)){
            $paymentlogData = $obj->MySQLSelect("SELECT * FROM $this->rentitem_payment_log WHERE iUserId = '" . $iMemberId . "' AND iPaymentPlanId = '" . $iPaymentPlanId . "' AND eStatus = 'Active' ORDER BY iUserPaymentPlanId DESC LIMIT 1");
            if(!empty($paymentlogData)&& $paymentlogData[0]['iTotalPost'] > 0){
                $iTotalPost = $paymentlogData[0]['iTotalPost'];
            }
            else {
                $iTotalPost = $getRentItemPaymentPlanAmount['iTotalPost'];
            }
        }
        else {
            $iTotalPost = $getRentItemPaymentPlanAmount['iTotalPost'];
        }
        $SelectpaymentlogData = $obj->MySQLSelect("SELECT * FROM $this->rentitem_payment_log WHERE iUserId = '" . $iMemberId . "' AND iRentItemPostId = '" . $iRentItemPostId . "'");
        $postlogarray['iUserId'] = $iMemberId;
        $postlogarray['tPlanPurchaseDay'] = date('Y-m-d H:i:s');
        $postlogarray['iRentItemPostId'] = $iRentItemPostId;
        $postlogarray['iPaymentPlanId'] = $iPaymentPlanId;
        $postlogarray['eStatus'] = 'Active';
        $postlogarray['iTotalDays'] = $getRentItemPaymentPlanAmount['iTotalDays'];
        if($iTotalPost > 0){
            $postlogarray['iTotalPost'] = $iTotalPost - 1;
        }
        else {
            $postlogarray['iTotalPost'] = $iTotalPost;
        }
        $iRentItemPaymentLogId = $obj->MySQLQueryPerform($this->rentitem_payment_log, $postlogarray, 'insert');
        return $iRentItemPaymentLogId;
    }
    public function getRentItemPlan($use, $iPaymentPlanId, $vLanguage = "EN", $reqArr = []){
        global $obj;
        $sql = '';
        $iPaymentPlanId = explode(',', $iPaymentPlanId);
        if(scount($iPaymentPlanId)> 1){
            $sql .= " iPaymentPlanId IN(" . $iPaymentPlanId . ")";
        }
        else {
            $sql .= "iPaymentPlanId = '" . $iPaymentPlanId[0] . "'";
        }
        $rentitem_plan_master_categories = $obj->MySQLSelect("SELECT iPaymentPlanId, vPlanName,tDescription, iTotalDays, iTotalPost, fAmount, eStatus, JSON_UNQUOTE(JSON_VALUE(vPlanName, '$.vPlanName_" . $vLanguage . "'))as vPlanNameDefault, JSON_UNQUOTE(JSON_VALUE(tDescription, '$.tDescription_" . $vLanguage . "'))as tDescriptionDefault, eFreePlan, eFeaturedPlan, eAvailability,iMasterServiceCategoryId FROM $this->PaymentPlanTableName WHERE 1 = 1 AND $sql");
        $return_array = array();
        $return_array = $rentitem_plan_master_categories;
        return $return_array[0];
    }
    function createItemInquirylog($use, $reqArr = [], $vLanguage = "EN"){
        global $obj;
        if($reqArr != ""){
            $postlogarray = $reqArr;
            $iRentItemPostLogId = $obj->MySQLQueryPerform($this->rent_item_sendquery_log, $postlogarray, 'insert');
        }
        return $iRentItemPostLogId;
    }
    public function getRentItemMasterData($column, $field){
        global $obj, $master_service_category_tbl, $oCache;
        $RentItemMasterApcKey = md5('RENT_ITEM_MASTER');
        $getRentItemMasterCacheData = $oCache->getData($RentItemMasterApcKey);
        if(!empty($getRentItemMasterCacheData)&& scount($getRentItemMasterCacheData)> 0){
            $rent_item_master = $getRentItemMasterCacheData;
        }
        else {
            $rent_item_master = $obj->MySQLSelect("SELECT iMasterServiceCategoryId, eType FROM $master_service_category_tbl WHERE eType IN('RentItem', 'RentCars', 'RentEstate')");
            $oCache->setData($RentItemMasterApcKey, $rent_item_master);
        }
        $master_data = array();
        if($field == "eType"){
            foreach($rent_item_master as $master_service){
                $master_data[$master_service['iMasterServiceCategoryId']] = $master_service['eType'];
            }
        }
        else {
            foreach($rent_item_master as $master_service){
                $master_data[$master_service['eType']] = $master_service['iMasterServiceCategoryId'];
            }
        }
        return $master_data[$column];
    }
    public function getServiceCategoriesPro($iUserId){
        global $obj, $tconfig, $LANG_OBJ, $MODULES_OBJ, $master_service_category_tbl;
        $userData = $obj->MySQLSelect("SELECT vName, vLastName, vLang FROM `register_user` WHERE iUserId = '$iUserId' ");
        $lang = $userData[0]['vLang'];
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $lang . "'))as vCategoryName, JSON_UNQUOTE(JSON_VALUE(vCategoryDesc, '$.vCategoryDesc_" . $lang . "'))as vCategoryDesc FROM $master_service_category_tbl WHERE eType IN('RentItem', 'RentEstate', 'RentCars')AND eStatus = 'Active' ORDER BY iDisplayOrder");
        $MASTER_SERVICE_CATEGORIES = array();
        $whereloc = " AND iLocationid IN('-1')";
        if($MODULES_OBJ->isEnableLocationwiseBanner()){
            $vLatitude = isset($_REQUEST["vLatitude"])? $_REQUEST["vLatitude"] : '';
            $vLongitude = isset($_REQUEST["vLongitude"])? $_REQUEST["vLongitude"] : '';
            $User_Address_Banner = array($vLatitude, $vLongitude);
            if(!empty($User_Address_Banner)){
                $iLocationIdBanner = GetUserGeoLocationIdBanner($User_Address_Banner);
                $country_str_banner = "'-1'";
                if(scount($iLocationIdBanner)> 0){
                    foreach($iLocationIdBanner as $key => $value){
                        $country_str_banner .= ", '" . $value . "'";
                    }
                    $whereloc = " AND iLocationid IN(" . $country_str_banner . ")";
                }
            }
        }
        $Data_banners = $obj->MySQLSelect("SELECT vImage,vStatusBarColor,iUniqueId FROM banners WHERE vCode= '" . $lang . "' AND vImage != '' AND eStatus = 'Active' AND(iServiceId = '0' OR iServiceId = '')AND eBuyAnyService NOT IN('Genie', 'Runner')AND eType = 'General' $whereloc ORDER BY iDisplayOrder ASC");
        $dataOfBanners = array();
        $count = 0;
        for($i = 0;
        $i < scount($Data_banners);
        $i++){
            if(isset($Data_banners[$i]['vImage'])&& $Data_banners[$i]['vImage'] != ""){
                $dataOfBanners[$count]['vImage'] = $tconfig["tsite_url"] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $banner_img_path = $tconfig['tpanel_path'] . 'assets/img/images/' . $Data_banners[$i]['vImage'];
                $imagedata = getimagesize($banner_img_path);
                $dataOfBanners[$count]['vImageWidth'] = strval($imagedata[0]);
                $dataOfBanners[$count]['vImageHeight'] = strval($imagedata[1]);
                $dataOfBanners[$count]['isClickable'] = "No";
                $count++;
            }
        }
        $mServiceCategoryArr = array();
        $mServiceCategoryArr['eViewType'] = "BannerView";
        $mServiceCategoryArr['isScroll'] = "Yes";
        $mServiceCategoryArr['displayCount'] = "1";
        $mServiceCategoryArr['AddTopPadding'] = "No";
        $mServiceCategoryArr['AddBottomPadding'] = "No";
        $mServiceCategoryArr['isFullView'] = "No";
        $mServiceCategoryArr['vImageWidth'] = $dataOfBanners[0]['vImageWidth'];
        $mServiceCategoryArr['vImageHeight'] = $dataOfBanners[0]['vImageHeight'];
        $mServiceCategoryArr['imagesArr'] = $dataOfBanners;
        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
        $MasterCategoryArr = array();
        foreach($master_service_categories as $master_category){
            $categoryArr = array('vCategoryName' => $master_category['vCategoryName'], 'eType' => $master_category['eType']);
            if($master_category['eType'] == "RentEstate"){
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_RENT_PROPERTY_LISTING'];
            }
            elseif($master_category['eType'] == "RentCars"){
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_RENT_CARS_LISTING'];
            }
            else {
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_RENT_GENERAL_ITEM_LISTING'];
            }
            $MasterCategoryArr[] = $categoryArr;
        }
        $mServiceCategoryArr = array();
        $mServiceCategoryArr['eViewType'] = "NewListingView";
        $mServiceCategoryArr['vTitle'] = $languageLabelsArr['LBL_RENT_SELL_ITEM_TXT'];
        $mServiceCategoryArr['BtnText'] = $languageLabelsArr['LBL_RENT_ADD_NEW_LISTING_TXT'];
        $mServiceCategoryArr['servicesArr'] = $MasterCategoryArr;
        $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
        foreach($master_service_categories as $master_category){
            $mServiceCategoryArr = array();
            $mServiceCategoryArr['eViewType'] = "BannerView";
            $mServiceCategoryArr['isScroll'] = "No";
            $mServiceCategoryArr['displayCount'] = "1";
            $mServiceCategoryArr['isFullView'] = "No";
            $mServiceCategoryArr['isOnlyImage'] = "No";
            $mServiceCategoryArr['AddTopPadding'] = "Yes";
            $mServiceCategoryArr['AddBottomPadding'] = "No";
            $mServiceCategoryArr['eCatType'] = $master_category['eType'];
            $mServiceCategoryArr['imagesArr'] = array();
            $vImageBuySellRent = "";
            if(!empty($master_category['vIconImage1'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $master_category['vIconImage1'])){
                $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $master_category['vIconImage1']);
                $mServiceCategoryArr['vImageWidth'] = strval($imagedata[0]);
                $mServiceCategoryArr['vImageHeight'] = strval($imagedata[1]);
                $mServiceCategoryArr['isClickable'] = "Yes";
                $vImageBuySellRent = $tconfig["tsite_upload_app_home_screen_images"] . $master_category['vIconImage1'];
            }
            $msql = " AND iMasterServiceCategoryId = " . $master_category['iMasterServiceCategoryId'];
            $BuySellRentServicesArr = $this->getRentItemMaster('webservice', $msql, '', '', $lang);
            $BuySellRentServicesArrNew = array();
            $BuySellRentServicesArrNew[] = $BuySellRentServicesArr[0];
            $BuySellRentServicesArr = $BuySellRentServicesArrNew;
            $BuySellRentImgArr = array('vCategoryName' => $master_category['vCategoryName'], 'vCategoryTitle' => $master_category['vCategoryName'], 'vCategory' => $master_category['vCategoryName'], 'vImage' => $vImageBuySellRent, 'vTextColor' => $master_category['vTextColor'], 'vBgColor' => $master_category['vBgColor'], 'isClickable' => 'Yes', 'servicesArr' => $BuySellRentServicesArrNew);
            if($master_category['eType'] == "RentEstate"){
                $BuySellRentImgArr['PromotionalTagText'] = $languageLabelsArr['LBL_PROMOTIONAL_CATEGORY_TAG_1'];
                $BuySellRentImgArr['rentestateSection'] = 'Yes';
            }
            elseif($master_category['eType'] == "RentCars"){
                $BuySellRentImgArr['rentcarSection'] = 'Yes';
            }
            else {
                $BuySellRentImgArr['rentitemSection'] = 'Yes';
            }
            $mServiceCategoryArr['imagesArr'][] = $BuySellRentImgArr;
            $MASTER_SERVICE_CATEGORIES[] = $mServiceCategoryArr;
        }
        $returnArr['Action'] = "1";
        $returnArr['HOME_SCREEN_DATA'] = $MASTER_SERVICE_CATEGORIES;
        setDataResponse($returnArr);
    }
    public function getFilterPriority($use,$iUserId,$iCategoryId = "",$iRentItemPostId="",$eType="",$vLanguage = ""){
        global $obj,$master_service_category_tbl;
        $where = "";
        if(!empty($iUserId)){
            $where .= " AND rp.iUserId ='" . $iUserId . "'";
        }
        if(!empty($iCategoryId)){
            $where .= " AND rp.iItemCategoryId = '" . $iCategoryId . "'";
        }
        if(!empty($iRentItemPostId)){
            $where .= " AND rp.iRentItemPostId ='" . $iRentItemPostId . "'";
        }
        if($use != "Web"){
            $where .= " AND((rp.eStatus != 'Deleted')OR(rp.eStatus = 'Deleted' AND rp.eDeletedBy = 'Admin'))";
        }
        $msql = "";
        if(!empty($eType)){
            $iMasterServiceCategoryId = $this->getRentItemMasterData($eType, 'iMasterServiceCategoryId');
            if(!empty($iMasterServiceCategoryId)){
                $msql = " AND rc.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
            }
            $sql = "SELECT count(iRentItemPostId)as count FROM $this->rentitem_post as rp LEFT JOIN rent_items_category as rc on rc.iRentItemId =rp.iItemCategoryId WHERE 1 = 1 $where $msql ORDER BY rp.dRentItemPostDate";
            $TotalPostData = $obj->MySQLSelect($sql);
            $inprocessCount = $TotalPostData[0]['count'];
            if($inprocessCount > 0){
                $filter = $eType;
                $res['filter'] = $filter;
                return $res;
            }
        }
        else {
            $master_service_categoriesArray = array('RentEstate','RentCars','RentItem');
            foreach($master_service_categoriesArray as $k => $val){
                $iMasterServiceCategoryId = $this->getRentItemMasterData($val, 'iMasterServiceCategoryId');
                if(!empty($iMasterServiceCategoryId)){
                    $msql = " AND rc.iMasterServiceCategoryId='" . $iMasterServiceCategoryId . "'";
                }
                $sql = "SELECT count(iRentItemPostId)as count FROM $this->rentitem_post as rp LEFT JOIN rent_items_category as rc on rc.iRentItemId =rp.iItemCategoryId WHERE 1 = 1 $where $msql ORDER BY rp.dRentItemPostDate";
                $TotalPostData = $obj->MySQLSelect($sql);
                $inprocessCount = $TotalPostData[0]['count'];
                if($inprocessCount > 0){
                    $filter = $val;
                    $res['filter'] = $filter;
                    return $res;
                }
            }
        }
    }
    public function GetMasterCategoriesData($vLanguage){
        global $obj,$master_service_category_tbl,$LANG_OBJ;
        if($vLanguage == "" || $vLanguage == NULL){
            $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1", "");
        $master_service_categories = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $vLanguage . "'))as vCategoryName, JSON_UNQUOTE(JSON_VALUE(vCategoryDesc, '$.vCategoryDesc_" . $vLanguage . "'))as vCategoryDesc FROM $master_service_category_tbl WHERE eType IN('RentItem', 'RentEstate', 'RentCars')AND eStatus = 'Active' ORDER BY iDisplayOrder");
        $MasterCategoryArr = array();
        foreach($master_service_categories as $master_category){
            $categoryArr = array('vCategoryName' => $master_category['vCategoryName'], 'eType' => $master_category['eType']);
            if($master_category['eType'] == "RentEstate"){
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_PROPERTIES'];
            }
            elseif($master_category['eType'] == "RentCars"){
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_RENT_CARS_FILTER_TXT'];
            }
            else {
                $categoryArr['ListingsTitle'] = $languageLabelsArr['LBL_RENT_GENERAL_ITEM_FILTER_TXT'];
            }
            $MasterCategoryArr[] = $categoryArr;
        }
        return $MasterCategoryArr;
    }
    public function WebCommonParam(){
        global $obj;
        $iUserId = $_SESSION['sess_iUserId'];
        $lang = $_SESSION['sess_lang'];
        $userData = $obj->MySQLSelect("SELECT vTimeZone FROM register_user as ru WHERE ru.iUserId = '" . $iUserId . "' ");
        $_REQUEST["GeneralMemberId"] = $iUserId;
        $_REQUEST["vGeneralLang"] = $lang;
        $_REQUEST["vTimeZone"] = $userData[0]['vTimeZone'];
        $_REQUEST["SYSTEM_TYPE"] = "WEB";
        if(empty($_REQUEST["vTimeZone"])){
            $_REQUEST["vTimeZone"] = date_default_timezone_get();
        }
    }
    public function getFieldsDataArray($tFieldsArr,$iRentItemPostId,$vLanguage='EN'){
        global $obj;
        $tFieldsArr = array_filter(json_decode($tFieldsArr, true));
        $tFields_Details_Arr = $getRentItemPostData = [];
        foreach($tFieldsArr as $k => $arryfields){
            $tFields_Details_Arr[0][$arryfields['iData']] = $arryfields['value'];
        }
        foreach($tFields_Details_Arr as $k => $arryfields){
            foreach($arryfields as $iRentFieldId => $value1){
                $sql = "SELECT iRentFieldId,vFieldName,iRentItemId,eInputType,eAllowFloat,eRequired,eEditable,iOrder,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tFieldName_" . $vLanguage . "'))as tFieldName,JSON_UNQUOTE(JSON_VALUE(tDesc, '$.tDesc_" . $vLanguage . "'))as tDesc,eStatus,eDescription,eTitle,eListing from rentitem_fields where iRentFieldId='" . $iRentFieldId . "' order by iOrder ASC";
                $getRentItemFields = $obj->MySQLSelect($sql);
                if(!empty($getRentItemFields[0]['iRentFieldId'])){
                    if($iRentFieldId == $getRentItemFields[0]['iRentFieldId'] && $getRentItemFields[0]['eListing'] == 'Yes' && $getRentItemFields[0]['eInputType'] == 'Select'){
                        $sql = "SELECT iOptionId,vFieldName,iRentFieldId,eStatus,JSON_UNQUOTE(JSON_VALUE(tFieldName, '$.tOptionNameLang_" . $vLanguage . "'))as tFieldName,eListingType FROM rent_item_fields_option WHERE iOptionId='" . $value1 . "'";
                        $db_fields = $obj->MySQLSelect($sql);
                        $vFieldName = $db_fields[0]['vFieldName'];
                        $eListingTypeOptions = $db_fields[0]['eListingType'];
                        $getRentItemPostData[$iRentItemPostId]['eListingTypeWeb'] = $vFieldName;
                    }
                }
            }
        }
        return $getRentItemPostData;
    }
}
class RideShare {
    public $isOnlyEnableRideSharingPro,$BookingFeeCheckInWallet;
    function __construct(){
        global $MODULES_OBJ;
        $this->isOnlyEnableRideSharingPro = true;
        $dStartDate = isset($_REQUEST['dStartDate'])?$_REQUEST['dStartDate']:'';
        if(!empty($_REQUEST['dStartDate'])){
            $_REQUEST['dStartDate'] = preg_replace('/\([^)]*\)/','',$dStartDate);
        }
        $this->BookingFeeCheckInWallet = "ACCEPT_BOOKING_TIME";
    }
    public function getCategories($tCategoryDetails = array()){
        global $languageLabelsArr,$tconfig,$obj,$master_service_category_tbl;
        if(empty($tCategoryDetails)){
            $service_details = $obj->MySQLSelect("SELECT tCategoryDetails FROM $master_service_category_tbl WHERE eType = 'RideShare' ");
            $tCategoryDetails = json_decode($service_details[0]['tCategoryDetails'],true);
        }
        $vImageRideSharePublish = "";
        if(!empty($tCategoryDetails['RideSharePublish']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideSharePublish']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideSharePublish']['vImage']);
            $vImageWidthRideSharePublish = strval($imagedata[0]);
            $vImageHeightRideSharePublish = strval($imagedata[1]);
            $vImageRideSharePublish = $tconfig["tsite_upload_app_home_screen_images"].$tCategoryDetails['RideSharePublish']['vImage'];
        }
        $vImageRideShareBook = "";
        if(!empty($tCategoryDetails['RideShareBook']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideShareBook']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideShareBook']['vImage']);
            $vImageWidthRideShareBook = strval($imagedata[0]);
            $vImageHeightRideShareBook = strval($imagedata[1]);
            $vImageRideShareBook = $tconfig["tsite_upload_app_home_screen_images"].$tCategoryDetails['RideShareBook']['vImage'];
        }
        $vImageRideShareMyRides = "";
        if(!empty($tCategoryDetails['RideShareMyRides']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideShareMyRides']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"].$tCategoryDetails['RideShareMyRides']['vImage']);
            $vImageWidthRideShareMyRides = strval($imagedata[0]);
            $vImageHeightRideShareMyRides = strval($imagedata[1]);
            $vImageRideShareMyRides = $tconfig["tsite_upload_app_home_screen_images"].$tCategoryDetails['RideShareMyRides']['vImage'];
        }
        $category_arr = array(array('vCategory' => $languageLabelsArr['LBL_RIDE_SHARE_PUBLISH_TXT'], 'vImage' => $vImageRideSharePublish, 'vListLogo' => $vImageRideSharePublish, 'vImageWidth' => $vImageWidthRideSharePublish, 'vImageHeight' => $vImageHeightRideSharePublish, 'eCatType' => 'RideSharePublish', 'isRoundImage' => 'Yes'), array('vCategory' => $languageLabelsArr['LBL_RIDE_SHARE_BOOK_TXT'], 'vImage' => $vImageRideShareBook, 'vListLogo' => $vImageRideShareBook, 'vImageWidth' => $vImageWidthRideShareBook, 'vImageHeight' => $vImageHeightRideShareBook, 'eCatType' => 'RideShareBook', 'isRoundImage' => 'Yes'), array('vCategory' => $languageLabelsArr['LBL_RIDE_SHARE_MY_RIDES_TXT'], 'vImage' => $vImageRideShareMyRides, 'vListLogo' => $vImageRideShareMyRides, 'vImageWidth' => $vImageWidthRideShareMyRides, 'vImageHeight' => $vImageHeightRideShareMyRides, 'eCatType' => 'RideShareMyRides', 'isRoundImage' => 'Yes'));
        return $category_arr;
    }
    public function getDriverDetailsFields($iPublishedRideId = 0,$vLang = '',$getData = "No"){
        global $obj,$LANG_OBJ;
        if($getData == "No"){
            $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
            $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
            $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        }
        $userData = $obj->MySQLSelect("SELECT vPhone, vName, vLastName FROM register_user WHERE iUserId = '$iUserId' ");
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $tDriverDetails = [];
        if(isset($iPublishedRideId)&& !empty($iPublishedRideId)){
            $sql = "SELECT pr.tDriverDetails FROM published_rides as pr WHERE pr.iPublishedRideId = '".$iPublishedRideId."'";
            $data = $obj->MySQLSelect($sql);
            $tDriverDetails = json_decode($data[0]['tDriverDetails'],true);
            $tDriver_Details = [];
            foreach($tDriverDetails as $Details){
                $tDriver_Details[$Details['iData']] = $Details['value'];
            }
        }
        $fields = $obj->MySQLSelect("SELECT *, JSON_UNQUOTE(JSON_EXTRACT(tFieldName, '$.tFieldName_".$vLang."'))as tFieldName FROM ride_share_driver_fields WHERE eStatus = 'Active' ");
        $i = 0;
        foreach($fields as $field){
            if(isset($tDriver_Details)&& !empty($tDriver_Details)){
                $fields[$i]['value'] = $tDriver_Details[$field['iFieldId']];
            }
            else {
                if($field['eFor'] == "Name"){
                    $fields[$i]['value'] = $userData[0]['vName'].' '.$userData[0]['vLastName'];
                }
                elseif($field['eFor'] == "Phone"){
                    $fields[$i]['value'] = $userData[0]['vPhone'];
                }
            }
            $i++;
        }
        if($getData == "Yes"){
            return $fields;
        }
        $returnArr['Action'] = '1';
        $returnArr['message'] = $fields;
        setDataResponse($returnArr);
    }
    public function getVerificationDocuments(){
        global $obj,$LANG_OBJ,$tconfig,$ONLY_ENABLE_RIDE_SHARING_PRO,$ENABLE_24_HOUR_FORMAT;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $tEndLat = isset($_REQUEST["tEndLat"])?$_REQUEST["tEndLat"]:'';
        $tEndLong = isset($_REQUEST["tEndLong"])?$_REQUEST["tEndLong"]:'';
        $dStartDate = isset($_REQUEST["dStartDate"])?$_REQUEST["dStartDate"]:'';
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $SYSTEM_TYPE = isset($_REQUEST["SYSTEM_TYPE"])?$_REQUEST["SYSTEM_TYPE"]:'';
        $tSAddress = isset($_REQUEST["tSAddress"])?$_REQUEST["tSAddress"]:'';
        $tDAddress = isset($_REQUEST["tDAddress"])?$_REQUEST["tDAddress"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $serverTimeZone = date_default_timezone_get();
        $PointRecommendedPrice = isset($_REQUEST["PointRecommendedPrice"])?$_REQUEST["PointRecommendedPrice"]:'';
        $fPrice = isset($_REQUEST["fPrice"])?$_REQUEST["fPrice"]:'';
        if(isset($PointRecommendedPrice)&& !empty($PointRecommendedPrice)&& $this->isOnlyEnableRideSharingPro){
            $TYPE_FUNCTION = "getVerificationDocuments";
            $waypointData = $this->getWayPointsWithOtherDataForDisplay($PointRecommendedPrice,$TYPE_FUNCTION);
            $WayPoints = $waypointData['wayPoint'];
            $returnArr['waypointFare'] = $waypointData['WayPointPrice'];
            $returnArr['SourceLocationPoint'] = $waypointData['SourceLocationPoint'];
            $returnArr['DestLocationPoint'] = $waypointData['DestLocationPoint'];
            if(isset($WayPoints)&& !empty($WayPoints)){
                $endWayPoint = end($WayPoints);
                $tStartLat = $endWayPoint['lat'];
                $tStartLong = $endWayPoint['long'];
                $endWPDate = $endWayPoint['WPDate'];
            }
        }
        $UserData = get_value('register_user','vCountry,vLang','iUserId',$iUserId);
        $vCountry = $UserData[0]['vCountry'];
        $vLang = $UserData[0]['vLang'];
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $StartCity = $EndCity = "";
        $StartAddress = $tSAddress;
        $tStartLocation = getLocationNameLatLog($tStartLat,$tStartLong,'No');
        $tStartLocation = json_decode($tStartLocation,true);
        if(!empty($tStartLocation)){
            $address_components = $tStartLocation['results'][0]['address_components'];
            foreach($address_components as $addr){
                if($addr['types'][0] == "locality"){
                    $StartCity = $addr['long_name'];
                }
                elseif($addr['types'][0] == "administrative_area_level_3"){
                    $StartCity = $addr['long_name'];
                }
            }
            if(empty($tSAddress)){
                $StartAddress = $tStartLocation['results'][0]['formatted_address'];
            }
        }
        $EndAddress = $tDAddress;
        $tEndLocation = getLocationNameLatLog($tEndLat,$tEndLong,'No');
        $tEndLocation = json_decode($tEndLocation,true);
        if(!empty($tEndLocation)){
            $address_components = $tEndLocation['results'][0]['address_components'];
            foreach($address_components as $addr){
                if($addr['types'][0] == "locality"){
                    $EndCity = $addr['long_name'];
                }
                elseif($addr['types'][0] == "administrative_area_level_3"){
                    $EndCity = $addr['long_name'];
                }
            }
            if(empty($tDAddress)){
                $EndAddress = $tEndLocation['results'][0]['formatted_address'];
            }
        }
        $vLangCodeData = get_value('language_master','vCode, vGMapLangCode','eDefault','Yes');
        $vGMapLangCode = $vLangCodeData[0]['vGMapLangCode'];
        $requestDataArr = array();
        $requestDataArr['SOURCE_LATITUDE'] = $tStartLat;
        $requestDataArr['SOURCE_LONGITUDE'] = $tStartLong;
        $requestDataArr['DEST_LATITUDE'] = $tEndLat;
        $requestDataArr['DEST_LONGITUDE'] = $tEndLong;
        $requestDataArr['LANGUAGE_CODE'] = $vGMapLangCode;
        $direction_data = getPathInfoBetweenLocations($requestDataArr);
        $fDuration = $direction_data['duration'];
        $documents = $obj->MySQLSelect("SELECT rdl.ex_date,rdl.doc_file,rdl.doc_id,(SELECT CASE WHEN COUNT(*)> 0 THEN 'Yes' ELSE 'No' END as 'isUploaded' FROM `ride_share_document_list` WHERE doc_masterid = dm.doc_masterid AND doc_userid = {
            $iUserId
        })as isUploaded,dm.doc_masterid, dm.ex_status, dm.doc_name_$vLang as doc_name FROM document_master as dm LEFT JOIN ride_share_document_list rdl ON(rdl.doc_masterid = dm.doc_masterid AND doc_userid = {
            $iUserId
        })WHERE(dm.country='".$vCountry."' OR dm.country='All')and dm.doc_usertype = 'user' AND dm.status = 'Active' ORDER BY iDisplayOrder ASC ");
        $img_path = $tconfig["tsite_upload_ride_share_documents"];
        $Photo_Gallery_folder = $img_path.'/'.$iUserId.'/';
        if(!empty($documents)){
            $i = 0;
            foreach($documents as $document){
                if(empty($document['doc_id'])){
                    $documents[$i]['doc_id'] = '';
                }
                if(empty($document['ex_date'])){
                    $documents[$i]['ex_date'] = '';
                }
                else {
                    if($document['ex_date'] != "0000-00-00"){
                        $exdate_data_array = array('tdate' => converToTz($document['ex_date'],$vTimeZone,$serverTimeZone), 'langCode' => $vLang);
                        $getDocumentExDateFormat = DateformatCls::getNewDateFormat($exdate_data_array);
                        if(!empty($getDocumentExDateFormat)){
                            $documents[$i]['tDisplayDate'] = $getDocumentExDateFormat['tDisplayDate'];
                        }
                    }
                }
                if(empty($document['doc_file'])){
                    $documents[$i]['doc_file'] = '';
                }
                else {
                    $documents[$i]['doc_file'] = $Photo_Gallery_folder.$document['doc_file'];
                    $documents[$i]['is_doc'] = "No";
                    $doc_file_arr = explode(".",$document['doc_file']);
                    $doc_file_ext = strtolower($doc_file_arr[scount($doc_file_arr)- 1]);
                    $images_ext_arr = explode(",",$tconfig["tsite_upload_image_file_extensions"]);
                    if(!in_array($doc_file_ext,$images_ext_arr)){
                        $documents[$i]['is_doc'] = "Yes";
                    }
                }
                $i++;
            }
        }
        $returnArr['Action'] = '1';
        $returnArr['message'] = $documents;
        $returnArr['StartCity'] = $StartCity;
        $returnArr['EndCity'] = $EndCity;
        $returnArr['StartAddress'] = $StartAddress;
        if(isset($WayPoints)&& !empty($WayPoints)){
            $returnArr['waypoints'] = $WayPoints;
        }
        $returnArr['EndAddress'] = $EndAddress;
        $returnArr['StartDate'] = date('D d F',strtotime($dStartDate));
        $dStartdate_data_array = array('tdate' => converToTz($dStartDate,$vTimeZone,$serverTimeZone), 'langCode' => $vLang);
        $getdstartDateFormat = DateformatCls::getNewDateFormat($dStartdate_data_array);
        if(!empty($getdstartDateFormat)){
            foreach($getdstartDateFormat as $dstart_key => $dstart_value){
                $returnArr[$dstart_key] = $dstart_value;
            }
        }
        $returnArr['StartDate'] = date('D, jS M y',strtotime($dStartDate));
        $SD = $dStartDate;
        if(isset($endWPDate)&& !empty($endWPDate)){
            $SD = $endWPDate;
        }
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $returnArr['StartTime'] = date('H:i',strtotime($dStartDate));
            $returnArr['EndTime'] = date('H:i',strtotime($SD)+ $fDuration);
        }
        else {
            $returnArr['StartTime'] = date('h:i A',strtotime($dStartDate));
            $returnArr['EndTime'] = date('h:i A',strtotime($SD)+ $fDuration);
        }
        if($SYSTEM_TYPE == "WEB"){
            return $returnArr;
        }
        else {
            setDataResponse($returnArr);
        }
    }
    public function getWayPointsWithOtherDataForDisplay($PointRecommendedPrice,$TYPE_FUNCTION = ''){
        global $ENABLE_24_HOUR_FORMAT;
        $wayPoint = [];
        if($TYPE_FUNCTION == "getVerificationDocuments"){
            $dStartDate = isset($_REQUEST["dStartDate"])?$_REQUEST["dStartDate"]:'';
            $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
            $fPrice = isset($_REQUEST["fPrice"])?$_REQUEST["fPrice"]:'';
            $UserData = get_value('register_user','vCurrencyPassenger','iUserId',$iUserId);
            $vCurrencyPassenger = $UserData[0]['vCurrencyPassenger'];
            $ADD_WAYPOINTS_STARTDATE = $this->getWayPointStartEndTime($PointRecommendedPrice,$dStartDate)['PointRecommendedPrice'];
            $StartLetter = $letter = 'A';
        }
        if(!empty($PointRecommendedPrice)){
            $PointRecommendedPrice = json_decode($PointRecommendedPrice,true);
            $wayPointCount = 1;
            $totalCount = scount($PointRecommendedPrice);
            foreach($PointRecommendedPrice as $key => $point){
                if($TYPE_FUNCTION == "getVerificationDocuments"){
                    $l = $letter;
                    $letter = ord($letter)+ 1;
                    $letter1 = $letter = chr($letter);
                    $WayPointPrice[]['Location '.$l.' - '.$letter1] = formateNumAsPerCurrency($ADD_WAYPOINTS_STARTDATE[$key]['recommended_price'],$vCurrencyPassenger);
                }
                if($key == 0){
                    $arr = [];
                    $arr['address'] = $point['endPoint']['add'];
                    $arr['lat'] = $point['endPoint']['lat'];
                    $arr['long'] = $point['endPoint']['long'];
                    $arr['StartDate'] = $point['dStartDate'];
                    $arr['letterPoint'] = $point['letterPoint'];
                    if($TYPE_FUNCTION == "getVerificationDocuments"){
                        $arr['letterPoint'] = $letter1;
                    }
                    if($TYPE_FUNCTION == "getVerificationDocuments"){
                        $point['dEndDate'] = $ADD_WAYPOINTS_STARTDATE[$key]['EndDate'];
                    }
                    if(isset($point['dEndDate'])&& !empty($point['dEndDate'])){
                        if(strtoupper($ENABLE_24_HOUR_FORMAT)== "YES"){
                            $arr['WPDate'] = date('H:i',strtotime($point['dEndDate']));
                        }
                        else {
                            $arr['WPDate'] = date('h:i A',strtotime($point['dEndDate']));
                        }
                    }
                    $wayPoint[] = $arr;
                    $wayPointCount++;
                }
                else if($key ==($totalCount - 1)){
                }
                else {
                    $arr = [];
                    $arr['address'] = $point['endPoint']['add'];
                    $arr['lat'] = $point['endPoint']['lat'];
                    $arr['long'] = $point['endPoint']['long'];
                    $arr['StartDate'] = $point['dStartDate'];
                    $arr['letterPoint'] = $point['letterPoint'];
                    if($TYPE_FUNCTION == "getVerificationDocuments"){
                        $arr['letterPoint'] = $letter1;
                    }
                    if($TYPE_FUNCTION == "getVerificationDocuments"){
                        $point['dEndDate'] = $ADD_WAYPOINTS_STARTDATE[$key]['EndDate'];
                    }
                    if(isset($point['dEndDate'])&& !empty($point['dEndDate'])){
                        if(strtoupper($ENABLE_24_HOUR_FORMAT)== "YES"){
                            $arr['WPDate'] = date('H:i',strtotime($point['dEndDate']));
                        }
                        else {
                            $arr['WPDate'] = date('h:i A',strtotime($point['dEndDate']));
                        }
                    }
                    $wayPoint[] = $arr;
                    $wayPointCount++;
                }
            }
        }
        $ARR['SourceLocationPoint'] = isset($StartLetter)? $StartLetter : '';
        $ARR['DestLocationPoint'] = isset($letter1)? $letter1 : '';
        $ARR['wayPoint'] = $wayPoint;
        if($TYPE_FUNCTION == "getVerificationDocuments" && $letter1 != '' && $StartLetter != ''){
            $WayPointPrice[]['Location '.$StartLetter.' - '.$letter1] = formateNumAsPerCurrency($fPrice,$vCurrencyPassenger);
        }
        $ARR['WayPointPrice'] = isset($WayPointPrice)? $WayPointPrice : '';
        return $ARR;
    }
    public function getWayPointStartEndTime($PointRecommendedPrice,$dStartDate){
        $TotalDuration = 0;
        $ARR['StartDate'] = $ARR['PointRecommendedPrice'] = [];
        if(isset($PointRecommendedPrice)&& !empty($PointRecommendedPrice)){
            $PointRecommendedPrice = json_decode($PointRecommendedPrice,true);
            $StartLetter = $letter = 'A';
            foreach($PointRecommendedPrice as $key => $point){
                $l = $letter;
                $letter = ord($letter)+ 1;
                $letter1 = $letter = chr($letter);
                $PointRecommendedPrice[$key]['vSPoint'] = $l;
                $PointRecommendedPrice[$key]['vDPoint'] = $letter1;
                if($key == 0){
                    $PointRecommendedPrice[$key]['StartDate'] = $dStartDate;
                    $PointRecommendedPrice[$key]['EndDate'] = date('Y-m-d H:i:s',strtotime($dStartDate)+ $point['duration']);
                    $ARR['StartDate'][] = $dStartDate;
                }
                else {
                    $StartDate = $PointRecommendedPrice[$key - 1]['EndDate'];
                    $ARR['StartDate'][] = $StartDate;
                    $PointRecommendedPrice[$key]['StartDate'] = $StartDate;
                    $PointRecommendedPrice[$key]['EndDate'] = date('Y-m-d H:i:s',strtotime($StartDate)+ $point['duration']);
                }
                $TotalDuration += $point['duration'];
            }
            $ARR['PointRecommendedPrice'] = $PointRecommendedPrice;
            $ARR['vSPoint'] = $StartLetter;
            $ARR['vDPoint'] = $letter1;
        }
        $ARR['TotalDuration'] = $TotalDuration;
        return $ARR;
    }
    public function publishRide(){
        global $ONLY_ENABLE_RIDE_SHARING_PRO,$obj,$tconfig,$Data_ALL_currency_Arr,$WALLET_OBJ,$CASH_AVAILABLE,$RIDE_SHARE_BOOKING_FEE,$LANG_OBJ,$COMM_MEDIA_OBJ,$UPLOAD_OBJ;
        $GeneralMemberId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $tEndLat = isset($_REQUEST["tEndLat"])?$_REQUEST["tEndLat"]:'';
        $tEndLong = isset($_REQUEST["tEndLong"])?$_REQUEST["tEndLong"]:'';
        $dStartDate = isset($_REQUEST["dStartDate"])?$_REQUEST["dStartDate"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $iAvailableSeats = isset($_REQUEST["iAvailableSeats"])?$_REQUEST["iAvailableSeats"]:'';
        $fPrice = isset($_REQUEST["fPrice"])?$_REQUEST["fPrice"]:'';
        $tDriverDetails = isset($_REQUEST["tDriverDetails"])?$_REQUEST["tDriverDetails"]:'';
        $documentIds = isset($_REQUEST["documentIds"])?$_REQUEST["documentIds"]:'';
        $StartCity = isset($_REQUEST["tStartCity"])?$_REQUEST["tStartCity"]:'';
        $EndCity = isset($_REQUEST["tEndCity"])?$_REQUEST["tEndCity"]:'';
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $existingCarImageName = isset($_REQUEST["existingCarImageName"])?$_REQUEST["existingCarImageName"]:'';
        $image_name = $vImage = isset($_FILES['vImage']['name'])?$_FILES['vImage']['name']:'';
        $image_object = isset($_FILES['vImage']['tmp_name'])?$_FILES['vImage']['tmp_name']:'';
        $PointRecommendedPrice = isset($_REQUEST["PointRecommendedPrice"])?$_REQUEST["PointRecommendedPrice"]:'';
        $tSAddress = isset($_REQUEST["tSAddress"])?$_REQUEST["tSAddress"]:'';
        $tDAddress = isset($_REQUEST["tDAddress"])?$_REQUEST["tDAddress"]:'';
        $userData = $obj->MySQLSelect("SELECT CONCAT(ru.vName, ' ', ru.vLastName)as PublisherName, CONCAT('+', ru.vPhoneCode, ru.vPhone)as PhoneNo, ru.vCurrencyPassenger, curr.Ratio, ru.vLang FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$GeneralMemberId."' ");
        $priceRatio = $userData[0]['Ratio'];
        $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
        $vLang = $userData[0]['vLang'];
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $langLabels = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $fOutStandingAmount = GetPassengerOutstandingAmount($GeneralMemberId);
        $fOutStandingAmount = setTwoDecimalPoint($fOutStandingAmount * $priceRatio);
        if($fOutStandingAmount > 0 && $GeneralMemberId > 0){
            $returnArr['fOutStandingAmount'] = $fOutStandingAmount;
            $returnArr['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount,$vCurrencyPassenger);
            $checkDataArray = array();
            $checkDataArray['UserType'] = "Passenger";
            $checkDataArray['iMemberId'] = $GeneralMemberId;
            $checkDataArray['fOutStandingAmount'] = $fOutStandingAmount;
            $checkDataArray['ePayWallet'] = 'No';
            $checkDataArray['vLangCode'] = $vLang;
            $ShowOutstandingButtonsArray = ShowOutstandingButtons($checkDataArray,"RideShare");
            $returnArr = array_merge($returnArr,$ShowOutstandingButtonsArray);
            $returnArr['Action'] = "0";
            setDataResponse($returnArr);
        }
        $systemTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $dStartDate = converToTz($dStartDate,$systemTimeZone,$vTimeZone);
        }
        $ADD_WAYPOINTS = [];
        if(isset($PointRecommendedPrice)&& !empty($PointRecommendedPrice)&& $this->isOnlyEnableRideSharingPro && $this->isOnlyEnableRideSharingPro){
            $ADD_WAYPOINTS = $this->getWayPointStartEndTime($PointRecommendedPrice,$dStartDate);
        }
        if($CASH_AVAILABLE == 'Yes' && $this->BookingFeeCheckInWallet == "PUBLISH_TIME"){
            $rider_available_balance = $WALLET_OBJ->FetchMemberWalletBalanceApp($GeneralMemberId,"Rider","No","Yes");
            $rider_available_balance = $rider_available_balance['ORIG_AMOUNT'];
            $commission = $RIDE_SHARE_BOOKING_FEE *($iAvailableSeats *($fPrice / $priceRatio))/ 100;
            if($commission > $rider_available_balance){
                $commission = formateNumAsPerCurrency($commission * $priceRatio,$vCurrencyPassenger);
                $rider_available_balance = formateNumAsPerCurrency($rider_available_balance * $priceRatio,$vCurrencyPassenger);
                $returnArr['Action'] = "0";
                $returnArr['LOW_WALLET_BAL'] = "Yes";
                $returnArr['message'] = str_replace(['#####', '####'],[$commission, $rider_available_balance],$langLabels['LBL_RIDE_SHARE_LOW_WALLET_BAL_NOTE_WITH_WALLET_AMT']);
                setDataResponse($returnArr);
            }
        }
        $tPriceRatioArr = array();
        if(!empty($Data_ALL_currency_Arr)&& scount($Data_ALL_currency_Arr)> 0){
            $currencyList = $Data_ALL_currency_Arr;
        }
        else {
            $currencyList = $obj->MySQLSelect("SELECT vName, Ratio, eStatus FROM currency ");
        }
        for($c = 0;
        $c < scount($currencyList);
        $c++){
            $tPriceRatioArr['fRatio_'.$currencyList[$c]['vName']] = "1.0000";
            if(strtoupper($currencyList[$c]['eStatus'])== "ACTIVE"){
                $tPriceRatioArr['fRatio_'.$currencyList[$c]['vName']] = $currencyList[$c]['Ratio'];
            }
        }
        $tDriverDetailsDB = "";
        if(!empty($tDriverDetails)){
            $tDriverDetailsDB = preg_replace('/[[:cntrl:]]/','\r\n',$tDriverDetails);
            $tDriverDetailsDB = json_decode($tDriverDetailsDB,true);
            if($image_name != ''){
                $filecheck = basename($image_name);
                $fileextarr = explode(".",$filecheck);
                $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
                if($ext != "jpg" && $ext != "gif" && $ext != "png" && $ext != "jpeg" && $ext != "bmp"){
                    $var_msg = $langLabels['LBL_FILE_EXT_VALID_ERROR_MSG']." .jpg, .jpeg, .gif, .png, .bmp";
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = $var_msg;
                    setDataResponse($returnArr);
                }
                $Photo_Gallery_folder = $tconfig["tsite_upload_images_driver_car_ride_share_path"].'/';
                if(!is_dir($Photo_Gallery_folder)){
                    mkdir($Photo_Gallery_folder,0777);
                    chmod($Photo_Gallery_folder,0777);
                }
                $img1 = $UPLOAD_OBJ->GeneralFileUpload($Photo_Gallery_folder,$image_object,$image_name,'','jpg,png,gif,jpeg,bmp');
                $vImgName = $img1[0];
                $image = array('iData' => "cImage", 'value' => $vImgName);
                $tDriverDetailsDB[] = $image;
            }
            if($existingCarImageName != '' && $image_name == ''){
                $image = array('iData' => "cImage", 'value' => $existingCarImageName);
                $tDriverDetailsDB[] = $image;
            }
            $tDriverDetailsDB_ = $tDriverDetailsDB;
        }
        $tDriverDetailsDB_temp = [];
        foreach($tDriverDetailsDB as $details){
            if($details['iData'] == "cNote"){
                $details['value'] = $details['value'];
            }
            $tDriverDetailsDB_temp[] = $details;
        }
        $tDriverDetailsDB = $tDriverDetailsDB_temp;
        if(!empty($tSAddress)){
            $tStartLocation = $tSAddress;
        }
        else {
            $tStartLocation = getLocationNameLatLog($tStartLat,$tStartLong);
        }
        if(!empty($tDAddress)){
            $tEndLocation = $tDAddress;
        }
        else {
            $tEndLocation = getLocationNameLatLog($tEndLat,$tEndLong);
        }
        $vLangCodeData = get_value('language_master','vCode, vGMapLangCode','eDefault','Yes');
        $vGMapLangCode = $vLangCodeData[0]['vGMapLangCode'];
        if(isset($ADD_WAYPOINTS['TotalDuration'])&& !empty($ADD_WAYPOINTS['TotalDuration'])){
            $fDuration = $ADD_WAYPOINTS['TotalDuration'];
        }
        else {
            $requestDataArr = array();
            $requestDataArr['SOURCE_LATITUDE'] = $tStartLat;
            $requestDataArr['SOURCE_LONGITUDE'] = $tStartLong;
            $requestDataArr['DEST_LATITUDE'] = $tEndLat;
            $requestDataArr['DEST_LONGITUDE'] = $tEndLong;
            $requestDataArr['LANGUAGE_CODE'] = $vGMapLangCode;
            $direction_data = getPathInfoBetweenLocations($requestDataArr);
            $fDuration = $direction_data['duration'];
        }
        $vPublishedRideNo = $this->GenerateUniquePublishedRideNo();
        $Data_publish = array();
        $Data_publish['vPublishedRideNo'] = $vPublishedRideNo;
        $Data_publish['iUserId'] = $GeneralMemberId;
        $Data_publish['dStartDate'] = $dStartDate;
        $Data_publish['dEndDate'] = date('Y-m-d H:i:s',strtotime($dStartDate)+ $fDuration);
        $Data_publish['fDuration'] = $fDuration;
        $Data_publish['tStartLat'] = $tStartLat;
        $Data_publish['tStartLong'] = $tStartLong;
        $Data_publish['tEndLat'] = $tEndLat;
        $Data_publish['tEndLong'] = $tEndLong;
        $Data_publish['tStartLocation'] = $tStartLocation;
        $Data_publish['tEndLocation'] = $tEndLocation;
        $Data_publish['fPrice'] = $fPrice / $priceRatio;
        $Data_publish['tPriceRatio'] = json_encode($tPriceRatioArr,JSON_UNESCAPED_UNICODE);
        $Data_publish['iAvailableSeats'] = $iAvailableSeats;
        $Data_publish['dAddedDate'] = date('Y-m-d H:i:s');
        $Data_publish['tDriverDetails'] = json_encode($tDriverDetailsDB,JSON_UNESCAPED_UNICODE);
        $Data_publish['tDocumentIds'] = $documentIds;
        $Data_publish['eStatus'] = "Active";
        $Data_publish['eVerified'] = "No";
        $Data_publish['tStartCity'] = $StartCity;
        $Data_publish['tEndCity'] = $EndCity;
        if(isset($ADD_WAYPOINTS['vSPoint'])&& !empty($ADD_WAYPOINTS['vSPoint'])){
            $Data_publish['vSPoint'] = $ADD_WAYPOINTS['vSPoint'];
        }
        if(isset($ADD_WAYPOINTS['vDPoint'])&& !empty($ADD_WAYPOINTS['vDPoint'])){
            $Data_publish['vDPoint'] = $ADD_WAYPOINTS['vDPoint'];
        }
        $iPublishedRideId = $obj->MySQLQueryPerform("published_rides",$Data_publish,"insert");
        if(isset($ADD_WAYPOINTS['PointRecommendedPrice'])&& !empty($ADD_WAYPOINTS['PointRecommendedPrice'])){
            $this->addWayPointsData($ADD_WAYPOINTS,$iPublishedRideId,$priceRatio,$Data_publish['tPriceRatio'],$iAvailableSeats);
        }
        $this->notifyUser($iPublishedRideId);
        $CommonDateFormat = commonDateFormat($dStartDate,$vTimeZone,$vLang,1,'Yes');
        $Data_Mail = array();
        $Data_Mail['vName'] = $userData[0]['PublisherName'];
        $Data_Mail['vPhone'] = $userData[0]['PhoneNo'];
        $Data_Mail['vSourceAddresss'] = $tStartLocation;
        $Data_Mail['vDestinationAddress'] = $tEndLocation;
        $Data_Mail['Date'] = $CommonDateFormat['DATE_TIME']." ".$CommonDateFormat['UTC'];
        $Data_Mail['Seats'] = $iAvailableSeats;
        $Data_Mail['PricePerSeat'] = formateNumAsPerCurrency($fPrice / $priceRatio,'');
        if(isset($tDriverDetailsDB_)&& !empty($tDriverDetailsDB_)){
            foreach($tDriverDetailsDB_ as $Details){
                $iData = $Details['iData'];
                if($Details['iData'] == 'cImage'){
                    $Details['value'] = $tconfig["tsite_upload_images_driver_car_ride_share"].'/'.$Details['value'];
                }
                $$iData = $Details['value'];
            }
        }
        $DriverDetailsHtml = '';
        if(isset($dName)&& !empty($dName)){
            $tFieldName = $langLabels['LBL_RIDE_SHARE_DRIVER_NAME_TXT'];
            $value = $dName;
            $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
        }
        if(isset($dPhoneCode)&& !empty($dPhoneCode)){
            $tFieldName = $langLabels['LBL_RIDE_SHARE_DRIVER_PHONE_NO_TXT'];
            $value = '+'.$dPhoneCode.$dPhone;
            $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
        }
        if(isset($cMake)&& !empty($cMake)){
            $tFieldName = $langLabels['LBL_RIDE_SHARE_CAR_DETAILS_TITLE'];
            $value = $cMake.' '.$cModel.' - '.$cNumberPlate;
            $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
        }
        if(isset($cNote)&& !empty($cNote)){
            $tFieldName = $langLabels['LBL_RIDE_SHARE_ADDITIONAL_NOTES_TXT'];
            $value = $cNote;
            $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
        }
        $Data_Mail['DriverDetails'] = $DriverDetailsHtml;
        $COMM_MEDIA_OBJ->SendMailToMember("RIDE_PUBLISHED_NOTIFY_ADMIN",$Data_Mail);
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_RIDE_SHARE_PUBLISH_RIDE_SUCCESS_TEXT";
        $returnArr['message_title'] = "LBL_RIDE_SHARE_PUBLISH_RIDE_SUCCESS_TITLE";
        if($this->IsAnyDocumentActive()){
            $sql = "SELECT eApproveDoc FROM register_user WHERE iUserId = '".$GeneralMemberId."'";
            $result_user = $obj->MySQLSelect($sql);
            if($result_user[0]['eApproveDoc'] == "No"){
                $returnArr['messageReviewDoc'] = "LBL_RIDE_SHARE_PUBLISHED_RIDE_REVIEW_DOC";
            }
        }
        setDataResponse($returnArr);
    }
    public function GenerateUniquePublishedRideNo(){
        global $obj,$tconfig;
        $random = substr(number_format(time()* rand(),0,'',''),0,10);
        $str = "select iPublishedRideId from published_rides where vPublishedRideNo ='".$random."'";
        $db_str = $obj->MySQLSelect($str);
        if(!empty($db_str)&& scount($db_str)> 0){
            $Generateuniqueno = GenerateUniquePublishedRideNo();
        }
        else {
            $Generateuniqueno = $random;
        }
        return $Generateuniqueno;
    }
    public function addWayPointsData($ADD_WAYPOINTS,$iPublishedRideId,$priceRatio,$tPriceRatio,$iAvailableSeats){
        global $GeneralMemberId,$obj;
        if(isset($ADD_WAYPOINTS['PointRecommendedPrice'])&& !empty($ADD_WAYPOINTS['PointRecommendedPrice'])){
            foreach($ADD_WAYPOINTS['PointRecommendedPrice'] as $ADD){
                $Data_Insert['iPublishedRideId'] = $iPublishedRideId;
                $Data_Insert['iUserId'] = $GeneralMemberId;
                $Data_Insert['dStartDate'] = $ADD['StartDate'];
                $Data_Insert['dEndDate'] = $ADD['EndDate'];
                $Data_Insert['fDuration'] = $ADD['duration'];
                $Data_Insert['tStartLocation'] = $ADD['startPoint']['add'];
                $Data_Insert['tStartLat'] = $ADD['startPoint']['lat'];
                $Data_Insert['tStartLong'] = $ADD['startPoint']['long'];
                $Data_Insert['tEndLocation'] = $ADD['endPoint']['add'];
                $Data_Insert['tEndLat'] = $ADD['endPoint']['lat'];
                $Data_Insert['tEndLong'] = $ADD['endPoint']['long'];
                $Data_Insert['fPrice'] = $ADD['recommended_price'] / $priceRatio;
                $Data_Insert['tPriceRatio'] = $tPriceRatio;
                $Data_Insert['iAvailableSeats'] = $iAvailableSeats;
                $Data_Insert['vSPoint'] = $ADD['vSPoint'];
                $Data_Insert['vDPoint'] = $ADD['vDPoint'];
                $Data_Insert['tStartCity'] = $this->getCity($Data_Insert['tStartLat'],$Data_Insert['tStartLong']);
                $Data_Insert['tEndCity'] = $this->getCity($Data_Insert['tEndLat'],$Data_Insert['tEndLong']);
                $obj->MySQLQueryPerform("published_rides_waypoints",$Data_Insert,'insert');
            }
        }
    }
    public function getCity($tLat,$tLong){
        $Location = getLocationNameLatLog($tLat,$tLong,'No');
        $Location = json_decode($Location,true);
        $address_components = $Location['results'][0]['address_components'];
        foreach($address_components as $addr){
            if($addr['types'][0] == "locality"){
                $City = $addr['long_name'];
            }
            elseif($addr['types'][0] == "administrative_area_level_3"){
                $City = $addr['long_name'];
            }
        }
        return $City;
    }
    public function notifyUser($iPublishRide){
        global $LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE,$LIST_RIDES_LIMIT_BY_DEST_DISTANCE,$obj,$LANG_OBJ;
        $LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE = 20;
        $LIST_RIDES_LIMIT_BY_DEST_DISTANCE = 20;
        if(isset($iPublishRide)&& !empty($iPublishRide)){
            $vLang = $_REQUEST["vGeneralLang"] ?? '';
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
            $PublishRideData = $this->getPublishRideById($iPublishRide)[0];
            $tStartLat = $PublishRideData['tStartLat'];
            $tStartLong = $PublishRideData['tStartLong'];
            $tEndLat = $PublishRideData['tEndLat'];
            $tEndLong = $PublishRideData['tEndLong'];
            $dStartDate = $PublishRideData['dStartDate'];
            $dStartDate = date('Y-m-d',strtotime($dStartDate));
            $NoOfSeats = $PublishRideData['iAvailableSeats'];
            $iUserId = $PublishRideData['iUserId'];
            $searchSql = "SELECT riderUser.vLang, riderUser.vTimeZone, riderUser.vName, riderUser.vEmail, CONCAT(riderUser.vName,' ',riderUser.vLastName)AS rider_Name, ra.iUserId, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(ra.tStartLat, 8)))* cos(radians(ROUND(ra.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(ra.tStartLat, 8))))), 2)AS startDistance, ROUND((6371 * acos(cos(radians(".$tEndLat."))* cos(radians(ROUND(ra.tEndLat, 8)))* cos(radians(ROUND(ra.tEndLong, 8))- radians(".$tEndLong."))+ sin(radians(".$tEndLat."))* sin(radians(ROUND(ra.tEndLat, 8))))), 2)AS endDistance FROM ride_alert as ra LEFT JOIN register_user riderUser ON(riderUser.iUserId = ra.iUserId)WHERE NoOfSeats <= $NoOfSeats AND ra.iUserId != $iUserId AND dStartDate = '".$dStartDate."' GROUP BY ra.iUserId HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE." AND endDistance <= ".$LIST_RIDES_LIMIT_BY_DEST_DISTANCE." ";
            $ride_alert_data = $obj->MySQLSelect($searchSql);
            $RideWayPointsData = $this->getRideWaypoints($iPublishRide);
            if(isset($RideWayPointsData)&& !empty($RideWayPointsData)){
                foreach($RideWayPointsData as $waypointData){
                    $tStartLat = $waypointData['tStartLat'];
                    $tStartLong = $waypointData['tStartLong'];
                    $tEndLat = $waypointData['tEndLat'];
                    $tEndLong = $waypointData['tEndLong'];
                    $dStartDate = $waypointData['dStartDate'];
                    $dStartDate = date('Y-m-d',strtotime($dStartDate));
                    $NoOfSeats = $waypointData['iAvailableSeats'];
                    $iUserId = $waypointData['iUserId'];
                    $searchSql = "SELECT riderUser.vLang, riderUser.vTimeZone, riderUser.vName, riderUser.vEmail, CONCAT(riderUser.vName,' ',riderUser.vLastName)AS rider_Name, ra.iUserId, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(ra.tStartLat, 8)))* cos(radians(ROUND(ra.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(ra.tStartLat, 8))))), 2)AS startDistance, ROUND((6371 * acos(cos(radians(".$tEndLat."))* cos(radians(ROUND(ra.tEndLat, 8)))* cos(radians(ROUND(ra.tEndLong, 8))- radians(".$tEndLong."))+ sin(radians(".$tEndLat."))* sin(radians(ROUND(ra.tEndLat, 8))))), 2)AS endDistance FROM ride_alert as ra LEFT JOIN register_user riderUser ON(riderUser.iUserId = ra.iUserId)WHERE NoOfSeats <= $NoOfSeats AND ra.iUserId != $iUserId AND dStartDate = '".$dStartDate."' GROUP BY ra.iUserId HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE." AND endDistance <= ".$LIST_RIDES_LIMIT_BY_DEST_DISTANCE." ";
                    $ride_alert_data_1 = $obj->MySQLSelect($searchSql);
                    $ride_alert_data = $this->margeArrayForRideAlert($ride_alert_data,$ride_alert_data_1);
                }
            }
            if(isset($ride_alert_data)&& !empty($ride_alert_data)){
                foreach($ride_alert_data as $ride_alert){
                    $vTimeZone_rider = $ride_alert['vTimeZone'];
                    $vLang_rider = $ride_alert['vLang'];
                    $CommonDateFormat = commonDateFormat($PublishRideData['dStartDate'],$vTimeZone_rider,$vLang_rider,1,'Yes');
                    $Data_Mail = array();
                    $Data_Mail['vRiderName'] = $ride_alert['rider_Name'];
                    $Data_Mail['vEmail'] = $ride_alert['vEmail'];
                    $Data_Mail['vDiverName'] = $PublishRideData['PublisherName'];
                    $Data_Mail['vSourceAddresss'] = $PublishRideData['tStartLocation'];
                    $Data_Mail['vDestinationAddress'] = $PublishRideData['tEndLocation'];
                    $Data_Mail['Date'] = $CommonDateFormat['DATE_TIME'];
                    $tDriverDetailsDB_ = $PublishRideData['tDriverDetails'];
                    $tDriverDetailsDB_ = json_decode($tDriverDetailsDB_,true);
                    if(isset($tDriverDetailsDB_)&& !empty($tDriverDetailsDB_)){
                        foreach($tDriverDetailsDB_ as $Details){
                            $iData = $Details['iData'];
                            if($Details['iData'] == 'cImage'){
                                $Details['value'] = $tconfig["tsite_upload_images_driver_car_ride_share"].'/'.$Details['value'];
                            }
                            $$iData = $Details['value'];
                        }
                    }
                    $DriverDetailsHtml = '';
                    if(isset($dName)&& !empty($dName)){
                        $tFieldName = $languageLabelsArr['LBL_RIDE_SHARE_DRIVER_NAME_TXT'];
                        $value = $dName;
                        $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
                    }
                    if(isset($dPhoneCode)&& !empty($dPhoneCode)){
                        $tFieldName = $languageLabelsArr['LBL_RIDE_SHARE_DRIVER_PHONE_NO_TXT'];
                        $value = '(+'.$dPhoneCode.')'.$dPhone;
                        $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
                    }
                    if(isset($cMake)&& !empty($cMake)){
                        $tFieldName = $languageLabelsArr['LBL_RIDE_SHARE_CAR_DETAILS_TITLE'];
                        $value = $cMake.' '.$cModel.' - '.$cNumberPlate;
                        $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
                    }
                    if(isset($cNote)&& !empty($cNote)){
                        $tFieldName = $languageLabelsArr['LBL_RIDE_SHARE_ADDITIONAL_NOTES_TXT'];
                        $value = $cNote;
                        $DriverDetailsHtml .= '<strong>'.$tFieldName.': </strong>'.$value.'<br>';
                    }
                    $Data_Mail['DriverDetails'] = $DriverDetailsHtml;
                    $alertMeg = $languageLabelsArr['LBL_SEND_NOTI_MESSAGE_RIDER_RIDE_SHARE_TEXT'];
                    $dataNotify = $this->notify($ride_alert['iUserId'],'NOTIFICATION,SMS,MAIL','RIDE_SHARE_NOTIFY_USER_SEARCH_CRITERIA_NEW_PUBLISH_RIDE','RIDE_SHARE_NOTIFY_USER_SEARCH_CRITERIA_NEW_PUBLISH_RIDE','RideShareAlert',$Data_Mail,$Data_SMS,$alertMeg,$iPublishRide,"");
                }
            }
        }
    }
    public function getPublishRideById($iPublishedRideId){
        global $obj;
        $sql = "SELECT ru.vName, CONCAT(ru.vName, ' ', ru.vLastName)as PublisherName, ru.vEmail, ru.vPhone, ru.vPhoneCode, pr.iUserId,pr.tPriceRatio,pr.iBookedSeats,pr.fPrice,pr.tStartLocation, pr.tStartLat, pr.tStartLong, pr.tEndLocation, pr.tEndLat, pr.tEndLong, pr.dStartDate, pr.dEndDate, pr.fPrice, pr.iAvailableSeats, pr.tDriverDetails, ru.vCurrencyPassenger FROM published_rides as pr LEFT JOIN register_user as ru ON ru.iUserId = pr.iUserId WHERE pr.iPublishedRideId = '".$iPublishedRideId."' ORDER BY pr.dAddedDate DESC";
        return $obj->MySQLSelect($sql);
    }
    public function getRideWaypoints($iPublishedRideId){
        global $obj;
        $sql = "SELECT ru.vName, CONCAT(ru.vName, ' ', ru.vLastName)as PublisherName, ru.vEmail, ru.vPhone, ru.vPhoneCode, prw.iUserId, prw.tPriceRatio, prw.iBookedSeats, prw.fPrice, prw.tStartLocation, prw.tStartLat, prw.tStartLong, prw.tEndLocation, prw.tEndLat, prw.tEndLong, prw.dStartDate, prw.dEndDate, prw.fPrice, prw.iAvailableSeats, ru.vCurrencyPassenger FROM published_rides_waypoints as prw LEFT JOIN register_user as ru ON ru.iUserId = prw.iUserId WHERE prw.iPublishedRideId = '".$iPublishedRideId."'";
        return $obj->MySQLSelect($sql);
    }
    public function margeArrayForRideAlert($RideArr = [],$newRideArr = []){
        if(isset($newRideArr)&& !empty($newRideArr)){
            foreach($newRideArr as $arr){
                $RideArr[] = $arr;
            }
        }
        return $RideArr;
    }
    public function notify($userId,$type,$SMS_TEMPLATE,$MAIL_TEMPLATE,$NOTI_TEMPLATE,$mailArr,$smsArr,$alertMsg = '',$iPublishedRideId = '',$iBookingId = ''){
        global $obj,$EVENT_MSG_OBJ,$COMM_MEDIA_OBJ,$LANG_OBJ;
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $type = explode(',',$type);
        $row1 = $obj->MySQLSelect("SELECT vPhoneCode , vPhone, eHmsDevice , iUserId, vCurrencyPassenger, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName FROM `register_user` WHERE iUserId = '".$userId."'");
        if(in_array('NOTIFICATION',$type)){
            $generalDataArr = $final_message = array();
            $final_message['Message'] = $NOTI_TEMPLATE;
            $final_message['MsgType'] = $NOTI_TEMPLATE;
            $final_message['time'] = time();
            $final_message['eType'] = "RideShare";
            $generalDataArr[] = array('eDeviceType' => $row1[0]['eDeviceType'], 'deviceToken' => $row1[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $row1[0]['eAppTerminate'], 'eDebugMode' => $row1[0]['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $row1[0]['eHmsDevice'], 'channelName' => "PASSENGER_".$userId);
            $arr['NOTIFICATION'] = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr),RN_USER);
        }
        if(in_array('MAIL',$type)){
            $arr['MAIL'] = $COMM_MEDIA_OBJ->SendMailToMember($MAIL_TEMPLATE,$mailArr);
        }
        if(in_array('SMS',$type)){
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($SMS_TEMPLATE,$smsArr,"",$vLangCode);
            $arr['SMS'] = $COMM_MEDIA_OBJ->SendSystemSMS($row1[0]['vPhone'],$row1[0]['vPhoneCode'],$message_layout);
        }
        return $arr;
    }
    public function fetchPublishedRides(){
        global $START_TRIP_BTN_SHOW_BEFORE_SPECIFIC_TIME,$obj,$LANG_OBJ,$ONLY_ENABLE_RIDE_SHARING_PRO,$ENABLE_24_HOUR_FORMAT;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $vFilterParam = isset($_REQUEST['vSubFilterParam'])?$_REQUEST['vSubFilterParam']:"";
        $SYSTEM_TYPE = isset($_REQUEST['SYSTEM_TYPE'])?$_REQUEST['SYSTEM_TYPE']:"";
        $startDate = isset($_REQUEST['startDate'])?$_REQUEST['startDate']:"";
        $endDate = isset($_REQUEST['endDate'])?$_REQUEST['endDate']:"";
        $EXPIRED = 2;
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $langLabels = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $page = isset($_REQUEST['page'])?trim($_REQUEST['page']):1;
        $iPublishedRideId_sql = '';
        if(!empty($iPublishedRideId)){
            $iPublishedRideId_sql = "AND pr.iPublishedRideId = '".$iPublishedRideId."'";
        }
        $currentDate = date('Y-m-d H:i:s');
        $serverTimeZone = date_default_timezone_get();
        $todaydate = converToTz($currentDate,$serverTimeZone,$vTimeZone,"Y-m-d");
        if($vFilterParam == '' && $SYSTEM_TYPE != "WEB"){
            $FilterPriority = $this->getFilterPriority($iUserId)['filter'];
            $vFilterParam = $FilterPriority;
        }
        $ssql = '';
        if(empty($iPublishedRideId)){
            if(strtoupper($vFilterParam)!= "CANCELLED"){
                $ssql .= " AND pr.eStatus != 'Cancelled' ";
            }
            if(strtoupper($vFilterParam)== "UPCOMING"){
                $todaydate = $currentDate;
                $time = time();
                $date2 = strtotime('-'.$EXPIRED.' hours',$time);
                $todaydate2 = date('Y-m-d H:i:s',$date2);
                $ssql .= " AND pr.dStartDate > '$todaydate2' AND pr.eTrackingStatus = 'Pending' ";
            }
            else if(strtoupper($vFilterParam)== "COMPLETED"){
                $ssql .= " AND pr.eStatus != 'Cancelled' AND pr.eTrackingStatus = 'PaymentCollect' ";
            }
            elseif(strtoupper($vFilterParam)== "INPROCESS"){
                $ssql .= " AND pr.eTrackingStatus IN('Start','MarkAsPickupALL','End')";
            }
            elseif(strtoupper($vFilterParam)== "CANCELLED"){
                $ssql .= " AND pr.eStatus = 'Cancelled' ";
            }
            elseif(strtoupper($vFilterParam)== "EXPIRED"){
                $time = time();
                $date2 = strtotime('-'.$EXPIRED.' hours',$time);
                $todaydate2 = date('Y-m-d H:i:s',$date2);
                $ssql .= " AND pr.dStartDate < '$todaydate2' AND pr.eTrackingStatus = 'Pending' ";
            }
            else {
                if($SYSTEM_TYPE == "WEB"){
                    $ssql = '';
                    if($startDate != ''){
                        $ssql .= " AND Date(pr.dStartDate)>='".$startDate."'";
                    }
                    if($endDate != ''){
                        $ssql .= " AND Date(pr.dStartDate)<='".$endDate."'";
                    }
                }
            }
        }
        $isExpired = '';
        if(!empty($vTimeZone)){
            $TimeZoneOffset = converToTz($currentDate,$serverTimeZone,$vTimeZone,"P");
        }
        $EXPIRED_M = $EXPIRED * 60;
        $isExpired .= "CASE WHEN pr.eTrackingStatus ='Pending' THEN pr.dStartDate <((CONVERT_TZ(NOW(), 'SYSTEM', '".$TimeZoneOffset."'))- INTERVAL $EXPIRED_M MINUTE)ELSE '0' END as isExpired,";
        $published_rides = $obj->MySQLSelect("SELECT $isExpired pr.eStatus,pr.iBookedSeats,pr.eTrackingStatus,pr.iPublishedRideId,pr.tCancelReason,pr.iCancelReasonId, pr.tDocumentIds, ru.eApproveDoc, pr.tPriceRatio,pr.tStartCity, pr.tEndCity, pr.tStartLocation, pr.tStartLat, pr.tStartLong, pr.tEndLocation, pr.tEndLat, pr.tEndLong, pr.dStartDate, pr.dEndDate, pr.fPrice, pr.iAvailableSeats, pr.tDriverDetails, ru.vCurrencyPassenger, pr.fDuration, pr.vPublishedRideNo FROM published_rides as pr LEFT JOIN register_user as ru ON ru.iUserId = pr.iUserId WHERE 1 = 1 {
            $iPublishedRideId_sql
        }
        AND pr.iUserId = '".$iUserId."' $ssql ORDER BY pr.dStartDate DESC");
        if(!empty($published_rides)&& scount($published_rides)> 0){
            $iPublishedRideIds = array_column($published_rides,'iPublishedRideId');
            $PendingBookingRequest = $this->checkAnyPendingRemaining($iPublishedRideIds);
            $ridesArr = array();
            foreach($published_rides as $k => $ride){
                $Expired = $ride['isExpired'];
                $BookingListArr = $this->BookingList($vLang,$ride['iPublishedRideId'],[],'PublishedRide');
                if($ride['eTrackingStatus'] == "Pending" && $Expired == 0){
                    if(isset($PendingBookingRequest[$ride['iPublishedRideId']])&& !empty($PendingBookingRequest[$ride['iPublishedRideId']])){
                        $ridesArr[$k]['pendingReqMsg'] = $langLabels['LBL_PENDING_REQUEST_RIDE_SHARE_TEXT'];
                    }
                }
                $tPriceRatio = $ride['tPriceRatio'];
                $tPriceRatio = json_decode($tPriceRatio,true);
                $vCurrencyPassenger = $ride['vCurrencyPassenger'];
                if(empty($tPriceRatio['fRatio_'.$vCurrencyPassenger])){
                    $tPriceRatio['fRatio_'.$vCurrencyPassenger] = get_value('currency', 'Ratio', 'vName', $vCurrencyPassenger, '', 'true');
                }
                $fPrice = $ride['fPrice'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $ridesArr[$k]['tStartLocation'] = $ride['tStartLocation'];
                $ridesArr[$k]['tStartLat'] = $ride['tStartLat'];
                $ridesArr[$k]['tStartLong'] = $ride['tStartLong'];
                $ridesArr[$k]['tEndLocation'] = $ride['tEndLocation'];
                $ridesArr[$k]['tEndLat'] = $ride['tEndLat'];
                $ridesArr[$k]['tEndLong'] = $ride['tEndLong'];
                if($this->isOnlyEnableRideSharingPro){
                    $fRatioCurrency = $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                    $waypointData = $this->getWayPointsFromTheDb($ride['iPublishedRideId'],$fRatioCurrency,$vCurrencyPassenger,$fPrice);
                    if($waypointData['SourceLocationPoint'] == ''){
                        $waypointData['SourceLocationPoint'] = 'A';
                    }
                    if($waypointData['DestLocationPoint'] == ''){
                        $waypointData['DestLocationPoint'] = 'B';
                    }
                    if(isset($waypointData['waypoint_data'])&& !empty($waypointData['waypoint_data'])){
                        foreach($waypointData['waypoint_data'] as $key => $waypoint_data){
                            $waypointData['waypoint_data'][$key]['WPDate'] = date('h:i A',strtotime(converToTz($waypoint_data['WPDate'],$vTimeZone,$serverTimeZone)));
                        }
                    }
                    $ridesArr[$k]['waypoints'] = $waypointData['waypoint_data'];
                    $ridesArr[$k]['waypointFare'] = $waypointData['WayPointPrice'];
                    $ridesArr[$k]['SourceLocationPoint'] = $waypointData['SourceLocationPoint'];
                    $ridesArr[$k]['DestLocationPoint'] = $waypointData['DestLocationPoint'];
                }
                $ridesArr[$k]['StartDate'] = DateTime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone),22);
                if(!empty($ride['dStartDate'])|| $ride['dStartDate'] != "0000-00-00"){
                    $startdate_data_array = array('tdate' => converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone), 'langCode' => $vLang);
                    $getRidestartDateFormat = DateformatCls::getNewDateFormat($startdate_data_array);
                    if(!empty($getRidestartDateFormat)){
                        foreach($getRidestartDateFormat as $ridestart_key => $ridestart_value){
                            $ridesArr[$k][$ridestart_key] = $ridestart_value;
                        }
                    }
                }
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $ridesArr[$k]['StartTime'] = date('H:i',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                    $ridesArr[$k]['EndTime'] = date('H:i',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
                }
                else {
                    $ridesArr[$k]['StartTime'] = date('h:i A',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                    $ridesArr[$k]['EndTime'] = date('h:i A',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
                }
                $ridesArr[$k]['fDuration'] = $this->convertSecToMin($ride['fDuration']);
                $ridesArr[$k]['fPrice'] = formateNumAsPerCurrency($fPrice,$vCurrencyPassenger);
                $ridesArr[$k]['PriceLabel'] = $langLabels['LBL_RIDE_SHARE_PER_PASSENGER_TXT'];
                $ridesArr[$k]['AvailableSeats'] = $ride['iAvailableSeats'];
                $ridesArr[$k]['tDriverDetails'] = $ride['tDriverDetails'];
                $ridesArr[$k]['carDetails'] = $this->carDetails($ride['tDriverDetails']);
                $ridesArr[$k]['tStartCity'] = $ride['tStartCity'];
                $ridesArr[$k]['tEndCity'] = $ride['tEndCity'];
                $ridesArr[$k]['iPublishedRideId'] = $ride['iPublishedRideId'];
                $ridesArr[$k]['vPublishedRideNo'] = $ride['vPublishedRideNo'];
                $ridesArr[$k]['vPublishedRideNoTxt'] = $langLabels['LBL_RIDE_SHARE_PUBLISH_NO'].' #'.$ride['vPublishedRideNo'];
                $ridesArr[$k]['tDocumentIds'] = $this->userUploadedDocument($vLang,$iUserId,'No');
                $ridesArr[$k]['BookingList'] = $BookingListArr;
                $ridesArr[$k]['eApproveDoc'] = $ride['eApproveDoc'];
                $ridesArr[$k]['eJobType'] = "RideSharing";
                if(!empty($ride['iCancelReasonId'])){
                    $vCancelReason = get_value('cancel_reason',"vTitle_".$vLang,'iCancelReasonId',$ride['iCancelReasonId'],'','true');
                }
                else {
                    $vCancelReason = $ride['tCancelReason'];
                }
                $ridesArr[$k]['tCancelReason'] = $vCancelReason;
                if($ride['eTrackingStatus'] == 'PaymentCollect'){
                    $UsersAvgRatingForRide = $this->getUsersAvgRatingForRide($ride['iPublishedRideId']);
                    if(isset($UsersAvgRatingForRide['fRating'])&& !empty($UsersAvgRatingForRide['fRating'])){
                        $ridesArr[$k]['USERS_AVG_RATING_FOR_RIDE'] = $UsersAvgRatingForRide['fRating'];
                    }
                }
                if(empty($iPublishedRideId)&& $Expired == 0){
                    $currDate = date('Y-m-d H:i:s');
                    $dStartDate = $ride['dStartDate'];
                    $datediff = abs(strtotime($dStartDate)- strtotime($currDate))/ 60;
                    $additional_mins_into_secs = $START_TRIP_BTN_SHOW_BEFORE_SPECIFIC_TIME;
                    $ridesArr[$k]['Btn_StartTrip'] = 'No';
                    $ridesArr[$k]['Btn_TripDetails'] = 'No';
                    if($datediff > $additional_mins_into_secs && strtotime($dStartDate)> strtotime($currDate)){
                        $ridesArr[$k]['Btn_StartTrip'] = 'No';
                        $ridesArr[$k]['Btn_TripDetails'] = 'No';
                    }
                    else if($ride['eTrackingStatus'] == "Pending" && $ride['iBookedSeats'] > 0 && $ride['eStatus'] == "Active"){
                        $ridesArr[$k]['Btn_StartTrip'] = 'Yes';
                        $ridesArr[$k]['BTN_TEXT'] = $langLabels['LBL_RIDE_SHARE_START_TRIP'];
                    }
                    if(in_array($ride['eTrackingStatus'],['Start', 'End', 'MarkAsPickupALL'])&& $ride['eStatus'] == "Active"){
                        $ridesArr[$k]['Btn_TripDetails'] = 'Yes';
                        $ridesArr[$k]['BTN_TEXT'] = $langLabels['LBL_RIDE_SHARE_TRIP_DETAILS'];
                    }
                    $ridesArr[$k]['RideState'] = $this->RideState($ride['iPublishedRideId'],$iUserId);
                }
                else {
                }
                $ridesArr[$k]['isExpired'] = $Expired;
                if($this->IsAnyDocumentActive()){
                    if($ride['eApproveDoc'] == "No" && $Expired == 0 && $ridesArr[$k]['Btn_StartTrip'] == "No"){
                        $ridesArr[$k]['DocReviewMes'] = $langLabels['LBL_RIDE_SHARE_DOCUMNET_IN_REVIEW'];
                        if(!empty($iPublishedRideId)){
                            $ridesArr[$k]['DocReviewMes'] = $langLabels['LBL_RIDE_SHARE_DOCUMENT_UNDER_REVIEW'];
                        }
                    }
                }
                $ridesArr[$k]['isCancelbuttonHide'] = 'No';
                if(in_array($ride['eTrackingStatus'],['Start', 'MarkAsPickupALL', 'End', 'PaymentCollect'])|| $Expired == 1){
                    $ridesArr[$k]['isCancelbuttonHide'] = 'Yes';
                }
                if($SYSTEM_TYPE == "WEB"){
                    if($ride['eStatus'] == "Cancelled"){
                        $displayStatus = $langLabels["LBL_CANCELLED"];
                    }
                    else if(in_array($ride['eTrackingStatus'],['PaymentCollect'])){
                        $displayStatus = $langLabels["LBL_COMPLETED"];
                    }
                    else if(in_array($ride['eTrackingStatus'],['Start','MarkAsPickupALL','End'])){
                        $displayStatus = $langLabels["LBL_INPROCESS"];
                    }
                    else if(in_array($ride['eTrackingStatus'],['Pending'])){
                        $displayStatus = $langLabels["LBL_UPCOMING"];
                    }
                    else if($Expired == 1){
                        $displayStatus = $langLabels["LBL_EXPIRED_TXT"];
                    }
                    $ridesArr[$k]['TripStatus'] = $displayStatus;
                }
            }
            if($SYSTEM_TYPE != "WEB"){
                $total = scount($ridesArr);
                $per_page = 10;
                $totalPages = ceil($total / $per_page);
                $start_limit =($page - 1)* $per_page;
                $ridesArr = array_slice($ridesArr,$start_limit,$per_page);
                if($totalPages > $page){
                    $returnArr['NextPage'] =($page + 1);
                }
                else {
                    $returnArr['NextPage'] = "0";
                }
            }
            $returnArr['Action'] = "1";
            $returnArr['message'] = $ridesArr;
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_RIDE_SHARE_NO_PUBLISHED_RIDES_FOUND_TXT";
            $returnArr['message_title'] = "LBL_RIDE_SHARE_NO_PUBLISHED_RIDES_FOUND_TITLE";
        }
        if(empty($iPublishedRideId)){
            $returnArr['vSubFilterParam'] = $vFilterParam;
            $filterarray = array('Upcoming' => $langLabels["LBL_UPCOMING"], 'Inprocess' => $langLabels["LBL_INPROCESS"], 'Completed' => $langLabels["LBL_COMPLETED"], 'Cancelled' => $langLabels["LBL_CANCELLED"], 'Expired' => $langLabels["LBL_EXPIRED_TXT"]);
            $returnArr['vSelectedFilterTitle'] = isset($filterarray[$vFilterParam])? $filterarray[$vFilterParam] : '';
            $returnArr['subFilterOption'] = array(array('vSubFilterParam' => 'Upcoming', 'vTitle' => $langLabels["LBL_UPCOMING"]), array('vSubFilterParam' => 'Inprocess', 'vTitle' => $langLabels["LBL_INPROCESS"]), array('vSubFilterParam' => 'Completed', 'vTitle' => $langLabels["LBL_COMPLETED"]), array('vSubFilterParam' => 'Cancelled', 'vTitle' => $langLabels["LBL_CANCELLED"]), array('vSubFilterParam' => 'Expired', 'vTitle' => $langLabels["LBL_EXPIRED_TXT"]));
        }
        if($SYSTEM_TYPE == "WEB"){
            return $returnArr;
        }
        else {
            setDataResponse($returnArr);
        }
    }
    public function getFilterPriority($iUserId){
        global $obj;
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $date_ = date("Y-m-d H:i:s");
        $serverTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $todaydate = $date_;
        }
        $inprocess_data = $obj->MySQLSelect("SELECT count(*)as count FROM `published_rides` WHERE iUserId = ".$iUserId." AND eTrackingStatus IN('Start','MarkAsPickupALL','End')AND eStatus != 'Cancelled' ");
        $inprocessCount = $inprocess_data[0]['count'];
        $filter = "Completed";
        if(!empty($inprocessCount)){
            $filter = 'Inprocess';
        }
        else {
            $time = time();
            $date2 = strtotime('-2 hours',$time);
            $todaydate2 = date('Y-m-d H:i:s',$date2);
            $upcoming_data = $obj->MySQLSelect("SELECT count(*)as count FROM `published_rides` WHERE iUserId = ".$iUserId." AND eTrackingStatus IN('Pending')AND dStartDate > '$todaydate2' AND eStatus != 'Cancelled' ");
            $upcomingCount = $upcoming_data[0]['count'];
            if(!empty($upcomingCount)){
                $filter = 'Upcoming';
            }
        }
        $res['filter'] = $filter;
        return $res;
    }
    public function checkAnyPendingRemaining($iPublishedRideIds){
        global $obj;
        $iPublishedRideIds = implode(',',$iPublishedRideIds);
        $ride_share_bookings = $obj->MySQLSelect("SELECT iPublishedRideId,eStatus FROM `ride_share_bookings` WHERE iPublishedRideId IN($iPublishedRideIds)AND eStatus = 'Pending'");
        $FINAL_RIDE_SHARE_BOOKINGS = [];
        if(isset($ride_share_bookings)&& !empty($ride_share_bookings)){
            foreach($ride_share_bookings as $booking){
                $FINAL_RIDE_SHARE_BOOKINGS[$booking['iPublishedRideId']] = $booking;
            }
        }
        return $FINAL_RIDE_SHARE_BOOKINGS;
    }
    public function BookingList($vLang,$iPublishedRideId,$notAllowedUserId = [],$type = ''){
        global $obj,$tconfig,$LANG_OBJ,$currencyAssociateArr;
        $langLabels = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $ssql = "";
        if($type == "SearchRide" || $type == "Booking" || $type == "publishRidePaymentSummery" || $type == "PublishRideTripStart"){
            $ssql .= " AND rsb.eStatus = 'Approved' ";
        }
        $sql = "SELECT CONCAT(riderDriver.vName,' ',riderDriver.vLastName)AS driver_Name, CONCAT(riderUser.vName,' ',riderUser.vLastName)AS rider_Name, CONCAT('+', riderUser.vPhoneCode,riderUser.vPhone)AS rider_Phone, riderUser.vImgName as rider_ProfileImg, riderUser.iUserId as rider_iUserId, riderDriver.iUserId as driver_iUserId, riderDriver.vCurrencyPassenger, COALESCE(prw.tStartLocation, pr.tStartLocation)AS tStartLocation, COALESCE(prw.tStartLat, pr.tStartLat)AS tStartLat, COALESCE(prw.tStartLong, pr.tStartLong)AS tStartLong, COALESCE(prw.tEndLocation, pr.tEndLocation)AS tEndLocation, COALESCE(prw.tEndLat, pr.tEndLat)AS tEndLat, COALESCE(prw.tEndLong, pr.tEndLong)AS tEndLong, COALESCE(prw.vSPoint, pr.vSPoint)AS vSPoint, COALESCE(prw.vDPoint, pr.vDPoint)AS vDPoint, pr.eTrackingStatus, pr.dStartDate, pr.dStartDate, pr.dEndDate, pr.tPriceRatio, pr.tEndCity, pr.tStartCity, pr.iAvailableSeats, pr.eTrackingStatus, rsb.fTax1,rsb.fTax2,rsb.fTax1Percentage,rsb.fTax2Percentage, rsb.iPublishedRideId,rsb.eStatus,rsb.fTotal,rsb.iBookedSeats,pr.tDriverDetails,rsb.iBookingId,rsb.iCancelReasonId,rsb.tCancelReason, rsb.vBookingNo, rsb.fTotal, rsb.fBookingFee, rsb.fPricePerSeat, rsb.fWalletDebit, rsb.ePaymentOption FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)LEFT JOIN published_rides_waypoints prw ON(prw.iPublishedRideWayPointId = rsb.iPublishedRideWayPointId)LEFT JOIN register_user riderUser ON(riderUser.iUserId = rsb.iUserId)LEFT JOIN register_user riderDriver ON(riderDriver.iUserId = pr.iUserId)WHERE pr.iPublishedRideId = {
            $iPublishedRideId
        }
        $ssql ORDER BY rsb.eStatus ASC";
        $rideShareBookings = $obj->MySQLSelect($sql);
        $bookingArr = [];
        if(isset($rideShareBookings)&& !empty($rideShareBookings)){
            $i = 0;
            foreach($rideShareBookings as $booking){
                if(in_array($booking['rider_iUserId'],$notAllowedUserId)){
                    continue;
                }
                $profile = '';
                if(isset($booking['rider_ProfileImg'])&& !empty($booking['rider_ProfileImg'])){
                    if(file_exists($tconfig["tsite_upload_images_passenger_path"].'/'.$booking['rider_iUserId'].'/3_'.$booking['rider_ProfileImg'])){
                        $profile = $tconfig["tsite_upload_images_passenger"].'/'.$booking['rider_iUserId'].'/3_'.$booking['rider_ProfileImg'];
                    }
                }
                if(isset($booking['vSPoint'])&& !empty($booking['vSPoint'])&& isset($booking['vDPoint'])&& !empty($booking['vDPoint'])){
                    $bookingArr[$i]['tLocation'] = 'Location '.$booking['vSPoint'].' - '.$booking['vDPoint'];
                }
                $bookingArr[$i]['driver_Name'] = $booking['driver_Name'];
                $bookingArr[$i]['rider_Name'] = $booking['rider_Name'];
                $bookingArr[$i]['rider_Phone'] = $booking['rider_Phone'];
                $bookingArr[$i]['rider_ProfileImg'] = $profile;
                $bookingArr[$i]['eStatus'] = $booking['eStatus'];
                $bookingArr[$i]['iBookingId'] = $booking['iBookingId'];
                $bookingArr[$i]['vBookingNo'] = $booking['vBookingNo'];
                $bookingArr[$i]['vBookingNoTxt'] = $langLabels['LBL_RIDE_SHARE_BOOKING_NO'].' #'.$booking['vBookingNo'];
                $bookingArr[$i]['tEndCity'] = $booking['tEndCity'];
                $bookingArr[$i]['tStartCity'] = $booking['tStartCity'];
                $bookingArr[$i]['rider_iUserId'] = $booking['rider_iUserId'];
                $bookingArr[$i]['iAvailableSeats'] = $booking['iAvailableSeats'];
                $bookingArr[$i]['iBookedSeats'] = $booking['iBookedSeats'];
                $bookingArr[$i]['BookedSeatsTxt'] = str_replace('#SEATS#',$booking['iBookedSeats'],$langLabels['LBL_RIDE_SHARE_BOOKED_PASSENGERS_TXT']);
                if($type == 'PublishedRide'){
                    if($booking['eTrackingStatus'] == "PaymentCollect" && !in_array($booking['eStatus'],['Declined', 'Cancelled'])){
                        $bookingArr[$i]['IS_RATING_SHOW'] = "Yes";
                        $getRating = $this->getRating($booking['iBookingId'],'Driver');
                        if(isset($getRating)&& !empty($getRating)){
                            $bookingArr[$i]['rating'] = $getRating[0]['fRating'];
                        }
                    }
                    else {
                        if($booking['eStatus'] == 'Pending'){
                            $statusMessage = $langLabels['LBL_RIDE_SHARE_PENDING_MESSAGE'];
                        }
                        else if($booking['eStatus'] == 'Approved'){
                            $statusMessage = str_replace('#USERNAME#',$booking['rider_Name'],$langLabels['LBL_RIDE_SHARE_APPROVED_MESSAGE']);
                        }
                        else if($booking['eStatus'] == 'Declined'){
                            $statusMessage = str_replace('#USERNAME#',$booking['rider_Name'],$langLabels['LBL_RIDE_SHARE_DECLINE_MESSAGE']);
                            if(!empty($booking['iCancelReasonId'])){
                                $vCancelReason = get_value('cancel_reason',"vTitle_".$vLang,'iCancelReasonId',$booking['iCancelReasonId'],'','true');
                            }
                            else {
                                $vCancelReason = $booking['tCancelReason'];
                            }
                            $bookingArr[$i]['DeclineReason'] = $vCancelReason;
                        }
                        else if($booking['eStatus'] == 'Cancelled'){
                            $statusMessage = str_replace('#USERNAME#',$booking['rider_Name'],$langLabels['LBL_RIDE_SHARE_CANCEL_MESSAGE']);
                            if(!empty($booking['iCancelReasonId'])){
                                $vCancelReason = get_value('cancel_reason',"vTitle_".$vLang,'iCancelReasonId',$booking['iCancelReasonId'],'','true');
                            }
                            else {
                                $vCancelReason = $booking['tCancelReason'];
                            }
                            $bookingArr[$i]['DeclineReason'] = $vCancelReason;
                        }
                        $bookingArr[$i]['statusMessage'] = $statusMessage;
                    }
                }
                $priceRatio = $currencyAssociateArr[$booking['vCurrencyPassenger']]['Ratio'];
                $fPricePerSeatTotal = $booking['fPricePerSeat'] * $booking['iBookedSeats'] * $priceRatio;
                $fBookingFee = $booking['fBookingFee'] * $priceRatio;
                $fWalletDebit = $booking['fWalletDebit'] * $priceRatio;
                $fTotalAmount =($booking['fTotal'] - $booking['fWalletDebit'])* $priceRatio;
                if($booking['ePaymentOption'] == "Cash"){
                    $bookingArr[$i]['PaymentLabel'] = $langLabels['LBL_RIDE_SHARE_PASSENGER_PAY_IN_CASH'];
                    $bookingArr[$i]['PaymentModeLabel'] = $langLabels['LBL_CASH_TXT'];
                }
                elseif($booking['ePaymentOption'] == "Card"){
                    $bookingArr[$i]['PaymentLabel'] = $langLabels['LBL_RIDE_SHARE_PASSENGER_PAY_CARD'];
                    $bookingArr[$i]['PaymentModeLabel'] = $langLabels['LBL_CARD'];
                }
                else {
                    $bookingArr[$i]['PaymentLabel'] = $langLabels['LBL_RIDE_SHARE_PASSENGER_PAY_WALLET'];
                    $bookingArr[$i]['PaymentModeLabel'] = $langLabels['LBL_WALLET_TXT'];
                }
                $bookingArr[$i]['PaymentModeTitle'] = $langLabels['LBL_PAYMENT_MODE_TXT'];
                $bookingArr[$i]['PriceBreakdown'] = "";
                $bookingArr[$i]['TotalFare'] = formateNumAsPerCurrency($fTotalAmount,$booking['vCurrencyPassenger']);
                $bookingArr[$i]['PriceBreakdownTitle'] = $langLabels['LBL_FARE_BREAKDOWN_TXT'];
                $bookingArr[$i]['PaymentNote'] = "";
                $arrindex = 0;
                $priceBreakdownArr = array();
                $priceBreakdownArr[$arrindex][$langLabels['LBL_RIDE_SHARE_PRICE_PER_SEAT_TOTAL_TXT'].'(X '.$booking['iBookedSeats'].')'] = formateNumAsPerCurrency($fPricePerSeatTotal,$booking['vCurrencyPassenger']);
                $arrindex++;
                if($booking['fTax1'] > 0){
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_TAX1_TXT']." @ ".$booking['fTax1Percentage']." % "] = formateNumAsPerCurrency($booking['fTax1'],$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                if($booking['fTax2'] > 0){
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_TAX1_TXT']." @ ".$booking['fTax2Percentage']." % "] = formateNumAsPerCurrency($booking['fTax2'],$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                if($fBookingFee > 0){
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_RIDE_SHARE_BOOKING_FEES_TXT']] = formateNumAsPerCurrency($fBookingFee,$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                if($booking['fWalletDebit'] > 0){
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_WALLET_ADJUSTMENT']] = "-".formateNumAsPerCurrency($fWalletDebit,$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                $priceBreakdownArr[$arrindex]['eDisplaySeperator'] = "Yes";
                $arrindex++;
                if($booking['ePaymentOption'] == "Cash"){
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_RIDE_SHARE_COLLECT_FROM_USER_TXT']] = formateNumAsPerCurrency($fTotalAmount,$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                else {
                    $bookingArr[$i]['PaymentNote'] = $langLabels['LBL_RIDE_SHARE_PAYMENT_NOTE'];
                    $priceBreakdownArr[$arrindex][$langLabels['LBL_RIDE_SHARE_TOTAL_PRICE']] = formateNumAsPerCurrency($fTotalAmount,$booking['vCurrencyPassenger']);
                    $arrindex++;
                }
                $bookingArr[$i]['PriceBreakdown'] = $priceBreakdownArr;
                $bookingArr[$i]['eShowCallImg'] = "No";
                if($booking['eStatus'] == 'Approved'){
                    $bookingArr[$i]['eShowCallImg'] = "Yes";
                }
                if($booking['eStatus'] == 'Approved' && $booking['eTrackingStatus'] == "PaymentCollect"){
                    $bookingArr[$i]['eShowCallImg'] = "No";
                }
                $bookingArr[$i]['tStartLocation'] = $booking['tStartLocation'];
                $bookingArr[$i]['tEndLocation'] = $booking['tEndLocation'];
                $i++;
            }
        }
        return $bookingArr;
    }
    public function getRating($iBookingId,$eFromUserType){
        global $obj;
        $ride_share_bookings = $obj->MySQLSelect("SELECT fRating,tMessage FROM `ride_share_ratings` WHERE iBookingId = $iBookingId AND eFromUserType = '".$eFromUserType."' ");
        return $ride_share_bookings;
    }
    public function getWayPointsFromTheDb($iPublishedRideId,$fRatioCurrency = '',$vCurrencyPassenger = '',$sourceDestinationPrice = ''){
        global $obj;
        $sql = "SELECT * FROM `published_rides_waypoints` WHERE `iPublishedRideId` = {
            $iPublishedRideId
        }
        ORDER BY iPublishedRideWayPointId ASC";
        $published_rides_waypoints = $obj->MySQLSelect($sql);
        $wayPoint = $this->wayPointDBToArray($published_rides_waypoints,$fRatioCurrency,$vCurrencyPassenger,$sourceDestinationPrice);
        if(!empty($wayPoint)){
            $ARR['wayPoint'] = $wayPoint['wayPoint'];
            $ARR['waypoint_data'] = isset($wayPoint['waypoint_data'])? $wayPoint['waypoint_data'] : '';
            $ARR['WayPointPrice'] = isset($wayPoint['WayPointPrice'])? $wayPoint['WayPointPrice'] : '';
            $ARR['DestLocationPoint'] = isset($wayPoint['DestLocationPoint'])? $wayPoint['DestLocationPoint'] : '';
            $ARR['SourceLocationPoint'] = isset($wayPoint['SourceLocationPoint'])? $wayPoint['SourceLocationPoint'] : '';
        }
        return $ARR;
    }
    public function wayPointDBToArray($published_rides_waypoints,$fRatioCurrency = 0,$vCurrencyPassenger = '',$sourceDestinationPrice = 0){
        $ARR = [];
        $ARR['wayPoint'] = '';
        if(isset($published_rides_waypoints)&& !empty($published_rides_waypoints)){
            $WayPointPrice = $PointRecommendedPrice = [];
            $StartLetter = $letter = 'A';
            $ARR['SourceLocationPoint'] = $StartLetter;
            foreach($published_rides_waypoints as $waypoint){
                $fPrice = formateNumAsPerCurrency(($waypoint['fPrice'] * $fRatioCurrency),$vCurrencyPassenger);
                $waypointArr['startPoint']['long'] = $waypoint['tStartLat'];
                $waypointArr['startPoint']['lat'] = $waypoint['tStartLong'];
                $waypointArr['startPoint']['add'] = $waypoint['tStartLong'];
                $waypointArr['endPoint']['long'] = $waypoint['tEndLong'];
                $waypointArr['endPoint']['lat'] = $waypoint['tEndLat'];
                $waypointArr['endPoint']['add'] = $waypoint['tEndLocation'];
                $waypointArr['recommended_price'] = $fPrice;
                $waypointArr['duration'] = $waypoint['fDuration'];
                $waypointArr['dStartDate'] = $waypoint['dStartDate'];
                $waypointArr['dEndDate'] = $waypoint['dEndDate'];
                $l = $letter;
                $letter = ord($letter)+ 1;
                $letter1 = $letter = chr($letter);
                $WayPointPrice[]['Location '.$l.' - '.$letter1] = $fPrice;
                $waypointArr['letterPoint'] = $letter1;
                $PointRecommendedPrice[] = $waypointArr;
            }
            $ARR['DestLocationPoint'] = $letter;
            $WayPointPrice[]['Location '.$StartLetter.' - '.$letter1] = formateNumAsPerCurrency($sourceDestinationPrice,$vCurrencyPassenger);
            $WayPointsWithOtherData = $this->getWayPointsWithOtherDataForDisplay(json_encode($PointRecommendedPrice));
            $getWayPoints = $this->getWayPointsForDisplay(json_encode($PointRecommendedPrice));
            $ARR['wayPoint'] = $getWayPoints['wayPoint'];
            $ARR['waypoint_data'] = $WayPointsWithOtherData['wayPoint'];
            $ARR['WayPointPrice'] = $WayPointPrice;
        }
        return $ARR;
    }
    public function getWayPointsForDisplay($PointRecommendedPrice){
        $wayPoint = [];
        if(!empty($PointRecommendedPrice)){
            $PointRecommendedPrice = json_decode($PointRecommendedPrice,true);
            $wayPointCount = 1;
            $totalCount = scount($PointRecommendedPrice);
            foreach($PointRecommendedPrice as $key => $point){
                if($key == 0){
                    $wayPoint[] = $point['endPoint']['add'];
                    $wayPointCount++;
                }
                else if($key ==($totalCount - 1)){
                }
                else {
                    $wayPoint[] = $point['endPoint']['add'];
                    $wayPointCount++;
                }
            }
        }
        $ARR['wayPoint'] = $wayPoint;
        return $ARR;
    }
    public function convertSecToMin($seconds){
        $minutes = floor(calculate($seconds , 60 , '/'));
        return convertMinToHoursToDays($minutes,'Minutes',1);
    }
    public function carDetails($tDriverDetails){
        global $tconfig;
        $tDriverDetails = json_decode($tDriverDetails,true);
        $return = [];
        $cMake = $cNote = $cModel = $cColor = $cNumberPlate = $cImage = '';
        if(isset($tDriverDetails)&& !empty($tDriverDetails)){
            foreach($tDriverDetails as $Details){
                $iData = $Details['iData'];
                if($Details['iData'] == 'cNote' || $Details['iData'] == 'cMake' || $Details['iData'] == 'cModel' || $Details['iData'] == 'cImage' || $Details['iData'] == 'cNumberPlate' || $Details['iData'] == 'cColor'){
                    if($Details['iData'] == 'cImage'){
                        $Details['value'] = $tconfig["tsite_upload_images_driver_car_ride_share"].'/'.$Details['value'];
                    }
                    $$iData = $Details['value'];
                }
            }
        }
        $cNote_new = $cNote;
        $return = array('cNote' => $cNote_new, 'cModel' => $cModel.' - '.$cColor, 'cMake' => $cMake, 'cNumberPlate' => $cNumberPlate, 'cImage' => $cImage);
        return $return;
    }
    public function userUploadedDocument($vLang,$iUserId,$isDocumentEditable = "Yes"){
        global $obj,$tconfig;
        $documents = $obj->MySQLSelect("SELECT rdl.ex_date,rdl.doc_file,rdl.doc_id,dm.doc_masterid, dm.ex_status, dm.doc_name_$vLang as doc_name FROM ride_share_document_list rdl LEFT JOIN document_master as dm ON(rdl.doc_masterid = dm.doc_masterid)WHERE dm.doc_usertype = 'user' AND rdl.doc_userid = {
            $iUserId
        }
        AND dm.status = 'Active' ORDER BY iDisplayOrder ASC ");
        $img_path = $tconfig["tsite_upload_ride_share_documents"];
        $Photo_Gallery_folder = $img_path.'/'.$iUserId.'/';
        $Photo_Gallery_folder_path = $tconfig["tsite_upload_ride_share_documents_path"].'/'.$iUserId.'/';
        if(!empty($documents)){
            $i = 0;
            foreach($documents as $document){
                $documents[$i]['isDocumentEditable'] = $isDocumentEditable;
                if(empty($document['doc_id'])){
                    $documents[$i]['doc_id'] = '';
                }
                if(empty($document['ex_date'])){
                    $documents[$i]['ex_date'] = '';
                }
                else {
                    if($document['ex_date'] != "0000-00-00"){
                        $exdate_data_array = array('tdate' => $document['ex_date'], 'langCode' => $vLang);
                        $getDocumentExDateFormat = DateformatCls::getNewDateFormat($exdate_data_array);
                        if(!empty($getDocumentExDateFormat)){
                            $documents[$i]['tDisplayDate'] = $getDocumentExDateFormat['tDisplayDate'];
                        }
                    }
                }
                if(empty($document['doc_file'])|| !file_exists($Photo_Gallery_folder_path.$document['doc_file'])){
                    $documents[$i]['doc_file'] = '';
                }
                else {
                    $documents[$i]['doc_file'] = $Photo_Gallery_folder.$document['doc_file'];
                }
                $i++;
            }
        }
        return $documents;
    }
    public function getUsersAvgRatingForRide($iPublishedRideId){
        global $obj;
        $ride_share_ratings = $obj->MySQLSelect("SELECT SUM(fRating)as RatingSum, COUNT(iRideShareRatingId)as Count FROM `ride_share_ratings` WHERE iPublishedRideId = $iPublishedRideId AND eFromUserType = 'Passenger' ");
        $return['fRating'] = 0;
        if($ride_share_ratings[0]['Count'] > 0){
            $return['fRating'] = number_format(($ride_share_ratings[0]['RatingSum'] / $ride_share_ratings[0]['Count']),1);
        }
        return $return;
    }
    public function RideState($iPublishedRideId,$iUserId){
        global $obj,$LANG_OBJ;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $sql = "SELECT eTrackingStatus,tEndLocation,tEndLat,tEndLong,tStartLocation,tStartLat,tStartLong FROM published_rides as pr WHERE pr.iUserId = '".$iUserId."' AND pr.iPublishedRideId = '".$iPublishedRideId."'";
        $published_rides_data = $obj->MySQLSelect($sql);
        $published_rides_data = $published_rides_data[0];
        $TripStateArr = [];
        if($published_rides_data['eTrackingStatus'] == 'Pending'){
            $iPublishedRideIds[] = $iPublishedRideId;
            $PendingBookingRequest = $this->checkAnyPendingRemaining($iPublishedRideIds);
            if(isset($PendingBookingRequest[$iPublishedRideId])&& !empty($PendingBookingRequest[$iPublishedRideId])){
                $TripStateArr['PendingBookingRequest'] = $PendingBookingRequest[$iPublishedRideId];
            }
            $TripStateArr['RideState'] = 'Start';
            $FR = 1;
        }
        if($published_rides_data['eTrackingStatus'] == 'Start' && $FR == 0){
            $TripStateArr['RideState'] = 'MarkAsPickup';
            $TripStateArr['Location'] = $published_rides_data['tStartLocation'];
            $TripStateArr['Latitude'] = $published_rides_data['tStartLat'];
            $TripStateArr['Longitude'] = $published_rides_data['tStartLong'];
            $TripStateArr['Label'] = $languageLabelsArr['LBL_RIDE_SHARE_MARK_AS_ALL_PASSENGER_PICKED_UP'];
            $FR = 1;
        }
        if($published_rides_data['eTrackingStatus'] == 'MarkAsPickupALL' && $FR == 0){
            $TripStateArr['RideState'] = 'TripEnd';
            $TripStateArr['Location'] = $published_rides_data['tEndLocation'];
            $TripStateArr['Latitude'] = $published_rides_data['tEndLat'];
            $TripStateArr['Longitude'] = $published_rides_data['tEndLong'];
            $TripStateArr['Label'] = $languageLabelsArr['LBL_RIDE_SHARE_END_TRIP'];
            $FR = 1;
        }
        if($published_rides_data['eTrackingStatus'] == 'End' && $FR == 0){
            $TripStateArr['RideState'] = 'PaymentCollected';
            $TripStateArr['Label'] = $languageLabelsArr['LBL_RIDE_SHARE_PAYMENT_COLLECTED'];
            $TripStateArr['Payment_summery_user'] = $this->RidePaymentSummery($iPublishedRideId);
        }
        return $TripStateArr;
    }
    public function RidePaymentSummery($iPublishedRide_Id = 0){
        global $LANG_OBJ;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        if($iPublishedRide_Id > 0){
            $iPublishedRideId = $iPublishedRide_Id;
        }
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $BookingListArr = $this->BookingList($vLang,$iPublishedRideId,[],'publishRidePaymentSummery');
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $F_ARR = [];
        if(isset($BookingListArr)&& !empty($BookingListArr)){
            $i = 0;
            foreach($BookingListArr as $arr){
                $F_ARR[$i]['RiderLabel'] = 'Rider '.($i + 1);
                $F_ARR[$i]['rider_Name'] = $arr['rider_Name'];
                $F_ARR[$i]['rider_Phone'] = $arr['rider_Phone'];
                $F_ARR[$i]['TotalFareLabel'] = $languageLabelsArr['LBL_AMOUNT'];
                $F_ARR[$i]['TotalFare'] = $arr['TotalFare'];
                $F_ARR[$i]['PaymentModeTitle'] = $arr['PaymentModeTitle'];
                $F_ARR[$i]['PaymentModeLabel'] = $arr['PaymentModeLabel'];
                $F_ARR[$i]['iBookedSeatsLabel'] = $languageLabelsArr['LBL_RIDE_SHARE_BOOKED_SEATS'];
                $F_ARR[$i]['iBookedSeats'] = $arr['iBookedSeats'];
                $F_ARR[$i]['tStartLocation'] = $arr['tStartLocation'];
                $F_ARR[$i]['tEndLocation'] = $arr['tEndLocation'];
                $F_ARR[$i]['vBookingNoTxt'] = $arr['vBookingNo'];
                $F_ARR[$i]['iBookingId'] = $arr['iBookingId'];
                $getRating = $this->getRating($arr['iBookingId'],'Passenger');
                if(isset($getRating)&& !empty($getRating)){
                    $F_ARR[$i]['rating'] = $getRating[0]['fRating'];
                    $F_ARR[$i]['tMessage'] = $getRating[0]['tMessage'];
                }
                $getRating = $this->getRating($arr['iBookingId'],'Driver');
                if(isset($getRating)&& !empty($getRating)){
                    $F_ARR[$i]['UserRating'] = $getRating[0]['fRating'];
                    $F_ARR[$i]['UserMessage'] = $getRating[0]['tMessage'];
                }
                $i++;
            }
        }
        return $F_ARR;
    }
    public function is_base64($s){
        return(bool)preg_match('/^[a-zA-Z0-9\/\r\n+]*= {
            0,2
        }
        $/',$s);
    }
    public function searchRide(){
        global $ONLY_ENABLE_RIDE_SHARING_PRO,$obj,$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE,$LIST_RIDES_LIMIT_BY_DEST_DISTANCE,$LANG_OBJ,$tconfig,$RIDE_SHARE_BOOKING_FEE,$ENABLE_24_HOUR_FORMAT;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $tEndLat = isset($_REQUEST["tEndLat"])?$_REQUEST["tEndLat"]:'';
        $tEndLong = isset($_REQUEST["tEndLong"])?$_REQUEST["tEndLong"]:'';
        $dStartDate = isset($_REQUEST["dStartDate"])?$_REQUEST["dStartDate"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $NoOfSeats = isset($_REQUEST["NoOfSeats"])?$_REQUEST["NoOfSeats"]:'1';
        $vFilterParam = isset($_REQUEST["vFilterParam"])?$_REQUEST["vFilterParam"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $Departure = isset($_REQUEST["Departure"])?$_REQUEST["Departure"]:'';
        $dStartDate = date('Y-m-d',strtotime($dStartDate));
        $serverTimeZone = date_default_timezone_get();
        $currentDate = date('Y-m-d H:i:s');
        $startTime = $dStartDate." 00:00:00";
        $endTime = $dStartDate." 23:59:00";
        $startTimeServer = converToTz($startTime,$serverTimeZone,$vTimeZone);
        $endTimeeServer = converToTz($endTime,$serverTimeZone,$vTimeZone);
        $sql_cur = " pr.dStartDate BETWEEN '".$startTimeServer."' AND '".$endTimeeServer."'";
        if($dStartDate == date('Y-m-d')){
            $sql_cur = $sql_cur." AND pr.dStartDate >= '".$currentDate."'";
        }
        $sql_cur_prw = " prw.dStartDate BETWEEN '".$startTimeServer."' AND '".$endTimeeServer."'";
        if($dStartDate == date('Y-m-d')){
            $sql_cur_prw = $sql_cur_prw." AND prw.dStartDate >= '".$currentDate."'";
        }
        if($Departure == "Before"){
            $sql_cur = " pr.dStartDate BETWEEN '".$currentDate."' AND '".$startTimeServer."' ";
            $sql_cur_prw = " prw.dStartDate BETWEEN '".$currentDate."' AND '".$startTimeServer."' ";
        }
        if($Departure == "After"){
            $sql_cur = " pr.dStartDate >= '".$startTimeServer."'";
            $sql_cur_prw = " prw.dStartDate >= '".$startTimeServer."'";
        }
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $page = isset($_REQUEST['page'])?trim($_REQUEST['page']):1;
        $order_param = " dStartDate ASC ";
        if(!empty($vFilterParam)){
            if(strtoupper($vFilterParam)== "TIME"){
                $order_param = " pr.dStartDate ASC ";
            }
            elseif(strtoupper($vFilterParam)== "DURATION"){
                $order_param = " pr.fDuration ASC ";
            }
            elseif(strtoupper($vFilterParam)== "PRICELOW"){
                $order_param = " pr.fPrice ASC ";
            }
            elseif(strtoupper($vFilterParam)== "PRICEHIGH"){
                $order_param = " pr.fPrice DESC ";
            }
            elseif(strtoupper($vFilterParam)== "RATING"){
            }
        }
        if($this->IsAnyDocumentActive()){
            $sql_cur .= " AND rd.eApproveDoc = 'Yes' ";
            $sql_cur_prw .= " AND rd.eApproveDoc = 'Yes' ";
        }
        $userData = $obj->MySQLSelect("SELECT vCurrencyPassenger FROM register_user WHERE iUserId = '$iUserId' ");
        $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
        $serverTimeZone = date_default_timezone_get();
        $searchSql = "SELECT pr.*, rd.iUserId as iDriverId, CONCAT(rd.vName,' ',rd.vLastName)AS DriverName, CONCAT('+',rd.vPhoneCode,rd.vPhone)AS DriverPhone, rd.iUserId as DriveriUserId , rd.vImgName as DrivervImgName, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(pr.tStartLat, 8)))* cos(radians(ROUND(pr.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(pr.tStartLat, 8))))), 2)AS startDistance, ROUND((6371 * acos(cos(radians(".$tEndLat."))* cos(radians(ROUND(pr.tEndLat, 8)))* cos(radians(ROUND(pr.tEndLong, 8))- radians(".$tEndLong."))+ sin(radians(".$tEndLat."))* sin(radians(ROUND(pr.tEndLat, 8))))), 2)AS endDistance FROM published_rides pr LEFT JOIN register_user rd ON(rd.iUserId = pr.iUserId)WHERE $sql_cur AND pr.eStatus = 'Active' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE." AND endDistance <= ".$LIST_RIDES_LIMIT_BY_DEST_DISTANCE." ORDER BY $order_param ";
        if($this->isOnlyEnableRideSharingPro){
            $order_param = " SD ASC ";
            $searchSql = "SELECT pr.dStartDate as SD, '' as iPublishedRideWayPointId,pr.tPriceRatio,pr.iPublishedRideId,pr.fPrice,pr.iAvailableSeats,pr.tStartLocation,pr.tStartLat,pr.tStartLong,pr.tEndLocation,pr.tEndLat,pr.tEndLong,pr.fDuration,pr.dStartDate,pr.dEndDate,pr.iAvailableSeats,pr.tDriverDetails,pr.iPublishedRideId,pr.tStartCity,pr.tEndCity,pr.vPublishedRideNo, rd.iUserId as iDriverId, CONCAT(rd.vName,' ',rd.vLastName)AS DriverName, CONCAT('+',rd.vPhoneCode,rd.vPhone)AS DriverPhone, rd.iUserId as DriveriUserId , rd.vImgName as DrivervImgName, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(pr.tStartLat, 8)))* cos(radians(ROUND(pr.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(pr.tStartLat, 8))))), 2)AS startDistance, ROUND((6371 * acos(cos(radians(".$tEndLat."))* cos(radians(ROUND(pr.tEndLat, 8)))* cos(radians(ROUND(pr.tEndLong, 8))- radians(".$tEndLong."))+ sin(radians(".$tEndLat."))* sin(radians(ROUND(pr.tEndLat, 8))))), 2)AS endDistance FROM published_rides pr LEFT JOIN register_user rd ON(rd.iUserId = pr.iUserId)WHERE $sql_cur AND pr.eStatus = 'Active' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats AND(pr.iAvailableSeats -(pr.iBookedSeats +(SELECT IFNULL(MAX(iBookedSeats),0)AS maxSeats FROM published_rides_waypoints WHERE iPublishedRideId = pr.iPublishedRideId)))>= $NoOfSeats HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE." AND endDistance <= ".$LIST_RIDES_LIMIT_BY_DEST_DISTANCE." UNION ALL SELECT prw.dStartDate as SD, prw.iPublishedRideWayPointId,prw.tPriceRatio,prw.iPublishedRideId,prw.fPrice,prw.iAvailableSeats,prw.tStartLocation,prw.tStartLat,prw.tStartLong,prw.tEndLocation,prw.tEndLat,prw.tEndLong,prw.fDuration,prw.dStartDate,prw.dEndDate,prw.iAvailableSeats,pr.tDriverDetails,prw.iPublishedRideId,pr.tStartCity,pr.tEndCity,pr.vPublishedRideNo, rd.iUserId as iDriverId, CONCAT(rd.vName,' ',rd.vLastName)AS DriverName, CONCAT('+',rd.vPhoneCode,rd.vPhone)AS DriverPhone, rd.iUserId as DriveriUserId , rd.vImgName as DrivervImgName, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(prw.tStartLat, 8)))* cos(radians(ROUND(prw.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(prw.tStartLat, 8))))), 2)AS startDistance, ROUND((6371 * acos(cos(radians(".$tEndLat."))* cos(radians(ROUND(prw.tEndLat, 8)))* cos(radians(ROUND(prw.tEndLong, 8))- radians(".$tEndLong."))+ sin(radians(".$tEndLat."))* sin(radians(ROUND(prw.tEndLat, 8))))), 2)AS endDistance FROM published_rides_waypoints prw LEFT JOIN published_rides pr ON(pr.iPublishedRideId = prw.iPublishedRideId)LEFT JOIN register_user rd ON(rd.iUserId = prw.iUserId)WHERE $sql_cur_prw AND pr.eStatus = 'Active' AND pr.eTrackingStatus = 'Pending' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats &&((pr.iAvailableSeats - pr.iBookedSeats)- prw.iBookedSeats)>= $NoOfSeats HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_SOURCE_DISTANCE." AND endDistance <= ".$LIST_RIDES_LIMIT_BY_DEST_DISTANCE." ORDER BY $order_param ";
        }
        $published_rides = $obj->MySQLSelect($searchSql);
        if($this->isOnlyEnableRideSharingPro){
            $published_rides_data = $this->removeChildRides($published_rides);
            if(isset($published_rides_data)&& !empty($published_rides_data)){
                $published_rides = $published_rides_data;
            }
        }
        $ridesArr = array();
        foreach($published_rides as $k => $ride){
            $profile = '';
            if(isset($ride['DrivervImgName'])&& !empty($ride['DrivervImgName'])){
                if(file_exists($tconfig["tsite_upload_images_passenger_path"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'])){
                    $profile = $tconfig["tsite_upload_images_passenger"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'];
                }
            }
            $tPriceRatio = $ride['tPriceRatio'];
            $tPriceRatio = json_decode($tPriceRatio,true);
            $BookingListArr = $this->BookingList($vLangCode,$ride['iPublishedRideId'],[],'SearchRide');
            $fPrice = $NoOfSeats * $ride['fPrice'];
            $commission = 0;
            $fPrice =($fPrice + $commission)* $tPriceRatio['fRatio_'.$vCurrencyPassenger];
            $iAvailableSeats = str_replace('#NUMBER#',$ride['iAvailableSeats'],$languageLabelsArr['LBL_RIDE_SHARE_NUMBER_MAX_BOOK_SET']);
            $vNoOfPassenger = str_replace('#NUMBER#',$NoOfSeats,$languageLabelsArr['LBL_RIDE_SHARE_FOR_NO_PASSENGER']);
            $perPassengerPrice = $ride['fPrice'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
            $ridesArr[$k]['tStartLocation'] = $ride['tStartLocation'];
            $ridesArr[$k]['tStartLat'] = $ride['tStartLat'];
            $ridesArr[$k]['tStartLong'] = $ride['tStartLong'];
            $ridesArr[$k]['tEndLocation'] = $ride['tEndLocation'];
            $ridesArr[$k]['tEndLat'] = $ride['tEndLat'];
            $ridesArr[$k]['tEndLong'] = $ride['tEndLong'];
            if(isset($ride['iPublishedRideWayPointId'])&& !empty($ride['iPublishedRideWayPointId'])){
            }
            else {
            }
            $ridesArr[$k]['fDuration'] = $this->convertSecToMin($ride['fDuration']);
            $ridesArr[$k]['StartDate'] = DateTime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone),22);
            if(!empty($ride['dStartDate'])|| $ride['dStartDate'] != "0000-00-00"){
                $dstartdate_data_array = array('tdate' => converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone), 'langCode' => $vLang);
                $getdstartDateFormat = DateformatCls::getNewDateFormat($dstartdate_data_array);
                if(!empty($getdstartDateFormat)){
                    foreach($getdstartDateFormat as $dstart_key => $dstart_value){
                        $ridesArr[$k][$dstart_key] = $dstart_value;
                    }
                }
            }
            if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                $ridesArr[$k]['StartTime'] = date('H:i',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                $ridesArr[$k]['EndTime'] = date('H:i',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
            }
            else {
                $ridesArr[$k]['StartTime'] = date('h:i A',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                $ridesArr[$k]['EndTime'] = date('h:i A',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
            }
            $ridesArr[$k]['fToTalPrice'] = formateNumAsPerCurrency($fPrice,$vCurrencyPassenger);
            $ridesArr[$k]['fPrice'] = formateNumAsPerCurrency($perPassengerPrice,$vCurrencyPassenger);
            $ridesArr[$k]['PriceLabel'] = $languageLabelsArr['LBL_RIDE_SHARE_PER_PASSENGER_TXT'];
            $ridesArr[$k]['AvailableSeats'] = $ride['iAvailableSeats'];
            $ridesArr[$k]['tDriverDetails'] = $ride['tDriverDetails'];
            $ridesArr[$k]['carDetails'] = $this->carDetails($ride['tDriverDetails']);
            $ridesArr[$k]['iPublishedRideId'] = $ride['iPublishedRideId'];
            $ridesArr[$k]['iPublishedRideWayPointId'] = $ride['iPublishedRideWayPointId'];
            $DriverDetails = $this->DriverDetails($ride['tDriverDetails']);
            $dName = !empty($DriverDetails['dName'])?$DriverDetails['dName']:$ride['DriverName'];
            $dPhone = !empty($DriverDetails['dPhone'])?"+".$DriverDetails['dPhoneCode'].$DriverDetails['dPhone']:$ride['DriverPhone'];
            $ridesArr[$k]['DriverName'] = $dName;
            $ridesArr[$k]['DriverPhone'] = $dPhone;
            $ridesArr[$k]['iDriverId'] = $ride['iDriverId'];
            $ridesArr[$k]['TRAVEL_PREFERENCES_ARR'] = $this->displayTravelPreferences($ride['iDriverId'])['TRAVEL_PREFERENCES_ARR'];
            $ridesArr[$k]['DriverRating'] = 0;
            $ridesArr[$k]['DriverImg'] = $profile;
            $ridesArr[$k]['tStartCity'] = $ride['tStartCity'];
            $ridesArr[$k]['tEndCity'] = $ride['tEndCity'];
            $ridesArr[$k]['iAvailableSeatsText'] = $iAvailableSeats;
            $ridesArr[$k]['vNoOfPassengerText'] = $vNoOfPassenger;
            $ridesArr[$k]['vPublishedRideNo'] = $ride['vPublishedRideNo'];
            $ridesArr[$k]['vPublishedRideNoTxt'] = $languageLabelsArr['LBL_RIDE_SHARE_PUBLISH_NO'].' #'.$ride['vPublishedRideNo'];
            $ridesArr[$k]['BookingList'] = $BookingListArr;
            $ridesArr[$k]['isBookedByOthers'] = !empty($BookingListArr)&& scount($BookingListArr)> 0?'Yes':'No';
            $ridesArr[$k]['PUBLISHER_AVG_RATING'] = 0;
            $ridesArr[$k]['isContactToDriver'] = 'No';
        }
        $total = scount($ridesArr);
        $per_page = 20;
        $totalPages = ceil($total / $per_page);
        $start_limit =($page - 1)* $per_page;
        $ridesArr = array_slice($ridesArr,$start_limit,$per_page);
        if($totalPages > $page){
            $returnArr['NextPage'] =($page + 1);
        }
        else {
            $returnArr['NextPage'] = "0";
        }
        if(scount($ridesArr)> 0){
            $returnArr['Action'] = "1";
            $returnArr['message'] = $ridesArr;
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_RIDE_SHARE_RIDES_NOT_FOUND";
            if($Departure == ""){
                $startTime = converToTz($startTime,$vTimeZone,$serverTimeZone);
                $startTime = date('Y-m-d',strtotime($startTime));
                $dStartDate = strtotime($startTime);
                $current = strtotime(date('Y-m-d'));
                $datediff = $dStartDate - $current;
                $difference = floor($datediff /(60 * 60 * 24));
                $day = "";
                if($difference == 0){
                    $day = $languageLabelsArr['LBL_Today'];
                }
                else {
                    $day = date('d,M Y',strtotime($startTime));
                    $returnArr['BEFORE_DEPARTURE_TEXT'] = $languageLabelsArr["LBL_BEFORE_DEPARTURE_RIDE_SHARE_TEXT"];
                }
                $returnArr['AFTER_DEPARTURE_TEXT'] = $languageLabelsArr["LBL_AFTER_DEPARTURE_RIDE_SHARE_TEXT"];
                $returnArr['DAY_TEXT'] = $day;
                $returnArr['NO_RIDES_FOR_THIS_DAY_TEXT'] = $languageLabelsArr["LBL_NO_RIDES_FOR_THIS_DAY_RIDE_SHARE_TEXT"];
                $returnArr['CREATE_RIDE_ALERT_TEXT'] = $languageLabelsArr["LBL_NO_CREATE_RIDE_ALERT_RIDE_SHARE_TEXT"];
                $returnArr['IS_RIDE_ALERT_VIEW_OPEN'] = 'Yes';
            }
        }
        setDataResponse($returnArr);
    }
    public function removeChildRides($published_rides){
        $FINAL_ARR = [];
        $REMOVE_ARR = [];
        if(isset($published_rides)&& !empty($published_rides)){
            $publishedId = [];
            foreach($published_rides as $rides){
                if(isset($rides['iPublishedRideWayPointId'])&& empty($rides['iPublishedRideWayPointId'])){
                    $publishedId[] = $rides['iPublishedRideId'];
                }
            }
            $temp = [];
            foreach($published_rides as $rides){
                if(in_array($rides['iPublishedRideId'],$publishedId)&& isset($rides['iPublishedRideWayPointId'])&& !empty($rides['iPublishedRideWayPointId'])){
                    $REMOVE_ARR[] = $rides;
                }
                else {
                    $FINAL_ARR[] = $rides;
                }
            }
        }
        return $FINAL_ARR;
    }
    public function DriverDetails($tDriverDetails){
        global $tconfig;
        $tDriverDetails = json_decode($tDriverDetails,true);
        $return = [];
        if(isset($tDriverDetails)&& !empty($tDriverDetails)){
            foreach($tDriverDetails as $Details){
                $iData = $Details['iData'];
                if($Details['iData'] == 'cImage'){
                    $Details['value'] = $tconfig["tsite_upload_images_driver_car_ride_share"].'/'.$Details['value'];
                }
                $$iData = $Details['value'];
            }
        }
        $return = array('dName' => $dName, 'dPhoneCode' => $dPhoneCode, 'dPhone' => $dPhone);
        return $return;
    }
    public function displayTravelPreferences($UserId){
        global $obj,$vLangCode;
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $sql = "SELECT vTravelPreferencesIds FROM register_user WHERE iUserId = {
            $UserId
        }
        ";
        $register_user_data = $obj->MySQLSelect($sql)[0];
        $TRAVEL_PREFERENCES_ARR = [];
        $Qsql = '';
        if(isset($register_user_data['vTravelPreferencesIds'])&& !empty($register_user_data['vTravelPreferencesIds'])){
            $vTravelPreferencesIds = rtrim($register_user_data['vTravelPreferencesIds'],',');
            $Qsql .= "AND TravelPreferencesId IN($vTravelPreferencesIds)";
            $sql = "SELECT TP.eDeafultSelected,TP.iTravelPreferencesCategoryId,TP.TravelPreferencesId,JSON_UNQUOTE(JSON_VALUE(TP.vTitle, '$.vTitle_".$vLangCode."'))as Title , JSON_UNQUOTE(JSON_VALUE(TPC.vTitle,'$.vTitle_".$vLangCode."'))as TitleCatgeory FROM travel_preferences AS TP JOIN travel_preferences_category AS TPC ON(TP.iTravelPreferencesCategoryId = TPC.iTravelPreferencesCategoryId)WHERE TP.eStatus = 'Active' AND TPC.eStatus = 'Active' $Qsql";
            $travel_preferences = $obj->MySQLSelect($sql);
            if(isset($travel_preferences)&& !empty($travel_preferences)){
                foreach($travel_preferences as $preference){
                    $arr['Title'] = $preference['TitleCatgeory'];
                    $arr['Value'] = $preference['Title'];
                    $TRAVEL_PREFERENCES_ARR[] = $arr;
                }
            }
        }
        $data['TRAVEL_PREFERENCES_ARR'] = $TRAVEL_PREFERENCES_ARR;
        return $data;
    }
    public function bookRide(){
        global $ONLY_ENABLE_RIDE_SHARING_PRO,$ENABLE_TAX_FOR_RIDE_SHARE_SERVICE,$obj,$LANG_OBJ,$RIDE_SHARE_BOOKING_FEE,$EVENT_MSG_OBJ,$tconfig,$WALLET_OBJ,$COMM_MEDIA_OBJ,$ePayWallet;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $iBookNoOfSeats = isset($_REQUEST["iBookNoOfSeats"])?$_REQUEST["iBookNoOfSeats"]:'0';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'0';
        $iPublishedRideWayPointId = isset($_REQUEST["iPublishedRideWayPointId"])?$_REQUEST["iPublishedRideWayPointId"]:'';
        $isFareAuthorized = isset($_REQUEST["isFareAuthorized"])?$_REQUEST["isFareAuthorized"]:'No';
        $iAuthorizePaymentId = isset($_REQUEST["iAuthorizePaymentId"])?$_REQUEST["iAuthorizePaymentId"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $eWalletIgnore = isset($_REQUEST["eWalletIgnore"])?$_REQUEST["eWalletIgnore"]:'No';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $userData = $obj->MySQLSelect("SELECT CONCAT(ru.vName, ' ', ru.vLastName)as RiderName, CONCAT('+', ru.vPhoneCode, ru.vPhone)as RiderPhone, ru.tSessionId, ru.vCurrencyPassenger, curr.Ratio FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$iUserId."' ");
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $priceRatio = $userData[0]['Ratio'];
        $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
        $fOutStandingAmount = GetPassengerOutstandingAmount($iUserId);
        $fOutStandingAmount = setTwoDecimalPoint($fOutStandingAmount * $priceRatio);
        if($fOutStandingAmount > 0 && $iUserId > 0){
            $returnArr['fOutStandingAmount'] = $fOutStandingAmount;
            $returnArr['fOutStandingAmountWithSymbol'] = formateNumAsPerCurrency($fOutStandingAmount,$vCurrencyPassenger);
            $checkDataArray = array();
            $checkDataArray['UserType'] = "Passenger";
            $checkDataArray['iMemberId'] = $iUserId;
            $checkDataArray['fOutStandingAmount'] = $fOutStandingAmount;
            $checkDataArray['ePayWallet'] = 'No';
            $checkDataArray['vLangCode'] = $vLangCode;
            $ShowOutstandingButtonsArray = ShowOutstandingButtons($checkDataArray,"RideShare");
            $returnArr = array_merge($returnArr,$ShowOutstandingButtonsArray);
            $returnArr['Action'] = "0";
            setDataResponse($returnArr);
        }
        $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iUserId,"Rider");
        if(isset($iPublishedRideWayPointId)&& !empty($iPublishedRideWayPointId)){
            $PublishRideData = $this->getPublishedRidesWaypoints($iPublishedRideWayPointId)[0];
        }
        else {
            $PublishRideData = $this->getPublishRideById($iPublishedRideId)[0];
        }
        $params = array("iMemberId" => $iUserId, "eUserType" => "Passenger", "eType" => "RideShare", "GET_DATA" => "Yes");
        $payment_mode_data = GetPaymentModeDetails($params);
        $ePaymentMode = !empty($payment_mode_data['PaymentMode'])?$payment_mode_data['PaymentMode']:"cash";
        $cashPayment = $ePaymentMode == "cash"?"Yes":"No";
        $ePayWallet = $ePaymentMode == "wallet"?"Yes":"No";
        $eWalletDebitAllow = $ePaymentMode == "wallet"?"Yes":($payment_mode_data['eWalletDebit'] == "Yes"?"Yes":"No");
        $isRestrictToWallet = $payment_mode_data['PAYMENT_MODE_RESTRICT_TO_WALLET'];
        $iPaymentInfoId = $payment_mode_data['iPaymentInfoId'];
        $sql = "SELECT iBookingId, vBookingNo FROM ride_share_bookings rsb WHERE iUserId = '".$iUserId."' AND rsb.iPublishedRideId = '".$iPublishedRideId."' AND eStatus = 'Pending' LIMIT 1";
        $ride_share_bookings = $obj->MySQLSelect($sql);
        $allowed = $this->checkAllowedSites($iPublishedRideId,$iPublishedRideWayPointId,$iBookNoOfSeats);
        if($allowed == 1){
            $fBookingFee = $RIDE_SHARE_BOOKING_FEE *($PublishRideData['fPrice'] * $iBookNoOfSeats)/ 100;
            $tPriceRatio = $PublishRideData['tPriceRatio'];
            $tPriceRatio = json_decode($tPriceRatio,true);
            $UserData = get_value('register_user','vCurrencyPassenger','iUserId',$iUserId);
            $vCurrencyPassenger = $UserData[0]['vCurrencyPassenger'];
            $fTotal =($PublishRideData['fPrice'] * $iBookNoOfSeats)+ $fBookingFee;
            $taxCal['fTax2'] = $taxCal['fTax1'] = $taxCal['fTaxAmount2'] = $taxCal['fTaxAmount1'] = 0;
            if($ENABLE_TAX_FOR_RIDE_SHARE_SERVICE == "Yes"){
                $Apply_tax_on_total_fare = $fTotal - $fBookingFee;
                $taxCal = $this->taxCalculation($iUserId,'Passenger',$Apply_tax_on_total_fare);
                $fTotal = $taxCal['fTaxAmount1'] + $taxCal['fTaxAmount2'] + $fTotal;
            }
            if($ePaymentMode == "card" && $isFareAuthorized != "Yes"){
                $returnArr["Action"] = "1";
                $returnArr['WebviewPayment'] = "Yes";
                $returnArr['message'] = $tconfig['tsite_url'].'assets/libraries/webview/system_payment.php?PAGE_TYPE=AUTHORIZE_TRIP_AMOUNT&SYSTEM_TYPE=APP&GeneralMemberId='.$iUserId.'&tSessionId='.$userData[0]['tSessionId'].'&GeneralUserType=Passenger&AMOUNT='.$fTotal;
                $tEstimatedFareUser = formateNumAsPerCurrency($fTotal * $tPriceRatio['fRatio_'.$vCurrencyPassenger],$userData[0]['vCurrencyPassenger']);
                $returnArr['message1'] = str_replace('#AUTHORIZE_AMOUNT#',$tEstimatedFareUser,$languageLabelsArr['LBL_RIDE_SHARE_AUTHORIZE_AMOUNT_MSG']);
                setDataResponse($returnArr);
            }
            $user_available_balance_wallet = $WALLET_OBJ->FetchMemberWalletBalance($iUserId,"Rider",true);
            $walletDataArr = array();
            if(is_array($user_available_balance_wallet)){
                $walletDataArr = $user_available_balance_wallet;
                $user_available_balance_wallet = $walletDataArr['CurrentBalance'];
            }
            $ratio = $userData[0]['Ratio'];
            $currency_vSymbol = $userData[0]['vSymbol'];
            $currencycode = $userData[0]['vCurrencyPassenger'];
            $user_available_balance_wallet = setTwoDecimalPoint($user_available_balance_wallet * $ratio);
            if($ePaymentMode == "wallet" && $user_available_balance_wallet < $fTotal && $eWalletIgnore == 'No'){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LOW_WALLET_AMOUNT";
                $auth_wallet_amount = 0;
                $returnArr['ORIGINAL_WALLET_BALANCE'] = formateNumAsPerCurrency(0,$currencycode);
                $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = setTwoDecimalPoint(0);
                if(!empty($walletDataArr)&& scount($walletDataArr)> 0){
                    $auth_wallet_amount = strval(setTwoDecimalPoint((isset($walletDataArr['TotalAuthorizedAmount'])?$walletDataArr['TotalAuthorizedAmount']:0)* $ratio));
                    $returnArr['AUTH_AMOUNT'] = $auth_wallet_amount > 0?formateNumAsPerCurrency($auth_wallet_amount,$currencycode):"";
                    $returnArr['AUTH_AMOUNT_VALUE'] = $auth_wallet_amount > 0?setTwoDecimalPoint($auth_wallet_amount):"";
                    $returnArr['ORIGINAL_WALLET_BALANCE'] = isset($walletDataArr['WalletBalance'])?formateNumAsPerCurrency(($walletDataArr['WalletBalance'] * $ratio),$currencycode):formateNumAsPerCurrency(0,$currencycode);
                    $returnArr['ORIGINAL_WALLET_BALANCE_VALUE'] = strval(setTwoDecimalPoint((isset($walletDataArr['WalletBalance'])?setTwoDecimalPoint($walletDataArr['WalletBalance']):0)* $ratio));
                }
                $returnArr['CURRENT_JOB_EST_CHARGE'] = formateNumAsPerCurrency($fTotal,$currencycode);
                $returnArr['CURRENT_JOB_EST_CHARGE_VALUE'] = strval(setTwoDecimalPoint($fTotal));
                $returnArr['WALLET_AMOUNT_NEEDED'] = formateNumAsPerCurrency(($fTotal - $user_available_balance_wallet),$currencycode);
                $returnArr['WALLET_AMOUNT_NEEDED_VALUE'] = strval(setTwoDecimalPoint($fTotal - $user_available_balance_wallet));
                if(!empty($walletDataArr)&& scount($walletDataArr)> 0 && $auth_wallet_amount > 0){
                    $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT'];
                    if(strtoupper($ePayWallet)== "YES" && strtoupper($isRestrictToWallet)== "YES"){
                        $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AUTH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####",$returnArr['WALLET_AMOUNT_NEEDED'],$content_msg_low_balance);
                    if(!empty($returnArr['ORIGINAL_WALLET_BALANCE'])){
                        $content_msg_low_balance = str_replace("####",$returnArr['ORIGINAL_WALLET_BALANCE'],$content_msg_low_balance);
                    }
                    if(!empty($returnArr['AUTH_AMOUNT'])){
                        $content_msg_low_balance = str_replace("###",$returnArr['AUTH_AMOUNT'],$content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##","\n\n",$content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                }
                else {
                    $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT'];
                    if(strtoupper($ePayWallet)== "YES" && strtoupper($isRestrictToWallet)== "YES"){
                        $content_msg_low_balance = $languageLabelsArr['LBL_LOW_WALLET_BAL_NOTE_WITH_AMT_NO_CASH'];
                    }
                    $content_msg_low_balance = str_replace("#####",$returnArr['WALLET_AMOUNT_NEEDED'],$content_msg_low_balance);
                    if(!empty($returnArr['ORIGINAL_WALLET_BALANCE'])){
                        $content_msg_low_balance = str_replace("####",$returnArr['ORIGINAL_WALLET_BALANCE'],$content_msg_low_balance);
                    }
                    if(!empty($returnArr['CURRENT_JOB_EST_CHARGE'])){
                        $content_msg_low_balance = str_replace("###",$returnArr['CURRENT_JOB_EST_CHARGE'],$content_msg_low_balance);
                    }
                    $content_msg_low_balance = str_replace("##","\n\n",$content_msg_low_balance);
                    $returnArr['low_balance_content_msg'] = $content_msg_low_balance;
                }
                if(strtoupper($ePayWallet)== "YES" && strtoupper($isRestrictToWallet)== "YES"){
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "Yes";
                }
                else {
                    $returnArr['IS_RESTRICT_TO_WALLET_AMOUNT'] = "No";
                }
                setDataResponse($returnArr);
            }
            $vBookingNo = $this->GenerateUniqueBookingNo();
            $Update_ride_share = array();
            $Update_ride_share['iUserId'] = $iUserId;
            $Update_ride_share['iPublishedRideId'] = $iPublishedRideId;
            $Update_ride_share['iPublishedRideWayPointId'] = $iPublishedRideWayPointId;
            $Update_ride_share['iBookedSeats'] = $iBookNoOfSeats;
            $Update_ride_share['dBookingDate'] = date('Y-m-d H:i:s');
            $Update_ride_share['fPricePerSeat'] = $PublishRideData['fPrice'];
            $Update_ride_share['fTotal'] = $fTotal;
            $Update_ride_share['fBookingFee'] = $fBookingFee;
            $Update_ride_share['ePaymentOption'] = ucfirst($ePaymentMode);
            $Update_ride_share['ePaid'] = 'No';
            $Update_ride_share['eStatus'] = 'Pending';
            if($ENABLE_TAX_FOR_RIDE_SHARE_SERVICE == "Yes"){
                $Update_ride_share['fTax2Percentage'] = $taxCal['fTax2'];
                $Update_ride_share['fTax1Percentage'] = $taxCal['fTax1'];
                $Update_ride_share['fTax2'] = $taxCal['fTaxAmount2'];
                $Update_ride_share['fTax1'] = $taxCal['fTaxAmount1'];
            }
            if($isFareAuthorized == "Yes"){
                $Update_ride_share['iAuthorizePaymentId'] = $iAuthorizePaymentId;
            }
            if($ePaymentMode == "card"){
                $Update_ride_share['iPaymentInfoId'] = $iPaymentInfoId;
            }
            elseif($ePaymentMode == "wallet" || $eWalletDebitAllow == "Yes"){
                $fWalletDebit = 0;
                if($user_available_balance > 0){
                    if($fTotal > $user_available_balance){
                        $fWalletDebit = $user_available_balance;
                    }
                    else {
                        $fWalletDebit = $fTotal;
                    }
                }
                $Update_ride_share['fWalletDebit'] = $fWalletDebit;
                $Update_ride_share['ePayWallet'] = $fWalletDebit > 0?"Yes":"No";
                $Update_ride_share['tUserWalletBalance'] = $walletDataArr['AutorizedWalletBalance'];
            }
            $Update_ride_share['vBookingNo'] = $vBookingNo;
            $id = $obj->MySQLQueryPerform("ride_share_bookings",$Update_ride_share,"insert");
            $row1 = $obj->MySQLSelect("SELECT eHmsDevice , iUserId, vCurrencyPassenger, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName, eLogout FROM `register_user` WHERE iUserId = '".$PublishRideData['iUserId']."'");
            $generalDataArr = $final_message = array();
            $final_message = $this->fetchPublishedRidesNotification($iPublishedRideId,$id,$iPublishedRideWayPointId);
            $alertMsg = $languageLabelsArr["LBL_RIDE_SHARE_NEW_BOOKING"];
            $generalDataArr[] = array('eDeviceType' => $row1[0]['eDeviceType'], 'deviceToken' => $row1[0]['iGcmRegId'], 'alertMsg' => $alertMsg, 'eAppTerminate' => $row1[0]['eAppTerminate'], 'eDebugMode' => $row1[0]['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $row1['eHmsDevice'], 'channelName' => "PASSENGER_".$PublishRideData['iUserId']);
            if($row1[0]['eLogout'] == "No"){
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr),RN_USER);
            }
            $Data_Mail = array();
            $Data_Mail['vEmail'] = $PublishRideData['vName'];
            $Data_Mail['vPublisherName'] = $PublishRideData['vName'];
            $Data_Mail['EMAIL_NAME'] = $PublishRideData['vName'];
            $Data_Mail['vName'] = $userData[0]['RiderName'];
            $Data_Mail['vPhone'] = $userData[0]['RiderPhone'];
            $Data_Mail['vBookingNo'] = $vBookingNo;
            $Data_Mail['Seats'] = $iBookNoOfSeats;
            $COMM_MEDIA_OBJ->SendMailToMember("RIDE_SHARE_BOOKING_NOTIFY_PUBLISHER",$Data_Mail);
            $Data_SMS = array();
            $Data_SMS['vPublisherName'] = $PublishRideData['vName'];
            $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate('RIDE_SHARE_BOOKING_NOTIFY_PUBLISHER',$Data_SMS,"",$vLangCode);
            $COMM_MEDIA_OBJ->SendSystemSMS($PublishRideData['vPhone'],$PublishRideData['vPhoneCode'],$message_layout);
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_RIDE_SHARE_WAIT_FOR_THE_APPROVAL_TXT";
            $returnArr['message_title'] = "LBL_RIDE_SHARE_WAIT_FOR_THE_APPROVAL_TITLE";
        }
        else {
            $message = str_replace(['#REQUESTED_SITE#', '#AVAILABLE_SITES#'],[$iBookNoOfSeats, $allowed],$languageLabelsArr["LBL_RIDE_SHARE_NOT_AVAILABLE_SITES_TXT"]);
            $returnArr['Action'] = "0";
            $returnArr['message'] = $message;
        }
        setDataResponse($returnArr);
    }
    public function getPublishedRidesWaypoints($iPublishedRideWayPointId){
        global $obj;
        $sql = "SELECT ru.vName, CONCAT(ru.vName, ' ', ru.vLastName)as PublisherName, ru.vEmail, ru.vPhone, ru.vPhoneCode, prw.iUserId,prw.tPriceRatio,prw.iBookedSeats,prw.fPrice,prw.tStartLocation, prw.tStartLat, prw.tStartLong, prw.tEndLocation, prw.tEndLat, prw.tEndLong, prw.dStartDate, prw.dEndDate, prw.fPrice, prw.iAvailableSeats, pr.tDriverDetails, ru.vCurrencyPassenger FROM published_rides_waypoints as prw JOIN published_rides as pr ON(pr.iPublishedRideId = prw.iPublishedRideId)LEFT JOIN register_user as ru ON ru.iUserId = pr.iUserId WHERE prw.iPublishedRideWayPointId = '".$iPublishedRideWayPointId."' ORDER BY pr.dAddedDate DESC";
        return $obj->MySQLSelect($sql);
    }
    public function checkAllowedSites($iPublishedRideId,$iPublishedRideWayPointId,$iBookNoOfSeats){
        global $obj;
        $sql = "SELECT iAvailableSeats,iBookedSeats FROM `published_rides` WHERE `iPublishedRideId` = {
            $iPublishedRideId
        }
        ";
        $published_rides_data = $obj->MySQLSelect($sql)[0];
        $allow = 0;
        if(isset($iPublishedRideWayPointId)&& !empty($iPublishedRideWayPointId)){
            $sql = "SELECT iAvailableSeats,iBookedSeats FROM `published_rides_waypoints` WHERE `iPublishedRideWayPointId` = {
                $iPublishedRideWayPointId
            }
            ";
            $published_rides_waypoint_data = $obj->MySQLSelect($sql)[0];
            if(($published_rides_data['iAvailableSeats'] -($published_rides_data['iBookedSeats'] + $published_rides_waypoint_data['iBookedSeats']))>= $iBookNoOfSeats){
                $allow = 1;
            }
        }
        else {
            $sql = "SELECT IFNULL(MAX(iBookedSeats),0)AS maxSeats FROM `published_rides_waypoints` WHERE `iPublishedRideId` = {
                $iPublishedRideId
            }
            ";
            $published_rides_waypoint_data = $obj->MySQLSelect($sql)[0];
            if(($published_rides_data['iAvailableSeats'] -($published_rides_data['iBookedSeats'] + $published_rides_waypoint_data['maxSeats']))>= $iBookNoOfSeats){
                $allow = 1;
            }
        }
        return $allow;
    }
    public function taxCalculation($MemberId,$UserType = "Passenger",$Price = ''){
        $TaxArr = getMemberCountryTax($MemberId,$UserType);
        $fTax1 = $TaxArr['fTax1'];
        $fTax2 = $TaxArr['fTax2'];
        $data['fTax2'] = $data['fTax1'] = $data['fTaxAmount2'] = $data['fTaxAmount1'] = 0;
        if($fTax1 > 0){
            $data['fTaxAmount1'] = round(((($Price)* $fTax1)/ 100),2);
            $data['fTax1'] = $fTax1;
        }
        if($fTax2 > 0){
            $data['fTaxAmount2'] = round(((($Price)* $fTax2)/ 100),2);
            $data['fTax2'] = $fTax2;
        }
        return $data;
    }
    public function GenerateUniqueBookingNo(){
        global $obj,$tconfig;
        $random = substr(number_format(time()* rand(),0,'',''),0,10);
        $str = "select iBookingId from ride_share_bookings where vBookingNo ='".$random."'";
        $db_str = $obj->MySQLSelect($str);
        if(!empty($db_str)&& scount($db_str)> 0){
            $Generateuniqueorderno = GenerateUniqueBookingNo();
        }
        else {
            $Generateuniqueorderno = $random;
        }
        return $Generateuniqueorderno;
    }
    public function fetchPublishedRidesNotification($iPublishedRideId,$iBookingId,$iPublishedRideWayPointId){
        global $obj,$LANG_OBJ,$tconfig,$ENABLE_24_HOUR_FORMAT;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $serverTimeZone = date_default_timezone_get();
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        if($iPublishedRideWayPointId != ''){
            $sql = " AND prw.iPublishedRideWayPointId = '".$iPublishedRideWayPointId."' ";
            $SQL_SELECT = " COALESCE(prw.tStartCity, pr.tStartCity)AS tStartCity, COALESCE(prw.tEndCity, pr.tEndCity)AS tEndCity, COALESCE(prw.fPrice, pr.fPrice)AS fPrice, COALESCE(prw.tStartLocation, pr.tStartLocation)AS tStartLocation, COALESCE(prw.tStartLat, pr.tStartLat)AS tStartLat, COALESCE(prw.tStartLong, pr.tStartLong)AS tStartLong, COALESCE(prw.dStartDate, pr.dStartDate)AS dStartDate, COALESCE(prw.tEndLocation, pr.tEndLocation)AS tEndLocation, COALESCE(prw.tEndLat, pr.tEndLat)AS tEndLat, COALESCE(prw.tEndLong, pr.tEndLong)AS tEndLong, COALESCE(prw.dEndDate, pr.dEndDate)AS dEndDate, ";
        }
        else {
            $SQL_SELECT = " pr.tStartCity AS tStartCity, pr.tEndCity AS tEndCity, pr.fPrice AS fPrice, pr.tStartLocation AS tStartLocation, pr.tStartLat AS tStartLat, pr.tStartLong AS tStartLong, pr.dStartDate AS dStartDate, pr.tEndLocation AS tEndLocation, pr.tEndLat AS tEndLat, pr.tEndLong AS tEndLong, pr.dEndDate AS dEndDate, ";
        }
        $sql = "SELECT $SQL_SELECT ru.tSessionId AS DrivertSessionId, CONCAT(ru.vName,' ',ru.vLastName)AS DriverName, ru.iUserId as DriveriUserId , ru.vImgName as DrivervImgName ,pr.iPublishedRideId, pr.tDocumentIds, pr.tPriceRatio, pr.iAvailableSeats, pr.tDriverDetails, ru.vCurrencyPassenger FROM published_rides as pr LEFT JOIN register_user as ru ON ru.iUserId = pr.iUserId LEFT JOIN published_rides_waypoints prw ON(prw.iPublishedRideId = pr.iPublishedRideId)WHERE pr.eStatus != 'Cancelled' AND pr.iPublishedRideId = '".$iPublishedRideId."' $sql ORDER BY pr.dAddedDate DESC";
        $ride = $obj->MySQLSelect($sql);
        $ride = $ride[0];
        $sql = "SELECT iBookingId,iBookedSeats,iUserId FROM ride_share_bookings rsb WHERE rsb.iBookingId = '".$iBookingId."' LIMIT 1";
        $ride_share_bookings = $obj->MySQLSelect($sql);
        $ride_share_bookings = $ride_share_bookings[0];
        $iUserId = $ride_share_bookings['iUserId'];
        $userData = $obj->MySQLSelect("SELECT CONCAT(vName,' ',vLastName)AS UserName FROM register_user WHERE iUserId = '$iUserId' ");
        $UserName = $userData[0]['UserName'];
        $profile = '';
        if(isset($ride['DrivervImgName'])&& !empty($ride['DrivervImgName'])){
            if(file_exists($tconfig["tsite_upload_images_passenger_path"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'])){
                $profile = $tconfig["tsite_upload_images_passenger"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'];
            }
        }
        $tPriceRatio = $ride['tPriceRatio'];
        $tPriceRatio = json_decode($tPriceRatio,true);
        $vCurrencyPassenger = $ride['vCurrencyPassenger'];
        $fPrice = $ride['fPrice'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
        $fPrice = $ride_share_bookings['iBookedSeats'] * $fPrice;
        $ridesArr['tStartLocation'] = $ride['tStartLocation'];
        $ridesArr['tStartLat'] = $ride['tStartLat'];
        $ridesArr['tStartLong'] = $ride['tStartLong'];
        $ridesArr['tEndLocation'] = $ride['tEndLocation'];
        $ridesArr['tEndLat'] = $ride['tEndLat'];
        $ridesArr['tEndLong'] = $ride['tEndLong'];
        $dStartDateServer = converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone);
        $dEndDateServer = converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone);
        $ridesArr['StartDate'] = date('D d F',strtotime($dStartDateServer));
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $ridesArr['StartTime'] = date('H:i',strtotime($dStartDateServer));
            $ridesArr['EndTime'] = date('H:i',strtotime($dEndDateServer));
        }
        else {
            $ridesArr['StartTime'] = date('h:i A',strtotime($dStartDateServer));
            $ridesArr['EndTime'] = date('h:i A',strtotime($dEndDateServer));
        }
        $ridesArr['AvailableSeats'] = $ride['iAvailableSeats'];
        $ridesArr['tDriverDetails'] = $ride['tDriverDetails'];
        $ridesArr['tStartCity'] = $languageLabelsArr['LBL_RIDE_SHARE_DETAILS_START_LOC_TXT'];
        $ridesArr['tEndCity'] = $languageLabelsArr['LBL_RIDE_SHARE_DETAILS_END_LOC_TXT'];
        $ridesArr['iPublishedRideId'] = $ride['iPublishedRideId'];
        $ridesArr['fPrice'] = formateNumAsPerCurrency($fPrice,$vCurrencyPassenger);
        $ridesArr['NoOfSeatTxt'] = $languageLabelsArr['LBL_RIDE_SHARE_FOR_TXT']." ".$ride_share_bookings['iBookedSeats']." ".$languageLabelsArr['LBL_RIDE_SHARE_PRICE_SEAT_TXT'];
        $ridesArr['DriverName'] = $UserName;
        $ridesArr['DriverRating'] = 0;
        $ridesArr['DriverImg'] = $profile;
        $ridesArr['iBookingId'] = $iBookingId;
        $ridesArr['iPublishedRideId'] = $iPublishedRideId;
        $ridesArr['eJobType'] = "RideSharing";
        $Arr['tSessionId'] = $ride['DrivertSessionId'];
        $Arr['Message'] = "RiderShareBooking";
        $Arr['MsgType'] = "RiderShareBooking";
        $Arr['time'] = time();
        $Arr['notiData'] = $ridesArr;
        $Arr['eType'] = "RideShare";
        return $Arr;
    }
    public function fetchBookings(){
        global $obj,$tconfig,$LANG_OBJ,$vSystemDefaultCurrencyName,$ENABLE_24_HOUR_FORMAT;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $page = isset($_REQUEST['page'])?trim($_REQUEST['page']):1;
        $vFilterParam = isset($_REQUEST['vSubFilterParam'])?$_REQUEST['vSubFilterParam']:"";
        $SYSTEM_TYPE = isset($_REQUEST['SYSTEM_TYPE'])?$_REQUEST['SYSTEM_TYPE']:"";
        $iBookingId = isset($_REQUEST['iBookingId'])?$_REQUEST['iBookingId']:"";
        $startDate = isset($_REQUEST['startDate'])?$_REQUEST['startDate']:"";
        $endDate = isset($_REQUEST['endDate'])?$_REQUEST['endDate']:"";
        $EXPIRED = 2;
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $serverTimeZone = date_default_timezone_get();
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        if($vFilterParam == '' && $SYSTEM_TYPE != "WEB" && $SYSTEM_TYPE != "ADMIN"){
            $FilterPriority = $this->getBookingFilterPriority($iUserId)['filter'];
            $vFilterParam = $FilterPriority;
        }
        if(strtoupper($vFilterParam)!= "CANCELLED"){
            $ssql = " AND pr.eStatus != 'Cancelled' ";
        }
        $currentDate = date('Y-m-d H:i:s');
        $todaydate = converToTz($currentDate,$serverTimeZone,$vTimeZone,"Y-m-d H:i:s");
        if(strtoupper($vFilterParam)== "UPCOMING"){
            $ssql .= " AND pr.dStartDate > '$todaydate' AND pr.eTrackingStatus = 'Pending' AND rsb.eStatus = 'Approved' ";
        }
        else if(strtoupper($vFilterParam)== "COMPLETED"){
            $ssql .= " AND pr.eStatus != 'Cancelled' AND rsb.eStatus = 'Approved' AND pr.eTrackingStatus = 'PaymentCollect'";
        }
        elseif(strtoupper($vFilterParam)== "INPROCESS"){
            $ssql .= " AND pr.eTrackingStatus IN('Start','MarkAsPickupALL','End')AND rsb.eStatus = 'Approved' ";
        }
        elseif(strtoupper($vFilterParam)== "CANCELLED"){
            $ssql = " AND rsb.eStatus = 'Cancelled' ";
        }
        elseif(strtoupper($vFilterParam)== "DECLINED"){
            $ssql = " AND(rsb.eStatus = 'Declined')";
        }
        elseif(strtoupper($vFilterParam)== "PENDING"){
            $time = time();
            $date2 = strtotime('-'.$EXPIRED.' hours',$time);
            $todaydate2 = date('Y-m-d H:i:s',$date2);
            $ssql = " AND pr.dStartDate > '$todaydate2' AND rsb.eStatus = 'Pending' AND pr.eTrackingStatus IN('Pending')";
        }
        elseif(strtoupper($vFilterParam)== "ACCEPTED"){
            $time = time();
            $date2 = strtotime('-'.$EXPIRED.' hours',$time);
            $todaydate2 = date('Y-m-d H:i:s',$date2);
            $ssql = " AND pr.dStartDate > '$todaydate2' AND rsb.eStatus = 'Approved' AND pr.eTrackingStatus = 'Pending' AND pr.eStatus != 'Cancelled'";
        }
        elseif(strtoupper($vFilterParam)== "EXPIRED"){
            $time = time();
            $date2 = strtotime('-'.$EXPIRED.' hours',$time);
            $todaydate2 = date('Y-m-d H:i:s',$date2);
            $ssql .= " AND pr.dStartDate < '$todaydate2' AND pr.eTrackingStatus = 'Pending' ";
        }
        else {
            $ssql .= " AND pr.dStartDate < '$todaydate' AND pr.eStatus != 'Cancelled' ";
        }
        $ssql .= " AND rsb.iUserId = {
            $iUserId
        }
        ";
        if(!empty($iBookingId)&& $iBookingId > 0){
            if($SYSTEM_TYPE == "ADMIN"){
                $ssql = '';
            }
            $ssql .= ' AND rsb.iBookingId = "'.$iBookingId.'" ';
        }
        if($SYSTEM_TYPE == "WEB"){
            $ssql = '';
            $ssql .= " AND rsb.iUserId = {
                $iUserId
            }
            ";
            if($startDate != ''){
                $ssql .= " AND Date(pr.dStartDate)>='".$startDate."'";
            }
            if($endDate != ''){
                $ssql .= " AND Date(pr.dStartDate)<='".$endDate."'";
            }
        }
        $isExpired = '';
        if(!empty($vTimeZone)){
            $TimeZoneOffset = converToTz($currentDate,$serverTimeZone,$vTimeZone,"P");
        }
        $EXPIRED_M = $EXPIRED * 60;
        $isExpired .= "CASE WHEN pr.eTrackingStatus ='Pending' THEN pr.dStartDate <((CONVERT_TZ(NOW(), 'SYSTEM', '".$TimeZoneOffset."'))- INTERVAL $EXPIRED_M MINUTE)ELSE '0' END as isExpired,";
        $sql = "SELECT rsb.fPricePerSeat,pr.eTrackingStatus,riderDriver.vName as driver_Name, riderUser.vName as rider_Name, CONCAT(riderUser.vName,' ',riderUser.vLastName)AS RiderName, CONCAT('+',riderUser.vPhoneCode,' ',riderUser.vPhone)AS RiderPhone, riderUser.iUserId as RideriUserId , riderUser.vImgName as RiderImgName, CONCAT(riderDriver.vName,' ',riderDriver.vLastName)AS DriverName, CONCAT('+',riderDriver.vPhoneCode,riderDriver.vPhone)AS DriverPhone, riderDriver.iUserId as DriveriUserId , riderDriver.vImgName as DrivervImgName, pr.fDuration,pr.fPrice , pr.tStartCity ,pr.tEndCity , pr.iAvailableSeats,pr.tStartLocation,pr.tStartLat,pr.tStartLong,pr.tEndLocation,pr.tEndLat,pr.tEndLong,pr.dStartDate,pr.dStartDate,pr.dEndDate,pr.tPriceRatio,pr.vPublishedRideNo, rsb.fTax1,rsb.fTax2,rsb.fTax1Percentage,rsb.fTax2Percentage, rsb.iPublishedRideId,rsb.eStatus,rsb.fTotal,rsb.iBookedSeats,pr.tDriverDetails,rsb.fBookingFee,rsb.ePaymentOption,riderDriver.iUserId as iDriverId, rsb.iBookingId, rsb.tCancelReason, rsb.iCancelReasonId, cr.vTitle_$vLangCode as vCancelReason, rsb.vBookingNo, rsb.fWalletDebit, rsb.fPricePerSeat FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)LEFT JOIN register_user riderUser ON(riderUser.iUserId = rsb.iUserId)LEFT JOIN register_user riderDriver ON(riderDriver.iUserId = pr.iUserId)LEFT JOIN cancel_reason cr ON(cr.iCancelReasonId = rsb.iCancelReasonId)WHERE 1=1 $ssql ORDER BY rsb.dBookingDate DESC";
        if($this->isOnlyEnableRideSharingPro){
            $sql = "SELECT $isExpired rsb.fPricePerSeat,rsb.iPublishedRideWayPointId,pr.eTrackingStatus,riderDriver.vName as driver_Name, riderUser.vName as rider_Name, CONCAT(riderUser.vName,' ',riderUser.vLastName)AS RiderName, CONCAT('+',riderUser.vPhoneCode,' ',riderUser.vPhone)AS RiderPhone, riderUser.iUserId as RideriUserId , riderUser.vImgName as RiderImgName, riderUser.iUserId as UseriUserId , CONCAT(riderDriver.vName,' ',riderDriver.vLastName)AS DriverName, CONCAT('+',riderDriver.vPhoneCode,riderDriver.vPhone)AS DriverPhone, riderDriver.iUserId as DriveriUserId , riderDriver.vImgName as DrivervImgName, pr.fDuration, pr.fPrice , pr.tStartCity ,pr.tEndCity , pr.iAvailableSeats,pr.tStartLocation,pr.tStartLat,pr.tStartLong,pr.vPublishedRideNo, COALESCE(prw.tEndLocation, pr.tEndLocation)AS tEndLocation, COALESCE(prw.tEndLat, pr.tEndLat)AS tEndLat, COALESCE(prw.tEndLong, pr.tEndLong)AS tEndLong, COALESCE(prw.dEndDate, pr.dEndDate)AS dEndDate, pr.dStartDate,pr.dStartDate,pr.tPriceRatio, rsb.fTax1,rsb.fTax2,rsb.fTax1Percentage,rsb.fTax2Percentage, rsb.iPublishedRideId,rsb.eStatus,rsb.fTotal,rsb.iBookedSeats,pr.tDriverDetails,rsb.fBookingFee,rsb.ePaymentOption,riderDriver.iUserId as iDriverId, rsb.iBookingId, rsb.tCancelReason, rsb.iCancelReasonId, cr.vTitle_$vLangCode as vCancelReason, rsb.vBookingNo, rsb.fWalletDebit, rsb.fPricePerSeat FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)LEFT JOIN published_rides_waypoints prw ON(prw.iPublishedRideWayPointId = rsb.iPublishedRideWayPointId)LEFT JOIN register_user riderUser ON(riderUser.iUserId = rsb.iUserId)LEFT JOIN register_user riderDriver ON(riderDriver.iUserId = pr.iUserId)LEFT JOIN cancel_reason cr ON(cr.iCancelReasonId = rsb.iCancelReasonId)WHERE 1=1 $ssql ORDER BY rsb.dBookingDate DESC";
        }
        $rideShareBookings = $obj->MySQLSelect($sql);
        if(!empty($rideShareBookings)&& scount($rideShareBookings)> 0){
            $userData = $obj->MySQLSelect("SELECT vCurrencyPassenger FROM register_user WHERE iUserId = '$iUserId' ");
            if(!empty($userData)){
                $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
            }
            if($SYSTEM_TYPE == "ADMIN"){
                $vCurrencyPassenger = $vSystemDefaultCurrencyName;
            }
            $ridesArr = [];
            foreach($rideShareBookings as $k => $ride){
                $profile = '';
                if(isset($ride['DrivervImgName'])&& !empty($ride['DrivervImgName'])){
                    if(file_exists($tconfig["tsite_upload_images_passenger_path"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'])){
                        $profile = $tconfig["tsite_upload_images_passenger"].'/'.$ride['DriveriUserId'].'/3_'.$ride['DrivervImgName'];
                    }
                }
                if(!empty($ride['tPriceRatio'])){
                    $tPriceRatio = json_decode($ride['tPriceRatio'],true);
                }
                if(empty($tPriceRatio['fRatio_'.$vCurrencyPassenger])){
                    $tPriceRatio['fRatio_'.$vCurrencyPassenger] = get_value('currency', 'Ratio', 'vName', $vCurrencyPassenger, '', 'true');
                }
                $fTotal = $ride['fTotal'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fPricePerSeat = $ride['fPricePerSeat'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $iAvailableSeats = str_replace('#NUMBER#',$ride['iAvailableSeats'],$languageLabelsArr['LBL_RIDE_SHARE_NUMBER_MAX_BOOK_SET']);
                $vNoOfPassenger = str_replace('#NUMBER#',$ride['iBookedSeats'],$languageLabelsArr['LBL_RIDE_SHARE_FOR_NO_PASSENGER']);
                $BookingListArr = $this->BookingList($vLangCode,$ride['iPublishedRideId'],[$iUserId],'Booking');
                $ridesArr[$k]['tDriverDetails'] = $ride['tDriverDetails'];
                $ridesArr[$k]['carDetails'] = $this->carDetails($ride['tDriverDetails']);
                $ridesArr[$k]['tStartLocation'] = $ride['tStartLocation'];
                $ridesArr[$k]['tStartLat'] = $ride['tStartLat'];
                $ridesArr[$k]['tStartLong'] = $ride['tStartLong'];
                $ridesArr[$k]['tEndLocation'] = $ride['tEndLocation'];
                $ridesArr[$k]['tEndLat'] = $ride['tEndLat'];
                $ridesArr[$k]['tEndLong'] = $ride['tEndLong'];
                $ridesArr[$k]['StartDate'] = DateTime($ride['dStartDate'],22);
                $ridesArr[$k]['StartTime'] = date('h:i A',strtotime($ride['dStartDate']));
                if(!empty($ride['dStartDate'])|| $ride['dStartDate'] != "0000-00-00"){
                    $startdate_data_array = array('tdate' => converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone), 'langCode' => $vLangCode);
                    $getdStartDateFormat = DateformatCls::getNewDateFormat($startdate_data_array);
                    if(!empty($getdStartDateFormat)){
                        foreach($getdStartDateFormat as $dstart_key => $dstart_value){
                            $ridesArr[$k][$dstart_key] = $dstart_value;
                        }
                    }
                }
                $ridesArr[$k]['EndTime'] = date('h:i A',strtotime($ride['dEndDate']));
                $ridesArr[$k]['StartDate'] = DateTime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone),22);
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $ridesArr[$k]['StartTime'] = date('H:i',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                    $ridesArr[$k]['EndTime'] = date('H:i',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
                }
                else {
                    $ridesArr[$k]['StartTime'] = date('h:i A',strtotime(converToTz($ride['dStartDate'],$vTimeZone,$serverTimeZone)));
                    $ridesArr[$k]['EndTime'] = date('h:i A',strtotime(converToTz($ride['dEndDate'],$vTimeZone,$serverTimeZone)));
                }
                $ridesArr[$k]['fTotalPrice'] = formateNumAsPerCurrency($fTotal,$vCurrencyPassenger);
                $ridesArr[$k]['fPrice'] = formateNumAsPerCurrency($fPricePerSeat,$vCurrencyPassenger);
                $ridesArr[$k]['PriceLabel'] = $languageLabelsArr['LBL_RIDE_SHARE_PER_PASSENGER_TXT'];
                $ridesArr[$k]['iPublishedRideId'] = $ride['iPublishedRideId'];
                $ridesArr[$k]['vBookingNo'] = $ride['vBookingNo'];
                $ridesArr[$k]['eStatus'] = $ride['eStatus'];
                $ridesArr[$k]['AvailableSeats'] = $ride['iAvailableSeats'];
                $ridesArr[$k]['DriverName'] = $ride['driver_Name'];
                $ridesArr[$k]['DriverPhone'] = $ride['DriverPhone'];
                $ridesArr[$k]['iDriverId'] = $ride['iDriverId'];
                $ridesArr[$k]['TRAVEL_PREFERENCES_ARR'] = $this->displayTravelPreferences($ride['iDriverId'])['TRAVEL_PREFERENCES_ARR'];
                $ridesArr[$k]['DriverRating'] = 0;
                $ridesArr[$k]['DriverImg'] = $profile;
                $ridesArr[$k]['tStartCity'] = $ride['tStartCity'];
                $ridesArr[$k]['tEndCity'] = $ride['tEndCity'];
                $ridesArr[$k]['iAvailableSeatsText'] = $iAvailableSeats;
                $ridesArr[$k]['vNoOfPassengerText'] = $vNoOfPassenger;
                $ridesArr[$k]['fDuration'] = $this->convertSecToMin($ride['fDuration']);
                $ridesArr[$k]['BookingList'] = $BookingListArr;
                $ridesArr[$k]['iPublishedRideWayPointId'] = $ride['iPublishedRideWayPointId'];
                $ridesArr[$k]['vPublishedRideNo'] = $ride['vPublishedRideNo'];
                if($SYSTEM_TYPE == "ADMIN"){
                    $ridesArr[$k]['dStartDate'] = $ride['dStartDate'];
                    $ridesArr[$k]['RiderName'] = $ride['RiderName'];
                    $ridesArr[$k]['RiderPhone'] = $ride['RiderPhone'];
                    $ridesArr[$k]['RiderImgName'] = $ride['RiderImgName'];
                    $ridesArr[$k]['UseriUserId'] = $ride['UseriUserId'];
                    $ridesArr[$k]['eTrackingStatus'] = $ride['eTrackingStatus'];
                }
                if($this->isOnlyEnableRideSharingPro){
                    if(isset($ride['iPublishedRideWayPointId'])&& $ride['iPublishedRideWayPointId'] == 0){
                        $fRatioCurrency = $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                        $waypointData = $this->getWayPointsFromTheDb($ride['iPublishedRideId'],$fRatioCurrency,$vCurrencyPassenger,$fPricePerSeat);
                    }
                }
                $ridesArr[$k]['isBookedByOthers'] = !empty($BookingListArr)&& scount($BookingListArr)> 0?'Yes':'No';
                $ridesArr[$k]['vBookingNoTxt'] = $languageLabelsArr['LBL_RIDE_SHARE_BOOKING_NO'].' #'.$ride['vBookingNo'];
                $ridesArr[$k]['vStatusBgColor'] = RANDOM_COLORS_ARR[array_rand(RANDOM_COLORS_ARR,1)];
                if($ride['ePaymentOption'] == "Cash"){
                    $ridesArr[$k]['PaymentText'] = $languageLabelsArr['LBL_RIDE_SHARE_PAY_CASH_TXT'];
                    $ridesArr[$k]['PaymentModeLabel'] = $languageLabelsArr['LBL_CASH_TXT'];
                }
                elseif($ride['ePaymentOption'] == "Card"){
                    $ridesArr[$k]['PaymentText'] = $languageLabelsArr['LBL_RIDE_SHARE_PAY_CARD_TXT'];
                    $ridesArr[$k]['PaymentModeLabel'] = $languageLabelsArr['LBL_CARD'];
                }
                else {
                    $ridesArr[$k]['PaymentText'] = $languageLabelsArr['LBL_RIDE_SHARE_PAY_WALLET_TXT'];
                    $ridesArr[$k]['PaymentModeLabel'] = $languageLabelsArr['LBL_WALLET_TXT'];
                }
                $ridesArr[$k]['iBookingId'] = $ride['iBookingId'];
                $ridesArr[$k]['PaymentModeTitle'] = $languageLabelsArr['LBL_PAYMENT_MODE_TXT'];
                $ridesArr[$k]['PriceBreakdown'] = "";
                $ridesArr[$k]['eShowCallImg'] = "No";
                $ridesArr[$k]['isCancelbuttonHide'] = 'No';
                if($ride['eTrackingStatus'] == 'PaymentCollect' || in_array($ride['eStatus'],['Pending', 'Declined', 'Cancelled'])){
                    $ridesArr[$k]['isContactToDriver'] = 'No';
                }
                if(in_array($ride['eTrackingStatus'],['Start', 'MarkAsPickupALL', 'End', 'PaymentCollect'])&& $ride['eStatus'] != 'Cancelled'){
                    $ridesArr[$k]['isCancelbuttonHide'] = 'Yes';
                }
                if($ride['eStatus'] == "Pending"){
                    $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_PENDING_STATUS_TXT'];
                }
                elseif($ride['eStatus'] == "Approved"){
                    if($ride['eTrackingStatus'] == "Start"){
                        $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_DRIVER_ARRIVING_STATUS'];
                    }
                    elseif($ride['eTrackingStatus'] == "MarkAsPickupALL"){
                        $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_ON_GOING_TRIP_STATUS'];
                    }
                    elseif($ride['eTrackingStatus'] == "End"){
                        $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_END_TRIP_STATUS'];
                    }
                    else if($ride['eTrackingStatus'] == "PaymentCollect"){
                        $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_COMPLETED'];
                    }
                    else {
                        $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_ACCEPT_STATUS_TXT'];
                    }
                }
                elseif($ride['eStatus'] == "Declined"){
                    $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_DECLINE_STATUS_TXT'];
                    $ridesArr[$k]['tCancelReason'] = $ride['iCancelReasonId'] > 0?$ride['vCancelReason']:$ride['tCancelReason'];
                    $ridesArr[$k]['PaymentText'] = $languageLabelsArr['LBL_RIDE_SHARE_DECLINE_STATUS_TXT'];
                    $ridesArr[$k]['vNoOfPassengerText'] = "";
                }
                else {
                    $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_RIDE_SHARE_CANCEL_STATUS_TXT'];
                    $ridesArr[$k]['tCancelReason'] = $ride['iCancelReasonId'] > 0?$ride['vCancelReason']:$ride['tCancelReason'];
                    $ridesArr[$k]['PaymentText'] = $languageLabelsArr['LBL_RIDE_SHARE_CANCEL_STATUS_TXT'];
                    $ridesArr[$k]['vNoOfPassengerText'] = "";
                }
                if($ride['isExpired'] == 1 && !in_array($ride['eStatus'],['Declined','Cancelled'])){
                    $ridesArr[$k]['eStatusText'] = $languageLabelsArr['LBL_EXPIRED_TXT'];
                }
                $ridesArr[$k]['PriceBreakdownTitle'] = $languageLabelsArr['LBL_PYMENT_DETAILS'];
                $ridesArr[$k]['PaymentNote'] = "";
                $arrindex = 0;
                $priceBreakdownArr = array();
                $fPricePerSeat = $ride['fPricePerSeat'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fPricePerSeatTotal = $ride['fPricePerSeat'] * $ride['iBookedSeats'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fTotalAmount =($ride['fTotal'] - $ride['fWalletDebit'])* $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fBookingFee = $ride['fBookingFee'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fWalletDebit = $ride['fWalletDebit'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fTax1 = $ride['fTax1'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $fTax2 = $ride['fTax2'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
                $priceBreakdownArr[$arrindex][$ride['iBookedSeats'].' '.$languageLabelsArr['LBL_RIDE_SHARE_PRICE_SEAT_TXT'].' X '.formateNumAsPerCurrency($fPricePerSeat,$vCurrencyPassenger)] = formateNumAsPerCurrency($fPricePerSeatTotal,$vCurrencyPassenger);
                $arrindex++;
                if($ride['fTax1'] > 0){
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_TAX1_TXT']." @ ".$ride['fTax1Percentage']." % "] = formateNumAsPerCurrency($fTax1,$vCurrencyPassenger);
                    $arrindex++;
                }
                if($ride['fTax2'] > 0){
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_TAX2_TXT']." @ ".$ride['fTax2Percentage']." % "] = formateNumAsPerCurrency($fTax2,$vCurrencyPassenger);
                    $arrindex++;
                }
                if($fBookingFee > 0){
                    if($SYSTEM_TYPE == "ADMIN"){
                        $ridesArr[$k]['BOOKING_FEE_TEXT'] = formateNumAsPerCurrency($fBookingFee,$vCurrencyPassenger);
                    }
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_RIDE_SHARE_BOOKING_FEES_TXT']] = formateNumAsPerCurrency($fBookingFee,$vCurrencyPassenger);
                    $arrindex++;
                }
                if($ride['fWalletDebit'] > 0){
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_WALLET_ADJUSTMENT']] = "-".formateNumAsPerCurrency($fWalletDebit,$vCurrencyPassenger);
                    $arrindex++;
                }
                $priceBreakdownArr[$arrindex]['eDisplaySeperator'] = "Yes";
                $arrindex++;
                if($SYSTEM_TYPE == "ADMIN"){
                    $ridesArr[$k]['TotalFareArrIndex'] = $arrindex;
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_RIDE_SHARE_TOTAL_PRICE'].'('.$ride['ePaymentOption'].')'] = formateNumAsPerCurrency($fTotalAmount,$vCurrencyPassenger);
                    $arrindex++;
                }
                else {
                    $priceBreakdownArr[$arrindex][$languageLabelsArr['LBL_RIDE_SHARE_TOTAL_PRICE']] = formateNumAsPerCurrency($fTotalAmount,$vCurrencyPassenger);
                    $arrindex++;
                }
                $ridesArr[$k]['PriceBreakdown'] = $priceBreakdownArr;
                $ridesArr[$k]['eJobType'] = "RideSharing";
                $ridesArr[$k]['Btn_TrackDriver'] = 'No';
                if($ride['eTrackingStatus'] == "Start" && $ride['eStatus'] == "Approved"){
                    $ridesArr[$k]['Btn_TrackDriver'] = 'Yes';
                }
                $ridesArr[$k]['BTN_TEXT'] = $languageLabelsArr['LBL_RIDE_SHARE_TRACK_DRIVER'];
                if(!in_array($ride['eTrackingStatus'],['PaymentCollect','Pending','Start'])){
                    $ridesArr[$k]['IS_EMERGENCY_CALL_ENABLE'] = 'Yes';
                    $ridesArr[$k]['BTN_TEXT'] = $languageLabelsArr['LBL_RIDE_SHARE_SOS'];
                }
                if($ride['eTrackingStatus'] == 'PaymentCollect'){
                    $ridesArr[$k]['IS_RATING_SHOW'] = "Yes";
                    $getRating = $this->getRating($ride['iBookingId'],'Passenger');
                    if(isset($getRating)&& !empty($getRating)){
                        $ridesArr[$k]['rating'] = $getRating[0]['fRating'];
                        $ridesArr[$k]['tMessage'] = $getRating[0]['tMessage'];
                    }
                    $getRating = $this->getRating($ride['iBookingId'],'Driver');
                    if(isset($getRating)&& !empty($getRating)){
                        $ridesArr[$k]['ratingFromDriver'] = $getRating[0]['fRating'];
                        $ridesArr[$k]['tMessageFromDriver'] = $getRating[0]['tMessage'];
                    }
                }
            }
            $total = scount($ridesArr);
            $per_page = 10;
            $totalPages = ceil($total / $per_page);
            $start_limit =($page - 1)* $per_page;
            $ridesArr = array_slice($ridesArr,$start_limit,$per_page);
            $returnArr['Action'] = "1";
            $returnArr['message'] = $ridesArr;
            if($totalPages > $page){
                $returnArr['NextPage'] =($page + 1);
            }
            else {
                $returnArr['NextPage'] = "0";
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_RIDE_SHARE_NO_RIDES_FOUND_TXT";
            $returnArr['message_title'] = "LBL_RIDE_SHARE_NO_RIDES_FOUND_TITLE";
        }
        $returnArr['vSubFilterParam'] = $vFilterParam;
        $filterarray = array('Accepted' => $languageLabelsArr["LBL_ACCEPTED"], 'Pending' => $languageLabelsArr["LBL_PENDING"], 'Upcoming' => $languageLabelsArr["LBL_UPCOMING"], 'Declined' => $languageLabelsArr["LBL_DECLINED"], 'Inprocess' => $languageLabelsArr["LBL_INPROCESS"], 'Completed' => $languageLabelsArr["LBL_COMPLETED"], 'Cancelled' => $languageLabelsArr["LBL_CANCELLED"], 'Expired' => $languageLabelsArr["LBL_EXPIRED_TXT"]);
        $returnArr['vSelectedFilterTitle'] = isset($filterarray[$vFilterParam])? $filterarray[$vFilterParam] : '';
        $returnArr['subFilterOption'] = array(array('vSubFilterParam' => 'Accepted', 'vTitle' => $languageLabelsArr["LBL_ACCEPTED"]), array('vSubFilterParam' => 'Pending', 'vTitle' => $languageLabelsArr["LBL_PENDING"]), array('vSubFilterParam' => 'Inprocess', 'vTitle' => $languageLabelsArr["LBL_INPROCESS"]), array('vSubFilterParam' => 'Completed', 'vTitle' => $languageLabelsArr["LBL_COMPLETED"]), array('vSubFilterParam' => 'Declined', 'vTitle' => $languageLabelsArr["LBL_DECLINED"]), array('vSubFilterParam' => 'Cancelled', 'vTitle' => $languageLabelsArr["LBL_CANCELLED"]), array('vSubFilterParam' => 'Expired', 'vTitle' => $languageLabelsArr["LBL_EXPIRED_TXT"]));
        if(in_array($SYSTEM_TYPE,["WEB", "ADMIN"])){
            return $returnArr;
        }
        else {
            setDataResponse($returnArr);
        }
    }
    public function getBookingFilterPriority($iUserId){
        global $obj;
        $EXPIRED = 2;
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $date_ = date("Y-m-d H:i:s");
        $serverTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $todaydate = converToTz($date_,$serverTimeZone,$vTimeZone,"Y-m-d H:i:s");
        }
        $sql = "SELECT count(*)as count FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)WHERE rsb.iUserId = ".$iUserId." AND pr.eStatus != 'Cancelled' AND pr.eTrackingStatus IN('Start','MarkAsPickupALL','End')";
        $inprocess_data = $obj->MySQLSelect($sql);
        $inprocessCount = $inprocess_data[0]['count'];
        $filter = "Completed";
        if(!empty($inprocessCount)){
            $filter = 'Inprocess';
        }
        else {
            $sql2 = "SELECT count(*)as count FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)WHERE rsb.iUserId = ".$iUserId." AND pr.eTrackingStatus = 'Pending' AND pr.eStatus != 'Cancelled' AND pr.dStartDate > '$todaydate'";
            $upcoming_data = $obj->MySQLSelect($sql2);
            $upcomingCount = $upcoming_data[0]['count'];
            if(!empty($upcomingCount)){
            }
        }
        if($filter == "Completed"){
            $time = time();
            $date2 = strtotime('-'.$EXPIRED.' hours',$time);
            $todaydate2 = date('Y-m-d H:i:s',$date2);
            $sql2 = "SELECT count(*)as count FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)WHERE pr.dStartDate > '$todaydate2' AND rsb.iUserId = ".$iUserId." AND pr.eTrackingStatus = 'Pending' AND rsb.eStatus = 'Approved'";
            $Accepted_data = $obj->MySQLSelect($sql2);
            $AcceptedCount = $Accepted_data[0]['count'];
            if(!empty($AcceptedCount)){
                $filter = 'Accepted';
            }
        }
        if($filter == "Completed"){
            $sql2 = "SELECT count(*)as count FROM ride_share_bookings rsb LEFT JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)WHERE rsb.iUserId = ".$iUserId." AND pr.eTrackingStatus = 'Pending' AND rsb.eStatus = 'Pending'";
            $Accepted_data = $obj->MySQLSelect($sql2);
            $AcceptedCount = $Accepted_data[0]['count'];
            if(!empty($AcceptedCount)){
                $filter = 'Pending';
            }
        }
        $res['filter'] = $filter;
        return $res;
    }
    public function cancelPublishRide(){
        global $obj,$LANG_OBJ;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $GeneralUserType = isset($_REQUEST["GeneralUserType"])?$_REQUEST["GeneralUserType"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $iCancelReasonId = isset($_REQUEST["iCancelReasonId"])?$_REQUEST["iCancelReasonId"]:'';
        $tCancelReason = isset($_REQUEST["tCancelReason"])?$_REQUEST["tCancelReason"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $publishRideData = $this->getPublishRideById($iPublishedRideId);
        $dCancelDate = date('Y-m-d H:i:s');
        $where = " iPublishedRideId = '".$iPublishedRideId."' AND iUserId = '".$iUserId."'";
        $data['eStatus'] = 'Cancelled';
        $data['eCancelledBy'] = $GeneralUserType;
        $data['tCancelReason'] = $tCancelReason;
        $data['iCancelReasonId'] = $iCancelReasonId;
        $data['dCancelDate'] = $dCancelDate;
        $obj->MySQLQueryPerform('published_rides',$data,'update',$where);
        $bookingData = $obj->MySQLSelect("SELECT riderUser.vLang AS rider_vLang ,riderUser.vTimeZone AS rider_vTimeZone, riderUser.vEmail AS rider_vEmail, riderUser.iUserId AS rider_iUserId, riderDriver.iUserId AS driver_iUserId, rsb.iBookingId, rsb.vBookingNo, rsb.eStatus, rsb.ePaid, rsb.fWalletDebit, rsb.fBookingFee, rsb.ePaymentOption, rsb.iAuthorizePaymentId, rsb.fTotal, pr.vPublishedRideNo FROM ride_share_bookings as rsb LEFT JOIN published_rides as pr ON pr.iPublishedRideId = rsb.iPublishedRideId LEFT JOIN register_user as riderDriver ON riderDriver.iUserId = pr.iUserId LEFT JOIN register_user as riderUser ON riderUser.iUserId = rsb.iUserId WHERE rsb.iPublishedRideId = {
            $iPublishedRideId
        }
        AND rsb.eStatus = 'Approved' ");
        foreach($bookingData as $booking){
            if(!empty($iCancelReasonId)){
                $vCancelReason = get_value('cancel_reason',"vTitle_".$vLangCode,'iCancelReasonId',$iCancelReasonId,'','true');
            }
            else {
                $vCancelReason = $tCancelReason;
            }
            $rider_vTimeZone = $booking['rider_vTimeZone'];
            $rider_vLang = $booking['rider_vLang'];
            $CommonDateFormat = commonDateFormat($dCancelDate,$rider_vTimeZone,$rider_vLang,1,'No');
            $alertMsg = str_replace('#BOOKING_NO#',$booking['vBookingNo'],$languageLabelsArr["LBL_RIDE_SHARE_CANCEL_BOOKING_PUBLISHER"]);
            $mailArr = $smsArr = [];
            $rider_iUserId = $booking['rider_iUserId'];
            $mailArr['BOOKING_NO'] = $booking['vBookingNo'];
            $mailArr['DATE'] = $CommonDateFormat['DATE_TIME'];
            $mailArr['USER_TYPE'] = 'Driver';
            $mailArr['REASON'] = $vCancelReason;
            $mailArr['START_LOCATION'] = $publishRideData[0]['tStartLocation'];
            $mailArr['END_LOCATION'] = $publishRideData[0]['tEndLocation'];
            $mailArr['EMAIL'] = $booking['rider_vEmail'];
            $mailArr['RIDER_USERID'] = $booking['rider_iUserId'];
            $data = $this->notify($rider_iUserId,'NOTIFICATION,MAIL','','PASSENGERS_NOTIFIED_WHEN_RIDE_CANCELED_BY_PUBLISHER','CancelPublishRide',$mailArr,$smsArr,$alertMsg,$iPublishedRideId,$booking['iBookingId']);
            $where = " iBookingId = '".$booking['iBookingId']."' ";
            $data = array();
            $data['eStatus'] = 'Cancelled';
            $data['tCancelReason'] = $tCancelReason;
            $data['iCancelReasonId'] = $iCancelReasonId;
            $data['dCancelDate'] = date('Y-m-d H:i:s');
            $data['ePaymentStatus'] = "Settled";
            if($booking['eStatus'] == "Pending"){
                if($booking['ePaymentOption'] == "Card"){
                    $paymentData = array("iMemberId" => $booking['rider_iUserId'], "UserType" => "Passenger", "iAuthorizePaymentId" => $booking['iAuthorizePaymentId']);
                    $resultArr =(PaymentGateways::getInstance())->cancelAuthorizedPayment($paymentData);
                    if($resultArr['Action'] == "0"){
                        $returnArr['Action'] = "0";
                        $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
                        setDataResponse($returnArr);
                    }
                }
            }
            elseif($booking['eStatus'] == "Approved"){
                $this->CreditDriverCommission($booking['fBookingFee'],$booking['driver_iUserId'],$booking['iBookingId'],$booking['vBookingNo']);
                $driverDebitAmt = $booking['fTotal'] - $booking['fBookingFee'];
                if($booking['ePaymentOption'] == "Card"){
                    $this->CreditMemberPayment($booking['fTotal'],$booking['rider_iUserId'],$booking['iBookingId'],$booking['vBookingNo'],'User');
                }
                else if($booking['fWalletDebit'] > 0){
                    $this->CreditMemberPayment($booking['fWalletDebit'],$booking['rider_iUserId'],$booking['iBookingId'],$booking['vBookingNo'],'User');
                }
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_RIDE_SHARE_PUBLISH_RIDE_CANCEL_SUCCESSFULLY_TXT";
        setDataResponse($returnArr);
    }
    public function CreditDriverCommission($fAmount,$iUserId,$iBookingId,$vBookingNo){
        global $WALLET_OBJ;
        $data_wallet = array();
        $data_wallet['iUserId'] = $iUserId;
        $data_wallet['eUserType'] = "Rider";
        $data_wallet['iBalance'] = $fAmount;
        $data_wallet['eType'] = "Credit";
        $data_wallet['dDate'] = date("Y-m-d H:i:s");
        $data_wallet['iBookingId'] = $iBookingId;
        $data_wallet['eFor'] = "Booking";
        $data_wallet['ePaymentStatus'] = "Settelled";
        $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_CREDITED_BOOKING#".$vBookingNo;
        $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'],$data_wallet['eUserType'],$data_wallet['iBalance'],$data_wallet['eType'],0,$data_wallet['eFor'],$data_wallet['tDescription'],$data_wallet['ePaymentStatus'],$data_wallet['dDate'],'','',$data_wallet['iBookingId']);
    }
    public function CreditMemberPayment($fAmount,$iUserId,$iBookingId,$vBookingNo,$UserType){
        global $WALLET_OBJ;
        $data_wallet = array();
        $data_wallet['iUserId'] = $iUserId;
        $data_wallet['eUserType'] = "Rider";
        $data_wallet['iBalance'] = $fAmount;
        $data_wallet['eType'] = "Credit";
        $data_wallet['dDate'] = date("Y-m-d H:i:s");
        $data_wallet['iBookingId'] = $iBookingId;
        $data_wallet['eFor'] = "Booking";
        $data_wallet['ePaymentStatus'] = "Settelled";
        if($UserType == "User"){
            $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_CREDITED_BOOKING_REFUND# ".$vBookingNo;
        }
        else {
            $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_CREDITED_EARNING# ".$vBookingNo;
        }
        $data_wallet = $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'],$data_wallet['eUserType'],$data_wallet['iBalance'],$data_wallet['eType'],0,$data_wallet['eFor'],$data_wallet['tDescription'],$data_wallet['ePaymentStatus'],$data_wallet['dDate'],'','',$data_wallet['iBookingId']);
    }
    public function UpdateBookingsStatus(){
        global $obj,$LANG_OBJ,$WALLET_OBJ;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $GeneralUserType = isset($_REQUEST["GeneralUserType"])?$_REQUEST["GeneralUserType"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $iPublishedRideWayPointId = isset($_REQUEST["iPublishedRideWayPointId"])?$_REQUEST["iPublishedRideWayPointId"]:'';
        $iBookingId = isset($_REQUEST["iBookingId"])?$_REQUEST["iBookingId"]:'';
        $eStatus = isset($_REQUEST["eStatus"])?$_REQUEST["eStatus"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $iCancelReasonId = isset($_REQUEST["iCancelReasonId"])?$_REQUEST["iCancelReasonId"]:'';
        $tCancelReason = isset($_REQUEST["tCancelReason"])?$_REQUEST["tCancelReason"]:'';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $getBookingData = $this->getBookingById($iBookingId);
        $getBookingData = $getBookingData[0];
        $iPublishedRideWayPointId = $getBookingData['iPublishedRideWayPointId'];
        $date = date('Y-m-d H:i:s');
        if(strtotime($getBookingData['dStartDate'])< strtotime($date)){
            $returnArr['Action'] = "0";
            $returnArr['message'] = $languageLabelsArr['LBL_EXPIRED_TXT'];
        }
        $WayPointSetsAvailable = 'true';
        $WayPointSetsAvailableData = $this->IsWayPointSetsAvailable($iPublishedRideWayPointId,$iPublishedRideId,$getBookingData['iBookedSeats']);
        $WayPointSetsAvailable = $WayPointSetsAvailableData['isValid'];
        if($WayPointSetsAvailable && $eStatus == 'Approved' && $getBookingData['iBookedSeats'] <=($getBookingData['iAvailableSeats'] - $getBookingData['pr_iBookedSeats'])){
            $rider_available_balance = $WALLET_OBJ->FetchMemberWalletBalanceApp($iUserId,"Rider","No","Yes");
            $rider_available_balance = $rider_available_balance['ORIG_AMOUNT'];
            $fBookingFee = $getBookingData['fBookingFee'];
            if($fBookingFee > $rider_available_balance && $this->BookingFeeCheckInWallet == "ACCEPT_BOOKING_TIME"){
                $userData = $obj->MySQLSelect("SELECT CONCAT(ru.vName, ' ', ru.vLastName)as PublisherName, CONCAT('+', ru.vPhoneCode, ru.vPhone)as PhoneNo, ru.vCurrencyPassenger, curr.Ratio, ru.vLang FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$iUserId."' ");
                $priceRatio = $userData[0]['Ratio'];
                $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
                $commission = formateNumAsPerCurrency($fBookingFee * $priceRatio,$vCurrencyPassenger);
                $rider_available_balance = formateNumAsPerCurrency($rider_available_balance * $priceRatio,$vCurrencyPassenger);
                $returnArr['Action'] = "0";
                $returnArr['LOW_WALLET_BAL'] = "Yes";
                $returnArr['message'] = str_replace(['#####', '####'],[$commission, $rider_available_balance],$languageLabelsArr['LBL_RIDE_SHARE_LOW_WALLET_BAL_NOTE_WITH_WALLET_AMT']);
                setDataResponse($returnArr);
            }
            $update_status = "No";
            $commissionDeducted = "No";
            $settle_payment = "No";
            if($getBookingData['ePaymentOption'] == "Cash"){
                $fWalletDebitCommission = $getBookingData['fBookingFee'];
                $eCommissionDeduct = $getBookingData['eCommissionDeduct'];
                $this->adminCommission($eCommissionDeduct,$fWalletDebitCommission,$iUserId,$iBookingId);
                $update_status = "Yes";
            }
            if($getBookingData['ePaymentOption'] == "Wallet" || $getBookingData['ePayWallet'] == "Yes"){
                $this->DebitMemberPayment($getBookingData['fWalletDebit'],$getBookingData['rider_iUserId'],$iBookingId,$getBookingData['vBookingNo'],'User');
                if($commissionDeducted == "No"){
                    $fWalletDebitCommission = $getBookingData['fBookingFee'];
                    $eCommissionDeduct = $getBookingData['eCommissionDeduct'];
                    $this->adminCommission($eCommissionDeduct,$fWalletDebitCommission,$iUserId,$iBookingId);
                }
                $update_status = "Yes";
            }
            if($getBookingData['ePaymentOption'] == "Card"){
                $paymentData = array("iMemberId" => $getBookingData['rider_iUserId'], "UserType" => "Passenger", "iAuthorizePaymentId" => $getBookingData['iAuthorizePaymentId']);
                $resultArr =(PaymentGateways::getInstance())->capturePayment($paymentData);
                if($resultArr['Action'] == 1){
                    $where_payments = " tPaymentUserID = '".$resultArr['tPaymentTransactionId']."'";
                    $data_payments['iBookingId'] = $iBookingId;
                    $data_payments['eEvent'] = "RideShareBooking";
                    $obj->MySQLQueryPerform("payments",$data_payments,'update',$where_payments);
                    $fWalletDebitCommission = $getBookingData['fBookingFee'];
                    $eCommissionDeduct = $getBookingData['eCommissionDeduct'];
                    $this->adminCommission($eCommissionDeduct,$fWalletDebitCommission,$iUserId,$iBookingId);
                    $update_status = "Yes";
                }
                else {
                    $transMsg = "LBL_CHARGE_COLLECT_FAILED";
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = $resultArr['message'];
                    setDataResponse($returnArr);
                }
            }
            if($update_status == "Yes"){
                $where = " iBookingId = '".$iBookingId."'";
                $Update_ride_share = array();
                $Update_ride_share['eStatus'] = $eStatus;
                $Update_ride_share['eCommissionDeduct'] = 'Yes';
                $Update_ride_share['ePaid'] = 'Yes';
                if($getBookingData['ePaymentOption'] == "Cash" && $getBookingData['fWalletDebit'] == 0){
                    $Update_ride_share['ePaymentStatus'] = "Settled";
                }
                elseif($getBookingData['ePaymentOption'] == "Wallet"){
                }
                $id = $obj->MySQLQueryPerform("ride_share_bookings",$Update_ride_share,'update',$where);
                if($iPublishedRideWayPointId > 0){
                    $where = " iPublishedRideWayPointId = '".$iPublishedRideWayPointId."'";
                    $update_published_rides = array();
                    $update_published_rides['iBookedSeats'] = $getBookingData['WayPointBookedSeats'] + $getBookingData['iBookedSeats'];
                    $id = $obj->MySQLQueryPerform("published_rides_waypoints",$update_published_rides,'update',$where);
                }
                else {
                    $where = " iPublishedRideId = '".$iPublishedRideId."'";
                    $update_published_rides = array();
                    $update_published_rides['iBookedSeats'] = $getBookingData['pr_iBookedSeats'] + $getBookingData['iBookedSeats'];
                    $id = $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
                }
                $returnArr['Action'] = "1";
                $returnArr['message'] = str_replace('#RIDER_NAME#',$getBookingData['rider_Name'],$languageLabelsArr["LBL_RIDE_SHARE_BOOKING_APPROVED_SUCCESSFULLY_TXT"]);
            }
            $rider_iUserId = $getBookingData['rider_iUserId'];
            $mailArr = [];
            $mailArr['BOOKING_NO'] = $getBookingData['vBookingNo'];
            $mailArr['START_LOCATION'] = $getBookingData['tStartLocation'];
            $mailArr['END_LOCATION'] = $getBookingData['tEndLocation'];
            $mailArr['EMAIL'] = $getBookingData['rider_vEmail'];
            $alertMeg = str_replace('#XXXXX#',$getBookingData['vBookingNo'],$languageLabelsArr['LBL_RIDE_SHARE_PASSENGERS_NOTIFIED_AFTER_THE_ACCEPTED']);
            $this->notify($rider_iUserId,'MAIL,NOTIFICATION','','PASSENGERS_NOTIFIED_WHEN_RIDE_ACCEPTED_BY_PUBLISHER','AcceptPublishRide',$mailArr,"",$alertMeg,"",$iBookingId);
        }
        else if($eStatus == 'Declined'){
            $where = " iBookingId = '".$iBookingId."'";
            $Update_ride_share = [];
            $Update_ride_share['eStatus'] = $eStatus;
            $Update_ride_share['tCancelReason'] = $tCancelReason;
            $Update_ride_share['iCancelReasonId'] = $iCancelReasonId;
            $id = $obj->MySQLQueryPerform("ride_share_bookings",$Update_ride_share,'update',$where);
            if($getBookingData['ePaymentOption'] == "Card"){
                $paymentData = array("iMemberId" => $getBookingData['rider_iUserId'], "UserType" => "Passenger", "iAuthorizePaymentId" => $getBookingData['iAuthorizePaymentId']);
                $resultArr =(PaymentGateways::getInstance())->cancelAuthorizedPayment($paymentData);
                if($resultArr['Action'] == "0"){
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
                    setDataResponse($returnArr);
                }
            }
            $alertMeg = str_replace(['#XXXXX#', '#USERTYPE#'],[$getBookingData['vBookingNo'], $languageLabelsArr['LBL_DRIVER']],$languageLabelsArr['LBL_RIDE_SHARE_BOOKING_DECLINED_BY_PUBLISHER']);
            $rider_iUserId = $getBookingData['rider_iUserId'];
            $this->notify($rider_iUserId,'NOTIFICATION','','','DeclinePublishRide',"","",$alertMeg,"",$iBookingId);
            if(isset($id)&& !empty($id)){
                $returnArr['Action'] = "1";
                $returnArr['message'] = "LBL_RIDE_SHARE_BOOKING_DECLINED_SUCCESSFULLY_TXT";
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_RIDE_SHARE_BOOKING_CANT_UPDATE_STATUS_TXT";
        }
        $RemainingPossibility = $this->GetRemainingPossibility($iPublishedRideId);
        if(!$RemainingPossibility['SEAT_BOOKING_REMAINING']){
            $this->declineBookingAllSeatsFull($iPublishedRideId);
        }
        setDataResponse($returnArr);
    }
    public function getBookingById($iBookingId){
        global $obj;
        $sql = "SELECT prw.iBookedSeats as WayPointBookedSeats,rsb.iPublishedRideWayPointId,rsb.eStatus AS bookingStatus , riderUser.vEmail AS rider_vEmail, riderDriver.vEmail AS driver_vEmail,pr.vPublishedRideNo , pr.iPublishedRideId , rsb.fBookingFee ,riderUser.iUserId AS rider_iUserId , riderDriver.iUserId AS driver_iUserId ,riderUser.vName AS rider_Name, riderUser.vLastName as rider_LastName, pr.tStartLocation, pr.tEndLocation, riderDriver.vName AS driver_Name , pr.iAvailableSeats , pr.iBookedSeats as pr_iBookedSeats , rsb.iBookedSeats , pr.dStartDate, rsb.eCommissionDeduct, rsb.ePaymentOption, rsb.ePayWallet, rsb.fWalletDebit, rsb.vBookingNo, rsb.iAuthorizePaymentId, rsb.fTotal FROM ride_share_bookings rsb LEFT JOIN published_rides as pr ON pr.iPublishedRideId = rsb.iPublishedRideId LEFT JOIN published_rides_waypoints prw ON(prw.iPublishedRideWayPointId = rsb.iPublishedRideWayPointId)LEFT JOIN register_user as riderDriver ON riderDriver.iUserId = pr.iUserId LEFT JOIN register_user as riderUser ON riderUser.iUserId = rsb.iUserId WHERE rsb.iBookingId = '".$iBookingId."' ORDER BY pr.dAddedDate DESC";
        return $obj->MySQLSelect($sql);
    }
    public function IsWayPointSetsAvailable($iPublishedRideWayPointId,$iPublishedRideId,$NoOfSeats){
        global $obj;
        $sql_cur = '';
        if($this->IsAnyDocumentActive()){
            $sql_cur = " AND rd.eApproveDoc = 'Yes' ";
        }
        if($iPublishedRideWayPointId > 0){
            $sql = "SELECT iPublishedRideWayPointId FROM published_rides_waypoints prw LEFT JOIN published_rides pr ON(pr.iPublishedRideId = prw.iPublishedRideId)LEFT JOIN register_user rd ON(rd.iUserId = prw.iUserId)WHERE pr.iPublishedRideId = $iPublishedRideId AND prw.iPublishedRideWayPointId = $iPublishedRideWayPointId $sql_cur AND pr.eStatus = 'Active' AND pr.eTrackingStatus = 'Pending' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats &&((pr.iAvailableSeats - pr.iBookedSeats)- prw.iBookedSeats)>= $NoOfSeats ";
        }
        else {
            $sql = "SELECT iPublishedRideWayPointId FROM published_rides_waypoints prw LEFT JOIN published_rides pr ON(pr.iPublishedRideId = prw.iPublishedRideId)LEFT JOIN register_user rd ON(rd.iUserId = prw.iUserId)WHERE pr.iPublishedRideId = $iPublishedRideId $sql_cur AND pr.eStatus = 'Active' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats AND(pr.iAvailableSeats -(pr.iBookedSeats +(SELECT IFNULL(MAX(iBookedSeats),0)AS maxSeats FROM published_rides_waypoints WHERE iPublishedRideId = pr.iPublishedRideId)))>= $NoOfSeats";
        }
        $published_rides = $obj->MySQLSelect($sql);
        $FINAL_ARR = [];
        $FINAL_ARR['isValid'] = 'false';
        if(isset($published_rides)&& !empty($published_rides)){
            $FINAL_ARR['iPublishedRideWayPointId'] = $published_rides[0]['iPublishedRideWayPointId'];
            $FINAL_ARR['isValid'] = 'true';
        }
        return $FINAL_ARR;
    }
    public function adminCommission($eCommissionDeduct,$fWalletDebit,$iUserId,$iBookingId){
        global $WALLET_OBJ;
        if($fWalletDebit > 0 && $eCommissionDeduct == 'No'){
            $bookingData = $this->getBookingById($iBookingId);
            $data_wallet = array();
            $data_wallet['iUserId'] = $iUserId;
            $data_wallet['eUserType'] = "Rider";
            $data_wallet['iBalance'] = $fWalletDebit;
            $data_wallet['eType'] = "Debit";
            $data_wallet['dDate'] = date("Y-m-d H:i:s");
            $data_wallet['iBookingId'] = $iBookingId;
            $data_wallet['eFor'] = "Booking";
            $data_wallet['ePaymentStatus'] = "Settelled";
            $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_COMMISSION_PUBLISHES_RIDES# #".$bookingData[0]['vPublishedRideNo'].'('.$bookingData[0]['rider_Name'].' '.$bookingData[0]['rider_LastName'].')';
            $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'],$data_wallet['eUserType'],$data_wallet['iBalance'],$data_wallet['eType'],0,$data_wallet['eFor'],$data_wallet['tDescription'],$data_wallet['ePaymentStatus'],$data_wallet['dDate'],'','',$data_wallet['iBookingId']);
        }
        return $data_wallet;
    }
    public function DebitMemberPayment($fAmount,$iUserId,$iBookingId,$vBookingNo,$UserType){
        global $WALLET_OBJ;
        $data_wallet = array();
        $data_wallet['iUserId'] = $iUserId;
        $data_wallet['eUserType'] = "Rider";
        $data_wallet['iBalance'] = $fAmount;
        $data_wallet['eType'] = "Debit";
        $data_wallet['dDate'] = date("Y-m-d H:i:s");
        $data_wallet['iBookingId'] = $iBookingId;
        $data_wallet['eFor'] = "Booking";
        $data_wallet['ePaymentStatus'] = "Settelled";
        if($UserType == "User"){
            $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_DEBITED_BOOKING# ".$vBookingNo;
        }
        else {
            $data_wallet['tDescription'] = "#LBL_RIDE_SHARE_BOOKING_REFUND_DEBITED# ".$vBookingNo;
        }
        $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'],$data_wallet['eUserType'],$data_wallet['iBalance'],$data_wallet['eType'],0,$data_wallet['eFor'],$data_wallet['tDescription'],$data_wallet['ePaymentStatus'],$data_wallet['dDate'],'','',$data_wallet['iBookingId']);
    }
    public function GetRemainingPossibility($iPublishedRideId){
        global $obj;
        $sql = "SELECT iAvailableSeats,iBookedSeats,vSPoint,vDPoint FROM published_rides pr WHERE pr.iPublishedRideId = $iPublishedRideId";
        $published_rides = $obj->MySQLSelect($sql)[0];
        $sql = "SELECT iAvailableSeats,iBookedSeats,vSPoint,vDPoint FROM published_rides_waypoints rsb WHERE rsb.iPublishedRideId = $iPublishedRideId";
        $published_rides_waypoints = $obj->MySQLSelect($sql);
        $seatAvailability = [];
        $main_route = $published_rides['vSPoint']." to ".$published_rides['vDPoint'];
        $seatAvailability[$main_route] = $published_rides['iAvailableSeats'];
        $RESULT_ARR = $wayPointArr = [];
        if(isset($published_rides_waypoints)&& !empty($published_rides_waypoints)){
            foreach($published_rides_waypoints as $waypoint){
                $seatAvailability[$waypoint['vSPoint']." to ".$waypoint['vDPoint']] = $waypoint['iAvailableSeats'];
                $wayPointArr[] = $waypoint['iBookedSeats'];
            }
            $seatAvailability = $this->bookSeats($main_route,$published_rides['iBookedSeats'],$seatAvailability,$main_route,$published_rides['iAvailableSeats']);
            $wayPointBooking = max($wayPointArr);
            $seatAvailability[$main_route] -= $wayPointBooking;
            if(isset($published_rides_waypoints)&& !empty($published_rides_waypoints)){
                foreach($published_rides_waypoints as $waypoint){
                    $waypoint_rount = $waypoint['vSPoint']." to ".$waypoint['vDPoint'];
                    $seatAvailability = $this->bookSeats($waypoint_rount,$waypoint['iBookedSeats'],$seatAvailability,$main_route,$published_rides['iAvailableSeats']);
                }
            }
            $seatAvailability = $this->checkArrayValues($seatAvailability);
            $RESULT_ARR['SEAT_BOOKING_REMAINING'] = $seatAvailability;
        }
        return $RESULT_ARR;
    }
    function bookSeats($route,$quantity,$seatAvailability,$main_route,$iAvailableSeats){
        if($route != $main_route){
            $res = $quantity;
            $seatAvailability[$route] -= $res;
        }
        elseif($route == $main_route){
            foreach($seatAvailability as $KEY => $SA){
                $seatAvailability[$KEY] -= $quantity;
            }
        }
        return $seatAvailability;
    }
    function checkArrayValues($availability){
        foreach($availability as $route => $seats){
            if($seats > 0){
                return true;
            }
        }
        return false;
    }
    function declineBookingAllSeatsFull($iPublishedRideId){
        global $obj;
        $where = " iPublishedRideId = '".$iPublishedRideId."' AND eStatus = 'Pending' ";
        $Update_ride_share = [];
        $Update_ride_share['eStatus'] = 'Declined';
        $Update_ride_share['tCancelReason'] = 'All seats are full.';
        $Update_ride_share['iCancelReasonId'] = 0;
        $id = $obj->MySQLQueryPerform("ride_share_bookings",$Update_ride_share,'update',$where);
    }
    public function BookRideDetails(){
        global $RIDE_SHARE_BOOKING_FEE,$LANG_OBJ,$ENABLE_TAX_FOR_RIDE_SHARE_SERVICE,$ENABLE_24_HOUR_FORMAT;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $iBookNoOfSeats = isset($_REQUEST["iBookNoOfSeats"])?$_REQUEST["iBookNoOfSeats"]:'1';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'1';
        $iPublishedRideWayPointId = isset($_REQUEST["iPublishedRideWayPointId"])?$_REQUEST["iPublishedRideWayPointId"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $serverTimeZone = date_default_timezone_get();
        if(isset($iPublishedRideWayPointId)&& !empty($iPublishedRideWayPointId)){
            $PublishedRide = $this->getPublishedRidesWaypoints($iPublishedRideWayPointId)[0];
        }
        else {
            $PublishedRide = $this->getPublishRideById($iPublishedRideId)[0];
        }
        $UserData = get_value('register_user','vCurrencyPassenger','iUserId',$iUserId);
        $vCountry = $UserData[0]['vCurrencyPassenger'];
        $vCurrencyPassenger = $UserData[0]['vCurrencyPassenger'];
        $tPriceRatio = $PublishedRide['tPriceRatio'];
        $tPriceRatio = json_decode($tPriceRatio,true);
        $fPrice = $PublishedRide['fPrice'] * $tPriceRatio['fRatio_'.$vCurrencyPassenger];
        $totalPrice = $iBookNoOfSeats * $fPrice;
        $BookingFees = $RIDE_SHARE_BOOKING_FEE * $totalPrice / 100;
        $taxCal['fTax2'] = $taxCal['fTax1'] = $taxCal['fTaxAmount2'] = $taxCal['fTaxAmount1'] = 0;
        if($ENABLE_TAX_FOR_RIDE_SHARE_SERVICE == "Yes"){
            $taxCal = $this->taxCalculation($iUserId,'Passenger',$totalPrice);
            $taxCal['fTaxAmount1'] = $taxCal['fTaxAmount1'];
            $taxCal['fTaxAmount2'] = $taxCal['fTaxAmount2'];
        }
        $Summary = [];
        $Summary[][$iBookNoOfSeats.' '.$languageLabelsArr['LBL_RIDE_SHARE_PRICE_SEAT_TXT'].' X '.formateNumAsPerCurrency($fPrice,$vCurrencyPassenger)] = formateNumAsPerCurrency($totalPrice,$vCurrencyPassenger);
        if($ENABLE_TAX_FOR_RIDE_SHARE_SERVICE == "Yes"){
            if($taxCal['fTax1'] > 0){
                $Summary[][$languageLabelsArr['LBL_TAX1_TXT']." @ ".$taxCal['fTax1']." % "] = formateNumAsPerCurrency($taxCal['fTaxAmount1'],$vCurrencyPassenger);
            }
            if($taxCal['fTax2'] > 0){
                $Summary[][$languageLabelsArr['LBL_TAX1_TXT']." @ ".$taxCal['fTax2']." % "] = formateNumAsPerCurrency($taxCal['fTaxAmount2'],$vCurrencyPassenger);
            }
        }
        $Summary[]['eDisplaySeperator'] = 'Yes';
        if($RIDE_SHARE_BOOKING_FEE > 0){
            $Summary[][$languageLabelsArr['LBL_RIDE_SHARE_BOOKING_FEES_TXT']] = formateNumAsPerCurrency($BookingFees,$vCurrencyPassenger);
        }
        $total_fare = $BookingFees + $totalPrice + $taxCal['fTaxAmount2'] + $taxCal['fTaxAmount1'];
        $returnArr['message']['Summary'] = $Summary;
        $PublishedRidedStartDate = converToTz($PublishedRide['dStartDate'],$vTimeZone,$serverTimeZone);
        if($ENABLE_24_HOUR_FORMAT == 'Yes'){
            $returnArr['message']['dStartDate'] = DateTime($PublishedRidedStartDate,22).' '.$languageLabelsArr['LBL_AT_TXT'].' '.DateTime($PublishedRidedStartDate,12);
        }
        else {
            $returnArr['message']['dStartDate'] = DateTime($PublishedRidedStartDate,22).' '.$languageLabelsArr['LBL_AT_TXT'].' '.DateTime($PublishedRidedStartDate,18);
        }
        if(!empty($PublishedRide['dStartDate'])|| $PublishedRide['dStartDate'] != "0000-00-00"){
            $dStartdate_data_array = array('tdate' => converToTz($PublishedRide['dStartDate'],$vTimeZone,$serverTimeZone), 'langCode' => $vLang);
            $getdstartDateFormat = DateformatCls::getNewDateFormat($dStartdate_data_array);
            if(!empty($getdstartDateFormat)){
                foreach($getdstartDateFormat as $dstart_key => $dstart_value){
                    $returnArr['message'][$dstart_key] = $dstart_value;
                }
            }
        }
        $returnArr['message']['TotalPrice'] = formateNumAsPerCurrency($total_fare,$vCurrencyPassenger);
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    }
    public function cancelRideShareBooking(){
        global $obj,$LANG_OBJ;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $GeneralUserType = isset($_REQUEST["GeneralUserType"])?$_REQUEST["GeneralUserType"]:'';
        $iBookingId = isset($_REQUEST["iBookingId"])?$_REQUEST["iBookingId"]:'';
        $iCancelReasonId = isset($_REQUEST["iCancelReasonId"])?$_REQUEST["iCancelReasonId"]:'';
        $tCancelReason = isset($_REQUEST["tCancelReason"])?$_REQUEST["tCancelReason"]:'';
        $getBookingData = $this->getBookingById($iBookingId);
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        if($getBookingData[0]['bookingStatus'] == 'Cancelled'){
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_RIDE_SHARE_BOOKING_CANCEL_SUCCESS_TXT";
            setDataResponse($returnArr);
        }
        if($getBookingData[0]['ePaymentOption'] == "Card" && $getBookingData[0]['bookingStatus'] != 'Approved'){
            $paymentData = array("iMemberId" => $getBookingData[0]['rider_iUserId'], "UserType" => "Passenger", "iAuthorizePaymentId" => $getBookingData[0]['iAuthorizePaymentId']);
            $resultArr =(PaymentGateways::getInstance())->cancelAuthorizedPayment($paymentData);
            if($resultArr['Action'] == "0"){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
                setDataResponse($returnArr);
            }
        }
        $where = " iBookingId = '".$iBookingId."' AND iUserId = '".$iUserId."'";
        $data['eStatus'] = 'Cancelled';
        $data['tCancelReason'] = $tCancelReason;
        $data['iCancelReasonId'] = $iCancelReasonId;
        $data['dCancelDate'] = date('Y-m-d H:i:s');
        $obj->MySQLQueryPerform('ride_share_bookings',$data,'update',$where);
        if($getBookingData[0]['bookingStatus'] == 'Approved'){
            $where = " iPublishedRideId = '".$getBookingData[0]['iPublishedRideId']."'";
            $update_published_rides = array();
            $update_published_rides['iBookedSeats'] = $getBookingData[0]['pr_iBookedSeats'] - $getBookingData[0]['iBookedSeats'];
            $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
            $this->CreditDriverCommission($getBookingData[0]['fBookingFee'],$getBookingData[0]['driver_iUserId'],$iBookingId,$getBookingData[0]['vPublishedRideNo']);
            $driverDebitAmt = $getBookingData[0]['fTotal'] - $getBookingData[0]['fBookingFee'];
            if($getBookingData[0]['fWalletDebit'] > 0){
                $this->CreditMemberPayment($getBookingData[0]['fWalletDebit'],$getBookingData[0]['rider_iUserId'],$iBookingId,$getBookingData[0]['vBookingNo'],'User');
            }
        }
        $driver_iUserId = $getBookingData[0]['driver_iUserId'];
        if(!empty($iCancelReasonId)){
            $vCancelReason = get_value('cancel_reason',"vTitle_".$vLangCode,'iCancelReasonId',$iCancelReasonId,'','true');
        }
        else {
            $vCancelReason = $tCancelReason;
        }
        $mailArr = [];
        $mailArr['PUBLISH_RIDE_NO'] = $getBookingData[0]['vPublishedRideNo'];
        $mailArr['RIDE_NO'] = $getBookingData[0]['vPublishedRideNo'];
        $mailArr['REASON'] = $vCancelReason;
        $mailArr['START_LOCATION'] = $getBookingData[0]['tStartLocation'];
        $mailArr['END_LOCATION'] = $getBookingData[0]['tEndLocation'];
        $mailArr['EMAIL'] = $getBookingData[0]['driver_vEmail'];
        $alertMsg = str_replace('#RIDE_NO#','#'.$getBookingData[0]['vPublishedRideNo'],$languageLabelsArr['LBL_RIDE_SHARE_CANCEL_BOOKING_PASSENGER']);
        $data = $this->notify($driver_iUserId,'MAIL,NOTIFICATION','','PUBLISHERS_NOTIFIED_WHEN_RIDE_CANCELED_BY_PASSENGERS','CancelPublishRide',$mailArr,"",$alertMsg,"","");
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_RIDE_SHARE_BOOKING_CANCEL_SUCCESS_TXT";
        setDataResponse($returnArr);
    }
    public function GetRideShareRecommendedPrice(){
        global $obj,$RIDE_SHARE_RECOMNENDED_PRICE,$LANG_OBJ,$ONLY_ENABLE_RIDE_SHARING_PRO,$RIDE_SHARE_ENABLE_RECOMMENDED_PRICE;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $tEndLat = isset($_REQUEST["tEndLat"])?$_REQUEST["tEndLat"]:'';
        $tEndLong = isset($_REQUEST["tEndLong"])?$_REQUEST["tEndLong"]:'';
        $tStartLocation = isset($_REQUEST["tStartLocation"])?$_REQUEST["tStartLocation"]:'';
        $tEndLocation = isset($_REQUEST["tEndLocation"])?$_REQUEST["tEndLocation"]:'';
        $distance = isset($_REQUEST["distance"])?$_REQUEST["distance"]:'0';
        $duration = isset($_REQUEST["duration"])?$_REQUEST["duration"]:'0';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $MSP = isset($_REQUEST["MSP"])?$_REQUEST["MSP"]:'';
        if(isset($MSP)&& !empty($MSP)&& $this->isOnlyEnableRideSharingPro && $this->isOnlyEnableRideSharingPro){
            $PointRecommendedPrice = $this->RecommendedPriceForPro()['PointRecommendedPrice'];
            if(isset($PointRecommendedPrice['TOTAl_DISTANCE'])&& !empty($PointRecommendedPrice['TOTAl_DISTANCE'])){
                $distance = $PointRecommendedPrice['TOTAl_DISTANCE'];
            }
        }
        $userData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger, curr.Ratio ,curr.vSymbol FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$iUserId."' ");
        $priceRatio = $userData[0]['Ratio'];
        $vCurrency = $userData[0]['vCurrencyPassenger'];
        $recommended_price = 0;
        if(!empty($distance)){
            $recommended_price =($distance / 1000)* $RIDE_SHARE_RECOMNENDED_PRICE;
        }
        $recommended_price_1 = $recommended_price -($recommended_price * 0.2);
        $recommended_price_2 = $recommended_price +($recommended_price * 0.2);
        $recommended_price_text = formateNumAsPerCurrency($recommended_price_1 * $priceRatio,$vCurrency).' - '.formateNumAsPerCurrency($recommended_price_2 * $priceRatio,$vCurrency);
        $passenger_nos_arr = array();
        for($i = 1;
        $i <= RIDE_SHARE_PASSENGER_NOS;
        $i++){
            $passenger_nos_arr[] = $i;
        }
        $returnArr['Action'] = "1";
        $returnArr['CurrencySymbol'] = $userData[0]['vSymbol'];
        $returnArr['CurrencyName'] = $userData[0]['vCurrencyPassenger'];
        if(strtoupper($RIDE_SHARE_ENABLE_RECOMMENDED_PRICE)== "YES"){
            $returnArr['RecommdedPrice'] = round($recommended_price * $priceRatio);
            $returnArr['RecommdedPriceText'] = $languageLabelsArr['LBL_RIDE_SHARE_RECOMMENDED_PRICE_TXT'];
            $returnArr['RecommdedPriceRange'] = $recommended_price_text;
        }
        if(isset($PointRecommendedPrice)&& !empty($PointRecommendedPrice)){
            $returnArr['PointRecommendedPrice'] = $PointRecommendedPrice;
        }
        $returnArr['PassengerNo'] = $passenger_nos_arr;
        $returnArr['message'] = strtoupper($languageLabelsArr['LBL_RIDE_SHARE_RECOMMENDED_PRICE_TXT']).' '.$recommended_price_text;
        $sql = "SELECT iPublishedRideId,tDriverDetails FROM published_rides as pr WHERE pr.iUserId = '".$iUserId."' ORDER BY iPublishedRideId DESC LIMIT 1";
        $published_rides_data = $obj->MySQLSelect($sql);
        if(isset($published_rides_data)&& !empty($published_rides_data)){
            $returnArr['carDetails'] = $this->carDetails($published_rides_data[0]['tDriverDetails']);
            if(isset($returnArr['carDetails']['cModel'])&& !empty($returnArr['carDetails']['cModel'])){
                $cModel = explode('-',$returnArr['carDetails']['cModel']);
                $returnArr['carDetails']['cColor'] = trim($cModel[1]);
                $returnArr['carDetails']['cModel'] = trim($cModel[0]);
            }
            if(isset($returnArr['carDetails']['cImage'])&& !empty($returnArr['carDetails']['cImage'])){
                $returnArr['carDetails']['cImageName'] = basename($returnArr['carDetails']['cImage']);
            }
            else {
                $returnArr['carDetails']['cImage'] = '';
            }
        }
        setDataResponse($returnArr);
    }
    public function RecommendedPriceForPro(){
        global $LANG_OBJ,$RIDE_SHARE_RECOMNENDED_PRICE,$obj,$RIDE_SHARE_ENABLE_RECOMMENDED_PRICE;
        $MSP = $_REQUEST["MSP"] ?? '';
        $vLangCode = $_REQUEST["vGeneralLang"] ?? '';
        $GeneralMemberId = $_REQUEST["GeneralMemberId"] ?? '';
        $userData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger, curr.Ratio FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$GeneralMemberId."' ");
        $priceRatio = $userData[0]['Ratio'];
        $vCurrency = $userData[0]['vCurrencyPassenger'];
        if(isset($MSP)&& !empty($MSP)){
            $MSP = json_decode($MSP,true);
            $modifiedArray = array();
            $numItems = scount($MSP);
            $w = 1;
            if($numItems > 2){
                $waypoints = [];
                foreach($MSP as $M){
                    if(!in_array($w,[1, $numItems])){
                        $latlong = $M['lat'].','.$M['long'];
                        $waypoints[] = $latlong;
                    }
                    else if($w == 1){
                        $SOURCE_LATITUDE = $M['lat'];
                        $SOURCE_LONGITUDE = $M['long'];
                    }
                    else if($w == $numItems){
                        $DEST_LATITUDE = $M['lat'];
                        $DEST_LONGITUDE = $M['long'];
                    }
                    $w++;
                }
                $waypoints = json_encode($waypoints);
                $requestDataArr = array();
                $requestDataArr['SOURCE_LATITUDE'] = $SOURCE_LATITUDE;
                $requestDataArr['SOURCE_LONGITUDE'] = $SOURCE_LONGITUDE;
                $requestDataArr['DEST_LATITUDE'] = $DEST_LATITUDE;
                $requestDataArr['DEST_LONGITUDE'] = $DEST_LONGITUDE;
                $requestDataArr['LANGUAGE_CODE'] = $vLangCode;
                $requestDataArr['WAYPOINTS'] = $waypoints;
                $WHOLE_ROUTES = getPathInfoBetweenLocations($requestDataArr);
                if(isset($WHOLE_ROUTES['distance'])&& !empty($WHOLE_ROUTES['distance'])){
                    $returnArr['TOTAl_DISTANCE'] = $WHOLE_ROUTES['distance'];
                }
                $StartLetter = $letter = 'A';
                for($i = 0;
                $i < $numItems - 1;
                $i++){
                    $SOURCE = $MSP[$i];
                    $DEST = $MSP[$i + 1];
                    $requestDataArr = array();
                    $requestDataArr['SOURCE_LATITUDE'] = $SOURCE['lat'];
                    $requestDataArr['SOURCE_LONGITUDE'] = $SOURCE['long'];
                    $requestDataArr['DEST_LATITUDE'] = $DEST['lat'];
                    $requestDataArr['DEST_LONGITUDE'] = $DEST['long'];
                    $requestDataArr['LANGUAGE_CODE'] = $vLangCode;
                    $direction_data = getPathInfoBetweenLocations($requestDataArr);
                    $distance = $direction_data['distance'];
                    $duration = $direction_data['duration'];
                    $recommended_price = 0;
                    if(!empty($distance)&& strtoupper($RIDE_SHARE_ENABLE_RECOMMENDED_PRICE)== "YES"){
                        $recommended_price =($distance / 1000)* $RIDE_SHARE_RECOMNENDED_PRICE;
                        $recommended_price_1 = $recommended_price -($recommended_price * 0.2);
                        $recommended_price_2 = $recommended_price +($recommended_price * 0.2);
                        $recommended_price = number_format((($recommended_price_1 + $recommended_price_2)/ 2),2);
                        $recommended_price_text_with_currency_symbol = formateNumAsPerCurrency($recommended_price * $priceRatio,$vCurrency);
                        $recommended_price = $recommended_price * $priceRatio;
                    }
                    $l = $letter;
                    $letter = ord($letter)+ 1;
                    $letter1 = $letter = chr($letter);
                    $MSP[$i]['point'] = $l;
                    $MSP[$i + 1]['point'] = $letter1;
                    $modifiedArray[] = array('startPoint' => $MSP[$i], 'endPoint' => $MSP[$i + 1], 'recommended_price' => $recommended_price, 'duration' => $duration, 'distance' => $distance,);
                }
            }
            $returnArr['PointRecommendedPrice'] = $modifiedArray;
            return $returnArr;
        }
    }
    public function getCommission($iBookingId,$ssql){
        global $obj;
        $iBookingId = implode(",",array_unique($iBookingId));
        $sql = "SELECT IFNULL(SUM(IFNULL(fBookingFee, 0)), 0)as commission FROM ride_share_bookings rsb JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)JOIN register_user riderUser ON(riderUser.iUserId = rsb.iUserId)JOIN register_user riderDriver ON(riderDriver.iUserId = pr.iUserId)WHERE 1=1 AND iBookingId IN($iBookingId)$ssql ";
        $data_drv = $obj->MySQLSelect($sql);
        $arr['commission'] = $data_drv[0]['commission'];
        return $arr;
    }
    public function getTotalFare($iBookingId,$ssql){
        global $obj;
        $iBookingId = implode(",",array_unique($iBookingId));
        $sql = "SELECT IFNULL(SUM(IFNULL(fTotal, 0)), 0)as Total FROM ride_share_bookings rsb JOIN published_rides pr ON(pr.iPublishedRideId = rsb.iPublishedRideId)JOIN register_user riderUser ON(riderUser.iUserId = rsb.iUserId)JOIN register_user riderDriver ON(riderDriver.iUserId = pr.iUserId)WHERE 1=1 AND iBookingId IN($iBookingId)$ssql ";
        $data_drv = $obj->MySQLSelect($sql);
        $arr = $data_drv[0]['Total'];
        return $arr;
    }
    public function publishRideState(){
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $TripStateArr = $this->RideState($iPublishedRideId,$iUserId);
        if(!empty($TripStateArr)){
            $returnArr['Action'] = "1";
            $returnArr['message'] = $TripStateArr;
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "";
        }
        setDataResponse($returnArr);
    }
    public function publishRideUpdateState(){
        global $REFERRAL_OBJ;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $TripStateArr = $this->RideUpdateState($iPublishedRideId,$iUserId);
    }
    public function RideUpdateState($iPublishedRideId,$iUserId,$arrayPass = 0){
        global $obj;
        $TripStateArr = $this->RideState($iPublishedRideId,$iUserId);
        $RideCurrentState = $TripStateArr['RideState'];
        if($RideCurrentState == 'Start'){
            $pendingbookingArray = $TripStateArr['PendingBookingRequest'];
            if(!empty($pendingbookingArray)){
                if($pendingbookingArray['iPublishedRideId'] == $iPublishedRideId){
                    $returnArr['Action'] = "0";
                    $returnArr['message'] = "LBL_RIDE_SHARE_PENDING_NOTE";
                    $returnArr['vTitle'] = "LBL_RIDE_SHARE_REVIEW";
                    $returnArr['eIsBookingRidePending'] = "Yes";
                    if($arrayPass == 0){
                        setDataResponse($returnArr);
                    }
                }
            }
            $update_published_rides['dTripStartDate'] = date('Y-m-d H:i:s');
            $update_published_rides['eTrackingStatus'] = 'Start';
            $where = " iPublishedRideId = '".$iPublishedRideId."'";
            $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
            $this->tripStartEndNotify($iPublishedRideId,'RideShareStartTrip');
            $TripStateArr = $this->RideState($iPublishedRideId,$iUserId);
            $returnArr['Action'] = "1";
            $returnArr['message'] = $TripStateArr;
            if($arrayPass == 0){
                setDataResponse($returnArr);
            }
        }
        else if($RideCurrentState == 'MarkAsPickup'){
            $update_published_rides['markAsPickupDate'] = date('Y-m-d H:i:s');
            $update_published_rides['eTrackingStatus'] = 'MarkAsPickupALL';
            $where = " iPublishedRideId = '".$iPublishedRideId."'";
            $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
            $this->tripStartEndNotify($iPublishedRideId,'RideSharePickup');
            $TripStateArr = $this->RideState($iPublishedRideId,$iUserId);
            $returnArr['Action'] = "1";
            $returnArr['message'] = $TripStateArr;
            if($arrayPass == 0){
                setDataResponse($returnArr);
            }
        }
        else if($RideCurrentState == 'TripEnd'){
            $update_published_rides['dTripEndDate'] = date('Y-m-d H:i:s');
            $update_published_rides['eTrackingStatus'] = 'End';
            $where = " iPublishedRideId = '".$iPublishedRideId."'";
            $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
            $TripStateArr = $this->RideState($iPublishedRideId,$iUserId);
            $this->tripStartEndNotify($iPublishedRideId,'RideShareEndTrip');
            $returnArr['Action'] = "1";
            $returnArr['message'] = $TripStateArr;
            if($arrayPass == 0){
                setDataResponse($returnArr);
            }
        }
        else if($RideCurrentState == 'PaymentCollected'){
            $update_published_rides['PaymentCollectDate'] = date('Y-m-d H:i:s');
            $update_published_rides['eTrackingStatus'] = 'PaymentCollect';
            $where = " iPublishedRideId = '".$iPublishedRideId."'";
            $obj->MySQLQueryPerform("published_rides",$update_published_rides,'update',$where);
            $this->CreditReferralAmount($iPublishedRideId);
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_RIDE_SHARE_TRIP_END_SUCCESSFULLY";
            if($arrayPass == 0){
                setDataResponse($returnArr);
            }
        }
    }
    public function tripStartEndNotify($iPublishedRideId,$messageType){
        global $obj,$LANG_OBJ,$EVENT_MSG_OBJ;
        $sql = "SELECT vPublishedRideNo,iUserId FROM published_rides as pr WHERE pr.iPublishedRideId = '".$iPublishedRideId."'";
        $published_rides_data = $obj->MySQLSelect($sql);
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $BookingListArr = $this->BookingList($vLang,$iPublishedRideId,[],'PublishRideTripStart');
        $rider_iUserId = array_column($BookingListArr,'rider_iUserId');
        $rider_iUserId = implode(',',$rider_iUserId);
        $riders_data = $obj->MySQLSelect("SELECT eHmsDevice,eDeviceType,vPhoneCode , vPhone, iUserId, vCurrencyPassenger, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName FROM `register_user` WHERE iUserId IN(".$rider_iUserId.")");
        $driver_data = $obj->MySQLSelect("SELECT vName, vLastName FROM `register_user` WHERE iUserId = '".$published_rides_data[0]['iUserId']."'");
        $NOTI_TEMPLATE = $messageType;
        $final_message = $generalDataArr = [];
        $final_message['Message'] = $NOTI_TEMPLATE;
        $final_message['MsgType'] = $NOTI_TEMPLATE;
        $final_message['time'] = time();
        $final_message['eType'] = "RideShare";
        if(isset($riders_data)&& !empty($riders_data)){
            foreach($riders_data as $rider){
                $vLang = $rider['vLang'];
                $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
                $message = str_replace('#DRIVER_NAME#',$driver_data[0]['vName'].' '.$driver_data[0]['vLastName'],$languageLabelsArr['LBL_PUBLISHED_RIDE_TRIP_STARTED']);
                if($messageType == "RideShareEndTrip"){
                    $message = $languageLabelsArr["LBL_RIDE_SHARE_TRIP_END_SUCCESSFULLY"];
                }
                else if($messageType == "RideSharePickup"){
                    $message = $languageLabelsArr["LBL_RIDE_SHARE_TRIP_PICKUP_RIDER"];
                }
                $alertMsg_db = $message;
                $final_message['vTitle'] = $message;
                $generalDataArr[] = array('eDeviceType' => $rider['eDeviceType'], 'deviceToken' => $rider['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $rider['eAppTerminate'], 'eDebugMode' => $rider['eDebugMode'], 'eHmsDevice' => $rider['eHmsDevice'], 'message' => $final_message, 'channelName' => "PASSENGER_".$rider['iUserId']);
            }
        }
        $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr),RN_PROVIDER);
    }
    public function CreditReferralAmount($iPublishedRideId){
        global $REFERRAL_OBJ;
        $BookingListArr = $this->BookingList($this->vLang,$iPublishedRideId,[],'PublishRideTripStart');
        $iBookingId_ARR = array_column($BookingListArr,'iBookingId');
        if(isset($iBookingId_ARR)&& !empty($iBookingId_ARR)){
            foreach($iBookingId_ARR as $bookId){
                $data = $REFERRAL_OBJ->CreditReferralAmountRideShare($bookId);
            }
        }
    }
    public function publishRidePaymentSummery(){
        global $LANG_OBJ;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $iPublishedRideId = isset($_REQUEST["iPublishedRideId"])?$_REQUEST["iPublishedRideId"]:'';
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang,"1","");
        $F_ARR = $this->RidePaymentSummery($iPublishedRideId);
        $returnArr['Action'] = "1";
        $returnArr['message']['Payment_summery_user'] = $F_ARR;
        setDataResponse($returnArr);
    }
    public function GetNearestRide(){
        global $obj,$LANG_OBJ,$tconfig,$RIDE_SHARE_BOOKING_FEE,$LIST_RIDES_LIMIT_BY_DISTANCE,$NUMBER_RIDE_SHOW_ON_HOME_PAGE;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $NoOfSeats = 1;
        $serverTimeZone = date_default_timezone_get();
        $dStartDate = $currentDate = date('Y-m-d');
        $startTime = $dStartDate." 00:00:00";
        $endTime = $dStartDate." 23:59:00";
        $currentDate = date('Y-m-d H:i:s');
        $startTimeServer = converToTz($startTime,$serverTimeZone,$vTimeZone);
        $endTimeeServer = converToTz($endTime,$serverTimeZone,$vTimeZone);
        $sql_cur = '';
        $sql_cur .= " AND pr.dStartDate >= '".$currentDate."'";
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $page = isset($_REQUEST['page'])?trim($_REQUEST['page']):1;
        $order_param = " dStartDate ASC ";
        $userData = $obj->MySQLSelect("SELECT vCurrencyPassenger FROM register_user WHERE iUserId = '$iUserId' ");
        $vCurrencyPassenger = $userData[0]['vCurrencyPassenger'];
        $serverTimeZone = date_default_timezone_get();
        if($this->IsAnyDocumentActive()){
            $sql_cur .= " AND rd.eApproveDoc = 'Yes' ";
        }
        $searchSql = "SELECT pr.*, rd.iUserId as iDriverId, CONCAT(rd.vName,' ',rd.vLastName)AS DriverName, CONCAT('+',rd.vPhoneCode,rd.vPhone)AS DriverPhone, rd.iUserId as DriveriUserId , rd.vImgName as DrivervImgName, ROUND((6371 * acos(cos(radians(".$tStartLat."))* cos(radians(ROUND(pr.tStartLat, 8)))* cos(radians(ROUND(pr.tStartLong, 8))- radians(".$tStartLong."))+ sin(radians(".$tStartLat."))* sin(radians(ROUND(pr.tStartLat, 8))))), 2)AS startDistance FROM published_rides pr LEFT JOIN register_user rd ON(rd.iUserId = pr.iUserId)WHERE 1=1 $sql_cur AND pr.iUserId != {
            $iUserId
        }
        AND pr.eStatus = 'Active' AND(pr.iAvailableSeats - pr.iBookedSeats)>= $NoOfSeats HAVING startDistance <= ".$LIST_RIDES_LIMIT_BY_DISTANCE." ORDER BY $order_param LIMIT $NUMBER_RIDE_SHOW_ON_HOME_PAGE";
        $published_rides = $obj->MySQLSelect($searchSql);
        $RECENTRIDE = [];
        if(isset($published_rides)&& !empty($published_rides)){
            $iPublishedRideId_arr = array_column($published_rides,'iPublishedRideId');
            $iPublishedRideId_arr = implode(',',$iPublishedRideId_arr);
            $sql = "SELECT MAX(prw.iBookedSeats)AS waypoints_iBookedSeats , iPublishedRideId FROM published_rides_waypoints prw WHERE `iPublishedRideId` IN($iPublishedRideId_arr)";
            $published_rides_waypoints = $obj->MySQLSelect($sql);
            $RideWayPoint = [];
            if(isset($published_rides_waypoints)&& !empty($published_rides_waypoints)){
                foreach($published_rides_waypoints as $ridesWaypoint){
                    $RideWayPoint[$ridesWaypoint['iPublishedRideId']] = $ridesWaypoint['waypoints_iBookedSeats'];
                }
            }
            foreach($published_rides as $Ride){
                $waypointSeats = 0;
                if(isset($RideWayPoint[$Ride['iPublishedRideId']])&& $RideWayPoint[$Ride['iPublishedRideId']] > 0){
                    $waypointSeats = $RideWayPoint[$Ride['iPublishedRideId']];
                }
                $Recent_ride['iPublishedRideId'] = $Ride['iPublishedRideId'];
                $Recent_ride['startCity'] = $Ride['tStartCity'];
                $Recent_ride['endCity'] = $Ride['tEndCity'];
                $Recent_ride['tEndLocation'] = $Ride['tEndLocation'];
                $Recent_ride['tStartLocation'] = $Ride['tStartLocation'];
                $Recent_ride['iAvailableSeats'] = $Ride['iAvailableSeats'];
                $Recent_ride['iPendingSeats'] =($Ride['iAvailableSeats'] -($Ride['iBookedSeats'] + $waypointSeats));
                $Recent_ride['START_END_LOCATION'] = $Ride['tStartLocation'].' -> '.$Ride['tEndLocation'];
                $Recent_ride['AVAILABLE_SEATS_TXT'] = $Ride['iAvailableSeats'].' '.$languageLabelsArr['LBL_TOTAL_SEATS_OF_PASSANGER'];
                $Recent_ride['PENDING_SEATS_TXT'] = str_replace('#SEATS#',$Recent_ride['iPendingSeats'],$languageLabelsArr['LBL_RIDE_SHARE_NEAREST_RIDE_SEATS_AVAILABLE']);
                $search_seats = [];
                if($Recent_ride['iPendingSeats'] > 0){
                    for($i = 1;
                    $i <= $Recent_ride['iPendingSeats'];
                    $i++){
                        $search_seats[] = $i;
                    }
                    $Recent_ride['SEARCH_SEATS'] = $search_seats;
                }
                $Recent_ride['tStartLat'] = $Ride['tStartLat'];
                $Recent_ride['tStartLong'] = $Ride['tStartLong'];
                $Recent_ride['tEndLat'] = $Ride['tEndLat'];
                $Recent_ride['tEndLong'] = $Ride['tEndLong'];
                $date = strtotime($Ride['dStartDate']);
                $current = strtotime(date("Y-m-d"));
                $datediff = $date - $current;
                $difference = floor($datediff /(60 * 60 * 24));
                if($difference == 0){
                    $day = $languageLabelsArr['LBL_Today'];
                }
                else if($difference > 1){
                    $day = date('D d F',strtotime($Ride['dStartDate']));
                }
                else if($difference > 0){
                    $day = date('D d F',strtotime($Ride['dStartDate']));
                }
                $Recent_ride['date'] = $day;
                $Recent_ride['dateFormat'] = date("d M, Y",strtotime($Ride['dStartDate']));
                if($Ride['dStartDate'] != "0000-00-00 00:00:00" && !empty($vTimeZone)){
                    $convertDate = converToTz($Ride['dStartDate'],$vTimeZone,$serverTimeZone);
                    $date_data_array = array('tdate' => $convertDate, 'langCode' => $vLangCode);
                    $dStartDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                    if(!empty($dStartDateFormat)){
                        $newFormat = $dStartDateFormat['tDisplayDate'];
                        $Recent_ride['tDisplayDate'] = $newFormat;
                        $Recent_ride['dateFormat'] = date("Y-m-d",strtotime($convertDate));
                    }
                }
                $RECENTRIDE[] = $Recent_ride;
            }
        }
        if(!empty($RECENTRIDE)){
            $returnArr['Action'] = "1";
            $returnArr['message'] = $RECENTRIDE;
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = 'LBL_NO_DATA_AVAIL';
        }
        setDataResponse($returnArr);
    }
    public function getTravelPreferences(){
        global $obj;
        $vLang = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $GeneralMemberId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $GeneralUserType = isset($_REQUEST['GeneralUserType'])?trim($_REQUEST['GeneralUserType']):'';
        $sql = "SELECT vTravelPreferencesIds FROM register_user WHERE iUserId = {
            $GeneralMemberId
        }
        ";
        $register_user_data = $obj->MySQLSelect($sql);
        $register_user_data = $register_user_data[0];
        $vTravelPreferencesIdsArr = [];
        if(isset($register_user_data['vTravelPreferencesIds'])&& !empty($register_user_data['vTravelPreferencesIds'])){
            $vTravelPreferencesIdsArr = explode(',',$register_user_data['vTravelPreferencesIds']);
        }
        $sql = "SELECT iTravelPreferencesCategoryId,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_".$vLang."'))as vCategory FROM travel_preferences_category WHERE eStatus = 'Active' ORDER BY vTitle ASC ";
        $category = $obj->MySQLSelect($sql);
        $sql = "SELECT eDeafultSelected,iTravelPreferencesCategoryId,TravelPreferencesId,JSON_UNQUOTE(JSON_VALUE(vTitle, '$.vTitle_".$vLang."'))as Title FROM `travel_preferences` WHERE eStatus = 'Active'";
        $travel_preferences = $obj->MySQLSelect($sql);
        $TRAVEL_PREFERENCES_ARR = [];
        if(isset($travel_preferences)&& !empty($travel_preferences)){
            foreach($travel_preferences as $preferences){
                $iTravelPreferencesCategoryId = $preferences['iTravelPreferencesCategoryId'];
                $preferences['Selected'] = 'No';
                if(in_array($preferences['TravelPreferencesId'],$vTravelPreferencesIdsArr)){
                    $preferences['Selected'] = 'Yes';
                }
                unset($preferences['iTravelPreferencesCategoryId'],$preferences['eDeafultSelected']);
                $TRAVEL_PREFERENCES_ARR[$iTravelPreferencesCategoryId][] = $preferences;
            }
        }
        $FINAL_ARR = [];
        if(isset($category)&& !empty($category)){
            foreach($category as $cat){
                $cat['Option'] = $TRAVEL_PREFERENCES_ARR[$cat['iTravelPreferencesCategoryId']];
                if(isset($cat['Option'])&& !empty($cat['Option'])){
                    $FINAL_ARR[] = $cat;
                }
            }
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $FINAL_ARR;
        setDataResponse($returnArr);
    }
    public function UpdateTravelPreferences(){
        global $obj;
        $GeneralMemberId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $GeneralUserType = isset($_REQUEST['GeneralUserType'])?trim($_REQUEST['GeneralUserType']):'';
        $TravelPreferencesId = isset($_REQUEST["TravelPreferencesId"])?$_REQUEST["TravelPreferencesId"]:'';
        $data_update = [];
        $where = " iUserId = '".$GeneralMemberId."'";
        $data_update['vTravelPreferencesIds'] = $TravelPreferencesId;
        $id = $obj->MySQLQueryPerform("register_user",$data_update,'update',$where);
        $returnArr['Action'] = "1";
        $returnArr['message'] = "LBL_TRAVEL_PREFERENCES_UPDATE_SUCCESSFULLY";
        setDataResponse($returnArr);
    }
    public function addRideAlert(){
        global $obj;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $tStartLat = isset($_REQUEST["tStartLat"])?$_REQUEST["tStartLat"]:'';
        $tStartLong = isset($_REQUEST["tStartLong"])?$_REQUEST["tStartLong"]:'';
        $tEndLat = isset($_REQUEST["tEndLat"])?$_REQUEST["tEndLat"]:'';
        $tEndLong = isset($_REQUEST["tEndLong"])?$_REQUEST["tEndLong"]:'';
        $dStartDate = isset($_REQUEST["dStartDate"])?$_REQUEST["dStartDate"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $NoOfSeats = isset($_REQUEST["NoOfSeats"])?$_REQUEST["NoOfSeats"]:'1';
        $vFilterParam = isset($_REQUEST["vFilterParam"])?$_REQUEST["vFilterParam"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'1';
        $systemTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $dStartDate = converToTz($dStartDate,$systemTimeZone,$vTimeZone);
        }
        $Data_Insert['tStartLat'] = $tStartLat;
        $Data_Insert['tStartLong'] = $tStartLong;
        $Data_Insert['tEndLat'] = $tEndLat;
        $Data_Insert['tEndLong'] = $tEndLong;
        $Data_Insert['NoOfSeats'] = $NoOfSeats;
        $Data_Insert['dStartDate'] = $dStartDate;
        $Data_Insert['iUserId'] = $iUserId;
        $obj->MySQLQueryPerform("ride_alert",$Data_Insert,'insert');
        $returnArr['Action'] = 1;
        $returnArr['message'] = 'LBL_INFORM_NEW_RIDE_POST_RIDE_SHARE_TEXT';
        setDataResponse($returnArr);
    }
    public function RideShareRating(){
        global $obj;
        $FromUserId = $_REQUEST["GeneralMemberId"] ?? '';
        $FromUserType = $_REQUEST["FromUserType"] ?? '';
        $ToUserId = $_REQUEST["ToUserId"] ?? '';
        $tMessage = $_REQUEST["tMessage"] ?? '';
        $rating = $_REQUEST["rating"] ?? '';
        $iBookingId = $_REQUEST["iBookingId"] ?? '';
        if($FromUserType == "rider"){
            $FromUserType = "Passenger";
        }
        $ride_share_bookings = $obj->MySQLSelect("SELECT iPublishedRideId FROM `ride_share_bookings` WHERE iBookingId = $iBookingId");
        $ride_share_ratings = $obj->MySQLSelect("SELECT iPublishedRideId FROM `ride_share_ratings` WHERE iBookingId = $iBookingId AND eFromUserType = '".$FromUserType."' ");
        if(isset($ride_share_bookings)&& !empty($ride_share_bookings)&& scount($ride_share_ratings)== 0){
            $ToUserType = "Passenger";
            if($FromUserType == "Passenger"){
                $ToUserType = "Driver";
            }
            $Data_Insert['iBookingId'] = $iBookingId;
            $Data_Insert['fRating'] = $rating;
            $Data_Insert['tMessage'] = $tMessage;
            $Data_Insert['eUserType'] = $FromUserType;
            $Data_Insert['eFromUserType'] = $FromUserType;
            $Data_Insert['eToUserType'] = $ToUserType;
            $Data_Insert['iPublishedRideId'] = $ride_share_bookings[0]['iPublishedRideId'];
            $Data_Insert['tDate'] = date('Y-m-d H:i:s');
            $obj->MySQLQueryPerform("ride_share_ratings",$Data_Insert,'insert');
            $returnArr['Action'] = '1';
            $returnArr['message'] = 'LBL_SUCCESS_RATING_SUBMIT_TXT';
        }
        else {
            $returnArr['Action'] = '0';
            $returnArr['message'] = 'LBL_ERROR_OCCURED';
        }
        setDataResponse($returnArr);
    }
    public function WebCommonParam(){
        global $obj;
        $iUserId = $_SESSION['sess_iUserId'];
        $lang = $_SESSION['sess_lang'];
        $userData = $obj->MySQLSelect("SELECT vTimeZone FROM register_user as ru WHERE ru.iUserId = '".$iUserId."' ");
        $_REQUEST["GeneralMemberId"] = $iUserId;
        $_REQUEST["vGeneralLang"] = $lang;
        $_REQUEST["vTimeZone"] = $userData[0]['vTimeZone'];
        $_REQUEST["SYSTEM_TYPE"] = "WEB";
        if(empty($_REQUEST["vTimeZone"])){
            $_REQUEST["vTimeZone"] = date_default_timezone_get();
        }
    }
    public function AdminCommonParam(){
        global $obj,$LANG_OBJ;
        $_REQUEST["vGeneralLang"] = $LANG_OBJ->FetchDefaultLangData("vCode");
        $_REQUEST["vTimeZone"] = date_default_timezone_get();
        $_REQUEST["SYSTEM_TYPE"] = "ADMIN";
    }
    public function getDisplayStatusForAdmin($DBStatus,$DBBookingStatus){
        $Status = '';
        if(in_array($DBBookingStatus,['Declined','Cancelled'])){
            $Status = $DBBookingStatus;
        }
        else if(in_array($DBStatus,['PaymentCollect'])&& $DBBookingStatus != "Pending"){
            $Status = "Completed";
        }
        else if(in_array($DBStatus,['Start','MarkAsPickupALL','End'])){
            $Status = "On Going Trip";
        }
        else if(in_array($DBStatus,['Pending'])|| $DBBookingStatus == "Pending"){
            $Status = $DBBookingStatus;
        }
        $arr['status'] = $Status;
        return $arr;
    }
    public function GetUserDocument(){
        global $obj,$tconfig,$LANG_OBJ;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $vLangCode = isset($_REQUEST["vGeneralLang"])?$_REQUEST["vGeneralLang"]:'';
        $SYSTEM_TYPE = isset($_REQUEST["SYSTEM_TYPE"])?$_REQUEST["SYSTEM_TYPE"]:'';
        $vTimeZone = isset($_REQUEST["vTimeZone"])?$_REQUEST["vTimeZone"]:'';
        $serverTimeZone = date_default_timezone_get();
        $UserData = get_value('register_user','vCountry,vLang','iUserId',$iUserId);
        $vCountry = $UserData[0]['vCountry'];
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1","");
        $documents = $obj->MySQLSelect("SELECT rdl.eApproveDoc , rdl.ex_date,rdl.doc_file,rdl.doc_id,(SELECT CASE WHEN COUNT(*)> 0 THEN 'Yes' ELSE 'No' END as 'isUploaded' FROM `ride_share_document_list` WHERE doc_masterid = dm.doc_masterid AND doc_userid = {
            $iUserId
        })as isUploaded,dm.doc_masterid, dm.ex_status, dm.doc_name_$vLangCode as doc_name FROM document_master as dm LEFT JOIN ride_share_document_list rdl ON(rdl.doc_masterid = dm.doc_masterid AND doc_userid = {
            $iUserId
        })WHERE(dm.country='".$vCountry."' OR dm.country='All')and dm.doc_usertype = 'user' AND dm.status = 'Active' ORDER BY iDisplayOrder ASC ");
        $img_path = $tconfig["tsite_upload_ride_share_documents"];
        $Photo_Gallery_folder = $img_path.'/'.$iUserId.'/';
        $Photo_Gallery_folder_path = $tconfig["tsite_upload_ride_share_documents_path"].'/'.$iUserId.'/';
        if(!empty($documents)){
            $i = 0;
            foreach($documents as $document){
                $ex_date = $document['ex_date'];
                $todaydate = date('Y-m-d');
                if($ex_date == "" || $ex_date == "0000-00-00" || $ex_date == "0000-00-00" || $ex_date <= "1970-01-01"){
                    $expire_document = "No";
                }
                else {
                    if(strtotime($ex_date)< strtotime($todaydate)){
                        $expire_document = "Yes";
                    }
                    else {
                        $expire_document = "No";
                    }
                }
                $documents[$i]['EXPIRE_DOCUMENT'] = $expire_document;
                $expireLabel = $languageLabelsArr['LBL_EXPIRE_TXT'];
                if($document['ex_date'] != "0000-00-00"){
                    $date_data_array = array('tdate' => converToTz($ex_date,$vTimeZone,$serverTimeZone), 'langCode' => $UserData[0]['vLang']);
                    $getUserDocumentDateFormat = DateformatCls::getNewDateFormat($date_data_array);
                    if(!empty($getUserDocumentDateFormat)){
                        foreach($getUserDocumentDateFormat as $Postinfo_datetime_key => $Postinfo_datetime_val){
                            $documents[$i][$Postinfo_datetime_key] = $Postinfo_datetime_val;
                        }
                        $documents[$i]['exp_date'] = $expireLabel.": ".$getUserDocumentDateFormat['tDisplayDate'];
                    }
                }
                $documents[$i]['eApproveDoc'] = $document['eApproveDoc'];
                if($document['eApproveDoc'] == "No"){
                    $documents[$i]['DOC_STATUS_TEXT'] = $languageLabelsArr['LBL_RIDE_SHARE_DOC_APPROVAL_TEXT'];
                }
                if(empty($document['doc_id'])){
                    $documents[$i]['doc_id'] = '';
                }
                if(empty($document['ex_date'])){
                    $documents[$i]['ex_date'] = '';
                }
                if(empty($document['doc_file'])){
                    $documents[$i]['doc_file'] = '';
                }
                else {
                    if(file_exists($Photo_Gallery_folder_path.$document['doc_file'])){
                        $documents[$i]['doc_file'] = $Photo_Gallery_folder.$document['doc_file'];
                        $documents[$i]['is_doc'] = "No";
                        $doc_file_arr = explode(".",$document['doc_file']);
                        $doc_file_ext = strtolower($doc_file_arr[scount($doc_file_arr)- 1]);
                        $images_ext_arr = explode(",",$tconfig["tsite_upload_image_file_extensions"]);
                        if(!in_array($doc_file_ext,$images_ext_arr)){
                            $documents[$i]['is_doc'] = "Yes";
                        }
                    }
                    else {
                        $documents[$i]['doc_file'] = '';
                    }
                }
                $i++;
            }
        }
        $returnArr['Action'] = '1';
        $returnArr['message'] = $documents;
        if($SYSTEM_TYPE == "WEB"){
            return $returnArr;
        }
        else {
            setDataResponse($returnArr);
        }
    }
    public function sendAlertToEmergencyContacts($dataArr,$iUserId,$UserType,$iPublishedRideId){
        global $obj,$SITE_ISD_CODE,$SITE_NAME,$LANG_OBJ,$COMM_MEDIA_OBJ;
        if(scount($dataArr)> 0){
            $PublishData = $this->getPublishRideById($iPublishedRideId);
            $userData = $obj->MySQLSelect("SELECT CONCAT(ru.vName, ' ', ru.vLastName)as RiderName, CONCAT('+', ru.vPhoneCode, ru.vPhone)as RiderPhone, ru.tSessionId, ru.vCurrencyPassenger, curr.Ratio FROM register_user as ru LEFT JOIN currency as curr ON ru.vCurrencyPassenger = curr.vName WHERE iUserId = '".$iUserId."' ");
            $tStartDate = $PublishData[0]['dStartDate'];
            $tripData[0]['iUserId'] = $PublishData[0]['iUserId'];
            $tripData[0]['tStartDate'] = $tStartDate;
            $tripData[0]['tTripRequestDate'] = $tStartDate;
            $trackingURL = $this->getGooglelocatiotionTrackingURL($iPublishedRideId,$PublishData[0]['iUserId']);
            $trackingFinalMessage = ".".$trackingURL;
            if(isset($trackingURL)&& !empty($trackingURL)){
                if($UserType == "Passenger"){
                    $vLangCode = get_value('register_user','vLang','iUserId',$iUserId,'','true');
                }
                if($vLangCode == "" || $vLangCode == NULL){
                    $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
                }
                $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode,"1",$iServiceId);
                $trackingMessage = $languageLabelsArr['LBL_PLEASE_CHECK_LAST_LOCATION_TRACKING_MESSAGE'];
                $trackingFinalMessage = $trackingURL;
            }
            $dataArraySMSNew['SITE_NAME'] = $SITE_NAME;
            $dataArraySMSNew['vDriverName'] = $PublishData[0]['PublisherName'];
            $dataArraySMSNew['DriverPhone'] = '+'.$PublishData[0]['vPhoneCode'].' '.$PublishData[0]['vPhone'];
            $dataArraySMSNew['tStartDate'] = date('dS M Y \a\t h:i a',strtotime($PublishData[0]['dStartDate']));
            $dataArraySMSNew['tSaddress'] = $PublishData[0]['tStartLocation'];
            $dataArraySMSNew['vPassengerName'] = $userData[0]['RiderName'];
            $dataArraySMSNew['PassengerPhone'] = $userData[0]['RiderPhone'];
            $dataArraySMSNew['vLicencePlate'] = '';
            $dataArraySMSNew['trackingURL'] = $trackingFinalMessage;
            $dataArraySMSNew['PassengerName'] = $userData[0]['RiderName'];
            $dataArraySMSNew['StartDate'] = date('dS M Y \a\t h:i a',strtotime($PublishData[0]['dStartDate']));
            $dataArraySMSNew['Saddress'] = $PublishData[0]['tStartLocation'];
            $dataArraySMSNew['DriverName'] = $PublishData[0]['PublisherName'];
            $dataArraySMSNew['LicencePlate'] = '';
            $message = $COMM_MEDIA_OBJ->GetSMSTemplate('EMERGENCY_SMS_FOR_USER_RIDE',$dataArraySMSNew,"",$vLangCode);
            for($i = 0;
            $i < scount($dataArr);
            $i++){
                $phone = preg_replace("/[^0-9]/","",$dataArr[$i]['vPhone']);
                $toMobileNum = "+".$phone;
                if($UserType == "Passenger"){
                    $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM `register_user` AS r, `country` AS c WHERE r.iUserId = $iUserId AND r.vCountry = c.vCountryCode");
                }
                else {
                    $passengerData = $obj->MySQLSelect("SELECT r.vPhone,c.vPhoneCode FROM `register_driver` AS r, `country` AS c WHERE r.iDriverId = $iUserId AND r.vCountry = c.vCountryCode");
                }
                $PhoneCode = $passengerData[0]['vPhoneCode'];
                $result = $COMM_MEDIA_OBJ->SendSystemSMS($toMobileNum,$PhoneCode,$message);
                $datainsert = array();
                $datainsert['iEmergencyId'] = $dataArr[$i]['iEmergencyId'];
                $datainsert['vContactName'] = $dataArr[$i]['vName'];
                $datainsert['vContactPhone'] = $phone;
                $datainsert['iDriverId'] = 0;
                $datainsert['iUserId'] = $tripData[0]['iUserId'];
                $datainsert['iPublishedRideId'] = $iPublishedRideId;
                $datainsert['vFromUserType'] = $UserType;
                $datainsert['tMessage'] = $message;
                $datainsert["tRequestDate"] = @date("Y-m-d H:i:s");
                $id = $obj->MySQLQueryPerform("emergency_contact_data",$datainsert,'insert');
            }
            UpdateUserSmsLimitForEmergency($iUserId,$UserType);
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_EME_CONTACT_ALERT_SENT";
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_ADD_EME_CONTACTS";
            $returnArr['message1'] = "ContactError";
        }
        setDataResponse($returnArr);
    }
    public function getGooglelocatiotionTrackingURL($iPublishedRideId,$iUserId){
        $trackingURL = '';
        if(isset($iPublishedRideId)&& !empty($iPublishedRideId)){
            $registerUserData = get_value('register_user','vLatitude,vLongitude','iUserId',$iUserId);
            $lasttPlatitudes = $registerUserData[0]['vLatitude'];
            $lasttPlongitudes = $registerUserData[0]['vLongitude'];
            if(isset($lasttPlongitudes)&& !empty($lasttPlongitudes)){
                $formatted_address = getLocationNameLatLog($lasttPlatitudes,$lasttPlongitudes);
                if(!empty($formatted_address)){
                    $geoUrl = "http://maps.google.com/maps?q=".urlencode($formatted_address);
                }
                else {
                    $geoUrl = "http://maps.google.com/maps?q=loc:".$lasttPlatitudes.",".$lasttPlongitudes;
                }
                $trackingURL = get_tiny_url($geoUrl);
            }
        }
        return $trackingURL;
    }
    public function IsAnyDocumentActive(){
        global $obj;
        $iUserId = isset($_REQUEST["GeneralMemberId"])?$_REQUEST["GeneralMemberId"]:'';
        $UserData = get_value('register_user','vCountry,vLang','iUserId',$iUserId);
        $vCountry = $UserData[0]['vCountry'];
        $documents = $obj->MySQLSelect("SELECT COUNT(dm.doc_masterid)as document_count FROM document_master as dm WHERE(dm.country='".$vCountry."' OR dm.country='All')and dm.doc_usertype = 'user' AND dm.status = 'Active' ORDER BY iDisplayOrder ASC ");
        if(isset($documents[0]['document_count'])&& !empty($documents[0]['document_count'])){
            return true;
        }
        else {
            return false;
        }
    }
}
class RiderReward {
    function __construct(){
        global $obj;
    }
    public function GiveRiderReward($iUserId,$iTripId){
        global $obj,$USER_REWARD_AMOUNT_FOR_COINS,$USER_REWARD_COINS_FOR_DISTANCE,$WALLET_OBJ,$DEFAULT_DISTANCE_UNIT,$COMM_MEDIA_OBJ,$MAXIMUM_USER_REWARD_AMOUNT_PER_TRIP,$MAXIMUM_NO_TRIPS_ALLOWED_USER_REWARD;
        $yes_to_reaward = [];
        $TripDetails = $obj->MySQLSelect("SELECT * FROM `trips` WHERE `iTripId` = " . $iTripId);
        $fDistance = $TripDetails[0]['fDistance'];
        $getPaymentStatus = $obj->MySQLSelect("SELECT iTripId,eUserType,ePaymentStatus,iUserWalletId,eType,eFor FROM user_wallet WHERE iTripId='" . $iTripId . "' AND eUserType='Rider'");
        $walletArr = array();
        for($h = 0;
        $h < scount($getPaymentStatus);
        $h++){
            $walletArr[$getPaymentStatus[$h]['eType']][$getPaymentStatus[$h]['eUserType']][$getPaymentStatus[$h]['iTripId']][$getPaymentStatus[$h]['eFor']] = $getPaymentStatus[$h]['eType'];
        }
        if($DEFAULT_DISTANCE_UNIT == "Miles"){
            $tripDistanceDisplay = $fDistance * 0.621371;
        }
        else {
            $tripDistanceDisplay = $fDistance;
        }
        $tripDistanceDisplayNumber = floor($tripDistanceDisplay);
        $UserRewardscoins = $tripDistanceDisplayNumber*$USER_REWARD_COINS_FOR_DISTANCE;
        $getTotalTrips = $this->getTotalUserTrips($iUserId,'Ride');
        if($UserRewardscoins > 0 && $getTotalTrips <= $MAXIMUM_NO_TRIPS_ALLOWED_USER_REWARD){
            $Userrewardamounts = $UserRewardscoins*$USER_REWARD_AMOUNT_FOR_COINS;
            if($Userrewardamounts > $MAXIMUM_USER_REWARD_AMOUNT_PER_TRIP){
                $Userrewardamounts = $MAXIMUM_USER_REWARD_AMOUNT_PER_TRIP;
            }
            $update_sql = "UPDATE trips set fUserRewardsCoins = '".$UserRewardscoins."' WHERE iTripId ='" . $iTripId . "'";
            $result = $obj->sql_query($update_sql);
            $data_wallet['iUserId'] = $iUserId;
            $data_wallet['eUserType'] = "Rider";
            $data_wallet['iBalance'] = $Userrewardamounts;
            $data_wallet['eType'] = "Credit";
            $data_wallet['dDate'] = date("Y-m-d H:i:s");
            $data_wallet['iTripId'] = $iTripId;
            $data_wallet['eFor'] = "Deposit";
            $data_wallet['ePaymentStatus'] = "Settelled";
            $data_wallet['tDescription'] = "#LBL_REWARD_AMOUNT_CREDITED_USER#";
            if(!isset($walletArr["Credit"]['Rider'][$iTripId]["Deposit"])){
                $WALLET_OBJ->PerformWalletTransaction($data_wallet['iUserId'], $data_wallet['eUserType'], $data_wallet['iBalance'], $data_wallet['eType'], $data_wallet['iTripId'], $data_wallet['eFor'], $data_wallet['tDescription'], $data_wallet['ePaymentStatus'], $data_wallet['dDate']);
            }
            $sql12 = "SELECT vEmail, CONCAT(vName,' ',vLastName)as username, vCurrencyPassenger from register_user where iUserId='" . $iUserId . "'";
            $db_user_data = $obj->MySQLSelect($sql12);
            $vCurrencyPassenger =$db_user_data[0]['vCurrencyPassenger'];
            $userCurrencyData = $obj->MySQLSelect("SELECT vSymbol,vName,Ratio FROM currency WHERE vName='" . $vCurrencyPassenger . "'");
            $userCurrencySymbol = $userCurrencyData[0]['vSymbol'];
            $userCurrencyRatio = $userCurrencyData[0]['Ratio'];
            $Userrewardamounts = round(($Userrewardamounts * $userCurrencyRatio), 2);
            $maildatadeliverd['vEmail'] = $db_user_data[0]['vEmail'];
            $maildatadeliverd['UserName'] =$db_user_data[0]['username'];
            $maildatadeliverd['EMAIL_NAME'] =$db_user_data[0]['username'];
            $maildatadeliverd['vRideNo'] =$TripDetails[0]['vRideNo'];
            $maildatadeliverd['amount'] = formateNumAsPerCurrency($Userrewardamounts, $vCurrencyPassenger);
            $mailResponse = $COMM_MEDIA_OBJ->SendMailToMember("REWARD_AMOUNT_CREDIT_TO_USER", $maildatadeliverd);
            $yes_to_reaward['status'] = 1;
        }
        else {
            $yes_to_reaward['status'] = 0;
        }
        return $yes_to_reaward;
    }
    public function getTotalUserTrips($iUserId,$eType='Ride'){
        global $obj;
        $TripDetails = $obj->MySQLSelect("SELECT count(iTripId)as TotalRideTrips from trips where iUserId='" . $iUserId . "' AND iActive = 'Finished' AND eType='".$eType."'");
        $NumberofTrips = $TripDetails[0]['TotalRideTrips'];
        return $NumberofTrips;
    }
}
class ScheduleRide {
    public $SCHEDULE_RIDE_DRIVER_REQUEST,$ACCEPTED_TEXT;
    function __construct(){
        $this->SCHEDULE_RIDE_DRIVER_REQUEST = "schedule_ride_driver_request";
        $this->ACCEPTED_TEXT = "Assign";
    }
    public function sendRequestToDriverForScheduleRide($iCabBookingId, $action, $iDriverId = ''){
        global $EVENT_MSG_OBJ, $obj, $LIST_DRIVER_LIMIT_BY_DISTANCE, $RIDE_LATER_ON_GOING_TRIP_PROVIDER_RECEIVED_REQUEST_TIME_INTERVAL, $LANG_OBJ, $RIDE_LATER_SEND_REQUEST_TOTAL_NUMBER_OF_DRIVER;
        $eBookingFrom = isset($_REQUEST['eBookingFrom'])? $_REQUEST['eBookingFrom'] : '';
        $eType = "Ride";
        $sqldata = "SELECT iDriverId,vBookingNo,iUserId,tTotalDuration,dBooking_date, vSourceLatitude , vSourceLongitude,iVehicleTypeId FROM `cab_booking` WHERE iCabBookingId ='" . $iCabBookingId . "' AND eType = '" . $eType . "' ";
        $cab_booking = $obj->MySQLSelect($sqldata);
        $cab_booking = $cab_booking[0];
        $dBooking_date = $cab_booking['dBooking_date'];
        $tTotalDuration = $cab_booking['tTotalDuration'];
        $iUserId = $cab_booking['iUserId'];
        $vBookingNo = $cab_booking['vBookingNo'];
        if(isset($cab_booking)&& !empty($cab_booking)){
            $getUserData = $obj->MySQLSelect("SELECT vLang FROM register_user WHERE iUserId='" . $iUserId . "'");
            $getUserData = $getUserData[0];
            $vLang = $getUserData['vLang'];
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1");
            $vLatitude = 'vLatitude';
            $vLongitude = 'vLongitude';
            $iDriverIds = $iDriverId;
            $DriverId = "";
            if($iDriverId > 0){
                $DriverId = "AND iDriverId IN(" . $iDriverId . ")";
            }
            $sourceLat = $cab_booking['vSourceLatitude'];
            $sourceLon = $cab_booking['vSourceLongitude'];
            $currentDate = $Date = date("Y-m-d H:i:s");
            $additional_mins =($RIDE_LATER_ON_GOING_TRIP_PROVIDER_RECEIVED_REQUEST_TIME_INTERVAL * 60);
            $OnGoingDriverInterval = date("Y-m-d H:i:s", strtotime($currentDate)+ $additional_mins);
            $sql = "SELECT tLastOnline, vTripStatus,iDriverVehicleId,iDriverId, ROUND((6371 * acos(cos(radians(" . $sourceLat . "))* cos(radians(ROUND(" . $vLatitude . ",8)))* cos(radians(ROUND(" . $vLongitude . ",8))- radians(" . $sourceLon . "))+ sin(radians(" . $sourceLat . "))* sin(radians(ROUND(" . $vLatitude . ",8))))),2)AS distance,iDriverId FROM `register_driver` WHERE(" . $vLatitude . " != '' AND " . $vLongitude . " != '' AND eStatus='active' AND eIsBlocked = 'No')HAVING distance < " . $LIST_DRIVER_LIMIT_BY_DISTANCE . " $DriverId ORDER BY tLastOnline DESC , distance ASC";
            $DRIVER_ARR = $obj->MySQLSelect($sql);
            if(strtoupper($action)== "EDIT"){
                $bookingAcceptedDriverId = $cab_booking['iDriverId'];
                $this->sendNotiToDriver($bookingAcceptedDriverId, 'LBL_RIDE_LATER_RESCHEDULE_RIDE_CANCEL_EXISTING_RIDE', ['#BOOKING_NO#'], [$vBookingNo], 'rideLaterBookingRequest');
                $this->cancelExistingRequest($iCabBookingId);
                $where = " iCabBookingId = '$iCabBookingId' ";
                $Data = [];
                $Data['eStatus'] = 'Pending';
                if($eBookingFrom == 'Admin' && $iDriverIds > 0){
                }
                else {
                    $Data['iDriverId'] = '';
                }
                $Data['eAssigned'] = 'No';
                $Update_Booking_id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
            }
            if(isset($DRIVER_ARR)&& !empty($DRIVER_ARR)){
                $sendNotificationDriverArr = [];
                $iDriverVehicleIdARR = array_column($DRIVER_ARR, 'iDriverVehicleId');
                $iDriverVehicleIdARR = implode(',', array_filter($iDriverVehicleIdARR));
                $sql = "SELECT iDriverId,vCarType,eHandiCapAccessibility FROM `driver_vehicle` WHERE eStatus = 'Active' AND iDriverVehicleId IN(" . $iDriverVehicleIdARR . ")";
                $DRIVER_VEHICLE_ARR = $obj->MySQLSelect($sql);
                $DRIVER_AND_VEHICLE = [];
                if(isset($DRIVER_VEHICLE_ARR)&& !empty($DRIVER_VEHICLE_ARR)){
                    foreach($DRIVER_VEHICLE_ARR as $DRIVER_VEHICLE){
                        $DRIVER_AND_VEHICLE[$DRIVER_VEHICLE['iDriverId']] = $DRIVER_VEHICLE;
                    }
                }
                $iVehicleTypeId = $cab_booking['iVehicleTypeId'];
                $tHistory = [];
                $tHistory['status'] = 'Pending';
                $tHistory['date'] = $currentDate;
                $BULK_INSERT_DATA = [];
                foreach($DRIVER_ARR as $DRIVER){
                    $DriverVehicleTypeArr = explode(",", $DRIVER_AND_VEHICLE[$DRIVER['iDriverId']]['vCarType']);
                    $isRemoveFromList = "No";
                    if(strtotime($OnGoingDriverInterval)> strtotime($dBooking_date)&& in_array($DRIVER['vTripStatus'], ['Arrived', 'On Going Trip', 'Active'])){
                        $isRemoveFromList = "Yes";
                    }
                    if($isRemoveFromList == "No"){
                        if(!in_array($iVehicleTypeId, $DriverVehicleTypeArr)){
                            $isRemoveFromList = "Yes";
                        }
                    }
                    if($isRemoveFromList == "No"){
                        $TripExists = $this->CheckSameTimeAnyBookingAccepted($dBooking_date, $iCabBookingId, $DRIVER['iDriverId'], $tTotalDuration);
                        if(scount($TripExists)> 0){
                            $isRemoveFromList = "Yes";
                        }
                    }
                    if($isRemoveFromList == "No"){
                        $sendNotificationDriverArr[] = $DRIVER['iDriverId'];
                        $DataInsert = [];
                        $DataInsert[] = $iCabBookingId;
                        $DataInsert[] = $DRIVER['iDriverId'];
                        $DataInsert[] = $eType;
                        $DataInsert[] = 'Pending';
                        $DataInsert[] = 'No';
                        $DataInsert[] = json_encode($tHistory);
                        $BULK_INSERT_DATA[] = $DataInsert;
                    }
                }
                $sql = "INSERT INTO schedule_ride_driver_request(iCabBookingId, iDriverId,eType,eStatus,eShown,tHistory)VALUES ";
                $values = array();
                foreach($BULK_INSERT_DATA as $row){
                    $values[] = "('" . implode("', '", $row). "')";
                }
                $sql .= implode(", ", $values);
                $obj->MySQLSelect($sql);
                $this->DriverNotifyForNewRequest($sendNotificationDriverArr, $obj, $languageLabelsArr, $vLang, $vBookingNo, $EVENT_MSG_OBJ);
            }
        }
    }
    public function sendNotiToDriver($bookingAcceptedDriverId, $alertMessage, $search_arr, $replace_arr, $templete){
        global $obj, $EVENT_MSG_OBJ;
        $bookingAcceptedDriverId = 33;
        $sql_driver_status_chk = "SELECT vTripStatus,iGcmRegId,eDeviceType,iDriverId,vLang,tSessionId,iAppVersion,eAppTerminate,eDebugMode,eHmsDevice,vCurrencyDriver FROM register_driver WHERE iDriverId = {
            $bookingAcceptedDriverId
        }
        ";
        $DRIVER_DATA = $obj->MySQLSelect($sql_driver_status_chk)[0];
        $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', $alertMessage, " and vCode='" . $DRIVER_DATA['vLang'] . "'", 'true');
        $alertMessage = str_replace($search_arr, $replace_arr, $alertMsg_db);
        $alertMsg_db = $alertMessage;
        $NOTI_TEMPLATE = $templete;
        $final_message['Message'] = $NOTI_TEMPLATE;
        $final_message['MsgType'] = $NOTI_TEMPLATE;
        $final_message['time'] = time();
        $final_message['eType'] = "Ride";
        $final_message['MsgCode'] = strval(time(). mt_rand(1000, 9999));
        $generalDataArr[] = array('eDeviceType' => $DRIVER_DATA['eDeviceType'], 'deviceToken' => $DRIVER_DATA['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $DRIVER_DATA['eAppTerminate'], 'eDebugMode' => $DRIVER_DATA['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $DRIVER_DATA['eHmsDevice'], 'channelName' => "DRIVER_" . $DRIVER_DATA['iDriverId']);
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
    }
    public function cancelExistingRequest($iCabBookingId){
        global $obj;
        $data_update = [];
        $where = " iCabBookingId = '" . $iCabBookingId . "'";
        $data_update['eStatus'] = "Rescheduled";
        $obj->MySQLQueryPerform($this->SCHEDULE_RIDE_DRIVER_REQUEST, $data_update, 'update', $where);
    }
    public function CheckSameTimeAnyBookingPending($dBooking_date, $iCabBookingId, $iDriverId, $tTotalDuration){
        global $RIDE_LATER_PROVIDER_ACCEPT_TIME_INTERVAL, $obj;
        $additional_mins =($RIDE_LATER_PROVIDER_ACCEPT_TIME_INTERVAL * 60);
        $FromDate = date("Y-m-d H:i:s", strtotime($dBooking_date)- $additional_mins);
        $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_mins);
        if($tTotalDuration > 0){
            $additional_seconds = $additional_mins +($tTotalDuration * 60);
            $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_seconds);
        }
        $sql = "SELECT iCabBookingId from cab_booking WHERE eStatus = 'Pending' AND(dBooking_date BETWEEN '" . $FromDate . "' AND '" . $ToDate . "')AND iCabBookingId != '" . $iCabBookingId . "'";
        $checkbookingdate = $obj->MySQLSelect($sql);
        $RETURN_ARR['PendingTrip'] = false;
        if(isset($checkbookingdate)&& !empty($checkbookingdate)){
            $cab_booking_arr = array_column($checkbookingdate, "iCabBookingId");
            $cab_booking_arr = implode(',', $cab_booking_arr);
            $getDriverVehicleData = $obj->MySQLSelect("SELECT iDriverId,iCabBookingId FROM $this->SCHEDULE_RIDE_DRIVER_REQUEST WHERE iCabBookingId IN($cab_booking_arr)AND iDriverId = $iDriverId AND eStatus = 'Pending' ");
            if(isset($getDriverVehicleData)&& !empty($getDriverVehicleData)){
                $RETURN_ARR['PendingTrip'] = true;
                $RETURN_ARR['PendingTripData'] = $getDriverVehicleData;
            }
        }
        return $RETURN_ARR;
    }
    public function CheckSameTimeAnyBookingAccepted($dBooking_date, $iCabBookingId, $iDriverId, $tTotalDuration){
        global $RIDE_LATER_PROVIDER_ACCEPT_TIME_INTERVAL, $obj;
        $additional_mins =($RIDE_LATER_PROVIDER_ACCEPT_TIME_INTERVAL * 60);
        $FromDate = date("Y-m-d H:i:s", strtotime($dBooking_date)- $additional_mins);
        $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_mins);
        if($tTotalDuration > 0){
            $additional_seconds = $additional_mins +($tTotalDuration * 60);
            $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_seconds);
        }
        $SQL = " AND eStatus = '" . $this->ACCEPTED_TEXT . "' ";
        $sql = "SELECT iCabBookingId from cab_booking WHERE(dBooking_date BETWEEN '" . $FromDate . "' AND '" . $ToDate . "')AND iCabBookingId != '" . $iCabBookingId . "' $SQL AND iDriverId = '" . $iDriverId . "'";
        $checkbookingdate = $obj->MySQLSelect($sql);
        return $checkbookingdate;
    }
    public function updateHistory($Data, $iDriverRequestId, $method, $where = ''){
        global $obj;
        $CData = date("Y-m-d H:i:s");
        if(strtoupper($method)== strtoupper("insert")){
            $tHistory = [];
            $tHistory['status'] = $Data['eStatus'];
            $tHistory['date'] = $CData;
            $data_update = [];
            $where = " iDriverRequestId = '" . $iDriverRequestId . "'";
            $data_update['tHistory'] = json_encode($tHistory);
            $obj->MySQLQueryPerform($this->SCHEDULE_RIDE_DRIVER_REQUEST, $data_update, 'update', $where);
        }
        else {
            $login_sql = "UPDATE schedule_ride_driver_request SET tHistory = JSON_ARRAY_APPEND(tHistory, '$', JSON_OBJECT('status', '" . $Data['eStatus'] . "', 'date', '" . $CData . "'))WHERE $where ";
            $obj->sql_query($login_sql);
        }
    }
    public function UpdateRideStatus(){
        global $EVENT_MSG_OBJ, $obj, $MODULES_OBJ, $WALLET_OBJ, $WALLET_MIN_BALANCE, $LANG_OBJ, $COMM_MEDIA_OBJ;
        $iCabBookingId = isset($_REQUEST["iCabBookingId"])? $_REQUEST["iCabBookingId"] : '';
        $eStatus = isset($_REQUEST["eStatus"])? $_REQUEST["eStatus"] : '';
        $iDriverId = isset($_REQUEST['iDriverId'])? $_REQUEST['iDriverId'] : '';
        $iDriverId = $GeneralMemberId = isset($_REQUEST['GeneralMemberId'])? $_REQUEST['GeneralMemberId'] : '';
        $vGeneralLang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : '';
        if($eStatus == "Accepted"){
            $eStatus = $this->ACCEPTED_TEXT;
        }
        $LanguageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vGeneralLang, '1');
        $eConfirmByProvider = isset($_REQUEST['eConfirmByProvider'])? $_REQUEST['eConfirmByProvider'] : 'No';
        if($eConfirmByProvider == "" || $eConfirmByProvider == NULL){
            $eConfirmByProvider = "No";
        }
        $obj->ExecuteQuery("START TRANSACTION");
        $sqldata = "SELECT iCabBookingId FROM `cab_booking` WHERE iCabBookingId ='" . $iCabBookingId . "' FOR UPDATE";
        $BookingData = $obj->MySQLSelect($sqldata);
        $DRIVER_DATA_SQL = "SELECT concat(vName,' ',vLastName)as DriverName,vTripStatus,iGcmRegId,eDeviceType,iDriverId,vLang,tSessionId,iAppVersion,eAppTerminate,eDebugMode,eHmsDevice,vCurrencyDriver FROM register_driver WHERE iDriverId = " . $iDriverId . " ";
        $DRIVER_DATA = $obj->MySQLSelect($DRIVER_DATA_SQL)[0];
        $sqldata = "SELECT ru.vTimeZone,ru.vLang,ru.iGcmRegId,ru.eDeviceType,ru.iUserId, ru.tSessionId,ru.iAppVersion,ru.eAppTerminate,ru.eDebugMode,ru.eHmsDevice,ru.vCurrencyPassenger, ru.vEmail,ru.vPhone,ru.vPhoneCode,ru.vLang, concat(ru.vName,' ',ru.vLastName)as UserName, cb.eStatus,cb.eStatus, cb.eType, cb.dBooking_date, cb.tTotalDuration, cb.ePayType, ru.vLang,cb.vBookingNo FROM cab_booking cb JOIN register_user ru ON cb.iUserId = ru.iUserId WHERE cb.iCabBookingId = '" . $iCabBookingId . "'";
        $cab_booking = $obj->MySQLSelect($sqldata);
        $cab_booking = $cab_booking[0];
        $vBookingNo = $cab_booking['vBookingNo'];
        $BookingStatus = $cab_booking['eStatus'];
        $BOOKING_APP_TYPE = $cab_booking['eType'];
        $dBooking_date = $cab_booking['dBooking_date'];
        $tTotalDuration = $cab_booking['tTotalDuration'];
        $UserPhoneNumber = $cab_booking['vPhone'];
        $UserPhoneCode = $cab_booking['vPhoneCode'];
        $UservLang = $cab_booking['vLang'];
        $ePayType_cabbooking = $cab_booking['ePayType'];
        $data_p = date("P");
        $currentDate = date('Y-m-d H:i:s');
        if($BookingStatus == "Cancel"){
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_MANAUL_BOOKING_CANCELLED_MSG";
            $returnArr['DO_RELOAD'] = "Yes";
            setDataResponse($returnArr);
        }
        if($BookingStatus == $this->ACCEPTED_TEXT){
            $returnArr['Action'] = "1";
            $returnArr['message'] = "LBL_FAIL_ASSIGN_TO_PASSENGER_TXT";
            $returnArr['DO_RELOAD'] = "Yes";
            setDataResponse($returnArr);
        }
        if($eStatus == $this->ACCEPTED_TEXT){
            if(strtotime($currentDate)> strtotime($dBooking_date)){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_JOB_ACCEPT_VALIDATION_MSG";
                $returnArr['DO_RELOAD'] = "Yes";
                setDataResponse($returnArr);
            }
        }
        if($eStatus == $this->ACCEPTED_TEXT){
            $enableCommisionDeduct = $MODULES_OBJ->autoDeductDriverCommision("Ride");
            if($enableCommisionDeduct == 'Yes'){
                $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iDriverId, "Driver");
                $user_available_balance = setTwoDecimalPoint($user_available_balance);
                if($WALLET_MIN_BALANCE > $user_available_balance){
                    $driverDetail = get_value('register_driver AS rd LEFT JOIN currency AS c ON c.vName=rd.vCurrencyDriver', 'rd.vCurrencyDriver,c.Ratio,rd.vLang', 'rd.iDriverId', $iDriverId);
                    $vCurrencyDriver = $driverDetail[0]['vCurrencyDriver'];
                    $ratio = $driverDetail[0]['Ratio'];
                    $returnArr["IS_LOW_WALLET_BALANCE"] = "No";
                    if($ePayType_cabbooking == "Cash" && $BOOKING_APP_TYPE == "UberX"){
                        $returnArr = array();
                        $returnArr['Action'] = "0";
                        $returnArr["message"] = str_replace('####', formateNumAsPerCurrency(($WALLET_MIN_BALANCE * $ratio), $vCurrencyDriver), $LanguageLabelsArr['LBL_REQUIRED_MINIMUM_BALNCE_UBERX']);
                        $returnArr["IS_LOW_WALLET_BALANCE"] = "Yes";
                        echo json_encode($returnArr);
                        exit;
                    }
                }
            }
        }
        if($MODULES_OBJ->isDriverSubscriptionModuleAvailable()&& $eStatus != 'Declined'){
            $returnSubStatus = 0;
            $returnSubStatus = checkDriverSubscribed($iDriverId);
            if($returnSubStatus == 1){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_PENDING_MIXSUBSCRIPTION";
                setDataResponse($returnArr);
            }
            else if($returnSubStatus == 2){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_PENDING_SUBSCRIPTION_TEXT";
                setDataResponse($returnArr);
            }
        }
        if($eStatus == $this->ACCEPTED_TEXT && $BOOKING_APP_TYPE == "Ride"){
            $checkbookingdate = $this->CheckSameTimeAnyBookingAccepted($dBooking_date, $iCabBookingId, $iDriverId, $tTotalDuration);
            if(scount($checkbookingdate)> 0){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_PROVIDER_RIDE_FOUND_TXT";
                setDataResponse($returnArr);
            }
        }
        if($eStatus == $this->ACCEPTED_TEXT && $BOOKING_APP_TYPE == "Ride" && $eConfirmByProvider == "No"){
            $checkbookingdate = $this->CheckSameTimeAnyBookingPending($dBooking_date, $iCabBookingId, $iDriverId, $tTotalDuration)['PendingTrip'];
            if($checkbookingdate){
                $returnArr['Action'] = "0";
                $returnArr['BookingFound'] = "Yes";
                $returnArr['message'] = str_replace(['#BOOKING_NO#'], ['#' . $vBookingNo], $LanguageLabelsArr['LBL_PROVIDER_RIDE_PENDING_FOUND_TXT']);
                setDataResponse($returnArr);
            }
        }
        if($eStatus == $this->ACCEPTED_TEXT){
            $where = " iCabBookingId = '$iCabBookingId' ";
            $Data = [];
            $Data['eStatus'] = $eStatus;
            $Data['iDriverId'] = $iDriverId;
            $Data['eAssigned'] = 'Yes';
            $Update_Booking_id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
        }
        else if($eStatus != 'Declined'){
            $where = " iCabBookingId = '$iCabBookingId' ";
            $Data = [];
            $Data['eStatus'] = $eStatus;
            $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
        }
        $where = " iCabBookingId = '$iCabBookingId' AND iDriverId = '$iDriverId' AND eStatus != 'Rescheduled' ";
        $Data = [];
        $Data['eStatus'] = $eStatus;
        $Update_Booking_id = $obj->MySQLQueryPerform("schedule_ride_driver_request", $Data, 'update', $where);
        $this->updateHistory($Data, '', 'update', $where);
        if($Update_Booking_id){
            $dBookingDateArr = commonDateFormat($cab_booking['dBooking_date'],$cab_booking['vTimeZone'],$cab_booking['vLang'],1,'No');
            $Data1['vRider'] = $cab_booking['UserName'];
            $Data1['EMAIL_NAME'] = $cab_booking['UserName'];
            $Data1['vDriver'] = $DRIVER_DATA['DriverName'];
            $Data1['vRiderMail'] = $cab_booking['vEmail'];
            $Data1['vBookingNo'] = $cab_booking['vBookingNo'];
            $Data1['dBookingdate'] = $dBookingDateArr['DATE_TIME'];
            if($eStatus == $this->ACCEPTED_TEXT){
                $returnArr['message'] = "LBL_JOB_ACCEPTED";
                $sendMailtoUser = $COMM_MEDIA_OBJ->SendMailToMember("MANUAL_BOOKING_ACCEPT_BYDRIVER_RIDE", $Data1);
                $USER_SMS_TEMPLATE = "BOOKING_ACCEPT_BYDRIVER_MESSAGE_RIDE";
                $message_layout = $COMM_MEDIA_OBJ->GetSMSTemplate($USER_SMS_TEMPLATE, $Data1, "", $UservLang);
                $UsersendMessage = $COMM_MEDIA_OBJ->SendSystemSMS($UserPhoneNumber, $UserPhoneCode, $message_layout);
                $alertMsg_db = $message_layout;
                $NOTI_TEMPLATE = 'rideLaterBookingRequestAccept';
                $final_message['Message'] = $NOTI_TEMPLATE;
                $final_message['MsgType'] = $NOTI_TEMPLATE;
                $final_message['time'] = time();
                $final_message['eType'] = "Ride";
                $final_message['vTitle'] = $alertMsg_db;
                $final_message['MsgCode'] = strval(time(). mt_rand(1000, 9999));
                $generalDataArr[] = array('eDeviceType' => $cab_booking['eDeviceType'], 'deviceToken' => $cab_booking['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $cab_booking['eAppTerminate'], 'eDebugMode' => $cab_booking['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $cab_booking['eHmsDevice'], 'channelName' => "PASSENGER_" . $cab_booking['iUserId']);
                $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
            }
            else {
                $returnArr['message'] = getDriverDetailInfo($iDriverId);
            }
            $returnArr['Action'] = "1";
            if($eStatus == $this->ACCEPTED_TEXT){
                $returnArr['message'] = str_replace(['#RIDE_NO#'], [$vBookingNo], $LanguageLabelsArr['LBL_LATER_BOOKING_TRIP_ACCEPTED']);
            }
            else if($eStatus == "Declined"){
                $returnArr['message'] = "LBL_LATER_BOOKING_TRIP_DECLINED";
            }
            else if($eStatus == "Declined"){
                $returnArr['message'] = "LBL_LATER_BOOKING_TRIP_CANCELED";
            }
            else {
                $returnArr['message'] = getDriverDetailInfo($iDriverId);
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
        }
        $obj->ExecuteQuery("COMMIT");
        setDataResponse($returnArr);
    }
    public function ShowBtn($Date){
        global $RIDE_LATER_START_TRIP_BEFORE_TRIP_TIME, $RIDE_LATER_HIDE_CANCEL_BTN_BEFORE_TRIP_TIME;
        $currentTimestamp = strtotime(date("Y-m-d H:i:s"));
        $requestTimestamp = strtotime($Date);
        $minutesDifference =($requestTimestamp - $currentTimestamp)/ 60;
        $ARR['DateDifference'] = $minutesDifference;
        $ARR['allowStartTrip'] = $ARR['showAcceptBtn'] = $ARR['showDeclineBtn'] = "No";
        $ARR['allowCancelTrip'] = $ARR['showStartBtn'] = $ARR['showCancelBtn'] = "Yes";
        if($minutesDifference <= $RIDE_LATER_START_TRIP_BEFORE_TRIP_TIME){
            $ARR['showStartBtn'] = "Yes";
            $ARR['allowStartTrip'] = "Yes";
        }
        if($minutesDifference <= $RIDE_LATER_HIDE_CANCEL_BTN_BEFORE_TRIP_TIME){
            $ARR['showCancelBtn'] = "No";
            $ARR['allowCancelTrip'] = "No";
        }
        return $ARR;
    }
    public function cancelBooking(){
        global $obj, $EVENT_MSG_OBJ, $LANG_OBJ;
        $iUserId = isset($_REQUEST["iUserId"])? $_REQUEST["iUserId"] : '';
        $userType = isset($_REQUEST["UserType"])? $_REQUEST["UserType"] : '';
        $iCabBookingId = isset($_REQUEST["iCabBookingId"])? $_REQUEST["iCabBookingId"] : '';
        $Reason = isset($_REQUEST["Reason"])? $_REQUEST["Reason"] : '';
        $iCancelReasonId = isset($_REQUEST["iCancelReasonId"])? $_REQUEST["iCancelReasonId"] : '';
        $sqldata = "SELECT dBooking_date,iUserId,vBookingNo FROM `cab_booking` WHERE iCabBookingId ='" . $iCabBookingId . "' ";
        $cab_booking = $obj->MySQLSelect($sqldata);
        $cab_booking = $cab_booking[0];
        $allowCancelTrip = $this->ShowBtn($cab_booking['dBooking_date'])['allowCancelTrip'];
        if($userType == "Driver" && $allowCancelTrip == "Yes"){
            $USER_DATA_SQL = "SELECT vLang ,iGcmRegId,eDeviceType,iUserId,tSessionId,iAppVersion,eAppTerminate,eDebugMode,eHmsDevice,vCurrencyPassenger, vEmail,vPhone,vPhoneCode,vLang FROM `register_user` WHERE iUserId ='" . $cab_booking['iUserId'] . "' ";
            $USER_DATA = $obj->MySQLSelect($USER_DATA_SQL)[0];
            $where = " iCabBookingId = '$iCabBookingId' AND iDriverId = '$iUserId' AND eStatus != 'Rescheduled' ";
            $Data = [];
            $Data['eStatus'] = 'Cancel';
            $Data['iCancelReasonId'] = $iCancelReasonId;
            $Data['vCancelReason'] = $Reason;
            $Update_Booking_id = $obj->MySQLQueryPerform("schedule_ride_driver_request", $Data, 'update', $where);
            $this->updateHistory($Data, '', 'update', $where);
            $where = " iCabBookingId = '$iCabBookingId' ";
            $Data = [];
            $Data['eStatus'] = 'Pending';
            $Data['iDriverId'] = '';
            $Update_Booking_id = $obj->MySQLQueryPerform("cab_booking", $Data, 'update', $where);
            $LanguageLabelsArr = $LANG_OBJ->FetchLanguageLabels($USER_DATA['vLang'], "1");
            $message_layout = str_replace(['#BOOKING_NO#'], [$cab_booking['vBookingNo']], $LanguageLabelsArr["LBL_LATER_BOOKING_ASSIGN_DRIVER_CANCEL_BOOKING"]);
            $alertMsg_db = $message_layout;
            $NOTI_TEMPLATE = 'rideLaterBooking';
            $final_message['Message'] = $NOTI_TEMPLATE;
            $final_message['MsgType'] = $NOTI_TEMPLATE;
            $final_message['time'] = time();
            $final_message['eType'] = "Ride";
            $final_message['MsgCode'] = strval(time(). mt_rand(1000, 9999));
            $generalDataArr[] = array('eDeviceType' => $USER_DATA['eDeviceType'], 'deviceToken' => $USER_DATA['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $USER_DATA['eAppTerminate'], 'eDebugMode' => $USER_DATA['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $USER_DATA['eHmsDevice'], 'channelName' => "PASSENGER_" . $USER_DATA['iUserId']);
            $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
            $sqldata = "SELECT GROUP_CONCAT(iDriverId)as iDriverId FROM `schedule_ride_driver_request` WHERE iCabBookingId ='" . $iCabBookingId . "' AND eStatus = 'Pending' ";
            $schedule_ride_driver_request = $obj->MySQLSelect($sqldata);
            $iiDriverIdArr = explode(",", $schedule_ride_driver_request[0]['iDriverId']);
            $this->DriverNotifyForNewRequest($iiDriverIdArr, $obj, $LanguageLabelsArr, $USER_DATA['vLang'], $cab_booking['vBookingNo'], $EVENT_MSG_OBJ);
            if($Update_Booking_id){
                $returnArr['Action'] = "1";
                $returnArr['message'] = "LBL_BOOKING_CANCELED";
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            }
            setDataResponse($returnArr);
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_BOOK_LATER_CAN_NOT_CANCEL_TRIP";
            setDataResponse($returnArr);
        }
    }
    public function checkAnyDuplicateTripInPending($iDriverId){
        global $obj;
        $current_date = date("Y-m-d H:i:s");
        $sql = "SELECT CB.iDriverId , CB.iCabBookingId , CB.dBooking_date ,CB.tTotalDuration from cab_booking as CB WHERE dBooking_date > '" . $current_date . "' AND CB.eStatus = '" . $this->ACCEPTED_TEXT . "' AND CB.eType = 'Ride' AND iDriverId = $iDriverId";
        $AcceptDriverBooking = $obj->MySQLSelect($sql);
        $NOT_TO_SHOW_CAB_BOOKING = [];
        if(isset($AcceptDriverBooking)&& !empty($AcceptDriverBooking)){
            foreach($AcceptDriverBooking as $booking){
                $dBooking_date = $booking['dBooking_date'];
                $iCabBookingId = $booking['iCabBookingId'];
                $tTotalDuration = $booking['tTotalDuration'];
                $data = $this->CheckSameTimeAnyBookingPending($dBooking_date, $iCabBookingId, $iDriverId, $tTotalDuration);
                if($data['PendingTrip']){
                    $NOT_TO_SHOW_CAB_BOOKING = array_merge(array_column($data['PendingTripData'], "iCabBookingId"), $NOT_TO_SHOW_CAB_BOOKING);
                }
            }
        }
        return $NOT_TO_SHOW_CAB_BOOKING;
    }
    public function AdminCommonParam(){
        global $obj, $LANG_OBJ;
        $_REQUEST["vGeneralLang"] = $LANG_OBJ->FetchDefaultLangData("vCode");
        $_REQUEST["vTimeZone"] = date_default_timezone_get();
        $_REQUEST["SYSTEM_TYPE"] = "ADMIN";
    }
    public function GetLaterBookingInfo($iCabBookingId){
        global $obj, $tconfig;
        $sqldata = "SELECT ru.vName as user_vName , ru.vLastName as user_vLastName , ru.vPhone as user_vPhone , ru.vPhoneCode as user_vPhoneCode ,ru.vEmail as user_vEmail, ru.vImgName as user_vImgName, rd.vName as driver_vName , rd.vImage as driver_vImgName, rd.vLastName as driver_vLastName , rd.vPhone as driver_vPhone , rd.vCode as driver_vCode ,rd.vEmail as driver_vEmail,rd.vEmail as driver_vEmail, cb.iDriverId,cb.vBookingNo,cb.iUserId,cb.tTotalDuration,cb.dBooking_date, cb.vSourceAddresss, cb.tDestAddress, cb.vSourceLatitude,cb.vSourceLongitude,cb.vDestLatitude,cb.vDestLongitude, cb.iVehicleTypeId,ru.vTimeZone FROM cab_booking as cb JOIN register_user as ru ON ru.iUserId = cb.iUserId LEFT JOIN register_driver as rd ON rd.iDriverId = cb.iDriverId WHERE cb.iCabBookingId ='" . $iCabBookingId . "' ";
        $cab_booking = $obj->MySQLSelect($sqldata);
        $cab_booking = $cab_booking[0];
        if(isset($cab_booking['user_vImgName'])&& !empty($cab_booking['user_vImgName'])&& file_exists($tconfig["tsite_upload_images_passenger_path"] . '/' . $cab_booking['iUserId'] . '/3_' . $cab_booking['user_vImgName'])){
            $cab_booking['user_vImgName'] = $tconfig["tsite_upload_images_passenger"] . '/' . $cab_booking['iUserId'] . '/3_' . $cab_booking['user_vImgName'];
        }
        else {
            $cab_booking['user_vImgName'] = $tconfig['tsite_url'] . '/assets/img/profile-user-img.png';
        }
        if(isset($cab_booking['driver_vImgName'])&& !empty($cab_booking['driver_vImgName'])&& file_exists($tconfig["tsite_upload_images_driver_path"] . '/' . $cab_booking['iDriverId'] . '/3_' . $cab_booking['driver_vImgName'])){
            $cab_booking['driver_vImgName'] = $tconfig["tsite_upload_images_driver"] . '/' . $cab_booking['iDriverId'] . '/3_' . $cab_booking['driver_vImgName'];
        }
        else {
            $cab_booking['driver_vImgName'] = $tconfig['tsite_url'] . '/assets/img/profile-user-img.png';
        }
        $sql_data = "SELECT srd.iDriverId,srd.tHistory,srd.eStatus,srd.iCancelReasonId,srd.vCancelReason, rd.vImage as driver_vImage , rd.vName as driver_vName , rd.vLastName as driver_vLastName , rd.vPhone as driver_vPhone , rd.vCode as driver_vCode FROM `schedule_ride_driver_request` as srd JOIN register_driver as rd ON rd.iDriverId = srd.iDriverId WHERE srd.iCabBookingId = '" . $iCabBookingId . "' AND srd.eStatus != 'Rescheduled' ";
        $SCHEDULE_RIDE_DRIVER_REQUEST_ROW_DATA = $obj->MySQLSelect($sql_data);
        $SCHEDULE_RIDE_DRIVER_REQUEST_ROW = [];
        if(isset($SCHEDULE_RIDE_DRIVER_REQUEST_ROW_DATA)&& !empty($SCHEDULE_RIDE_DRIVER_REQUEST_ROW_DATA)){
            foreach($SCHEDULE_RIDE_DRIVER_REQUEST_ROW_DATA as $DATA){
                $DATA_ARR = [];
                $tHistory = json_decode($DATA['tHistory'], true);
                $assignData = $pendingData = [];
                if(isset($tHistory)&& !empty($tHistory)){
                    foreach($tHistory as $data){
                        if(is_array($data)){
                            if($data['status'] === 'Assign'){
                                $assignData = $data;
                            }
                            if($data['status'] === 'Pending'){
                                $pendingData = $data;
                            }
                        }
                        else {
                            $pendingData = $tHistory;
                        }
                    }
                }
                $ROW_HEIGHTLiGHT = "";
                if($DATA['eStatus'] == "Assign"){
                    $ROW_HEIGHTLiGHT = "assign-driver-row";
                }
                if($DATA['eStatus'] == "Assign"){
                    $DATA['eStatus'] = "Assigned";
                }
                $DATA_ARR[] = array('type' => 'Name', 'vTitle' => 'Name', 'Value' => clearName($DATA['driver_vName'] . ' ' . $DATA['driver_vLastName']), 'iDriverId' => $DATA['iDriverId'], 'style' => "text-align:left");
                $DATA_ARR[] = array('vTitle' => 'Phone No.', 'Value' => '(+' . $DATA['driver_vCode'] . ')' . clearPhone($DATA['driver_vPhone']), 'style' => "text-align:left");
                $DATA_ARR[] = array('vTitle' => 'Status', 'Value' => $DATA['eStatus'], 'style' => "text-align:center", 'ROW_HEIGHTLiGHT' => $ROW_HEIGHTLiGHT);
                $DATA_ARR[] = array('vTitle' => 'Request Received', 'Value' => $pendingData['date'], 'type' => 'Date', 'style' => "text-align:left",);
                $DATA_ARR[] = array('vTitle' => 'Request Assigned', 'Value' => $assignData['date'], 'type' => 'Date', 'style' => "text-align:left",);
                $SCHEDULE_RIDE_DRIVER_REQUEST_ROW[] = array('TR_DATA' => $DATA_ARR, 'TR_CLASS' => $ROW_HEIGHTLiGHT);
            }
            $DATA_ARR_TITLE[] = array('vTitle' => 'Name', 'width' => '20', 'style' => "text-align:left",);
            $DATA_ARR_TITLE[] = array('vTitle' => 'Phone No', 'width' => '20', 'style' => "text-align:left",);
            $DATA_ARR_TITLE[] = array('vTitle' => 'Status', 'width' => '10', 'style' => "text-align:center",);
            $DATA_ARR_TITLE[] = array('vTitle' => 'Request Received', 'width' => '25', 'style' => "text-align:left",);
            $DATA_ARR_TITLE[] = array('vTitle' => 'Request Assigned', 'width' => '25', 'style' => "text-align:left",);
            $SCHEDULE_RIDE_DRIVER_REQUEST_ROW_TITLE = $DATA_ARR_TITLE;
        }
        $RETURN_ARR['CAB_BOOKING_DETAILS'] = $cab_booking;
        $RETURN_ARR['DRIVER_REQUEST_HISTORY'] = $SCHEDULE_RIDE_DRIVER_REQUEST_ROW;
        $RETURN_ARR['SCHEDULE_RIDE_DRIVER_REQUEST_ROW_TITLE'] = $SCHEDULE_RIDE_DRIVER_REQUEST_ROW_TITLE;
        return $RETURN_ARR;
    }
    public function CheckSameTimeBookingExistOrNot($dBooking_date, $iUserId, $Data){
        global $RIDE_LATER_RIDE_BOOK_TIME_INTERVAL_FOR_RIDER, $obj, $ENABLE_24_HOUR_FORMAT;
        $additional_mins =($RIDE_LATER_RIDE_BOOK_TIME_INTERVAL_FOR_RIDER * 60);
        $tTotalDuration = $Data['tTotalDuration'];
        $FromDate = date("Y-m-d H:i:s", strtotime($dBooking_date)- $additional_mins);
        $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_mins);
        if($tTotalDuration > 0){
            $additional_seconds = $additional_mins +($tTotalDuration * 60);
            $ToDate = date("Y-m-d H:i:s", strtotime($dBooking_date)+ $additional_seconds);
        }
        $sql = "SELECT vBookingNo,iCabBookingId,dBooking_date,tTotalDuration from cab_booking WHERE(dBooking_date BETWEEN '" . $FromDate . "' AND '" . $ToDate . "')AND iUserId = '" . $iUserId . "' AND eStatus NOT IN('Cancel', 'Declined', 'Failed' ,'Completed')";
        $checkbookingdate = $obj->MySQLSelect($sql);
        $Return_Arr['checkbookingdate'] = $checkbookingdate;
        if(isset($checkbookingdate)&& !empty($checkbookingdate)){
            $ALREADY_BOOKING_SLOTS = [];
            $TIME_SLOT_TEXT = "\n";
            $i = 1;
            foreach($checkbookingdate as $key => $bookingDate){
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $FromDate = date("H:i", strtotime($bookingDate['dBooking_date']));
                }
                else {
                    $FromDate = date("H:i A", strtotime($bookingDate['dBooking_date']));
                }
                $tTotalDuration = $bookingDate['tTotalDuration'];
                $additional_seconds = $tTotalDuration * 60;
                if($ENABLE_24_HOUR_FORMAT == 'Yes'){
                    $ToDate = date("H:i", strtotime($bookingDate['dBooking_date'])+ $additional_seconds);
                }
                else {
                    $ToDate = date("H:i A", strtotime($bookingDate['dBooking_date'])+ $additional_seconds);
                }
                $TIME_SLOT_TEXT .= "\n". $i.')#'.$bookingDate['vBookingNo'] . ':- '.$FromDate .' to '. $ToDate;
                $i ++;
            }
            $Return_Arr['ALREADY_BOOKING_SLOT_TEXT'] = $TIME_SLOT_TEXT."\n";
        }
        return $Return_Arr;
    }
    public function DriverNotifyForNewRequest(array $sendNotificationDriverArr, $obj, $languageLabelsArr, $vLang, $vBookingNo, $EVENT_MSG_OBJ){
        if(isset($sendNotificationDriverArr)&& !empty($sendNotificationDriverArr)){
            $sendNotificationDriver = implode(',', $sendNotificationDriverArr);
            $SCHEDULE_RIDE_DRIVER_REQUEST = $this->getPendingTrip($sendNotificationDriver);
            $DRIVER_PENDING_TRIP_COUNT =[];
            if(isset($SCHEDULE_RIDE_DRIVER_REQUEST)&& !empty($SCHEDULE_RIDE_DRIVER_REQUEST)){
                foreach($SCHEDULE_RIDE_DRIVER_REQUEST as $DRIVER_REQUEST){
                    $DRIVER_PENDING_TRIP_COUNT[$DRIVER_REQUEST['iDriverId']] = $DRIVER_REQUEST['DriverPendingRideCount'];
                }
            }
            $sql_driver_status_chk = "SELECT t.iActive, rd.iTripId,rd.vTripStatus,rd.iGcmRegId,rd.eDeviceType,rd.iDriverId,rd.vLang,rd.tSessionId,rd.iAppVersion,rd.eAppTerminate,rd.eDebugMode,rd.eHmsDevice,rd.vCurrencyDriver FROM register_driver as rd LEFT JOIN trips as t ON(t.iTripId = rd.iTripId)WHERE rd.iDriverId IN(" . $sendNotificationDriver . ")";
            $SEND_NOTI_TO_DRIVER_DATA = $obj->MySQLSelect($sql_driver_status_chk);
            if(isset($SEND_NOTI_TO_DRIVER_DATA)&& !empty($SEND_NOTI_TO_DRIVER_DATA)){
                $labelsStoreArr = array();
                $labelsStoreArr[$vLang]['LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT'] = $languageLabelsArr['LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT'];
                $labelsStoreArr[$vLang]['LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST'] = $languageLabelsArr['LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST'];
                foreach($SEND_NOTI_TO_DRIVER_DATA as $DRIVER_DATA){
                    if(in_array($DRIVER_DATA['vTripStatus'], ['Active', 'On Going Trip', 'Arrived'])){
                        $final_message['OpenPendingList'] = 'No';
                        if(!empty($labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST'])){
                            $alertMsg_db = $labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST'];
                        }
                        else {
                            $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', 'LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST', " and vCode='" . $DRIVER_DATA['vLang'] . "'", 'true');
                            $labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_LATER_BOOKING_ON_GOING_RIDE_GET_REQUEST'] = $alertMsg_db;
                        }
                        $alertMsg_db = str_replace(['#RIDE_NO#'], ['#' . $vBookingNo], $alertMsg_db);
                    }
                    else {
                        $final_message['OpenPendingList'] = 'Yes';
                        if(!empty($labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT'])){
                            $alertMsg_db = $labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT'];
                        }
                        else {
                            $alertMsg_db = get_value('language_label', 'vValue', 'vLabel', 'LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT', " and vCode='" . $DRIVER_DATA['vLang'] . "'", 'true');
                            $labelsStoreArr[$DRIVER_DATA['vLang']]['LBL_RIDE_LATER_NEW_PROVIDER_RIDE_REQUEST_TEXT'] = $alertMsg_db;
                        }
                        $alertMsg_db = str_replace(['#RIDE_NO#'], ['#' . $vBookingNo], $alertMsg_db);
                    }
                    $NOTI_TEMPLATE = 'rideLaterBookingRequest';
                    $final_message['Message'] = $NOTI_TEMPLATE;
                    $final_message['MsgType'] = $NOTI_TEMPLATE;
                    $final_message['time'] = time();
                    $final_message['eType'] = "Ride";
                    $final_message['PendingRideRequestCount'] = $DRIVER_PENDING_TRIP_COUNT[$DRIVER_DATA['iDriverId']];
                    $final_message['MsgCode'] = strval(time(). mt_rand(1000, 9999));
                    $generalDataArr[] = array('eDeviceType' => $DRIVER_DATA['eDeviceType'], 'deviceToken' => $DRIVER_DATA['iGcmRegId'], 'alertMsg' => $alertMsg_db, 'eAppTerminate' => $DRIVER_DATA['eAppTerminate'], 'eDebugMode' => $DRIVER_DATA['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $DRIVER_DATA['eHmsDevice'], 'channelName' => "DRIVER_" . $DRIVER_DATA['iDriverId']);
                }
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
            }
        }
    }
    public function UpdatShownStatus($iCabBookingId , $memberId){
        global $obj;
        $data_update = [];
        $where = " iCabBookingId = '" . $iCabBookingId . "' AND iDriverId = '" . $memberId . "' AND eStatus = 'Pending' ";
        $data_update['eShown'] = "Yes";
        $obj->MySQLQueryPerform("schedule_ride_driver_request", $data_update, 'update', $where);
    }
    public function getPendingTrip(string $sendNotificationDriver){
        global $obj;
        $TripPending = $this->checkAnyDuplicateTripInPending($sendNotificationDriver);
        $TripPending = implode(',',$TripPending);
        $subSqlBook = '';
        if(isset($TripPending)&& !empty($TripPending)){
            $subSqlBook .= " AND cb.iCabBookingId NOT IN($TripPending)";
        }
        $CurrentDate = date("Y-m-d H:i:s");
        $SQL = "SELECT COUNT(srdr.iDriverRequestId)as DriverPendingRideCount,srdr.iDriverId FROM schedule_ride_driver_request as srdr RIGHT JOIN cab_booking as cb ON srdr.iCabBookingId = cb.iCabBookingId WHERE srdr.eStatus = 'Pending' AND srdr.iDriverId IN(" . $sendNotificationDriver . ")AND cb.eStatus = 'Pending' AND cb.dBooking_date > '$CurrentDate' $subSqlBook GROUP BY srdr.iDriverId";
        $SCHEDULE_RIDE_DRIVER_REQUEST = $obj->MySQLSelect($SQL);
        return $SCHEDULE_RIDE_DRIVER_REQUEST;
    }
}
class TaxiBid {
    function __construct(){
    }
    public function getCategories($tCategoryDetails = array()){
        $RETURN_CAT = [];
        if(isset($tCategoryDetails)&& !empty($tCategoryDetails)){
            foreach($tCategoryDetails as $skey => $SubCategories){
                if(in_array($SubCategories['eCatType'], [ 'TaxiBid', 'MotoBid' ])){
                    $tCategoryDetails[$skey]['eCatViewType'] = "List";
                    $RETURN_CAT[] = $tCategoryDetails[$skey];
                }
            }
        }
        return $RETURN_CAT;
    }
    public function saveUserTaxiBidAmount(){
        global $obj;
        $OfferFare = isset($_REQUEST["OfferFare"])? $_REQUEST["OfferFare"] : '';
        $isTaxiBid = isset($_REQUEST["isTaxiBid"])? $_REQUEST["isTaxiBid"] : 'No';
        $GeneralUserType = isset($_REQUEST['GeneralUserType'])? trim($_REQUEST['GeneralUserType']): '';
        $GeneralMemberId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $row = $obj->MySQLSelect("SELECT *,iUserId as iMemberId FROM `register_user` WHERE iUserId='$GeneralMemberId'");
        $currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $row[0]['vCurrencyPassenger'] . "'");
        $Taxi_bid['fTaxiBidAmount'] = $OfferFare / $currency[0]['ratio'];
        $Taxi_bid['isTaxiBid'] = $isTaxiBid;
        return $Taxi_bid;
    }
    public function sendDriverQuotationToUser($iCabRequestId, $OfferFare, $driver_id, $vMsgCode){
        global $obj, $EVENT_MSG_OBJ, $tconfig, $LANG_OBJ;
        if($iCabRequestId != ''){
            $lang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : "";
            if($lang == "" || $lang == NULL){
                $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
            }
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
            $sqldata = "SELECT * FROM `cab_request_now` WHERE iCabRequestId = $iCabRequestId AND eStatus = 'Requesting' ";
            $cab_request_now = $obj->MySQLSelect($sqldata);
            if(!empty($cab_request_now)&& scount($cab_request_now)> 0){
                $cab_request_now = $cab_request_now[0];
                $iUserId = $cab_request_now['iUserId'];
                $iUser_fTaxiBidAmount = $cab_request_now['fTaxiBidAmount'];
                $driver_data = $obj->MySQLSelect("SELECT vLatitude,vLongitude,CONCAT(vName, ' ', vLastName)as driverName, vImage,vEmail as drivermail,iDriverId,vCurrencyDriver,vAvgRating FROM `register_driver` WHERE iDriverId = '" . $driver_id . "'");
                $driver_currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $driver_data[0]['vCurrencyDriver'] . "'");
                $org_OfferFare = $OfferFare / $driver_currency[0]['ratio'];
                $amount_driver = formateNumAsPerCurrency($OfferFare, $driver_data[0]['vCurrencyDriver']);
                $isSameFare = "No";
                if(number_format(($iUser_fTaxiBidAmount),2)== number_format(($org_OfferFare),2)){
                    $isSameFare = "Yes";
                }
                $getDurationDistance_data = $this->getDurationDistance($driver_data[0]['vLatitude'],$driver_data[0]['vLongitude'],$cab_request_now['vSourceLatitude'],$cab_request_now['vSourceLongitude']);
                $row1 = $obj->MySQLSelect("SELECT vCurrencyPassenger, vPhoneCode , vPhone, eHmsDevice , iUserId, vCurrencyPassenger, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, vName, vLastName FROM `register_user` WHERE iUserId = '" . $iUserId . "'");
                $passenger_currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $row1[0]['vCurrencyPassenger'] . "'");
                $amount_passenger = formateNumAsPerCurrency(($org_OfferFare * $passenger_currency[0]['ratio']), $row1[0]['vCurrencyPassenger']);
                $generalDataArr = $final_message = array();
                $final_message['Message'] = 'TaxiBidDriverQuotation';
                $final_message['MsgType'] = 'TaxiBidDriverQuotation';
                $final_message['time'] = time();
                $final_message['OfferFare'] = $amount_passenger;
                $final_message['eType'] = "TaxiBid";
                $final_message['vMsgCode'] = $vMsgCode;
                if(!empty($driver_data)){
                    $final_message['driverAvgRating'] = $driver_data[0]['vAvgRating'];
                    $final_message['driverName'] = $driver_data[0]['driverName'];
                    $final_message['drivermail'] = $driver_data[0]['drivermail'];
                    $final_message['driverImage'] = '';
                    if(file_exists($tconfig["tsite_upload_images_driver_path"] . "/" . $driver_data[0]['iDriverId'] . "/2_" . $driver_data[0]['vImage'])){
                        $final_message['driverImage'] = $tconfig["tsite_upload_images_driver"] . "/" . $driver_data[0]['iDriverId'] . "/2_" . $driver_data[0]['vImage'];
                    }
                    $final_message['driverId'] = $driver_id;
                    $final_message['driverVehicle'] = $this->getDriverVehicle($driver_id)['vehicle'];
                    $final_message['DurationToReach'] = $getDurationDistance_data['distance'];
                    $final_message['TimeToReach'] = $getDurationDistance_data['duration'];
                    $final_message['isSameFare'] = $isSameFare;
                }
                $generalDataArr[] = array('eDeviceType' => $row1[0]['eDeviceType'], 'deviceToken' => $row1[0]['iGcmRegId'], 'alertMsg' => '', 'eAppTerminate' => $row1[0]['eAppTerminate'], 'eDebugMode' => $row1[0]['eDebugMode'], 'message' => $final_message, 'eHmsDevice' => $row1[0]['eHmsDevice'], 'channelName' => "PASSENGER_" . $iUserId);
                $arr['NOTIFICATION'] = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
                $where = " vMsgCode='" . $vMsgCode . "' AND iDriverId = '" . $driver_id . "'";
                $data_driver_request['fTaxiBidAmount'] = $org_OfferFare;
                $obj->MySQLQueryPerform("driver_request", $data_driver_request, 'update', $where);
                $returnArr['Action'] = "1";
                if($isSameFare == "Yes"){
                    $returnArr['message'] = '';
                }
                else {
                    $returnArr['message'] = str_replace(['#AMOUNT#'], [$amount_driver], $languageLabelsArr["LBL_WAIT_FOR_USER_REPLY"]);
                }
                setDataResponse($returnArr);
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_CAR_REQUEST_CANCELLED_TXT";
                setDataResponse($returnArr);
            }
        }
        else {
        }
    }
    public function getDriverVehicle($iDriverId){
        global $obj;
        $ssql = " AND dv.eType != 'UberX'";
        $sql = "SELECT register_driver.iDriverVehicleId as DriverSelectedVehicleId,make.vMake, model.vTitle, dv.* FROM `driver_vehicle` dv, make, model,register_driver WHERE dv.iDriverId='$iDriverId' AND register_driver.iDriverId = '$iDriverId' AND dv.`iMakeId` = make.`iMakeId` AND dv.`iModelId` = model.`iModelId` AND dv.`eStatus`='Active'" . $ssql . " Order By dv.iDriverVehicleId desc";
        $Data_Car = $obj->MySQLSelect($sql);
        $Data_Car = $Data_Car[0];
        $arr['vehicle'] = $Data_Car['vMake'] . '(' . $Data_Car['vTitle'] . ')';
        return $arr;
    }
    public function getAvgRating($iMemberId, $UserType){
        global $obj;
    }
    public function saveUserAcceptedAmount($RequestMsgCode, $driverId){
        global $obj, $EVENT_MSG_OBJ,$LANG_OBJ;
        $GeneralMemberId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $GeneralUserType = isset($_REQUEST['GeneralUserType'])? trim($_REQUEST['GeneralUserType']): '';
        $GeneralDeviceType = isset($_REQUEST['GeneralDeviceType'])? trim($_REQUEST['GeneralDeviceType']): '';
        $lang = isset($_REQUEST['vGeneralLang'])? $_REQUEST['vGeneralLang'] : "";
        if($lang == "" || $lang == NULL){
            $lang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($lang, "1", "");
        $sqldata = "SELECT fTaxiBidAmount FROM `driver_request` WHERE vMsgCode='" . $RequestMsgCode . "' AND iDriverId = '" . $driverId . "' ";
        $driver_request = $obj->MySQLSelect($sqldata);
        $fTaxiBidAmount = $driver_request[0]['fTaxiBidAmount'];
        $where = " tMsgCode='" . $RequestMsgCode . "'";
        $data_driver_request['fUserAcceptedTaxiBidAmount'] = $fTaxiBidAmount;
        $obj->MySQLQueryPerform("cab_request_now", $data_driver_request, 'update', $where);
        $sqldata = "SELECT iCabRequestId,fTaxiBidAmount,vSourceLatitude,vSourceLongitude,vDestLatitude,vDestLongitude,tSourceAddress,tDestAddress FROM `cab_request_now` WHERE tMsgCode='" . $RequestMsgCode . "'";
        $cab_request_now = $obj->MySQLSelect($sqldata);
        $cab_request_now = $cab_request_now[0];
        $sourceLoc = $cab_request_now['vSourceLatitude'] . ',' . $cab_request_now['vSourceLongitude'];
        $destLoc = $cab_request_now['vDestLatitude'] . ',' . $cab_request_now['vDestLongitude'];
        $PickUpAddress = $cab_request_now['tSourceAddress'];
        $DestAddress = $cab_request_now['tDestAddress'];
        $sql_driver_status_chk = "SELECT vLastName,vName,vTripStatus,iGcmRegId,eDeviceType,iDriverId,vLang,tSessionId,iAppVersion,eAppTerminate,eDebugMode,eHmsDevice FROM register_driver WHERE iDriverId IN(" . $driverId . ")";
        $result_driverData = $obj->MySQLSelect($sql_driver_status_chk);
        foreach($result_driverData as $item){
            $alertMsg_db = '';
            $generalDataArr[] = array('eDeviceType' => $item['eDeviceType'], 'deviceToken' => $item['iGcmRegId'], 'alertMsg' => '', 'eAppTerminate' => $item['eAppTerminate'], 'eDebugMode' => $item['eDebugMode'], 'eHmsDevice' => $item['eHmsDevice'], 'message' => array('iUserId' => $GeneralMemberId, 'iDriverId' => $driverId, 'tMessage' => 'WaitTripGenerateProcessRunning', 'iMsgCode' => $RequestMsgCode, 'MsgType' => 'WaitTripGenerateProcessRunning', 'vStartLatlong' => $sourceLoc, 'vEndLatlong' => $destLoc, 'tStartAddress' => $PickUpAddress, 'tEndAddress' => $DestAddress, 'eType' => "TaxiBid",), 'channelName' => "DRIVER_" . $item['iDriverId']);
        }
        $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
        $driver_data = $obj->MySQLSelect("SELECT tSessionId,vCurrencyDriver FROM `register_driver` WHERE iDriverId = '" . $driverId . "'");
        $driver_data = $driver_data[0];
        $driver_currency = $obj->MySQLSelect("SELECT ratio,vName FROM `currency` WHERE vName='" . $driver_data['vCurrencyDriver'] . "'");
        $driver_fTaxiBidAmount = $fTaxiBidAmount * $driver_currency[0]['ratio'];
        $amount_driver = formateNumAsPerCurrency($driver_fTaxiBidAmount, $driver_data['vCurrencyDriver']);
        $DATA_ARR['PassengerID'] = $GeneralMemberId;
        $DATA_ARR['DriverID'] = $driverId;
        $DATA_ARR['iCabRequestId'] = $cab_request_now['iCabRequestId'];
        $DATA_ARR['start_lat'] = $cab_request_now['vSourceLatitude'];
        $DATA_ARR['start_lon'] = $cab_request_now['vSourceLongitude'];
        $DATA_ARR['sAddress'] = $PickUpAddress;
        $DATA_ARR['vMsgCode'] = $RequestMsgCode;
        $DATA_ARR['ride_type'] = 'Ride';
        $DATA_ARR['REQUEST_TYPE'] = 'Ride';
        $DATA_ARR['GeneralMemberId'] = $driverId;
        $DATA_ARR['tSessionId'] = $driver_data['tSessionId'];
        $DATA_ARR['GeneralUserType'] = 'Driver';
        $DATA_ARR['type'] = 'GenerateTrip';
        $DATA_ARR['OfferAccepted'] = 'Yes';
        $DATA_ARR['isTaxiBid'] = 'Yes';
        $DATA_ARR['DRIVER_NAME'] = $result_driverData[0]['vName'] .' '.$result_driverData[0]['vLastName'];
        $DATA_ARR['FINAL_AMOUNT'] = $amount_driver;
        $DATA_ARR['GeneralDeviceType'] = $GeneralDeviceType;
        $GenerateTripData = $this->callGenerateTripType($DATA_ARR);
        $userData = $obj->MySQLSelect("SELECT vName,vLastName FROM `register_user` WHERE iUserId='$GeneralMemberId'");
        $userData = $userData[0];
        $User_Name= $userData['vName'] .' '.$userData['vLastName'];
        $vtitle = str_replace(['#DRIVER#' , '#AMOUNT#'] , [$User_Name , $amount_driver ] , $languageLabelsArr['LBL_USER_ACCEPT_DRIVER_REQUEST_TEXI_BID_TEXT']);
        foreach($result_driverData as $item){
            $alertMsg_db = '';
            $generalDataArr[] = array('eDeviceType' => $item['eDeviceType'], 'deviceToken' => $item['iGcmRegId'], 'alertMsg' => '', 'eAppTerminate' => $item['eAppTerminate'], 'eDebugMode' => $item['eDebugMode'], 'eHmsDevice' => $item['eHmsDevice'], 'vTitle' => $vtitle, 'message' => array('iUserId' => $GeneralMemberId, 'iDriverId' => $driverId, 'tMessage' => 'UserAccepDriverOffer', 'iMsgCode' => $RequestMsgCode, 'MsgType' => 'UserAccepDriverOffer', 'vStartLatlong' => $sourceLoc, 'vEndLatlong' => $destLoc, 'tStartAddress' => $PickUpAddress, 'tEndAddress' => $DestAddress, 'eType' => "TaxiBid", 'vTitle' => $vtitle,), 'channelName' => "DRIVER_" . $item['iDriverId']);
        }
        $data = $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_PROVIDER);
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    }
    public function getDurationDistance($tStartLat,$tStartLong,$tEndLat,$tEndLong){
        $requestDataArr = array();
        $vLangCodeData = get_value('language_master', 'vCode, vGMapLangCode', 'eDefault', 'Yes');
        $vGMapLangCode = $vLangCodeData[0]['vGMapLangCode'];
        $requestDataArr['SOURCE_LATITUDE'] = $tStartLat;
        $requestDataArr['SOURCE_LONGITUDE'] = $tStartLong;
        $requestDataArr['DEST_LATITUDE'] = $tEndLat;
        $requestDataArr['DEST_LONGITUDE'] = $tEndLong;
        $requestDataArr['LANGUAGE_CODE'] = $vGMapLangCode;
        $direction_data = getPathInfoBetweenLocations($requestDataArr);
        $returnArr = [];
        if(isset($direction_data)&& !empty($direction_data)){
            $returnArr['distance'] = number_format(($direction_data['distance'] / 1000),2).' km';
            $returnArr['duration'] = trim($this->convertSecToMin($direction_data['duration']));
        }
        return $returnArr;
    }
    public function convertSecToMin($seconds){
        $minutes = floor($seconds / 60);
        return convertMinToHoursToDays($minutes, 'Minutes', 1);
    }
    public function callGenerateTripType($data){
        global $tconfig,$AUTH_MEMBER_OBJ;
        $webservice_url = $tconfig['tsite_url'] . WEBSERVICE_API_FILE_NAME;
        $token = $AUTH_MEMBER_OBJ->getPackageData()['ANDROID_DRIVER'];
        $ch = curl_init();
        curl_setopt($ch,CURLOPT_URL, $webservice_url);
        curl_setopt($ch,CURLOPT_POST, true);
        curl_setopt($ch,CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch,CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch,CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [ 'Authorization: Bearer ' . encrypt_bycrypt($token)]);
        $response = curl_exec($ch);
        $error_msg = curl_error($ch);
        if(!empty($error_msg)){
        }
        $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        if(!empty($response)&& isJsonTextGT($response)){
            $returnArr = json_decode($response, true);
            $ARR_RETURN['iTripId'] = $returnArr['message']['iTripId'];
            $ARR_RETURN['Action'] = "1";
        }
        else {
            $ARR_RETURN['Action'] = "0";
        }
        return $ARR_RETURN;
    }
}
class TrackAnyService {
    public $isOnlyEnableFETApp;
    function __construct(){
        global $MODULES_OBJ;
        $this->isOnlyEnableFETApp = $MODULES_OBJ->isOnlyEnableFETApp();
    }
    public function getServiceCategories($vLang, $tCategoryDetails = array()){
        global $obj, $tconfig;
        $trackServiceCategory = $obj->MySQLSelect("SELECT JSON_UNQUOTE(JSON_VALUE(vCategoryName, '$.vCategoryName_" . $vLang . "'))as vCategoryName, JSON_UNQUOTE(JSON_VALUE(vCategoryDesc, '$.vCategoryDesc_" . $vLang . "'))as vCategoryDesc, vImage, eMemberType, vTextColor, vBgColor FROM track_service_category WHERE eStatus = 'Active'");
        $ServiceCategoryArr = array();
        foreach($trackServiceCategory as $ServiceCategory){
            $TrackServiceArr = $this->getCategories($tCategoryDetails, $ServiceCategory['eMemberType']);
            $ServiceCategory['vImageName'] = $ServiceCategory['vImage'];
            if(!empty($ServiceCategory['vImage'])&& file_exists($tconfig['tpanel_path'] . 'webimages/icons/DefaultImg/' . $ServiceCategory['vImage'])){
                $ServiceCategory['vImage'] = $tconfig['tsite_url'] . 'webimages/icons/DefaultImg/' . $ServiceCategory['vImage'];
                $ServiceCategory['vListLogo'] = $ServiceCategory['vImage'];
            }
            $ServiceCategory['vCategory'] = $ServiceCategory['vCategoryName'];
            $ServiceCategory['vTitle'] = $ServiceCategory['vCategoryName'];
            $ServiceCategory['MemberType'] = $ServiceCategory['eMemberType'];
            $ServiceCategory['vCategoryDesc'] = $ServiceCategory['vCategoryDesc'];
            $ServiceCategory['vTextColor'] = $ServiceCategory['vTextColor'];
            $ServiceCategory['vBgColor'] = $ServiceCategory['vBgColor'];
            if(in_array($ServiceCategory['MemberType'], ['Family','Employee'])){
                $ServiceCategory['eCatType'] = "TrackAnyService";
            }
            else {
                $ServiceCategory['eCatType'] = "ToBeTrackService";
            }
            $ServiceCategory['TrackServiceSection'] = 'Yes';
            $ServiceCategory['isRoundImage'] = 'Yes';
            $ServiceCategoryArr[] = $ServiceCategory;
        }
        return $ServiceCategoryArr;
    }
    public function getCategories($tCategoryDetails = array(), $eMemberType = ''){
        global $languageLabelsArr, $tconfig, $obj, $master_service_category_tbl;
        if(empty($tCategoryDetails)){
            $service_details = $obj->MySQLSelect("SELECT tCategoryDetails FROM $master_service_category_tbl WHERE eType = 'TrackAnyService' ");
            $tCategoryDetails = json_decode($service_details[0]['tCategoryDetails'], true);
        }
        $vImageTrackService = "";
        if(!empty($tCategoryDetails['TrackService']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackService']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackService']['vImage']);
            $vImageWidthTrackService = strval($imagedata[0]);
            $vImageHeightTrackService = strval($imagedata[1]);
            $vImageTrackService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['TrackService']['vImage'];
        }
        $vImageTrackServiceAdd = "";
        if(!empty($tCategoryDetails['TrackServiceAdd']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackServiceAdd']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackServiceAdd']['vImage']);
            $vImageWidthTrackServiceAdd = strval($imagedata[0]);
            $vImageHeightTrackServiceAdd = strval($imagedata[1]);
            $vImageTrackServiceAdd = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['TrackServiceAdd']['vImage'];
        }
        $category_arr = array(array('vCategory' => $languageLabelsArr['LBL_TRACK_SERVICE_TRACK_MEMBER_TXT'], 'vImage' => $vImageTrackService, 'vListLogo' => $vImageTrackService, 'vImageWidth' => $vImageWidthTrackService, 'vImageHeight' => $vImageHeightTrackService, 'eCatType' => 'TrackService'), array('vCategory' => $languageLabelsArr['LBL_TRACK_SERVICE_SETUP_PROFILE_TXT'], 'vImage' => $vImageTrackServiceAdd, 'vListLogo' => $vImageTrackServiceAdd, 'vImageWidth' => $vImageWidthTrackServiceAdd, 'vImageHeight' => $vImageHeightTrackServiceAdd, 'eCatType' => 'TrackServiceAdd'));
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "checkTrackingProfileSetup"){
            $tracking_users = $this->listTrackingUsers(0, $eMemberType);
            if(!empty($tracking_users['message'])&& scount($tracking_users['message'])> 0){
                $category_arr = array('vCategory' => $languageLabelsArr['LBL_TRACK_SERVICE_TRACK_MEMBER_TXT'], 'vImage' => $vImageTrackService, 'vListLogo' => $vImageTrackService, 'vImageWidth' => $vImageWidthTrackService, 'vImageHeight' => $vImageHeightTrackService, 'eCatType' => 'TrackService');
            }
            else {
                $category_arr = array('vCategory' => $languageLabelsArr['LBL_TRACK_SERVICE_SETUP_PROFILE_TXT'], 'vImage' => $vImageTrackServiceAdd, 'vListLogo' => $vImageTrackServiceAdd, 'vImageWidth' => $vImageWidthTrackServiceAdd, 'vImageHeight' => $vImageHeightTrackServiceAdd, 'eCatType' => 'TrackServiceAdd');
            }
        }
        return $category_arr;
    }
    public function verifyPairingCode(){
        global $obj, $LANG_OBJ;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $vPairingCode = isset($_REQUEST["vPairingCode"])? $_REQUEST["vPairingCode"] : '';
        $vLangCode = isset($_REQUEST['vGeneralLang'])? clean($_REQUEST['vGeneralLang']): '';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLangCode, "1", "");
        $ssql = "";
        if($this->isOnlyEnableFETApp){
            $ssql = " AND iUserId != '$iMemberId' ";
        }
        $tracking_code_db = $obj->MySQLSelect("SELECT iUserId FROM track_service_pairing_codes WHERE vPairingCode = '$vPairingCode' $ssql ");
        if(!empty($tracking_code_db)&& scount($tracking_code_db)> 0){
            $track_user_db = $obj->MySQLSelect("SELECT iTrackServiceUserId FROM track_service_users WHERE FIND_IN_SET(" . $tracking_code_db[0]['iUserId'] . ", tUserIds)AND iTrackServiceUserId = {
                $iMemberId
            }
            ");
            if(!empty($track_user_db)&& scount($track_user_db)> 0){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_TRACK_SERVICE_USER_ALREADY_PAIRED_MSG";
            }
            else {
                $userData = $obj->MySQLSelect("SELECT vPhoneCode, vPhone FROM register_user WHERE iUserId = '" . $tracking_code_db[0]['iUserId'] . "' ");
                $vPhoneNo = substr($userData[0]['vPhone'], -4);
                $returnArr['Action'] = "1";
                $returnArr['message'] = str_replace('#PHONE_NO#', 'XXXXXX' . $vPhoneNo, $languageLabelsArr['LBL_TRACK_SERVICE_VERIFICATION_CODE_HINT']);
                $returnArr['Phone'] = $userData[0]['vPhone'];
                $returnArr['PhoneCode'] = $userData[0]['vPhoneCode'];
                $returnArr['PairedUserId'] = $tracking_code_db[0]['iUserId'];
                if($this->isOnlyEnableFETApp){
                    $iMemberId = $this->signupTrackUser($iMemberId);
                    $returnArr['TRACK_USER_DATA'] = $this->getTrackingMemberDetailInfo($iMemberId);
                }
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRACK_SERVICE_PAIRING_CODE_INVALID";
        }
        setDataResponse($returnArr);
    }
    public function signupTrackUser($iMemberId){
        global $obj;
        $track_user_db = $obj->MySQLSelect("SELECT iTrackServiceUserId FROM track_service_users WHERE iUserId = {
            $iMemberId
        }
        ");
        if(isset($track_user_db)&& empty($track_user_db)){
            $userData = $obj->MySQLSelect("SELECT * FROM register_user WHERE iUserId = '" . $iMemberId . "' ");
            $userData = $userData[0];
            $Data_passenger['vPhoneCode'] = $userData['vPhoneCode'];
            $Data_passenger['vName'] = $userData['vName'];
            $Data_passenger['vLastName'] = $userData['vLastName'];
            $Data_passenger['vEmail'] = $userData['vEmail'];
            $Data_passenger['vPhone'] = $userData['vPhone'];
            $Data_passenger['vPassword'] = $userData['vPassword'];
            $Data_passenger['iGcmRegId'] = $userData['iGcmRegId'];
            $Data_passenger['vFirebaseDeviceToken'] = $userData['vFirebaseDeviceToken'];
            $Data_passenger['vLang'] = $userData['vLang'];
            $Data_passenger['vCountry'] = $userData['vCountry'];
            $Data_passenger['eDeviceType'] = $userData['eDeviceType'];
            $Data_passenger['tRegistrationDate'] = @date('Y-m-d H:i:s');
            $random = substr(md5(rand()), 0, 7);
            $Data_passenger['tDeviceSessionId'] = session_id(). time(). $random;
            $Data_passenger['tSessionId'] = session_id(). time();
            $Data_passenger['eLocationTracking'] = "Yes";
            $Data_passenger['iUserId'] = $iMemberId;
            $id = $obj->MySQLQueryPerform('track_service_users', $Data_passenger, 'insert');
        }
        else {
            $id = $track_user_db[0]['iTrackServiceUserId'];
        }
        return $id;
    }
    public function sendAuthOtpTracking(){
        global $obj, $MOBILE_NO_VERIFICATION_METHOD, $COMM_MEDIA_OBJ, $SITE_NAME, $LANG_OBJ, $WA_OPS_OBJ;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $PairedUserId = isset($_REQUEST["PairedUserId"])? $_REQUEST["PairedUserId"] : '';
        $vLangCode = isset($_REQUEST['vGeneralLang'])? clean($_REQUEST['vGeneralLang']): '';
        $verificationMethod = isset($_REQUEST['verificationMethod'])? clean($_REQUEST['verificationMethod']): 'SMS';
        if($vLangCode == "" || $vLangCode == NULL){
            $vLangCode = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $res = $obj->MySQLSelect("SELECT * from send_message_templates where vEmail_Code = 'TRACKING_AUTH_OTP'");
        $message = $res[0]['vBody_' . $vLangCode];
        $userData = $obj->MySQLSelect("SELECT vPhoneCode, vPhone FROM register_user WHERE iUserId = '" . $PairedUserId . "' ");
        $otp = mt_rand(1000, 9999);
        $message = str_replace(["#OTP#", "#SITE_NAME#"], [$otp, $SITE_NAME], $message);
        $returnArr['Action'] = "1";
        $returnArr['MOBILE_NO_VERIFICATION_METHOD'] = $MOBILE_NO_VERIFICATION_METHOD;
        if(strtoupper($verificationMethod)== "WHATSAPP"){
            $result = $WA_OPS_OBJ->sendAuthOtp($userData[0]['vPhoneCode'] . $userData[0]['vPhone'], $otp, $vLangCode);
        }
        else {
            if(strtoupper($MOBILE_NO_VERIFICATION_METHOD)!= "FIREBASE"){
                $result = $COMM_MEDIA_OBJ->SendSystemSMS($userData[0]['vPhone'], $userData[0]['vPhoneCode'], $message);
            }
            else {
                $result = 1;
            }
        }
        if($result == 0){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_FAILED_SEND_AUTH_OTP";
            setDataResponse($returnArr);
        }
        else {
            $returnArr['Action'] = "1";
            $returnArr['message'] = $otp;
            $returnArr['Phone'] = $userData[0]['vPhone'];
            $returnArr['PhoneCode'] = $userData[0]['vPhoneCode'];
            setDataResponse($returnArr);
        }
        setDataResponse($returnArr);
    }
    public function pairTrackingUser(){
        global $obj, $EVENT_MSG_OBJ, $LANG_OBJ, $SITE_NAME, $MONGO_OP_OBJ;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $PairedUserId = isset($_REQUEST["PairedUserId"])? $_REQUEST["PairedUserId"] : '';
        $vPairingCode = isset($_REQUEST["vPairingCode"])? $_REQUEST["vPairingCode"] : '';
        if($this->isOnlyEnableFETApp){
            $iMemberId = $this->signupTrackUser($iMemberId);
        }
        $pairing_code_db = $obj->MySQLSelect("SELECT eMemberType FROM track_service_pairing_codes WHERE vPairingCode = '$vPairingCode ' ");
        if(!empty($pairing_code_db)&& scount($pairing_code_db)> 0){
            $MemberType = $pairing_code_db[0]['eMemberType'];
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
            setDataResponse($returnArr);
        }
        $track_user_db = $obj->MySQLSelect("SELECT tUserIds FROM track_service_users WHERE iTrackServiceUserId = '$iMemberId' ");
        $tUserIds = $track_user_db[0]['tUserIds'];
        $tUserIdsArr = array();
        if(!empty($tUserIds)){
            $tUserIdsArr = explode(",", $tUserIds);
        }
        $tUserIdsArr[] = $PairedUserId;
        $tUserIdsStr = implode(",", $tUserIdsArr);
        $obj->sql_query("UPDATE track_service_users SET tUserIds = '" . $tUserIdsStr . "', eMemberType = '$MemberType' WHERE iTrackServiceUserId = '" . $iMemberId . "'");
        $userData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName, iUserId, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, eHmsDevice, tSessionId FROM register_user WHERE iUserId = '$PairedUserId'");
        $dataArr = array();
        $dataArr['iMemberId'] = $iMemberId;
        $dataArr['LinkedMembers.' . $PairedUserId] = array('iUserId' => $PairedUserId, 'name' => $userData[0]['userName']);
        $MONGO_OP_OBJ->updateTrackingUser($dataArr);
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userData[0]['vLang'], "1", "");
        $alertMsg = str_replace('#SITE_NAME#', $SITE_NAME, $languageLabelsArr['LBL_TRACK_SERVICE_DEVICE_PAIRED_SUCCESS_MSG']);
        $vMsgCode = strval(time());
        $message_arr = array();
        $message_arr['vMsgCode'] = $vMsgCode;
        $message_arr['vTitle'] = $alertMsg;
        $message_arr['MsgType'] = "TrackMemberPaired";
        $message_arr['time'] = time();
        $generalDataArr = array();
        $generalDataArr[] = array('eDeviceType' => $userData[0]['eDeviceType'], 'deviceToken' => $userData[0]['iGcmRegId'], 'eAppTerminate' => $userData[0]['eAppTerminate'], 'eDebugMode' => $userData[0]['eDebugMode'], 'eHmsDevice' => $userData[0]['eHmsDevice'], 'tSessionId' => $userData[0]['tSessionId'], 'alertMsg' => $alertMsg, 'message' => $message_arr, 'channelName' => "PASSENGER_" . $userData[0]['iUserId']);
        $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = $this->getTrackingMemberDetailInfo($iMemberId);
        setDataResponse($returnArr);
    }
    public function listTrackingUsers($iTrackServiceUserId = 0, $eMemberType = ''){
        global $obj, $LANG_OBJ, $iServiceId, $tconfig;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $vLang = isset($_REQUEST["vGeneralLang"])? $_REQUEST["vGeneralLang"] : '';
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $returnArr['Action'] = "1";
        $ssql = "";
        if($iTrackServiceUserId > 0){
            $ssql = " AND iTrackServiceUserId = '$iTrackServiceUserId' ";
        }
        if(!empty($eMemberType)){
            $ssql .= " AND eMemberType = '$eMemberType' ";
        }
        $tracking_users = $obj->MySQLSelect("SELECT iTrackServiceUserId, CONCAT(vName, ' ', vLastName)as userName, CONCAT('+', vPhoneCode, vPhone)as userPhone, vImage, vLocation as userLocation, vAddress as userAddress, vLatitude as userLatitude, vLongitude as userLongitude, eLocationTracking, eGpsStatus FROM track_service_users WHERE FIND_IN_SET($iMemberId, tUserIds)AND eStatus = 'Active' $ssql ");
        if(!empty($tracking_users)&& scount($tracking_users)> 0){
            $userArr = array();
            foreach($tracking_users as $k => $user){
                $userArr[$k]['iTrackServiceUserId'] = $user['iTrackServiceUserId'];
                $userArr[$k]['userName'] = $user['userName'];
                $userArr[$k]['userPhone'] = $user['userPhone'];
                $userArr[$k]['userAddress'] = !empty($user['userAddress'])? $user['userAddress'] : $user['userLocation'];
                $userArr[$k]['userLatitude'] = $user['userLatitude'];
                $userArr[$k]['userLongitude'] = $user['userLongitude'];
                $userArr[$k]['vImage'] = "";
                $image_path = $tconfig["tsite_upload_images_track_company_user_path"] . '/' . $user['iTrackServiceUserId'] . '/' . $user['vImage'];
                if(!empty($user['vImage'])&& file_exists($image_path)){
                    $userArr[$k]['vImage'] = $tconfig["tsite_upload_images_track_company_user"] . '/' . $user['iTrackServiceUserId'] . '/3_' . $user['vImage'];
                }
                $userArr[$k]['LocationTrackingStatus'] = $user['eLocationTracking'];
                $userArr[$k]['GpsStatus'] = $user['eGpsStatus'];
            }
            if($iTrackServiceUserId > 0){
                return $userArr[0];
            }
            $returnArr['message'] = $userArr;
        }
        else {
            $returnArr['message'] = "";
        }
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "checkTrackingProfileSetup"){
            return $returnArr;
        }
        setDataResponse($returnArr);
    }
    public function GeneratePairingCode(){
        global $obj;
        $random = RandomString(6, 'Yes');
        $db_str = $obj->MySQLSelect("SELECT vPairingCode FROM track_service_pairing_codes WHERE vPairingCode ='" . $random . "'");
        if(!empty($db_str)&& scount($db_str)> 0){
            $code = GeneratePairingCode();
        }
        else {
            $code = $random;
        }
        return $code;
    }
    public function getTrackingMemberDetailInfo($iMemberId){
        global $obj, $langLabels, $demo_site_msg, $generalSystemConfigDataArr, $tconfig, $vTimeZone, $vUserDeviceCountry, $iServiceId, $country_data_retrieve, $country_data_arr, $languageLabelDataArr, $MODULES_OBJ, $LANG_OBJ;
        if($MODULES_OBJ->isOnlyEnableFETApp()){
            $row = $obj->MySQLSelect("SELECT iTrackServiceUserId, tUserIds, iUserId FROM track_service_users WHERE iTrackServiceUserId ='" . $iMemberId . "'");
            $row[0]['DEVICE_PAIRED'] = "No";
            $row[0]['PAIRED_MEMBERS'] = "";
            if(!empty($row[0]['tUserIds'])){
                $row[0]['DEVICE_PAIRED'] = "Yes";
                $tUserIds = $row[0]['tUserIds'];
                $members = $obj->MySQLSelect("SELECT iUserId, CONCAT(vName, ' ', vLastName)as MemberName, CONCAT('+', vPhoneCode, vPhone)as MemberPhone, vImgName FROM register_user WHERE iUserId IN($tUserIds)AND eStatus = 'Active'");
                $membersArr = array();
                foreach($members as $member){
                    $membersArr[] = array('iUserId' => $member['iUserId'], 'MemberName' => $member['MemberName'], 'MemberPhone' => $member['MemberPhone'], 'MemberType' => $row[0]['eMemberType'] == "Family" ? $langLabels['LBL_TRACK_SERVICE_FAMILY_MEMBER_TXT'] : $langLabels['LBL_TRACK_SERVICE_EMPLOYEE_MEMBER_TXT'], 'vImage' => !empty($member['vImgName'])? $tconfig['tsite_upload_images_passenger'] . '/' . $member['iUserId'] . '/3_' . $member['vImgName'] : "");
                }
                $row[0]['PAIRED_MEMBERS'] = $membersArr;
            }
            $row[0]['MEMBER_TYPE'] = $this->GetMemberType($iMemberId);
            return $row[0];
        }
        $where = " iTrackServiceUserId = '" . $iMemberId . "'";
        $tblName = "track_service_users";
        $data_version['iAppVersion'] = "2";
        $data_version['eLogout'] = 'No';
        $data_version['eDebugMode'] = isset($_REQUEST["IS_DEBUG_MODE"])? $_REQUEST["IS_DEBUG_MODE"] : "";
        $data_version['tApiFileName'] = pathinfo(__FILE__, PATHINFO_FILENAME);
        $arr_app_version = array();
        $arr_app_version['AppVersionName'] = isset($_REQUEST['GeneralAppVersion'])? $_REQUEST['GeneralAppVersion'] : "";
        $arr_app_version['AppVersionCode'] = isset($_REQUEST['GeneralAppVersionCode'])? $_REQUEST['GeneralAppVersionCode'] : "";
        $data_version['tVersion'] = strval(json_encode($arr_app_version));
        $data_version['tDeviceData'] = isset($_REQUEST['DEVICE_DATA'])? $_REQUEST['DEVICE_DATA'] : "";
        $data_version['eHmsDevice'] = isset($_REQUEST['HMS_DEVICE'])? $_REQUEST['HMS_DEVICE'] : "No";
        $obj->MySQLQueryPerform($tblName, $data_version, 'update', $where);
        $row = $obj->MySQLSelect("SELECT *,iTrackServiceUserId as iMemberId FROM " . $tblName . " WHERE iTrackServiceUserId ='" . $iMemberId . "'");
        if(scount($row)> 0){
            $vLanguage = $row[0]['vLang'];
            if($vLanguage == "" || $vLanguage == NULL){
                $vLanguage = $LANG_OBJ->FetchDefaultLangData("vCode");
            }
            if(isset($languageLabelDataArr['language_label_union_other_' . $vLanguage])){
                $langLabels = $languageLabelDataArr['language_label_union_other_' . $vLanguage];
            }
            else {
                $langLabels = $LANG_OBJ->FetchLanguageLabels($vLanguage, "1");
                $languageLabelDataArr['language_label_union_other_' . $vLanguage] = $langLabels;
            }
            foreach($generalSystemConfigDataArr as $key => $value){
                if(is_null($generalSystemConfigDataArr[$key])|| empty($generalSystemConfigDataArr[$key])){
                    $generalSystemConfigDataArr[$key] = "";
                }
            }
            $row[0] = array_merge($row[0], $generalSystemConfigDataArr);
            if($_REQUEST['APP_TYPE'] != ""){
                $row[0]['APP_TYPE'] = $_REQUEST['APP_TYPE'];
            }
            $row[0]['REFERRAL_SCHEME_ENABLE'] = 'No';
            $row[0]['MULTI_LEVEL_REFERRAL_SCHEME_ENABLE'] = 'No';
            $row[0]['GOOGLE_ANALYTICS'] = "";
            $row[0]['SERVER_MAINTENANCE_ENABLE'] = $row[0]['MAINTENANCE_APPS'];
            if(isset($row[0]['AUDIO_CALLING_METHOD'])&& strtoupper($row[0]['AUDIO_CALLING_METHOD'])== "SINCH"){
                if(isset($row[0]['SINCH_APP_ENVIRONMENT_HOST'])&&($row[0]['SINCH_APP_ENVIRONMENT_HOST'] == "" || strpos($row[0]['SINCH_APP_ENVIRONMENT_HOST'], '#')!== false)){
                    $row[0]['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
                }
                if(isset($row[0]['SINCH_APP_KEY'])&&($row[0]['SINCH_APP_KEY'] == "" || strpos($row[0]['SINCH_APP_KEY'], '#')!== false)){
                    $row[0]['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
                }
                if(isset($row[0]['SINCH_APP_SECRET_KEY'])&&($row[0]['SINCH_APP_SECRET_KEY'] == "" || strpos($row[0]['SINCH_APP_SECRET_KEY'], '#')!== false)){
                    $row[0]['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
                }
                $usercountrycode = $row[0]['vCountry'];
                if($usercountrycode != ""){
                    $eEnableSinch = checkCountryVoipMethod($usercountrycode);
                    if(strtoupper($eEnableSinch)== "NO"){
                        $row[0]['RIDE_DRIVER_CALLING_METHOD'] = "Normal";
                    }
                }
            }
            if($row[0]['tDeviceSessionId'] == ""){
                $random = substr(md5(rand()), 0, 7);
                $Update_Device_Session['tDeviceSessionId'] = session_id(). time(). $random;
                $Update_Device_Session_id = $obj->MySQLQueryPerform($tblName, $Update_Device_Session, 'update', $where);
                $row[0]['tDeviceSessionId'] = $Update_Device_Session['tDeviceSessionId'];
            }
            if($row[0]['tSessionId'] == ""){
                $Update_Session['tSessionId'] = session_id(). time();
                $Update_Session_id = $obj->MySQLQueryPerform($tblName, $Update_Session, 'update', $where);
                $row[0]['tSessionId'] = $Update_Session['tSessionId'];
            }
            if($row[0]['vImage'] != "" && $row[0]['vImage'] != "NONE"){
                $row[0]['vImage'] = "3_" . $row[0]['vImage'];
            }
            if($row[0]['eStatus'] != "Active"){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_ACC_DELETE_TXT";
                if($row[0]['eStatus'] != "Deleted"){
                    $returnArr['message'] = "LBL_CONTACT_US_STATUS_NOTACTIVE_PASSENGER";
                }
                setDataResponse($returnArr);
            }
            $row[0]['Allow_Edit_Profile'] = "Yes";
            $row[0]['SITE_TYPE'] = SITE_TYPE;
            $row[0]['SITE_TYPE_DEMO_MSG'] = $demo_site_msg;
            $usercountrydetailbytimezone = FetchMemberCountryData($iMemberId, "Tracking", $vTimeZone, $vUserDeviceCountry);
            $row[0]['vDefaultCountry'] = $usercountrydetailbytimezone['vDefaultCountry'];
            $row[0]['vDefaultCountryCode'] = $usercountrydetailbytimezone['vDefaultCountryCode'];
            $row[0]['vDefaultPhoneCode'] = $usercountrydetailbytimezone['vDefaultPhoneCode'];
            $row[0]['vRCountryImage'] = $usercountrydetailbytimezone['vRImageMember'];
            $row[0]['vSCountryImage'] = $usercountrydetailbytimezone['vSImageMember'];
            $row[0]['vDefaultCountryImage'] = empty($row[0]['vSCountryImage'])? $usercountrydetailbytimezone['vDefaultCountryImage'] : $row[0]['vSCountryImage'];
            $row[0]['vPhoneCode'] = empty($row[0]['vPhoneCode'])? $row[0]['vDefaultPhoneCode'] : $row[0]['vPhoneCode'];
            $row[0]['vCountry'] = empty($row[0]['vCountry'])? $row[0]['vDefaultCountryCode'] : $row[0]['vCountry'];
            $SITE_POLICE_CONTROL_NUMBER = getMemberCountryPoliceNumber($iMemberId, "Tracking", $row[0]['vCountry']);
            $row[0]['SITE_POLICE_CONTROL_NUMBER'] = $SITE_POLICE_CONTROL_NUMBER;
            $row[0]['MONGO_DB'] = $tconfig['tmongodb_databse'];
            $row[0]['MONGO_DB_CONNECTION_PORT'] = $tconfig['tmongodb_port'];
            $row[0]['SERVER_DEFAULT_TIMEZONE'] = date_default_timezone_get();
            $row[0]['tsite_upload_docs_file_extensions'] = $tconfig['tsite_upload_docs_file_extensions'];
            $row[0]['tsite_upload_image_file_extensions'] = $tconfig['tsite_upload_image_file_extensions'];
            $row[0]['tsite_upload_video_file_extensions'] = $tconfig['tsite_upload_video_file_extensions'];
            $row[0]['SC_CONNECT_URL'] = getSocketURL();
            $row[0]['APP_SERVICE_URL'] = APP_SERVICE_URL;
            if(scount($country_data_retrieve)> 0){
                $getCountryData = array();
                for($h = 0;
                $h < scount($country_data_retrieve);
                $h++){
                    if(strtoupper($country_data_retrieve[$h]['eStatus'])== "ACTIVE"){
                        $getCountryData[] = $country_data_retrieve[$h]['iCountryId'];
                    }
                }
            }
            else {
                $getCountryData = $obj->MySQLSelect("SELECT iCountryId FROM country WHERE eStatus='Active'");
            }
            $multiCountry = "No";
            if(scount($getCountryData)> 1){
                $multiCountry = "Yes";
            }
            $row[0]['showCountryList'] = $multiCountry;
            $row[0]['RANDOM_COLORS_KEY_VAL_ARR'] = RANDOM_COLORS_KEY_VAL_ARR;
            $row[0]['AUTH_EMAIL_SYSTEM'] = AUTH_EMAIL_SYSTEM;
            $getPageData = $obj->MySQLSelect("SELECT iPageId,eStatus FROM pages WHERE iPageId IN(4,33,52)");
            foreach($getPageData as $kPage => $vPage){
                if($vPage['iPageId'] == 4)$pagename = "showTermsCondition";
                if($vPage['iPageId'] == 33)$pagename = "showPrivacyPolicy";
                if($vPage['iPageId'] == 52)$pagename = "showAboutUs";
                $row[0][$pagename] = $vPage['eStatus'] == 'Active' ? 'Yes' : 'No';
            }
            $row[0]['APP_LAUNCH_IMAGES'] = "";
            if(!empty(getAppLaunchImages($vLanguage, 'TrackServiceUser'))){
                $row[0]['APP_LAUNCH_IMAGES'] = getAppLaunchImages($vLanguage, 'TrackServiceUser');
            }
            $row[0]['DEVICE_PAIRED'] = "No";
            $row[0]['PAIRED_MEMBERS'] = "";
            if(!empty($row[0]['tUserIds'])){
                $row[0]['DEVICE_PAIRED'] = "Yes";
                $tUserIds = $row[0]['tUserIds'];
                $members = $obj->MySQLSelect("SELECT iUserId, CONCAT(vName, ' ', vLastName)as MemberName, CONCAT('+', vPhoneCode, vPhone)as MemberPhone, vImgName FROM register_user WHERE iUserId IN($tUserIds)AND eStatus = 'Active'");
                $membersArr = array();
                foreach($members as $member){
                    $membersArr[] = array('iUserId' => $member['iUserId'], 'MemberName' => $member['MemberName'], 'MemberPhone' => $member['MemberPhone'], 'MemberType' => $row[0]['eMemberType'] == "Family" ? $langLabels['LBL_TRACK_SERVICE_FAMILY_MEMBER_TXT'] : $langLabels['LBL_TRACK_SERVICE_EMPLOYEE_MEMBER_TXT'], 'vImage' => !empty($member['vImgName'])? $tconfig['tsite_upload_images_passenger'] . '/' . $member['iUserId'] . '/3_' . $member['vImgName'] : "");
                }
                $row[0]['PAIRED_MEMBERS'] = $membersArr;
            }
            $row[0]['MEMBER_TYPE'] = $this->GetMemberType($iMemberId);
            $row[0]['TSITE_DB'] = TSITE_DB;
            $row[0]['GOOGLE_API_REPLACEMENT_URL'] = GOOGLE_API_REPLACEMENT_URL;
            $row[0]['ENABLE_APPLE_LOGIN_FOR_USER'] =($MODULES_OBJ->isEnableAppleLoginForUser())? "Yes" : "No";
            $row[0]['WEBRTC_SOCKET_URL'] = WEBRTC_SOCKET_URL;
            $row[0]['WEBRTC_ICE_SERVER_LIST'] = WEBRTC_ICE_SERVER_LIST;
            $row[0]['WEBRTC_USERNAME'] = $tconfig["tsite_webrtc_username"];
            $row[0]['WEBRTC_PASS'] = $tconfig["tsite_webrtc_pass"];
            $row[0]['isSmartLoginEnable'] = $MODULES_OBJ->isEnableSmartLogin()? "Yes" : "No";
            $row[0]['RIDE_ENABLED'] = "No";
            $row[0]['DELIVERY_ENABLED'] = "No";
            $row[0]['UFX_ENABLED'] = "No";
            $row[0]['DELIVERALL_ENABLED'] = "No";
            $row[0]['GENIE_ENABLED'] = "No";
            $row[0]['RUNNER_ENABLED'] = "No";
            $row[0]['BIDDING_ENABLED'] = "No";
            $row[0]['VC_ENABLED'] = "No";
            $row[0]['MED_UFX_ENABLED'] = "No";
            $row[0]['RENT_ITEM_ENABLED'] = "No";
            $row[0]['RENT_ESTATE_ENABLED'] = "No";
            $row[0]['RENT_CARS_ENABLED'] = "No";
            $row[0]['NEARBY_ENABLED'] = "No";
            $row[0]['TRACK_SERVICE_ENABLED'] = "No";
            $row[0]['RIDE_SHARE_ENABLED'] = "No";
            $row[0]['TRACK_ANY_SERVICE_ENABLED'] = "Yes";
            unset($row[0]['vLatitude']);
            unset($row[0]['vLongitude']);
            unset($row[0]['eGpsStatus']);
            unset($row[0]['MAIL_FOOTER']);
            return $row[0];
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRY_AGAIN_LATER_TXT";
            setDataResponse($returnArr);
        }
    }
    private function GetMemberType($iMemberId){
        global $obj;
        $memberData = $obj->MySQLSelect("SELECT iTrackServiceUserId FROM track_service_users WHERE FIND_IN_SET($iMemberId, tUserIds)AND eStatus = 'Active' ");
        $memberType = "Parent";
        if(!empty($memberData)&& scount($memberData)> 0){
            $memberType = "Child";
        }
        return $memberType;
    }
    public function getPairingCode(){
        global $obj;
        $iUserId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $MemberType = isset($_REQUEST["MemberType"])? $_REQUEST["MemberType"] : '';
        if(empty($MemberType)){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
            setDataResponse($returnArr);
        }
        $pairing_code = $this->GeneratePairingCode();
        $pairing_code_db = $obj->MySQLSelect("SELECT iCodeId,vPairingCode FROM track_service_pairing_codes WHERE iUserId = '$iUserId' AND eMemberType = '$MemberType' ");
        if(!empty($pairing_code_db)&& scount($pairing_code_db)> 0){
            $Data_update = array();
            $Data_update['vPairingCode'] = $pairing_code;
            $where = " iCodeId = '" . $pairing_code_db[0]['iCodeId'] . "'";
            $obj->MySQLQueryPerform("track_service_pairing_codes", $Data_update, "update", $where);
        }
        else {
            $Data_insert = array();
            $Data_insert['iUserId'] = $iUserId;
            $Data_insert['vPairingCode'] = $pairing_code;
            $Data_insert['eMemberType'] = $MemberType;
            $obj->MySQLQueryPerform("track_service_pairing_codes", $Data_insert, "insert");
        }
        $returnArr['Action'] = "1";
        $returnArr['message'] = $pairing_code;
        setDataResponse($returnArr);
    }
    public function configTrackingTripStatus(){
        global $obj;
        $iMemberId = isset($_REQUEST["iMemberId"])? $_REQUEST["iMemberId"] : '';
        $vLatitude = isset($_REQUEST["vLatitude"])? $_REQUEST["vLatitude"] : '';
        $vLongitude = isset($_REQUEST["vLongitude"])? $_REQUEST["vLongitude"] : '';
        if($iMemberId != ""){
            if(!empty($vLatitude)&& !empty($vLongitude)){
                $driver_update['vLatitude'] = $vLatitude;
                $driver_update['vLongitude'] = $vLongitude;
            }
            if(scount($driver_update)> 0){
                $where = " iTrackServiceUserId = '" . $iMemberId . "'";
                $Update_driver = $obj->MySQLQueryPerform("track_service_users", $driver_update, "update", $where);
            }
        }
        $returnArr['Action'] = "1";
        setDataResponse($returnArr);
    }
    public function removeLinkedMember(){
        global $obj, $LANG_OBJ, $EVENT_MSG_OBJ, $SITE_NAME, $MONGO_OP_OBJ;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $UserType = isset($_REQUEST["GeneralUserType"])? $_REQUEST["GeneralUserType"] : '';
        $PairedUserId = isset($_REQUEST["PairedUserId"])? $_REQUEST["PairedUserId"] : '';
        if(!empty($PairedUserId)){
            $ssql = " AND iTrackServiceUserId = '$iMemberId' ";
            if($this->isOnlyEnableFETApp){
                $UserType = isset($_REQUEST["UserType"])? $_REQUEST["UserType"] : '';
                $ssql = " AND iUserId = '$iMemberId' ";
            }
            if($UserType == "Tracking"){
                $obj->sql_query("UPDATE track_service_users SET tUserIds = TRIM(BOTH ',' FROM REPLACE(CONCAT(',', tUserIds, ','), ',$PairedUserId,', ','))WHERE 1 = 1 $ssql ");
                $userData = $obj->MySQLSelect("SELECT iUserId, CONCAT(vName, ' ', vLastName)as userName, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, eHmsDevice, tSessionId FROM register_user WHERE iUserId = '$PairedUserId'");
                $trackUserData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as trackUserName FROM track_service_users WHERE iTrackServiceUserId = '$iMemberId'");
                $alertUserName = $trackUserData[0]['trackUserName'];
                $channelName = "PASSENGER_" . $userData[0]['iUserId'];
                $alertLabel = "LBL_TRACK_SERVICE_PAIRED_MEMBER_REMOVED_MSG";
            }
            else {
                $obj->sql_query("UPDATE track_service_users SET tUserIds = TRIM(BOTH ',' FROM REPLACE(CONCAT(',', tUserIds, ','), ',$iMemberId,', ','))WHERE iTrackServiceUserId = '$PairedUserId'");
                $userData = $obj->MySQLSelect("SELECT iTrackServiceUserId, CONCAT(vName, ' ', vLastName)as userName, vLang, eDeviceType, iGcmRegId, eAppTerminate, eDebugMode, eHmsDevice, tSessionId FROM track_service_users WHERE iTrackServiceUserId = '$PairedUserId'");
                $trackUserData = $obj->MySQLSelect("SELECT CONCAT(vName, ' ', vLastName)as userName FROM register_user WHERE iUserId = '$iMemberId'");
                $alertUserName = $trackUserData[0]['userName'];
                $channelName = "TRACKING_" . $userData[0]['iTrackServiceUserId'];
                $alertLabel = "LBL_TRACK_SERVICE_TRACK_MEMBER_REMOVED_MSG";
            }
            $dataArr = array();
            $dataArr['LinkedMembers.' . $iMemberId] = "";
            $dataFilter = array('iMemberId' => $PairedUserId);
            $MONGO_OP_OBJ->removeTrackingLinkedMember($dataArr, $dataFilter);
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userData[0]['vLang'], "1", "");
            $alertMsg = str_replace(['#NAME#', '#SITE_NAME#'], [$alertUserName, $SITE_NAME], $languageLabelsArr[$alertLabel]);
            $vMsgCode = strval(time());
            $message_arr = array();
            $message_arr['vMsgCode'] = $vMsgCode;
            $message_arr['vTitle'] = $alertMsg;
            $message_arr['MsgType'] = "TrackMemberRemoved";
            $message_arr['iMemberId'] = $iMemberId;
            $message_arr['time'] = time();
            $generalDataArr = array();
            $generalDataArr[] = array('eDeviceType' => $userData[0]['eDeviceType'], 'deviceToken' => $userData[0]['iGcmRegId'], 'eAppTerminate' => $userData[0]['eAppTerminate'], 'eDebugMode' => $userData[0]['eDebugMode'], 'eHmsDevice' => $userData[0]['eHmsDevice'], 'tSessionId' => $userData[0]['tSessionId'], 'alertMsg' => $alertMsg, 'message' => $message_arr, 'channelName' => $channelName);
            $returnArr['Action'] = "1";
            if($UserType == "Tracking"){
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
                $returnArr['message'] = "";
                $returnArr['USER_DATA'] = $this->getTrackingMemberDetailInfo($iMemberId);
            }
            else {
                $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_TRACK_USER);
                $returnArr['message'] = "";
                $returnArr['USER_DATA'] = getPassengerDetailInfo($iMemberId, '', '');
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_SOMETHING_WENT_WRONG_MSG";
        }
        setDataResponse($returnArr);
    }
    public function updateLocationTrackingStatus(){
        global $obj, $LANG_OBJ, $EVENT_MSG_OBJ, $SITE_NAME;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $LocationTrackingStatus = isset($_REQUEST["LocationTrackingStatus"])? $_REQUEST["LocationTrackingStatus"] : '';
        $GpsStatus = isset($_REQUEST["GpsStatus"])? $_REQUEST["GpsStatus"] : '';
        if($this->isOnlyEnableFETApp){
            $iMemberId = $this->signupTrackUser($iMemberId);
        }
        if(!empty($LocationTrackingStatus)){
            $obj->sql_query("UPDATE track_service_users SET eLocationTracking = '$LocationTrackingStatus' WHERE iTrackServiceUserId = '$iMemberId' ");
        }
        if(!empty($GpsStatus)){
            $obj->sql_query("UPDATE track_service_users SET eGpsStatus = '$GpsStatus' WHERE iTrackServiceUserId = '$iMemberId' ");
        }
        $track_user_db = $obj->MySQLSelect("SELECT tUserIds, CONCAT(vName, ' ', vLastName)as userName, eLocationTracking, eGpsStatus FROM track_service_users WHERE iTrackServiceUserId = '$iMemberId' ");
        $LocationTrackingStatus = $track_user_db[0]['eLocationTracking'];
        $GpsStatus = $track_user_db[0]['eGpsStatus'];
        $returnArr['Action'] = "1";
        $returnArr['LocationTrackingStatus'] = $LocationTrackingStatus;
        $returnArr['GpsStatus'] = $GpsStatus;
        setDataResponse($returnArr);
    }
    public function getTrackingMemberDetail($iMemberId){
        $iMemberId = $this->signupTrackUser($iMemberId);
        $data = $this->getTrackingMemberDetailInfo($iMemberId);
        return $data;
    }
    public function getSubscriptionHistory(){
        global $obj, $LANG_OBJ;
        $iUserId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $tblPlan = 'user_subscription_plan';
        $tblDetails = 'user_subscription_details';
        $userData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger, ru.vLang, cu.vSymbol FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $iUserId . "'");
        $userlangcode = $userData[0]['vLang'];
        $currencySymbol = $userData[0]['vSymbol'];
        $currencycode = $userData[0]['vCurrencyPassenger'];
        if($userlangcode == "" || $userlangcode == NULL){
            $userlangcode = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
        }
        if($currencySymbol == "" || $currencySymbol == NULL){
            $currencySymbol = get_value('currency', 'vSymbol', 'eDefault', 'Yes', '', 'true');
        }
        $userCurrencyRatio = get_value('currency', 'Ratio', 'vName', $currencycode, '', 'true');
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userlangcode, "1");
        $SubscriptionTxt = $languageLabelsArr['LBL_SUBSCRIPTION_TXT'];
        $DailySubscriptionTxt = $languageLabelsArr['LBL_DAILY_SUBSCRIPTION'];
        $WeeklySubscriptionTxt = $languageLabelsArr['LBL_WEEKLY_SUBSCRIPTION'];
        $MonthlySubscriptionTxt = $languageLabelsArr['LBL_MONTHLY_SUSCRIPTION'];
        $DailyDurTxt = $languageLabelsArr['LBL_DAYS'];
        $WeeklyDurTxt = $languageLabelsArr['LBL_SUB_WEEKS'];
        $MonthlyDurTxt = $languageLabelsArr['LBL_SUB_MONTH'];
        $getField = "d.eSubscriptionStatus, d.vPlanName, d.vPlanDescription,d.vPlanPeriod,d.ePlanValidity,FORMAT(d.fPrice * $userCurrencyRatio,2)as fPlanPrice, CASE WHEN d.ePlanValidity = 'Daily' THEN '$DailySubscriptionTxt' WHEN d.ePlanValidity = 'Weekly' THEN '$WeeklySubscriptionTxt' WHEN d.ePlanValidity = 'Monthly' THEN '$MonthlySubscriptionTxt' ELSE '$SubscriptionTxt' END AS PlanTypeTitle, CASE WHEN d.ePlanValidity = 'Daily' THEN CONCAT(d.vPlanPeriod,' $DailyDurTxt')WHEN d.ePlanValidity = 'Weekly' THEN CONCAT(d.vPlanPeriod,' $WeeklyDurTxt')WHEN d.ePlanValidity = 'Monthly' THEN CONCAT(d.vPlanPeriod,' $MonthlyDurTxt')ELSE CONCAT(p.vPlanPeriod,'$SubscriptionTxt')END AS PlanDuration, d.tSubscribeDate,d.tExpiryDate,IFNULL(DATEDIFF(d.tExpiryDate,CURDATE()),'0')AS planLeftDays";
        $sql = "SELECT $getField FROM $tblDetails d INNER JOIN $tblPlan p ON d.iUserSubscriptionPlanId = p.iUserSubscriptionPlanId AND d.iUserId = $iUserId ORDER BY d.tSubscribeDate DESC, d.tExpiryDate DESC";
        $getUserSubscription = $obj->MySQLSelect($sql);
        foreach($getUserSubscription as $key => $value){
            $getUserSubscription[$key]['fPlanPrice'] = formateNumAsPerCurrency($value['fPlanPrice'], $currencycode);
        }
        if(empty($getUserSubscription)){
            $returnArr['Action'] = 0;
            $returnArr['message'] = "LBL_NO_SUBSCRIPTION_PLANS";
        }
        else {
            $returnArr['Action'] = 1;
            $returnArr['message'] = $getUserSubscription;
        }
        setDataResponse($returnArr);
    }
    public function getSubscriptionPlans(){
        global $obj, $LANG_OBJ;
        $iUserId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $tblPlan = 'user_subscription_plan';
        $tblDetails = 'user_subscription_details';
        $userData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger, ru.vLang, cu.vSymbol FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $iUserId . "'");
        $userlangcode = $userData[0]['vLang'];
        $currencySymbol = $userData[0]['vSymbol'];
        $currencycode = $userData[0]['vCurrencyPassenger'];
        if($userlangcode == "" || $userlangcode == NULL){
            $userlangcode = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
        }
        $userdefaultlangcode = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
        if($currencySymbol == "" || $currencySymbol == NULL){
            $currencySymbol = get_value('currency', 'vSymbol', 'eDefault', 'Yes', '', 'true');
        }
        $userCurrencyRatio = get_value('currency', 'Ratio', 'vName', $currencycode, '', 'true');
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userlangcode, "1");
        $SubscriptionTxt = $languageLabelsArr['LBL_SUBSCRIPTION_TXT'];
        $DailySubscriptionTxt = $languageLabelsArr['LBL_DAILY_SUBSCRIPTION'];
        $WeeklySubscriptionTxt = $languageLabelsArr['LBL_WEEKLY_SUBSCRIPTION'];
        $MonthlySubscriptionTxt = $languageLabelsArr['LBL_MONTHLY_SUSCRIPTION'];
        $DailyDurTxt = $languageLabelsArr['LBL_DAYS'];
        $WeeklyDurTxt = $languageLabelsArr['LBL_SUB_WEEKS'];
        $MonthlyDurTxt = $languageLabelsArr['LBL_SUB_MONTH'];
        $getField = "p.iUserSubscriptionPlanId, CASE WHEN(p.vPlanName_$userlangcode is null or p.vPlanName_$userlangcode = '')THEN p.vPlanName_$userdefaultlangcode ELSE p.vPlanName_$userlangcode END AS vPlanName, CASE WHEN(p.vPlanDescription_$userlangcode is null or p.vPlanDescription_$userlangcode = '')THEN p.vPlanDescription_$userdefaultlangcode ELSE p.vPlanDescription_$userlangcode END AS vPlanDescription, p.vPlanPeriod AS vPlanPeriod, p.ePlanValidity AS PlanType, CASE WHEN p.ePlanValidity = 'Daily' THEN '$DailySubscriptionTxt' WHEN p.ePlanValidity = 'Weekly' THEN '$WeeklySubscriptionTxt' WHEN p.ePlanValidity = 'Monthly' THEN '$MonthlySubscriptionTxt' ELSE 'Subscribe' END AS PlanTypeTitle, CASE WHEN p.ePlanValidity = 'Daily' THEN CONCAT(p.vPlanPeriod,' $DailyDurTxt')WHEN p.ePlanValidity = 'Weekly' THEN CONCAT(p.vPlanPeriod,' $WeeklyDurTxt')WHEN p.ePlanValidity = 'Monthly' THEN CONCAT(p.vPlanPeriod,' $MonthlyDurTxt')ELSE CONCAT(p.vPlanPeriod,'Subscribe')END AS PlanDuration, FORMAT(p.fPrice * $userCurrencyRatio,2)as fPlanPrice, IFNULL(d.eSubscriptionStatus,'Unsubscribed')as eSubscriptionStatus,IFNULL(d.tSubscribeDate,'N/A')as tSubscribeDate,IFNULL(d.tExpiryDate,'N/A')as tExpiryDate,IFNULL(DATEDIFF(d.tExpiryDate,CURDATE()),'0')AS planLeftDays,p.eStatus, CASE WHEN p.eStatus = 'Inactive' AND d.eSubscriptionStatus = 'Subscribed' THEN 'No' WHEN p.eStatus = 'Deleted' AND d.eSubscriptionStatus = 'Subscribed' THEN 'No' WHEN d.eSubscriptionStatus = 'Subscribed' THEN 'Yes' ELSE 'No' END AS isRenew";
        $sql = "SELECT $getField FROM $tblDetails d RIGHT JOIN $tblPlan p ON d.iUserSubscriptionPlanId = p.iUserSubscriptionPlanId AND d.iUserId = $iUserId AND d.eSubscriptionStatus = 'Subscribed' WHERE((p.eStatus != 'Deleted' ||(p.eStatus = 'Deleted' && d.eSubscriptionStatus = 'Subscribed'))&&(p.eStatus != 'Inactive' ||(p.eStatus = 'Inactive' && d.eSubscriptionStatus = 'Subscribed')))ORDER BY p.iUserSubscriptionPlanId ASC";
        $getUserSubscription = $obj->MySQLSelect($sql);
        foreach($getUserSubscription as $key => $value){
            $getUserSubscription[$key]['fPlanPrice'] = formateNumAsPerCurrency($value['fPlanPrice'], $currencycode);
        }
        if(empty($getUserSubscription)){
            $returnArr['Action'] = 0;
            $returnArr['message'] = "LBL_NO_SUBSCRIPTION_PLANS";
        }
        else {
            $returnArr['Action'] = 1;
            $returnArr['message'] = $getUserSubscription;
        }
        setDataResponse($returnArr);
    }
    public function SubscribePlan(){
        global $obj, $LANG_OBJ, $WALLET_OBJ, $tconfig;
        $iUserId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $isCard = isset($_REQUEST['isCard'])? trim($_REQUEST['isCard']): 'No';
        $isWallet = isset($_REQUEST['isWallet'])? trim($_REQUEST['isWallet']): 'No';
        $iUserSubscriptionPlanId = isset($_REQUEST['iUserSubscriptionPlanId'])? trim($_REQUEST['iUserSubscriptionPlanId']): '';
        $payStatus = isset($_REQUEST["payStatus"])? $_REQUEST["payStatus"] : '';
        $CheckUserWallet = isset($_REQUEST["CheckUserWallet"])? $_REQUEST["CheckUserWallet"] : 'No';
        $isUpgrade = isset($_REQUEST["isUpgrade"])? $_REQUEST["isUpgrade"] : '';
        if($payStatus != "succeeded" && $payStatus != ""){
            $payStatus = "Failed";
        }
        $tblDetails = 'user_subscription_details';
        $tblPlan = 'user_subscription_plan';
        $flagerr = 1;
        $date = date("Y-m-d H:i:s");
        if(empty($isUpgrade)){
            $selUpgraded = "SELECT count(*)as cntrec FROM $tblDetails WHERE iUserId = $iUserId AND eSubscriptionStatus = 'Subscribed'";
            $dbUpgraded = $obj->MySQLSelect($selUpgraded);
            if($dbUpgraded[0]['cntrec']>0){
                $returnArr['Action'] = 1;
                $returnArr['message'] = "LBL_UPGRADE_PLANS";
                $returnArr['isUpgrade'] = 'Yes';
                setDataResponse($returnArr);
            }
        }
        $userData = $obj->MySQLSelect("SELECT ru.vCurrencyPassenger, ru.vLang, ru.tSessionId, cu.vSymbol FROM register_user as ru LEFT JOIN currency as cu ON ru.vCurrencyPassenger = cu.vName WHERE iUserId = '" . $iUserId . "'");
        $currencycode = $userData[0]['vCurrencyPassenger'];
        $currencySymbol = $userData[0]['vSymbol'];
        $userlangcode = $userData[0]['vLang'];
        if($userlangcode == "" || $userlangcode == NULL){
            $userlangcode = get_value('language_master', 'vCode', 'eDefault', 'Yes', '', 'true');
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userlangcode, "1");
        if($currencycode == "" || $currencycode == NULL){
            $sql = "SELECT vName,vSymbol from currency WHERE eDefault = 'Yes'";
            $currencyData = $obj->MySQLSelect($sql);
            $currencycode = $currencyData[0]['vName'];
            $currencySymbol = $currencyData[0]['vSymbol'];
        }
        $WalletSubscriptionTxt = $languageLabelsArr['LBL_WALLET_SUBSRIPTION_PLAN'];
        $walletbalance = $cardbalance = $fPrice = get_value($tblPlan, 'fPrice', 'iUserSubscriptionPlanId', $iUserSubscriptionPlanId, '', 'true');
        $userCurrencyRatio = get_value('currency', 'Ratio', 'vName', $currencycode, '', 'true');
        if($fPrice==0 || empty($fPrice)){
            $this->updateUserSubscription($iUserSubscriptionPlanId, $iUserId, $walletbalance, $insid);
            $returnArr['Action'] = 1;
            $returnArr['message'] = "LBL_SUBSCRIBED_SUCCESFULLY_TXT";
            setDataResponse($returnArr);
        }
        $user_available_balance = $WALLET_OBJ->FetchMemberWalletBalance($iUserId, "Rider");
        $user_available_balance_cur = $WALLET_OBJ->FetchMemberCurrencyWalletBalance($iUserId, "Rider");
        $cardbalance_cur = $walletbalance_cur = $fPrice_cur = $walletbalance*$userCurrencyRatio;
        if($isWallet=='Yes' && $payStatus == ""){
            if($user_available_balance_cur<$fPrice_cur && $isCard=='No'){
                $returnArr['Action'] = 0;
                $returnArr['message'] = "LBL_LOW_WALLET_BAL_NOTE";
                setDataResponse($returnArr);
            }
            if($user_available_balance_cur >= $fPrice_cur){
                $insid = $WALLET_OBJ->PerformWalletTransaction($iUserId, 'Rider', $walletbalance, 'Debit', 0, 'Subscription', $WalletSubscriptionTxt, 'Unsettelled', $date);
                if(empty($insid)){
                    $returnArr['Action'] = 0;
                    $returnArr['message'] = "LBL_NO_SUBSCRIPTION_PLANS";
                    setDataResponse($returnArr);
                }
                else {
                    $this->updateUserSubscription($iUserSubscriptionPlanId, $iUserId, $walletbalance, $insid);
                    $returnArr['Action'] = 1;
                    $returnArr['message'] = "LBL_SUBSCRIBED_SUCCESFULLY_TXT";
                    setDataResponse($returnArr);
                }
            }
        }
        $DefaultCurrencyData = get_value('currency', 'vName,Ratio', 'eDefault', 'Yes');
        $currencyCode = $DefaultCurrencyData[0]['vName'];
        $currencyratio = $DefaultCurrencyData[0]['Ratio'];
        if($user_available_balance_cur > 0 && $isWallet=='Yes'){
            $walletbalance_cur = $user_available_balance_cur;
            $walletbalance = round($walletbalance_cur / $userCurrencyRatio,2);
            $cardbalance_cur =($fPrice_cur-$user_available_balance_cur);
            $cardbalance = round($cardbalance_cur / $userCurrencyRatio,2);
        }
        else {
            $walletbalance = 0;
        }
        if($isCard == 'Yes' && $cardbalance_cur > 0 && $payStatus == ""){
            $CheckUserWallet =($isWallet == 'Yes')? "Yes" : "No";
            $iMemberId = $iUserId;
            $UserType = "Passenger";
            $returnArr['Action'] = 0;
            $returnArr['msg_type'] = "ADD_CARD";
            $extraParams = "tSessionId=".$userData[0]['tSessionId']."&GeneralMemberId=".$iMemberId."&GeneralUserType=".$UserType."&iUserSubscriptionPlanId=".$iUserSubscriptionPlanId."&isWallet=".$isWallet."&isCard=".$isCard."&isUpgrade=".$isUpgrade."&AMOUNT=".$cardbalance."&PAGE_TYPE=SUBSCRIBE_PLAN&SYSTEM_TYPE=APP&IS_RETURN_RESULT=Yes";
            $returnArr['ADD_CARD_URL'] = $tconfig['tsite_url'].'assets/libraries/webview/system_payment.php?'.$extraParams;
            setDataResponse($returnArr);
        }
        if($payStatus == "succeeded"){
            $payment_id = $_REQUEST['payment_id'];
            $where_payments = " iPaymentId = '" . $payment_id . "'";
            $data_payments['iOrderId'] = $iUserSubscriptionPlanId;
            $data_payments['eEvent'] = "SubscribePayment";
            $obj->MySQLQueryPerform("payments", $data_payments, 'update', $where_payments);
            if($walletbalance > 0 &&($isWallet == "Yes" || $CheckUserWallet == 'Yes')){
                $insid = $WALLET_OBJ->PerformWalletTransaction($iUserId, 'Rider', $walletbalance, 'Debit', 0, 'Subscription', $WalletSubscriptionTxt, 'Unsettelled', $date);
            }
            $this->updateUserSubscription($iUserSubscriptionPlanId,$iUserId,$fPrice,$insid,$payment_id);
            $returnUrl = $tconfig['tsite_url'] . "assets/libraries/webview/success.php";
            header('Location:'.$returnUrl."?success=1&SYSTEM_TYPE=APP");
            exit;
        }
        if($flagerr==0){
            $returnArr['Action'] = 0;
            $returnArr['message'] = "LBL_NO_SUBSCRIPTION_PLANS";
        }
        else {
            $returnArr['Action'] = 1;
            $returnArr['message'] = "LBL_SUBSCRIBED_SUCCESFULLY_TXT";
        }
        setDataResponse($returnArr);
    }
    public function CancelSubscription(){
        global $obj, $COMM_MEDIA_OBJ;
        $iUserId = isset($_REQUEST['GeneralMemberId'])? trim($_REQUEST['GeneralMemberId']): '';
        $iUserSubscriptionPlanId = isset($_REQUEST['iUserSubscriptionPlanId'])? trim($_REQUEST['iUserSubscriptionPlanId']): '';
        $tblDetails = 'user_subscription_details';
        $dataCancelSubscription['tClosedDate'] = date("Y-m-d H:i:s");
        $dataCancelSubscription['eSubscriptionStatus'] = 'Cancelled';
        $where = "iUserId = '".$iUserId."' AND iUserSubscriptionPlanId = '".$iUserSubscriptionPlanId."' AND eSubscriptionStatus = 'Subscribed'";
        $id = $obj->MySQLQueryPerform($tblDetails, $dataCancelSubscription, 'update', $where);
        if(empty($id)){
            $returnArr['Action'] = 0;
            $returnArr['message'] = "LBL_ERROR_CANCEL_SUBSCRIPTION";
        }
        else {
            $userData = get_value('register_user', 'vEmail,vName,vLastName', 'iUserId', $iUserId);
            $getMaildata = array();
            $getMaildata['vEmail'] = $userData[0]['vEmail'];
            $getMaildata['FromName'] = $userData[0]['vName'].' '.$userData[0]['vLastName'];
            $getMaildata['EMAIL_NAME'] = $userData[0]['vName'].' '.$userData[0]['vLastName'];
            $mail = $COMM_MEDIA_OBJ->SendMailToMember('USER_SUBSCRIPTION_CANCEL',$getMaildata);
            $returnArr['Action'] = 1;
            $returnArr['message'] = "LBL_CANCELLED_SUCCESFULLY_TXT";
        }
        setDataResponse($returnArr);
    }
    public function updateUserSubscription($iUserSubscriptionPlanId,$iUserId,$balance,$walletId = 0,$paymentId = 0){
        global $obj, $COMM_MEDIA_OBJ, $LANG_OBJ;
        $tblDetails = 'user_subscription_details';
        $tblPlan = 'user_subscription_plan';
        $userlangcode = get_value('register_user', 'vLang', 'iUserId', $iUserId, '', 'true');
        $selPlan = "SELECT CASE WHEN ePlanValidity = 'Daily' THEN 'Days' WHEN ePlanValidity = 'Weekly' THEN 'Weeks' WHEN ePlanValidity = 'Monthly' THEN 'Months' ELSE 'Days' END AS PlanTypeTitle,vPlanPeriod,vPlanName_$userlangcode as vPlanName,ePlanValidity,vPlanDescription_$userlangcode as vPlanDescription FROM $tblPlan WHERE iUserSubscriptionPlanId = $iUserSubscriptionPlanId";
        $dbPlans = $obj->MySQLSelect($selPlan);
        $vPlanPeriod = 1;
        $PlanTypeTitle = "Days";
        if(scount($dbPlans)> 0){
            $vPlanPeriod = $dbPlans[0]['vPlanPeriod'];
            $PlanTypeTitle = $dbPlans[0]['PlanTypeTitle'];
        }
        $expire = strtotime(date("Y-m-d H:i:s"). ' + '.$vPlanPeriod.' '.$PlanTypeTitle);
        $tExpiryDate = date("Y-m-d H:i:s",$expire);
        $exDate = date("Y-m-d",strtotime($tExpiryDate));
        if($exDate == "1970-01-01"){
            $tExpiryDate = date("Y-m-d H:i:s",$expire);
        }
        $selSubDetails = "SELECT(DATEDIFF(tExpiryDate,CURDATE()))as days,iUserSubscriptionDetailsId FROM $tblDetails WHERE iUserId = $iUserId AND eSubscriptionStatus = 'Subscribed'";
        $dbSubDetails = $obj->MySQLSelect($selSubDetails);
        if(!empty($dbSubDetails[0]['days'])){
            $data_status_inactive['eSubscriptionStatus'] = 'Inactive';
            $data_status_inactive['tClosedDate'] = date("Y-m-d H:i:s");
            $where = "iUserSubscriptionDetailsId = '".$dbSubDetails[0]['iUserSubscriptionDetailsId']."'";
            $obj->MySQLQueryPerform($tblDetails, $data_status_inactive, 'update', $where);
            $expire = strtotime($tExpiryDate. ' + '.$dbSubDetails[0]['days'].' Days');
            $tExpiryDate = date("Y-m-d H:i:s",$expire);
        }
        else {
            $selSubDetailsCancel = "SELECT(DATEDIFF(tExpiryDate,CURDATE()))as days,iUserSubscriptionDetailsId FROM $tblDetails WHERE iUserId = $iUserId AND eSubscriptionStatus = 'Cancelled' order by iUserSubscriptionDetailsId DESC limit 1";
            $dbSubDetailsCancel = $obj->MySQLSelect($selSubDetailsCancel);
            if(!empty($dbSubDetailsCancel[0]['days'])){
                $expire = strtotime($tExpiryDate. ' + '.$dbSubDetailsCancel[0]['days'].' Days');
                $tExpiryDate = date("Y-m-d H:i:s",$expire);
            }
        }
        $selDetails = "SELECT count(*)as cntrec FROM $tblDetails WHERE iUserId = $iUserId AND eSubscriptionStatus = 'Unsubscribed'";
        $dbDetails = $obj->MySQLSelect($selDetails);
        $data_currency_ratio['iUserId'] = $iUserId;
        $data_currency_ratio['iUserSubscriptionPlanId'] = $iUserSubscriptionPlanId;
        $data_currency_ratio['vPlanName'] = $dbPlans[0]['vPlanName'];
        $data_currency_ratio['vPlanPeriod'] = $dbPlans[0]['vPlanPeriod'];
        $data_currency_ratio['ePlanValidity'] = $dbPlans[0]['ePlanValidity'];
        $data_currency_ratio['vPlanDescription'] = $dbPlans[0]['vPlanDescription'];
        $data_currency_ratio['tSubscribeDate'] = date("Y-m-d H:i:s");
        $data_currency_ratio['tExpiryDate'] = $tExpiryDate;
        $data_currency_ratio['tClosedDate'] = $tExpiryDate;
        $data_currency_ratio['eSubscriptionStatus'] = 'Subscribed';
        $data_currency_ratio['iWalletId'] = $walletId;
        $data_currency_ratio['iPaymentId'] = $paymentId;
        $data_currency_ratio['fPrice'] = $balance;
        if($dbDetails[0]['cntrec']<=0){
            $iUserSubscriptionDetailsId = $obj->MySQLQueryPerform($tblDetails, $data_currency_ratio, 'insert');
        }
        else {
            $where = " iUserId = '" . $iUserId . "' AND eSubscriptionStatus = 'Unsubscribed' AND iUserSubscriptionPlanId = '".$iUserSubscriptionPlanId."'";
            $iUserSubscriptionDetailsId = $obj->MySQLQueryPerform($tblDetails, $data_currency_ratio, 'update',$where);
        }
        if($iUserSubscriptionDetailsId>0){
            $sql = "SELECT * FROM currency WHERE eStatus = 'Active'";
            $db_curr = $obj->MySQLSelect($sql);
            $where = " iUserSubscriptionDetailsId = '" . $iUserSubscriptionDetailsId . "'";
            for($i = 0;
            $i < scount($db_curr);
            $i++){
                $data_currency_ratio['fRatio_' . $db_curr[$i]['vName']] = $db_curr[$i]['Ratio'];
                $obj->MySQLQueryPerform($tblDetails, $data_currency_ratio, 'update', $where);
            }
            $currencycode = get_value('register_user', 'vCurrencyPassenger', 'iUserId', $iUserId, '', 'true');
            $userDetails = get_value('currency', 'Ratio,vSymbol', 'vName', $currencycode);
            $userCurrencyRatio = $userDetails[0]['Ratio'];
            $userCurrencySymbol = $userDetails[0]['vSymbol'];
            $userCurrencyRatio = get_value('currency', 'Ratio', 'vName', $currencycode, '', 'true');
            $balance_new = $balance * $userCurrencyRatio;
            $curbalance = formateNumAsPerCurrency($balance_new,$currencycode);
            $balance_new = round($balance_new,2);
            $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($userlangcode, "1");
            $planTxt = $languageLabelsArr['LBL_SUBSCRIPTION_PLAN_NAME'].': '.$dbPlans[0]['vPlanName']."<br>".$languageLabelsArr['LBL_SUBSCRIPTION_PLAN_PRICE'].': '.$curbalance."<br>".$languageLabelsArr['LBL_USER_SUBSCRIBE_DATE'].": ".date("Y-m-d");
            $userData = get_value('register_user', 'vEmail,vName,vLastName', 'iUserId', $iUserId);
            $getMaildata = array();
            $getMaildata['vEmail'] = $userData[0]['vEmail'];
            $getMaildata['planName'] = $planTxt;
            $getMaildata['FromName'] = $userData[0]['vName'].' '.$userData[0]['vLastName'];
            $getMaildata['EMAIL_NAME'] = $userData[0]['vName'].' '.$userData[0]['vLastName'];
            $mail = $COMM_MEDIA_OBJ->SendMailToMember('DRIVER_SUBSCRIPTION_SUCCESS',$getMaildata);
        }
        return true;
    }
    public function checkUserSubscribed($iUserId){
        global $obj;
        $tblDetails = 'user_subscription_details';
        $getField = "d.eSubscriptionStatus, p.vPlanName, p.vPlanDescription,p.vPlanPeriod,p.ePlanValidity,p.fPrice";
        $curdate = date("Y-m-d H:i:s");
        $dataExpired = $obj->MySQLSelect("SELECT iUserSubscriptionDetailsId,iUserId,tExpiryDate >= '$curdate' AS tExpiryDate, datediff(tExpiryDate,'$curdate')AS daysRemain,eSubscriptionStatus FROM $tblDetails WHERE iUserId = $iUserId");
        foreach($dataExpired as $key=>$value){
            if($value['tExpiryDate']<=0 && $value['eSubscriptionStatus']!='Expired'){
                $where = "iUserSubscriptionDetailsId = '".$value['iUserSubscriptionDetailsId']."'";
                $DataUpdate['eSubscriptionStatus'] = 'Expired';
                $id = $obj->MySQLQueryPerform($tblDetails,$DataUpdate,'update',$where);
            }
        }
        $getUserSubscription = $obj->MySQLSelect("SELECT count(iUserSubscriptionPlanId)as cnt FROM $tblDetails WHERE iUserId = $iUserId AND(eSubscriptionStatus = 'Subscribed' or(eSubscriptionStatus = 'Cancelled' AND tExpiryDate>= '$curdate'))");
        if($getUserSubscription[0]['cnt'] == 0){
            return 1;
        }
        return 0;
    }
}
class TrackService {
    function __construct(){
    }
    public function getCategories($tCategoryDetails = array()){
        global $languageLabelsArrTrackService, $tconfig, $obj, $master_service_category_tbl;
        if(empty($tCategoryDetails)){
            $service_details = $obj->MySQLSelect("SELECT tCategoryDetails FROM $master_service_category_tbl WHERE eType = 'TrackService' ");
            $tCategoryDetails = json_decode($service_details[0]['tCategoryDetails'], true);
        }
        $vImageTrackService = "";
        if(!empty($tCategoryDetails['TrackService']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackService']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackService']['vImage']);
            $vImageWidthTrackService = strval($imagedata[0]);
            $vImageHeightTrackService = strval($imagedata[1]);
            $vImageTrackService = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['TrackService']['vImage'];
        }
        $vImageTrackServiceAdd = "";
        if(!empty($tCategoryDetails['TrackServiceAdd']['vImage'])&& file_exists($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackServiceAdd']['vImage'])){
            $imagedata = getimagesize($tconfig["tsite_upload_app_home_screen_images_path"] . $tCategoryDetails['TrackServiceAdd']['vImage']);
            $vImageWidthTrackServiceAdd = strval($imagedata[0]);
            $vImageHeightTrackServiceAdd = strval($imagedata[1]);
            $vImageTrackServiceAdd = $tconfig["tsite_upload_app_home_screen_images"] . $tCategoryDetails['TrackServiceAdd']['vImage'];
        }
        $category_arr = array(array('vCategory' => $languageLabelsArrTrackService['LBL_TRACK_SERVICE_TRACK_MEMBER_TXT'], 'vImage' => $vImageTrackService, 'vListLogo' => $vImageTrackService, 'vImageWidth' => $vImageWidthTrackService, 'vImageHeight' => $vImageHeightTrackService, 'eCatType' => 'TrackService'), array('vCategory' => $languageLabelsArrTrackService['LBL_TRACK_SERVICE_SETUP_PROFILE_TXT'], 'vImage' => $vImageTrackServiceAdd, 'vListLogo' => $vImageTrackServiceAdd, 'vImageWidth' => $vImageWidthTrackServiceAdd, 'vImageHeight' => $vImageHeightTrackServiceAdd, 'eCatType' => 'TrackServiceAdd'));
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "getServiceCategoriesPro"){
            $tracking_users = $this->listTrackingUsers();
            if(!empty($tracking_users['message'])&& scount($tracking_users['message'])> 0){
                $category_arr = array(array('vCategory' => $languageLabelsArrTrackService['LBL_TRACK_SERVICE_TRACK_MEMBER_TXT'], 'vImage' => $vImageTrackService, 'vListLogo' => $vImageTrackService, 'vImageWidth' => $vImageWidthTrackService, 'vImageHeight' => $vImageHeightTrackService, 'eCatType' => 'TrackService'));
            }
            else {
                $category_arr = array(array('vCategory' => $languageLabelsArrTrackService['LBL_TRACK_SERVICE_SETUP_PROFILE_TXT'], 'vImage' => $vImageTrackServiceAdd, 'vListLogo' => $vImageTrackServiceAdd, 'vImageWidth' => $vImageWidthTrackServiceAdd, 'vImageHeight' => $vImageHeightTrackServiceAdd, 'eCatType' => 'TrackServiceAdd'));
            }
        }
        return $category_arr;
    }
    public function verifyInviteCode(){
        global $obj;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $vInviteCode = isset($_REQUEST["vInviteCode"])? $_REQUEST["vInviteCode"] : '';
        $vPhoneCode = isset($_REQUEST["vPhoneCode"])? $_REQUEST["vPhoneCode"] : '';
        $vPhone = isset($_REQUEST["MobileNo"])? $_REQUEST["MobileNo"] : '';
        $tracking_vehicle = $obj->MySQLSelect("SELECT * FROM track_service_users WHERE vInviteCode = '" . $vInviteCode . "' ");
        if($tracking_vehicle[0]['iUserId'] == $iMemberId){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRACK_SERVICE_INVITE_CODE_IN_USED";
            setDataResponse($returnArr);
        }
        if(!empty($tracking_vehicle)&& scount($tracking_vehicle)> 0){
            if($tracking_vehicle[0]['vPhoneCode'] == $vPhoneCode && $tracking_vehicle[0]['vPhone'] == $vPhone){
                $returnArr['Action'] = "1";
                $obj->sql_query("UPDATE track_service_users SET iUserId = '" . $iMemberId . "' WHERE iTrackServiceUserId = '" . $tracking_vehicle[0]['iTrackServiceUserId'] . "' ");
            }
            else {
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_INVALID_PHONE_NUMBER";
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRACK_SERVICE_INVITE_CODE_INVALID";
        }
        setDataResponse($returnArr);
    }
    public function initiateTrackingTrip(){
        global $obj;
        $iDriverId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $TripType = isset($_REQUEST["TripType"])? $_REQUEST["TripType"] : '';
        $tStartLat = isset($_REQUEST["tStartLat"])? $_REQUEST["tStartLat"] : '';
        $tStartLong = isset($_REQUEST["tStartLong"])? $_REQUEST["tStartLong"] : '';
        $driverData = $obj->MySQLSelect("SELECT iDriverVehicleId , iTrackServiceCompanyId FROM register_driver WHERE iDriverId = '" . $iDriverId . "'");
        $tStartLocation = getLocationNameLatLog($tStartLat, $tStartLong);
        $track_service_users = $this->getDriverConnectedUsers($iDriverId);
        if(empty($track_service_users)){
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRACK_SERVICE_START_TRIP_VALIDATION_MSG";
            setDataResponse($returnArr);
        }
        $iUserIdsArr = array_column($track_service_users, 'iTrackServiceUserId');
        $iUserIds = implode(",", $iUserIdsArr);
        $Data_trip = array();
        $Data_trip['iDriverId'] = $iDriverId;
        $Data_trip['iUserIds'] = $iUserIds;
        $Data_trip['eTripType'] = $TripType;
        $Data_trip['eTripStatus'] = strtoupper($TripType)== "PICKUP" ? "Active" : "Onboarding";
        $Data_trip['tStartLocation'] = $tStartLocation;
        $Data_trip['tStartLat'] = $tStartLat;
        $Data_trip['tStartLong'] = $tStartLong;
        $Data_trip['dAddedDate'] = date('Y-m-d H:i:s');
        $Data_trip['iDriverVehicleId'] = $driverData[0]['iDriverVehicleId'];
        $Data_trip['iTrackServiceCompanyId'] = $driverData[0]['iTrackServiceCompanyId'];
        $iTrackServiceTripId = $obj->MySQLQueryPerform("track_service_trips", $Data_trip, "insert");
        $obj->sql_query("UPDATE register_driver SET iTrackServiceTripId = '" . $iTrackServiceTripId . "' WHERE iDriverId = '" . $iDriverId . "'");
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = getDriverDetailInfo($iDriverId);
        setDataResponse($returnArr);
    }
    public function getDriverConnectedUsers($iDriverId){
        global $obj;
        $track_service_users = $obj->MySQLSelect("SELECT iTrackServiceUserId, CONCAT(vName, ' ', vLastName)as userName, vLatitude, vLongitude, vAddress FROM track_service_users WHERE iUserId > 0 AND iDriverId = '" . $iDriverId . "' AND eStatus = 'Active' ");
        return $track_service_users;
    }
    public function updateTrackingTripStatus(){
        global $obj, $DRIVER_START_DISTANCE_FROM_START_END_LOCATION, $EVENT_MSG_OBJ, $LANG_OBJ, $iServiceId;
        $iTrackServiceTripId = isset($_REQUEST["iTrackServiceTripId"])? $_REQUEST["iTrackServiceTripId"] : '';
        $tEndLat = isset($_REQUEST["tEndLat"])? $_REQUEST["tEndLat"] : '';
        $tEndLong = isset($_REQUEST["tEndLong"])? $_REQUEST["tEndLong"] : '';
        $tCancelReason = isset($_REQUEST["tCancelReason"])? $_REQUEST["tCancelReason"] : '';
        $TripStatus = isset($_REQUEST["TripStatus"])? $_REQUEST["TripStatus"] : '';
        $Data_trip_update = array();
        $track_service_trip = $obj->MySQLSelect("SELECT eTripType, eTripStatus, iDriverId, iUserIds FROM track_service_trips WHERE iTrackServiceTripId = '" . $iTrackServiceTripId . "'");
        $driverData = $obj->MySQLSelect("SELECT tsc.vLatitude, tsc.vLongitude, dv.vLicencePlate FROM register_driver as rd LEFT JOIN track_service_company as tsc ON tsc.iTrackServiceCompanyId = rd.iTrackServiceCompanyId LEFT JOIN driver_vehicle as dv ON dv.iDriverVehicleId = rd.iDriverVehicleId WHERE rd.iDriverId = '" . $track_service_trip[0]['iDriverId'] . "'");
        $compLat = $driverData[0]['vLatitude'];
        $compLong = $driverData[0]['vLongitude'];
        $vLicencePlateNo = $driverData[0]['vLicencePlate'];
        if(!empty($TripStatus)&& strtoupper($TripStatus)== "CANCELLED"){
            $eTripStatus = "Cancelled";
        }
        else {
            $eTripStatus = $track_service_trip[0]['eTripStatus'];
        }
        $eTripType = $track_service_trip[0]['eTripType'];
        $sendNotification = "No";
        $CLOSED = 0;
        if(strtoupper($eTripStatus)== "ONBOARDING"){
            $NextTripStatus = "Active";
            $Data_trip_update['dOnboardingDate'] = date('Y-m-d H:i:s');
            $sendNotification = "Yes";
            $noti_label = "LBL_TRACK_SERVICE_ONBOARDING_NOTI_MSG";
        }
        elseif(strtoupper($eTripStatus)== "ACTIVE"){
            $driverdistance = distanceByLocation($tEndLat, $tEndLong, $compLat, $compLong, "K");
            $driverdistance = $driverdistance * 1000;
            if($driverdistance > $DRIVER_START_DISTANCE_FROM_START_END_LOCATION){
            }
            $NextTripStatus = "OnGoingTrip";
            $Data_trip_update['dStartDate'] = date('Y-m-d H:i:s');
            $sendNotification = "Yes";
            if($eTripType == "Pickup"){
                $noti_label = "LBL_TRACK_SERVICE_PICKUP_START_NOTI_MSG";
            }
            else {
                $noti_label = "LBL_TRACK_SERVICE_DROPOFF_START_NOTI_MSG";
            }
        }
        elseif(strtoupper($eTripStatus)== "ONGOINGTRIP"){
            $driverdistance = distanceByLocation($tEndLat, $tEndLong, $compLat, $compLong, "K");
            $driverdistance = $driverdistance * 1000;
            if($driverdistance > $DRIVER_START_DISTANCE_FROM_START_END_LOCATION){
            }
            $NextTripStatus = "Finished";
            $tEndLocation = getLocationNameLatLog($tEndLat, $tEndLong);
            $Data_trip_update['tEndLocation'] = $tEndLocation;
            $Data_trip_update['tEndLat'] = $tEndLat;
            $Data_trip_update['tEndLong'] = $tEndLong;
            $Data_trip_update['dEndDate'] = date('Y-m-d H:i:s');
            if($eTripType == "Pickup"){
                $sendNotification = "Yes";
                $noti_label = "LBL_TRACK_SERVICE_PICKUP_END_NOTI_MSG";
                $CLOSED = 1;
            }
            else {
                $sendNotification = "Yes";
                $noti_label = "LBL_TRACK_SERVICE_DROPOFF_END_NOTI_MSG";
                $CLOSED = 1;
            }
        }
        elseif(strtoupper($eTripStatus)== "CANCELLED"){
            $NextTripStatus = "Cancelled";
            $Data_trip_update['dEndDate'] = date('Y-m-d H:i:s');
            $Data_trip_update['tCancelReason'] = $tCancelReason;
            $sendNotification = "Yes";
            $noti_label = "LBL_TRACK_SERVICE_TRIP_CANCELLED_NOTI_MSG";
            $CLOSED = 1;
        }
        $Data_trip_update['eTripStatus'] = $NextTripStatus;
        $where = " iTrackServiceTripId = '" . $iTrackServiceTripId . "' ";
        $obj->MySQLQueryPerform("track_service_trips", $Data_trip_update, "update", $where);
        if($sendNotification == "Yes"){
            $companyUsers = $obj->MySQLSelect("SELECT CONCAT(tsu.vName, ' ', tsu.vLastName)as childName, tsu.iUserId, ru.eDeviceType, ru.iGcmRegId, ru.eAppTerminate, ru.eDebugMode, ru.eHmsDevice, ru.vLang, ru.tSessionId FROM track_service_users as tsu LEFT JOIN register_user as ru ON ru.iUserId = tsu.iUserId WHERE tsu.iTrackServiceUserId IN(" . $track_service_trip[0]['iUserIds'] . ")AND tsu.iUserId > 0");
            $vMsgCode = strval(time());
            $generalDataArr = array();
            foreach($companyUsers as $user){
                $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($user['vLang'], "1", $iServiceId);
                $alertMsg = str_replace(['#VEHICEL_PLATENO#', '#CHILD_NAME#'], [$vLicencePlateNo, $user['childName']], $languageLabelsArr[$noti_label]);
                $message_arr = array();
                $message_arr['vMsgCode'] = $vMsgCode;
                $message_arr['vTitle'] = $alertMsg;
                $message_arr['MsgType'] = "TrackMember";
                $message_arr['iDriverId'] = $track_service_trip[0]['iDriverId'];
                $message_arr['CLOSED'] = $CLOSED;
                $generalDataArr[] = array('eDeviceType' => $user['eDeviceType'], 'deviceToken' => $user['iGcmRegId'], 'eAppTerminate' => $user['eAppTerminate'], 'eDebugMode' => $user['eDebugMode'], 'eHmsDevice' => $user['eHmsDevice'], 'tSessionId' => $user['tSessionId'], 'alertMsg' => $alertMsg, 'message' => $message_arr, 'channelName' => "PASSENGER_" . $user['iUserId']);
            }
            $EVENT_MSG_OBJ->send(array('GENERAL_DATA' => $generalDataArr), RN_USER);
        }
        $returnArr['Action'] = "1";
        $returnArr['USER_DATA'] = getDriverDetailInfo($track_service_trip[0]['iDriverId']);
        setDataResponse($returnArr);
    }
    public function fetchTrackingTripStatus($iTrackServiceTripId){
        global $obj;
        $TripDetails = "";
        if($iTrackServiceTripId > 0){
            $track_service_trip = $obj->MySQLSelect("SELECT tst.iDriverId, tst.eTripType, tst.eTripStatus, tst.tStartLocation, tst.tEndLocation, CONCAT(rd.vName, ' ', rd.vLastName)as driverName, tsc.vCompany, CONCAT('+', tsc.vCode, tsc.vPhone)as orgPhone, tsc.vLatitude, tsc.vLongitude FROM track_service_trips as tst LEFT JOIN register_driver as rd ON rd.iDriverId = tst.iDriverId LEFT JOIN track_service_company as tsc ON tsc.iTrackServiceCompanyId = rd.iTrackServiceCompanyId WHERE tst.iTrackServiceTripId = '" . $iTrackServiceTripId . "' AND tst.eTripStatus NOT IN('Finished', 'Cancelled')");
            if(!empty($track_service_trip)&& scount($track_service_trip)> 0){
                $track_service_users = $this->getDriverConnectedUsers($track_service_trip[0]['iDriverId']);
                $TripDetails = array();
                $TripDetails['TripType'] = $track_service_trip[0]['eTripType'];
                $TripDetails['TripStatus'] = $track_service_trip[0]['eTripStatus'];
                $TripDetails['tStartAddress'] = $track_service_trip[0]['tStartLocation'];
                $TripDetails['tEndAddress'] = $track_service_trip[0]['tEndLocation'];
                $TripDetails['TripType'] = $track_service_trip[0]['eTripType'];
                $TripDetails['iTrackServiceTripId'] = $iTrackServiceTripId;
                $TripDetails['driverName'] = $track_service_trip[0]['driverName'];
                $TripDetails['orgName'] = $track_service_trip[0]['vCompany'];
                $TripDetails['orgPhone'] = $track_service_trip[0]['orgPhone'];
                $TripDetails['orgLatitude'] = $track_service_trip[0]['vLatitude'];
                $TripDetails['orgLongitude'] = $track_service_trip[0]['vLongitude'];
                $TripDetails['userList'] = $track_service_users;
            }
        }
        return $TripDetails;
    }
    public function getTrackingTripsDriver(){
        global $obj, $LANG_OBJ, $iServiceId, $setupInfoDataArr;
        $iDriverId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $vLang = isset($_REQUEST["vGeneralLang"])? $_REQUEST["vGeneralLang"] : '';
        $page = isset($_REQUEST['page'])? trim($_REQUEST['page']): 1;
        $vFromDate = isset($_REQUEST["vFromDate"])? $_REQUEST["vFromDate"] : "";
        $vTimeZone = isset($_REQUEST["vTimeZone"])? $_REQUEST["vTimeZone"] : "";
        $systemTimeZone = date_default_timezone_get();
        if(!empty($vTimeZone)){
            $vConvertFromDate = converToTz($vFromDate, $vTimeZone, $systemTimeZone, "Y-m-d");
        }
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $track_service_trips = $obj->MySQLSelect("SELECT tst.*, dv.vLicencePlate, ma.vMake, mo.vTitle FROM track_service_trips as tst LEFT JOIN driver_vehicle as dv ON dv.iDriverVehicleId = tst.iDriverVehicleId LEFT JOIN make as ma ON ma.iMakeId = dv.iMakeId LEFT JOIN model as mo ON mo.iModelId = dv.iModelId WHERE tst.iDriverId = '$iDriverId' AND DATE(tst.dAddedDate)= '" . $vFromDate . "' AND tst.eTripStatus IN('Finished', 'Cancelled')ORDER BY tst.dAddedDate DESC");
        if(!empty($track_service_trips)&& scount($track_service_trips)> 0){
            $tripsArr = array();
            foreach($track_service_trips as $k => $trip){
                $tripsArr[$k]['TripType'] = $trip['eTripType'];
                $tripsArr[$k]['tStartAddress'] = $trip['tStartLocation'];
                $tripsArr[$k]['tStartLat'] = $trip['tStartLat'];
                $tripsArr[$k]['tStartLong'] = $trip['tStartLong'];
                $tripsArr[$k]['tEndAddress'] = $trip['tEndLocation'];
                $tripsArr[$k]['tEndLat'] = $trip['tEndLat'];
                $tripsArr[$k]['tEndLong'] = $trip['tEndLong'];
                $tripsArr[$k]['vMake'] = $trip['vMake'];
                $tripsArr[$k]['vModel'] = $trip['vTitle'];
                $tripsArr[$k]['vLicencePlateNo'] = $trip['vLicencePlate'];
                $tripsArr[$k]['dAddedDate'] = $trip['dAddedDate'];
                if($trip['eTripStatus'] == "Finished"){
                    $tripsArr[$k]['TripStatus'] = $languageLabelsArr['LBL_TRACK_SERVICE_FINISHED_STATUS'];
                }
                else {
                    $tripsArr[$k]['TripStatus'] = $languageLabelsArr['LBL_TRACK_SERVICE_CANCELLED_STATUS'];
                }
            }
            $total = scount($tripsArr);
            $per_page = 10;
            $totalPages = ceil($total / $per_page);
            $start_limit =($page - 1)* $per_page;
            $tripsArr = array_slice($tripsArr, $start_limit, $per_page);
            $returnArr['Action'] = "1";
            $returnArr['message'] = $tripsArr;
            if($totalPages > $page){
                $returnArr['NextPage'] =($page + 1);
            }
            else {
                $returnArr['NextPage'] = "0";
            }
        }
        else {
            $returnArr['Action'] = "0";
            $returnArr['message'] = "LBL_TRACK_SERVICE_NO_TRIPS_FOUND";
        }
        $dSetupDate = $setupInfoDataArr[0]['dSetupDate'];
        $yearFromDate = date('Y-m-d 00:00:00', strtotime($dSetupDate));
        $yearToDate = date('Y-m-d 23:59:59', strtotime($vConvertFromDate));
        $getAllTrips = $obj->MySQLSelect("SELECT dAddedDate FROM track_service_trips WHERE(dAddedDate BETWEEN '$yearFromDate' AND '$yearToDate')AND iDriverId = '$iDriverId' AND eTripStatus IN('Finished', 'Cancelled')");
        $getAllTripsArr = array();
        foreach($getAllTrips as $Trip){
            $getAllTripsArr[] = date('Y-m-d', strtotime($Trip['dAddedDate']));
        }
        $returnArr['EARNING_DATA'] = getEarningDates($getAllTripsArr);
        setDataResponse($returnArr);
    }
    public function uploadImageForTrackingUser(){
        global $obj, $tconfig, $UPLOAD_OBJ;
        $iUserId = isset($_REQUEST['GeneralMemberId'])? clean($_REQUEST['GeneralMemberId']): '';
        $iMemberId = isset($_REQUEST['iTrackServiceUserId'])? clean($_REQUEST['iTrackServiceUserId']): '';
        $image_name = $vImage = isset($_FILES['vImage']['name'])? $_FILES['vImage']['name'] : '';
        $image_object = isset($_FILES['vImage']['tmp_name'])? $_FILES['vImage']['tmp_name'] : '';
        $check_file_query = "SELECT iTrackServiceUserId, vImage from track_service_users where iTrackServiceUserId = " . $iMemberId;
        $check_file = $obj->sql_query($check_file_query);
        $img_path = $tconfig["tsite_upload_images_track_company_user_path"];
        if($image_name != ""){
            $check_file['vImage'] = $img_path . '/' . $iMemberId . '/' . $check_file[0]['vImage'];
            if($check_file['vImage'] != '' && file_exists($check_file['vImage'])){
                unlink($img_path . '/' . $iMemberId . '/' . $check_file[0]['vImage']);
                unlink($img_path . '/' . $iMemberId . '/1_' . $check_file[0]['vImage']);
                unlink($img_path . '/' . $iMemberId . '/2_' . $check_file[0]['vImage']);
                unlink($img_path . '/' . $iMemberId . '/3_' . $check_file[0]['vImage']);
            }
            $filecheck = basename($_FILES['vImage']['name']);
            $fileextarr = explode(".", $filecheck);
            $ext = strtolower($fileextarr[scount($fileextarr)- 1]);
            $flag_error = 0;
            if($ext != "jpg" && $ext != "gif" && $ext != "png" && $ext != "jpeg" && $ext != "bmp" && $ext != "heic"){
                $returnArr['Action'] = "0";
                $returnArr['message'] = "LBL_UPLOAD_IMG_ERROR";
                setDataResponse($returnArr);
            }
            $Photo_Gallery_folder = $img_path . '/' . $iMemberId . '/';
            if(!is_dir($Photo_Gallery_folder)){
                mkdir($Photo_Gallery_folder, 0777);
                chmod($Photo_Gallery_folder, 0777);
            }
            $img1 = $UPLOAD_OBJ->GeneralUploadImage($image_object, $image_name, $Photo_Gallery_folder, '', '', '', '', '', '', 'Y', '', $Photo_Gallery_folder);
            if($img1 != ''){
                if(is_file($Photo_Gallery_folder . $img1)){
                    include_once(TPATH_CLASS . "/SimpleImage.class.php");
                    $img = new SimpleImage();
                    list($width, $height, $type, $attr)= getimagesize($Photo_Gallery_folder . $img1);
                    if($width < $height){
                        $final_width = $width;
                    }
                    else {
                        $final_width = $height;
                    }
                    $img->load($Photo_Gallery_folder . $img1)->crop(0, 0, $final_width, $final_width)->save($Photo_Gallery_folder . $img1);
                    $img1 = $UPLOAD_OBJ->img_data_upload($Photo_Gallery_folder, $img1, $Photo_Gallery_folder, $tconfig["tsite_upload_images_member_size1"], $tconfig["tsite_upload_images_member_size2"], $tconfig["tsite_upload_images_member_size3"], "");
                }
            }
            $vImage = $img1;
        }
        else {
            $vImage = $check_file[0]['vImage'];
        }
        $obj->sql_query("UPDATE track_service_users SET vImage = '$vImage' WHERE iTrackServiceUserId = '$iMemberId' ");
        $returnArr['Action'] = "1";
        $returnArr['message'] = $this->listTrackingUsers($iMemberId);
        setDataResponse($returnArr);
    }
    public function listTrackingUsers($iTrackServiceUserId = 0){
        global $obj, $LANG_OBJ, $iServiceId, $tconfig;
        $iMemberId = isset($_REQUEST["GeneralMemberId"])? $_REQUEST["GeneralMemberId"] : '';
        $vLang = isset($_REQUEST["vGeneralLang"])? $_REQUEST["vGeneralLang"] : '';
        if(empty($vLang)){
            $vLang = $LANG_OBJ->FetchDefaultLangData("vCode");
        }
        $languageLabelsArr = $LANG_OBJ->FetchLanguageLabels($vLang, "1", $iServiceId);
        $returnArr['Action'] = "1";
        $ssql = "";
        if($iTrackServiceUserId > 0){
            $ssql = " AND iTrackServiceUserId = '$iTrackServiceUserId' ";
        }
        $tracking_users = $obj->MySQLSelect("SELECT tsu.iTrackServiceUserId, CONCAT(tsu.vName, ' ', tsu.vLastName)as userName, CONCAT('+', tsu.vPhoneCode, tsu.vPhone)as userPhone, tsu.vImage, tsu.vInviteCode, tsu.vLocation as userLocation, tsu.vAddress as userAddress, tsu.vLatitude as userLatitude, tsu.vLongitude as userLongitude, tsu.iDriverId, CONCAT(rd.vName, ' ', rd.vLastName)as driverName, CONCAT('+', rd.vCode, rd.vPhone)as driverPhone, rd.vLatitude as driverLatitude, rd.vLongitude as driverLongitude, dv.vLicencePlate as vLicencePlateNo, ma.vMake, mo.vTitle as vModel, tsc.vCompany, CONCAT('+', tsc.vCode, tsc.vPhone)as orgPhone, tsc.vLocation, tsc.vAddress, tsc.vLatitude as orgLatitude, tsc.vLongitude as orgLongitude FROM track_service_users as tsu LEFT JOIN register_driver as rd ON rd.iDriverId = tsu.iDriverId LEFT JOIN driver_vehicle as dv ON dv.iDriverVehicleId = rd.iDriverVehicleId LEFT JOIN make as ma ON ma.iMakeId = dv.iMakeId LEFT JOIN model as mo ON mo.iModelId = dv.iModelId LEFT JOIN track_service_company as tsc ON tsc.iTrackServiceCompanyId = tsu.iTrackServiceCompanyId WHERE tsu.iUserId = '$iMemberId' AND tsu.iDriverId > 0 AND tsu.eStatus = 'Active' $ssql ");
        if(!empty($tracking_users)&& scount($tracking_users)> 0){
            $userArr = array();
            foreach($tracking_users as $k => $user){
                $userArr[$k]['iTrackServiceUserId'] = $user['iTrackServiceUserId'];
                $userArr[$k]['userName'] = $user['userName'];
                $userArr[$k]['userPhone'] = $user['userPhone'];
                $userArr[$k]['userAddress'] = !empty($user['userAddress'])? $user['userAddress'] : $user['userLocation'];
                $userArr[$k]['userLatitude'] = $user['userLatitude'];
                $userArr[$k]['userLongitude'] = $user['userLongitude'];
                $userArr[$k]['vInviteCode'] = $user['vInviteCode'];
                $userArr[$k]['iDriverId'] = $user['iDriverId'];
                $userArr[$k]['driverName'] = $user['driverName'];
                $userArr[$k]['driverPhone'] = $user['driverPhone'];
                $userArr[$k]['driverLatitude'] = $user['driverLatitude'];
                $userArr[$k]['driverLongitude'] = $user['driverLongitude'];
                $userArr[$k]['orgName'] = $user['vCompany'];
                $userArr[$k]['orgPhone'] = $user['orgPhone'];
                $userArr[$k]['orgAddress'] = !empty($user['vAddress'])? $user['vAddress'] : $user['vLocation'];
                $userArr[$k]['orgLatitude'] = $user['orgLatitude'];
                $userArr[$k]['orgLongitude'] = $user['orgLongitude'];
                $userArr[$k]['vLicencePlateNo'] = $user['vLicencePlateNo'];
                $userArr[$k]['vMake'] = $user['vMake'];
                $userArr[$k]['vModel'] = $user['vModel'];
                $userArr[$k]['vImage'] = "";
                $userArr[$k]['userList'] = "";
                $image_path = $tconfig["tsite_upload_images_track_company_user_path"] . '/' . $user['iTrackServiceUserId'] . '/' . $user['vImage'];
                if(!empty($user['vImage'])&& file_exists($image_path)){
                    $userArr[$k]['vImage'] = $tconfig["tsite_upload_images_track_company_user"] . '/' . $user['iTrackServiceUserId'] . '/3_' . $user['vImage'];
                }
                $track_service_trip = $obj->MySQLSelect("SELECT iTrackServiceTripId, eTripStatus, eTripType FROM track_service_trips WHERE FIND_IN_SET(" . $user['iTrackServiceUserId'] . ", iUserIds)AND eTripStatus NOT IN('Finished', 'Cancelled')ORDER BY iTrackServiceTripId DESC LIMIT 1");
                $track_service_trip_last = $obj->MySQLSelect("SELECT iTrackServiceTripId, eTripStatus, eTripType FROM track_service_trips WHERE FIND_IN_SET(" . $user['iTrackServiceUserId'] . ", iUserIds)AND eTripStatus IN('Finished')ORDER BY iTrackServiceTripId DESC LIMIT 1");
                $userArr[$k]['TripStatus'] = "";
                $userArr[$k]['TripStatusDisplay'] = "";
                if(!empty($track_service_trip_last)&& scount($track_service_trip_last)> 0){
                    $userArr[$k]['TripStatus'] = "";
                    $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_NOT_ACTIVE_STATUS'];
                }
                if(!empty($track_service_trip)&& scount($track_service_trip)> 0){
                    $userArr[$k]['iTrackServiceTripId'] = $track_service_trip[0]['iTrackServiceTripId'];
                    $eTripStatus = $track_service_trip[0]['eTripStatus'];
                    $eTripType = $track_service_trip[0]['eTripType'];
                    if(strtoupper($eTripStatus)== "ONBOARDING"){
                        $userArr[$k]['TripStatus'] = "Onboarding";
                        $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_ONBOARDING_STATUS'];
                        if($eTripType == "Dropoff"){
                            $userArr[$k]['TripStatus'] = "";
                            $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_NOT_ACTIVE_STATUS'];
                        }
                    }
                    elseif(strtoupper($eTripStatus)== "ACTIVE"){
                        if($eTripType == "Pickup"){
                            $userArr[$k]['TripStatus'] = "";
                            $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_NOT_ACTIVE_STATUS'];
                        }
                        else {
                            $userArr[$k]['TripStatus'] = "Onboarding";
                            $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_ONBOARDING_STATUS'];
                        }
                    }
                    elseif(strtoupper($eTripStatus)== "ONGOINGTRIP"){
                        $userArr[$k]['TripStatus'] = "OnGoingTrip";
                        if($eTripType == "Pickup"){
                            $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_PICKUP_STATUS'];
                        }
                        else {
                            $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_DROPOFF_STATUS'];
                        }
                    }
                    else {
                        $userArr[$k]['TripStatus'] = "";
                        $userArr[$k]['TripStatusDisplay'] = $languageLabelsArr['LBL_TRACK_SERVICE_NOT_ACTIVE_STATUS'];
                    }
                    $track_service_users = $this->getDriverConnectedUsers($user['iDriverId']);
                    $userArr[$k]['userList'] = $track_service_users;
                }
            }
            if($iTrackServiceUserId > 0){
                return $userArr[0];
            }
            $returnArr['message'] = $userArr;
        }
        else {
            $returnArr['message'] = "";
        }
        if(isset($_REQUEST['type'])&& $_REQUEST['type'] == "getServiceCategoriesPro"){
            return $returnArr;
        }
        setDataResponse($returnArr);
    }
    public function GenerateInviteCode(){
        global $obj;
        $random = RandomString(10, 'Yes');
        $db_str = $obj->MySQLSelect("SELECT vInviteCode FROM track_service_users WHERE vInviteCode ='" . $random . "'");
        if(!empty($db_str)&& scount($db_str)> 0){
            $code = GenerateInviteCode();
        }
        else {
            $code = $random;
        }
        return $code;
    }
}
class VideoConsultation {
    function __construct(){
    }
    public function checkVideoConsultEnable($iVehicleCategoryId){
        global $obj;
        $sql_vehicle_category_table_name = getVehicleCategoryTblName();
        $vehicle_sub_category_arr = $obj->MySQLSelect("SELECT eVideoConsultEnable FROM $sql_vehicle_category_table_name WHERE iParentId = '$iVehicleCategoryId' AND eStatus = 'Active'");
        $isVideoConsultEnable = "No";
        if(!empty($vehicle_sub_category_arr)&& scount($vehicle_sub_category_arr)> 0){
            foreach($vehicle_sub_category_arr as $sub_category){
                if($sub_category['eVideoConsultEnable'] == "Yes"){
                    $isVideoConsultEnable = "Yes";
                    break;
                }
            }
        }
        return $isVideoConsultEnable;
    }
    public function updateVideoConsultService($Data){
        global $obj,$ENABLE_DRIVER_SERVICE_REQUEST_MODULE;
        $iDriverId = $Data['iDriverId'];
        $eStatus = $Data['eStatus'];
        $iVehicleCategoryId = $Data['iVehicleCategoryId'];
        $eVideoConsultServiceCharge = $Data['eVideoConsultServiceCharge'];
        $eVideoConsultEnableProvider = isset($Data['eVideoConsultEnableProvider'])? $Data['eVideoConsultEnableProvider'] : "No";
        $eVideoServiceDescription = $Data['eVideoServiceDescription'];
        $sqlServicePro = "SELECT * FROM `driver_services_video_consult_charges` WHERE iDriverId = '" . $iDriverId . "' AND iVehicleCategoryId='" . $iVehicleCategoryId . "'";
        $serviceProData = $obj->MySQLSelect($sqlServicePro);
        $Data_update = array();
        $Data_update["iDriverId"] = $iDriverId;
        $Data_update["iVehicleCategoryId"] = $iVehicleCategoryId;
        if(isset($Data['eVideoConsultServiceCharge'])){
            $Data_update["eVideoConsultServiceCharge"] = $eVideoConsultServiceCharge;
        }
        if(isset($Data['eVideoConsultEnableProvider'])){
            $Data_update["eVideoConsultEnableProvider"] = $eVideoConsultEnableProvider;
        }
        if(isset($Data['eVideoServiceDescription'])){
            $Data_update["eVideoServiceDescription"] = $eVideoServiceDescription;
        }
        if(scount($serviceProData)> 0){
            if($ENABLE_DRIVER_SERVICE_REQUEST_MODULE == 'Yes'){
                if($eVideoConsultEnableProvider == "Yes" && $serviceProData[0]['eApproved'] == "No"){
                    $Data_update['eStatus'] = 'Pending';
                }
            }
            else {
                $Data_update['eStatus'] = 'Active';
                $Data_update['eApproved'] = 'Yes';
            }
            $where = " iDriverServiceId = '" . $serviceProData[0]['iDriverServiceId'] . "'";
            $id = $obj->MySQLQueryPerform("driver_services_video_consult_charges", $Data_update, 'update', $where);
        }
        else {
            if($ENABLE_DRIVER_SERVICE_REQUEST_MODULE == 'Yes'){
                $Data_update['eStatus'] = "Inactive";
                if($eVideoConsultEnableProvider == "Yes"){
                    $Data_update['eStatus'] = 'Pending';
                }
            }
            else {
                $Data_update['eStatus'] = 'Active';
                $Data_update['eApproved'] = 'Yes';
            }
            $id = $obj->MySQLQueryPerform("driver_services_video_consult_charges", $Data_update, 'insert');
        }
        return $id;
    }
    public function getServiceDetails($iDriverId, $iVehicleCategoryId){
        global $obj;
        $returnArr = array();
        $returnArr['eVideoConsultServiceCharge'] = 0;
        $returnArr['eVideoConsultEnableProvider'] = "No";
        $returnArr['eVideoServiceDescription'] = "";
        $returnArr['eVideoConsultStatus'] = "Inactive";
        $vc_data = $obj->MySQLSelect("SELECT fCommissionVideoConsult FROM vehicle_category WHERE iVehicleCategoryId = '$iVehicleCategoryId'");
        $returnArr['fCommission'] = $vc_data[0]['fCommissionVideoConsult'];
        $service_data = $obj->MySQLSelect("SELECT eVideoConsultServiceCharge, eVideoConsultEnableProvider, eVideoServiceDescription, eStatus FROM driver_services_video_consult_charges WHERE iDriverId = '$iDriverId' AND iVehicleCategoryId = '$iVehicleCategoryId'");
        if(!empty($service_data)&& scount($service_data)> 0){
            $returnArr['eVideoConsultServiceCharge'] = $service_data[0]['eVideoConsultServiceCharge'];
            $returnArr['eVideoConsultEnableProvider'] = $service_data[0]['eVideoConsultEnableProvider'];
            $returnArr['eVideoServiceDescription'] = $service_data[0]['eVideoServiceDescription'];
            $returnArr['eVideoConsultStatus'] = $service_data[0]['eStatus'];
        }
        return $returnArr;
    }
}
class SystemInfo {
    private static $EXPIRY_DATE = '0000-00-00';
    private static $ALLOWED_INHOUSE_DOMAINS = array();
    private static $ALLOWED_CLIENT_DOMAINS = array("apiservice.buddyverse.africa","buddyverse.africa","dev.ridey.co","beta.ridey.co","www.buddyverse.africa","staging.ridey.co");
    function __construct(){
    }
    public static function _construct_($BASE_DOCUMENT_PATH){
        global $DOCUMENT_ROOT, $IS_INHOUSE_DOMAINS, $tconfig;
        ob_start();
        @session_start();
        @header('P3P:CP="IDC DSP COR ADM DEVi TAIi PSA PSD IVAi IVDi CONi HIS OUR IND CNT"');
        define('_TEXEC', 1);
        define('TPATH_BASE', $BASE_DOCUMENT_PATH);
        define('DS', DIRECTORY_SEPARATOR);
        $DOCUMENT_ROOT = $_SERVER['DOCUMENT_ROOT'];
        defined('_TEXEC')or die('Restricted access');
        define('TPATH_ROOT', TPATH_BASE);
        define('TPATH_CLASS', TPATH_ROOT.DS.'assets'.DS.'libraries/');
        if(!file_exists(TPATH_CLASS . "server_configurations_params.php")){
            echo '<div style="font-size: 24px">System is misconfigured. Please contact to the <strong>technical team</strong> to resolve.</div>';
            die();
        }
        if(empty(SystemInfo::$ALLOWED_INHOUSE_DOMAINS)){
            SystemInfo::configureSystemType();
        }
        if(file_exists(TPATH_CLASS . 'models/class.error_handler.php')){
            include_once(TPATH_CLASS . 'models/class.error_handler.php');
            ErrorHandlerCls::handler();
        }
        include_once(TPATH_CLASS . "system_global_functions.php");
        include_once(TPATH_CLASS."system_general_functions.php");
        require_once(TPATH_CLASS . "server_configurations_params.php");
        require_once(TPATH_CLASS . "server_configurations.php");
        require_once(TPATH_CLASS . "server_sc_configuration.php");
        require_once(TPATH_CLASS . "project_settings.php");
        SystemInfo::configureSystemType();
        extract(SystemInfo::declareCurrentScopeVariables(), EXTR_REFS | EXTR_OVERWRITE);
        if(!defined('SITE_TYPE')){
            define('SITE_TYPE','Live');
        }
        require_once(TPATH_CLASS . "module_configurations.php");
        require_once(TPATH_CLASS."db_info.php");
        SystemInfo::redefineVariables(get_defined_vars());
    }
    public static function redefineVariables($all_variables){
        foreach($all_variables as $var => $value){
            global $$var;
            $$var = $value;
        }
    }
    public static function declareCurrentScopeVariables(){
        $super_global_variables_arr = array('GLOBALS', '_ENV', 'HTTP_ENV_VARS', '_POST', 'HTTP_POST_VARS', '_GET', 'HTTP_GET_VARS', '_COOKIE', 'HTTP_COOKIE_VARS', '_SERVER', 'HTTP_SERVER_VARS', '_FILES', 'HTTP_POST_FILES', '_REQUEST', 'HTTP_SESSION_VARS', '_SESSION');
        $returnArr=array();
        foreach($GLOBALS as $var => $value){
            if(!in_array($var, $super_global_variables_arr)){
                $returnArr[$var] = $value;
            }
        }
        return $returnArr;
    }
    public static function Initiate($BASE_DOCUMENT_PATH){
        SystemInfo::_construct_($BASE_DOCUMENT_PATH);
        extract(SystemInfo::declareCurrentScopeVariables(), EXTR_REFS | EXTR_OVERWRITE);
        include_once(TPATH_CLASS.'models/class.configuration.settings.php');
        $tconfig = ConfigurationSettings::getTconfigVar();
        require_once(TPATH_CLASS . "class.cache.php");
        $oCache = new CacheMemcache();
        if(file_exists(TPATH_CLASS . 'include_models.php')){
            require_once(TPATH_CLASS . "include_models.php");
        }
        $THEME_OBJ = new SystemTheme;
        SystemInfo::redefineVariables(get_defined_vars());
        if(!isset($obj)){
            require_once(TPATH_CLASS."models/class.dbquery.php");
            $obj = new DBConnection(TSITE_SERVER, TSITE_DB, TSITE_USERNAME,TSITE_PASS);
        }
        require_once(TPATH_CLASS . 'cache_keys.php');
        SystemInfo::redefineVariables(get_defined_vars());
        $CONFIG_OBJ = new ConfigurationSettings;
        if(!isset($obj_security)){
            require_once(TPATH_CLASS."security_params.php");
            $obj_security = new CI_Security();
        }
        extract(SystemInfo::declareCurrentScopeVariables(), EXTR_REFS | EXTR_OVERWRITE);
        $exclude_webservice = array(WEBSERVICE_API_FILE_NAME);
        $inwebservice = 0;
        if(stripos_arr($_SERVER['REQUEST_URI'], $exclude_webservice)!== false){
            $inwebservice = 1;
        }
        SystemInfo::redefineVariables(get_defined_vars());
        $obj_security->xss_cleaner_all();
        $LANG_OBJ = new Language();
        $default_lang = $LANG_OBJ->FetchSystemDefaultLang();
        $def_lang_name = $LANG_OBJ->FetchSystemDefaultLangName();
        if(!isset($_SESSION['sess_lang'])|| $_SESSION['sess_lang']==""){
            $defaultLngDataArr = $LANG_OBJ->getDefaultLanguageData();
            $_SESSION['sess_lang']= $defaultLngDataArr['vSystemDefaultLangCode'];
            $_SESSION['eDirectionCode']= $defaultLngDataArr['vSystemDefaultLangDirection'];
        }
        $languageApcKey = md5($cacheKeysArr['language_master']);
        $getLanguageCacheData = $oCache->getData($languageApcKey);
        if(!empty($getLanguageCacheData)&& count($getLanguageCacheData)> 0){
            $Data_ALL_langArr = $getLanguageCacheData;
        }
        else {
            $Data_ALL_langArr = $obj->MySQLSelect("SELECT *, eDirectionCode as eType FROM language_master ORDER BY iDispOrder ASC");
            $setLanguageCacheData = $oCache->setData($languageApcKey, $Data_ALL_langArr);
        }
        $language_codes_arr =$active_language_codes_arr=$languageAssociateArr= array();
        foreach($Data_ALL_langArr as $language_item){
            if(strtoupper($language_item['eDefault'])== "YES"){
                $vSystemDefaultLangCode = $language_item['vCode'];
                $vSystemDefaultLangName = $language_item['vTitle'];
                $vSystemDefaultLangDirection = $language_item['eDirectionCode'];
                $vSystemDefaultLangvGMapLangCode = $language_item['vGMapLangCode'];
            }
            $language_codes_arr[] = $language_item['vCode'];
            $languageAssociateArr[$language_item['vCode']] = $language_item;
            if($language_item['eStatus'] == "Active"){
                $active_language_codes_arr[] = $language_item['vCode'];
            }
        }
        $vSystemDefaultLangCode = empty($vSystemDefaultLangCode)? "EN" : $vSystemDefaultLangCode;
        $vSystemDefaultLangName = empty($vSystemDefaultLangName)? "English" : $vSystemDefaultLangName;
        $vSystemDefaultLangDirection = empty($vSystemDefaultLangDirection)? "ltr" : $vSystemDefaultLangDirection;
        $vSystemDefaultLangvGMapLangCode = empty($vSystemDefaultLangvGMapLangCode)? "en" : $vSystemDefaultLangvGMapLangCode;
        $Data_langArr[0]['vCode'] = $vSystemDefaultLangCode;
        if(isset($_SESSION['sess_lang'])&& $_SESSION['sess_lang'] != "" && $inwebservice == 0){
            $langugaeCode = $_SESSION['sess_lang'];
        }
        if(empty($langugaeCode)){
            $langugaeCode = isset($_REQUEST["vLang"])?($_REQUEST["vLang"] == "" ? $Data_langArr[0]['vCode'] : $_REQUEST["vLang"]): $Data_langArr[0]['vCode'];
        }
        if(empty($langugaeCode)|| in_array_ci($langugaeCode, $active_language_codes_arr)== false){
            $langugaeCode = $vSystemDefaultLangCode;
        }
        $serviceCatApcKey = md5($cacheKeysArr['service_categories'].'_'. $langugaeCode);
        $getServiceCacheData = $oCache->getData($serviceCatApcKey);
        if(!empty($getServiceCacheData)&& count($getServiceCacheData)> 0){
            $ServiceData = $getServiceCacheData;
        }
        else {
            $service_ssql = "";
            if(!empty($enablesevicescategory)){
                $service_ssql = " AND iServiceId IN(" . $enablesevicescategory . ")";
            }
            $ServiceData = $obj->MySQLSelect("SELECT eType AS ispriceshow,iServiceId,vService,eStatus, vServiceName_" . $langugaeCode . " as vServiceName,vImage,if(tDescription != '',JSON_UNQUOTE(json_extract(`tDescription`, '$.tDescription_" . $langugaeCode . "')),'')AS tDescription FROM `service_categories` WHERE 1 = 1 $service_ssql AND eStatus!='Deleted' order by iDisplayOrder ASC");
            $setServiceCacheData = $oCache->setData($serviceCatApcKey, $ServiceData);
        }
        $serviceCategoriesTmp = $serviceCategoriesIdsArrTmp = array();
        $service_id_admin = -1;
        if(!empty($ServiceData)){
            foreach($ServiceData as $key => $value){
                if($value['eStatus'] == 'Active'){
                    if($value['vImage'] != ''){
                        $value['vImage'] = $tconfig["tsite_upload_service_categories_images"] . $value['vImage'];
                    }
                    $serviceCategoriesTmp[] = $value;
                    $serviceCategoriesIdsArrTmp[] = $value['iServiceId'];
                    if($service_id_admin == -1 && $value['iServiceId'] > 1){
                        $service_id_admin = $value['iServiceId'];
                    }
                }
            }
        }
        $iServiceId = isset($_REQUEST["iServiceId"])? $_REQUEST["iServiceId"] :(!empty($ServiceData)? $ServiceData[0]['iServiceId'] : "");
        if(empty($_REQUEST["iServiceId"])){
            $iServiceId = !empty($ServiceData)? $ServiceData[0]['iServiceId'] : "";
            $_REQUEST["iServiceId"] = $iServiceId;
        }
        if(empty($_REQUEST["iServiceId"])){
            $ServiceDataNew = $obj->MySQLSelect("SELECT iServiceId FROM `service_categories` WHERE iServiceId IN(" . $enablesevicescategory . ")");
            $iServiceId = $ServiceData[0]['iServiceId'] = !empty($ServiceDataNew)? $ServiceDataNew[0]['iServiceId'] : "";
            $_REQUEST["iServiceId"] = $iServiceId;
        }
        if(empty($iServiceId)){
            $iServiceId = $_REQUEST["iServiceId"] = "";
        }
        define('serviceCategories', json_encode($serviceCategoriesTmp));
        define('ServiceData', json_encode($ServiceData));
        $langage_lbl = array();
        if(isset($_SESSION['sess_user'])&& $_SESSION['sess_user'] == 'company'){
            $dbQueryData = $obj->MySQLSelect("SELECT iServiceId FROM company WHERE iCompanyId = '" . $_SESSION['sess_iUserId'] . "'");
            if(count($dbQueryData)> 0){
                $iServiceIdWeb = $dbQueryData[0]['iServiceId'];
            }
            else {
                $iServiceIdWeb = $ServiceData[0]['iServiceId'];
            }
        }
        else {
            $iServiceIdWeb = $ServiceData[0]['iServiceId'];
        }
        if($iServiceIdWeb != "0"){
            $langLabelApcKey = md5($cacheKeysArr['language_label_'] . $iServiceIdWeb."_".$langugaeCode);
            $getLabelCacheData = $oCache->getData($langLabelApcKey);
            if(!empty($getLabelCacheData)&& count($getLabelCacheData)> 0){
                $db_lbl = $getLabelCacheData;
            }
            else {
                $db_lbl = $obj->MySQLSelect("SELECT vLabel,vValue,LanguageLabelId FROM language_label_" . $iServiceIdWeb . " WHERE vCode='" . $langugaeCode . "'");
                $setLabelCacheData = $oCache->setData($langLabelApcKey, $db_lbl);
            }
            if(!empty($db_lbl)){
                foreach($db_lbl as $key => $value){
                    if(isset($_SESSION['sess_editingToken'])&& $_SESSION['sess_editingToken'] == $db_config[0]['vValue']){
                        $langage_lbl[$value['vLabel']] = "<em class='label-dynmic'><i class='fa fa-edit label-i' data-id='" . $value['LanguageLabelId'] . "' data-value='main'></i>" . $value['vValue'] . "</em>";
                    }
                    else {
                        $langage_lbl[$value['vLabel']] = $value['vValue'];
                    }
                }
            }
        }
        $LangLabelsApcKey = md5('language_label_union_other_' . $langugaeCode);
        $getLangLabelsCacheData = $oCache->getData($LangLabelsApcKey);
        if(!empty($getLangLabelsCacheData)&& count($getLangLabelsCacheData)> 0){
            $all_label_en = $getLangLabelsCacheData;
        }
        else {
            $sql_en = "SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = '".$langugaeCode."' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = '".$langugaeCode."'";
            $all_label_en = $obj->MySQLSelect($sql_en);
            $oCache->setData($LangLabelsApcKey, $all_label_en);
        }
        if(count($all_label_en)> 0){
            for($i = 0;
            $i < count($all_label_en);
            $i++){
                $vLabel_tmp = $all_label_en[$i]['vLabel'];
                $vValue_tmp = $all_label_en[$i]['vValue'];
                if(isset($langage_lbl[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $langage_lbl)){
                    if($langage_lbl[$vLabel_tmp] == ""){
                        $langage_lbl[$vLabel_tmp] = $vValue_tmp;
                    }
                }
                else {
                    $langage_lbl[$vLabel_tmp] = $vValue_tmp;
                }
            }
        }
        if(empty($langage_lbl)|| !empty($_SESSION['sess_iAdminUserId'])){
            $LangLabelsENApcKey = md5('language_label_union_other_EN');
            $getLangLabelsENCacheData = $oCache->getData($LangLabelsENApcKey);
            if(!empty($getLangLabelsENCacheData)&& count($getLangLabelsENCacheData)> 0){
                $all_label_en = $getLangLabelsENCacheData;
            }
            else {
                $all_label_en = $obj->MySQLSelect("SELECT `vLabel` , `vValue` FROM `language_label` WHERE `vCode` = 'EN' UNION SELECT `vLabel` , `vValue` FROM `language_label_other` WHERE `vCode` = 'EN'");
                $oCache->setData($LangLabelsENApcKey, $all_label_en);
            }
        }
        if(empty($langage_lbl)){
            $LabelsApcKey = md5($cacheKeysArr['language_label_' . $langugaeCode]);
            $getLabelsCacheData = $oCache->getData($LabelsApcKey);
            if(!empty($getLabelsCacheData)&& count($getLabelsCacheData)> 0){
                $db_lbl = $getLabelsCacheData;
            }
            else {
                $db_lbl = $obj->MySQLSelect("SELECT vLabel,vValue,LanguageLabelId FROM language_label WHERE vCode='" . $langugaeCode . "'");
                $oCache->setData($LabelsApcKey, $db_lbl);
            }
            foreach($db_lbl as $key => $value){
                if(isset($_SESSION['sess_editingToken'])&& $_SESSION['sess_editingToken'] == $db_config[0]['vValue']){
                    $langage_lbl[$value['vLabel']] = "<em class='label-dynmic'><i class='fa fa-edit label-i' data-id='" . $value['LanguageLabelId'] . "' data-value='other'></i>" . $value['vValue'] . "</em>";
                }
                else {
                    $langage_lbl[$value['vLabel']] = $value['vValue'];
                }
            }
            if(count($all_label_en)> 0){
                for($i = 0;
                $i < count($all_label_en);
                $i++){
                    $vLabel_tmp = $all_label_en[$i]['vLabel'];
                    $vValue_tmp = $all_label_en[$i]['vValue'];
                    if(isset($langage_lbl[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $langage_lbl)){
                        if($langage_lbl[$vLabel_tmp] == ""){
                            $langage_lbl[$vLabel_tmp] = $vValue_tmp;
                        }
                    }
                    else {
                        $langage_lbl[$vLabel_tmp] = $vValue_tmp;
                    }
                }
            }
        }
        $langage_lbl_admin = array();
        if(!empty($_SESSION['sess_iAdminUserId'])&& count($all_label_en)> 0){
            for($i = 0;
            $i < count($all_label_en);
            $i++){
                $vLabel_tmp = $all_label_en[$i]['vLabel'];
                $vValue_tmp = $all_label_en[$i]['vValue'];
                if(isset($langage_lbl_admin[$vLabel_tmp])|| array_key_exists($vLabel_tmp, $langage_lbl_admin)){
                    if($langage_lbl_admin[$vLabel_tmp] == ""){
                        $langage_lbl_admin[$vLabel_tmp] = $vValue_tmp;
                    }
                }
                else {
                    $langage_lbl_admin[$vLabel_tmp] = $vValue_tmp;
                }
            }
            if($ServiceData[0]['iServiceId'] > 0){
                if($service_id_admin != -1){
                    $iServiceIdWeb = $service_id_admin;
                }
                else {
                    $iServiceIdWeb = $ServiceData[0]['iServiceId'];
                }
                $db_lbl_admin = $obj->MySQLSelect("SELECT vLabel,vValue FROM language_label_" . $iServiceIdWeb . " WHERE vCode='EN'");
                foreach($db_lbl_admin as $key => $value){
                    $langage_lbl_admin[$value['vLabel']] = $value['vValue'];
                }
            }
        }
        else {
            $langage_lbl_admin = $langage_lbl;
        }
        $lang = isset($_REQUEST['lang'])?$_REQUEST['lang']:'';
        if(isset($lang)&& $lang != ''){
            $_SESSION['sess_lang'] = $lang;
            $sql1="select vTitle, vCode, vCurrencyCode, eDefault,eDirectionCode from language_master where vCode = '".$_SESSION['sess_lang']."' limit 0,1";
            $db_lng_mst1=$obj->MySQLSelect($sql1);
            $_SESSION['eDirectionCode'] = $db_lng_mst1[0]['eDirectionCode'];
            $posturi = $_SERVER['HTTP_REFERER'];
            if(isset($_REQUEST['HTTP_REFERER'])){
                $posturi = urldecode($_REQUEST['HTTP_REFERER']);
            }
            header("Location:".$posturi);
            die();
        }
        define('RIIDE_LATER','YES');
        define('PROMO_CODE','YES');
        require_once(TPATH_CLASS.'models/class.payment.gateways.php');
        require_once(TPATH_CLASS.'models/class.comm_media.php');
        require_once(TPATH_CLASS . "site_variables.php");
        require_once(TPATH_CLASS . "class.ExifCleaning.php");
        require_once(TPATH_CLASS . "Imagecrop.class.php");
        $MODULES_OBJ = new Modules;
        $AUTH_OBJ = new AuthLogin();
        $COMM_MEDIA_OBJ = new CommMedia();
        $REFERRAL_OBJ = new Referral();
        $WALLET_OBJ = new Wallet();
        $STATIC_PAGE_OBJ = new StaticPage();
        $UPLOAD_OBJ = new UploadFile();
        $THEME_OBJ->getTheme();
        $template = $THEME_OBJ->getTemplate();
        $templatePath = $THEME_OBJ->getTemplatePath();
        $logogpath = $THEME_OBJ->getLogoPath();
        if(!empty($GOOGLE_ANALYTICS)){
            $GOOGLE_ANALYTICS = "<!-- Global site tag(gtag.js)- Google Analytics --> <script async src='https://www.googletagmanager.com/gtag/js?id=$GOOGLE_ANALYTICS'></script> <script> window.dataLayer = window.dataLayer || [];
            function gtag(){
                dataLayer.push(arguments);
            }
            gtag('js', new Date());
            gtag('config', '$GOOGLE_ANALYTICS');
            </script>";
        }
        SystemInfo::redefineVariables(get_defined_vars());
        if(strpos($_SERVER['REQUEST_URI'], "/" . SITE_ADMIN_URL)!== false){
            include_once($tconfig['tpanel_path'] . "/" . SITE_ADMIN_URL . "/library/common_include.php");
            $userObj = new Admin\library\User();
            if(!in_array(basename($_SERVER['REQUEST_URI']), ['index.php','ajax_login_action.php', 'recaptcha.php'])){
                $userObj->isLogin(true);
            }
        }
        if($MAINTENANCE_WEBSITE == "Yes"){
            $exclude_maintenance = array("/" . SITE_ADMIN_URL, "safety_checklist.php", "system_payment.php", "payment_mode_select.php", "webview", WEBSERVICE_API_FILE_NAME, "updateSysServices", "network_data.php");
            if($MAINTENANCE_APPS == "No"){
                $exclude_maintenance[] = "user-order-information";
                $exclude_maintenance[] = "userbooking.php";
                $exclude_maintenance[] = "customer_info.php";
                $exclude_maintenance[] = "restaurant-listing";
                $exclude_maintenance[] = "restaurant_listing.php";
                $exclude_maintenance[] = "cx-restaurant_listing.php";
                $exclude_maintenance[] = "restaurant-items";
                $exclude_maintenance[] = "restaurant_menu.php";
                $exclude_maintenance[] = "restaurant-order";
                $exclude_maintenance[] = "restaurant_place-order.php";
            }
            if(stripos_arr($_SERVER['REQUEST_URI'], $exclude_maintenance)!== false){
            }
            else if(!isset($_REQUEST['maintanance'])){
                header("Location:" . $tconfig['tsite_url'] . "maintanance?maintanance=yes");
                die();
            }
        }
        else {
            if(isset($_REQUEST['maintanance'])){
                header("Location:" . $tconfig['tsite_url']);
                die();
            }
        }
        require_once($BASE_DOCUMENT_PATH . "/DataHelper.php");
        $dataHelperObj = new DataHelper();
        $_SESSION['sess_hosttype'] = 'ufxall';
        $IS_CONTINUE_DELETE_PROCESS = empty($IS_INHOUSE_DOMAINS)|| $IS_INHOUSE_DOMAINS == false ? true : false;
        include_once($tconfig["tpanel_path"]."include_config.php");
        $generalConfigPaymentArr = $CONFIG_OBJ->getGeneralVarAll_Payment_Array();
        if(empty($isUfxAvailable)){
            $isUfxAvailable = $MODULES_OBJ->isUfxFeatureAvailable();
        }
        include_once($tconfig["tpanel_path"] . "assets/libraries/include_advance_api.php");
        $type = isset($_REQUEST['type'])? trim($_REQUEST['type']): '';
        $currencyApcKey = md5($cacheKeysArr['currency']);
        $getCurrencyCacheData = $oCache->getData($currencyApcKey);
        if(!empty($getCurrencyCacheData)&& count($getCurrencyCacheData)> 0){
            $Data_ALL_currency_Arr = $getCurrencyCacheData;
        }
        else {
            $Data_ALL_currency_Arr = $obj->MySQLSelect("SELECT * FROM currency ORDER BY iDispOrder ASC");
            $setCurrencyCacheData = $oCache->setData($currencyApcKey, $Data_ALL_currency_Arr);
        }
        $active_currency_name_arr =$currency_arr=$currencyAssociateArr= array();
        foreach($Data_ALL_currency_Arr as $currency_item){
            if(strtoupper($currency_item['eDefault'])== "YES"){
                $vSystemDefaultCurrencyName = $currency_item['vName'];
                $vSystemDefaultCurrencySymbol = $currency_item['vSymbol'];
                $vSystemDefaultCurrencyRatio = $currency_item['Ratio'];
            }
            $currency_arr[] = $currency_item;
            $currencyAssociateArr[trim($currency_item['vName'])] = $currency_item;
            if($currency_item['eStatus'] == "Active"){
                $active_currency_name_arr[] = $currency_item['vName'];
            }
        }
        $vSystemDefaultCurrencyName = empty($vSystemDefaultCurrencyName)? "USD" : $vSystemDefaultCurrencyName;
        $vSystemDefaultCurrencySymbol = empty($vSystemDefaultCurrencySymbol)? "$" : $vSystemDefaultCurrencySymbol;
        $vSystemDefaultCurrencyRatio = empty($vSystemDefaultCurrencyRatio)? "1.00" : $vSystemDefaultCurrencyRatio;
        $countryApcKey = md5($cacheKeysArr['country']);
        $getCountryCacheData = $oCache->getData($countryApcKey);
        if(!empty($getCountryCacheData)&& count($getCountryCacheData)> 0){
            $country_data_retrieve = $getCountryCacheData;
        }
        else {
            $country_data_retrieve = $obj->MySQLSelect("SELECT * FROM country");
            $setCountryCacheData = $oCache->setData($countryApcKey, $country_data_retrieve);
        }
        $country_data_arr =$countryAssociateArr= array();
        foreach($country_data_retrieve as $country_data_retrieve_item){
            $country_data_arr[$country_data_retrieve_item['vCountryCode']] = $country_data_retrieve_item;
            $countryAssociateArr[$country_data_retrieve_item['iCountryId']] = $country_data_retrieve_item;
        }
        $VehicleCategoryApcKey = md5($cacheKeysArr['vehicle_category'] . '_ufx');
        $getVehicleCategoryCacheData = $oCache->getData($VehicleCategoryApcKey);
        if(!empty($getVehicleCategoryCacheData)&& count($getVehicleCategoryCacheData)> 0){
            $allUfxVehicleCategoryData = $getVehicleCategoryCacheData;
        }
        else {
            $allUfxVehicleCategoryData = $obj->MySQLSelect("SELECT * FROM `vehicle_category` WHERE 1=1 AND eCatType = 'ServiceProvider'");
            $oCache->setData($VehicleCategoryApcKey, $allUfxVehicleCategoryData);
        }
        $vehcleCategoryAssocArr = array();
        for($hj=0;
        $hj<count($allUfxVehicleCategoryData);
        $hj++){
            $vehcleCategoryAssocArr[$allUfxVehicleCategoryData[$hj]['iVehicleCategoryId']] = $allUfxVehicleCategoryData[$hj];
        }
        $MasterCategoryApcKey = md5($cacheKeysArr['master_vehicle_category']);
        $getMasterCategoryCacheData = $oCache->getData($MasterCategoryApcKey);
        if(!empty($getMasterCategoryCacheData)&& count($getMasterCategoryCacheData)> 0){
            $allUfxMasterCategory = $getMasterCategoryCacheData;
        }
        else {
            $allUfxMasterCategory = $obj->MySQLSelect("SELECT * FROM `master_vehicle_category` WHERE 1=1");
            $oCache->setData($MasterCategoryApcKey, $allUfxMasterCategory);
        }
        $masterVehcleCategoryAssocArr = array();
        for($jh=0;
        $jh<count($allUfxMasterCategory);
        $jh++){
            $masterVehcleCategoryAssocArr[$allUfxMasterCategory[$jh]['iMasterVehicleCategoryId']] = $allUfxMasterCategory[$jh];
        }
        require_once(TPATH_CLASS . 'models/class.dashboard.php');
        $DASHBOARD_OBJ = new Dashboard;
        require_once(TPATH_CLASS . "include_features.php");
        if(file_exists(TPATH_CLASS . "include_common.php")){
            require_once(TPATH_CLASS . "include_common.php");
        }
        SystemInfo::redefineVariables(get_defined_vars());
        return SystemInfo::declareCurrentScopeVariables();
    }
    public static function configureSystemType(){
        extract(SystemInfo::declareCurrentScopeVariables(), EXTR_REFS | EXTR_OVERWRITE);
        if(SystemInfo::strpos_arr($_SERVER["HTTP_HOST"], SystemInfo::$ALLOWED_INHOUSE_DOMAINS)!== false){
            if(!empty($_REQUEST['CUS_APP_TYPE'])){
                $APP_TYPE = $_REQUEST['CUS_APP_TYPE'];
                define('APP_TYPE', $APP_TYPE);
            }
            if(!empty($_REQUEST['CUS_PACKAGE_TYPE'])){
                $PACKAGE_TYPE = $_REQUEST['CUS_PACKAGE_TYPE'];
                define('PACKAGE_TYPE', $PACKAGE_TYPE);
            }
            if(!empty($_REQUEST['CUS_PARENT_UFX_CATID'])){
                $CUS_PARENT_UFX_CATID = $_REQUEST['CUS_PARENT_UFX_CATID'];
                define('CUS_PARENT_UFX_CATID', $CUS_PARENT_UFX_CATID);
            }
        }
        else if(!SystemInfo::checkClientServer()){
            echo '<div style="font-size: 24px">System is misconfigured. Please contact to the <strong>technical team</strong> to resolve.</div>';
            die();
        }
        if(empty($APP_TYPE)){
            $APP_TYPE = "Ride-Delivery-UberX";
        }
        if(!defined('APP_TYPE')){
            define('APP_TYPE', $APP_TYPE);
        }
        if(empty($PACKAGE_TYPE)){
            $PACKAGE_TYPE = "SHARK";
        }
        if(!defined('PACKAGE_TYPE')){
            define('PACKAGE_TYPE', $PACKAGE_TYPE);
        }
        if(empty($CUS_PARENT_UFX_CATID)){
            $parent_ufx_catid = "0";
        }
        else {
            $parent_ufx_catid = $CUS_PARENT_UFX_CATID;
        }
        SystemInfo::redefineVariables(get_defined_vars());
    }
    public static function checkClientServer(){
        if(!in_array($_SERVER["HTTP_HOST"], SystemInfo::$ALLOWED_CLIENT_DOMAINS)){
            return false;
        }
        elseif(strtotime(SystemInfo::$EXPIRY_DATE)< strtotime(date('Y-m-d'))&& SystemInfo::$EXPIRY_DATE != '0000-00-00'){
            return false;
        }
        return true;
    }
    private static function strpos_arr($haystack, $needle, $offset=0){
        if(!is_array($needle)){
            $needle = array($needle);
        }
        foreach($needle as $query){
            if(strpos($haystack, $query, $offset)!== false)return true;
        }
        return false;
    }
}


//Dudedev

// Carrega a localização vinculada ao Franchise Admin
$iFranchiseLocationId = ''; // variável global

if (isset($_SESSION['sess_iAdminUserId']) && isset($_SESSION['sess_iGroupId']) && $_SESSION['sess_iGroupId'] == 6) {
    $adminId = $_SESSION['sess_iAdminUserId'];
    $locationQuery = "SELECT location_id FROM admin_locations WHERE admin_id = '$adminId' LIMIT 1";
    $locationData = $obj->MySQLSelect($locationQuery);
    
    if (!empty($locationData)) {
        $iFranchiseLocationId = $locationData[0]['location_id'];
    }
}

function getLocationIdByLatLong($lat, $lng, $obj) {
    $sql = "SELECT iLocationId, tLatitude, tLongitude FROM location_master WHERE eStatus = 'Active' AND eFor = 'Franchise'";
    $locations = $obj->MySQLSelect($sql);

    foreach ($locations as $location) {
        $polyLat = explode(',', $location['tLatitude']);
        $polyLng = explode(',', $location['tLongitude']);

        $polygon = [];
        for ($i = 0; $i < count($polyLat); $i++) {
            $polygon[] = [$polyLat[$i], $polyLng[$i]];
        }

        if (isPointInPolygon([$lat, $lng], $polygon)) {
            return $location['iLocationId'];
        }
    }

    return null;
}

function isPointInPolygon($point, $polygon) {
    $x = $point[0];
    $y = $point[1];
    $inside = false;

    for ($i = 0, $j = count($polygon) - 1; $i < count($polygon); $j = $i++) {
        $xi = $polygon[$i][0]; $yi = $polygon[$i][1];
        $xj = $polygon[$j][0]; $yj = $polygon[$j][1];

        $intersect = (($yi > $y) != ($yj > $y))
            && ($x < ($xj - $xi) * ($y - $yi) / (($yj - $yi) ?: 0.00001) + $xi);
        if ($intersect) $inside = !$inside;
    }

    return $inside;
}



SystemInfo::Initiate(dirname(__FILE__));

function setSessionFromCookie($cookieName, $sessionKey) {
    if (isset($_COOKIE[$cookieName])) {
        $cookieValue = $_COOKIE[$cookieName];
        $_SESSION[$sessionKey] = $cookieValue;

        setcookie($cookieName, "", 0, '/'); // Setting expiration time to 0 effectively deletes the cookie
        unset($_COOKIE[$cookieName]);
    }
}
setSessionFromCookie('sess_lang', 'sess_lang');
setSessionFromCookie('sess_currency', 'sess_currency');
setSessionFromCookie('sess_currency', 'sess_vCurrency');
setSessionFromCookie('eDirectionCode', 'eDirectionCode');
require_once $tconfig['tsite_libraries_v'] . 'include_configurations.php';